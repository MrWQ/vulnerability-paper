> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247533350&idx=1&sn=369c37a7c5ba4d4980d5363633172dbd&chksm=fd76a971ca01206763866bc2e866f279724028d4e8de248cf598ad25c789c7c7d8d24f077a05&scene=21#wechat_redirect)

**![](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3MmaYz8UWHicLDSC4e3NqcibOLicCiaYtmQm9A0Ied3OLs4Wibj6bLz8jmf0gB3k0h1aQNNVKNqjKFcZV0Mg/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)**
----------------------------------------------------------------------------------------------------------------------------------------------------------------------

FFmpeg 是一套可以用来记录、转换数字音频、视频，并能将其转化为流的开源计算机程序。应用范围广泛，国内诸多大厂也有使用。

Part1

漏洞状态

<table interlaced="enabled" data-sort="sortDisabled"><tbody><tr><td valign="top" align="center" width="69.66666666666667">漏洞细节<br></td><td valign="top" align="center" width="71.66666666666667">漏洞 POC<br></td><td valign="top" align="center" width="61.66666666666667">漏洞 EXP<br></td><td valign="top" align="center" width="65.66666666666667">在野利用<br></td></tr><tr><td valign="top" align="center" width="10">有</td><td valign="top" align="center" width="71.66666666666667">有<br></td><td valign="top" align="center" width="61.66666666666667">有</td><td valign="top" align="center" width="65.66666666666667">无</td></tr></tbody></table>

Part2

漏洞描述

FFmpeg 2.x 允许远程攻击者通过在 HTTP Live Streaming（HLS）M3U8 文件中使用 concat 协议进行跨源攻击并读取任意文件，导致外部 HTTP 请求中的 URL 字符串包含本地文件。

<table interlaced="enabled"><tbody><tr><td width="103" valign="middle" align="center">‍漏洞名称<br></td><td valign="middle" align="left" width="417.6666666666667"><p>&nbsp;&nbsp;CVE-2016-1898 FFmpeg 任意文件读取漏洞</p></td></tr><tr><td width="103" valign="middle" align="center">CVE 编号</td><td valign="top" width="418.6666666666667">CVE-2016-1898</td></tr><tr><td width="103" valign="middle" align="center">漏洞类型</td><td valign="top" width="418.6666666666667">远程任意文件读取</td></tr><tr><td valign="middle" align="center" colspan="1" rowspan="1">漏洞等级</td><td valign="middle" align="left" colspan="1" rowspan="1">5.5 中危</td></tr><tr><td valign="middle" align="center" colspan="1" rowspan="1">公开状态</td><td valign="middle" align="left" colspan="1" rowspan="1">公开<br></td></tr><tr><td valign="middle" align="center" colspan="1" rowspan="1">时间线</td><td valign="middle" align="left" colspan="1" rowspan="1"><section>2016-01-14 - 分配 CVE<br>2016-03-14&nbsp; - 公开发布</section></td></tr></tbody></table>

**影响范围**

FFmpeg 2.8.x < 2.8.5

FFmpeg 2.7.x < 2.7.5

FFmpeg 2.6.x < 2.6.7

FFmpeg 2.5.x < 2.5.10

**复现环境:**

Kali 64

FFmpeg-2.8.1

Part3

漏洞复现

- 安装 yasm-1.3.0

1）下载：wget http://www.tortall.net/projects/yasm/releases/yasm-1.3.0.tar.gz

2）解压：tar zxvf yasm-1.3.0.tar.gz

3）切换路径：cd yasm-1.3.0

4）执行配置：./configure

5）编译：make

6）安装：make install

- 安装 FFmpeg-2.8.1

·wget  下载

https://ffmpeg.org/releases/ffmpeg-2.8.1.tar.bz2

·tar -xjvf ffmpeg-2.8.1.tar.bz2 解压下载的文件

·cd ffmpeg-2.8.1/

· 编译和安装

./configure --enable-shared --prefix=/monchickey/ffmpeg

make

make install

运行后可能会提示找不到 libavdevice.so.56

find / -name "libavdevice.so.56"

添加动态库路径 (根据)

![](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3Mma5MUK172SS2M0Xge94p9EnDrZH2XmvCJTGMYMfe5cA967QXpsQiaAszr9Ddu69BoI1QAyou6FHicwg/640?wx_fmt=jpeg)

通过 python exp 脚本生成一个特殊构造的验证视频文件 file_read.avi

![](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3Mma5MUK172SS2M0Xge94p9En1UyAfqv7SzgHzDMLPgFk2xb7IUYdckFS5YF0X48KThdyBSjvL1clCw/640?wx_fmt=jpeg)

使用命令出发 ffmpeg 漏洞

./ffmpeg  -i  /home/kali/Desktop/poc/file_read.avi /home/kali/Desktop/poc/file_read.mp4

![](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3Mma5MUK172SS2M0Xge94p9EnhWuENUyUAbLqLw2f3ibRPoGSBwvllsbDVuKoxXDUGmCwGxiceVkh8aug/640?wx_fmt=jpeg)

打开转换后的 mp4 文件

![](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3Mma5MUK172SS2M0Xge94p9Enj1plKsdI15U44Lh2X0HQvfMrJpULYXYqqgePFibPRFBaKSZyUuTE59w/640?wx_fmt=jpeg)

出现文件内容

复现成功！

**漏洞细节:**

由于漏洞是出现在解析 HLS 流媒体文件出的问题，所以我们必须先了解 HLS。

HLS（HTTP Live Streaming）是 Apple 公司开发的一种基于 HTTP 协议的流媒体通信协议，大多数都应用在 PC 上和 Iphone 上。它的基本原理是把一个视频流分成很多个很小很小很小的 ts 流文件，然后通过 HTTP 下载，每次下载一点点。在一个开始一个新的流媒体会话时，客户端都会先下载一个 m3u8（播放列表 Playlist）文件，里面包含了这次 HLS 会话的所有数据。

m3u8 文件结构如下：

#EXTM3U

#EXT-X-TARGETDURATION:6

#EXT-X-VERSION:2

#EXTINF:6,

http://**.flv.ts?ts_start=0&ts_end=5.9&ts_seg_no=0&ts_keyframe=1

#EXTINF:0,

http://**.flv.ts?ts_start=5.9&ts_end=6.367&ts_seg_no=1&ts_keyframe=1

#EXT-X-ENDLIST

**解析：**

#EXTM3U 标签是 m3u8 的文件头，开头必须要这一行

#EXT-X-TARGETDURATION 表示整个媒体的长度 这里是 6 秒

#EXT-X-VERSION:2 该标签可有可无

#EXTINF:6, 表示该一段 TS 流文件的长度

#EXT-X-ENDLIST 这个相当于文件结束符

这些是 m3u8 的最基本的标签，而问题就出在 FFMpeg 去请求 TS 流文件的时，由于我们可以伪造一个 m3u8 文件，FFMpeg 不会判断里面的流地址，直接请求。

总结来说，就是通过构造一个特殊的流媒体文件，包含 m3u8 标签，里面内容指向 kali 系统内部的文件，这样 ffmpeg 在转换视频文件的时候会读取指向的 kali 系统内部文件，并转换成视频。

![](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3Mma5MUK172SS2M0Xge94p9EnO1JZriccWuFaicG7hkA0oG9AiaO5qCMhRDomaHCWZHCXEpGGVLYN4M0Wg/640?wx_fmt=jpeg)

这是通过 winhex 打开的特殊构造的 avi 文件，可以看到里面存在 m3u8 文件结构。

Part4

修复缓解建议

1. 软件升级至最新版本。

2. 监控网络流量，查看是否有恶意代码的流量特征。

3. 安装主机卫士，设置 IP 白名单。

**SAFE**

**获取更多情报**

  

联系我们，获取更多漏洞情报详情及处置建议，让企业远离漏洞威胁。  
电话：18511745601

邮箱：shiliangang@andisec.com

**漏洞分析回顾**  
![](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3MmYrt8sZBqiah8aNInQspzccnPAAhd0OKLQ5Ziad4ovQEohiamyrpYjQcwVAWROpYWmMXia1YRKPiczFSQw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)[![](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmaxJJricFkZkibhryfwV3vEDTMvcrOmicTOr9AexSibdBAoPe1Ruu8DAOVFOlCjH0tE6b25SIVvpyhMow/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247533011&idx=1&sn=30d2cdb4cb614d4b556cd64effb1dc8d&chksm=fd76ab84ca012292705b092e1268ca4ae418df8d16c35d05670143bb1e1ca20ca44c1af465b0&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmaxJJricFkZkibhryfwV3vEDT4Vbrfh6ZmNwuPV3dDu9EnGn4Xrk4H6fMgRq8CkHlCvdqDRupwQN6rQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247532641&idx=1&sn=194abb0d9dd334969553d80846095ccb&chksm=fd76aa36ca012320b08fab08fa7e6e469e76ed1dce61da4c5b3cca1786120880570e09d86387&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmaxJJricFkZkibhryfwV3vEDTAxO7PPCr1huK0IEpDaXerKmDibz8MEHthPibmRfyhnQxQ9dBOFktxBrQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247532563&idx=1&sn=074c9a7ab3b51a4250c13b82c4bb74cb&chksm=fd76aa44ca012352964f1bc708f497db583c81e1022394f5605c0079a3d4168152d93e756f0d&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmaxJJricFkZkibhryfwV3vEDTrneXicqhAfKW6pqYPUicxiabwmAk00UcSdlwKxFWcfPQcn16bKZZUosjg/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247531591&idx=1&sn=41fbf4dfa7234e08a4c342ada9c90150&chksm=fd769610ca011f068ce363eaf1e52b43da091b60269ffbe216254f1da0588a811888d6e93bed&scene=21#wechat_redirect)

  

北京安帝科技有限公司是新兴的工业网络安全能力供应商，专注于网络化、数字化、智能化背景下的工业网络安全技术、产品、服务的创新研究和实践探索，基于网络空间行为学理论及工业网络系统安全工程方法，围绕工业网络控制系统构建预防、识别、检测、保护、响应、恢复等核心能力优势，为电力、水利、石油石化、轨道交通、烟草、钢铁冶金、智能制造、矿业等关键信息基础设施行业提供安全产品、服务和综合解决方案。坚持 IT 安全与 OT 安全融合发展，坚持产品体系的自主可控，全面赋能客户构建 “业务应用紧耦合、用户行为强相关、安全风险自适应、网络弹性稳增强” 的主动防御和纵深防御相结合的安全保障体系。截至 2021 年底，公司主要产品已应用于数千家 “关基” 企业，其中工业网络安全态势感知平台已部署 4000 余家客户，虚实结合工业网络靶场服务超过 50 家客户。

![](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3Mma4ibTfp7sC3ibt8WmetoDfiaGHEb7VOiaemeFbuCTupYgus7NTKkibwKwpsEDfzqZdXh1skHff6A6VNgA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

**点击 “在看” 鼓励一下吧**

**![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmZOFFgf4oTyfUTx7y0ZBV9yIg8qmaSwAvbjiba2KQn7VgmXYIriagc9H0hMu1u0UIZr98JYSmyG9tibg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)**