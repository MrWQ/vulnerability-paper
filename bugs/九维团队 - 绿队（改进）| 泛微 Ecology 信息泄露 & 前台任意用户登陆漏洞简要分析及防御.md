> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/HTLv1nGV4UaTZ9idUrEQ4Q)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOQ4y3CslMX5EINOxRsoicGxHxJnwtXjIau4usI94yHUKXTqh4LyuVL4A/640?wx_fmt=gif)

**01**

**漏洞描述**

近日泛微发布了新的安全漏洞补丁，修复了信息泄露和任意用户登录漏洞，该漏洞是由于系统未对系统接口的响应进行合理的处理，导致该系统会泄漏用户信息，由于系统硬编码了 AES 的 KEY 值，攻击者可利用信息泄露漏洞获取到的 loginid 导致任意用户登录系统。

**02**

**信息泄露**

根据补丁对比找到接口。

第一处：

<table><tbody><tr><td width="557" valign="top"><img data-ratio="0.38796296296296295" data-src="https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKtta9w319CYfTRlXfe4oCrcbbYtam3S5buN3IQjPuEsq7SbGLAYlZjRSzbJVgMhfEGOLBekjeAjg/640?wx_fmt=png" data-type="png" data-w="1080" data-index="2" src="https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKtta9w319CYfTRlXfe4oCrcbbYtam3S5buN3IQjPuEsq7SbGLAYlZjRSzbJVgMhfEGOLBekjeAjg/640?wx_fmt=png" _width="578px" crossorigin="anonymous" alt="图片" data-fail="0" class="sr-rd-content-nobeautify"></td></tr></tbody></table>

  

漏洞位置：

```
/mobile/plugin/changeuserinfo.jsp

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKtta9w319CYfTRlXfe4oCrIVuB3tEOHlk4bFUR857h7mbgz60CCibW3yPl7ib5tpdwyhxjeXVjojlw/640?wx_fmt=png)

可以根据手机号模糊查询 loginid。

首先查一下共有多少个，数量大于 1 响应为 {"status":"0"}, 当等于 1 时输出查到的 loginid。

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKtta9w319CYfTRlXfe4oCre8ENMgtqTKneFa81gwGEpFre4g35ectlN9Jl1TkCe3HA81eEhR0ibow/640?wx_fmt=png)

<table><tbody><tr><td width="557" valign="top"><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKtta9w319CYfTRlXfe4oCrmwtGhgj5eCaXuzLeicibV6xW2aLvxibwxo3zCmeFibKQqkgULA6TpKt63Q/640?wx_fmt=png"></td></tr></tbody></table>

  

  

第二处比较鸡肋：

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKtta9w319CYfTRlXfe4oCrDljgo1ynOeIQGd3WwibQqokPs0DGY2upicmGj6Kib7NzSdKN8cbGVibflg/640?wx_fmt=png)

大致就是根据提供的用户 ID 列表，获取这些用户的信息，然后将获取到的信息返回。

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKtta9w319CYfTRlXfe4oCr59icv55zVrsibQjBtSJWDH5brAMuj4cWlYhPic3VaDOITPYeWAWbtzf2w/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKtta9w319CYfTRlXfe4oCrhA8l0KbXXPHoIcGAXmBfwctuZ0jH0qvMTaGnia6WibLtjsvYxzw0Q7iaw/640?wx_fmt=png)

<table><tbody><tr><td width="557" valign="top"><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKtta9w319CYfTRlXfe4oCrCT3n7pERoywg1MdkmlcalnqHftx3CbMfNAW6rXiaVoKva53kyIbmemg/640?wx_fmt=png"></td></tr></tbody></table>

  

  

获取到的只有 id、name、avatar_url 三个字段。

**03**

**登录绕过**

漏洞位置在

```
mobile/plugin/1/ofsLogin.jsp

```

重点在 if 语句上，当 loginTokenFromThird 等于 loginTokenFromThird2 时进入 else 中，前者的值是参数传进来的，后者经过为 AES 加密得到的。

AES 加密的 key 是 syscode+Prop.getPropValue

("transferE9","secretkey") 对 receiver+timestamp 进行加密。

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKtta9w319CYfTRlXfe4oCrqE28tASpMSL0TIcTBmwDHP4unyria9c7ng5s63khRgMJ33MESUeLBhA/640?wx_fmt=png)

看 AES 加密部分。

首先是 key。

Prop.getPropValue("transferE9","secretkey") 为中从配置文件 transferE9.properties 中获取 secretkey 的值。

那么 key 就等于传递过来的参数 syscode 加上 secretkey 的值。

secretkey 还是硬编码在配置文件中的。此时我们调用 AES 加密并将加密后的值通过 loginTokenFromThird 传入即可进入 else 中。

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKtta9w319CYfTRlXfe4oCrd2dQapKzVEJQE6oEsgiakdeOsZk5l5yXdRic5rrBdaicozHXeicWWckiagw/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKtta9w319CYfTRlXfe4oCrFz4M3NKA3bNvIXxzBjUtdHE83hWrUXQKSiaic11qMKEgx8rrAfibMXlUw/640?wx_fmt=png)

可以看到首先是确定登录方式，查看数据库，默认安装的 ofs_sendinfo 表中 hrmtransrule 是空的，所以此时 hrmtransrule 参数必定会被赋值为 1，因此登录方式固定为 loginid，loginid 由 receiver 决定所以将信息泄露中获取到的 loginid 传递给 receiver 参数就可以完成登录了。

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKtta9w319CYfTRlXfe4oCrR1I38bCdujDdtOOM7douggI9g06U1nS1UU6ic5CV4seQom4LBfwAOibQ/640?wx_fmt=png)

<table><tbody><tr><td width="557" valign="top"><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKtta9w319CYfTRlXfe4oCr8VLbJY5GgQ0Z2lnuphgenfDmutvT5HaKXzsevyFG9qgpvN03lpIrWg/640?wx_fmt=png"><br><p><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKtta9w319CYfTRlXfe4oCrQOg2CCpsl925dVobTC4GiaOZiamrQPflwmW0TqKJmG1ViaBB3zxib1TYvw/640?wx_fmt=png" style="width: auto;"></p></td></tr></tbody></table>

  

  

这里查询的库是 HrmResource 所以并不能登录管理员。

第一处可以直接模糊匹配，第二处信息泄露并未返回 loginid 字段，所以要根据 name 猜测 login 的值，随后加密后登录即可。

**04**

**修复建议**

1、及时更新补丁：泛微 OA 不断推出新的安全补丁，建议管理员及时升级以确保系统的安全性。

2、建议管理员将用户权限设置为最低限度，避免普通用户对系统进行恶意操作。

3、建议部署防火墙、入侵检测和反病毒软件等安全设备，减少网络攻击的风险。

4、建议定期进行安全审计，以及时发现和排除系统漏洞。

5、开启访问控制，配置访问控制列表（ACLs）限制外部 IP 访问，仅允许受信任的 IP 地址访问网络。

6、经常备份关键数据，并将备份文件存放在一个安全的位置，以防意外损失或攻击。

* * *

**往期回顾**

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zK9CpI1AR5hwPibGhicQHyvvusu0od1oxHl20hrKEtcDJScSzyrXbzEib9MS6VtZlsFfwnW3TuOibblhg/640?wx_fmt=jpeg&wx_co=1&wxfrom=5&wx_lazy=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247503784&idx=2&sn=bc990c6259149fdf93ba39e2bbd0f898&chksm=9ae18e90ad960786ff7b082ba3d2afcfe716606214a3c6ad6929bdd2f8d437e14383a619f490&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zIMGymuUmz7KkgDu76bqK4jvH34NQGFge4gcKKnic0ytD523yf5Q7MLM1jrOHy9kXqYLUyUabkNqLQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247515689&idx=1&sn=8de152aec10a47f8203bf54c2081618b&chksm=9ae1ff11ad967607d5f40a480d4af64e17db2bc2c61dbc81f60a30bfbb02003ba070845c2fd8&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKDWSHDmgRVUFRgLwU9Unw6le33KdvFOPBf8YrsetvOPDiaSgBWzN6ibXqop6TuLDF2v7E9aBYG6bHw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247514846&idx=1&sn=2e644c83e0d40577df710856bde0e786&chksm=9ae1fbe6ad9672f0ceb51933b8608dd5cf32d9371c203b191e6e868eee2025851a7b5065cb4e&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKkOZo4mMe0avq8h2VtnS8OSVrqDSooXtaaPnpJykYcra6icvQ964iaqpWBuSGqicqjUricLg8kkBBrHQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247514448&idx=1&sn=519bfeaffa63122b169f9bc6ce1ffe84&chksm=9ae1f868ad96717eae7befa908d863b7bf902485d74bf746807f8f8c9242affe38d78438811f&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKtta9w319CYfTRlXfe4oCrs5uicPX3kCt8QkrcXTntN0RwQgBCqjs8pJhiaACWWIQY35TwEPLMXEuw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247514117&idx=1&sn=b7b7db081edeb47fff34f98a9fa6009e&chksm=9ae1f93dad96702b6cff006a2f1bd9e5005c0676951c258ad28550d8740ab55e393f10fbc0fe&scene=21#wechat_redirect)

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/Ljib4So7yuWjVsaTygX5CCGxuYZaPeibrpfOOGAjXfTkTp3AIPeXv08iayGTH94Xcmvk4RJxs9NNSc2vzCoCiaXOSQ/640?wx_fmt=jpeg&wx_co=1&wxfrom=5&wx_lazy=1)

  

**关于安恒信息安全服务团队**

**安恒信息安全服务团队由九维安全能力专家构成，其职责分别为：红队持续突破、橙队擅于赋能、黄队致力建设、绿队跟踪改进、青队快速处置、蓝队实时防御，紫队不断优化、暗队专注情报和研究、白队运营管理，以体系化的安全人才及技术为客户赋能。**

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIFIDZlXFuQeZrcKrV7Zd8Aeg98Fw5jzbGBgUW1hVQXIV3YpLZncEYibgw7MFwWtDU5vwnE2QFVP7A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL31gt4m6YIRLh7wJeOSwYPOIblCvhN6OgHhV9NMJNH0TBianlpMmRbaKG1ia7iaPsWb4UX4ImgfEJ0A/640?wx_fmt=jpeg&wx_co=1&wxfrom=5&wx_lazy=1)

![图片](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOCUgD3ep5Jp4DE8e2S2Y3WnxsKjicicOg3OsGGRc9NPibQ61aRAqNXZQDA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)