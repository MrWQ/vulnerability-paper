<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/OEteWONm376GJ8kqrWSaAw)

报告编号：B6-2021-033001

报告来源：360CERT

报告作者：360CERT

更新日期：2021-03-30

0x01   漏洞概述
-----------

F5 BIG-IP 在今年 3 月补丁日中修复了`CVE-2021-22986`，未经身份验证的攻击者可以向`iControl REST`发送精心构造的恶意请求，最终在目标服务器上执行任意命令。

0x02   环境配置
-----------

_F5 BIG-IP 官方_提供了对应版本的`Virtual Edition`版本，所以直接下载导入到`vmware`中即可。本篇所使用的漏洞版本为 16.0.1，diff 版本为 16.0.1.1。具体的步骤及操作可以参考_这篇文章_进行基础配置，完成 F5 BIG-IP 的启动。

### 2.1 允许 ssh 远连

可以根据_这篇文章_配置允许 ssh 远连，这里推荐直接用`tmsh`来进行配置。

### 2.2 寻找具体服务

在 F5 BIG-IP 中，`TMUI`与`iControl REST`是部署在不同的端口上的。我们可以看一下我们访问的 443 端口的服务是什么：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYpI09zsiatyvMo5yAcGtzDYKiaua91Q0QUDWbaoCFZO5pYoAHV1zlBx6w/640)

可以看到是由 Apache httpd 进行请求承接，并将请求转发到不同端口的服务上完成对应的处理。我们可以看一下 httpd 的配置文件，在`/config/httpd/conf/httpd.conf`：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYLqqfcXnpAcn2xbxTY6LYC3eJiaP5M6ic7ShosQ5V83xZWgxe9JyYxVjQ/640)

这里可以注意到两点：

* AuthPAM 开启，说明调用了 httpd 的某个`.so`文件进行预先的认证

* 将所有向`/mgmt`发送的请求都转发到了`http://localhost:8100/mgmt/`

通过阅读官方文档，我们可以知道所有 REST API 的目录前缀都是含有`mgmt`的，所以可以看一下 8100 端口的服务及其进程信息是什么：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYfbEMpM3GkTlCygiccp0iav2B5boT4KNib5IPpCZpE5btzzbNn0lNGqdRQ/640)

可以看到其`classpath`为`/usr/share/java/rest/`目录。之后我们可以通过`PID`在`/proc/`目录下查看进程信息：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYBHEtSFQlqiauklsFT0ykHRjBtiaFJBEu2lDIFmoIxKPicRjdGK8otNrlw/640)

这样也知道了进程运行目录为`/var/service/restjavad`。

### 2.3 允许远程调试

根据 2.2 中找到的进程信息，我们直接到`/var/service/restjavad`目录，然后向运行文件中添加相关的 jdwp 配置：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYppqmkK3AYKdVworKMS8bdDw7A3gDAiaFJ7jfzwyQnAItz7urCfwBC3w/640)

这里看到运行文件为`/etc/bigstart/scripts/restjavad`，直接修改该文件即可：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYibILC2m372wbBicv0CvjStsFicEJywExHU58zHNoPWsah2tX5GWquDkvQ/640)

当添加完 jdwp 配置后，还需要利用`tmsh`将 jdwp 监听端口 8777 开放出去，这里可以直接参考_这篇文章_。这里为了防止链接失效，截一个这篇文章的关键图：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYw4X3KLCiaU9lEicbeLcMyajs6KTibVdKE7vpickria1t5cDiaia9OsSFbbfSQ/640)

### 2.4 导出分析代码

在 2.2 中已经进行了详细的叙述，直接把`/usr/share/java/rest/`下的代码导出就行了。如果遇到无法导出的问题，可能是由于`/usr`目录无写权限，重新挂载一下`/usr`即可：

```
mount -o remount w /usr
```

0x03   diff 信息
--------------

### 3.1 ssrf

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYMAt6EpHXkS5RnJ9JYaFZuWWiahuiaLJ0bC2ctiammwcEmJW1bFpq5dEIg/640)![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYdu6QM7JkuF0Zwbwsib4YRvApo1004x3U5UC7ePQjg6niaS5WibhJf8zwg/640)![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYFKPda5j4RlRmkcqBuACiblLkSWOkE3vVuyoibIr6gS6IRSW6ffGMQxVg/640)

### 3.2 命令执行

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYJx6icuianksdicT12OYpTvXF2wnY1DBUouMPsEraT511JQTaicWs2rjxhw/640)

0x04   漏洞分析
-----------

该漏洞可以分解为两部分：

* 认证绕过

* 命令执行端点

该漏洞有两种方式可以达成认证绕过：

* 认证不完全导致绕过

* ssrf 获取 token 导致认证绕过

本文将使用动静态跟踪结合的方式，将两部分进行串流分析。

### 4.1 iControl REST 处理逻辑

在开始分析认证绕过前，首先来分析一下程序执行流。

#### 4.1.1 RestServerServlet

`RestServerServlet`是整个`iControle REST`的入口，首先看一下其`service`方法：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJY7b7A86uib75RvFNJZmCHMwkAibYVIlcBXc5jxOsqRRvAjzBKOiaoRoxMw/640)

从`service`方法中，可以获得以下几个信息：

* `RestServerServlet`以异步执行，并注册了一个`ReadListener`

* 在处理请求时，为每一个请求创建了一个`RestOperation`

* 因为向`RestOperation`注册了一个`RestRequestCompletion`，后续逻辑将以回调的方式执行

由于是注册了`ReadListener`，所以我们直接跟进看`com.f5.rest.app.RestServerServlet.ReadListenerImpl#onAllDataRead`（具体原因可以看 _ReadListener 官方文档_）：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYJx6icuianksdicT12OYpTvXF2wnY1DBUouMPsEraT511JQTaicWs2rjxhw/640)

跟进看一下`com.f5.rest.common.RestOperationIdentifier#setIdentityFromAuthenticationData`：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYnwUjqMoNjNibn6dWq5oTvzYibhzjyTcVMXz9ia7y2PZzwHh85YyiaK4TTw/640)

这里会监测请求中是否包含相关认证，并将其设置到`RestOperation`中。注意这里涉及到两种身份设置方法，第一种是检测是否存在`X-F5-Auth-Token`，第二种是通过 Basic 认证来设置身份。其中`setIdentityFromBasicAuth`即为 diff 点：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYmkAmZK4lJXkOibXY1zHqxPQQs1VbibjwqvJVia33pkfb02UpxV8iaNrbpQ/640)![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYoa3a5lYlzogaWwHicatfIdzXnaEtBWabhgxl43yRPfaxOm5KowhBDGg/640)

在`setIdentityData`中只会判断 Basic 头信息中是否存在`username`，当存在时，将`userReference`初始化为`/mgmt/shared/authz/users/[username]`。

在完成设置后，便会执行`completion.run()`方法，即：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYmnRXuE7fHQWnKcyzyObPzic6Hqib7MpTYFDm2VQkr20MkcSFCoKBpbGQ/640)

关键逻辑为`com.f5.rest.common.RestServer#trySendInProcess`：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYhJDMhU0JIzibpUtr3WtcLAI0IqibexWVgzCVjCap54hhVBCmIYj57ib0g/640)

其中会根据请求端口来寻找相关的`RestWorker`，并执行`OnRequest`方法。这里因为是`8100`端口，其映射为`RestServer`对象：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYLnc6Eib0nyV8cPdjMPbFaXDKNxjQbUOyGmGQ6nO6cP56CAxYf2EUJAQ/640)

在`findWorker()`方法中，将以请求的路径为查询条件，匹配`RestServer`的`pathToWarkerMap`。之后便会执行`worker.onRequest()`方法，在这里会将 worker 添加到`RestServer.readyWorkerSet`中。后面会以该`Set`为消费者队列，并执行各个 worker。

#### 4.1.2 RestServer

`RestServer`中主要工作是维护队列，并执行相关的 worker。入口点为其构造方法：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYpnOhWSM2eWGPQxZnQLqictAoXP6xjOwgKwbTpTX3nn7FLoJUQvr4CHg/640)![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYe9qKpkw3wGSCyxibGRo9YwLCkFZZCM8RINjnS6Z6b8qJbh5CiclLqhbQ/640)

这里明显为一个消费者，所以直接看`callRestMethodHandler`即可，一路向下跟进到`callDerivedRestMethod`方法：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYFMGGXUeicXgSuBiazTicqiaWv4siarppb79iaoAQcIR0cw3UyaPo79BNfic2g/640)

这里即会调用对应 worker 的处理方法并完成对应的链调用。

### 4.2 认证绕过

该漏洞的重点是认证绕过这一部分，两种绕过方式采用了不同的思路，本篇主要分析第二种绕过方式，针对第一种方式只进行基础的分析，如果想要了解详情，可以阅读_斗象的研究文章_。

#### 4.2.1 认证不完全导致绕过

BIG-IP 由两部分组成，首先是通过`Apache httpd`接收 443 的请求，并将请求转发给本地 8100 端口的 Jetty 服务，最终通过 Jetty 的 servlet 将不同的路由分发到不同的 worker 中，完成请求的处理。

而第一种利用方式正是利用了 Jetty 服务不会对通过 httpd 认证的请求进行二次认证的缺陷，导致了未认证的攻击者可以绕过认证访问任意 worker，最终完成 pre auth rce。

在 2.2 中，从`httpd.conf`中已经看到`httpd`在进行转发时启用了`AuthPAM`，其具体的`.so`文件为`/usr/lib/httpd/modules/mod_auth_pam.so`。

用 IDA 分析一下逻辑：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYyYs3Rs8SZcjxUmTovcictb9BIEkUrHrHwkxVq1kT5VHa0JjMMCv23Yw/640)![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYY1otm8pv0ujseSBic9VZyibA2PQ2cXCObLqBd1fVc8lSDkUfaqOyjh7A/640)![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYY1otm8pv0ujseSBic9VZyibA2PQ2cXCObLqBd1fVc8lSDkUfaqOyjh7A/640)

httpd 只查看请求中是否存在`X-F5-Auth-Token`，若存在，则直接将请求转发到 Jetty 进行后续处理。

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJY8v8AlspQccxkJ1ZPTMoGLRsJjE0pWA7iaCPLIsM45sebHyckeGeatibw/640)

在 Jetty 这端，首先会判断`X-F5-Auth-Token`是否为空，当设置为空时，对访问路径进行校验，但是这里不匹配任何一种情况。最终进入到 else 中。这里只会判断`userReference`是否为空，以及`userReference`是否为`admin的userReference`。

回看`userReference`的生成过程（在`com.f5.rest.common.RestOperationIdentifier#setIdentityFromBasicAuth`）：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYO7sic3GVoG4Sic7W2BKwZTVXK8nwgj12hvR9sVr8Qq6ByFC4dDO8DQXA/640)![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYSlkmfmWWDF6wpJ9NqicTY7YLQqCx708m4wmTI04cxziaaajKKGP617Ow/640)

可以发现这里的`userReference`就是默认 admin 的`userReference`：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYkic4cyrDoicsEZqNOkfh2AxlwZ4ZvelAh3iaBtACGHZ4nOTeFAicevV6Qg/640)

从而导致了绕过。

#### 4.2.2 ssrf 获取 token 导致认证绕过

在 diff 中可以明显的看到在`com.f5.rest.workers.authn.AuthnWorker#onPost`方法中增加了对`loginReference.link`的校验。在跟踪了代码逻辑后，可以发现这里存在一处 ssrf。

可控输入点为：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYKHc16W6QP0ibLMOuOoRd193qssES4Eh2zY2uRxOSjnRLKcXMQfGiaIqQ/640)

向下看 ssrf 点：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJY3v61rxJ4YPZf4tSwWibR5172kAJGAMPq7LfCzbwibSKr12pOMR7tdVWw/640)

这里`state.loginReference.link`是可控的。首先会 new 一个`RestRequestCompletion`，并将其封装到`RestOperation`中，最后向`state.loginReference`发起请求。注意到在`RestRequestCompletion`中存在`completed()`方法，其中会调用`AuthnWorker.generateToken()`方法生成一个 token，跟进可以看到：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYicLHQJDicaliaz4DuiauAy84uIiaQibJJVEhVSAvLFyCwRvlejBdabQro4BQ/640)

这里又新创建了一个`RestOperation`，其中的`completed`方法完成了 token 的映射及返回。具体的 token 生成在`com.f5.rest.workers.AuthTokenWorker#generatePrimaryKey`中：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJY2O0aURibfibaoUaqELAjZGz4kUu46jz1ibSXC4dzfCJl6DyLxic0tulTbA/640)

调用栈为：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYoGVlQicvRAS9w8vsGticfP5CzQcMjE5nhF1qWoBPjtic9wkEBHKwmQlYg/640)

如果想要静态跟踪到 token 生成点的话，直接跟进`RestRequestSender.sendPost()`方法即可。

#### 4.2.3 ssrf 获取 token 总结

根据 4.1 中对处理逻辑的分析，想要找到获取 token 的点的话，只需要在所有的`RestWorker`子类中寻找符合以下两个条件的子类即可：

* 存在`onPost`方法可以处理`POST`请求

* `onPost`方法中可以控制执行流到`RestOperation.complete()`方法

由于 F5 采用了回调的方式完成执行流的构建，最终都会通过回调的逻辑执行`RestRequestCompletion.completed()`方法。

### 4.3 命令执行端点

命令执行端点主要是配合认证绕过最终达成远程 pre auth rce 的效果。

#### 4.3.1 /mgmt/tm/util/bash

从 [F5 BIG IP 官方 sdk][7] 中找到`/mgmt/tm/util/bash`可以直接执行命令：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYdsWDI7gRPe3bTtZXibcGR3icSEOmzibqnSkLhbeNhCCOlTLGbI80tnI9A/640)

#### 4.3.2 /mgmt/tm/access/bundle-install-tasks

从 diff 中可以看到`/mgmt/tm/access/bundle-install-tasks`直接将可控参数与`tar -xf`拼接，直接执行命令。可以通过反引号直接执行命令。

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYY6ndCP5reB3XHx6TAWnyZxF3VD8woPZuQRGjEElDxoZBm5X4zXvdPQ/640)

0x05   漏洞利用
-----------

### 5.1 认证不完全导致绕过

第一种方法，可以直接构造如下的包，便可以直接执行命令：

```
POST /mgmt/tm/util/bash HTTP/1.1
Host: 192.168.59.7
Content-Type: application/json
X-F5-Auth-Token: 
Authorization: Basic YWRtaW46
Content-Length: 52
```

### 5.2 ssrf 获取 token

参考 4.2.3 的总结，寻找相应获取 token 的端点，然后配合`X-F5-Auth-Token`头向命令执行端点发送请求即可。

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYSGSSHBNpMwdFribSicUGxkX0oQ23Mb91Fibp3LzulMY6SM0xeogF6ibl4g/640)![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96fpuVTc2KRwHdS26c2rGNJYn8wQeuLNfg0RGCLAI8Pr0z55gDLasesj4qozlquxKHz1BB1FVEdAFg/640)

0x06   Reference
----------------

斗象的研究文章

_https://blog.riskivy.com/f5%e4%bb%8e%e8%ae%a4%e8%af%81%e7%bb%95%e8%bf%87%e5%88%b0%e8%bf%9c%e7%a8%8b%e4%bb%a3%e7%a0%81%e6%89%a7%e8%a1%8c%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90/_

F5 BIG-IP 官方下载链接

_https://downloads.f5.com/esd/productlines.jsp_

Deploying BIG-IP Virtual Edition in ESXi

_https://techdocs.f5.com/kb/en-us/products/big-ip_ltm/manuals/product/bigip-ve-setup-vmware-esxi-13-1-0/3.html_

_Specify allowable IP ranges for SSH access__m01e 对于 F5 的漏洞配置文章_

ReadListener 官方文档

_https://docs.oracle.com/javaee/7/api/javax/servlet/ReadListener.html_

F5 BIG IP 官方 sdk

_https://f5-sdk.readthedocs.io/en/latest/_modules/f5/bigip/tm/util/bash.html_

![](https://mmbiz.qpic.cn/mmbiz_png/Ic3Rgfdm96enbZCwpavVt7Zmmb0L061eKnOZnB6kYaUJ9iceibwiayMU1hQhFsEBc9Mhse5uRlcibXaXvFOjjoyxZg/640?wx_fmt=png)推荐阅读：

1、_[安全事件周报 (03.22-03.28)](http://mp.weixin.qq.com/s?__biz=MzU5MjEzOTM3NA==&mid=2247489344&idx=1&sn=0337c5cf0542ae65cd96b786d317d59e&chksm=fe251241c9529b57b0118a738eadcf9edab182995d0a04584c7edfe06e4f92a02ed84524538c&scene=21#wechat_redirect)_

2、_[安全日报（2021.03.29）](http://mp.weixin.qq.com/s?__biz=MzU5MjEzOTM3NA==&mid=2247489344&idx=2&sn=beb9d0c705ff84cecb1eb0a771cf88ee&chksm=fe251241c9529b57e14feafd48c36473f0c0ef09b29d73de22d90e58f7bf0479ee39cd997fb4&scene=21#wechat_redirect)_

3、_[安全运营周刊](http://mp.weixin.qq.com/s?__biz=MzU5MjEzOTM3NA==&mid=2247489337&idx=1&sn=f8ed3b5bfdb4957c024dbaad1e3966dd&chksm=fe251238c9529b2e14b418428b2f8c7b34d94cd609a125af2dfc03236b50b5421ef02694d2aa&scene=21#wechat_redirect)_

长按下方二维码关注 360CERT！谢谢你的关注！

![](https://mmbiz.qpic.cn/mmbiz_jpg/Ic3Rgfdm96eS0L4ATySCia0HkpjGczsa7Jvo1pojjhzVp3EsJfSKN3rxzTchs0dbICrb9iavTEhiagBSZQ5jHJlmg/640)

注：360CERT 官方网站提供 《CVE-2021-22986：F5 BIG-IP iControl REST 未授权远程命令执行漏洞分析》 完整详情，点击阅读原文