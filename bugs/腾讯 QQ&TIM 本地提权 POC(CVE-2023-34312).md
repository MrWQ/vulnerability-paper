> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Q4ZlbXhzpFPF8TjGT3mrEA)

****声明：****请勿利用文章内的相关技术从事非法测试，由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，海底生残月及文章作者不为此承担任何责任。
==============================================================================================

现在只对常读和星标的公众号才展示大图推送，建议大家能把**海底生残月** “**设为星标**”，否则可能就看不到了啦！  

**0x01 漏洞描述  
**

       腾讯 QQ 和 TIM 是深圳市腾讯计算机系统有限公司开发的两款即时通讯软件。它们都有一个组件 QQProtect.exe，位于 %ProgramFiles(x86)%\Common Files\Tencent\QQProtect\bin. QQProtect.exe 作为名为 QPCore 的 Windows 服务安装，并 NT Authority\SYSTEM 在系统启动时自动运行。组件 QQProtect.exe 及其依赖的 DLL QQProtectEngine.dll 均存在任意地址写入漏洞。低权限攻击者可以结合这两个漏洞在 QQProtect.exe 进程中加载恶意 DLL 并获取 NT Authority\SYSTEMshell。

**0x02 影响范围**

```
受影响的产品：
QQ 9.7.1.28940 ~ 9.7.8.29039
TIM 3.4.5.22071 ~ 3.4.7.22084
受影响的组件：
QQProtect.exe 4.5.0.9424（在 TIM 3.4.5.22071 中）
QQProtect.exe 4.5.0.9426（在QQ 9.7.1.28940中）
QQProtectEngine.dll 4.5.0.9424（在 TIM 3.4.5.22071 中）
QQProtectEngine.dll 4.5.0.9426（在QQ 9.7.1.28940中）

```

**0x03 漏洞复现  
**

第一个漏洞是 QQProtect.exe+0x40c9f8 处的代码：

![](https://mmbiz.qpic.cn/mmbiz_png/fYSUHibFMoaJuG2Ibtyibyxx9bD5hr3jRg4qRzPZTtSTAZPbiagh9WiaN2Kv2tedYk2IdIniaPhsXMPLAb6hemNdnjg/640?wx_fmt=png)

其中`a2`是一个可以被攻击者控制的指针，`dword_41a740`是一个全局变量，其值`0x00000001`。因此攻击者可以在任意地址写入该值`DWORD(1)`。

第二个漏洞是 QQProtectEngine.dll+0x3B4F6 处的代码：

![](https://mmbiz.qpic.cn/mmbiz_png/fYSUHibFMoaJuG2Ibtyibyxx9bD5hr3jRgcAAKnxoKR0Fl1etIOX1w5QperTJ57aaOtWfwz7w5sehpbPBYdc3pibw/640?wx_fmt=png)

其中`v3`是可以被攻击者控制的指针。因此攻击者可以`std::bit_cast<DWORD>(ptr) + 4`在任何给定的地址写入该值`ptr`。

`QQProtect.exe`由于`QQProtect.exe`没有 ASLR 保护，攻击者可以轻易篡改改驻留的函数指针并利用 ROP 链执行任意代码。

poc 代码是用 Rust 语言编写的。您应该使用`i686-pc-windows-msvc`工具链来编译它。

```
$ cd poc
$ cargo +stable-i686-pc-windows-msvc build --release --config "build.rustflags = [\"-C\", \"target-feature=+crt-static\"]"

```

你将得到两个 DLL：

```
target\release\tinyxml.dll
target\release\evil.dll

```

然后将上面的两个 Dll 放到**_`%ProgramFiles(x86)%\Common Files\Tencent\QQProtect\bin\QQProtect.exe`_**一个文件夹中。

**_`NT Authority\SYSTEM`_**最后用一个命令获取 shell：

```
$ QQProtect.exe <PATH TO evil.dll>

```

![](https://mmbiz.qpic.cn/mmbiz_png/fYSUHibFMoaJuG2Ibtyibyxx9bD5hr3jRgSuiaYNAPT7sTKMHz12Re8YCj1kyGIQKTMdxiaxHbHypzsTOHS6rE01CQ/640?wx_fmt=png)

**0x04 工具下载**

**点击关注下方名片****进入公众号**

**回复关键字【本地提权****】获取****下载链接**