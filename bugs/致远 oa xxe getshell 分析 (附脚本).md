> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/efuMlGrjYsUjP7nP3W2F4w)

**0x01 前言**
-----------

最近看到有大佬公布了致远 xxe 的后利用，简单来说就是通过 xxe 漏洞去打本地 60001 端口 Agent 服务的 testDBConnect 接口，因为用户可通过传递 driverClass 参数自定义数据库 driver，所以可以通过控制 JDBC Connection URL 打 H2 RCE 执行任意代码来获取权限。

这个 xxe 漏洞的 URL 是建议大家好好去跟一下，一个绕过吧前几年就已经有了，感兴趣的可以去看看。

过程就不详细带大家看了，就直接看一些重要位置。还有就是我新建了一个小密圈，暂时是免费的 (0.1 100 张券)，主要是为了方便交流与反馈，然后就是之后有一些工具、文章、漏洞等我也会放到里面，希望与兄弟们一起打造我们的小圈子，这个漏洞的脚本我已经放到了小密圈，大家文末扫码进入即可。

**0x02** **漏洞分析**
-----------------

**XXE 漏洞  
**可以看到主要有四个参数需要传递，encode 设置为 true 获取参数的时候会进行 base64 解码，elemId 不为空可以进入循环体即可，imgvalue 传入内容长度大于 65 即可。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUmeibfOul0WQUqibbFLHHqN5YOlMbYbdCoT2UwSRcCjIiaDic6icAntatjIOQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUm3vczQOg0l46uwQHabmpAvuGvOu9FQ7tcEQ3eicP45wE9YNBvuxFqgzg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUm3HWgD8RalBcQE7tn7WYayFUM3fIj1OMPZ3PbJFny22qw6bJ5U3EhWQ/640?wx_fmt=png)

然后会进入 signature 方法，它接收 xmlValue 并调用 runSignature。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUmS5qYO45582vfP1hEEDo6dnojsJVBicicv4Y243bsGXWjBmS4TxMSXlNQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUmNxMlicZupvmXqKSf35XNV71qT1vFq4VtYLXCe54Syp7gQE5kI1GVkCg/640?wx_fmt=png)

runSignature 调用了 xmlToList，xmlToList 调用了 getNodes，最后调用 saxReader.read 解析 xml 造成了 XXE 漏洞。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUm9FZemcRHt3kjiaSck2XTZHgzbQ3GXvc7CEkyz1ag2KicRY3CXomzxdmQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUmricSkqRvSpYfVPaaib8D1YEVX726hK7q0TDBic7Kscp9L6InmUOODbv3g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUmDxiacXnxiaaHXm9EEywPxewMLucntlcicicluRF2M24J9ucGUHbiczHFdlA/640?wx_fmt=png)

**JDBC 反序列化  
**driverClass 可控，调用 testDBConnect 进而调用 getConnection。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUm65fAADLW9EuefDW7Y0NRuk9qXGBN2oHy6hq6gc261EF87Nox90a8yQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUmsPgWiap5TEIic2Geia9o3vDXBMnBlLq5LicibW4U8aEicFDzbqmZoXd4ORFw/640?wx_fmt=png)

直接访问发现全局拦截器判断了用户 token，首先需要 token 不为空还要满足 TokenUtils.isChecktoken 的条件才会返回 true。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUmMfstIZ4FtY4bst1ibbibe2v17bDk7cupeDq7jtwllzK8lnW4hgSS8nyA/640?wx_fmt=png)

tokenMap 中如果包含传递的这个 token 就会返回 true。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUmxsdXicwVCIElKiaibiaFJhw1CJniaGia6JgGvChnFq9eO7iaiaDjibjMBO6yf0w/640?wx_fmt=png)

全局搜索 tokenMap. 发现 TokenUtils 类中的 getToken 调用了 tokenMap.put 将 token 存入。  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUmoJImAN5u4g4k9kBHrlNn84u5oIiafjRIwLdgSZoeBJYVsKvian4IsEicQ/640?wx_fmt=png)

全局搜索调用 TokenUtils 类 getToken 方法的位置，需要传递两个参数，传递之后会将传递的数据进行处理 (看注释)，最后经过 toJavaBean 的转换传递给各个变量。  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8OqmzLyJNSB27j7ajerNnxS6T2DQswpa4Z9dbcaKv2vdB5BkzgsedC3WGNibT2ZWIEF0Sw0984WzbQ/640?wx_fmt=png)

可以看到在调用 TokenUtils 类的 getToken 方法之前，还判断了 seeyon 用户的密码，校验通过之后才会生成 token 存进 tokenMap，最后返回 token 到响应体。所以此时需要知道 seeyon 用户的密码。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUmOsMe3Wkia9BcFhWT0ZjzSjnSicHcwsSLrTXKPBYr3Nql8I4gfP3nBlQQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUmpRRoDMEpxzGiaicuudJJXf9bXKgaZjYa0wuZ2j8fXQjj3rfia3ThMLB9A/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUm6tqX55XicqUZWpCiaB87BDFZ9dNkXictYnBYRqgjhibZb4ZG5Vfr2qjBcQ/640?wx_fmt=png)

在 Dao 层搜 seeyon，可以看到 modifyDefaultUserInfo 修改了 seeyon 用户的密码。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUmaE8MaBINA5erPjXDic5QlktHH2oLCnOAubtnbcwdac6SKiaqfEeQdqww/640?wx_fmt=png)

Service 层没有任何条件直接调用 Dao 层这边修改了 seeyon 用户的密码。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUm4alEUJunccLec46wWgnZOTic3qDrzyx72I9l1esTYIDrFC8Mq395Ppw/640?wx_fmt=png)

Controller 这边也是直接接收了参数，然后调用了 Service 层的 modifyDefaultUserInfo 方法。  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUm8aoNiaowCPqOxbHLm2SVibS022K3BB1M27Sf7SXRLPkQ5LH7Y1cymPJQ/640?wx_fmt=png)

**0x03 漏洞复现**
-------------

将 111.xml 与 222.xml 放到 vps，开一个 web 端口，修改 111.xml 与 222.xml 中外带数据的请求地址为你的 vps web 端口地址，之后修改拼接 xmldata1 进行密码重置。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUmMJbUCgNkIFGVt9RyqAslZ0t2gOYuaY3WpA1MTIzqPXWrtVRMNrOL0A/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUmCH1LYyNne6IYVPgPF27Cnue9WZksFOzQNBSoPfGFx86VpSs9zPCxHQ/640?wx_fmt=png)

修改为 xmldata2 获取 token。 

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUmzZrIJ7uGnuU3DKXoraXw1tPyeazUcAibicUsS0W7QL0EiawI9kwyjmUfQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUmeChP2W4pDD1DbcEjAnquVBTdmldFNzGaYZ3k5uxlYJK6LoPkMaiaONA/640?wx_fmt=png)

修改上传的文件名以及内容，拼接 xmldata3 运行即可。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUmlMtNPd9mmfIyKKI7yArNibBNOf5Lhx16iaPqN9AUKzLyB2Hjng0ABDmw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUmJhwtucrIZRnduVpKF55ibxcjx0ptHQ9dibJDIlxfQA9qjm92Pm0EDtkQ/640?wx_fmt=png)

成功上传。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/9zZrDr2DM8Owibd4KBYdOs1ec8olCHbUmicjANECuKUCrwH48kEJOoZ72JllMKLToKZYRl5uia0tibPt8n3XQp9XUw/640?wx_fmt=png)

**0x04 小密圈**
------------

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/9zZrDr2DM8OqmzLyJNSB27j7ajerNnxShuiavCTJBmZOgqvF5eHDmfDkAkMp0nLkL8DRJzPf8BI7QtVEPibgY8ibg/640?wx_fmt=jpeg)