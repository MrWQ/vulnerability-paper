> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/9YhYOqE-P44kb1oCV9FITQ)

欢迎关注公众号，更多资料

介绍
--

SSH-Agent 是 SSH 的一部分，它是一个用于管理私钥并支持公钥身份验证的程序。用户使用 SSH-Agent 转发代理功能连接攻击者恶意服务器时，由于 SSH-Agent 未对加载的共享库进行限制，攻击者可通过将恶意共享库作为参数传递给 SSH-Agent 并通过其调用 dlopen/dlclose 函数加载 / 卸载位于用户客户端主机的共享库，实现远程代码执行。

环境准备
----

目标：目标是提升特权并损害 “alice” 帐户。

机器：

*   workstation 受害者机器
    
*   kali 攻击者 hacker 机器
    

用户：

*   redqueenerbel
    
*   alice
    
*   root(hacker)
    

可以看到目前 redqueenerbel 为非特权用户，且无法访问 alice 文件夹

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ycCk5rOJqJ69P8YFIubabXGHXziaHlibU4ktZSTZTCbaM0ibVOTsIAkPO5h2nJcbFm84K0SQwszlNSFhLgwdiaicm7Q/640?wx_fmt=png)

### 第一步：添加 Alice 的公钥

将 Alice 的公钥添加到 kali 机器的 authorized_keys 文件中。

```
echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCs4FT0kCeBfQ1co/PeApZn3NmZ68mUwEEbtP598IcBBDgpe+AauGtOVNxsptmZD26yjhTXp4RJgrreUgPJQ8ICDUvASD/2W8GOl5XpYddbrcHy+djyViQV/69VskB2Y9LCobbkYPBUjIKlObqgamM7HhcNO3Zu65AAtbu+31+N+swygYjTRB37cjQOLgI7FM9nmuhyb8uSMtttTJRD7ybXPfiHV8YxLENuJU0BGggc9i/hXKQKwhEvnliiqw/XdpK/JyT6t65DFvYYkT21bPHpBDMNzPauUgr2yagKMFNe8HFQfk/QibTcLMeV0JmCGeOcv8oJP/T4xJnnoetMvZGEPZ4hXH7E3n2wksLjuF2se61/c+SIh6Zm+gUYQESTAmmbRPeTj7RcZPRN22knpSyu76eZKBf/dmHYXQlIk1gKsouFdposOpxYRJ4Wt97uEPihW/wzzT+QPcLyYoGpbFXJmpqNaOBVJw1n0KqB98dL5Ixa32FKTCzaBPHkDmK/I2M= alice@workstation" >> /root/.ssh/authorized_keys

```

### 第二步：创建 IP 文件

接下来，在 workstation 上创建一个名为 / tmp/ip.txt 的文件。在该文件中，将攻击者 kali 的 IP 地址写为其内容。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ycCk5rOJqJ69P8YFIubabXGHXziaHlibU4o4njEKNL9icN5OI7mpUGlbo6C07wQTJt2b4hFKOnnTmgEpiaGXjtjyQQ/640?wx_fmt=png)

### 第三步：等待连接

此时，受害者机器应该在一分钟内收到来自攻击者机器的连接。

攻击过程
----

对于这个特定的场景，我们将使用两台机器：工作站（Ubuntu 21.04 的一个易受攻击的实例）和另一台受攻击者控制的服务器（kali 机器）。为了模拟易受攻击的实例，在上一个任务中使用了工作站和服务器之间的连接。有一个用户 alice 使用 SSH 代理转发从工作站连接到攻击者。Alice 通过执行以下命令来实现这一点（我们复现过程不必执行）：

```
alice@workstation:~$ eval `ssh-agent -s`
Agent pid 1286
alice@workstation ~ [SIGINT]> ssh root@10.10.157.249 -A

```

**攻击：**

在这个阶段，将侧面加载几个库。需要注意的是，这些库将从攻击者的终端中执行，但其影响将直接针对目标工作站。为了在易受攻击的进程（ssh-pkcs11-helper）中执行 shell 代码，下面的操作会将该进程的堆栈标记为可执行：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ycCk5rOJqJ69P8YFIubabXGHXziaHlibU4bBkWTf5iblHuXVl1eAghmu6Jcj7BjGYYhPD2icFBXicYScZhCI3dXqfzQ/640?wx_fmt=png)

> 要使用 SSH 套接字将外壳代码复制到进程中，需要执行以下步骤：1. 获取远程攻击者计算机上运行的 SSH 代理的 PID。2. 一旦有了套接字，就使用 netcat（nc）将 shell 代码传输到代理的内存（工作站）3. 开始传输后，等待几秒钟，以确保外壳代码完全复制到目标内存中。4. 最后，在 shell 代码成功放入代理的内存后，按 Ctrl-C 停止 netcat 传输。

下一个命令将不使用 ssh-add。因为恶意 payload 大约是 10KB 的 passphrase，而 ssh-add 的限制是 1KB。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ycCk5rOJqJ69P8YFIubabXGHXziaHlibU41l91icpB0ZZzhal9QZN8wEOxMJEWbTAWeE2JaqMCaFVqm3ibAbE4txcA/640?wx_fmt=png)

下一步是为分段故障（SIGSEGV）信号注册信号处理程序。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ycCk5rOJqJ69P8YFIubabXGHXziaHlibU4vHxyWTWomxnEmrhVXU1hXzH9dOqaM2aawxWa62nPUbxgFXeA2kbcQg/640?wx_fmt=png)

成功注册 SIGSEGV 的自定义信号处理程序后，利用过程中的下一个关键步骤是用精心选择的 gadget 替换原始信号处理程序例程。这个 gadget 将作为重定向程序执行流的手段，并在触发 SIGSEGV 信号时跳转到堆栈中。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ycCk5rOJqJ69P8YFIubabXGHXziaHlibU4jRryiaQibNNCzNhFXzWavBsCDzLtfQ9W2CJlFkBauuNeG5MiclK0JyMBg/640?wx_fmt=png)

最后，通过故意造成分段故障，可以触发 SIGSEGV 事件，执行 shell 代码：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ycCk5rOJqJ69P8YFIubabXGHXziaHlibU4xibCIQm1PU9zetVKrgss6MLaYjclr4kMtZ1ia5WjibLO6y5ThlE8h07Dw/640?wx_fmt=png)

成功执行该攻击后，攻击者可能会访问绑定 shell（shell 代码），该 shell 可以使用 netcat 进行访问。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ycCk5rOJqJ69P8YFIubabXGHXziaHlibU4kaH8qo8icokaH5nEW3yiaA6z8FC9J9TVUiaCBWaOTPLKn3vwYsxMzfhDA/640?wx_fmt=png)