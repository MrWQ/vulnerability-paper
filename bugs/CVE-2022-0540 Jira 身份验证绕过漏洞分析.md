> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [paper.seebug.org](https://paper.seebug.org/1961/)

> 作者：xxhzz@星阑科技 PortalLab 原文链接：https://mp.weixin.qq.com/s/fEhzBTl3SVVE072ubwi6EA

**作者：xxhzz@星阑科技 PortalLab  
原文链接：[https://mp.weixin.qq.com/s/fEhzBTl3SVVE072ubwi6EA](https://mp.weixin.qq.com/s/fEhzBTl3SVVE072ubwi6EA)**

前言
--

在上篇分析 [CVE-2022-26135Atlassian Jira Mobile Plugin SSRF 漏洞](http://mp.weixin.qq.com/s?__biz=Mzg3NDcwMDk3OA==&mid=2247483981&idx=1&sn=66f22ccf39f434401c24ee38ba73a0f2&chksm=cecd8b90f9ba0286ed40e9942dd42a23727c79771a582b6c39afd862a82e0b87f051c037a544&scene=21#wechat_redirect)之后，发现在此之前，jira 也曾爆出过身份验证绕过漏洞，CVE 编号为 cve-2022-0540。趁着环境还热乎，对其产生的原理和代码进行一波分析和学习。

漏洞描述
----

Atlassian Jira 是澳大利亚 Atlassian 公司的一套缺陷跟踪管理系统。该系统主要用于对工作中各类问题、缺陷进行跟踪管理。攻击者可利用此漏洞向目标系统发送特制的 HTTP 请求，以使用受影响的配置绕过 WebWork 操作中的身份验证和授权要求。

利用范围
----

**Jira**

*   Jira 所有版本 < 8.13.18
*   Jira 8.14.x、8.15.x、8.16.x、8.17.x、8.18.x、8.19.x
*   Jira 8.20.x < 8.20.6
*   Jira 8.21.x

**Jira Service Management**

*   Jira Service Management 所有版本 < 4.13.18
*   Jira Service Management 4.14.x、4.15.x、4.16.x、4.17.x、4.18.x、4.19.x
*   Jira Service Management 4.20.x < 4.20.6
*   Jira Service Management 4.21.x

漏洞分析
----

### 环境搭建

本次环境使用 docker 搭建 Dockerfile

```
FROM atlassian/jira-software:8.13.17
USER root
COPY "atlassian-agent.jar" /opt/atlassian/jira/
RUN echo 'export CATALINA_OPTS="-javaagent:/opt/atlassian/jira/atlassian-agent.jar  -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 ${CATALINA_OPTS}"' >> /opt/atlassian/jira/bin/setenv.sh
```

5005 为 idea debug 端口；atlassian-agent.jar 项目地址：[https://github.com/hgqapp/atlassian-agent](https://github.com/hgqapp/atlassian-agent)，使用 maven 编译为 jar 文件即可。

后续创建容器根据提示配置。

![](https://images.seebug.org/content/images/2022/09/08/1662606870000-1mqzbv.png-w331s)

调试源码：将以下三个文件夹设置为 Libraries。

```
\atlassian-jira-software-8.13.17-standalone\lib
\atlassian-jira-software-8.13.17-standalone\atlassian-jira\WEB-INF\classes
\atlassian-jira-software-8.13.17-standalone\atlassian-jira\WEB-INF\lib
```

### 前置知识

在漏洞分析之前，先简单了解一下 Jira 相关的背景知识。

### WebWork

Jira 使用 MVC 框架 WebWork 来处理用户发起的 WEB 请求。每个请求都是使用 WebWork action 来处理，在其中又使用了其他的 utility and Manager classes 来完成一个任务。作为响应返回给客户端的 HTML 大部分都是 View 层的 JSP 生成的。URL 中的”.jspa” 后缀标识其后端对应的是一个 JSP 文件。

### Seraph

Seraph 是一个开源认证框架，主要由 Atlassian 开发和维护。Jira、Confluence 的登录认证是都由 Seraph 来负责的。Seraph 是通过 Servlet 的 Filter 实现的。Seraph 的功能只是用来在给定一个 Web 请求的情况下，将该请求与特定用户相关联。

### 动态分析

通过前置知识可以了解到 Seraph 是一个开源认证框架，也是 jira 核心身份验证机制。Seraph 是通过 Servlet 和 Filter 实现的。

查看 Filter，发现 com.atlassian.jira.security.JiraSecurityFilter.class

在 doFilter 中调用父方法 super.doFilter

![](https://images.seebug.org/content/images/2022/09/08/1662606871000-2gkoci.png-w331s)

com.atlassian.seaph.filter.SecurityFilter#doFilter

这里处于 atlassian-seaph-4.0.4.jar 中 filter 也就是 seraph 过滤器，它会根据请求用户权限进行判断，进一步确定所需要的角色，确定是否需要认证。

![](https://images.seebug.org/content/images/2022/09/08/1662606874000-3krtio.png-w331s)

持续跟进，发现会通过循环会出现三种 Service

JiraPathService

![](https://images.seebug.org/content/images/2022/09/08/1662606874000-4ydbvy.png-w331s)

JiraPathService 是处理：如果请求的 servlet 路径以 /secure/admin/ 开头，那其角色权限必须是 admin（管理员权限）。

![](https://images.seebug.org/content/images/2022/09/08/1662606874000-5zjolv.png-w331s)

WebworkService

![](https://images.seebug.org/content/images/2022/09/08/1662606874000-6kntzz.png-w331s)

WebworkService 则是在 actions.xml 文件中获取角色所需要的 webwork 配置。

![](https://images.seebug.org/content/images/2022/09/08/1662606874000-7scefz.png-w331s)

经过调试，会多次进入 getRequiredRoles 函数，其中获取 URl 的方式为 getRequestURL。

![](https://images.seebug.org/content/images/2022/09/08/1662606875000-8xwvwj.png-w331s)

继续跟进发现在通过 getRequestURL 方式提取请求 URL 后，会通过提取最后一个 / 后面的接口产生一个 targetURL，这里传入的是 / secure/InsightPluginShowGeneralConfiguration.jspa，而 targetURL 为 / InsightPluginShowGeneralConfiguration.jspa

![](https://images.seebug.org/content/images/2022/09/08/1662606875000-9lcxdk.png-w331s)

JiraSeraphSecurityService

![](https://images.seebug.org/content/images/2022/09/08/1662606875000-10fupdw.png-w331s)

继续往下就是第三个服务 JiraSeraphSecurityService，作用是在所有插件的 atlassian-plugin.xml 文件中获取角色所需的 webwork 操作配置。

![](https://images.seebug.org/content/images/2022/09/08/1662606875000-11ddrga.png-w331s)

在跟进 JiraSeraphSecurityService 时，发现会调用 WebworkPluginSecurityServiceHelper.getRequiredRoles，和 WebworkService.getRequiredRoles 代码是相同的。

![](https://images.seebug.org/content/images/2022/09/08/1662606876000-12isguo.png-w331s)

接口权限必须是 admin。

![](https://images.seebug.org/content/images/2022/09/08/1662606876000-13rdwwi.png-w331s)

在 com.atlassian.jira.web.dispatcher.JiraWebworkActionDispatche 中会对 jspa 进行处理。

service 函数会从请求中获取 Action 名称，后续使用 / 和。jspa 切割字符来获取 ActionName。

![](https://images.seebug.org/content/images/2022/09/08/1662606876000-14zyblr.png-w331s)

![](https://images.seebug.org/content/images/2022/09/08/1662606876000-15udeyk.png-w331s)

在 webwork.dispatcher.GenericDispatcher#executeAction 函数，会对 Action 进行检查。

![](https://images.seebug.org/content/images/2022/09/08/1662606877000-16jnbvw.png-w331s)

系列 Action 工厂。

![](https://images.seebug.org/content/images/2022/09/08/1662606877000-17puqxq.png-w331s)

如上分析，其实目前已经知道在 Filter 中提取 URL 的方法是 getRequestURL，在 Servlet 中使用 getServletPatch。

在 URL 加入上 “;”，传入 / secure/InsightPluginShowGeneralConfiguration.jspa; 那么在 Filter 中无法找到 InsightPluginShowGeneralConfiguration.jspa；对应的 Action，后续进入 Servlrt 处理，而 getServletPath 会将; 删除，这样也就绕过了 Filter 层的认证。

![](https://images.seebug.org/content/images/2022/09/08/1662606877000-18ypqqq.png-w331s)

但实际效果上，这样还需要进行验证才能访问资源。

![](https://images.seebug.org/content/images/2022/09/08/1662606877000-19cyaaa.png-w331s)

继续动态调试发现。

在 LookupAliasActionFactoryProxy 同样进行了权限检查。

![](https://images.seebug.org/content/images/2022/09/08/1662606877000-20qppoa.png-w331s)

参考了其他大佬分析的文章，了解到在编写插件的时候可使用 webwork1 元素添加 roles-required 属性。这里直接使用受影响的插件 insight8.9.10 进行复现。

添加角色属性可参考 [https://developer.atlassian.com/server/jira/platform/webwork/](https://developer.atlassian.com/server/jira/platform/webwork/)

### 漏洞复现

在官网上下载插件 Insight8.9.10 版本。

![](https://images.seebug.org/content/images/2022/09/08/1662606877000-21jguun.png-w331s)

![](https://images.seebug.org/content/images/2022/09/08/1662606878000-22blzzz.png-w331s)

上传成功后，在未登录的情况下，访问 / secure/InsightPluginUpdateGeneralConfiguration.jspa;

![](https://images.seebug.org/content/images/2022/09/08/1662606878000-23jftna.png-w331s)

成功绕过登录认证限制。

修复建议
----

受影响用户可将产品更新至最新安全版本，具体参考官网公告： [https://jira.atlassian.com/browse/JRASERVER-73650](https://jira.atlassian.com/browse/JRASERVER-73650)

参考材料
----

1.[https://jira.atlassian.com/browse/JRASERVER-73650](https://jira.atlassian.com/browse/JRASERVER-73650) 2.[https://developer.atlassian.com/server/jira/platform/webwork/](https://developer.atlassian.com/server/jira/platform/webwork/) 3.[https://marketplace.atlassian.com/apps/1212137/insight-asset-management/version-history](https://marketplace.atlassian.com/apps/1212137/insight-asset-management/version-history) 4.[https://blog.viettelcybersecurity.com/cve-2022-0540-authentication-bypass-in-seraph/](https://blog.viettelcybersecurity.com/cve-2022-0540-authentication-bypass-in-seraph/)

![](https://images.seebug.org/content/images/2017/08/0e69b04c-e31f-4884-8091-24ec334fbd7e.jpeg) 本文由 Seebug Paper 发布，如需转载请注明来源。本文地址：[https://paper.seebug.org/1961/](https://paper.seebug.org/1961/)