> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/p4XFhwdwLUQDin14g95Tvw)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOQ4y3CslMX5EINOxRsoicGxHxJnwtXjIau4usI94yHUKXTqh4LyuVL4A/640?wx_fmt=gif)

因全文整体内容较长，将文章拆分为多篇在本公众号发出，欢迎大家关注~

往期内容阅读：  
[九维团队 - 红队（突破）| 云安全 - Docker 逃逸手法（上）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247526399&idx=1&sn=742aa9945173f63fecf46ee51a2e1c77&chksm=9ae126c7ad96afd1019531af19447bc83adcb50a00bd9103ea6f48d3974e0594bc4189db1fd5&scene=21#wechat_redirect)  
[九维团队 - 红队（突破）| 云安全 - Docker 逃逸手法（中）](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247529256&idx=1&sn=6a600f47b082f2f6abb0bd9ac2007409&chksm=9ae13210ad96bb0613dbb1d33045630f116d428cdb44af33728fceb3aa98bc794fb58f210769&scene=21#wechat_redirect)  

  

  

_**4.3 逃逸方法三：Docker CP 缺陷 CVE-2019-14271**_

**漏洞描述：** 

当 Docker 宿主机需要从容器内复制文件到宿主机时，使用 cp 命令，会调用辅助进程 docker-tar，但该进程没有被容器化，docker-tar 不受 cgroup 或 seccomp 的限制，且会在运行时动态加载一些 libnss.so 库。黑客可以通过在容器中替换 libnss.so 等库，将代码注入到 docker-tar 中。

当 Docker 用户尝试从容器中拷贝文件时将会执行恶意代码，成功实现 Docker 逃逸，获得宿主机 root 权限。（高权限进程自身未容器化，却加载了不可控的动态链接库，通过修改容器内动态链接库来实现在宿主机上以 root 权限执行任意代码。）

在这两种情况下，攻击者就可以宿主机上的 root 代码执行权限。

*   容器运行含有恶意 libnss_*.so 库的镜像；
    
*   容器中含有被攻击者替换的 libnss_*.so 库。
    

部分细节说明： 

当执行 CP，从容器内复制文件到宿主机，docker-tar 原理：docker cp 命令在容器中打包和解包文件时，分别会调用 docker-tar 和 docker-untar 命令。为了防止这两个命令的写操作影响到宿主机，在执行具体操作前，进行了 chroot。

根据文章《docker-tar,docker-untar 源码分析》中介绍，这些函数是不受 capbility,seccomp 和 LSM 的限制的。会切换进程的根目录（执行 chroot）到容器根目录，然后将需要复制的文件或目录打 tar 包传递给 Docker daemon，Docker daemon 负责将内容解包到用户指定的宿主机目标路径。

```
《docker-tar,docker-untar源码分析》原文链接：
https://ssst0n3.github.io/post/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/%E5%AE%89%E5%85%A8%E7%A0%94%E7%A9%B6/%E5%AE%B9%E5%99%A8%E5%AE%89%E5%85%A8/%E8%BF%9B%E7%A8%8B%E5%AE%B9%E5%99%A8/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%B9%E5%99%A8/docker/docker%E6%BA%90%E7%A0%81%E5%AE%A1%E8%AE%A1/docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/docker-tardocker-untar%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.html

```

‍* 左右滑动查看更多

**影响版本：**

官方说是只有 Docker 19.03.0，19.03.1 以上以及 18.09 以下都不受影响。但实际 18.09.9<=docker<19.03.8。

静态编译

*   不受影响
    

非静态编译

*   19.03.0 <= docker < 19.03.1 受影响
    
*   docker=18.09.9, 19.03.1 <= docker < 19.03.8 有条件受影响 (在宿主机加载 nsswitch 共享库失败)
    
*   18.09.0 <= docker < 18.09.8 不受影响
    

docker=18.09.9, 19.03.1 <= docker < 19.03.8 有条件受影响。

```
* ubuntu18.04-docker19.03.5 [https://github.com/moby/moby/issues/39449# issuecomment-570729463](https://github.com/moby/moby/issues/39449# issuecomment-570729463)
* debian9.11-docker19.03.5 [https://github.com/moby/moby/issues/39449# issuecomment-572993986](https://github.com/moby/moby/issues/39449# issuecomment-572993986)
* docker19.03.5 [https://github.com/moby/moby/issues/39449# issuecomment-573635439](https://github.com/moby/moby/issues/39449# issuecomment-573635439)
* ubuntu16.04amd64-docker19.03.6 [https://github.com/moby/moby/issues/39449# issuecomment-587187043](https://github.com/moby/moby/issues/39449# issuecomment-587187043)
* Ubuntu16.04.4amd64-dockerce19.03.4 [https://github.com/moby/moby/issues/40211](https://github.com/moby/moby/issues/40211)
* Ubuntu16.04.6-docker19.03.5 [https://github.com/moby/moby/issues/40211# issuecomment-562973937](https://github.com/moby/moby/issues/40211# issuecomment-562973937)
* Ubuntu18.04.5-docker19.03.6 [https://github.com/moby/moby/pull/39612# issuecomment-848854698](https://github.com/moby/moby/pull/39612# issuecomment-848854698)

```

* 左右滑动查看更多  

**漏洞利用：**

虽然危害挺大，但因为这种逃逸在实际利用中的效果不大，需要特定场景才会触发逃逸效果—宿主机执行了 cp 复制目录，就不进行详细截图了，简单了解以下利用流程即可。

利用思路：

1、找出 docker-tar 具体会加载哪些容器内的动态链接库；

2、下载对应动态链接库源码，为其增加一个__attribute__((constructor)) 属性的函数 run_at_link（该属性意味着在动态链接库被进程加载时，run_at_link 函数会首先被执行），在 run_at_link 函数中放置我们希望 docker-tar 执行的攻击载荷（payload）；编译生成动态链接文件；

3、编写辅助脚本”/breakout“，将辅助脚本和步骤二生成的恶意动态链接库放入恶意容器，等待用户执行 docker cp 命令，触发漏洞。

```
利用参考：
https://ssst0n3.github.io/post/网络安全/安全研究/容器安全/进程容器/服务器容器/docker/历史漏洞分析与复现/docker-software/plumbing/docker-cp/CVE-2019-14271/分析/CVE-2019-14271分析与复现.html
参考：
https://blog.csdn.net/qq_41667409/article/details/121557358

```

* 左右滑动查看更多

_**4.4 其他一些不太常用的逃逸的方法**_

**1、Docker Build 时的命令注入漏洞 (CVE-2019-13139)**

**漏洞描述 ：**  

攻击者能够提供或操纵 “docker build” 命令的构建路径将能够获得命令执行。“docker build”处理远程 git URL 的方式存在问题，并导致命令注入到底层 “git clone” 命令中，导致代码在用户执行 “docker build” 命令的上下文中执行。

**漏洞影响版本：**

Docker 18.09.4 之前的版本。

**攻击流程：**

```
可参照：
https://staaldraad.github.io/post/2019-07-16-cve-2019-13139-docker-build/

```

* 左右滑动查看更多

**2、Shocker 攻击  
**

**漏洞描述：** 

从 Docker 容器逃逸并读取到主机某个目录的文件内容。Shocker 攻击的关键是执行了系统调用 open_by_handle_at 函数，Linux 手册中特别提到调用 open_by_handle_at 函数需要具备 CAP_DAC_READ_SEARCH 能力，而 Docker1.0 版本对 Capability 使用黑名单管理策略，并且没有限制 CAP_DAC_READ_SEARCH 能力，因而引发了容器逃逸的风险。

漏洞影响版本：

Docker 版本 1.0， 存在于 Docker 1.0 之前的绝大多数版本 (目前基本上不会存在了) 。

POC：

```
https://github.com/gabrtv/shocker

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLykKiasmym7UFiccL7ClEbkyOfUmUiaMoktmxjP1qqRWfxbiamcltcHxXTOiadydeEJc6q0N6cILJkruw/640?wx_fmt=png)

  

  

  

**五、安全加固建议**

根据前文所述的风险点，可以考虑主要在以下几方面进行安全加固：  

**一、保证镜像的安全**

1) 做到最小安装原则，选择来自可信源的官方或已经验证的最小化基础镜像（没有构建历史不下载），并只安装运行所需的最小依赖。对镜像签名子进行验证。

2) 使用前，对镜像进行安全漏洞扫描、基线风险排查。删除镜像中遗留的 setuid 和 setgid 权限 (suid、sgid)。

3) 检查是否开了 2375/2376docker 管理端口，避免存在未授权访问漏洞，做好身份认证。设置 ACL，只允许信任的 IP 端口连接对应端口。

**二、保证容器的安全**

1）做好容器权限限制，使用非 ROOT 用户启用服务，不建议以 privileged（特权模式）启动 Docker，通过 capabilities 机制进行定制化的权限分级。

2）做好容器间的网络访问边界隔离，宿主机下的 docker 容器之间默认网络互通，通过使用 `-icc = false` 参数禁止容器与容器间的通信，也可以通过 `docker network create <network-name>` 新建网络来实现网络隔离。关于 docker 和宿主机通信的端口加上证书认证和加密。

3）做好容器资源隔离与限制，限制 docker 容器的网络带宽、磁盘 I/O、cpu 利用，例如配置 -memory 参数来防止一个容器消耗所有主机资源的拒绝服务攻击。

**三、Docker 的历史遗留安全问题**

1) 更新 Docker 版本到 19.03.1 及更高版本——CVE-2019-14271、覆盖 CVE-2019-5736。

2) 检查 runc 版本是否升级到 1.0-rc6 以上。

**四、定期检查**

定期检查服务器版本，打补丁包升级系统内核，避免服务器内核漏洞逃逸。

  

  

**六、小结：**

**细致调节以获得最大的安全性**

过了一遍 docker 逃逸的风险点，发现其实能够导致容器逃逸的手法还是非常多的（同时文中列举的漏洞也只是一部分，还有一些冷门洞）。在目前云安全的大环境下，Docker 逃逸的风险所带来的问题还是非常大的。

个人觉得两个地方影响还是非常明显的。一方面是内核漏洞的直接逃逸，另一方面就是因为配置导致的逃逸——” 错误配置可能远比安全漏洞更容易存在”。

**参考资料及推荐阅读：**

```
CVE-2019-5736 runc容器逃逸漏洞分析
https://x3fwy.bitcron.com/post/runc-malicious-container-escape
渗透测试之Docker逃逸
https://xz.aliyun.com/t/8558# toc-0
『杂项』Docker 逃逸方法汇总
https://mp.weixin.qq.com/s/FeOsaMgTMI0AwN7UzTjxAg
脏牛漏洞-Docker逃逸POC（dirtycow-vdso)代码分析
https://blog.csdn.net/enjoy5512/article/details/53196047
【云原生渗透】- containerd-shim容器逃逸漏洞(CVE-2020-15257)
https://zhuanlan.zhihu.com/p/471532280
host模式容器逃逸漏洞（CVE-2020-15257）技术分析
https://mp.weixin.qq.com/s/WmSaLPnG4o4Co1xRiYCOnQ
CVE-2019-14271分析与复现
https://ssst0n3.github.io/post/网络安全/安全研究/容器安全/进程容器/服务器容器/docker/历史漏洞分析与复现/docker-software/plumbing/docker-cp/CVE-2019-14271/分析/CVE-2019-14271分析与复现.html
CVE-2019-5736 runc容器逃逸漏洞分析
https://x3fwy.bitcron.com/post/runc-malicious-container-escape
Docker SYS_ADMIN 容器逃逸原理解析
https://www.freebuf.com/vuls/264843.html
Docker安全性与攻击面分析
https://zhuanlan.zhihu.com/p/152052618

```

* 左右滑动查看更多  

（完）

* * *

**往期回顾**

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zK0hx763cSsEkuJ7OAXAbS3r5LpSQFdxstG1Ujvtic9bTeFFKVBpN4lXibfXY7VUjpCkUNiboNs10ekQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247529534&idx=1&sn=34f389a3a9dfa39faf8edef7b351c681&chksm=9ae13506ad96bc10a23c9815f61b6cc70fc94f04102e90655f4cbfb60636f981198367a5fa3e&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKhWzyE8cH6mxibBa5S8YmtZZG0rzxva4HpXpGJFIo9rBCIc877yRdI0yTRCNhuhRrSk068ulNiapNQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247529473&idx=1&sn=5089ef613f8ce1a3d1815eb54c81b980&chksm=9ae13539ad96bc2fd3a379b4d5ec5c6cc5b2ca18f01e4dbd6f4b459832e31fa9df4758ccc652&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zI8xdcTd0WsQ3ibc4SpnFODqChEA2KAxW0jZgkeXSfkicPo7kFvSD26mtkawr70V60S0xK7q2y7qlPA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247529256&idx=1&sn=6a600f47b082f2f6abb0bd9ac2007409&chksm=9ae13210ad96bb0613dbb1d33045630f116d428cdb44af33728fceb3aa98bc794fb58f210769&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKpjPyCLWDplWsoicpaYve1GiaLEyKY3eGVUVSliaHWDuLD3CI6LfYib0pQQic8ibibjjV2dwof7B2lVZgMw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247529194&idx=1&sn=b1a9b20de509a2b2dc66d9c4f38705ee&chksm=9ae133d2ad96bac4f8f4a76341244f3b0dab8ed599b719d52612f7f64830f0deb0763db9c58c&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKZLkuia9xpAvxQFd3GzVSibicDVZ3X4nW1kqRPIwm4ZyWQSYwJTZYRPmYPgtsic2demqnlnouoDk9L5g/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247528506&idx=1&sn=1bf5c562ed861f22f18fbb83ebc235a8&chksm=9ae13102ad96b814f440af9988d483d77bea9f00b94e3bf858763aa7bcf0c189cb025bc2ec18&scene=21#wechat_redirect)

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/Ljib4So7yuWjVsaTygX5CCGxuYZaPeibrpfOOGAjXfTkTp3AIPeXv08iayGTH94Xcmvk4RJxs9NNSc2vzCoCiaXOSQ/640?wx_fmt=jpeg&wx_co=1&wxfrom=5&wx_lazy=1)

  

**关于安恒信息安全服务团队**

**安恒信息安全服务团队由九维安全能力专家构成，其职责分别为：红队持续突破、橙队擅于赋能、黄队致力建设、绿队跟踪改进、青队快速处置、蓝队实时防御，紫队不断优化、暗队专注情报和研究、白队运营管理，以体系化的安全人才及技术为客户赋能。**

![图片](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIFIDZlXFuQeZrcKrV7Zd8Aeg98Fw5jzbGBgUW1hVQXIV3YpLZncEYibgw7MFwWtDU5vwnE2QFVP7A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL31gt4m6YIRLh7wJeOSwYPOIblCvhN6OgHhV9NMJNH0TBianlpMmRbaKG1ia7iaPsWb4UX4ImgfEJ0A/640?wx_fmt=jpeg&wx_co=1&wxfrom=5&wx_lazy=1)

![图片](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOCUgD3ep5Jp4DE8e2S2Y3WnxsKjicicOg3OsGGRc9NPibQ61aRAqNXZQDA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)