<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/K6gTn1m7ZP5y7Djg424MGA)

### 0x01 漏洞简介

CVE-2020-1472 是一个 windows 域控中严重的远程权限提升漏洞，此漏洞是微软 8 月份发布安全公告披露的紧急漏洞，CVSS 评分为 10 分。未经身份认证的攻击者可通过使用 Netlogon 远程协议（MS-NRPC）连接域控制器来利用此漏洞，成功利用此漏洞的攻击者可获得域管理员权限。该漏洞由 Secura 公司的 Tom Tervoort 发现提交并命名为 ZeroLogon。  

### 0x02 影响范围

**Windows 受影响版本:**

Windows Server 2008 R2 for x64-based Systems Service Pack 1

Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)

Windows Server 2012

Windows Server 2012 (Server Core installation)

Windows Server 2012 R2

Windows Server 2012 R2 (Server Core installation)

Windows Server 2016

Windows Server 2016 (Server Core installation)

Windows Server 2019

Windows Server 2019 (Server Core installation)

Windows Server, version 1903 (Server Core installation)

Windows Server, version 1909 (Server Core installation)

Windows Server, version 2004 (Server Core installation)

**Samba 受影响版本：**

4.0 < Samba < 4.8 且 未配置 server schannel = yes

Samba > 4.0 且 Smb.conf 配置文件中配置了 server schannel = no 或 server schannel = auto

### 0x03 漏洞分析

**Netlogon 协议是微软提供的一套域访问认证协议，过程如下图：**

![](https://mmbiz.qpic.cn/mmbiz_png/PrTu58FA79bKJO6B8ew4Y4m6lZxU5ZzhIGDOS3qibVzLx6iaVeicmq1Cy5ibia9E80jBTH6KvZ5zkf4NIgnMY8KJCVg/640?wx_fmt=png)

Client challenge:8 字节，攻击者可控，且全部设置为 00

Server challenge:8 字节，攻击者不可控，但是可以多次发起连接，重新生成 server challenge

secret: 用户密码的 hash 

challenges: Client challenge+ Server challenge

Session key:AES 加密的密钥，由 secret 与 challenges 生成

Client credential:8 字节，由 session key 与 client challenge 加密运算生成

加密方式是 AES-CFB8，AES-CFB8 对明文的每个字节进行加密，首先由 16 个字节的初始化向量（IV）作为输入进行 AES 运算得到一个输出，取输出的第一个字节，与明文的第一个字节进行异或，得到第一个字节的密文。

第二步，由后 15 个字节的 IV 加 1 个字节的密文作为输入进行 AES 运算得到一个输出，取输出的第一个字节与明文的第二个字节进行异或，得到第二个字节的密文，以此类推，可得到 8 个字节的密文作为 Client credential。

**其运算过程如下图：**

![](https://mmbiz.qpic.cn/mmbiz_png/PrTu58FA79bKJO6B8ew4Y4m6lZxU5Zzhp8lPzxns8Y4J9Z8FOE2no70GOz4dfSic55CD6XvmkgAcfbZtcdwuIkg/640?wx_fmt=png)

黄色部分为 16 字节的初始向量 IV, 理论上为了保证 AES 算法的可靠性该部分内容应该随机生成，而微软却错误的将其全部设置为 00；蓝色部分为明文，对应 client challenge, 该部分内容攻击者可控，设置为全 00，那么整个 AES 运算过程如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/PrTu58FA79bKJO6B8ew4Y4m6lZxU5ZzhR1MgQb9Yq5pxPel41MRQwtmE37XRpBrs4Tw7ibvLsp3ibqzIqU80O0Dg/640?wx_fmt=png)

由上图可知，如果第一步的 AES 运算输出的第一个字节为 00，那么得到的第一个字节密文也为 00，并且由于后续 AES 的输入全为 00，密钥不变，所以 AES 输出的第一个字节还是 00，密文也还是 00，结果就可以得到 8 个字节全为 00 的密文作为 Client credential。

那么如何让 AES 运算输出第一个字节为 00 呢？输入全为 00，密钥不同，其输出就会不同，改变密钥，那么其输出就会改变。已知 Session key 为 AES 的密钥，session key 由 secret 与 challenges 生成，secret 与 client challenge 不变，所以只要改变 server challenge 就会密钥的值，从而改变 AES 输出的值。

攻击者可以不断发起新的连接，server 端就会生成新的 server challenge，直到 AES 输出的第一个字节为 00，那么攻击者就可以使用 8 个字节全为 00 的 Client credential 完成域身份认证。理论上平均 2^8=256 次碰撞可以得到 AES 输出的第一个字节为 00。

在整个碰撞过程中 session key 一直是未知的，攻击者可以通过设置 flag 使之后的过程不使用 session key 进行加密。

执行每个操作的调用都必须包含验证值，攻击者可以通过提供一个全零验证和一个全零时间戳来绕过。

攻击者可以利用 NetrServerPasswordSet2 调用更新密码，在该远程调用的过程中会发送新密码的密文，长度为 516 比特，后四 bit 表示密码长度，该密文是由 session key 加密的，同理设置为全 0，根据上面的 session key 加密算法其真实的密码的明文也是 0 并且长度为 0，这样就置空了 server 密码。攻击者使用 impacket 的 secretsdump，可以 dump 域内用户 hash，包括域控管理员以及 krbtgt。

**攻击者流程图：**

![](https://mmbiz.qpic.cn/mmbiz_png/PrTu58FA79bKJO6B8ew4Y4m6lZxU5Zzh9Vd4ZCROYzibjibiaZaCVgh21fxekbWVP1vQHRRFcH2Mw7ot4WeXFG51A/640?wx_fmt=png)

### 0x04 漏洞复现

**1、 复现环境**

域控: Windows Server 2012 R2

域成员：Windows 7

攻击机：kali

**2、 工具准备**

漏洞测试工具：zerologon_tester

https://github.com/SecuraBV/CVE-2020-1472

漏洞利用工具：zerologon

https://github.com/risksense/zerologon

网络协议工具：impacket

https://github.com/SecureAuthCorp/impacket

**3、 确定域控主机名及 IP**

在获取到一台域成员系统权限后，收集域控主机名及 IP 信息。

```
ipconfig /all
```

![](https://mmbiz.qpic.cn/mmbiz_png/PrTu58FA79bKJO6B8ew4Y4m6lZxU5ZzhLgX0KAw69QGNmOvrJXu6ibfUicEBWRXiaosNjrkntpJHM0g5asHmwAUVw/640?wx_fmt=png)

```
net user /domain
```

![](https://mmbiz.qpic.cn/mmbiz_png/PrTu58FA79bKJO6B8ew4Y4m6lZxU5Zzh8nxuN4aaGegXaicFEuCRrScb3vVb8mIspxibZCzMu3oplNy2hCytChZQ/640?wx_fmt=png)  

```
ping DC
```

![](https://mmbiz.qpic.cn/mmbiz_png/PrTu58FA79bKJO6B8ew4Y4m6lZxU5ZzhTZ9ySUHYRPiale8aIWeT6RKqG4KoDh9UOOn5ibVwKduDZiag8J1qQZwEw/640?wx_fmt=png)

**4、 测试域控是否存在漏洞**

```
python3 zerologon_tester.py DC 192.168.1.53
```

![](https://mmbiz.qpic.cn/mmbiz_png/PrTu58FA79bKJO6B8ew4Y4m6lZxU5ZzhcOp1zoMA9xUfUY9rKtpAuQLaMLGxGFgqJgic566Ey1DhGiah5XvUAhYg/640?wx_fmt=png)

**5、 使用漏洞利用工具置空域控机器账户的密码（**这一步可能会导致域控脱域，需要及时恢复域控机器用户 hash）。

```
python3 set_empty_pw.py DC 192.168.1.53
```

![](https://mmbiz.qpic.cn/mmbiz_png/PrTu58FA79bKJO6B8ew4Y4m6lZxU5ZzhXziaAfebMW3ibvTGJPKGfiaHLhtibehBZyBkflZad2lgo0M9hlxwmm0Pfw/640?wx_fmt=png)

**6、 使用空密码 dump 域控上的 hash**

```
python3 secretsdump.py troila.com/dc\$@192.168.1.53 –no-pass
```

![](https://mmbiz.qpic.cn/mmbiz_png/PrTu58FA79bKJO6B8ew4Y4m6lZxU5ZzhqrNyxibYXDu4B7TR1PVmKfbHFyrUOEGTPtlhvfQvoxHfdiaQpPms91Uw/640?wx_fmt=png)

**获得 administrator 的 hash 后可以尝试破解，得到明文密码**

![](https://mmbiz.qpic.cn/mmbiz_png/PrTu58FA79bKJO6B8ew4Y4m6lZxU5ZzhcXQE7LqTNKR8dYfcNIRtR1Oe3qATAUpibSHFIr9k3iaiaEBVUGdkgj73g/640?wx_fmt=png)

**7、 通过 wmiexec 使用 administrator 的 hash 获取域管权限**

```
python3 wmiexec.py –hashes  aad3b435b51404eeaad3b435b51404ee:34823259805a88a95e921f4f7e053334 administrator@192.168.1.53
```

![](https://mmbiz.qpic.cn/mmbiz_png/PrTu58FA79bKJO6B8ew4Y4m6lZxU5ZzhYS5S6oBKukryKIDm04nQ7AL7C4wqQIoLZMZJ64ibqWtUIhP0ffpP8DQ/640?wx_fmt=png)

**8、 获取目标原始 hash**

在域控主机上从注册表导出 hash 文件。

```
reg save HKLM\SYSTEM system.save
reg save HKLM\SAM sam.save
reg save HKLM\SECURITY security.save
```

![](https://mmbiz.qpic.cn/mmbiz_png/PrTu58FA79bKJO6B8ew4Y4m6lZxU5Zzhr1rbwlCLVYl78AJkS4Stapy11pn2XK3thicibH2VZe3dZ7mpUoQMQHibg/640?wx_fmt=png)

将导出的 hash 文件下载到本地。

```
get system.save
get sam.save
get security.save
```

![](https://mmbiz.qpic.cn/mmbiz_png/PrTu58FA79bKJO6B8ew4Y4m6lZxU5Zzh2jjsHe0ZEXPBWYRNMHsWFymINdTQEngOawTCHKb3BTicOacLLkreJlQ/640?wx_fmt=png)

在域控主机上删除导出的 hash 文件。

```
del /f system.save
del /f sam.save
del /f security.save
```

![](https://mmbiz.qpic.cn/mmbiz_png/PrTu58FA79bKJO6B8ew4Y4m6lZxU5ZzhWONU0Uuzaab4LO8OPT2F0YI9lWcguUs8kHvmDHFQu4Tf8AU5sWF67Q/640?wx_fmt=png)

使用 secretsdump 读取下载到本地的 hash 文件, 获取域控机器账户置空前的原始 hash。

```
python3 secretsdump.py –sam sam.save –system system.save –security security.save LOCAL
```

![](https://mmbiz.qpic.cn/mmbiz_png/PrTu58FA79bKJO6B8ew4Y4m6lZxU5ZzhytYianPWBBgXtVTVspcoUuAK3iavfKbhqCqN51Z1sVBYbDKdWdGPQOHA/640?wx_fmt=png)

**9、 还原域控机器账户 hash**

```
python3 reinstall_original_pw.py DC 192.168.1.53 9c0dbc4f157d628d3c618e4290c077f4
```

![](https://mmbiz.qpic.cn/mmbiz_png/PrTu58FA79bKJO6B8ew4Y4m6lZxU5ZzhmbbUD78NkksTbPZUvRPqm7vMMHGaVItwkvQXqqkiajJITG5JLAdljwA/640?wx_fmt=png)

**10、 验证 hash 是否还原**

使用空密码连接，连接失败。

![](https://mmbiz.qpic.cn/mmbiz_png/PrTu58FA79bKJO6B8ew4Y4m6lZxU5Zzhiafffkmnha8phno5fSmOwhA4oN7vCJqibAHiaVT1tIUeNOzJhSlYZXtGA/640?wx_fmt=png)

使用 administrator 查看域控机器账户密码 hash, 已还原。

![](https://mmbiz.qpic.cn/mmbiz_png/PrTu58FA79bKJO6B8ew4Y4m6lZxU5ZzhibibIQJ1Qkz7ssicR9QSUPaWoQ9rzEqYsyIialeaialEFQlKm5hLiciahOaQg/640?wx_fmt=png)

### 0x05 漏洞修复

**Windows：**

https://portal.msrc.microsoft.com/zh-CN/security-guidance/advisory/CVE-2020-1472

**Samba：**

https://www.samba.org/samba/history/security.html

参考链接：

https://www.secura.com/blog/zero-logon

https://www.anquanke.com/post/id/219374