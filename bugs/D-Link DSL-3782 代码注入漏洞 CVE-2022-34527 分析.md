> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=Mzg4MTY5NjQzMA==&mid=2247487125&idx=2&sn=04c1ae05384d696eabf7af2e67bd60ca&chksm=cf634554f814cc42452a3888e3409dd29ddd032596462dd4efd0dcd228bedb69532c67c66931&scene=21&sessionid=1663325310&key=7d0747fd59e25d7fa216f08e906ca711b236cb442cc551489dd74fe59764b0ccddd35863b61ab3318ec1ffef20b399708955261e944cc87cb310b80c9d9699a9226df4cb4c74353faa20d409d50baf304365ad4b55d5b623649b7ab6e41d89818ca9e675f597bc7e21cc1031ab0ad41ca4b46a518552802b8a44635c26074098&ascene=15&uin=NTY2NTA4NjQ=&devicetype=Windows%20Server%202016%20x64&version=63070517&lang=zh_CN&session_us=gh_3f7435f8d16d&exportkey=A4MqzG5SXiaPW7InEPy3psQ=&acctmode=0&pass_ticket=/CxJciBMgGN94DeRt8iXnLr6Xwld76EgPpdYSGnfvm3YltQ%20MTAF8Mhw41CYnnCx&wx_header=0&fontgear=2#wechat_redirect)

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ydbWQCZ7wtdshc0lGvyiacek7lPiac0KbvjISxNPqwZm7RBV3EDJjmG94aTsXLjnHlUmicrMrLLhNKsjE4qZwECXQ/640?wx_fmt=jpeg)

作者：景琇

**提取固件并分析**

```
binwalk -Me DSL-3782_A1_EU_1.01_07282016.bin
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/ydbWQCZ7wtdshc0lGvyiacek7lPiac0KbvDmuRjWbZ6Am7coDL1nRgw0GseULafgIu4v3JYpuvyQbCGFfMg3DBEA/640?wx_fmt=png)

查看 / usr/etc/init.d/rcS

```
#Web server
if [ ! -d "/var/boaroot/html/" ] || [ ! -d "/var/boaroot/cgi-bin/" ]; then
/userfs/bin/boa -c /boaroot -d &
/bin/rm -rf /var/boaroot
else
/userfs/bin/boa -c /var/boaroot -d &
fi
```

说明 boa 为 web server。

**定位漏洞点**

查询资料，官网说漏洞点出在 cfg_manager 的 byte_4C0160 中，使用 IDA 寻找一下。

![图片](https://mmbiz.qpic.cn/mmbiz_png/ydbWQCZ7wtdshc0lGvyiacek7lPiac0Kbvy0VsrdO4ib5kXVibqvyh4dETrXtlFBSKib5p5m5Ir5KSbzwLVia7gmibQ1Q/640?wx_fmt=png)

进入 sub_474c78，v0 = system(byte_4C0160); 中使用 system 进行命令执行。

![图片](https://mmbiz.qpic.cn/mmbiz_png/ydbWQCZ7wtdshc0lGvyiacek7lPiac0KbvNGXg1UH36QKOg7OLSE1UEATecr0qjwyqeG2uNVIACeuLyRceM6ibxXQ/640?wx_fmt=png)

但是无法判断 byte_4C0160 是否为用户可控，寻找 byte_4C0160 的赋值点，查看 byte_4C0160 的调用。

![图片](https://mmbiz.qpic.cn/mmbiz_png/ydbWQCZ7wtdshc0lGvyiacek7lPiac0KbveS4iajE8LOINVZAgcG7Ky7c0JgHib0O34EgF9qG9fGicpYDHc3aX8nDGA/640?wx_fmt=png)

addiu $s2,$v0,(byte_4c0160-0x4c0000) 是 MIPS 的相加指令，即 $s2=$v0+(byte_4c0160-0x4c0000)，跟进查看。

![图片](https://mmbiz.qpic.cn/mmbiz_png/ydbWQCZ7wtdshc0lGvyiacek7lPiac0KbvZIzroMcciaicGt8Bn3MTMfQTfeibMR4rtppgibV7JqnRks7QYnuyWuHzgg/640?wx_fmt=png)

```
.text:00474BD8                 addiu   $s2, $v0, (byte_4C0160 - 0x4C0000)
.text:00474BDC                 move    $a0, $s2
.text:00474BE0                 move    $a1, $zero
.text:00474BE4                 jalr    $t9 ; memset
.text:00474BE8                 li      $a2, 0x80
.text:00474BEC                 li      $v0, 0x70  # 'p'
.text:00474BF0                 beq     $s0, $v0, loc_474C58
.text:00474BF4                 lw      $gp, 0x10($sp)
.text:00474BF8                 la      $t9, sprintf
.text:00474BFC                 lui     $a1, 0x4A  # 'J'
.text:00474C00                 move    $a0, $s2
.text:00474C04                 li      $a1, aTracerouteNM10  # "traceroute -n -m 10 -w 2 %s > /tmp/var/"...
.text:00474C08                 jalr    $t9 ; sprintf
.text:00474C0C                 move    $a2, $s1
.text:00474C10                 lw      $gp, 0x10($sp)
.text:00474C14
.text:00474C14 loc_474C14:                              # CODE XREF: .text:00474C70↓j
.text:00474C14                 la      $t9, pthread_create
.text:00474C18                 li      $a2, sub_474C78
```

根据这段汇编，可以看到 byte_4c0160 传值给了 $s2，然后给了 $a0，然后调用了 sprintf，然后通过 pthread_create 调用了我们发现调用 system 函数的 sub_474c78。

**更多内容请在文末 “阅读原文” 跳转查看**

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ydbWQCZ7wtdshc0lGvyiacek7lPiac0Kbvj087ZdSoqBEkvvRxcrTN7iaK7CZz5w2unoym0H4Eo8RcmHmGpjJ4a5g/640?wx_fmt=jpeg)