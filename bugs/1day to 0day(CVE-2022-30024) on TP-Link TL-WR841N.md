> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [blog.viettelcybersecurity.com](https://blog.viettelcybersecurity.com/1day-to-0day-on-tl-link-tl-wr841n/)

> Vulnerabilities on TP-Link TL-WR841N devices Vulnerability Description CVE-2020-8423 Data parsing CV......

**Vulnerabilities on TP-Link TL-WR841N devices**

<table><thead><tr><th><strong>Vulnerability</strong></th><th><strong>Description</strong></th></tr></thead><tbody><tr><td>CVE-2020-8423</td><td>Data parsing</td></tr><tr><td><a href="https://blog.viettelcybersecurity.com/tp-link-tl-wr940n-httpd-httprpmfs-stack-based-buffer-overflow-remote-code-execution-vulnerability/">CVE-2022-24355</a></td><td>File extensions handling</td></tr><tr><td>CVE-2022-30024</td><td>Assignment data</td></tr></tbody></table>

CVE-2020-8423
-------------

**Description**

The vulnerability on TP-LINK's router device with model number TL-WR841N V10 is assigned ID [3.16.9 Build 150310](https://cve.mitre.org/cgi-bin/cvename.cgi?>CVE-2020-8423</a>. The vulnerability allows an authenticated attacker to remotely execute arbitrary code on the device by sending a GET request to the wifi network configuration.                                                     </p><p><strong>Firmware   </strong></p><p>Firmware version: <a href=).                                                  

**Vulnerability analysis**

Before going into the hole I will analyze `Dispatcher()` to understand how the program distributes functions to properly handle its function.

When a REQUEST is submitted, the `httpGenListDataGet()` function will be called to return a `LIST_ENTRY` pointer, which points to a list containing in turn the function pointers that handle the function for each previously assigned URL. Next, the program will call the function `httpGenListFuncGet()` to return the function pointer in the list and find out if the URL assigned to the handler function is found in the submitted REQUEST or not. If there is a function that will be called, otherwise the check will continue with the next function pointers in the list.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-42.png)![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-45.png)

The program will assign a handler function to each URL string using the `httpRpmConfigAdd()` function.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-48.png)

Rambling a bit to get an overview, now I will focus on analyzing this vulnerability. This error occurs when handling escaped characters in a function named `stringModify(char * dst, int size, char * src)`. The function will add the character `\` when it encounters the characters `\, /, <,> "`, or will add `<br>` if the next characters are not `\n` and `\r`, The process will stop when full-size buffer.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-50.png)

The problem is that adding `<br>` to `dst buffet`, the data is added `4 bytes`, but the program only processes `1 byte`.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-51.png)

So, just find a place calling this function that uses the `src buffer` as user input, this vulnerability is completely possible.

In reverse tracing, I get a `writePageParamSet()function` that has the gen page function to return the values ​​to the user, where a buffer `dst[512]` is created and passed to `stringModify()` to receive the values ​​in the handle escape characters.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-52.png)

further, we get a callback function that handles the URL string containing `/userRpm/popupSiteSurveyRpm.htm` at address `0x45FA94`.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-53.png)

This function will take the parameters of the GET request and call the function containing the vulnerability

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-54.png)

and we can control this vulnerability based on the optional `ssid` parameter entered.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-56.png)![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-9.png)

**Vulnerability verification**

Use `Payload = “/%0a” * 0x55 + “A” * 100`. Set breakpoint and observe.

So the vulnerability has been verified, the $ra register value has been changed, and 3 registers `$s0, $s1, $s2` have been overwritten.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-57.png)

**Exploit**

Check and see that no protection mechanism is enabled, so we can pass shellcode to the stack to execute arbitrary code.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-58.png)

There is a problem with the MIPS architecture, we need to clear the `Icache` cache before executing the shellcode, to solve this problem we will control the program to jump into the `Sleep()` function. Looking at the program's library and I found the Ropchain that matches the library from an old exploit [here](https://www.exploit-db.com/exploits/46678), which will need some debugging and tweaking. suitable for my case.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-60.png)![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-61.png)

**Fix shellcode**

I have a shellcode reference [here](https://www.exploit-db.com/exploits/45541) but it doesn't work. Through debugging, I realized that when the shellcode is passed to the `stringModify()` function, if it contains the bytes `\x3c, \x3e, \x2f, \x22, \x5c` the program will add 1 byte `\x5c` in front of `\x5c\x3c` or `\x5c\x3e`… and corrupt the shellcode. Checking this shellcode contains 2 bad bytes `\x3c` and `\x2f`. I will fix some commands to remove these bad bytes by replacing other commands.

**Fix byte 0x3c**

This byte is in the `lui` instruction,  the author's logic will save 4 bytes on the stack.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-62.png)

I will change the `lui` instruction to the `li` instruction to save 2 bytes on the stack instead of 4 bytes.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-63.png)

**Fix byte 0x2f**

In this command string shellcode contains 2 bad bytes, `0x3c` and `0x2f` when the author wants to put the string `//bin/sh` on the stack.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-64.png)

I would use the li instruction to remove `0x3c`, and the `xori` instruction with an `intermediate value` to fix the `0x2f` byte.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-65.png)

This way when we modify the shellcode, we get control of the router.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-66.png)

My next task was to evaluate the entire firmware of this device and here I discovered more 1day and 0day exist.

CVE-2022-24355
--------------

**Vulnerability information**

The first vulnerability I discovered (1day) is a critical vulnerability [CVE-2022-24355](https://nvd.nist.gov/vuln/detail/CVE-2022-24355) that allows network attackers to execute arbitrary code without based authentication about buffer overflow. A teammate of mine analyzed this vulnerability [here](https://blog.viettelcybersecurity.com/tp-link-tl-wr940n-httpd-httprpmfs-stack-based-buffer-overflow-remote-code-execution-vulnerability/) so I won't mention it further.

CVE-2022-30024
--------------

**Description**

This is a Stack-based buffer overflow vulnerability that exists in the `ipAddrDispose` function of a Web service running on binary httpd. The vulnerability occurs in the process of assigning the parameter value of the GET request to a stack variable, allowing the user to enter large amounts of data into the stack memory and the attacker can take control.

**Finding errors**

First, enter the function that I feel is easy to understand for me, which is `ping`.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-129.png)

Start checking to see if the program allows overflow to cause any errors by sending a string `aaaaaaaaa....aaa` and as a result, only 50 characters can be entered on the UI and get the message `ping request could not find host ….. Please check the name and try again.`

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-130.png)

Nothing seems to happen, we keep looking for the handler and reverse. As a result, we open the burp suite and get the Request containing `/userRpm/PingIframeRpm.htm`

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-131.png)

Open IDA to look for this URL string and found the function that handles this URL at `0x44A530`

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-132.png)![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-133.png)

Here the `httpGetEnv` functions are called to get the values `​​ping_addr, doType, isNew` … which are passed through GET REQUEST parameter.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-134.png)

Through a process, the `ipAddrDispose` function is called with the `ping _addr` argument passed. vulnerability will occur here.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-135.png)

A stack variable `buf_ip` with size 52 bytes are initialized and receives each character value from `ping_addr` until the end of the string. The problem is that the length of `ping_addr` is not handled with validation in the code but is limited to the web UI, and this can be easily bypass using `Burp Suite`.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-136.png)

Test with `Burp Suite`, enter a length of `ping_addr` around 200 bytes `a` for fun, and as a result. The program crashed. The return address register `$ra` was overwritten, so the vulnerability was confirmed.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-137.png)

I wrote a quick python script to enable the vulnerability. The result was as we expected.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-138.png)![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-139.png)

**Exploit**

The next goal is that RCE is device, because the device is not enabled with any protection mechanism, ASLR is also turned off, so we can control the `$ra` register to jump into the shellcode to execute the code and take control.

Looking at the assembly statement at the beginning of the program and the end of the program, the position of the stack variable `buf_ip`, we can calculate the offset to overwrite to `$ra: (0xD4 + 8) - (0xD4 – 0xA0) = 168 bytes` and at the same time can control two more registers `$s0` and `$s1`

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-140.png)![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-141.png)![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-142.png)

In order to have a mental model and build an exploit, I start making a diagram of the memory.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-143.png)

In MIPS architecture, we cannot jump directly into shellcode to execute the code, we have to clear the `Icache (Instruction cache)` memory first by jumping into `sleep()` function. Since it's on the same firmware, I will use ROP again in the above exploit.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-144.png)

Building the complete ROP chain, we will have the stack model as below.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-145.png)

As a result, we have successfully exploited the device with the Stack Overflow vulnerability, because we are performing a firmware simulation, so the reverse shell will print log, on the real device, this case will not appear.

![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-146.png)![](https://blog.viettelcybersecurity.com/content/images/2022/07/image-147.png)

I discovered this vulnerability exists on versions from TL-WR841N V12 and below and the ID `[CVE-2022-30024](https://nvd.nist.gov/vuln/detail/CVE-2022-30024)` is assigned to this vulnerability. Users should download the latest firmware from the official website from TP-Link to update the patch.  
[https://www.tp-link.com/en/support/download/tl-wr841n/v12/#Firmware](https://www.tp-link.com/en/support/download/tl-wr841n/v12/#Firmware)

**Time line**

*   14/04/2022: I sent them a report with the vulnerability
*   27/04/2022: TP-Link security teams sent me a fixed firmware to check
*   04/08/2022: TP-Link released the new firmware