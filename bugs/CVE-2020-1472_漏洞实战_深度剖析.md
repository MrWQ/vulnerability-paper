<meta name="referrer" content="no-referrer"/>
\> 本文由 \[简悦 SimpRead\](http://ksria.com/simpread/) 转码， 原文地址 \[mp.weixin.qq.com\](https://mp.weixin.qq.com/s/MagXtN1hfNPTQdcIMDOZEA)

> **本文作者：**Faith**（Ms08067 实验室 内网安全攻防知识星球）**

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWa9Y7Ac6gb6JZVymJwS3gu8cRey7icGjpsvppvqqhcYo6RXAqJcUwZy3EfeNOkMRS37m0r44MWYIYmg/640?wx_fmt=png)

**0x00 漏洞说明**

CVE-2020-1472 是继 MS17010 之后一个比较好用的内网提权漏洞，影响 Windows Server 2008R 2 至 Windows Server 2019 的多个版本系统，只要攻击者能访问到目标域控井且知道域控计算机名即可利用该漏洞. 该漏洞不要求当前计算机在域内，也不要求当前计算机操作系统为 windows，该漏洞的稳定利用方式为重置目标域控的密码， 然后利用城控凭证进行 Dc sync 获取域管权限后修复域控密码，之所以不直接使用坏控凭证远程执行命令，是因为城控账户是不可以登录的，但是域控具备 Dc sync 权限， 可以获取域内任意用户的凭证。

漏洞利用过程中会重置域控存储在域中 (ntds.dit) 的凭证，而域控存储在域中的凭证与本地的注册表 / lsass 中的凭证不一致时，会导致目标域控脱域，所以在重置完域控凭证后要尽快恢复。

**0x01 利用过程**

**0x01a mimikatz 利用过程**

测试环境：

```
域控：
  域名：ADC1.A.com
  IP：192.168.27.150
  操作系统：Windows Server 2012R 2
攻击机：
  不在域内：
  IP：192.168.27.129(没要求，能访问到目标域控即可)
  操作系统：Windows 7
```

工具地址：  

```
https：//github.com/genti1kiwi/mimikatz
https：//github.com/SecureAuthCorp/impacket
```

测试步骤如下：

1.  检测是否存在 CVE-2020-1472 漏洞
    

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicORncv0W0iaZ2VB0RzichKC8nJ7DSgBUia9XtWnZGJESOSE7kTHoj7AjuZ00HRBzSgZfiaq6WDickMg6Q/640?wx_fmt=png)

2\. 利用 CVE-2020-1472 修改域控密码为空  

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicORncv0W0iaZ2VB0RzichKC8Cibp5A8slCSVyH1Fm6xHDibaoChDxk6ErQJqeGIjp6eP7xpuayChgjiaQ/640?wx_fmt=png)

3\. 利用域控凭证通过 dcsync 获取域管 hash。

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicORncv0W0iaZ2VB0RzichKC8cKm0FEpsIwsBF9EfTuH8RHzXc8mmYebUnMs1BPBsM1EHEMjb0LI3Gg/640?wx_fmt=png)

4\. 利用获取的域管凭证进行 hash 注入获取一个域管权限的 cmd.exe。这里的 “domain:.” 也可以是 “domain:A"

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicORncv0W0iaZ2VB0RzichKC8TLUI3CHI3g8mg4yYQnBqibEYrChE6RIlpzGNpSXKhUjicICytwicmPVmw/640?wx_fmt=png)

5\. 在新开的 cmd 中使用 mimikatz 修改域控密码。

mimikatz 会将保存在域中的凭证以及注册表 / lsass 中的凭证同时修改为 "Waza1234/Waza1234/Waza1234/"，这样不影响域控的正常工作。

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicORncv0W0iaZ2VB0RzichKC8HGzwlWYj3hIa4cDpoNYA7e2BKfrqgezSf8Yb5jtdjia7429uPJmg4aQ/640?wx_fmt=png)

**0x01b zerologon 利用过程**

测试环境：

```
域控：
  域名：ADC1.A.com
  IP：192.168.27.150
  操作系统：Windows Server 2012R 2
攻击机：
  不在域内：
  IP：192.168.27.130(没要求，能访问到目标域控即可)
  操作系统：Windows 10
```

下载地址：  

```
https：//github.com/SecuraBV/CVE-2020-1472
https：//github.com/risksense/zerologon
https：//github.com/SecureAuthCorp/impacket
```

测试步骤如下：  

1\. 检测漏洞是否存在

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicORncv0W0iaZ2VB0RzichKC8Mp8XM8B5qnLTD8gQRhzQxYm5hoSqTuCVxmibYicXjeukn7Rl60DxttkA/640?wx_fmt=png)

2\. 修改域控密码为空

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicORncv0W0iaZ2VB0RzichKC8lxcqtcXctjtaCmKm2JtoKcfQH6Mgwuly1rE7NYu2funTgqFooGlsDQ/640?wx_fmt=png)

3\. 使用 impacket 中的 secretdump 获取域管 hash，这里的 “./ADC1” 也可以是“A/ADC1”, 也就是说我们 不需要知道目标域名即可获取到域管 hash。

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicORncv0W0iaZ2VB0RzichKC8v6WRdzqDl670KGfvTCowXGIGrIVK7lXCzLn49Pkt2wsHkrWIALC7fA/640?wx_fmt=png)

4\. 可以破解出域管密码，使用 net 结合 wmic、schtasks 等远程执行命令方法离线获取保存在注册表中 的域控凭证，也可以使用 imapcket 中的远程执行工具通过 hash 传递获取。当然也可以通过 mimikatz 在域控上直接获取，注意这一步一定要尽量快。

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicORncv0W0iaZ2VB0RzichKC8AXA8qJlU7GNZMq4uyLO2IgLDiav5lh3o3gnoYPmuyNX6iaIPkLYL3C6g/640?wx_fmt=png)

5\. 使用 impacket 中的 secretsdump 拿到域控机器账户原始哈希。

之前已经用 mimikatz 测试过一次，所以域控账户的 hash 为 "Waza1234/Waza1234/Waza1234/" 的 hash。

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicORncv0W0iaZ2VB0RzichKC8KATziaf5ul3q425FAzQbJQEngsnak110Bft2o3I5Y78pficEia6EaIdhQ/640?wx_fmt=png)

6\. 将 dc 机器用户密码恢复。

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicORncv0W0iaZ2VB0RzichKC8B8icOYiaUoT35m5Yl4gMZhL9ETe8CamN76YAmV4veWXvicQTRO3nyRrmw/640?wx_fmt=png)

**0x01c 利用方式对比**  

1.mimikatz 使用起来比 zerologon 方便快捷，极大的缩短了域控凭证恢复时间，减小对业务的影响以 及被发现的可能。

2.mimikatz 利用过程中第三步 dcsync 需要域名等信息，且需要当前计算机可以解析域控的 IP。当前计算机在域内时使用这种方式比较便捷。建议使用 zerologon 利用过程的第三步进行替换。

3.mimikatz 利用过程中第四步 hash 注入需要具有 SeDebugPrivilege 权限。

4.mimikatz 利用过程中第四步 hash 注入在 win10 环境下需要绕过 LSA Protection，该功能需要 mimidrv.sys 文件，未绕过 LSA Protection 时报错为。

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicORncv0W0iaZ2VB0RzichKC82TbQqIAcwic48iblPjzBmjutlPicMOZ98lPVq57yYngicTTWRxnPK9Hh4g/640?wx_fmt=png)

使用 mimikatz 绕过 LSA Protection 的命令为：

```
privilege::debug
!+
!processprotect /process:lsass.exe /remove
```

**0x02 寻找域控**

1\. 利用 nbtscan 扫描识别，标注 SHARING DC 即为域控。

2\. 扫描存活主机的 389 端口、88 端口是否开放。389 端口运行着 LDAP 服务，88 端口运行着 Kerberos 服务，开放这两个端口的计算机大概率为域控。

3\. 如果是拨 VPN 进入内网，可以 ipconfig /all 查看 DNS 服务器，DNS 可能是域控。

4\. 如果当前在域内，可以通过命令查询域控。参考如下命令：

```
Nslookup -type=SRV \_ldap.\_tcp
nltest /DCLIST:域名
net group "Domain Controllers" /do
…………
```

5\. 如果以上方式都无法定位到域控，尝试获取域内计算机权限后，查询域控信息。

**0x03 获取域控计算机名**  

1\. 利用 nbatscan 扫描识别。

2\. 利用 smb 嗅探目标域控的计算机名。

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicORncv0W0iaZ2VB0RzichKC8TzmEHsk70NjmWNmuSiccSo2Piaf1zAuFF5LNdscl1Oic9NbRMN3LicSyhA/640?wx_fmt=png)

3\. 利用 3389 获取相关信息。查看 3389 的证书信息，或者用 03 版 mstsc 不输凭证进入后 “切换用户” 找到 计算机名，特定情况下可用。

4\. 尝试利用 DNS 解析，可能不准确。

5\. 如果当前在域内，可以通过命令查询域控。

6\. 如果以上方式都无法定位到域控，尝试获取域内计算机权限后，查询域控信息。

**0x04 一些技巧**  

1\. 检测的目标计算机名不正确时，报错如下：

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicORncv0W0iaZ2VB0RzichKC85QX70fics5m62nQt1nXpHxCxswS08Lr8DU2YiblFCCaNXLNhvPMbCEuA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicORncv0W0iaZ2VB0RzichKC82qlmjibCKw3UVTgC4bR9Cp5xmfFBrfRBB59BDk36fUsazSY4GIeBicGA/640?wx_fmt=png)

2\. 如果不知道目标域的域管用户名，可以 secretsdump.exe -no-pass ./ADC1$@192.168.17.150 获取所有用户的 hash，然后利用 rid 为 500 的用户进行后续操作，或者使用任意用户凭证通过 adfind 或者 powerview 查询域信息。如果当前计算机在域内的话还可以尝试使用黄金票据。

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicORncv0W0iaZ2VB0RzichKC8cvT6bq7a19A0XGvLbOQkUcxYALOzSzTo52RYNeDeAHdF3uMT1WrB2A/640?wx_fmt=png)

3\. 验证域控密码是否恢复，如果域控 hash 为 31d6cfe0d16ae931b73c59d7e0c089c0，代表未恢复。

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicORncv0W0iaZ2VB0RzichKC86sUGMO6oLoChuTIJ0SicJozVvIDzibgMib1yN76Dmp8JebicIlORJeBnIA/640?wx_fmt=png)

本文来自 **内网知识星球****【内网安全攻防 2.0** **计划】**系列文章，更多文章请加入 **内网知识星球** 共同学习。

**【内网安全攻防 2.0** **计划】**  

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaibjZq4icdziaIpqtiau0A0Qfnvxgxemlkkqy0D7R3VRlpcE9WrKlg18ibDMIItluFhSM8llbXq4qiaEib9w/640?wx_fmt=png)

**现在加入星球的同学可以同时学习 “**内网安全攻防图书配套视频**”+“**内网高级渗透技术**” 二套视频教程！**

**[**内网安全攻防实战及高级进阶**](http://mp.weixin.qq.com/s?__biz=MzU1NjgzOTAyMg==&mid=2247488983&idx=1&sn=8ca92a60046111f77d113421ce789cab&chksm=fc3facd6cb4825c0ae1b42d154332d2e0f1fdbe7b87c0ff803ba523e5447bfa50a7d251ee62e&scene=21#wechat_redirect)**

**扫描下方二维码加入****星球学习**

**加入后会邀请你进入****内部微信群****，内部微信群永久有效！**

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWa9Y7Ac6gb6JZVymJwS3gu8cRey7icGjpsvppvqqhcYo6RXAqJcUwZy3EfeNOkMRS37m0r44MWYIYmg/640?wx_fmt=png)

目前 30000 + 人已关注加入我们

![](https://mmbiz.qpic.cn/mmbiz_gif/XWPpvP3nWa9FwrfJTzPRIyROZ2xwWyk6xuUY59uvYPCLokCc6iarKrkOWlEibeRI9DpFmlyNqA2OEuQhyaeYXzrw/640?wx_fmt=gif)

学习更多安全知识加入下列星球学习！  

![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWa9Y7Ac6gb6JZVymJwS3gu8cniaUZzJeYAibE3v2VnNlhyC6fSTgtW94Pz51p0TSUl3AtZw0L1bDaAKw/640?wx_fmt=png) ![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWa9Y7Ac6gb6JZVymJwS3gu8cT2rJYbRzsO9Q3J9rSltBVzts0O7USfFR8iaFOBwKdibX3hZiadoLRJIibA/640?wx_fmt=png)

 ![](https://mmbiz.qpic.cn/mmbiz_jpg/XWPpvP3nWaicjovru6mibAFRpVqK7ApHAwiaEGVqXtvB1YQahibp6eTIiaiap2SZPer1QXsKbNUNbnRbiaR4djJibmXAfQ/640?wx_fmt=jpeg) ![](https://mmbiz.qpic.cn/mmbiz_png/XWPpvP3nWaicJ39cBtzvcja8GibNMw6y6Amq7es7u8A8UcVds7Mpib8Tzu753K7IZ1WdZ66fDianO2evbG0lEAlJkg/640?wx_fmt=png)