> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/lLOA57krz0mojtE_zLe7xQ)

1. 安装
-----

> 安装过程 ruoyi-admin\src\main\resources\application-druid.yml 配置数据库等信息

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTsNxOMMpd2NYK3sWCRjzicBjSaBliaEBGfSaSjf5O8Ctq18LGNNQ5Eib2gg/640?wx_fmt=png)

2. 审计过程
-------

### 2.1 文件下载漏洞 (v4.7.6)

> 在 com.ruoyi.web.controller.common.resourceDownload 存在文件下载

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTsaqNnPllt7tHreSoPH2eZbfZGpnq83bRgTTl3ZicmAILukMN1pdbMJ5g/640?wx_fmt=png)

> 首先简单分析下其代码：请求 url 如：http://127.0.0.1/common/download/resource?resource=1.htm
> 
> 跟进 checkAllowDownload 校验的方法，发现是白名单校验，这里 htm 也在名单中，所以通过校验

![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTsmKpkfX2WcvGibvXV5fpIxRQHpicry9WkEOJlyLgZO3LsOdNHkkia3FjZQ/640?wx_fmt=png)

可以发现在 RuoYiConfig.getProfile(); 获取到的路径为 D:/ruoyi/uploadPath![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTsTYsicuBEib5mibIBEGicKMlYry2kITzyWJRPs7xGmMcUq6gViaN2kC9bgjA/640?wx_fmt=png)

此路径从配置文件中获取![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTsBA0RUeQt5lLyBiamNspW0Tica7CyvbzqfeVwp5lCNOljDJIR2x5bOZIw/640?wx_fmt=png)

而后面代码就是下载，在最后的 writeBytes 后，就是将 D:/ruoyi/uploadPath 写入到 response 中。

```
// 数据库资源地址  downloadPath为D:/ruoyi/uploadPath
String downloadPath = localPath + StringUtils.substringAfter(resource, Constants.RESOURCE_PREFIX);
// 下载名称 downloadName为uploadPath
String downloadName = StringUtils.substringAfterLast(downloadPath, "/");
response.setContentType(MediaType.APPLICATION_OCTET_STREAM_VALUE);
FileUtils.setAttachmentResponseHeader(response, downloadName);
FileUtils.writeBytes(downloadPath, response.getOutputStream());


```

但是若依有一处定时任务，该定时任务可以直接调用 Bean 其对应方法![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTsG6rkicmSjp7f4YYFqk5Oibx6g8YwHp1icWOSTHJyb1q84Qwic39Ebk1umA/640?wx_fmt=png)

而在 com.ruoyi.common.config 包中有一个 RuoYiConfig 配置类。可以看到该类是与 application.yml 有关联。因为在 application.yml 中发现了 profile 设置了文件下载的路径，于是乎就可以通过定时任务的 set 方法来对其进行更改![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTsjveWHWr5zHAMbibibGWzIJEC2xFib6TqibQib1icKVFdXROKZWyXOOoxkia8w/640?wx_fmt=png)

D 盘先准备个 txt![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTslcgf9iaeeEWZ9AlJaueNqdqxTic8jf4nAoXicEV0aicrqBB8e8CnFgu4icQ/640?wx_fmt=png)

ruoYiConfig.setProfile("要下载的文件");![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTsqkvzKyQS4q0P8OHMNds7LheQe4GREdK9PMX28ySF1OR0pUKMaN9j5w/640?wx_fmt=png)

稍后执行即可![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTsdVicic9kkQ42puULbYnuzd0KuzXuIIUEHzkhxeD3iayg5B6RsPDVRHB8g/640?wx_fmt=png)

但不是所有的 Bean 都能执行的。 

跟进 package com.ruoyi.quartz.controller.SysJobController 中 

可以看到其校验![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTschnLCz0Fia5g5DxaDzukE7tTjIMe6DU3XIAlKZzH0I2RTiaiallpJe9eg/640?wx_fmt=png)

跟进这两处判断看一下

```
else if (StringUtils.containsAnyIgnoreCase(job.getInvokeTarget(), Constants.JOB_ERROR_STR))
{
    return error("修改任务'" + job.getJobName() + "'失败，目标字符串存在违规");
}
else if (!ScheduleUtils.whiteList(job.getInvokeTarget()))
{
    return error("修改任务'" + job.getJobName() + "'失败，目标字符串不在白名单内");
}


```

首先第一处是黑名单校验![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTsNjaAa9RKTCiapNwljmfWq0TBPWTC4nxhibWo3pIbD8RuxULVtM1W1VpQ/640?wx_fmt=png)

在 containsIgnoreCase 中，是一个黑名单校验。对传入的字符串进行校验。![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTs4JMkykb1nCQpTpfMVrpabp0c11dvgxXVs5PA4sqgSx4Hl1ibz4pEuTg/640?wx_fmt=png)

第二处就是白名单校验，首先获取到 RuoYiConfig 的 bean。

return 处的 containsAnyIgnoreCase 功能是：查找指定字符串是否包含指定字符串列表中的任意一个字符串同时串忽略大小写![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTsRGjnSqQwblhqJMZVNdtRcl4yuk1Rmqia1vCP1XaGpFib8pg6eHnCSlLQ/640?wx_fmt=png)

因为在其这里进行了取反，所以该判断也就绕过了。![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTsibcC5RTrVTibDgvUviacficicFXYibXh0Ylh9kIslKHIEmM8dW6RTfwSaqyg/640?wx_fmt=png)

继续看文件下载 

请求 url：http://127.0.0.1/common/download/resource?resource=1.pdf

此时 RuoYiConfig.getProfile(); 为 D://1.txt![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTsvRan5NVqYh60CdmrZMfX4u8F6obIZepH56VdAfsO9C1CtXIuoK1ibWw/640?wx_fmt=png)

最后会将 D://1.txt 下载![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTsXQw3z6ewZhjB7sxlSPib0aHo2zibiaict6WI6r6NwCE9hmgrKbozcicozAw/640?wx_fmt=png)

这里的文件名后缀必须是 checkAllowDownload 中白名单校验的后缀![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTsyb6cqZNtOLExbLEIeZMibMTPU8hBvwBvry9eKz5rZ7rnyNOmazE1xuQ/640?wx_fmt=png)

### 2.3 新版 SQL 注入被修复 (v4.7.7)

在 com.ruoyi.system.mapper.SysDeptMapper 中![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTsE3sgATIIt5x18QENKu3K2YVQ0muu0d1UhbgB35yUGSuQWPdyWqxyOQ/640?wx_fmt=png)

都过该 Mapper 定位到了 service 层 SysDeptServiceImpl![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTs8BkBsAr49fh5VjeOfIAdGJ0Rch4QapujB4wYw3ic0Sh7bOZKOmdflOg/640?wx_fmt=png)

在往上就跟到了 SysDeptController![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTsmZQZNFUpK9IdxviajTpW2LRjWXuScrxQD4bgpJ5SQMOSsQsV11LzGxQ/640?wx_fmt=png)

可以发现自定义了一个 DataScope 注解，根据这个 DataScope 找到了一个 aop。![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTs8GGXyicJj9PibfCsZ7Fdx5SUFJ713CVKlqRD2KIK4u1KX70pTia7MZGnw/640?wx_fmt=png)

在这个类中。handleDataScope 对传入的 dataScope 进行了过滤

```
protected void handleDataScope(final JoinPoint joinPoint, DataScope controllerDataScope)
{
    // 获取当前的用户
    SysUser currentUser = ShiroUtils.getSysUser();
    if (currentUser != null)
    {
        // 如果是超级管理员，则不过滤数据
        if (!currentUser.isAdmin())
        {
            String permission = StringUtils.defaultIfEmpty(controllerDataScope.permission(), PermissionContextHolder.getContext());
            dataScopeFilter(joinPoint, currentUser, controllerDataScope.deptAlias(),
                            controllerDataScope.userAlias(), permission);
        }
    }
}


```

继续跟进 dataScopeFilter 方法看一下，可以看到在获取 role.getDataScope(); 之后，进行了判断值。并将创建了一个新的 sql 语句。大致流程就是 service 层加入了 DataScope 注解，就会跑到 aop 中进行过滤。

```
public static void dataScopeFilter(JoinPoint joinPoint, SysUser user, String deptAlias, String userAlias, String permission)
{
    StringBuilder sqlString = new StringBuilder();
    List<String> conditions = new ArrayList<String>();

    for (SysRole role : user.getRoles())
        {
            String dataScope = role.getDataScope();
            if (!DATA_SCOPE_CUSTOM.equals(dataScope) && conditions.contains(dataScope))
            {
                continue;
            }
            if (StringUtils.isNotEmpty(permission) && StringUtils.isNotEmpty(role.getPermissions())
                && !StringUtils.containsAny(role.getPermissions(), Convert.toStrArray(permission)))
            {
                continue;
            }
            if (DATA_SCOPE_ALL.equals(dataScope))
            {
                sqlString = new StringBuilder();
                conditions.add(dataScope);
                break;
            }
            else if (DATA_SCOPE_CUSTOM.equals(dataScope))
            {
                sqlString.append(StringUtils.format(
                    " OR {}.dept_id IN ( SELECT dept_id FROM sys_role_dept WHERE role_id = {} ) ", deptAlias,
                    role.getRoleId()));
            }
            else if (DATA_SCOPE_DEPT.equals(dataScope))
            {
                sqlString.append(StringUtils.format(" OR {}.dept_id = {} ", deptAlias, user.getDeptId()));
            }
            else if (DATA_SCOPE_DEPT_AND_CHILD.equals(dataScope))
            {
                sqlString.append(StringUtils.format(
                    " OR {}.dept_id IN ( SELECT dept_id FROM sys_dept WHERE dept_id = {} or find_in_set( {} , ancestors ) )",
                    deptAlias, user.getDeptId(), user.getDeptId()));
            }
            else if (DATA_SCOPE_SELF.equals(dataScope))
            {
                if (StringUtils.isNotBlank(userAlias))
                {
                    sqlString.append(StringUtils.format(" OR {}.user_id = {} ", userAlias, user.getUserId()));
                }
                else
                {
                    // 数据权限为仅本人且没有userAlias别名不查询任何数据
                    sqlString.append(StringUtils.format(" OR {}.dept_id = 0 ", deptAlias));
                }
            }
            conditions.add(dataScope);
        }

    // 多角色情况下，所有角色都不包含传递过来的权限字符，这个时候sqlString也会为空，所以要限制一下,不查询任何数据
    if (StringUtils.isEmpty(conditions))
    {
        sqlString.append(StringUtils.format(" OR {}.dept_id = 0 ", deptAlias));
    }

    if (StringUtils.isNotBlank(sqlString.toString()))
    {
        Object params = joinPoint.getArgs()[0];
        if (StringUtils.isNotNull(params) && params instanceof BaseEntity)
        {
            BaseEntity baseEntity = (BaseEntity) params;
            baseEntity.getParams().put(DATA_SCOPE, " AND (" + sqlString.substring(4) + ")");
        }
    }
}


```

### 2.4 定时任务修复 (v4.7.7)

com.ruoyi.quartz.controller#editSave 进行了白名单校验。![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTsJTHPJzUEfAGqfTaMfpMx8DqX3mJl4Qocn3RDUJxP6yZia4TtyB4uEvg/640?wx_fmt=png)

跟进校验的函数

```
public static boolean whiteList(String invokeTarget)
{
    String packageName = StringUtils.substringBefore(invokeTarget, "(");
 int count = StringUtils.countMatches(packageName, ".");
if (count > 1)
{
    return StringUtils.containsAnyIgnoreCase(invokeTarget, Constants.JOB_WHITELIST_STR);
}
Object obj = SpringUtils.getBean(StringUtils.split(invokeTarget, ".")[0]);
String beanPackageName = obj.getClass().getPackage().getName();
return StringUtils.containsAnyIgnoreCase(beanPackageName, Constants.JOB_WHITELIST_STR)
    && !StringUtils.containsAnyIgnoreCase(beanPackageName, Constants.JOB_ERROR_STR);
}


```

违规字符串如下：![](https://mmbiz.qpic.cn/mmbiz_png/ibZ6uZjjH3v7YIgwvZwvu3qOJW52GARTsZlr2tcurPQcv7UZHlDpvaAJ8LwSFWhWuf8uvSIIHviaBop93OV8PNug/640?wx_fmt=png)

`在上方中，可以看见String beanPackageName = obj.getClass().getPackage().getName();进行了获取包名`

当传入 ruoyiConfig 类之后获取其包名 com.ruoyi.common.config 此时匹配成功为 true，但是最后 return 中进行了取反操作。 

最外层又进行了取反，最终结果是 true。会 error。

```
加下方wx，拉你一起进群学习

```