> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/vfNv77z0LIRDu-V39mvSmg)

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/Tp9VOk1IaycpsK4AXvozeaMLYk7OBLQau8mDrsWslNiajkybyodE8HbkJ9ibPO7IofWw3S4sE38LyCWYSxSZMjkQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1&wx_co=1)

**免责声明**

由于传播、利用本公众号听风安全所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，公众号听风安全及作者不为**此**承担任何责任，一旦造成后果请自行承担！如有侵权烦请告知，我们会立即删除并致歉。谢谢！

0x00 前言
-------

  笔者在看一篇代码审计的文章时，对其中作者提及的一处地方感到迷惑，思考无果遂便自己展开了一次粗浅的分析，最终弄明白了自己的困惑并在 Window 环境下实现了两种思路去达到 GetShell 目的。

0x01 安装
-------

官网: http://www.sem-cms.com/xiazai.html

下载地址: http://www.sem-cms.com/TradeCmsdown/php/SEMCMS_PHP_3.9.zip

Linux:

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibeEM8U1zKtmFma7VI7lILX7abklib05wtbrCq87x7FPNmCXmhcmpCV9g/640?wx_fmt=png)

安装完成后会给出后台登陆信息:

> 网站后台地址为：你的域名 + N8D3ch_Admin/ 请牢记, 后台默认帐户：Admin 密码：1 登陆后进行修改

Window:

> 网站后台地址为：你的域名 + rhDOEr_Admin/ 请牢记, 后台默认帐户：Admin 密码：1 登陆后进行修改

0x02 失败复现
---------

访问: http://localhost:8887/semcms/N8D3ch_Admin/SEMCMS_Upload.php

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibmYObkSkYXT3H80VqSCz1eLNKcgia3ibiaPN89gx3vuC7HXTzxIPJ9lTiaQ/640?wx_fmt=png)

上传抓包

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibGE4cBDoJfEFPF9w7ba5XicJe5QX8FhOSA5YG3wYia4KicEguibgnN1NDjQ/640?wx_fmt=png)

按照某新版本商贸系统的代码审计文章所说的上传步骤进行操作

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibEFyL7A0ic9Tj3l5RVkRYKg33k9nOuzW1al2EGIPwo0aBgsaPac6f8cg/640?wx_fmt=png)

**1) 第一步**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibjbfuk5xZfm2xL0ldKHuXoRFPLEsGbAic0BdhnCUUhRFSU5qMfYcXD2w/640?wx_fmt=png)

传入这个参数之后，会进入代码的拼接过程

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibHXyibib4vbAXuqIPybnCxODicb4ueiagLhU61icucuVXvbAudmZQng1ortw/640?wx_fmt=png)

最终执行的`$newname` , 是将文件的内容写入到`111.jpg.php:.jpg`,`$Imageurl`可以控制向上目录穿越，这里不设置，默认则为空。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibUXjibUMNnIRbLqpzIULCEFBbP6PzoTBibQqghC8e16aokicaq2DX4nfNw/640?wx_fmt=png)

```
<?php
/**
 * Created by PhpStorm.
 * User: xq17
 * Date: 4/17/22
 * Time: 7:07 PM
 */
header("Content-Type: text/html; charset=UTF-8");

$filename = $_FILES["file"]["name"];
if($filename){
    # 获取后缀名
    $uptype = strtolower(end(explode(".", $filename)));
    print_r("suffix:".$uptype."\n");
    # 判断是否在黑名单里面
    if(in_array($uptype, array('php', 'phtml'))){
        print_r("不允许上传php文件!");
        die(0);
    }else{
        // 通过黑名单检验
        move_uploaded_file($_FILES["file"]["tmp_name"], $filename);
        print_r("上传成功!");
    }
}
```

最终由于`:`从而写入 ADS 流文件，会导致生成一个`111.jpg.php`的空文件和一个`111.jpg.php:.jpg`的实际内容为`<?php phpinfo();?>`的隐藏文件。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJib2rDfWyQPF8XicsOvOAzUlce9GH49EbyPW0lAGhhoCwAcxJPYdPkHWvw/640?wx_fmt=png)

**2) 第二步**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJib8wD2qux0vBibEESxRCqqOSXWdDUvhbrqS8q86FeGicyZMXBibUhEQ5wsg/640?wx_fmt=png)

代码处理:

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibyrkToMuZfvWpRI3s18TJ1icicGKofzWno8VhRQpYnYJ9sxa12JpRaicXA/640?wx_fmt=png)

最终走向生成文件名字为`111.jpg.php:.jpg<<<`，可惜访问`111.jpg.php`, 并没有发现有内容写入，所以在这里我对原文中作者的描述，产生了质疑。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibjxlbV6aQZuO3PPy5xOCl3FL35JQpaQSw3bKMvgj4jcvazxJMkVoLxA/640?wx_fmt=png)

0x03 问题探索
---------

首先这个问题，对环境有要求，只能在 Window 环境下进行测试。

正常来说，利用`:`冒号和`<`追加符号结合的方式，一般用于绕过黑名单的限制。为了理解这种方式，我们需要了解并学习下 **Window 的特性**。

### 0x3.1 Window 特性

通过一段存在上传漏洞的代码来进行说明。

```
<?php
/**
 * Created by PhpStorm.
 * User: xq17
 * Date: 4/17/22
 * Time: 7:07 PM
 */
header("Content-Type: text/html; charset=UTF-8");
$filename = $_FILES["file"]["name"];
if($filename){
    # 获取后缀名
    $uptype = strtolower(end(explode(".", $filename)));
    print_r("suffix:".$uptype."\n");
    # 判断是否在黑名单里面
    if(in_array($uptype, array('php', 'phtml'))){
        print_r("不允许上传php文件!");
        die(0);
    }else{
        // 通过黑名单检验
        move_uploaded_file($_FILES["file"]["tmp_name"], $filename);
        print_r("上传成功!");
    }
}
```

正常上传 php 文件的话，会被拦截。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibTpnZiacCLB3ySI6A0Wm0zPFJs6CshibsCfDOq3VibaE6U52gBuxTiaV2cQ/640?wx_fmt=png)

这种情况在 linux 环境可以通过 FUZZ 各种后缀来尝试绕过，不过在 Window 环境，却可以通过一些巧妙的方式来进行绕过。

**绕过方式 1:**

通过在文件名后面添加一个或多个`.`来绕过黑名单。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibjfiaiaYEPVib7bm6rG8MCZvfkRE52Ho2psjbkicmMTGcMssVQxCj4auppQ/640?wx_fmt=png)

生成文件的时候会自动删除`.`

**绕过方式 2:**

通过在文件名后面添加一个`::$data`这一默认流类型来绕过黑名单。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibBEmJvzLsEgMDIscBlRuhwN01U9lJkqPYvOKnYO7LiaxYn47owgvPLzQ/640?wx_fmt=png)

写入的时候会忽略`::$data`，而是作为默认流类型，保留了`3.php`这一原文件名达到绕过目的。

**绕过方式 3:**

这种方式是 PHP 调用 WindowAPI 的特性导致的:

window 的特性

Windows 下的 "你画我猜" -- 告别效率低下的目录扫描方法、

PHP 源码调试之 Windows 文件通配符分析

> `<` : 匹配 0 个以上的字符
> 
> `>`: 匹配一个字符
> 
> `"`: 匹配点号

(1) 先利用冒号截断生成一个空白文件 7.php

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibVf3Vo3hPAxW1Z99NSqzm9icwh9bDh4xUZjhvSL5PtNdSOqEVq1Eyg4g/640?wx_fmt=png)

修改文件名:`7.php:jpg`, 即可上传成功一个空文件

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibiczVVDMspODicJeK2otqNA5FTU0G8DAHowyicopqqZgmUUHiag3MlsxDkw/640?wx_fmt=png)

(2) 然后利用`<`、`"`或者`>`号进行覆盖写入

使用`<`可以匹配多个字符，即`7.p<` 能够匹配到`7.php`

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibewd8zq8zyJN0gQXZktSiaPJqbxvEXvlMmhWwyrqiaCwWHlX7mR6CTpbA/640?wx_fmt=png)

使用`>`只能匹配单个字符，故用`7.p>>`能够匹配到`7.php`

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibeKzedhcU38lD6J8TRto9NaAvKrDsNYjiat7OSYW5ibUxhriam1f6p9fOQ/640?wx_fmt=png)

使用`"`来匹配点号。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibF62KljjVciatbq3YQicEBJHCEdiaboM5yNh6ibb65Iz3I7eCnMJrZgicG7g/640?wx_fmt=png)

### 0x3.2 追溯失败原因

在 0x02 节提到的方式，若按原作者所说，通过构造`111.jpg.php:.jpg<<<`文件名结合 0x3.1 的 Window 特性来看并没有很大意义。

因为`111.jpg.php:.jpg<<<`匹配的就是`111.jpg.php:.jpg`+ 后面任意字符的文件名，根本匹配不到`111.jpg.php`这个我们想要覆盖的文件。

0x04 巧妙 ByPass
--------------

既然知道了失败的原因，那么我们需要去找找，看看有没有可以突破的地方。

在这里，我们需要清晰地认识到场景的两处特殊之处:

1) 后缀内容部分可控

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibg7c5sYz2DcHq85yIp1hwkqHzgWAia8bT5ibMyEEbbTAiaGCb6t4YTrYMA/640?wx_fmt=png)

2) 文件名可控制  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJib7kppbqgDW3hpVt0nxNtVZJvia7mcaVfJOrbP7TeLW83JDIZTk3PzBiaQ/640?wx_fmt=png)

### 0x4.1 Bypass 1

根据代码的逻辑，我们是没有办法构造出 php 后缀的，来直接上传的。

因为我们可控的仅仅是文件名，还需要拼接后缀，而后缀的话必须是形如 xxxjpgxxx 的字符串，不能插入`.`，要不然会被分割，所以后缀我们是没办法构造出`php`的。

既然直接的办法行不通，那么可以尝试利用 window 特性来进行覆盖写入。

**尝试 1**

首先通过冒号截断来写入一个 ttt.jpg.php 的空文件, 只需要如图构造参数即可。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibaa2cPHIVGTXiadKhFFBaWUrFF1N4dkq4P0jdu6AKxkgz1nGhBcbawaA/640?wx_fmt=png)

拼接之后，传入`move_uploaded_file`的值为`ttt.jpg.php:.jpg`

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJib5YJNGeIiaTkCYQPk1hKibWdmgHsK2Ria5IibBajScn5GwJYP70TBOrpeSg/640?wx_fmt=png)

那么接下来，我只需要控制，`wname`的值为`ttt`，后缀控制为`1.jpg<`, 那么拼接之后的值便是`ttt.jpg<`, 按道理来说是应该能匹配到`ttt.jpg.php`, 因为`<`其实等价于`*`的作用。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibXeHqMMSLs3kjwEvJj8fuuW3vOrPhHbbQdE28pLNMZgich5qD2OwXT7g/640?wx_fmt=png)

不过在实际中发现, 一个`<`并没有匹配成功，使用两个以上`<`即可匹配成功。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibG7Gmbjc9cjF7ialoa3zYbVEKx05IibicDXSX4dFMSmvtlhbC49fiaMJDyg/640?wx_fmt=png)

### 0x4.2 Bypass 2

那就是如果`<`被过滤的时候，我们可以通过构造`jpg\"php`来匹配上`jpg.php`这个格式。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibuttz91QkGp6RBLqBjiaiaDXia146LKR3FluFWMlQhw1prKQicVgPxwECWQ/640?wx_fmt=png)

查看下文件是否被修改成功， success!

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IayeORBywWVOicBg9VrFsY6DJibIRm4ic85icyiaB2EHKCzTfHcmrJ4Ow1Lk1B6nJkUQqqpf9AWhwkIa0jyw/640?wx_fmt=png)

0x05 总结
-------

   本文内容记录了笔者从初始化环境，因复现失败，再去学习 window 特性，然后结合特性实现在 window 环境绕过 CMS 伪白名单限制 (因为他只是通过正则部分限定了后缀，不是严格的白名单) 并最终完成 GetShell 的过程。值得一提的是，虽然这些 trick 比较老了，但是源远流长，在一些场景依然有着不可忽视的作用。

**欢迎关注听风安全，分享更多安全技术~**