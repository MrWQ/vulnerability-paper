> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/9DGocSaN-hfjxFtxufx2XA)

**WebSocket 内存马，一种新型内存马技术**
===========================

### 1. 前言

WebSocket 是一种全双工通信协议，即客户端可以向服务端发送请求，服务端也可以主动向客户端推送数据。这样的特点，使得它在一些实时性要求比较高的场景效果斐然（比如微信朋友圈实时通知、在线协同编辑等）。主流浏览器以及一些常见服务端通信框架（Tomcat、netty、undertow、webLogic 等）都对 WebSocket 进行了技术支持。

### 2. 版本

2013 年以前还没出 JSR356 标准，Tomcat 就对 Websocket 做了支持，自定义 API，再后来有了 JSR356，Tomcat 立马紧跟潮流，废弃自定义的 API，实现 JSR356 那一套，这就使得在 Tomcat7.0.47 之后的版本和之前的版本实现方式并不一样，接入方式也改变了。

JSR356 是 java 制定的 websocket 编程规范，属于 Java EE 7 的一部分，所以要实现 websocket 内存马并不需要任何第三方依赖

### 3. 服务端实现方式

#### （1）注解方式

```
本文章著作权归作者所有。转载请注明出处！https://github.com/veo
来源：先知(https://xz.aliyun.com/t/11549)
```

Tomcat 在启动时会默认通过 WsSci 内的 ServletContainerInitializer 初始化 Listener 和 servlet。然后再扫描 `classpath`下带有 `@ServerEndpoint`注解的类进行 `addEndpoint`加入 websocket 服务

所以即使 Tomcat 没有扫描到 `@ServerEndpoint`注解的类，也会进行 Listener 和 servlet 注册，这就是为什么所有 Tomcat 启动都能在 memshell scanner 内看到 WsFilter

![](https://mmbiz.qpic.cn/mmbiz_png/7nIrJAgaibicOjNJF9F3wutFjicSjLtOFZo7fiaHMuK2q6qxXPeckPAVibnVBmzeJmSDDKKGsdEckByXsoqYGAbVt0Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)
==========================================================================================================================================================================

#### （2）继承抽象类 Endpoint 方式

继承抽象类 `Endpoint`方式比加注解 `@ServerEndpoint`方式更麻烦，主要是需要自己实现 `MessageHandler`和 `ServerApplicationConfig`。`@ServerEndpoint`的话都是使用默认的，原理上差不多，只是注解更自动化，更简洁

可以用代码更方便的控制 ServerEndpointConfig 内的属性

```
ServerEndpointConfig serverEndpointConfig = ServerEndpointConfig.Builder.create(WebSocketServerEndpoint3.class, "/ws/{userId}").decoders(decoderList).encoders(encoderList).configurator(new MyServerConfigurator()).build();
```

### 3.websocket 内存马实现方法

之前提到过 Tomcat 在启动时会默认通过 WsSci 内的 ServletContainerInitializer 初始化 Listener 和 servlet。然后再扫描 `classpath`下带有 `@ServerEndpoint`注解的类进行 `addEndpoint`加入 websocket 服务

那如果在服务启动后我们再 addEndpoint 加入 websocket 服务行不行呢？答案是肯定的，而且非常简单只需要三步。创建一个 ServerEndpointConfig，获取 ws ServerContainer，加入 ServerEndpointConfig，即可

```
ServerEndpointConfig config = ServerEndpointConfig.Builder.create(EndpointInject.class, "/ws").build();
ServerContainer container = (ServerContainer) req.getServletContext().getAttribute(ServerContainer.class.getName());
container.addEndpoint(config);
```

### 4. 效果

首先利用 i.jsp 注入一个 websocket 服务，路径为 / x，注入后利用 ws 连接即可执行命令

![](https://mmbiz.qpic.cn/mmbiz_png/7nIrJAgaibicOjNJF9F3wutFjicSjLtOFZoQPia5icyMZOpf6jHAWk0ZdlLU32z9nsOGKhOSJBxDvW5MJ5NGnn4c4Tg/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

且通过 memshell scanner 查询不到任何异常（因为根本就没注册新的 Listener、servlet 或者 Filter）

![](https://mmbiz.qpic.cn/mmbiz_png/7nIrJAgaibicOjNJF9F3wutFjicSjLtOFZoXWicv3MEEQtRvucWAGAxSeiajYbOXyAmiathKX5V5daXa6yVSCa58KhyA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

### 5. 代理

WebSocket 是一种全双工通信协议，它可以用来做代理，且速度和普通的 TCP 代理一样快，这也是我研究 websocket 内存马的原因。

例如有一台不出网主机，有反序列化漏洞。

以前在这种场景下，可能会考虑上 reGeorg 或者利用端口复用来搭建代理。

现在可以利用反序列化漏洞直接注入 websocket 代理内存马，然后直接连上用上全双工通信协议的代理。

注入完内存马以后，使用 Gost：https://github.com/go-gost/gost 连接代理

```
./gost -L "socks5://:1080" -F "ws://127.0.0.1:8080?path=/proxy"
```

然后连接本地 1080 端口 socks5 即可使用代理

### 6. 多功能 shell 实现

想要使用 ws 马首先得支持连接 ws 协议的工具，目前市面的 webshell 管理工具都要从源码上修改才能支持 ws 协议

具体实现过程也并不复杂，相当于只是替换了协议，内容其实可以不变。例如给出的哥斯拉支持样例，基本逻辑并没发生改变，只是协议变了

还有一个问题是 ws 马必须先注入再连接，并不能直接连接 jsp 马。

然而例如哥斯拉的 jsp 马本身就是支持远程代码执行，那么 jsp 马其实可以保持不变就用哥斯拉原版，但发送 class 要修改，先发送过去先初始化注册 ws 马的 class，连上 ws 以后再初始化恶意 class，多一步，第二步连接的时候使用 ws 连接。

![](https://mmbiz.qpic.cn/mmbiz_png/7nIrJAgaibicOjNJF9F3wutFjicSjLtOFZoDldfONT6ISIOPFNibAesnN7fq8gHeQgiaYeLD82F3f3yn0NiaqhqkiaDSQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

如果是内存注入的内存马则不需要连接 jsp，直接连接 ws

![](https://mmbiz.qpic.cn/mmbiz_png/7nIrJAgaibicOjNJF9F3wutFjicSjLtOFZogibEaOiaXRZwAgXjiaAsEmfEWPXc32CoRW93LFaQ8KibVDwbbHLib3VZI3w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

版权声明
----

完整代码：https://github.com/veo/wsMemShell

```
本文章著作权归作者所有。转载请注明出处！https://github.com/veo
来源：先知(https://xz.aliyun.com/t/11549)
```

**侵权请私聊公众号删文**

 **热文推荐**  

*   [蓝队应急响应姿势之 Linux](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523380&idx=1&sn=27acf248b4bbce96e2e40e193b32f0c9&chksm=f9e3f36fce947a79b416e30442009c3de226d98422bd0fb8cbcc54a66c303ab99b4d3f9bbb05&scene=21#wechat_redirect)  
    
*   [通过 DNSLOG 回显验证漏洞](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523485&idx=1&sn=2825827e55c1c9264041744a00688caf&chksm=f9e3f3c6ce947ad0c129566e5952ac23c990cf0428704df1a51526d8db6adbc47f998ee96eb4&scene=21#wechat_redirect)  
    
*   [记一次服务器被种挖矿溯源](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523441&idx=2&sn=94c6fae1f131c991d82263cb6a8c820b&chksm=f9e3f32ace947a3cdae52cf4cdfc9169ecf2b801f6b0fc2312801d73846d28b36d4ba47cb671&scene=21#wechat_redirect)  
    
*   [内网渗透初探 | 小白简单学习内网渗透](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523346&idx=1&sn=4bf01626aa7457c9f9255dc088a738b4&chksm=f9e3f349ce947a5f934329a78177b9ce85e625a36039008eead2fe35cbad5e96a991569d0b80&scene=21#wechat_redirect)  
    
*   [实战 | 通过恶意 pdf 执行 xss 漏洞](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523274&idx=1&sn=89290e2b7a8e408ff62a657ef71c8594&chksm=f9e3f491ce947d8702eda190e8d4f7ea2e3721549c27a2f768c3256de170f1fd0c99e817e0fb&scene=21#wechat_redirect)  
    
*   [免杀技术有一套（免杀方法大集结）(Anti-AntiVirus)](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523189&idx=1&sn=44ea2c9a59a07847e1efb1da01583883&chksm=f9e3f42ece947d3890eb74e4d5fc60364710b83bd4669344a74c630ac78f689b1248a2208082&scene=21#wechat_redirect)  
    
*   [内网渗透之内网信息查看常用命令](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522979&idx=1&sn=894ac98a85ae7e23312b0188b8784278&chksm=f9e3f5f8ce947cee823a62ae4db34270510cc64772ed8314febf177a7660de08c36bedab6267&scene=21#wechat_redirect)  
    
*   [关于漏洞的基础知识](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523083&idx=2&sn=0b162aba30063a4073bad24269a8dc0e&chksm=f9e3f450ce947d4699dfebf0a60a2dade481d8baf5f782350c2125ad6a320f91a2854d027e85&scene=21#wechat_redirect)  
    
*   [任意账号密码重置的 6 种方法](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522927&idx=1&sn=075ccdb91ae67b7ad2a771aa1d6b43f3&chksm=f9e3f534ce947c220664a938bc42926bee3ca8d07c6e3129795d7c8977948f060b08c0f89739&scene=21#wechat_redirect)  
    
*   [干货 | 横向移动与域控权限维持方法总汇](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522810&idx=2&sn=ed65a8c60c45f9af598178ed20c89896&chksm=f9e3f6a1ce947fb710ff77d8fbd721220b16673953b30eba6b10ad6e86924f6b4b9b2a983e74&scene=21#wechat_redirect)  
    
*   [手把手教你 Linux 提权](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522500&idx=2&sn=ec74a21ef0a872f7486ccac6772e0b9a&chksm=f9e3f79fce947e89eac9d9077eee8ce74f3ab35a345b1c2194d11b77d5b522be3b269b326ebf&scene=21#wechat_redirect)
    

****欢迎关注 LemonSec****

**觉得不错点个 **“赞”**、“在看 “**