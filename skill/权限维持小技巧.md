> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Vsv5P_sXbk3YHt4u4kKyJg)

窃取域内明文密码
--------

在某些情况下，我们拿到了域的控制权限后需要获得用户的明文密码来进行后续的一些操作。但是使用常规方法导出的只是 hash，如果域内设置了密码强度的策略就会使得 hash 暂时无法破解出来，这时我们就需要一些操作来获得用户的明文密码了。在此介绍一些方法：

**1. Hook PasswordChangeNotify**

需要用到的工具：

https://github.com/3gstudent/Hook-PasswordChangeNotify

下载下来并进行编译，得到一个 dll 文件

使用该 powershell 脚本进行 dll 注入

```
Import-Module .\Invoke-ReflectivePEInjection.ps1<br style="visibility: visible;">Invoke-ReflectivePEInjection -PEPath HookPasswordChange.dll -procname lsass<br style="visibility: visible;">
```

这时已经 dll 注入成功。

后续如果有用户更改密码就会在 `c:\windows\temp` 目录下生成一个 `passwords` 文件。

如果想更改文件位置也可以修改代码。

![](https://mmbiz.qpic.cn/mmbiz_png/ibTZIRKIklebIJR1LYPuibZex7NG0s5gyD10GP7W5uaLCJVibkHwVaUrKicjrP7Lib3h89YSU1RPibNKWT9mPvicMkX1Q/640?wx_fmt=png)

**2. 可逆密码存储**

手动设置：

打开服务器管理界面，选择用户和计算机

![](https://mmbiz.qpic.cn/mmbiz_png/ibTZIRKIklebIJR1LYPuibZex7NG0s5gyD3YsowVRgqTHqsItJXz3qZ7icSSO3N1h6MTOoNoczLDAvibpUuEnv5picA/640?wx_fmt=png)

然后打开 users 界面选择 用户属性 -> 账户

![](https://mmbiz.qpic.cn/mmbiz_png/ibTZIRKIklebIJR1LYPuibZex7NG0s5gyDcr5v4tiasXmCFelf38BpfffPpmo2YWDYkVnicZTBnYcyS6lDFp5BDnRQ/640?wx_fmt=png)

把可逆加密存储密码选项勾上即可，当该用户下次更改密码时我们即可使用 secretsdump 拿到明文密码。

如果想快速拿到明文密码也可以勾选上用户下次登录时必须修改密码这个选项。

powershell 下操作：

```
Set-ADUser john -AllowReversiblePasswordEncryption $true
```

设置可逆存储之前：

![](https://mmbiz.qpic.cn/mmbiz_png/ibTZIRKIklebIJR1LYPuibZex7NG0s5gyDz0t8cfa6rMZd8L3nzkBv2jlf9IBVqDvX9sg9NNFfqdYI0cic8XpYwEQ/640?wx_fmt=png)

设置可逆存储之后修改密码子再次 dump：

![](https://mmbiz.qpic.cn/mmbiz_png/ibTZIRKIklebIJR1LYPuibZex7NG0s5gyDDPxYxUFdKlnplKNHXkzWmCZxXcpwtEia1NmtdesVNVlbcvEsksV7T2Q/640?wx_fmt=png)  
  

sid history 域内权限维持
------------------

每个用户账户都有一个对应的安全标识符 (SID)，在通常情况下 sid 是唯一的，但是为了支持域环境迁移，微软设计了 sid history 属性，因此在拿到权限后，我们可以借用这一属性来授予域内普通用户域管的权限，而不再域管组里面，实现权限维持。

使用普通域用户访问域控共享：

![](https://mmbiz.qpic.cn/mmbiz_png/ibTZIRKIklebIJR1LYPuibZex7NG0s5gyDK5iaSSnICm77mVwPBBuemunJvfONiaK8fCMibIZrXF1JWKO2FU5GMEr6g/640?wx_fmt=png)

使用 mimikatz 更改该用户的 sid

![](https://mmbiz.qpic.cn/mmbiz_png/ibTZIRKIklebIJR1LYPuibZex7NG0s5gyDgPLiayFAxMsy6EFvvrAOOPjySK3BCz6mzvTniaA7k3NtS7D0hrohXXCQ/640?wx_fmt=png)

成功更改了用户的 sid，接下来重新访问域控共享：

![](https://mmbiz.qpic.cn/mmbiz_png/ibTZIRKIklebIJR1LYPuibZex7NG0s5gyDVnE9UV98l8J33bWvia3PyWbkMiasOrDyA4SckpVfqoEGapQpHSoLF0gw/640?wx_fmt=png)

可以成功访问了，且域管组里面不存在我们这个用户。