> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/M8hK70imhy0sgF8Kde0hkw)

**![](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3MmaYz8UWHicLDSC4e3NqcibOLicCiaYtmQm9A0Ied3OLs4Wibj6bLz8jmf0gB3k0h1aQNNVKNqjKFcZV0Mg/640?wx_fmt=gif)**
---------------------------------------------------------------------------------------------------------------------------------------------------

**引言**

  

  

以色列工业网络安全公司 Claroty 旗下的 Team82 研究团队开发了一种称为 Evil PLC 攻击的新技术，其中 PLC 被武器化并用于突破并控制工程师站。在工程师站上立足的攻击者可以访问连接该机器的 OT 网络上的任何其他设备，包括其它 PLC。攻击的目标是从事工业网络运维、PLC 配置和故障排除的工程师，他们的工作是确保公用事业、电力、水和废水、重工业、制造和汽车等关键行业的流程的安全性和可靠性。Team82 团队的研究成果在 7 家自动化公司（罗克韦尔自动化、施耐德电气、通用电气、贝加莱、信捷、OVARRO 和艾默生）的相应设备上进行了有效的概念验证利用。

PLC 在工业领域的重要作用不言而喻，典型的工业网络可能有几十台 PLC 执行不同的操作，因之它也成为极其具有吸引力的攻击目标。但通常我们所能理解的大多数涉及 PLC 的攻击场景都是围绕 PLC 本身的访问、控制和利用。

Team82 研究团队另辟蹊径，他们试图寻找一种不同的方法，将 PLC 作为工具而不是目标。基于此，研究人员希望利用 PLC 来访问它的维护者，工程师站。攻击者引诱工程师连接到受感染的 PLC 的最快方法是使 PLC 发生故障或异常。这将迫使工程师使用工程师站软件连接作为故障排除工具。一旦控制工程师站，它将是获取相关信息的最佳来源，并将通过它访问网络上的所有其他 PLC。通过这些访问和信息，攻击者可以很容易地改变任何 PLC 上的逻辑。

通过 Team82 的研究，他们试图对多个领先的 ICS 平台执行这种新的攻击向量。研究人员在七家自动化厂商的平台上发现了各种漏洞，这些漏洞使他们能够将 PLC 武器化，当执行上传程序时，研究人员专门制作的辅助数据片段会导致工师站执行预制的恶意代码。

  

**一**

**基础知识**

对于每个目标供应商平台，需要研究的完整生态系统包括:

**-** 工程师站软件

**-** 工程师站项目文件

**-** 专有协议 (PLC 和工程师站)

**-** PLC 固件

**-** 逻辑代码 (字节码，文本代码)

![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmZ8cNZpQEScRdoBNZ63MU7XWLGiaHIHAYtFtCzWtI8wVQuYk25hH7f6ibfBoVcWMBjjrHe9vBS4ibCng/640?wx_fmt=png)

**1、项目文件**

通常情况下，项目文件是简单的基于存档的文件，具有相对容易理解的结构; 大多数情况下，研究工作都是从那里开始的。例如，GE MarkVIe 项目文件包含具有易于理解的命名约定的文本 XML 文件。它帮助研究人员了解工程师站生成并传输给 PLC 的全部数据类型范围。如下图是一个 GE ToolBoxST 的项目文件。

![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmZ8cNZpQEScRdoBNZ63MU7XBs3uJdAe3ickUzqGKWrR1LrjAPexPMWjGEXwQVoywN4ich8Vicanv3Qjw/640?wx_fmt=png)

当然，也一些项目文件是以研究人员需要分析和逆向工程的专有格式存储的。例如，艾默生工程师站 PAC 机器版使用的是一种专有的. swxcf 项目文件格式，它是基于二进制的 MFC 序列化数据。这个项目文件存储了一个完整的操作项目所需的数百个序列化的 c++ 对象。为了完成研究工作，研究人员为所有文件格式编写了解析器，并提取了项目的源代码逻辑、元数据和配置数据。下图就是一个艾默生工程师站 PAC 机器版使用的是一种专有的. swxcf 项目文件示例。

![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmZ8cNZpQEScRdoBNZ63MU7XibBTvVkfvuoHcPPy0GzT3a3xZeheHZWK8Mj8LbcbvhUKZicNuMHncyfQ/640?wx_fmt=png)

**2、通信协议**

另一个需要考察的重要方面，每个供应商开发和实现的专有协议。通过该协议，工程师站软件可以与兼容的 PLC 进行通信，执行获取其状态、进行监控和数据采集 (SCADA) 操作、进行固件升级等操作，对研究人员来说最重要的是执行上传 / 下载程序，修改或获取当前运行的逻辑。有些协议很容易分析，而有些则很复杂。最终，研究人员为这个研究项目范围内的所有专有协议开发了解析器和客户端。

例如，信捷 XD 工程师站 PLC Program Tool 就是使用基于 UDP modbus 协议与 PLC 进行通信的。大部分功能是通过 Modbus 读取 / 写入文件记录和 / 或多寄存器 Modbus 功能代码实现的。下图是上传过程中对信捷协议网络流量的 Wireshark 截图。

![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmZ8cNZpQEScRdoBNZ63MU7XssCLuUzFew8t28ouaGicXLQHaYa2jjhxj45x6ZpA68ge25jklc86I7A/640?wx_fmt=png)

**3、文本代码和字节码**

除了项目文件和专有协议之外，还研究了文本代码 (源代码) 和字节码(编译代码)。这是研究工作的一个重要方面，因为它允许研究人员执行全面的下载 / 上传程序，并帮助研究人员实现自动化和获得对 PLC 逻辑的控制。

虽然在研究中这不是必要的，但在某些情况下，为专有的 PLC 字节码开发了部分 / 完全工作的编译器和反编译器。

**4、恶意代码或攻击载荷**

最后，为了实现有效载荷和演示目的，研究人员准备了一个假的 WannaCry 勒索软件，它只是向用户显示一个看起来很吓人的弹出的勒索通知。在实际的攻击场景下，这个恶意代码很可能是敏感信息窃取、隐蔽后门、内网渗透等等不同用途的木马，加密文件的勒索软件，甚至是破坏性的文件擦除器。

![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmZ8cNZpQEScRdoBNZ63MU7XFzjAgIatQrQJdoHPLn57M18Mhzbum9hcqVlED5F0KxhggB2Sibf89zA/640?wx_fmt=png)

通过 Team82 全面的研究，能够找到 7 个以前未报告的漏洞，这些漏洞使 Team82 能够将受影响的 PLC 武器化，并在每次上传过程发生时攻击工程师站。所有的发现都按照 Team82 的协调披露政策报告给受影响的供应商。

  

**二**

**攻击场景想定  
**

当观察 Team82 的邪恶 PLC 攻击向量时，研究人员得出的结论是，它可以用于进攻和防御两种方式。考虑到这一点，Team82 设计了三种不同的攻击场景，可以使用这种新的攻击向量。

**1、将 PLC 武器化以实现初始访问**

攻击者可以使用武器化的 PLC 来在内部网络上获得初步立足点，甚至是横向移动。目前，利用 Shodan 和 Censys 在内的大多数公共互联网扫描服务，可以确定有数十万台 ICS 设备暴露在互联网上。这些面向互联网的设备通常缺乏安全性，允许任何人访问它们，修改参数，甚至通过下载程序改变它们的行为和逻辑。Team82 的研究表明，攻击者可以利用面向互联网的 PLC 作为支点，渗透整个 OT 网络。攻击者不是简单地连接到暴露的 PLC 并修改逻辑，而是可以武器化这些 PLC 并故意造成错误，从而引诱工程师使用它们。作为一种诊断方法，工程师将执行一个上载程序，这将危及他们工作站。攻击者进一步控制工作站，在 OT 网络上站稳了脚跟。

**2、攻击系统集成商**

攻击者可以针对系统集成商和承包商，作为进入世界各地许多不同组织和站点的手段。攻陷设备集成商：因为 OT 网络管理中，第三方工程师和承包商管理 OT 网络，它需要与许多不同的 OT 网络设备和 PLC 交互。这给这个新的攻击向量提供了另外另一个应用场景。即攻击者可以攻陷并利用这些系统集成商作为支点，以大幅扩大他们的控制和影响范围。

实际步骤将会是：攻击者在一个远程的、不太安全的设施中定位了 PLC，已知该设施由系统集成商或承包商管理。然后攻击者将 PLC 武器化，故意使 PLC 出现故障。这样，统集成商或承包商的工程师就会被引诱到可编程控制器前进行诊断。通过诊断过程，集成商将做一个上传程序，从而使他们的机器被控制。在进入集成商的机器后，通过设计可以访问许多其他 PLC，攻击者可以反过来攻击甚至武器化其他组织内的更多可访问的 PLC，进一步扩大他们的控制范围。

**3、将 PLC 武器化为蜜罐**

防御者可以使用蜜罐 PLC 来吸引和攻击可能的攻击者，从而威慑和挫败潜在的攻击者。从防御的角度来看，这种新的攻击向量可以用来为可能的攻击者设置陷阱，即蜜罐。通过利用攻击者也使用与工程师相同的商业工具这一事实，防御者可以故意设置公开可访问的可武器化的 PLC，并允许攻击者与它们交互。这些 PLC 将充当一个蜜罐，吸引攻击者与它们交互。但是，如果攻击者落入陷阱，并从诱饵 PLC 尝试执行上载过程，我们的武器化代码将在攻击者的机器上执行。这种方法可以用于早期阶段的攻击检测，也可能阻止攻击者以面向互联网的 PLC 为目标，因为他们需要保护自己不会成为有计划攻击的目标。

![](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmZ8cNZpQEScRdoBNZ63MU7XP2ws4bUm4wRkeJpwKklOcyRLMBZxicjlJvTz1GIh3e13ruzdxKRiavqA/640?wx_fmt=png)

  

**三  
**

**攻击步骤**

对于每个目标 / 平台，研究人员试图通过对固件和工程师站软件进行逆向工程来剖析整个下载 / 上传机制。研究人员的目标是找出 PLC 和工程师站之间的差异。如果发现了这种不一致，就可以通过恶意下载程序将 PLC 武器化，存储一段专门制作的数据，这段数据不会影响 PLC 本身，但当工程平台解析它时，它会触发并利用一个漏洞。

#### **1、研究验证的步骤**

Team82 的研究过程和方法有如下十个关键的步骤。

1) **环境设置**：使用目标 PLC、兼容的工程师站和 I/O 现场设备建立测试平台环境。

2) **建立 “Hello World”**：阅读 PLC 手册，观看教学视频，建立一个无恶意 / 良性的程序来控制简单的过程。

3) **分析项目文件**：分析项目文件中存储的内容 (元数据、配置、文本代码) 以及数据是如何序列化的。事实上，PLC 存储了工程软件使用的其他类型的数据，而不是 PLC 本身使用的数据，这让修改存储在 PLC 上的未使用数据以操纵工程软件成为可能。

4) **逆向工程**：除了工程师站软件之外，探索 PLC 硬件和固件。这是围绕 PLC 的软件、硬件和固件开展漏洞挖掘的前奏。

5) **上传 / 下载过程**：了解上传 / 下载过程的机制，以及通过专有协议传输哪些数据。往 PLC 上传输数据和将数据存储于 PLC 上，称为下载过程。获取当前 PLC 逻辑的工作副本，工程师将从 PLC 中读取存储的数据，这称为上传过程。

6) **协议分析**：分析私有协议及其功能，并构建一个功能齐全的客户端。

7) **找出差异**：了解在 PLC 中传输和存储的信息之间的差异，这些信息没有被解析或使用。

8) **寻找漏洞**：研究工程师站传输到 PLC 的所有信息片段的所有解析代码流，这些信息在 PLC 上没有被使用 / 修改。主要是针对运行在工程师站上的 PLC 连接软件进行漏洞挖掘。在 Team82 的研究中，他们发现了罗克韦尔 CCW 中的多个漏洞，其中一个是不安全的. net 反序列化漏洞。

9) **武器化**：使用客户端实现一个恶意下载过程，将专门制作的数据存储在 PLC 上。这里的专门制作的数据，应该是相应的漏洞利用程序、勒索软件、木马等的组合进行的编码。

10) **漏洞利用**：工程师连接 PLC，执行上传程序。工程师站解析研究人员专门制作的数据。解析流触发漏洞并执行预先编制的代码。

#### **2、关键步骤**

仔细分析 Team82 团队的研究验证步骤，不难发现，其中前半部分的主要是类似侦察准备的阶段，真正可称为攻击动作的应当在后半部分。也就是说，抛开研究的成分，从攻击的角度看，关键的攻击步骤可梳理如下：

**1) 找到可以公开访问 PLC，并且能够现连接软件建立连接，即对 PLC 可管理。**

**2)PLC 连接软件的漏洞挖掘。也就是对工程师站软件的逆向分析，找出其存在的各种可利用漏洞。**

**3) 恶意代码的编码。使其以 PLC 工程文件形式储存于 PLC。**

**4)PLC 的武器化，即利用下载过程将预制的工程文件下载至 PLC。**

**5) 制造 PLC 异常或故障，引诱工程师来连接排障。**

**6) 漏洞利用。工程师上传预制工程文件到工程师站，解析时触发漏洞。**

从网络攻击的角度看，参照工业控制系统的 ATT@CK 威胁框架，在初始突破（Initial Access）、命令执行（Execution）、持久潜伏（Persistence）、权限提升（Privilege Escalation）、防御规避（Evasion）、内部侦察 (Discovery)、横向移动（Lateral Movement）、信息收集（collection）、命令和控制 (C&C)、抑制响应功能（Inhibit Response Function）、损害过程控制（Impair Process Control）、后果影响（Impact）这十二个步骤中，Team82 的研究成果实际上已完成了关键的初始突破、命令执行、持久潜伏等任务，在 OT 网络构筑了关键的支点，后续的系列侦察活动和影响行动，几乎就没有了难度。

  

**四**

**小结**

Team82 认为邪恶 PLC 攻击是一种新的攻击技术。这项技术使 PLC 武器化，使数据不再是普通静态 / 离线项目文件的一部分，并使代码能够在工程连接 / 上传过程中执行。通过这种攻击方式，攻击目标并不是 PLC，即有别于臭名昭著的 Stuxnet 恶意软件，它偷偷改变 PLC 的逻辑，造成物理破坏。相反，Team82 希望利用 PLC 作为一个支点 / 跳板，攻击编程和诊断它的工程师站，以此获得对更多 PLC 的控制，并获得对 OT 网络的更深入访问。

值得注意的是，Team82 发现的所有漏洞都是在工程师站软件端，而不是在 PLC 固件中。在大多数情况下，漏洞的存在是因为软件完全信任来自 PLC 的数据，而没有进行广泛的安全检查。

**从防御者的视角看，邪恶 PLC 攻击技术中，PLC 的武器化是第一步。毫无疑问，这些设备不应该从外部访问或暴露在网络上，即使内部访问也应限于授权的工程师和操作员。如何阻断这一源头非常关键，因此应严格限制对 PLC 的物理和网络访问。其次才是 OT 网络的隔离分段、基本网络卫生的落实、用户客户端的鉴别认证、PKI 体系的引入、网络流量监测、软件和固件的持续更新等等防护措施。**

**往期精选**  
![图片](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3MmYrt8sZBqiah8aNInQspzccnPAAhd0OKLQ5Ziad4ovQEohiamyrpYjQcwVAWROpYWmMXia1YRKPiczFSQw/640?wx_fmt=gif)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmYYBMzc1f4pWNwbdl6iawj3I6CuEyYibKVPF0KVfkbXAz5SdvmZMk9UYUIxeJPh1icZqJvlU2EafvpFA/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247526763&idx=1&sn=bbb05065cb26baedc027ec444048f7d3&chksm=fd76833cca010a2a5861c93a5d05644d1c71653711b6891c666ceec93ed07b2570dcaa185457&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmYYBMzc1f4pWNwbdl6iawj3IQLNibs5ibkGWHMAziaK6t5Vib4PcM34egDfzYFJlBDIqUZWl7e6qkwTCMA/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247521869&idx=1&sn=2f9d0e67e6ae69ecfa549d767e736930&chksm=fd767c1aca01f50ccb3d6d801fa5e0bc5b5afd43eb7e12f44091ead75f5fa196d0b8d6aad1f9&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmYYBMzc1f4pWNwbdl6iawj3IajlYxvdgOpQq2SbSlR7cictXMIL0tickqu9pLSm0BARbhQf7xO7Tcvvw/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247493342&idx=1&sn=11205d1f60b72f0d49749287a33c0381&chksm=fd760c89ca01859fdee47bfb943598d12d4026cbf30df8494bda66bc3fb2da6f3801f164a446&scene=21#wechat_redirect)

[![图片](https://mmbiz.qpic.cn/mmbiz_jpg/ll2PVky3MmYYBMzc1f4pWNwbdl6iawj3IOrT8TaoLu38HEqsBnsEG8Qrx1VicUEiaVjZzLnegWwTU2ctesAYs9vEQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzU3ODQ4NjA3Mg==&mid=2247501736&idx=1&sn=74abdaff12cfc5a24d2134e39ec9cab2&chksm=fd762dffca01a4e9c4b474c819f48a4e199750ba10aa659046fde5e86ff573a33ec007b9b867&scene=21#wechat_redirect)

**安帝科技**丨 **ANDISEC**

  

北京安帝科技有限公司是新兴的工业网络安全能力供应商，专注于网络化、数字化、智能化背景下的工业网络安全技术、产品、服务的创新研究和实践探索，基于网络空间行为学理论及工业网络系统安全工程方法，围绕工业网络控制系统构建预防、识别、检测、保护、响应、恢复等核心能力优势，为电力、水利、石油石化、轨道交通、烟草、钢铁冶金、智能制造、矿业等关键信息基础设施行业提供安全产品、服务和综合解决方案。坚持 IT 安全与 OT 安全融合发展，坚持产品体系的自主可控，全面赋能客户构建 “业务应用紧耦合、用户行为强相关、安全风险自适应、网络弹性稳增强” 的主动防御和纵深防御相结合的安全保障体系。截至 2021 年底，公司主要产品已应用于数千家 “关基” 企业，其中工业网络安全态势感知平台已部署 4000 余家客户，虚实结合工业网络靶场服务超过 50 家客户。

![图片](https://mmbiz.qpic.cn/mmbiz_gif/ll2PVky3Mma4ibTfp7sC3ibt8WmetoDfiaGHEb7VOiaemeFbuCTupYgus7NTKkibwKwpsEDfzqZdXh1skHff6A6VNgA/640?wx_fmt=gif)

**点击 “在看” 鼓励一下吧**

**![图片](https://mmbiz.qpic.cn/mmbiz_png/ll2PVky3MmZOFFgf4oTyfUTx7y0ZBV9yIg8qmaSwAvbjiba2KQn7VgmXYIriagc9H0hMu1u0UIZr98JYSmyG9tibg/640?wx_fmt=png)**