> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/HGHSRqJtFp3_KMuc1n8tkg)

1. 前言

Windows Exchange Server，是国内外应用非常广泛的邮件服务器，是微软公司的一套电子邮件服务组件。简单而言，Exchange server 可以被用来构架应用于企业、学校的邮件系统。在渗透测试过程中经常会发现目标系统存在 Exchange server 所以便尝试总结利用方式扩展渗透的思路，这也是本文的初衷。![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfv9AeO658qhubxDfKlWCPNNTicZaTH6BTcicicdIRBL5SOia5cDTQgmvdxQ/640?wx_fmt=png)

#### 1.1 环境搭建

参考网上的步骤和配置完成搭建即可 https://saucer-man.com/information_security/748.html 唯一要说明的是，进入安装 setup 步骤不用右键管理员权限，有时候右键后反而会卡住无法进行安装引导。![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfphqrOP0Zh97AmAS9OlIA6rlBFEftKd9iaPV6LAVhMiangl5dm5xPz1dg/640?wx_fmt=png) 简单 exchange 测试环境搭建完成

安装完后需要配置的：允许以 @方式登录

1. 允许以 <username>@<domain > 方式登录 2. 配置外部 URL 访问

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfULBGSCNStDVLbxibhSj5b9hLicibXSzw9z6yq05tVIqKcE6x7cuYD7v6Q/640?wx_fmt=png) 配置外部 URL 访问 （ecp 和 owa 都要改） ![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfz0O69tibDQh7LwWqRTDE5KHlX8nsMRECIMlkTAdSKTTNXjK2iaJuLutA/640?wx_fmt=png) 按照命令重启即可 ![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfSAQRmrD4XutibzPaY20lugKapewXdNKe0e8Y1cBANX4VonfP9ricDteQ/640?wx_fmt=png) 新建用户 Exchange 安装完后只有当前机器加入的域用户，在 Exchange 新建用户 === 域新建普通用户 添加用户有两种方法：

* 新建用户 * 从现有的域用户添加用户（现有域用户所在的组有什么权限，添加后的用户就有什么权限）

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfDdm59NmVcvllKicLDgms3rnIVzk68ltfT899YttLq2Sniaiak74c81eRg/640?wx_fmt=png) 邮件测试![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfYO2q5l871q4DANzXMHUKTxza80u4aDjLnk4R5N2YprwPanmLj54hHw/640?wx_fmt=png)

#### 1.2 dork

microsoft exchange 2013：app="Microsoft-Exchange-2013"||app="Microsoft-Exchange-Server-2013-CU21"||app="Microsoft-Exchange-Server-2013-CU17"||app="Microsoft-Exchange-Server-2013-CU23"||app="Microsoft-Exchange-Server-2013-CU13"||app="Microsoft-Exchange-Server-2013-CU22"||app="Microsoft-Exchange-Server-2013-CU11"||app="Microsoft-Exchange-Server-2013-CU2"||app="Microsoft-Exchange-Server-2013-CU16"||app="Microsoft-Exchange-Server-2013-CU19"||app="Microsoft-Exchange-Server-2013-CU3"||app="Microsoft-Exchange-Server-2013-CU18"||app="Microsoft-Exchange-Server-2013-CU5"||app="Microsoft-Exchange-Server-2013-CU20"||app="Microsoft-Exchange-Server-2013-CU12"||app="Microsoft-Exchange-Server-2013-CU15"||app="Microsoft-Exchange-Server-2013-CU10"||app="Microsoft-Exchange-Server-2013-CU9"||app="Microsoft-Exchange-Server-2013-CU6"||app="Microsoft-Exchange-Server-2013-CU7"||app="Microsoft-Exchange-Server-2013-CU1"||app="Microsoft-Exchange-Server-2013-CU14"||app="Microsoft-Exchange-Server-2013-CU8"||app="Microsoft-Exchange-Server-2013-RTM"||app="Microsoft-Exchange-Server-2013-SP1"||app="Microsoft-Exchange-2013" microsoft exchange 2016：app="Microsoft-Exchange-Server-2016-CU19"||app="Microsoft-Exchange-Server-2016-CU3"||app="Microsoft-Exchange-Server-2016-CU12"||app="Microsoft-Exchange-Server-2016-RTM"||app="Microsoft-Exchange-Server-2016-CU7"||app="Microsoft-Exchange-Server-2016-CU17"||app="Microsoft-Exchange-Server-2016-CU2"||app="Microsoft-Exchange-Server-2016-CU1"||app="Microsoft-Exchange-Server-2016-CU14"||app="Microsoft-Exchange-Server-2016-CU5"||app="Microsoft-Exchange-Server-2016-CU11"||app="Microsoft-Exchange-Server-2016-CU9"||app="Microsoft-Exchange-Server-2016-CU16"||app="Microsoft-Exchange-Server-2016-CU10"||app="Microsoft-Exchange-Server-2016-CU6"||app="Microsoft-Exchange-Server-2016-CU13"||app="Microsoft-Exchange-Server-2016-CU18"||app="Microsoft-Exchange-Server-2016-CU8"||app="Microsoft-Exchange-Server-2016-CU4"||app="Microsoft-Exchange-2016-POP3-server" microsoft exchange 2019：app="Microsoft-Exchange-Server-2019-CU5"||app="Microsoft-Exchange-Server-2019-CU3"||app="Microsoft-Exchange-Server-2019-Preview"||app="Microsoft-Exchange-Server-2019-CU8"||app="Microsoft-Exchange-Server-2019-CU1"||app="Microsoft-Exchange-Server-2019-CU7"||app="Microsoft-Exchange-Server-2019-CU2"||app="Microsoft-Exchange-Server-2019-CU6"||app="Microsoft-Exchange-Server-2019-RTM"||app="Microsoft-Exchange-Server-2019-CU4" microsoft exchange 2010：app="Microsoft-Exchange-2010-POP3-server-version-03.1"||app="Microsoft-Exchange-Server-2010"

### 2. 思维导图作战图

![](https://mmbiz.qpic.cn/mmbiz_jpg/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfvLsFRcq3TnLb3eZicT9iaiciaKNVxqMvnKvzzPqSCNNlZavsoHMtPzYsEA/640?wx_fmt=jpeg)

### 3. 具体利用

#### **3.1 基础架构**

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfYTarXTjiaB44ibqrOzl6uE8xIaj3MrIHeNzAMiboqIxxCC1n9nibRSsKaQ/640?wx_fmt=png) 在 exchange 2010 中，exchange 包含五个服务器角色，分别为邮箱服务器，客户端访问服务器，集线传输服务器，统一消息服务器，边缘传输服务器。在后来的 exchange 2013 中服务器被精简为 3 个：邮箱服务器，客户端访问服务器，边缘传输服务器 exchange 2016 和 2019 中则只有 邮箱服务器和边缘传输服务器了。

**a. 邮箱服务器** mailbox server，提供托管邮箱，公共文件夹等服务，是必选的服务器角色

**b. 客户端访问服务器** client access server，用来接收并处理不同客户端的请求，并提供各种接口给客户以访问 Exchange 服务,

MAPI 访问 POP3 和 IMAP4 访问 Outlook Web App 访问（OWA） Outlook Anywhere 访问 Autodiscover 自动发现服务 可用性服务

**c. 集线传输服务器** hub transport server，核心服务是 Microsoft Exchange Transport，用于处理大多数邮件的路由、策略等以及 Mail Flow。起一个邮件传输中继的作用。

**e. 统一消息服务器** unified messaging server，用于允许邮箱用户可以在邮件中发送存储语音消息和传真消息，可选角色

**f. 边缘传输服务器** edge transport server，通常部署于网络边界。其接受来自内部组织的邮件和来自外部可信服务器的邮件，然后应用特定的反垃圾邮件、反病毒策略，最后将通过策略筛选的邮件路由到内部的集线传输服务器，可选角色

**g. 常用接口** 通常 Exchange Server 有以下接口，即可访问的接口连接如下：

<table width="750"><tbody><tr><td width="375"><p><strong>接口</strong></p></td><td width="375"><p><strong>说明</strong></p></td></tr><tr><td width="375"><p>/autodiscover</p></td><td width="375"><p>自 Exchange Server 2007 开始推出的一项自动服务，用于自动配置用户在 Outlook 中邮箱的相关设置，简化用户登陆使用邮箱的流程。</p></td></tr><tr><td width="375"><p>/ecp “Exchange Control Panel”</p></td><td width="375"><p>Exchange 管理中心，管理员用于管理组织中的 Exchange 的 Web 控制台</p></td></tr><tr><td width="375"><p>/ews “Exchange Web Services”</p></td><td width="375"><p>Exchange Web Service, 实现客户端与服务端之间基于 HTTP 的 SOAP 交互</p></td></tr><tr><td width="375"><p>/mapi</p></td><td width="375"><p>Outlook 连接 Exchange 的默认方式，在 2013 和 2013 之后开始使用，2010 sp2 同样支持</p></td></tr><tr><td width="375"><p>/Microsoft-Server-ActiveSync</p></td><td width="375"><p>用于移动应用程序访问电子邮件</p></td></tr><tr><td width="375"><p>/OAB “Offline Address Book”</p></td><td width="375"><p>用于为 Outlook 客户端提供地址簿的副本，减轻 Exchange 的负担</p></td></tr><tr><td width="375"><p>/owa “Outlook Web APP”</p></td><td width="375"><p>Exchange owa 接口，用于通过 web 应用程序访问邮件、日历、任务和联系人等</p></td></tr><tr><td width="375"><p>/powershell</p></td><td width="375"><p>用于服务器管理的 Exchange 管理控制台</p></td></tr><tr><td width="375"><p>/RPC</p></td><td width="375"><p>早期的 Outlook 还使用称为 Outlook Anywhere 的 RPC 交互</p></td></tr></tbody></table>

#### 3.2 信息收集

**3.2.1 版本确定** 可以通过 OWA,ECP 接口的 HTML 源代码确定版本，源代码搜索 favicon.ico ![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfQO3OqNanCQ442baS86REbelWtX2tvMcKfictvQlcb5kCxlMkwaW4Xjw/640?wx_fmt=png) 或者在 EWS 接口，在 Response Headers 中的 X-OWA-Version 可以获得精确版本 我这边测试了一下我的 2016 靶机和线上的 2019 没有版本信息 ![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfftKOtFKDeRIc5Z5lIzguIicG1mXGf8rJowvNLRsl6aEuz98yibEvAEpA/640?wx_fmt=png) 网上 2016 存在版本信息、2010 没有找到对应资产 ![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfcD8Sz52pk5FEKXAecicraao27y6GadHcxAMLoJmxExsRlSSR8lrohWQ/640?wx_fmt=png)****3.2.2**IP 泄露 抓包以下接口包，将 HTTP 版本改为 1.0，并删除 HOST 头，就会暴露 exchange ip，有时会暴露内网 IP 想要更方便的话，可以用 msf 的模块自动搜集 use auxiliary/scanner/http/owa_iis_internal_ip 我这里测试不同版本都没有成功![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfwJYHdAnXek4icBeQn5mkdslUS6GEQI1trR6WkCmO2WpujVsMicETHGRw/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfcibJ4hMOsiaBNr8ZfUpC7F1G3eHyQW9VXSRV1b9cmx3EGdaDrDOVpNPA/640?wx_fmt=png)

**3.2.3** 泄露 exchange 服务器信息 当我们对 exchange 服务器进行 NTLM 质询时, 在服务器返回 challenge 时同时会返回域信息，机器名等信息。以此为基础可以对 exchange 进行服务器信息搜集 直接 nmap

nmap host  -p 443 --script http-ntlm-info --script-args http-ntlm-info.root=/rpc/rpcproxy.dll -P

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfnkkfXmAecDKBoykASmI7Slx49V5qmSyiayibaGoianpAsibJBZcDEzSmrA/640?wx_fmt=png)

#### 3.3. 密码爆破

常用于暴力破解的有 1.Autodiscover(401 认证 NTLM Authenticate) 2.OWA(post 表单) 3.EWS(401 认证 NTLM Authenticate) 4.Microsoft-Server-ActiveSync(401 认证 + base64) autodiscover 爆破的原理是，访问 autodiscover 时浏览器会弹出认证框，当输入正确的凭证后则会显示 XML 文档内容。根据此返回的内容进行暴力判断的依据。![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfatn8l20Dpp5jG837xdrBqRgmB6E7OrcnuCrvTyTTY8XHU2yKIaF04A/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyf58oLVBaBqMpZH0NrcbSRjXzkEyr9sPvVtj3WTxX6TDLlTrTyoWEFtQ/640?wx_fmt=png)**使用 ruler 工具** https://github.com/sensepost/ruler ruler 是针对 Exchange 的半自动利用工具，其 Brute 功能使用率较高，主要通过 Autodiscover 接口进行密码枚举。准备用户名、密码字典：user.txt、pass.txt

ruler-win64.exe --url https://192.168.43.135/autodiscover --insecure brute -delay 0 --users user.txt --passwords pass.txt

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfZQZnQIWSEXHY3yf5PpDMw6p6icuqe9wmOE1VjtcjaQIreb09q9Y6SMA/640?wx_fmt=png) 测试速度比较缓慢

#### 3.4. 漏洞利用

**关于漏洞版本判断** 通过上面收集到的对于的 exchange 版本号码和发表时间 https://docs.microsoft.com/en-us/exchange/new-features/build-numbers-and-release-dates?view=exchserver-2019![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyftAS7ia5GaHjeomYUIiaSXppeKhxcNgvic8lHA8cnu8Dp8YyPbyrX67jXQ/640?wx_fmt=png) 查看具体的漏洞详情，如果发布的 exchange 版本在该漏洞补丁之前就有，那么可能存在漏洞就可以打一波，但是实战中一般都是先打一波，如果没有成功后面再来验证 https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-26855![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfmRDgchXyc0XWNpkFI0d4UnAhAdtuuXMTQeTkXJbeiaIEFSIzu05CIDQ/640?wx_fmt=png)**CVE-2021-26855** 

是⼀个 SSRF, 只需要能够访问 Exchange 服务器,

攻击者可以不经过任何类型的身份验证来利⽤此漏洞![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfvqfHtfPULeIaVjicwibYsmicUphOoibASG0MwvVpiaymrSlAx0l0sTNHHdw/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfuoWhqWibDrwwtgXcQqLxOkicabjwb2RCoHU9ibrpBibFv8GaXgqQNGcX1w/640?wx_fmt=png)

**poc：**https://saucer-man.com/information_security/748.html#cl-8

**CVE-2021-27065**

是⼀个任意⽂件写⼊漏洞，它需要登陆的管理员账号权限才能触发

登录管理员账号后, 进入: 服务器——> 虚拟目录——>OAB

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfibEYXPT8yge0BS4wohGcSiaQjSFCOxKdK5X46iaNUAraiadOJTqIxhLticQ/640?wx_fmt=png) 编辑 OAB 配置, 在外部链接中写⼊ shell 并保存。![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfzLT4Lje3BJNicDyTzmdibXdAWGhhrxgPpzpbesia5Rm3Kffkx9y1PibWng/640?wx_fmt=png)保存后选择重置虚拟目录 

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfw5L3T9bIUQibd0lqQPsDB2qZnue1YPO6cNnbZbicdBj4ibvl6Pq5wdJmQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfFxualZrNy2RtdFT6YAl2noAcdVRgAsddcDyITekzdJ1OJzr8uRsXbQ/640?wx_fmt=png) 成功写入 webshell

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfNOreHYLNiarPcB4t9Q50zSlyExs70K24crWYib5J25WzciaXqb9Opy83Q/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfH04DVyOqr4OzU4ZjR1bUMkOB9bpKETvlKwlUFEq1AXss35ricGaS91g/640?wx_fmt=png)

**CVE-2021-26855+CVE-2021-27065 组合拳利用** 

整个过程都是在未登录的状态下，利用 SSRF 漏洞访问内部资源，Cookie 中的 X-BEResource 字段内容为要访问的资源链接。利用过程如图：![](https://mmbiz.qpic.cn/mmbiz_jpg/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyficgxd0I11MiaKvQrX0ISHlTjCTjKHxpWeIXIwRs60j6AeOJEia1Ieabibg/640?wx_fmt=jpeg)

1. 获取 server name，/ecp/xx.js，cookie 中 local 实际中 为目标 exchange 的域名；

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfuoWhqWibDrwwtgXcQqLxOkicabjwb2RCoHU9ibrpBibFv8GaXgqQNGcX1w/640?wx_fmt=png)

2. 通过 SSRF 漏洞读取 autodiscover.xml 文件，获取 LegacyDN 的值；

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfT9mmAugnkVCfm9s2lxxzSVPxmBgBFmzhqM28hh9F7spxJcvHQVDbrA/640?wx_fmt=png)

3. 利用 Legacy DN 获取 SID；

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfxwqhCArtse670MYc8iaSYYXFDpkQicDXiaS3jIn0VHNBSRFyibSpUcq8yg/640?wx_fmt=png) 此处要在 LegacyDN 后面添加：

\x00\x00\x00\x00\x00\xe4\x04\x00\x00\x09\x04\x00\x00\x09\x04\x00\x00\x00\x00\x00\x00

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfdxI5Bn3s0Q1T62EiccdV1I9iclhv6vywKaaEtibeMhxI34YPpkd8sCWTA/640?wx_fmt=png)

4. 利用 SID 获取 Session、msExchEcpCanary；

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfFeaXhvmKKgZZGxrFsOzmNIkdMcOaicyPvribiaDAkfibvtwwot4EABRvTA/640?wx_fmt=png)

5. 写入 shell

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfPPKBWwYJI1nwqPabwJUCBLu1ic1KV3sZn6nIiaZOG0O6tQOicIxSrljiaA/640?wx_fmt=png) 保存到指定路径

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfqtqstd3H2WqQySffYVmictKllgs4wFILZtvCRrjr762SSyfCWe3s6YQ/640?wx_fmt=png)

**exp**https://saucer-man.com/information_security/748.html#cl-8

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfBEB6iaS6fN5SfaaNNpknZOMlLmwwIrQGdTyaq5n4mO9dpato39M380w/640?wx_fmt=png)

**proxyshell 组合拳利用**

CVE-2021-34473 - 一个 ssrf 漏洞 CVE-2021-34523 - 利用 CVE-2021-34473 配合 Exchange PowerShell BackEnd 提权伪造获得高权限用户 token 值 CVE-2021-31207 - 利用 token 值认证后利用伪造 payload 邮件任意文件写入 webshell

![](https://mmbiz.qpic.cn/mmbiz_jpg/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfIZGNQmJ2fRojtLMjoz5Eh7uyKiaeyqvlys3bBPa2O5ICOPf89XPic7RA/640?wx_fmt=jpeg)**CVE-2021-34473** 

payload

https://192.168.43.135/autodiscover/autodiscover.json?@foo.com/mapi/nspi/?&Email=autodiscover/autodiscover.json%3f@foo.com

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfMibdfibYib5y3OzaOwYpQkKdMQ0AicJUlgFC3aYXStZDzIFAJj9dWyv3bA/640?wx_fmt=png) 1. 首先利用 CVE-2021-34473 的 ssrf 漏洞需要获取对应账户的 LegacyDn![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfNSLhIlhOEd9HlrY1KUCcKYunqg7LICxuKZPc2jQMGLCpMs035loTSw/640?wx_fmt=png)

2. 利用 Legacy DN 获取 SID

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfTURkEN4ic4t9FA5kpULjOxbeKTR6eMVqjicksBFTFpK79pxiavBm7Axyw/640?wx_fmt=png)**CVE-2021-34523** 

3. 获取 sid 后利用脚本（脚本网上有现成的工具和使用方法这里就不赘述）构造 token 值，测试可以正常调用 powshell 接口

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfuia3FcpYS11og2m5Z2mhNfmPQre4bglkHDpFJibiaLSveTayTLuMSNq4Q/640?wx_fmt=png)**CVE-2021-31207** 

4. 利用脚本构造 webshell 再利用该接口发送伪造的 payload 邮件进一步写入 webshell

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyf4gPibKdS8ff05dutkgmZCsK0A8jZSqztMOYkunfmYD7CtYMzUf6xBvQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfH27Av9ZNebbtHuEoL2z0bZnBuMwUQ58S1wPhSB9bcjLh7F6fCrbgXA/640?wx_fmt=png) 最后使用 WsMan 协议调用 exchange powershell 接口，将邮件保存到本地中便成功写入，这里也有大佬写好的现成脚本可以使用。

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyffbqaMJSsGIu6Meqk8eQqJs9DLGfQDUI1JVeCickmdbkkrdPHAwobYoA/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfiaqHvHolpyVEvQY9BMzUE4QTTZAmgibwMhtuzFARBZ5h3ykexQAd10bg/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfeeOTG8sSOibuFMhTOwXXJCOqk7qCZyIcribPjcZ1ZF4SvG4oibxvsy2KQ/640?wx_fmt=png)**exp**

https://blog.csdn.net/weixin_43820662/article/details/120669214 

真实情况下使用 exp 脚本打的时候可能遇到没有生成 webshell 原因大概率是被本地 defender 查杀了

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfTFwibMffoomfmqU7WMX8aFbhpDp0Wfr9ibwPuMUdW7wWVUcRBDIMFGuQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfsibFWzy9qRUZWDJqeibSanUjk02U3HVSgXJVFAJasM9GN8d9YUBhjg8g/640?wx_fmt=png) 尝试了利用构造的免杀 webshell 替换成功上线

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfUcyzgWZaEBG9Hv7YY9o2EdoKvrml4zZ2CtIgMCDLknHDUL0LsjoYaQ/640?wx_fmt=png) 蚁剑连接

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfyZhkvDK1Fiae9bRA5yj7N5icjicwLOGCcPSZdSw3py2QX9ZUYickItqETw/640?wx_fmt=png) 这里注意需要把忽略 https 证书的设置选上不然会连不上

  
![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfxFdgru01ib4y9gzLZseewN2RBHK37OmUOj6CmymRIcAkQU5UATb7tlg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/ofBa42GG7Sh07KtibTLOfd5DvI4WLwEyfWhquicg4kPzqpUWbGfyJLicyddQkGnToD2bbAIvpqzictswxPynIV2kjg/640?wx_fmt=png)

**CVE-2021-31196** 

由于利用条件相对比较苛刻一点就没有深入研究，等有空在进行补充

#### 3.5 邮件窃取

实战中遇到短信二次验证情况无法登陆可以利用 EWS SOAP XML message 访问 Exchange 的资源, 这里可以直接使用脚本 ewsManage.py、ewsManage_Downloader.py、owaManage.py 进行邮件内容的导出，这里就不赘述了。