> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/dPXXpiIQnLLF5SBcZWEEPw)

****0x01 前言****

      在我们日常工作中常常会用到一些工具，普通杀软只能检测这些工具有没有毒，无法检测工具有没有异常外联，无法检测流量，

      再比如在内网中，我相信不小小伙伴都扫过内网，普通杀软也无法检测内网一些工具，要防御这些其实很简单，搭建一个 IDS/IPS 就行了，

       搭建普通 IDS/IPS 很简单，Suricata 和 Snort 任意一个都可以，但是他们无法保存流量，无法对告警的流量进行分析，这时想到了 arkime 可以利用 arkime 和 suricata 进行联动，arkime 用于保存全流量，suricata 用于流量检测，然后就可以从 arkime 下载命中 suricata 规则的流量包进行分析

****0x02arkime 搭建****

arkime 官网：https://arkime.com/

这里我用的 centos 系统，所以直接下载 centos 的 rpm 文件

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4MGrjBia92OttlnUa3ZnMicg1aWJywDUD36WOx52nNFZKkQzpIvFaVcKw/640?wx_fmt=png)

下载 arkime 的 rpm 安装包  

```
wget https://s3.amazonaws.com/files.molo.ch/builds/centos-7/arkime-3.4.2-1.x86_64.rpm
```

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4H1mpwjibGXLWuwLEw4bxeU4lulktJIfXiaVv3PUQ0YiaJJb9XKkjxGFhA/640?wx_fmt=png)

安装依赖

```
yum -y install perl-libwww-perl perl-JSON libyaml-devel perl-LWP-Protocol-https
```

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep40tfP6JtzTIDqMxJq6Mn5HOSziaRp0LSxHoEX90SgyyIc7ReTpTD5bTw/640?wx_fmt=png)

安装 rpm 包
--------

```
rpm -ivh arkime-3.1.1-1.x86_64.rpm
```

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4lux8qh7eLydX0Vn96icxbIHoXSmhQebDTgia5wcTAEln7M10Qpn7tkrw/640?wx_fmt=png)

     不过需要注意的是，这只是安装了 arkime 自身的一些组件，尚缺少 elasticsearch，以及一些配置。而解决这一步的问题才是整个安装过程中比较复杂的部分。

   至于如何安装 elasticsearch，如何配置 arkime，在 / opt/arkime/bin/Configure 这个脚本中列得很清楚了，建议直接读懂这个脚本，其实有用得行不多，看明白以后就知道后面的安装大致都干了什么，出错了也好处理。

      最容易出错的地方（尤其是在离线安装时）是 ElasticSearch 的安装。

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4JicMmVTZPf4M75Z4G88cYuhAGFcQdEbS4YYPMu3mwAc7GJEdH6S26fg/640?wx_fmt=png)

    从官网上这里就可以看出，Arkime 和 ElastcSearch 的版本是有一个配对关系的（实际就算版本号对准了，类型没对准也会转不起来，离线安装时我在这里卡了好久），所以还是不要自己去官网直接下载 ES 了，下不对很麻烦。我们可以借助这个 Configure 脚本，在在线安装的同时帮助我们直接下载对应版本的 ES。

        打开 / opt/arkime/bin/Configure 脚本，找到如下安装 ES 的这一行，复制一行后改一下命令，

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4ia3AacLp5WUGRLMwbJBXdicqCX3QuFwtAL2DpCwFDHhdFADdQklAJEGg/640?wx_fmt=png)

   把 yum install 改成 wget，直接借用脚本中的 ES 下载链接，把对应版本的 ES 的 rpm 包给弄下来。

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep47NwJibCELat7nGd04iataSiaunLFvbVVOokBQWrLtRCN0aDNkubRRL3OA/640?wx_fmt=png)

  然后就可用用 Configure 进行 ES 的安装和 Arkime 的配置工作。

  然后执行 Configure，注意如下图的地方，第一个要填网卡接口名，第二个只能填 yes，第三个填一个你自己的口令密码，

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KahsHz0TUJufzV47qsyW0d0RH1K0IzhhicqMyahkVhE7SXicRZ2LRibVwojD7K99ldeGmhczhxzPl8w/640?wx_fmt=png)

然后就是下载和安装的时候

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KahsHz0TUJufzV47qsyW0diaO8lhlPnd31c4kTNk1ApcMW4Nicz2fNRgbk7yZyCW2ljjKM8sslOI5w/640?wx_fmt=png)

最后是 GEO 信息的下载，这里要选 no

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KahsHz0TUJufzV47qsyW0dsGHtjeRxlicjXdrsuTlMH2qePicibicQfrOokJLELsicYd1iaQ6GX80QWvRw/640?wx_fmt=png)

 如果一切正常，主要是 ES 能够正确下载并安装的话，就会报告完毕，然后再 GEO 那个选项输入 no 后，基本就完事了，然后需要我们参考屏幕上返回的指示完成剩下的 4、5、6、7、8、9 步，这也很简单，复制对应的命令粘贴执行就好。 

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KahsHz0TUJufzV47qsyW0dJRYicPyeXKxYKhARIpbtHKkcSjrX2rB687jFajzCbXaIliaC3Jb6pj1w/640?wx_fmt=png)

第四步启动 elasticsearch

```
systemctl start elasticsearch.service
```

如果报错  

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4eaN8ODJrOvlib0t3v4GfFj3zGEy0ZKF3nAxVpQy3X1HFMpv23R1frFw/640?wx_fmt=png)

则查看目录有没

有 elasticsearch 的 rpm 文件

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4elERpYMSAZUmMjJjTxofFjtLtoDpMR7dHO4zm51uyUA4AeLM3Oq3wQ/640?wx_fmt=png)

如果没有则下载，找的上面报错信息  

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4QLSxOXA42ZicibstrMqA0xsDNowHiapYzwNvkTTSrib6ibapBlAhAwbicDtA/640?wx_fmt=png)

下载且安装再次启动

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4WJ2vqkcW3fPe5HP0mmFpec4O8iagVF7lFXIKq71jW72zSKqHMoywGQQ/640?wx_fmt=png)

查看需要看看 ES 是否正常，执行

```
curl http://127.0.0.1:9200
```

查看是否有返回，如果没以下结果则检查以上步骤  

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4HnEw8T4mqLLPOqZJmkkvCShxeYZEH2gsVibvTiaFtw6xylCicM9NWJrgQ/640?wx_fmt=png)

 如果结果正确，可以执行第 5 步，初始化 ES 数据库，注意替换 ESHOST 为 localhost；

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4dibHibmkB0aejOYRYiaArHrcekh02r9kLmQgGWkzVpEqqmVJdaxIicdNog/640?wx_fmt=png)

第 6 步，增加用户名和密码（这个会用来登录 Arkime 界面）

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4f5UgiaH5dtfoKSmXSThOoVJx6fesZK1cnx6hPA7pV5721hGHyasduww/640?wx_fmt=png)

第 7 步，启动

```
systemctl start arkimecapture.service
 systemctl start arkimeviewer.service
```

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4nPShhWwLAEkJOQ9iaTylY8Xe0wFWVhA6ibrg4rGKsDBeYZcuXuSeXq4A/640?wx_fmt=png)

第 8 步是查看日志文件

第九步登录

第七步启动了，但由于 GEO 还没配置号，capture 服务应该无法正确启动，在 arkime 中还看不到实际采集的数据。

        实际上，只要读懂了前面的 Configure 脚本，就能跟踪到此处是执行 arkime_update_geo.sh，主要目的就是下载 2 个文件。从 arkime_update_geo.sh 直接拿出两个地址进行 wget。

       打开 / opt/arkime/etc 目录，下载下面两个地址的文件到该目录下：

  1. https://www.iana.org/assignments/ipv4-address-space/ipv4-address-space.csv

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4fvT5olEFzMjLdTx15fiak376LHfniaiaYdLBIZSt4IcVqMj0jRl3DlRIw/640?wx_fmt=png)  

2.https://raw.githubusercontent.com/wireshark/wireshark/master/manuf

  其中，第二个地址下载下来的文件应该改名为 oui.txt。另外，第二个地址比较魔幻，早上连不上晚上能连上，固网能连上移动网连不上，不知是不是 DNS 问题，所以如果不太好用的话，就再试试下面这个地址，没准更好使一点：

        https://gitlab.com/wireshark/wireshark/-/raw/master/manuf

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4YdIYJ0ww8LyNhKpickWbvodG6dtkXeaxibxbCkGAFumwyAWrA5suOhAA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4ds8Qia9R6a20DrPSqBKH2fBfy7hWlMxAIIvGKgibOzkgCGzicgZlpnwyg/640?wx_fmt=png)

     下载及更名完成后，重启一下 capture 服务

   再登陆服务器

  等一会应该就能看到数据上来了，比如再 session 界面…… 实在等得着急的话，ping 一下主机看看，应该也就可以了

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep49JvpLr0n0qCeVgwQ07jkvvmRPzPfEpHapsVd6YZsQ8zB8Vp5lPFH3w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep45dZGguY5bfnYACpYsumEBWIIq1JvYZia67qqlWayRpSnY1C7j5hdeGQ/640?wx_fmt=png)  

********0x03 安装******** suricata

安装

```
yum install suricata
```

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep48bhIibcdxibOiaFlA5LAkxcLr4BPE7kXmnkccppJh37feByjuvHibqcn4w/640?wx_fmt=png)

更新规则

```
 suricata-update
```

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4coSSHcicqicQWEMoKczS1F6xvP3FUFCJYnEBjpM2tQtplnNCJicYH1J8A/640?wx_fmt=png)

测试是否安装好

```
suricata
```

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4oicySzib4MGBxYzsESaiaxBicuf757aFuwVaxbfcfRqmYfGPWCsveX7q7Q/640?wx_fmt=png)

************0x04************Arkime 与 Suricata 联动配置与使用

配 suricata 插件

```
cd /opt/arkime/etc/
vim config.ini
```

搜索关键词 pluginsDir，在面新增如下内容

```
# Add suricata.so to your plugins line, or add a new plugins line

plugins=suricata.so

# suricataAlertFile should be the full path to your alert.json or eve.json file

suricataAlertFile=/var/log/suricata/eve.json
suricataExpireMinutes=60
```

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4I96luzmViaZJkbGvcZWTcFjTfkOMeRciabbNn8JBliabazF7d1J99oDZw/640?wx_fmt=png)

配置 arkime 读取 suricata 数据
------------------------

### 修改 eve.json 权限

```
 chmod o+r /var/log/suricata/eve.json
```

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep4u6omb3BEf1P2pRsibvptsh5Vydh2lyBEcIBGL6uBRmKmMxWiaQoNE17Q/640?wx_fmt=png)

如果提示没此文件运行以下 suricata 就有这个文件了

### 修改 dorpUser

```
 cd /opt/arkime/etc/
 vim config.ini
```

搜索关键词 dropUser，修改为 root，![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KPvsoSHyBBEJb4pqg9cep494LSfQG0aVh3yrM7rUMzf8p8yMwp0Kul2e6NfibePibu1zIk0CDcX8BA/640?wx_fmt=png)

****************0x05 测试****************

测试环境

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KahsHz0TUJufzV47qsyW0dSu7sF3pbpbWxVh83YvqO5UoXnTQYCDRtamP1aTiaaZ5TnnGLC9vmHCA/640?wx_fmt=png)

攻击者利用永恒之蓝攻击靶机

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KahsHz0TUJufzV47qsyW0dzJUPJGjibzoibx4uiaMiaWDlN1dITEah5ic8ribpXYBHwwvbYAqW9Kd8gT8w/640?wx_fmt=png)

IPS/IDS 成功检测到异常流量  

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8KahsHz0TUJufzV47qsyW0dS1Q3gmPVPbDSeZiaSX0cHRoz15SicpQ2akJ0zmxMJ62RNT5258xYicsZQ/640?wx_fmt=png)

后续可将此流量下载，进行分分析是否误报

********************0x06 总结********************

可将此系统部署到内网中合适的位置就可以检测所有内网中的流量，

也可以研究以下 opnsense，貌似也挺好用的

************************************0x07 参考************************************

https://blog.csdn.net/lhyzws/article/details/124433680

https://blog.csdn.net/orright/article/details/120894886

https://blog.csdn.net/orright/article/details/120910452

本文最终解释权归本文作者所有！！！
=================

    本公众号发布的**靶场、文章项目中涉及的任何脚本工具**，仅用于**测试和学习研究，禁止用于商业用途****，**不能保证其合法性，准确性，完整性和有效性，请根据情况自行判断；

     本文章、项目内场所有资源文件，杜绝任何靶本公众号、自媒体进行形式的擅自转载、发布

    本公众号对任何脚本及工具问题概不负责，包括不限于由任何脚本错误导致的任何损失或损害及任何法律责任；

    直接使用本或公众发布的技术、靶场、文章项目中涉及的脚本工具，但在某些行为不符合任何国家 / 地区或相关地区的情况下进行传播时，引发的隐私或其他任何法律问题的后果概不负责；

    如果任何单位或个人认为项目或文章的内容可能侵犯其权利，则应及时通知并证明其身份，证明我们将在收到证明文件后删除相关内容；

    以任何方式查看或使用此项目的人或直接或间接使用项目的任何脚本的使用者都应仔细阅读此声明；

     本公众号保留更改或补充，免责随时声明的权利；

    **一旦您访问或使用访问本公众号任何项目，则视为您已接受此免责声明。**

 **您在本声明未发出之时，使用或者访问了本公众号任何项目 ，则视为已接受此声明，请仔细阅读。**

                                                                                        ** 此致**

 **由于、利用的信息而造成的任何或直接的此文传播后果，均由用户本人负责，作者不承担任何直接责任。**

**一切法律后果均由攻击者承担！！！**

**日站不规范，亲人两行泪！！！**

日站不规范，亲人两行泪！！！

日站不规范，亲人两行泪！！！

专注于信息安全方面分享，非营利性组织，不接任何商业广告

关注不迷，点赞！关注！转向！评论！！  

要投稿的请留言或者加微信，会第一时间回复，谢谢

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8LXzGow9VibbNMVo6HZcv2tXyEVHp3WgicIC7LMomYkvcRP4JcjK69MibibkGZlZfN3IAs8KqRiapekqqA/640?wx_fmt=png)