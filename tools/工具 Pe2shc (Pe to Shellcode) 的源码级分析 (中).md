> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ejhuSu_6NP6nG3gmFLo16Q)

    在上一篇中，我分析了 pe to shellcode 中的 pe2shc 源码，写完后我陷入了思考中，对它的执行原理我当时的解释始终无法释怀、无法放心，这两天抽出时间进行了验证，果然，证明我当时的解读和理解是错了，我理解当然地曲解了 Exe 的运行机理，使我长了见识，也不得不为这个工具的巧妙性点赞，连我这样的 “老师傅” 都“骗”过了。请看我的验证过程。

   **一、我的分析错误点**

   先来看下上篇文章中的我的分析图，看我错在哪里，

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLNpwzIrBvicctH3hTOThoyMugmqqcM5VhcVqGKrRcCcTtl7GlcbUZevRWSsrzuiaknK3r8YvPpib53Q/640?wx_fmt=png)

当时，作者给了这些 “//dec bp” 样的注释，并解读为 redir_code 的 16 进制 \ x4D 等的对应汇编代码，其实看到 “4D、5A” 这样的敏感字符，我第一反应就是 “这不是 Exe” 程序的 DOSHeader 吗，是 Exe 程序的标识性字符。所以也就认为作者是在误导读者、误导我们，就改成了这样，

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLNpwzIrBvicctH3hTOThoyMC9uZqIYGZM1IWPhcwTgxEj7fJuDCbicCd3D2g3LicEHlEYF5PmzPoA8w/640?wx_fmt=png)

看上图，“\x4D\x5A”被我改成了注释 “//Magic number” 等 DOSHeader 的 Exe 头格式，

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLNpwzIrBvicctH3hTOThoyMwpWIvlnqiaJ7f1WWjqs9rbGDj7XiaIus48xGErB3q4tdYAFcpQco3paQ/640?wx_fmt=png)

同时，还比较了头的位置，以及图二中 “size_t offset = siezeof(redir_code) - 8; ”，就认为了将 Shellcode 的起始位置正好填写在了“Initial IP Value” 位置，从而 Exe 在启动时会先去加载尾部的 shellcode，执行完后再跳转回原程序执时。

当时没有细想，后来细品时才越发觉得没道理。  

    **二、高明所在**

    我被欺骗的基准点是在 “4D5A” 上，认为它就是 Exe 的格式头标识，就象 MBR 的标识为 “55AA” 一样。当然这个标识的认识是没错的，看到 “4D5A” 就可以认为是 Exe 程序，但这里作者不但欺骗了我，也欺骗了 Windows，同时也欺骗了 OD 等这样的调试工具，让它 “看” 到“4D5A”也认为是 Exe 程序，从而按 Exe 程序来调试执行，我刚开始时怎么都执行不了 shellcode，始终都是正常的程序体，让我百思不得其解。

    直到，我用 shellcode 调试时，才发现了端倪。这个 Pe2shc 转换工具真是高明啊，膜拜一下这个作者！

我们看作者在 redir_code 的注释部分，以 32 位为例，  

dec bp; 0x4D

pop edx; 0x5A

inc ebp; 0x45

push edx; 0x52

call 0; 0xE8,0x00,0x00,0x00,0x00

pop ebx; 0x5B

sub ebx,9; 0x48,0x83,0xEB,0x09

push ebx; 0x53

add ebx,[value]; 0x48,0x81,0xc3,[value]

call ebx; 0xFF,0xD3

ret; 0xC3

最后两句，是不是很像啊，

先 Call 后面的 shellcode，再 ret 跳回原来的程序开头。

那第一句，第二句是干什么用的？

原来只是欺骗作用，对应的代码为 “dec ebp ,pop edx”，没有什么实质性作用，所以第三、第四句将 ebp、edx 值又补回来了：“inc ebp、push edx”。

第五句，“call 0”，这句话和下一句 “pop ebx” 组合起来就是取当前的 IP 值 (再减去上面多 9 个字节, sub ebx,9)，为后面的 add ebx,[value] 的 shellcode 的位置作准备工作。

    **三、调试验证**

    我们来一步步的调试跟踪看看，就非常清楚了；  

    1、在这之前，我们先来看看 shellcode 的位置，这样调试时看到位置值就能反应过来了，

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpK4oDG3S2nEIqOiaSdwtDWcpO7kugwaTpF8zqmy5ibYp1UAyqucmPzBYGGMK74tLWVHE0aJTZDUrQtQ/640?wx_fmt=png)

shellcode 所在的位置 0003 B000,

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpK4oDG3S2nEIqOiaSdwtDWcp7xTI6zA8QHw4au3uWQvpQiaYHd2VTWpSbyqnubO79OsknZyebsru51Q/640?wx_fmt=png)

在 3B000 处是 shellcode，首几个字符是 “60、6A、30、58”，和 stub32.bin 这个 shellcode 对应上了，说明此处确实为 shellcode。

2、开始调试

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpK4oDG3S2nEIqOiaSdwtDWcpUJgyricIc9jZSubqQ4OmrBS9dhSMdULusE8bQYNXRAGiblA5kS00L6lg/640?wx_fmt=png)

没错，首几个字节一样，说明加载起来了。单步一下，

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpK4oDG3S2nEIqOiaSdwtDWcpuPWDRbs8jVSZhGdxtulCWQOlAuSE4dicZ3j7gtwqpu0kzl2d66LxUsQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpK4oDG3S2nEIqOiaSdwtDWcpTEs634nMxTtBibqQbsHJIDKHx0sWiaXq7KhK0PDU8ibdylicHBrmibkXApg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpK4oDG3S2nEIqOiaSdwtDWcpC6PlqqNl0mh6pgZhGqxKynJ7gEUwWXHMToC812cMRgExbibDxuD3uvw/640?wx_fmt=png)

每个单步时都是 “step:” 这样的顺序码，  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpK4oDG3S2nEIqOiaSdwtDWcp7EPhLPSRUkPTguCBICRN9iaHOpTqHqKhFnjMeiauY3Vq9oKbn1PFzYgQ/640?wx_fmt=png)

看这个连图，“call 0x401009”，这个 0x401009 是哪里啊？正好是下一步的 Ip，所以通过 “pop ebx” 了下来，所以 “ebx=0x401009”；这时再通过“sub ebx,0x9” 得到 ebx=0x401000，恰好指向程序的首地址，就是程序被调试工具加载进来的地址。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpK4oDG3S2nEIqOiaSdwtDWcpOekmHEXLbodPn5egItibibAtudwE1Z5jxwjQ0pfhVAdN9fxUzSmJiba0w/640?wx_fmt=png)

这时 “add ebx,0x3b000”，在加载的基址上加上 shellcode 的相对位置，从而得到此时的程序中 shellcode 的实际位置 ebx=0x43c000；

下一句 “call ebx”，开始调用 shellcode，将控制权交给 shellcode；0x43c000 处的代码“60 6A 30 58” 正是 shellcode 的首几个字节。

在 “call ebx” 完成后，后面的 “ret” 弹出前面的“push ebx”，push ebx 中的 ebx=0x401000 程序的开头执行。这猜想后面的 shellcode 肯定会对此处进行重定位，让 shellcode 交还控制权时能跳到正常的程序体中。

    以上的分析，告一段落了，算是对我的错误进行了分析补正，这是一个难得的富贵经验，弥足珍贵。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/2hnvgPYNzpIBnjTKEFUOtkT0nD3UVeqnep7aQM5PiaFFRXNvMjXWeHHxZavLUqqfm8QVxrxlb15WCibYf0TPyItA/640?wx_fmt=jpeg)