> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/u-XnCEwxHxnFOsqFgQzz1g)

     BOF 这个东西无论是使用效果还是目前的生态，都非常的好，唯一不方便的就是开发起来不得劲，主要有编写、调试这两个方面，其实主要就是编写起来费事，需要确保用到的 Win32 API 都定义好，并且十分冗长。

    所以为了写起来方便点，之前参考 

https://github.com/securifybv/Visual-Studio-BOF-template

这个项目以及把 TrustedSec 定义的很多常用 Win32API 声明

https://github.com/trustedsec/CS-Situational-Awareness-BOF/blob/master/src/common/bofdefs.h

把他俩结合起来发布了一个 Visual Studio 的 BOF 模板：

https://github.com/evilashz/Visual-Studio-BOF-template/tree/oldversion

但确实还是需要定义很多冗长的声明。

### DFR

    前段时间看到 CS 官方这篇文章：https://www.cobaltstrike.com/blog/simplifying-bof-development，解决了这问题，今天找时间将里面提到的解决方法再次结合到 Visual-Studio-BOF-template 里面。（没有 Kit 的大 JB 小子，呜呜呜）

他们用预处理器宏定义来解决了冗长的声明

```
#define DFR_LOCAL(module, function) \
DECLSPEC_IMPORT decltype(function) module##$##function; \
decltype(module##$##function) *##function = module##$##function; 解释一下


```

1.  `DECLSPEC_IMPORT decltype(function) module##$##function;`
    

*   `DECLSPEC_IMPORT` 是一个常见的宏，用于声明一个函数或变量是在另一个模块中定义的，这通常用于 Windows 的 DLL 导入。在这里，它声明了一个名为 `module$function` 的外部函数，其类型为 `function` 的类型（用 `decltype` 获取）。
    

3.  `decltype(module##$##function) *function = module##$##function;`
    

*   这行代码首先定义了一个指针变量 `*function`，其类型为 `module$function` 的类型。然后将这个指针变量初始化为 `module$function` 的地址。
    

    大体来说现在可以比较方便的使用 c++ 来编写 BOF、并且可以调试、Beacon API 我只实现了一个 BeaconPrintf，剩下的可以自己到 beacon.cpp 写一下实现，另外调试时候的参数打包提取我没有实现。

    使用的时候只需要导入这个模板（导入方式看之前的文章：[使用 Visual Studio 开发 CS 的 BOF](http://mp.weixin.qq.com/s?__biz=MzI5NzU0MTc5Mg==&mid=2247484673&idx=1&sn=d1628ed1f77c638ba414185bfeabf8ee&chksm=ecb2cccedbc545d89bd098632be7fb23c273e585a4f2167089b39d483c42deac13b6078ba3b5&scene=21#wechat_redirect)），将需要的 API 这样进行导入即可。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hCicTN92QQAcLPnMc094wuicqeXSWZKqda4RXm72X00HibED06NibzMc0wIN3InOhe5FoHWibbDniaBHPACkgUTYCdQA/640?wx_fmt=png)

调试的时候这么切换即可：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hCicTN92QQAcLPnMc094wuicqeXSWZKqdaJ2zderxyJJJZelic6GpbNkCDd7ZsrFl3ehicRgN7P1Hr4qIicpgrRn5hw/640?wx_fmt=png)

去这找改完的模板：

https://github.com/evilashz/Visual-Studio-BOF-template/tree/main

### 彩蛋

BOF + VEH = ？

![](https://mmbiz.qpic.cn/sz_mmbiz_png/hCicTN92QQAcLPnMc094wuicqeXSWZKqda7fspYaiaicpUU8FUfxLhocP9lia9UovBG718IPPhbdRL05rEnJTkPWnDw/640?wx_fmt=png)

### 最后

星球 3 日后根据多方位因素价格上调 10 元，到￥229，望周知。

![](https://mmbiz.qpic.cn/mmbiz_png/hCicTN92QQAdaicTpyfnN9zyCkbVIZuWhvUibeMP0qkrEODzgpgLfROkknw97mF5gBugfib5z8liaBjwpaDkyUMAUvw/640?wx_fmt=png)