> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/HO88pP26GALeeWagnP79TQ)

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSMk8yib0WShIRBWBBNIkDOb80On20icwscO9uNVypx1QA5OYEnuGeVnwgCs3rE1qX6VKBsYPQB6KRA/640?wx_fmt=png)

点击上方 “蓝字”，关注更多精彩

0x00 前言
-------

这里所说的域信息采集导出不是我们在渗透域之前的【信息收集】，而是我们初步拿到了一些目标后，想要通过一种直观方便的方式利用内网信息关系扩大攻击面。说白了就是根据已有目标去了解整个域环境。

0x01 Bloodhound 介绍
------------------

1、一款**开源**域渗透工具，能轻松准确地识别出内网域的攻击方式。

2、使用可视化图形显示域环境中的关系。攻击者可以使用 BloodHound 识别高度复杂的攻击路径，防御者也可以使用 BloodHound 来识别和防御那些相同的攻击路径。**所以蓝队和红队都可以使用 BloodHound 轻松深入域环境中的权限关系。**

3、BloodHound 通过在域内导出相关信息，在将数据收集后，将其导入 Neo4j 数据库中，进行展示分析。因此在安装 BloodHound 时，需要安装 Neo4j 数据库。

4、bloodhound 更适用于大型域环境，如存在父域、辅域、子域，甚至其它域的环境。

0x02 Bloodhound 安装
------------------

因为`Neo4j`数据库需要`Java`支持，因此安装 `BloodHound` 前需要先安装 `Java`，这里以 Windows 系统下的安装为例。

### Java_JDK11

JDK 需要下载 JDK11，下载地址：https://www.oracle.com/java/technologies/javase-downloads.html，下载之后，直接安装即可不需要配置环境变量。

### Neo4j

Neo4j 直接下载最新版本，下载地址：https://neo4j.com/download-center/#community

下载最新版本之后解压下载文件，打开 bin 目录，执行命令`neo4j.bat console`，之后打开浏览器访问 http://localhost:7474 登陆后台

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXBN60Dia8n1LPq0g2IdC0KMPYqTbP9JB6PibRnqpdCglpUcXFmhwYb7tQ/640?wx_fmt=png)

不过需要注意的是 windows 默认的 IE 浏览器无法访问到`localhost:7474`，用谷歌浏览器就可以，输入默认账号密码`neo4j / neo4j`登录即可。

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXIzY5U8iacKuopHdZNOAzr5gibvl4HZj90m1xTEby3cLgYrGHFRgGibk4Q/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXkQNMGdIhOpPpZfqnQibicuxmv4g0vo2eDxmibKMdZH6VCHj8QiboPeUia3g/640?wx_fmt=png)

更改密码，我这里改成了 123456

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXAHKJceI34DelFLmouiaqQ19gUADDl9KA2kyicxb94A4J3jNz84MN8F9A/640?wx_fmt=png)

### bloodhound 安装

https://github.com/BloodHoundAD/BloodHound/releases/tag/4.2.0

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXgPq15GU66nNfPPAHyKYtadydkCns8VVVRIy7Snfic5EImRVVaZrlDhQ/640?wx_fmt=png)

github 下载直接解压使用，登录直接选择

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXucic96gXtKlPedFIs71bGIqOjlzmJdjQsmRNLaibHhRFGkLgel7gpWMQ/640?wx_fmt=png)

再次登录 bloodhound，成功。

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXQ5UbldYMABCEmz2NZ2aY07Ezibs5kjTdSvOIAy1sFctZSFFABorKScA/640?wx_fmt=png)

0x03 域信息采集导出
------------

需要注意一点的是，bloodhound 仅仅是安装完毕了，最重要的域环境信息怎么获得？

其实有很多工具与方式来连接 LDAP 进行查询信息，比如：`adfind.exe`、`ADExplorer.exe`、`ldapsearch`等等。

### 1、ADExplorer 导出

#### 域外机器

1、利用有效账号 (任意域用户账号以及明文密码即可) 连接`ldap`。然后点击`File——>Create Snapshot`

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXgwnf7OkKFJoDNXd4HZVjMxpx0SyepVo99k9aMFhRmorqqRnxXTS7Yg/640?wx_fmt=png)

2、添加点描述并选择一个路径导出`.dat`文件

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXBFbBq79gric2I8ktiayhknrSRJH3qFlF0t8BzkduoDP1FF3Mk3HaR5nw/640?wx_fmt=png)

3、导出的`*.dat`文件也可以再次导入进去

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXQTMrN6TdLvYbAP0QfaiaicKicMcCBce821CA16sqNoEy22v9DtnJzjf8g/640?wx_fmt=png)

我这里导入了三次，当然也可以在`File----remove`去掉不需要的信息。

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXHguiboCqVJtJPAkoxzIliaLB0Gc2LSwq4zDOIUSCcM41lAsWY6e4hKnA/640?wx_fmt=png)

#### 域内机器

域内机器可以直接运行此软件来导出，或者打开后用任意域用户账号登录都行。

```
ADExplorer.exe -snapshot "" result.dat /accepteula


```

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXUicTo8utxZ6FpXXXJXwZZ6hTtuV3d8hNMa9UcZUXYWA7qRfcvmhaNkg/640?wx_fmt=png)

#### 使用 ADExplorerSnapshot.py 解析

然后使用 ADExplorerSnapshot.py 将 dat 文件解析为 BloodHound 可解析的格式。

项目地址：https://github.com/c3c/ADExplorerSnapshot.py

```
git clone https://github.com/c3c/ADExplorerSnapshot.py.git
cd ADExplorerSnapshot.py
pip3 install --user .


```

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXibF3eh8lxsZJ0fGkhicjj5J4LJtcDjkkz8vYer7YVMCvc4CUYRr28GKw/640?wx_fmt=png)

将刚才导出的`test.dat`用脚本运行一下。

```
python3 ADExplorerSnapshot.py test.dat -o test   #test为创建的鑫文件夹


```

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXbzRf30gXtQXOFG0wGQVhjK7a7vVcibRLxJCdfCibzFful3rpibec993Rg/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaX7EA5daavRS6w8YkBqXPjA1SwYMKNPDJbntInnI7OgiajlZjUSMyJIAw/640?wx_fmt=png)

#### 导入到 bloodhound

将上述转换出来的`json`文件直接拖入 bloodhound 里面

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaX65KL4hR4MKozGgIEqgAIGOgTyibcndHM1iaslyUibM3TD2QMpf1XycASw/640?wx_fmt=png)

随后就可以查看域内信息了

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaX62wXMEXT1dib6V0Sz3WGrUT6qBkMKfTTy7pPjhb80MicT7NylO0iaB2cA/640?wx_fmt=png)

### 2、LDAPDomainDump 导出

https://github.com/dirkjanm/ldapdomaindump

> LDAPDomainDump 是一款通过 LDAP 协议实现的活动目录信息导出工具。在活动目录域中，任何一个有效的域用户均可以通过 LDAP 协议来查询域内大量的信息。如通过 adexplorer、adfind 等工具连接查询。但是这类工具只能实时连接查询，无法将所有数据导出。而 ldapdomaindump 这款工具可以通过 LDAP 收集解析导出数据，并将其输出为 HTML、CSV、TSV 等格式。

#### 安装

```
#安装相关库文件
pip3 install -r requirements.txt
#安装脚本
python3 setup.py install


```

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXleadUt1TyNxTG8IRTj1KS71UkmVzm3aRTnoAJ4aP0S057SKlUcSTyA/640?wx_fmt=png)

#### 使用

```
#格式
python3 ldapdomaindump.py -u <域用户> -p <域用户密码> <域控ip> --no-json --no-grep
#举例
python3 ldapdomaindump.py -u jntm.com\win10 -p 000.com 192.168.111.10 --no-json --no-grep


```

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXSIM7cHhIN1X9X4zOPHsVCDEQnxfibibd2Y6ibGkVNVySDXeNn3DmdGEGA/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaX6YcfPDicVPOIWLl6jH4pQoxCoJdn7s0ICouVRpHFstJWEzicibriaktWVg/640?wx_fmt=png)

打开后我们可以很直观的看到相应的域内用户以及计算机账号的相关信息

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXORVhqAwPYCoMetD8dybheyhxuyzg3o8ViaXpxJxPb2CeFFnNly9s2LA/640?wx_fmt=png)

还可以点击相关链接并查看详细信息

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaX1Qy23YBGhjFmMCdq7DQpLclR2mHAoJWpR5bM2OHy2Qe7icJzJAcA00g/640?wx_fmt=png)

### 3、Powershell 采集脚本

Bloodhound 数据的采集可以使用 ps1 脚本或者使用 exe 程序收集，需要使用对应版本的数据采集工具。

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXYuXnkvwYSibdLf5zxZETibgmUiaRBls0YzWdwKjpTdFNC0so05Phqib8VQ/640?wx_fmt=png)

```
# 二进制采集工具命令：
SharpHound.exe -c all
# powershell采集工具命令：
powershell -exec bypass -command "Import-Module ./SharpHound.ps1; Invoke-BloodHound -c all"


```

例如使用 SharpHound.exe 进行数据的采集，将 SharpHound.exe 拷贝到目标上，执行数据采集命令即可。采集成功后，会生成一个基于时间命名的 zip 文件，此文件保存了采集到的域环境数据信息。

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXM1mfKREyLYkjwBic87FhNzmyicosFOI3ozZjuAFKD9b6oCsia7CYYmkIA/640?wx_fmt=png)

#### 导入到 Bloodhound

点击下图右边的【上传数据】即可导入

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaX1PZbuguicpqNFEyMThpJdVfz2ribyaxfOpPv3qI6wyq27xl9vZqWMwtw/640?wx_fmt=png)

0x04 Bloodhound 基本使用
--------------------

### Database Info

可以查看当前数据库的基本信息，包括用户、计算机、组和关系（或边）的数量。

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXRMgToZkLTQ3MDYxWzBwBWWqnlbsLBbiboGMhI0ONYz9MsteqMdSomqg/640?wx_fmt=png)

### Node Info

Node Indo（节点信息），当单击某个节点时，可以显示对应节点的相关信息。

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXNsAufBjEEjiaOrKva0EYjNDI2ba5nUJ3QEQpys0uCJHZPsW7FHfoUvg/640?wx_fmt=png)

### Analysis

这个模块可以看到预定义的常用查询条件，也是最常用的一些条件。

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXqqy1L9ic1iacBBAqD3Yf388rVCguMAy0J1JfhNKUzoJfWtJSTdEoMItA/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSUZZJQ7LQoVUeppibv17ibaXiboGCqcDdQuuFeunnPybfU9Cn1iaRxSIkqJGqn2kIlNibpVgf5pibQ9YfA/640?wx_fmt=png)

操作比较简单，对于这种工具来说，我们了解个大概，到了实战再去仔细研究就可以了。

0x06 references
---------------

http://www.luckyzmj.cn/posts/7ebaa71c.html

https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSMk8yib0WShIRBWBBNIkDObIqYztlZ9BvqC6ibSmibichRicejhuo0Dpu4PfzmEk5jJDoMjr1ibrJIQfnw/640?wx_fmt=png)

**往期推荐**

[实战经验 | 解决 ssh 链接 VPS 掉线问题](http://mp.weixin.qq.com/s?__biz=MzIyMzcwMTg1MA==&mid=2247485403&idx=1&sn=a385f0e89404eb584492cfc857f05bb2&chksm=e81b79eedf6cf0f8d1ecbaed79a404d9c60ca645f397a8115d1567b29dd68ed97219b633035e&scene=21#wechat_redirect)

[内网渗透 | 文件共享服务与 ipc 横向详解](http://mp.weixin.qq.com/s?__biz=MzIyMzcwMTg1MA==&mid=2247485581&idx=1&sn=970b85beee07b240db18fbdad9df9f60&chksm=e81b76b8df6cffae1f781539f99f9b35fb9fc52939595c81106ca268506230a984ccc749eb05&scene=21#wechat_redirect)

[内网渗透 | JS 脚本下载 payload 与代码分析](http://mp.weixin.qq.com/s?__biz=MzIyMzcwMTg1MA==&mid=2247485429&idx=1&sn=1dc4cc394cf8ca51935cbe1a3c3bc3bc&chksm=e81b79c0df6cf0d688a11fcf525ba00f40ff65d49406bb6b5749ff4144533568d10d0024a7e0&scene=21#wechat_redirect)

[内网渗透 | 内网隐藏技术之我见](http://mp.weixin.qq.com/s?__biz=MzIyMzcwMTg1MA==&mid=2247484050&idx=1&sn=3cd0968ff2259c816cfda439a19b7024&chksm=e81b7ca7df6cf5b1e919fd8a6f74a83dd28e35fb2fc7937371eacbdab4e79660045fb054f30f&scene=21#wechat_redirect)

[每日技巧 05 | VM16 安装 macOS](http://mp.weixin.qq.com/s?__biz=MzIyMzcwMTg1MA==&mid=2247484225&idx=2&sn=898b643ae3478c4c12ea8930fc1d1b7a&chksm=e81b7d74df6cf4628aee43371b11ef9e1f107e1a115600f6601a9847edf0d79536dd84b77a79&scene=21#wechat_redirect)  

[Clash RCE 漏洞复现与高级利用（配合社工）](http://mp.weixin.qq.com/s?__biz=MzIyMzcwMTg1MA==&mid=2247483725&idx=1&sn=ab6144af79373a5a1965af4ab2db5f89&chksm=e81b7f78df6cf66eae9e994fa332f8b14d34d8f6eec736d50465e88741b6d7f3accb016b4898&scene=21#wechat_redirect)

[CVE-2021-4034 Linux Polkit 本地提权漏洞](http://mp.weixin.qq.com/s?__biz=MzIyMzcwMTg1MA==&mid=2247484145&idx=1&sn=431e26461495aaa295110a2c34769936&chksm=e81b7cc4df6cf5d293e6a6f360e7751bee68f9a169ae1c57718862a87d37c225b08538291ff2&scene=21#wechat_redirect)

[CVE-2021-31760 Webmin CSRF 致使 RCE](http://mp.weixin.qq.com/s?__biz=MzIyMzcwMTg1MA==&mid=2247484086&idx=1&sn=8f91e2facd89cfb0df53a35e72d74ee4&chksm=e81b7c83df6cf59524e112da61ff70a0674517b972d7fbfe212a12043533e35aa63fa0d8bd32&scene=21#wechat_redirect)

[CVE-2022-22965 Spring core RCE 漏洞](http://mp.weixin.qq.com/s?__biz=MzIyMzcwMTg1MA==&mid=2247485374&idx=1&sn=d6df2ef255521a90f9d22f0cb7e3cf7f&chksm=e81b798bdf6cf09d8adee7a91d916c66cedb0fa62a985ee3e070cfce25d333d84f7e345430af&scene=21#wechat_redirect)

 [CVE-2020-1472 ZeroLogon 漏洞复现利用 (Netlogon 域提权)](http://mp.weixin.qq.com/s?__biz=MzIyMzcwMTg1MA==&mid=2247484893&idx=1&sn=73717ba393b6078901528ac30f9a72ec&chksm=e81b7be8df6cf2fe37cbf6c2e4a41c76562ff78e1e1f3458e9713276fda028225e2e7c876627&scene=21#wechat_redirect)

**郑重声明****：**该公众号大部分文章来自作者日常工作与学习笔记，也有少数文章是经过原作者授权转载而来，未经授权，严禁转载。如需要，请公众号私信联系作者。

**请勿利用文章内的相关技术从事非法测试，如因此产生的一切不良后果与原作者以及本公众号无关。**  

![](https://mmbiz.qpic.cn/mmbiz_png/NKFP8MAliaHSMk8yib0WShIRBWBBNIkDObqLqYIdDgQCNwUfxjooA4GdVuer5RIyOyXia73lqZFycRZ9Yjh7wFwuA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/NKFP8MAliaHSMk8yib0WShIRBWBBNIkDObYTyIog69KicCib6671RDhJMaZ6G4rj7CnS6mwXiblm4BCU7HUUJicKeLPg/640?wx_fmt=jpeg)

**扫码关注**

人若无名便可潜心练剑  

专注渗透测试、工具开发