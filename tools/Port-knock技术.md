> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/lzlRImXPJ2J0E6zdo1ZqsQ)

作用：通过发送特定的序列号让服务器执行相应的操作

```
https://github.com/jvinet/knock
```

0x01安装方式
--------

```
yum -y install knockd   
apt -get install knockd
```

配置文件存放在/etc/knockd.conf中

![图片](https://mmbiz.qpic.cn/mmbiz_png/VXhXrEAacWtt5SJgGiaTxgWGqlKHhEBfQNQSWJ2BMR8BU4g6yicuNPn36ibPvBTB6BrPibApdCu2TTJ43hXBUaohmw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

看配置文件可以看出实际上是调用的iptables进行规则的增加和删除，所以首先要有一个拒绝ssh的iptables规则

```
iptables -A INPUT -p tcp --dport 22 -j REJECT
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/VXhXrEAacWtt5SJgGiaTxgWGqlKHhEBfQiclUF5n0Xlgc98PsdXlcJRdAYrbKLjKR75srYA6ezduriaI1Lg8JwYDQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

开启knockd服务

```
service knockd start
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/VXhXrEAacWtt5SJgGiaTxgWGqlKHhEBfQc6AlCyyHO1OdtCJ8qQDibY3E7cxxle7CUmbCKKgy5Kyd4pFic0kAWIKQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

发包测试

```
    knock -v 192.168.204.135 7000 8000 9000 //开ssh  
    knock -v 192.168.204.135 9000 8000 7000 //关ssh
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/VXhXrEAacWtt5SJgGiaTxgWGqlKHhEBfQgT0DaBTHOnP3n45Hqiav2QyTtQx5toPA1Qqtg3OazRKZmF0Xps9BicDw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/VXhXrEAacWtt5SJgGiaTxgWGqlKHhEBfQbpQByiaiciafPicpLlo0v8Rbibpia98jUqV9uIx0ghrS2KSIibt6PXIeroWeg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/VXhXrEAacWtt5SJgGiaTxgWGqlKHhEBfQ1HCNabCYHKUewyWqWiaaicMmUJpDhJkV4X7vy9f10eaQicoIBqicSxrgBg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/VXhXrEAacWtt5SJgGiaTxgWGqlKHhEBfQRmzZoXiamVXAVa9GEgiaOhIByr1DCKoVdElKHNlnFUdO12M9RXIiaYic6g/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

0x02 数据包分析
----------

![图片](https://mmbiz.qpic.cn/mmbiz_png/VXhXrEAacWtt5SJgGiaTxgWGqlKHhEBfQA7QAdibL5ZCuFLMhjicwPicslEUQSb7a6lERPiau8HJfaExtNIKAjX1KRA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/VXhXrEAacWtt5SJgGiaTxgWGqlKHhEBfQWy5ROxLKSwMHM99YLVGZ5eR6gHZo5yoa3sVs3SGMhib68fCQzOuLqIg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

从数据包可以看出默认发出的数据是TCP且标志位为syn=1的数据，这种数据包也是在TCP建立握手的常见数据包格式。

既然数据包呈现是这样，也就是说实际上并不非得使用他给的客户端来进行握手，我们可以尝试使用nc或者telnet来打开端口

```
nc 192.168.204.135 7000 || nc 192.168.204.135 8000 || nc 192.168.204.135 9000
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/VXhXrEAacWtt5SJgGiaTxgWGqlKHhEBfQNAwgHVFHvVvXfvM3zGBlVahJHN40Tx11M33ZEIsIdkr8LNUgfyYAxw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/VXhXrEAacWtt5SJgGiaTxgWGqlKHhEBfQJMNX5rFOCXWZUKIDUdaPey3owib0ic0yxLzFKguibx2WUSHkQlQxhQddQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

0x03进阶用法
--------

1.knockd不止可以添加防火墙规则

通过查看配置文件可以知道，本质上knockd提供的是一种命令执行效果的方式。只要发送了正确的数据包序列，该服务就会以**root**权限来执行命令。

将配置修改为如下所示

```
[options]  
    UseSyslog  
  
[whoami]  
    sequence    = 7000,8000,9000  
    seq_timeout = 5  
    command     = echo `whoami` >> /tmp/user.txt  
    tcpflags    = syn  
  
[ifconfig]  
    sequence    = 9000,8000,7000  
    seq_timeout = 5  
    command     = echo `ifconfig` >> /tmp/ifconfig.txt  
    tcpflags    = syn
```

再来使用knock客户端或者nc发送特定序列包查看效果

```
knock -v 192.168.204.135 7000 8000 9000  
knock -v 192.168.204.135 9000 8000 7000
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

2.修改序列标志位

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

我记得之前使用的时候修改完服务器的flag位对应的客户端也是可以指定flag位的，但是在实际查看参数的时候却没有发现有这种指定的参数，只能简单的指定TCP或者UDP

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

那为了实验效果，这里需要手动定制数据包发送，就先简单的设置一下服务器的配置

```
[options]  
	UseSyslog  
  
[whoami]  
	sequence    = 7000  
	seq_timeout = 5  
	command     = echo `whoami` >> /tmp/user.txt  
	tcpflags    = ack
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

简化成只需要向TCP7000端口发送一个fin包即可执行命令

使用scapy构造数据包

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

数据包分析：

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

效果：

发送前

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

发送后

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

按理说这种功能应该集成在客户端上的，我已经向作者提了issue 看看后面会不会增加参数吧。总之我们已经实现了修改flag标志位来执行相应操作，这只是一个概念验证，可以开发python脚本来具体实现。

总结
==

本文介绍了基本用法和一些进阶用法，可以利用此工具实现一些自动化功能而不仅仅是开关端口这样子。还可以通过修改默认端口和flag位更深层次隐藏端口或者做些操作。

knockd是一个很不错的端口防护软件，默认是发7000,8000,9000的TCP并且flag位是syn的顺序数据包进行开关，也可以用这个去撞一下公网的一些vps，包括在渗透中发现如果有文件包含漏洞或者文件读取漏洞的时候，可以考虑去读一下/etc/knockd.conf，说不定会有一些隐藏端口或服务。  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)