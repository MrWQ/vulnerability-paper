> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/iDXibqeQiA5fr1ad3TfSyA)

0x01 前言
-------

在服务器的日常维护和蓝队的日常监控中，经常需要对服务器出现的各种问题进行及时的预警推送。国外的服务器推荐使用`telebot`，而国内由于特殊的网络环境，则推荐使用`BARK`、`Chanify`等进行推送。

0x02 Telebot推送
--------------

首先需要一个telegram的账号(https://t.me/BotFather )。在对话框中输入`/newbot`，根据提示输入机器人的`name`和`username`，创建完成后会返回一个`token`，务必牢记。token类似如下：

```
5229xxxxxx:AAFAxxxxxxxxxxxxxxxxx1MJ4OY0  

```

接着在该机器人的对话框下输入任意信息，接着按照以下方式获取自己telegram的用户id

```
# curl方式。{token}替换为上面的token  
proxychains4 curl https://api.telegram.org/bot{token}/getUpdates  
  
# python方式。  
import requests  
resp = requests.get("https://api.telegram.org/bot{token}/getUpdates")  
print(resp.json())  

```

请求后会返回类似如下json内容

```
{"ok":true,"result":[{"update_id":324xxxx11,"message":{"message_id":3,"from":{"id":100xxxx661,"is_bot":false,"first_name":"xxxx","last_name":"xxxx","username":"xxxx","language_code":"zh-hans"},"chat":{"id":100xxxx661,"first_name":"xxxx","last_name":"xxxx","username":"xxxx","type":"private"},"date":1647093375,"text":"haha"}}]}%  

```

其中的`id`字段是我们所需要的，既我们自己的telegram账号的`chat_id`。

python的简单用法如下：

安装依赖 `pip install pyTelegramBotAPI`

```
import telebot  
bot = telebot.TeleBot(token="522xxxx:xxxxxxxxxOY0")  
bot.send_message(chat_id="xxxxxx",text="haha123")  

```

走代理跑

```
proxychains4 python3 telebot.py  

```

![图片](https://mmbiz.qpic.cn/mmbiz_png/ibxcwMR8shiabvprJVsH2n0ibWoz1cTjg1zxbwTEcep16XO5ccfjVn194URPlqiaGlG6EtJOKiasSO0HoKhyibibOmDcQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

可以看到，机器人已经给我们发来了指定的信息。当然除了发送文本信息，还可以发送图片、链接等，但这个不常用，就不做过多介绍了，各位师傅可以自己探索。

对于境外vps或者是网络环境允许的情况来说，`Telebot`是最好不过的预警推送方式。但是由于国内复杂的网络环境，这显然是不合理的。

因此这里尝试使用`BARK`这个免费开源的消息推送工具进行预警推送，虽然其功能较`Telebot`简陋一些，但起到基础的消息推送功能还是没有问题的。

0x03 BARK推送
-----------

先来看`BARK`的用法。`BARK`他会给每个账号提供一个私有ID，以GET方式请求 加上一定量参数即可。但同时带来的缺点就是由于get方式请求的url长度有限，因此不宜推送过长的内容。如对此有特殊要求，可使用如`Chanify`等其他app，但使用方式大同小异。

> 如果对于隐私要求高，可以在自己的私人服务器进行部署

### 3.1 推送方式

*   https://api.day.app/6cPxxxxxxxxxxxF4/推送内容
    
*   https://api.day.app/6cPxxxxxxxxxxxF4/推送标题/推送内容
    

### 3.2 参数

<table><thead><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><th style="border-top-width: 1px;border-color: rgb(204, 204, 204);background-color: rgb(240, 240, 240);min-width: 85px;text-align: center;">参数名</th><th style="border-top-width: 1px;border-color: rgb(204, 204, 204);background-color: rgb(240, 240, 240);min-width: 85px;text-align: center;">解释</th><th style="border-top-width: 1px;border-color: rgb(204, 204, 204);background-color: rgb(240, 240, 240);min-width: 85px;text-align: center;">值</th><th style="border-top-width: 1px;border-color: rgb(204, 204, 204);background-color: rgb(240, 240, 240);min-width: 85px;text-align: center;">其他</th></tr></thead><tbody style="border-width: 0px;border-style: initial;border-color: initial;"><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">sound</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">推送铃声</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">minuet、alarm等</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">无</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">isArchive</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">自动保存通知消息</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">1、0</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">设置为1则会自动保存，其他值则不会</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">icon</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">推送图标</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">[url]</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">需IOS15或以上</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">group</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">推送消息分组</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">[groupName]</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;"><img class="rich_pages wxw-img img_loading" data-ratio="0.5431111111111111" data-src="https://mmbiz.qpic.cn/mmbiz_jpg/ibxcwMR8shiabvprJVsH2n0ibWoz1cTjg1zqicu6YP5pytvQHGiaMtGlrQfpiaTFBWRTUVyA8mwt7OeppqJEo5kHWwJw/640?wx_fmt=jpeg" data-type="jpeg" data-w="1125" style="display: block; margin-right: auto; margin-left: auto; width: 314px !important; height: 171.451px !important;" _width="677px" src="data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==" crossorigin="anonymous" alt="图片"></td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">level</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">时效性通知</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">active、timeSensitive、passive</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">active：系统立即亮屏；timeSensitive：时效性通知，可在专注模式下显示通知；passive：仅将通知添加到通知列表，不会亮屏显示。</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">url</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">跳转</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">[url]</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">携带该参数时，点击推送会跳转到这个URL</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: white;"><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">copy</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">拷贝</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">[String]</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">携带该参数时，将只复制copy参数的值</td></tr><tr style="border-width: 1px 0px 0px;border-right-style: initial;border-bottom-style: initial;border-left-style: initial;border-right-color: initial;border-bottom-color: initial;border-left-color: initial;border-top-style: solid;border-top-color: rgb(204, 204, 204);background-color: rgb(248, 248, 248);"><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">badge</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">推送角标</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">[Num]</td><td style="border-color: rgb(204, 204, 204);min-width: 85px;text-align: center;">推送角标</td></tr></tbody></table>

### 3.3 测试

利用`Python`进行测试：

```
import requests  
url = "https://api.day.app/6cPxxxxxxxxxxxF4/"  #此处填入私有ID  
  
def sendMessage(title,text,icon=""):  
    requests.get(f'{url+title}/{text}?icon={icon}')  
  
sendMessage(title='Warning',text='Your server has been invaded',icon="https://th.bing.com/th/id/OIP.PnLgsfgLeK-s0mUrQOeonwAAAA?w=176&h=180&c=7&r=0&o=5&dpr=1.8&pid=1.7")  

```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

### 3.4 实战

写个shell脚本，让每次终端连接时都执行，放到`/etc/profile.d`中。这样当我们的服务器被意外连接时就能及时收到推送。

> 注意，由于url中不能存在空格，因此要把空格进行url编码
> 
> `echo $string | sed 's/ /%20/g'`

```
#!/bin/bash  
  
message="主机名:$(hostname) 时间:$(TZ=UTC-8 date) 登陆用户:$(whoami) 当前所有登陆用户:$(who) 其他信息:$(w|awk 'BEGIN{OFS=" "}{print $1,$8}')"  
  
curl "https://api.day.app/6cxxxxxxxxxF4/$(echo $message | sed 's/ /%20/g')?icon=https://th.bing.com/th/id/OIP.PnLgsfgLeK-s0mUrQOeonwAAAA?w=176&h=180&c=7&r=0&o=5&dpr=1.8&pid=1.7" &>/dev/null  

```

这样，当某一个用户被远程登录连接时我们的手机就会收到实时的预警推送。

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

0x04 拓展
-------

另外可以结合ssh蜜罐技术，或者是结合系统和中间件日志，对网页被篡改、被挂黑链、数据库篡改、主机出现其他用户等各种异常情况进行及时预警。

关注及时推送最新安全威胁资讯！
---------------

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

**推荐阅读**

  

[**干货 | CS绕过vultr特征检测修改算法**](http://mp.weixin.qq.com/s?__biz=MzkxNDAyNTY2NA==&mid=2247486980&idx=1&sn=6d65ae57f03bd32fddb37d7055e5ac8e&chksm=c175f3abf6027abdad06009b2fe964e79f2ca60701ae806b451c18845c656c12b9948670dcbc&scene=21#wechat_redirect)

  

[**漏洞复现** **| GitLab未授权RCE(CVE-2021-22205)**](http://mp.weixin.qq.com/s?__biz=MzkxNDAyNTY2NA==&mid=2247486834&idx=1&sn=a88a0afdbfbdf043e4210aa76dada233&chksm=c175f0ddf60279cb439452c995b0bf2371925babfc15f239b0f2c2f15d59205eb373f7947f78&scene=21#wechat_redirect)

  

**[漏洞复现 | Apache APISIX Dashboard-RCE工具](http://mp.weixin.qq.com/s?__biz=MzkxNDAyNTY2NA==&mid=2247487747&idx=1&sn=e928c89af89c51c6600e8496faf075f3&chksm=c175ecacf60265baed4b22ef817652fab396fd1e187d9e2ddbf96c046244b36dcc9c1750c823&scene=21#wechat_redirect)**

  

  

* * *

  

好文分享收藏赞一下最美点在看哦