> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ZiKYUN52nSSPFsjiRhnwbQ)

![图片](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iaaJcib7FH02wTKvoHALAMw4fuBhZCW25hNtiawibXa6jdibJO1LiaaYSDECImNTbFbhRx4BTAibjAv1wDBA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

扫码领资料

获黑客教程

免费&进群

![图片](https://mmbiz.qpic.cn/mmbiz_png/CBJYPapLzSFJNibV2baHRo8G34MZhFD1sjTz4LHLiaKG9208VTU6pdTIEpC9jlW6UVfhIb9rHorCvvMsdiaya4T6Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iaaJcib7FH02wTKvoHALAMw4fchVnBLMw4kTQ7B9oUy0RGfiacu34QEZgDpfia0sVmWrHcDZCV1Na5wDQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

  

  

随着WAF产品从

最近在准备比赛，打sqlilabs时看了一下sqlmap的wiki，发现了–csrf-token和–csrf-url的参数，于是写了个php版本的bug试了一试。

同时也了解了一下大家对csrf注入的普遍做法：sqlmap+burp正则匹配，两相比较，还是sqlmap自带的功能比较方便。  

* * *

**写一个bug**

CSRF的普遍防御方法是增加anti-csrf token，也就是一串不可预测的字符串。于是动手写了一个php版本防csrf的sqli脚本，这里写的并不规范，时间戳是可以被预测的，而且此脚本可以被绕过token检测，有兴趣可以琢磨一下。

```
<?php  
    session_start();  
    //生成随机token  
    $token = md5(time());  
    //获取name参数  
    $name = isset($_GET['name']) ? $_GET['name']: '';  
  
    //校验token  
    if ($_GET['token'] == $_SESSION['token']) {  
        //执行sql语句  
        $mysqli = new mysqli("127.0.0.1","root","root");  
        $mysqli->select_db("test");  
        if (!$mysqli->connect_error) {  
            $query = "select * from admin where username = '$name'";  
            $result = $mysqli->query($query);  
            if (!$mysqli->error) {  
                while ($row = $result->fetch_row()) {  
                    echo $row;  
                }  
            } else {  
                echo $mysqli->error;  
            }  
        } else {  
            echo $mysqli->connect_error;  
        }  
        $mysqli->close();  
    } else {  
        echo "no token";  
    }  
  
    //以hidden表单元素的形式输出token  
    echo "<input type=\"hidden\" name=\"token\" value=\"$token\">";  
    //刷新SESSION中token  
    $_SESSION['token'] = $token;  
  
?>
```

**漏洞利用**  

sqlmap 中有这样两个参数

*   –csrf-token=”token_name”，指定随机化token的参数名
    
*   –csrf-url=”http://x.x.x.x/page”，指定获取token值的地址
    

如果没有指定–csrf-url，则默认从当前页面获取token。先来看看不指定token时，sqlmap的输出：

```
sqlmap -u "http://192.168.154.134/tokensql.php? --flush-session
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

sqlmap根据关键字，识别出了token参数，但是默认不获取token，没有发现注入点。

再来看看指定token时的输出：

```
sqlmap -u "http://192.168.154.134/tokensql.php?
```

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

确认了注入的存在，并且在wireshark中观察到token被sqlmap自动更新

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

在这个demo中，获取token的页面和注入点相同，在真实场景中，可能需要单独获取token值，这时要用到–csrf-url=<url>的参数。

所以使用以下命令，效果也是一样的：

```
sqlmap -u "http://192.168.154.134/tokensql.php?
```

作者：**Woojay**

原文地址:blog.blankshell.com/2020/06/25/sqlmap

声明：本公众号所分享内容仅用于网安爱好者之间的技术讨论，禁止用于违法途径，**所有渗透都需获取授权**！否则需自行承担，本公众号及原作者不承担相应的后果.

  

@

**学习更多渗透技能！体验靶场实战练习**

```


![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

（hack视频资料及工具）  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)




























```

（部分展示）

往期推荐

[

【精选】SRC快速入门+上分小秘籍+实战指南



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247528604&idx=1&sn=5ab3a5b3eaf0c56fcdeabccadfdc6bde&chksm=ebea39b1dc9db0a71fa71d233709afdfd2e2e0483ded28cca42044eded300f1c7025bde1b37a&scene=21#wechat_redirect)

[

爬取免费代理，拥有自己的代理池



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247538507&idx=1&sn=012e95638679390d727ad9ac76f8093a&chksm=ebea1e66dc9d977076c87f955d303509c6a5dee9f498e18669ed25463d9403d7bd7fa2935277&scene=21#wechat_redirect)

[

漏洞挖掘｜密码找回中的套路



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247553371&idx=1&sn=28072033cc1b91a53ea3b48b9b070132&chksm=ebea5876dc9dd16059270c801801949f1b56d26ff76b4ca03b263f9d0228a62a068d1832fb7a&scene=21#wechat_redirect)

[

渗透测试岗位面试题(重点：渗透思路)



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247552587&idx=1&sn=3c0717a556f8e2caea0310585da5f33f&chksm=ebea4766dc9dce70f29bb3be417198f68b985df1c420ef7e92958e34f766a1a043c3e3f86a6b&scene=21#wechat_redirect)

[

漏洞挖掘 | 通用型漏洞挖掘思路技巧



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247550572&idx=1&sn=02bc4368e4b6cd0a39ff1ec24a6aa9ad&chksm=ebea4f41dc9dc657549d9dff584294ba534cbdd7bb5205b1eabb07787300a0a58a899c15ac93&scene=21#wechat_redirect)

[

干货｜列了几种均能过安全狗的方法！



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247524943&idx=1&sn=98644144a3c10bb068ec0f310dcc4958&chksm=ebea2b62dc9da2749321fce7ab28788ced08a2b496e0a45b06a5887b5aa457e48f7a66110301&scene=21#wechat_redirect)

[

一名大学生的黑客成长史到入狱的自述



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247502926&idx=1&sn=8750295399cdcc5e71918c30bb1a974f&chksm=ebea8563dc9d0c75cdf709d2d16fdbdf82abee64516f7a44347f40056969d1b4bc3a1eb2ab2e&scene=21#wechat_redirect)

[

攻防演练｜红队手段之将蓝队逼到关站！



](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247541662&idx=1&sn=343a8d7764dde2121f6b0373aa4dbd28&chksm=ebea6ab3dc9de3a5ad1f7eadd96bd2d42375d7f4c40bd8c4ea4b4dc000415097a0e3fe0fbd38&scene=21#wechat_redirect)

[巧用FOFA挖到你的第一个漏洞](https://mp.weixin.qq.com/s?__biz=MzI4NTcxMjQ1MA==&mid=2247521952&idx=1&sn=55ab0613e5a7ba79b78849b4d91451f6&chksm=ebeadf8ddc9d569bcc64e99414dcbe6878a0b2c9f5c057b30c4bbe465ba76fcaa64e66caa0c2&scene=21#wechat_redirect)

  

**看到这里了，点个“赞”、“再看”**