> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/b7MeEUOl3pYs5rlFIKhjDg)

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JUGej0IgVnrLQOAYILTSquzeCWoZck64025qzAUq1Qib8YSOmADS3dNibYDibEHjthvXjxD6vviao5OeQ/640?wx_fmt=png)

由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，雷神众测及文章作者不为此承担任何责任。

雷神众测拥有对此文章的修改和解释权。如欲转载或传播此文章，必须保证此文章的完整性，包括版权声明等全部内容。未经雷神众测允许，不得任意修改或者增减此文章内容，不得以任何方式将其用于商业目的。

![图片](https://mmbiz.qpic.cn/mmbiz_svg/ofvnGicEPbfSzSpQGue94NS4MiceiayvCwbG8arRDuiczdzibNVPXYEzBFf0GuKnlE2PvXMyDWicH2RDvHkThDwsnQmcPPfvGibR8Ab/640?wx_fmt=svg)

  

靶机简介

Name: Trollcave: 1.2  
Difficulty:easy  
Flag : root/flag.txt  
靶机下载地址：

https://www.vulnhub.com/entry/trollcave-12,230/

![图片](https://mmbiz.qpic.cn/mmbiz_svg/ofvnGicEPbfSzSpQGue94NS4MiceiayvCwbG8arRDuiczdzibNVPXYEzBFf0GuKnlE2PvXMyDWicH2RDvHkThDwsnQmcPPfvGibR8Ab/640?wx_fmt=svg)

  

实验环境

攻击机：本机 (192.168.11.1)、kali(192.168.11.143)  
靶机：Linux，IP 自动获取  
攻击机与靶机都使用 nat 网络连接，在同一网段下

  

![图片](https://mmbiz.qpic.cn/mmbiz_svg/ofvnGicEPbfSzSpQGue94NS4MiceiayvCwbG8arRDuiczdzibNVPXYEzBFf0GuKnlE2PvXMyDWicH2RDvHkThDwsnQmcPPfvGibR8Ab/640?wx_fmt=svg)

渗透测试步骤

1、使用 namp 扫描网段，获得靶机 IP

```
nmap -sn 192.168.11.0/24
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUCV60jfatzFlonfkqicn6qzdHD41pCpiavbibFXStbB45mHCwjwBHrG77A/640?wx_fmt=png)

2、使用 masscan 快速探测目标开放的端口

```
masscan -p1-65535 192.168.11.162 --rate=10000
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WU7XlWicjuN77DtGmdKV4s1w03tEgBDJWcA4hu6fzFRF3q4fhYLq9LTGw/640?wx_fmt=png)

3、使用 nmap 对开放的端口进行服务探测

```
nmap -sC -p 80,22 192.168.11.162
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUXCAIXxRKoZDkSiagkNL1xCbLiaAu2iaKyFIiaFxJS11SyY5phOwhVN7uaA/640?wx_fmt=png)

4、访问目标 80 端口

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WU2OCScWLmwZuxYbETJia8gRIGlA17qicjgX5qfVZ1MsREAcAffZYXeiawQ/640?wx_fmt=png)

大概看了一下是个博客网站，可以登录，不可以注册  
5、扫描网站目录

```
python dirsearch.py -u http://192.168.11.162/
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUv4PjXhUNnHlxQetjsnm0BpTaEpPtHiaznoUrBpWLkPNDZXibDb1icSBuw/640?wx_fmt=png)

6、找到登录口，对用户进行密码爆破发现没成功，看看用的是什么 cms

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WU4c5G7sKnxUds0JkX7CObbFyTiaEXJAz8kBOaaiaAcqicpoAlqlCzOia0Ug/640?wx_fmt=png)

7、查找该 cms 存在的漏洞发现有路径穿越漏洞，但是发现这里并没有该漏洞。于是去发布的博客中找信息，发现有一条 admin 发布的关于重置密码的博客，里面提到 password_resets

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUQJ5yNaBcwww0iazd8ePGO1ibXLqEMOM9Y4DHza2AAVzNdJVn8gmqXusg/640?wx_fmt=png)

8、通过搜索关键字，得知这是 ruby on rails 进行密码重设的

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUiaymajQtV4fF6kzSybQdshg884Evuv5oSqhUZCopgHxqzZSRtfUribmA/640?wx_fmt=png)

9、访问 http://192.168.11.162/password_resets/new 重置密码，填写 username 之后会返回一个重置密码的链接

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUtztpGkRm9H51OMOtJWEbs9jfC4mPswLrZOQaY4I1AI8UDfXRj1Be0g/640?wx_fmt=png)

10、访问返回的重置密码的链接，发现 ?name=xer ，想到可能是根据这个修改对应用的密码的，所以将 xer 改为 King，尝试是否能修改超级管理员 King 的密码，发现重置成功，并登录到 King 账户

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUyhdVsBJkZmwMGt4yowiaXH7iaTxs9LGBQVWBJhn3OlMnibLzpicRFGVE9Q/640?wx_fmt=png)

11、登录之后发现有个文件上传点，并且在 admin panel 模块中可以打开文件上传的功能

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WU9CKJvw9I8mUibZfQewqgNkibDzuDaibW8VibEv5mqeEpuaho1w7FkyMFJg/640?wx_fmt=png)

12、随后试一试先上传一个 php 木马，在 preferences 模块中看到了上传后的文件路径

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WU6hfqVe0VwKeSiaibibefz9xJptbXMHwiaXn6qThGCrblNywT1t5t86pHmw/640?wx_fmt=png)

访问发现并不能解析  
13、虽然不能上传 web 后门，但是发现上传点可以指定上传后的路径，又想到目标开启了 22 端口，于是尝试上传 authorized_keys 到 root 用户下的. ssh 就可以免密码登录 ssh

```
ssh-keygen -f root	
# 生成ssh密钥，生成公钥root.pub和私钥root
mv root.pub authorized_keys
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUaIqFljCUZ6jjryubtONXfIpf1g7OhoL9rLRPkbX7V5Fujutv6nkKPA/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WU4PaQWZOfteWxkia1fFXz0d3ArDicKziarSicwYsicEEGYeXJFkdY2GR8TSg/640?wx_fmt=png)

然后将 authorized_keys 上传到 /root/.ssh/

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUpNtxmwMlIZqKSLRlt5PhUQlaPRNATtRiagCBmFPvyuz5BdGpBpOPb7g/640?wx_fmt=png)

发现上传失败，应该是没有权限。  
14、随后又想到之前收集 ruby on rails 相关信息的时候，发现它在安装成功后会新建 rails 用户，于是尝试上传 authorized_keys 到 rails 用户下的. ssh 看能不能成功

```
ssh-keygen -f rails
mv rails.pub authorized_keys
```

将 authorized_keys 上传到 /home/rails/.ssh/

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUBzzNiclOj2FsWZBYexZzmA96Rq6jshADSxdGw3vGsTae9WicibdVHYPhQ/640?wx_fmt=png)

发现上传成功

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUG7SJAq9dCC4wu7MPo3rA15H1ynRpzTb0Jvknkia9wKWicQWCQDUrqedw/640?wx_fmt=png)

15、ssh 登录目标成功

```
mv rails id_rsa-rails
chmod 600 id_rsa-rails
ssh -i id_rsa-rails rails@192.168.11.162
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUEqUAbkr0DpyFdHtNVviaGph3D8tBudLYXfjOic3cWibcLjyYypLQhOD6A/640?wx_fmt=png)

16、查看内核版本，去查找该版本是否有漏洞，发现有一个可以利用

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WULFy003a4GacxkgJ4vFgRrL9GwOGaFJtTeP0zekqhD3Zj8PIbKM89yw/640?wx_fmt=png)

17、下载该漏洞利用的 c 文件，在 kali 上编译好之后，上传到目标机

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUEql3PpDg8F4rm1gIS6ePdXa9nxYF9a1RNz0Sp3J1um0cfFjG92vPNA/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUiaruo4oCJzTQyfibXt4iazx8ld7D4UL8FJMAfgibLQ83tPDONyT5jVrhWQ/640?wx_fmt=png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUVZDDcdAGIcH25UGNt2SkNuJ3TLLOaeYykicictiapoVfgaz9pXJ6lJvcA/640?wx_fmt=png)

18、运行 exp 成功提权

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUx5JvT8WsJmdaMk7MJznx2wbmZ6LfLl1gqFLK4W4vUnZdI671a85XwA/640?wx_fmt=png)

19、成功读取 flag 文件

![图片](https://mmbiz.qpic.cn/mmbiz_png/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUicfLEWmj7lTqWDEiavrzxsibmq8TpP2Oibv1Bmy7jY02GibvevGiaNo4BHUw/640?wx_fmt=png)

  

![图片](https://mmbiz.qpic.cn/mmbiz_svg/ofvnGicEPbfSzSpQGue94NS4MiceiayvCwbG8arRDuiczdzibNVPXYEzBFf0GuKnlE2PvXMyDWicH2RDvHkThDwsnQmcPPfvGibR8Ab/640?wx_fmt=svg)

总结

比较综合的一个靶场，从信息收集，看他是什么框架，搜集框架信息，看有没有现成可以利用的漏洞，到后面利用逻辑漏洞重置管理员密码进行登录，找到上传点，发现无法利用 php 等 web 后门，但是可以指定上传的路径，于是生成 ssh 密钥，上传到目标机的 / home/username/.ssh/ 目录下就能够免密码登录 ssh 了，之后利用内核版本已有的漏洞进行提权，最终拿到 flag。

**安恒信息**

✦

杭州亚运会网络安全服务官方合作伙伴

成都大运会网络信息安全类官方赞助商

武汉军运会、北京一带一路峰会

青岛上合峰会、上海进博会

厦门金砖峰会、G20 杭州峰会

支撑单位北京奥运会等近百场国家级

重大活动网络安保支撑单位

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUFTfYpiafRFqFMdwsjiafBnbwDQ3js52zvFTAU3jGLoXR0xOGEibK5RRjw/640?wx_fmt=jpeg)

END

![图片](https://mmbiz.qpic.cn/mmbiz_gif/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WU4XOPaSsFQTdTu6OrM5kko6Kb2xYdntRGzYOltCIaibEiaDLgwgjhyibGg/640?wx_fmt=gif)

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUx9akdzdjQgHGn8D5gZ4mLDQ4wILOhSiagKmYRBmibPoWdNjjyAfdQh8g/640?wx_fmt=jpeg)

![图片](https://mmbiz.qpic.cn/mmbiz_gif/HxO8NorP4JVkFl4FSQ3yZh8mHEVax9WUIcDdmqiauHHPjAfHHPDWspBlxEyQxKaclkzlUiaGpvwGP8clR8zhs86A/640?wx_fmt=gif)

**长按识别二维码关注我们**