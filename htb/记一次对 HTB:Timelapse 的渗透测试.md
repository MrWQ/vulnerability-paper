> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/LK2Z3WLtZXl4elka_PIj1Q)

主机发现
====

端口扫描
----

通过 nmap 进行端口端侧，发现存在 18 个开放端口。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJQSicu8fmKqlRWiaa05ibLkB2OLTDUkc77icsnicVIMN006NBpJT7xt5wq9Q/640?wx_fmt=png)

发现存在（Kerberos + LDAP + DNS + SMB）这种端口组合。说明可能 dc01.timelapse.htb 是域控制器。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJTQ6P5A21iagBibwMmicyIcKM87UNticgjRicmAYDcfMhHsPbqiaw40NhicgxQ/640?wx_fmt=png)

并且系统为 windows 系统。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJMibWXB58D8d99eoccBxbozfzVFevic5Pg1rWP3oc23sJ6WQia9GkyWtRQ/640?wx_fmt=png)

爆破 SMB
------

使用 crackmapexec 对其进行爆破。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJeDwSibDO6fo1gpvF2icyeeanVKsCianfdvRU8saGCy6ldrPGnww1fiaCCw/640?wx_fmt=png)

发现没有找到可利用信息。![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJMvuZ3wyxKTFZaSQ13BU6Dca5KnogI4B0WQ6dl7ZwRbPnYOPDkBmsQg/640?wx_fmt=png)

接着使用 smbclient 来进行连接。（-L 列出共享和 - N 空身份验证）

其中 $ 是所有 Windows 系统上的默认共享，其余几个可能是新建出来的。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJYW6JKMGW7NIVqLWibW1u7ylNNcZjAmAUf5od50Nsrg2xy6RxTSHXmew/640?wx_fmt=png)

接着使用 crackmapexec 来进行获取信息，-u 输入任意账户。-p'' 里面必须为空。如果其中是一些字符的话，可能会报错。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJMK0cjByA80rgDVs5sricHv3FicKGJmAOAzic636TVMConRnDA0EaOk72w/640?wx_fmt=png)

发现存在 shares 共享目录，然后使用 smbclient 进行读取文件。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJCCJribFQBCIEthXQdEAw1albricy9WTYhprdr0uSIcNJtVxjN4DtIfNA/640?wx_fmt=png)

发现在其目录下存在一个压缩包。![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJx8ZEQIaAaWZDZOOemnMDOTtcnic6Lxb5PHx1d6qM1lfesxQT3wmWFSQ/640?wx_fmt=png)

使用 get 将其下载到本地，进行分析。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJEX2PGfbUTSHgzibv7kyDGHGrnXGdrLqpxXO7hYZl1jUqqdtzocHicekg/640?wx_fmt=png)

分析文件
----

在 HelpDesk 有几个文件，都是关于 LAPS 的：

本地管理员密码解决方案 (LAPS) 是一种通过域管理本地管理员帐户密码的方法。如果没有圈数，支持团队很难管理为每个系统保留唯一的本地管理员密码。这会导致共享凭据，这意味着当攻击者在系统上获得提升的权限时，他们可以转储共享凭据并使用它来访问其他系统。

LAPS 还轮换管理员密码，定期更改它们，这样如果它们被攻击者捕获，它们会在一段时间后失效。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJJRyUkwYFWrTYvoFLvkxVxJfibibek0Iy3u0nSnbZh6VZOyeCibhoxG5Yw/640?wx_fmt=png)

爆破压缩包
-----

使用 unzip -l 进行查看压缩包里面的内容。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJAmXA1oXwjQzO35npfHg7Cltam2SQiajico0Voznv62eH1zWUibLkjLVOg/640?wx_fmt=png)

使用 unzip 进行解压，发现其存在密码验证。![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJjic13rPg6kew7BuyscM0G1bf0qIp5erha8kBiawhFFoGIDlCAUIe0jwg/640?wx_fmt=png)

用 zip2john 用来生成一个可以被暴力破解的 hash。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJuRmu5NZXNfxmgRzMicJ8Noy9dpz0ibkOYPJHnWsqGOnZxyKjqNwyLu5w/640?wx_fmt=png)接着使用 john 对压缩包生成的 hash 进行爆破。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJMWqherXe0URNfa26lro2991QR1Y5e4BJvjy2E3VRicHPguv2Hg3ibfcQ/640?wx_fmt=png)

接着找到了密码，对压缩包进行解压。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJIUgicX61g8VHZDvaHibobtxKZ5E7QkegMZKuoAhQ8MQc2moib2fxVibPSg/640?wx_fmt=png)

提取密钥
----

获取到了里面的. pfx 文件，访问这个文件需要密钥验证。

我们需要从 openssl 中提取私钥和证书（公钥）。

1. 使用 pfx2john.py 生成一个文件的 hash。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJmleaWABmofn9rSJs24ccRljzAZ6Z1KHJlyRc3lMxIZzqLiae1PO2mOg/640?wx_fmt=png)

继续使用 john 进行爆破 hash。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJyiamjn1tpGbic2miazd6HrLPCeuCIJicC2sLPl0QR70iaAvIOyIHze2cVjw/640?wx_fmt=png)

使用密码，可以提取密钥和证书。提取密钥时，它会要求输入密码（输入 “thuglegacy”），然后是输出. pem 文件的密码。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJNnoicyVIVRoQicrydOzhMsoWatOHbho5fF2g2PcUDpGulYbVqjZLPOicw/640?wx_fmt=png)

我都是使用它的原来密码来进行操作，主要是为了好记。哈哈哈！

接着来转存证书。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJlEbUIXog9icQvBkiapUX09ibqPa9Xtcfjkg5Slv3Cib3icRhQSetPIIUJSw/640?wx_fmt=png)

现在密钥和证书都有了，我们就可以连接主机了。

第一次远程连接
-------

evil-winrm 是从 Linux 主机连接到 WinRM 的工具。-h 会提示它的用法。![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJqBFhZJEicnnIjQg8q5iaDaMA99iaXb2RibZyrUicG4mFL8WTia0A3JSGohicA/640?wx_fmt=png)

本次连接主要 - 用到了 - S、-c、-k、-i 等参数。

*   -S- 启用 SSL，因为我连接到 5986；
    
*   -c legacyy_dev_auth.crt- 提供公钥证书
    
*   -k legacyy_dev_auth.key- 提供私钥
    
*   -i timelapse.htb- 要连接的主机
    

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJCO0XGYMN3pnTuPYyAB98ojqeUnav1AlYrP0XEvlTFjKicJSEt1iaSlEg/640?wx_fmt=png)

成功连接，连接之后就找 Desktop 下的文件。发现有 user.txt，第一个 flag 已经找到了。

获取 user.txt
-----------

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJ3XelJicWsZXblEDcYoAgia2u4HXicyGBFJYdIldTHxqtLg6blBkstqMTA/640?wx_fmt=png)

使用 net use 查看用户权限。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJbGz7kobwUwtV9XRsrzFicRUZHD3aiaxfgtaWm2K1WzcX3wHTAHGd9oOA/640?wx_fmt=png)

使用 whmai /priv 查看用户所属的组。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJq6qIZyoIJ0jboyicEtHA7QAdXf12FZibGNYB0csc0sW4wDIOTWZ56pgQ/640?wx_fmt=png)

检查 PowerShell 历史文件
------------------

查看 PowerShell 历史文件。

这个在应急响应中，检查 windows 主机，可以查看一下这个目录。

C:\Users\legacyy\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJCUml3USsBnjhsy8iakBb4WZicOXbnk5wkgNyA2GkkqcBGNbs8dAKDlXQ/640?wx_fmt=png)

目录下存在一些历史记录，包含了一些用户的远程连接记录。

发现存在用户名和密码。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJv7AcHN8Se9OOvq6Lkic6icBUUg0lVpk7p03esAa4o4PIoH2xXBCKUwWQ/640?wx_fmt=png)

第二次远程连接
-------

接着继续新开一个 winrm，使用新的用户名和密码进行连接。

使用 whoami /priv 查看用户分组。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJFWmVFjniaCTBIcj7AyOLia5Ze4jBA6VAibqqpZZ010mUtQRdgXWIRzRvw/640?wx_fmt=png)

使用 net user 查看用户权限。

LAPS_Readers 这个分组似乎在说明 svc_deploy 有权从 LAPS 进行 读取。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJ5N1lsGgFmr1GXzjzjKsv21INgAtmtqKpyFIicjokptf55xolFpKZhBA/640?wx_fmt=png)

使用 LAPS，DC 管理域中计算机的本地管理员密码。通常创建一组用户并授予他们读取这些密码的权限，从而允许受信任的管理员访问所有本地管理员密码。

读取密码
----

要读取 LAPS 密码，我只需要使用 Get-ADComputer 并专门请求该 ms-mcs-admpwd 属性

使用 Get-ADComputerDC01-property'ms-mcs-admpwd'，进行读取密码。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJJTPKoeps4IM7nXMckxnL5qJxibBOMcDSUnznprUQuA8ianXvzPWSFp1A/640?wx_fmt=png)

成功读到了密码：-c.I3I#+7Z},b;h01c$8D05r。

接着使用 administrator 和新获取到的密码。进行登录。

第三次远程连接
-------

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJeREcwDgXUMSm8FAnWOj9JakVIKkgH308NkzicRicIjAwmfy0enVdjiaFA/640?wx_fmt=png)

寻找 root.txt

接着和往常一样，进入 Desktop 目录下找 root.txt 文件，发现在 Desktop 下文件是空的。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJcYwlJulGqRzicoEibBOeRDcECxgCyibv3w92iaGLX6LjS7HYBU8tUhhgKg/640?wx_fmt=png)接下来去翻 user 目录，发现存在一个 TRX 目录。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJ2hcJkrjGJUIMFFPjJia41DwUcBAUxoPkZQNebd7hNqsCeGvR0PD2BLw/640?wx_fmt=png)

获取 root.txt
-----------

然后进行 TRX 目录，找到了 root.txt 文件。

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTqrbZVZjzAkbc44bS4N5rBJE4Wcd8OWbaxT3qpnnWpPXQ3CiaQ3FkiaeNxedrWMaibcbOeibASiaNrRdZw/640?wx_fmt=png)

总结：
===

靶机主要 nmap 端口扫描开始，然后发现域控制器 ip。对其端口开放的服务进行分析，使用 **crackmapexec** 进行爆破，**smbclient** 获取到 smb 服务下的目录。然后使用 smbclient 进行读取目录下的文件。使用 get 命令下载到本地。

然后对其目录下的文件进行分析，接着使用 **zip2john** 工具生成文件 hash，使用 john 进行 hash 碰撞。使用 **pfx2john.py** 脚本提取 openssl 处的私钥和证书。然后爆破密码并进行提取密钥和证书。使用 **evil-winrm** 进行远程连接，检查 **powershell** 历史文件，发现密钥，读 laps 密码。最后再次进行连接。找到 root.txt

![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWgrjpmypBNZUNibzjsmeQqj7CJRcViaBguHuEatwpSqwKYcAhejiazcXVaOqmdSnzKUjyjrsxiaxLmiaEQ/640?wx_fmt=gif)