> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ldRMacQQZBrFkUH84tGqqA)

![](https://mmbiz.qpic.cn/mmbiz_svg/uHwLXtyH4IXTars0DEAdy9nZcUtFcGrTy3nibexVh7BkBPMPp5nLfNgt67b5GWcgVibZsbUSHhKbtb6Eibh4vBoiaLfySz3fSygp/640?wx_fmt=svg)

![](https://mmbiz.qpic.cn/mmbiz_svg/dx4Y70y9Xcs692v9TjnicxJEZft7mP8uWicBRPuXXzZg069MvuoD4NP9L3WJiaoqponicCib5DMjypusYpLvEsR5g11bPZsUtwfjB/640?wx_fmt=svg)

  

  

  

  

声明：本人坚决反对利用文章内容进行恶意攻击行为，一切错误行为必将受到惩罚，绿色网络需要靠我们共同维护，推荐大家在了解技术原理的前提下，更好的维护个人信息安全、企业安全、国家安全。  

  

  

  

  

![](https://mmbiz.qpic.cn/mmbiz_svg/GPyw0pGicibl6FlfJiaNBkMPMFyFOibLIWIcnofJD9HFIEkZM5SEbOlmbksIpNdHnJna42D5LSLYtEA7cbicE6qBeJv0fJ8eeZjfM/640?wx_fmt=svg)

![](https://mmbiz.qpic.cn/mmbiz_svg/ZqDaDiccbgkhBmJZvPXtaUAefuaoJCVTKXplxCtc9ibiav0toECE9GgicrEgxdtJOMFHDgLu3CN01gofEcWnI72wNtR2AicveephI/640?wx_fmt=svg)

CTFd 是一个 Capture The Flag 框架，侧重于易用性和可定制性。它提供了运行 CTF 所需的一切，并且可以使用插件和主题轻松进行自定义。

```
官方网站：https://ctfd.io/
下载ctfd：https://github.com/glzjin/CTFd.git
下载frp：https://github.com/fatedier/frp/releases/download/v0.29.0/frp_0.29.0_linux_amd64.tar.gz
下载ctf-whale：https://github.com/glzjin/CTFd-Whale
```

01

  

安装部署 frps 服务  

  

步骤 1. 安装启动 frps

```
wget https://github.com/fatedier/frp/releases/download/v0.36.2/frp_0.36.2_linux_amd64.tar.gz 
tar -zxvf frp_0.36.2_linux_amd64.tar.gz 
cd frp_0.36.2_linux_amd64 
sudo cp systemd/* /etc/systemd/system/ 
sudo mkdir /etc/frp 
sudo cp frpc.ini  frps.ini /etc/frp/ 
sudo cp frpc  frps /usr/bin/ 
sudo chmod a+x /usr/bin/frpc /usr/bin/frps
```

![](https://mmbiz.qpic.cn/mmbiz_png/lFOEJLHA9qkZSicd99DGIQcic1y3pIZIuqPsu5rFMHMb4QEpqXJJiaA6hMDKuHHtCWNKKOcbBjiab45ORgScOkokXQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/lFOEJLHA9qkZSicd99DGIQcic1y3pIZIuqLqKOeSiakHl8WVdmSaHPZjZQ2Hgiawynw9icCSbMEWNUSgQwhibeHXyhFQ/640?wx_fmt=png)

步骤 2.  编辑 frps.ini

```
sudo vim /etc/frp/frps.ini 

[common] 
bind_port = 7897 
bind_addr = 0.0.0.0 
token =thisistoken 
vhost_http_port=80 #如果是http动态域名需要这个。80端口开启需要systemmd使用root权限启用frp
```

步骤 3. 启动 frps 服务

```
sudo systemctl start frps
```

![](https://mmbiz.qpic.cn/mmbiz_png/lFOEJLHA9qkZSicd99DGIQcic1y3pIZIuqVbHSRakxpInv4c1rfT9hZElN0nIs04S2v2FaAicedQY5OIcdKsdmo9w/640?wx_fmt=png)

步骤 4. 创建网络并启动 frpc 容器

```
sudo docker network create ctfd_frp-containers 
sudo docker network ls
```

![](https://mmbiz.qpic.cn/mmbiz_png/lFOEJLHA9qkZSicd99DGIQcic1y3pIZIuqGHeFef6aCb6PyLQicKJ6bzRvib3nJI6matwdfafLThrC3cc5eM8ux3Dg/640?wx_fmt=png)

```
sudo docker run -d -v ~/frp_0.36.2_linux_amd64/frpc.ini:/etc/frp/frpc.ini --network="ctfd_frp-containers" --restart=always "glzjin/frp"
```

![](https://mmbiz.qpic.cn/mmbiz_png/lFOEJLHA9qkZSicd99DGIQcic1y3pIZIuqicRolOLzf78hwZLzs9eqWlia7KYW3L7phj63DL6ujm5qqHgXso8w8Ttg/640?wx_fmt=png)

注意：如果执行上述命令行，产生的 frpc 容器一直循环启动，通过指令 docker logs <frpc 容器 ID> 查看报错内容为缺少配置文件，则可以将根目录的 frp_0.36.2_linux_amd64 文件夹删除 (注意是系统生成的空文件夹)，在下载的 frp_0.36.2_linux_amd64 文件夹目录执行（本次操作在 opt 目录下）

```
sudo docker run -d -v frp_0.36.2_linux_amd64/frpc.ini:/etc/frp/frpc.ini --network="ctfd_frp-containers" --restart=always "glzjin/frp"
```

步骤 5. 创建网络 frpcadmin 用于 ctfd 容器和 frpc 容器通信

```
sudo docker network create frpcadmin 
sudo docker network connect frpcadmin <frpc容器名或者ID> #将frpc和ctfd容器单独连接到网络frpcadmin,注意要等容器创建好之后再连接，因此ctfd将在稍后连接 
docker network inspect frpcadmin  #查看frpcadmin网络的连接情况并记录frpc容器的网络IP
```

![](https://mmbiz.qpic.cn/mmbiz_png/lFOEJLHA9qkZSicd99DGIQcic1y3pIZIuqUW0quQ35K3BMOsNJ8PCKW7jGDVUoBOlhFib1c61TCrCaw7BPRcsr2yg/640?wx_fmt=png)

步骤 6. 编辑 frpc.ini

```
vim ~/frp_0.36.2_linux_amd64/frpc.ini 

[common] server_addr = 172.17.0.1 # 这里填写宿主机ifconfig之后docker0的ip，因人而异，不要一摸一样填 
server_port = 7897 
token=thisistoken 
admin_addr = 172.19.0.2 #这里填写frpc容器在frpcadmin网络里的ip，因人而异，不要一摸一样填，而且要和后续下图插件配置界面中️的一样。
admin_port = 7400 
log_file = ./frpc.log
```

编辑完之后记得重启 frpc 容器

![](https://mmbiz.qpic.cn/mmbiz_png/lFOEJLHA9qkZSicd99DGIQcic1y3pIZIuqNVuWIO0dv90WRbKGxP9Odj5Qhr0U2JicAtJI8Plu3Bgu35EJrIXjygA/640?wx_fmt=png)

02

  

安装靶场与插件

  

步骤 1. 下载靶场与插件

将插件 ctfd-whale 下载到 CTFd/plugins 目录：

```
git clone https://github.com/CTFd/CTFd.git 
cd CTFd/ 
git reset 6c5c63d667a17aec159c8e26ea53dccfbc4d0fa3 --hard  #回滚到当前教程适合的版本 
cd CTFd/plugins  #打开ctfd插件目录 
git clone https://github.com/glzjin/CTFd-Whale.git ctfd-whale  #确保插件文件夹小写 
cd ctfd-whale 
git reset 5b32f457e9f56ee9b2b29495f4b3b118be3c57bd --hard  #回滚到当前教程适合的版本 cd ../..   #返回ctfd主目录 vim docker-compose.yml
```

步骤 2. 配置 docker-compose.yml

```
version: '2'
services:
  ctfd:
    build: .
    user: root
    restart: always
    ports:
      - "8000:8000" #你自己的
    environment:
      - UPLOAD_FOLDER=/var/uploads
      - DATABASE_URL=mysql+pymysql://root:ctfd@db/ctfd
      - REDIS_URL=redis://cache:6379
      - WORKERS=1
      - LOG_FOLDER=/var/log/CTFd
      - ACCESS_LOG=-
      - ERROR_LOG=-
    volumes:
      - .data/CTFd/logs:/var/log/CTFd
      - .data/CTFd/uploads:/var/uploads
      - .:/opt/CTFd:ro
      - /var/run/docker.sock:/var/run/docker.sock #添加这句即可，别的基本按照官方的不用动
    depends_on:
      - db
    networks:
        default:
        internal:
  db:
    image: mariadb:10.4.12 #这里改成10.4.12，10.4.13会出错
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=ctfd
      - MYSQL_USER=ctfd
      - MYSQL_PASSWORD=ctfd
      - MYSQL_DATABASE=ctfd
    volumes:
      - .data/mysql:/var/lib/mysql
    networks:
        internal:
    # This command is required to set important mariadb defaults
    command: [mysqld, --character-set-server=utf8mb4, --collation-server=utf8mb4_unicode_ci, --wait_timeout=28800, --log-warnings=0]
  cache:
    image: redis:4
    restart: always
    volumes:
    - .data/redis:/data
    networks:
        internal:
networks:
    default:
         external:
          name: frpcadmin
    internal:
        internal: true
```

步骤 3. 重新 build 后启动 ctfd

```
FROM python:3.6-alpine
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories &&\
    apk update && \
    apk add python3 python3-dev linux-headers libffi-dev gcc make musl-dev py-pip mysql-client git openssl-dev g++
RUN adduser -D -u 1001 -s /bin/bash ctfd
WORKDIR /opt/CTFd
RUN mkdir -p /opt/CTFd /var/log/CTFd /var/uploads
RUN pip3 config set global.index-url https://pypi.doubanio.com/simple
RUN pip3 config set install.trusted-host pypi.doubanio.com
COPY requirements.txt .
RUN pip install -r requirements.txt -i  https://pypi.doubanio.com/simple
COPY . /opt/CTFd
RUN for d in CTFd/plugins/*; do \
      if [ -f "$d/requirements.txt" ]; then \
        pip install -r $d/requirements.txt -i  https://pypi.doubanio.com/simple; \
      fi; \
    done;
RUN chmod +x /opt/CTFd/docker-entrypoint.sh
RUN chown -R 1001:1001 /opt/CTFd
RUN chown -R 1001:1001 /var/log/CTFd /var/uploads
USER 1001
EXPOSE 8000
ENTRYPOINT ["/opt/CTFd/docker-entrypoint.sh"]
```

步骤 4. 构建启动镜像。

```
docker-compose build docker-compose up -d
```

步骤 5. 将 ctfd 连接 frpcadmin 网络

```
docker network connect frpcadmin <ctfd容器名或者ID>
```

![](https://mmbiz.qpic.cn/mmbiz_png/lFOEJLHA9qkZSicd99DGIQcic1y3pIZIuqEqia3zbicsbXicwrcCiaAfs5KrcF7wpB8SocxMO3HVNiccLibgt4yMDHElJA/640?wx_fmt=png)

03

  

CTFd 部署及插件配置

  

步骤 1. 启动 ctfd 后进入管理页面选择插件

![](https://mmbiz.qpic.cn/mmbiz_png/lFOEJLHA9qkZSicd99DGIQcic1y3pIZIuqENJpQPC0aIRhQdSq1rkW28aa3ZiaWhCFt4emHFBj6MG0yEKykUWMibmQ/640?wx_fmt=png)

步骤 2. 填写相关参数

进入后随便设置，然后进 Admin Panel 进行设置

<table width="921"><colgroup><col><col></colgroup><tbody><tr><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>属性</p></td><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>配置</p></td></tr><tr><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>Docker API URL</p></td><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>unix://var/run/docker.sock</p></td></tr><tr><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>Frp API IP</p></td><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>frpc 的 ip 配置</p></td></tr><tr><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>Frp API Port</p></td><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>frpc 的端口配置</p></td></tr><tr><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>Frp Http Domain Suffix</p></td><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>Docker API URL to connect（可填 None）</p></td></tr><tr><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>Frp Http Port</p></td><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>80</p></td></tr><tr><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>Frp Direct IP Address</p></td><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>你的公网 ip，本机即为 127.0.0.1</p></td></tr><tr><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>Frp Direct Minimum Port</p></td><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>与之前 frps 最小端口呼应</p></td></tr><tr><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>Frp Direct Minimum Port</p></td><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>与之前 frps 最大端口呼应</p></td></tr><tr><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>Max Container Count</p></td><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>不超过最大 - 最小</p></td></tr><tr><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>Max Renewal Times</p></td><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>最大实例延时次数</p></td></tr><tr><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>Frp config template</p></td><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>填入 frps 的配置，只需填 [common]</p></td></tr><tr><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>Docker Auto Connect Containers</p></td><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>ctfd_frpc_1</p></td></tr><tr><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>Docker Dns Setting</p></td><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>可填机器内 DNS，没有可填个外网 DNS</p></td></tr><tr><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>Docker Swarm Nodes</p></td><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>linux-1 与前面 swarm 集群呼应</p></td></tr><tr><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>Docker Multi-Container Network Subnet</p></td><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>内网题大子网 ip 配置 / CIDR</p></td></tr><tr><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>Docker Multi-Container Network Subnet New Prefix</p></td><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>每个内网题实例的 CIDR</p></td></tr><tr><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>Docker Container Timeout</p></td><td style="}};border-right:1px solid #d9d9d9;border-bottom:1px solid #d9d9d9;padding:10px;"><p>单位为秒</p></td></tr></tbody></table>

最后附上我的配置图片

![](https://mmbiz.qpic.cn/mmbiz_png/lFOEJLHA9qkZSicd99DGIQcic1y3pIZIuqPuXB6ADic55TB9wFmria0uRtzHEFREEQ79pPfFoic2ZW34F067y53sGqA/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/lFOEJLHA9qkZSicd99DGIQcic1y3pIZIuq8cuX1U6P8K8KYjo3ueqVfOpysOIqM6UwBzNDZ8IwUpgJvNLbg5FqPQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/lFOEJLHA9qkZSicd99DGIQcic1y3pIZIuquK5D5kEMicqz3O1oWc1W4aAUgicDs9No5RRGnvia34biaPyLBZdDwAbTkg/640?wx_fmt=png)

示例：接下来带领大家创建一个 web 容器：

首先通过命令行，下载容器镜像，记录好镜像名称，然后在 challenge 进行配置：

![](https://mmbiz.qpic.cn/mmbiz_png/lFOEJLHA9qkZSicd99DGIQcic1y3pIZIuqLFd7xsFbYIH25icbTf6icwV4K2Lz7fdkrGLzbvcRJU8IW8s3PeUNvqZA/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/lFOEJLHA9qkZSicd99DGIQcic1y3pIZIuqbjNxUYJuwGGCyu1YnVibCic7kOdVtsQ010RRn97H049EZL8MzlWJPZdA/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/lFOEJLHA9qkZSicd99DGIQcic1y3pIZIuqzt0VBZoRqVFrQ664B77E2po52tzWzzkdnJhEgKaFP71cCXOWibEH7kw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/lFOEJLHA9qkZSicd99DGIQcic1y3pIZIuqE8anxy9icjYzSaIlzCKruL9z5vPZy96z8oNicNQkhOUlH9a3hUCiawtRg/640?wx_fmt=png)