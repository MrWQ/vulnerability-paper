<meta name="referrer" content="no-referrer"/>
> æœ¬æ–‡ç”± [ç®€æ‚¦ SimpRead](http://ksria.com/simpread/) è½¬ç ï¼Œ åŸæ–‡åœ°å€ [mp.weixin.qq.com](https://mp.weixin.qq.com/s/nPD5DmNmIMIH8uW_MKHQ9g)

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKTuNjLMC6vUjdfMMgL4ScCZD7aH7z4BiaAuEvia3XvzjXAPBwu7ia9kib7g/640?wx_fmt=png)

**å†…å­˜é©¬åˆè¯†**

**01 åŸºç¡€æ¦‚å¿µ**

**å†…å­˜ä¸ç¡¬ç›˜**

åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œç¡¬ç›˜å’Œå†…å­˜æ‰®æ¼”ç€ä¸åŒçš„è§’è‰²ï¼š

*   ç¡¬ç›˜ç”¨äºå­˜å‚¨ç¨‹åºçš„å¯æ‰§è¡Œæ–‡ä»¶ã€åº“æ–‡ä»¶ã€é…ç½®æ–‡ä»¶å’Œå…¶ä»–å¿…è¦çš„æ•°æ®æ–‡ä»¶ã€‚å½“ç¨‹åºé¦–æ¬¡è¿è¡Œæˆ–åœ¨éœ€è¦æ—¶ï¼Œè¿™äº›æ–‡ä»¶ä»ç¡¬ç›˜åŠ è½½åˆ°å†…å­˜ä¸­ã€‚
    
*   å†…å­˜ç”¨äºå­˜å‚¨ç¨‹åºçš„æŒ‡ä»¤å’Œæ•°æ®ï¼ŒåŒ…æ‹¬ä»£ç ã€å˜é‡ã€å¯¹è±¡ã€å †æ ˆç­‰ã€‚å½“ç¨‹åºéœ€è¦æ‰§è¡Œç‰¹å®šçš„æŒ‡ä»¤æˆ–è®¿é—®ç‰¹å®šçš„æ•°æ®æ—¶ï¼ŒCPU ä»å†…å­˜ä¸­è¯»å–è¿™äº›å†…å®¹è¿›è¡Œå¤„ç†ã€‚
    

å› ä¸ºå†…å­˜çš„æˆæœ¬æ˜¯å¾ˆé«˜çš„ï¼Œæ‰€ä»¥å†…å­˜çš„å®¹é‡é€šå¸¸æ¯”ç¡¬ç›˜å°å¾—å¤šï¼Œä½†è¯»å–å’Œå†™å…¥é€Ÿåº¦æ›´å¿«ã€‚æ‰€ä»¥åœ¨è¿è¡Œç¨‹åºå°†ä»–æ”¾å…¥å†…å­˜ï¼Œå¹³æ—¶æ”¾åœ¨ç¡¬ç›˜æ¥èŠ‚çº¦å†…å­˜ç©ºé—´ã€‚

**å®‰å…¨é—®é¢˜ - å†…å­˜é©¬**

æ™®é€šçš„æœ¨é©¬æ˜¯å†™å…¥ä¸€ä¸ªæ–‡ä»¶å»è®¿é—®ï¼Œæ¶æ„ä»£ç æ˜¯ä¾é äºæ–‡ä»¶çš„ã€‚æ‰§è¡Œåå°±ä¼šåœ¨å†…å­˜ä¸­è¢«é‡Šæ”¾æ‰ã€‚ä½†æ˜¯å†…å­˜é©¬æ˜¯ä¾èµ–äºç¨‹åºæœ¬èº«çš„åŠ¨æ€æ³¨å†Œï¼Œä¼šåœ¨å†…å­˜ä¸­è¿›è¡Œä¸€ä¸ªä¿å­˜ï¼Œè§†ä¸ºç¨‹åºçš„ä¸€éƒ¨åˆ†ã€‚å®ç°è„±ç¦»æ–‡ä»¶åä¾æ—§å¯ä»¥è¿è¡Œã€‚Â 

**02 Tomcat å†…å­˜é©¬**

(æ­¤æ–‡ç« é»˜è®¤ä½ å·²ç»äº†è§£ javaweb)

å¯¹äº Tomcat å†…å­˜é©¬ï¼Œæˆ‘ä»¬é¦–å…ˆè¦çŸ¥é“ Java ä¼šå°† JSP æ–‡ä»¶ç¿»è¯‘æˆä¸€ä¸ª Servlet çš„æ–‡ä»¶çš„ã€‚åŒæ—¶ä½ ä¼šå‘ç° JSP æ˜¯çƒ­éƒ¨ç½²çš„ã€‚å³å¯ä»¥ä¸åœæ­¢æ•´ä¸ª java æœåŠ¡æ¥æ·»åŠ æ–°çš„ Jsp é¡µé¢ã€‚è¿™å¯¹ä¸ Java-web å¼€å‘æ¥è¯´æ˜¯æä¸ºæ–¹ä¾¿çš„ï¼Œä½†æ˜¯æ–¹ä¾¿å°±å®¹æ˜“å¸¦æ¥å®‰å…¨çš„é—®é¢˜ã€‚ç»“åˆ Servlet3 æ”¯æŒåŠ¨æ€æ³¨å†Œï¼Œæˆ‘ä»¬å°±å¯ä»¥æ„é€ å„ç§ Web ç»„ä»¶å†…å­˜é©¬ã€‚

**Listener å†…å­˜é©¬**

**ServletRequestListener**

**è°ƒç”¨é“¾**

æˆ‘ä»¬ç›´æ¥é€šè¿‡ä¹¦å†™ä¸€ä¸ª Listenerï¼Œç„¶åè¿›è¡Œè°ƒè¯•å³å¯å‘ç°è°ƒç”¨é“¾ä¸ºï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgK2zm4u9ib28oaAZTcqWzUXtNeiaZGMeiboiaWYTEzIGrZXtYarK9D6w0YqQ/640?wx_fmt=png)

æˆ‘ä»¬çš„ä»£ç é€»è¾‘æ˜¯è®°å½•åœ¨ requestInitialized æ–¹æ³•ä¸­çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯»æ‰¾æ˜¯æ€ä¹ˆè°ƒç”¨çš„ requestInitialized æ–¹æ³•ã€‚

StandardContextï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgK9nJzkyQSa7icuv0c1YOO96z9Qib9DWgl0IQdtw17ichfACkQgJrFy2xibA/640?wx_fmt=png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ˜¯é€šè¿‡ listener.requestInitialized è¿™é‡Œè¿›è¡Œçš„ä¸€ä¸ªè°ƒç”¨ã€‚è€Œè¿™ä¸ª listener æ˜¯é€šè¿‡ getApplicationEventListeners() è·å–çš„ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKh6hu5zyb7CkvvPl39SwEbHG6tkrFLlhsDl6AQYia06N6y1oUbcJSibNw/640?wx_fmt=png)

é‚£ä¹ˆå…³é”®å°±æ˜¯è¿™ä¸ª applicationEventListenersList çš„å†…å®¹äº†ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKzg8tW6dpldeexUgbYDiaAhiahRjibd3S3ozI0h8JsvicJ7kVF8mRKdtMyw/640?wx_fmt=png)

å¹¶ä¸” StandardContext ç±»ä¸­æä¾›äº†è¿™ä¹ˆä¸€ä¸ªæ–¹æ³•ç»™æˆ‘ä»¬æ·»åŠ ã€‚é‚£ä¹ˆ StandardContext ç±»æˆ‘ä»¬å¦‚ä½•è·å–å‹’ï¼ŒæŸ¥çœ‹è°ƒç”¨é“¾å­ç®€å•å¯»æ‰¾äº†ä¸‹ï¼ŒStandardHostValve ç±»ä¸­å­˜åœ¨å¯¹ StandardContext çš„è·å–ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKbd2bRSDCiaXU6vHOOFzCeNHGyNJcWd1SoiasTegahJAZG5ricTECKfTcA/640?wx_fmt=png)

é‚£ä¹ˆæˆ‘ä»¬å°±è¦è·å– request ç±»äº†ï¼Œåœ¨ JSP ä¸­æ˜¯è‡ªå¸¦æœ‰ RequestFacade ç±»çš„ã€‚æˆ‘ä»¬è¦è·å–çš„æ˜¯ Request ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥é€šè¿‡åå°„æ¥è¿›è¡Œè·å–ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKVsMVRickdD1MpfQ4o3ddtFFUGPH2CTbfBGcGjbbJkrnhLNyCRPgUgGw/640?wx_fmt=png)

å…¶ä¸­çš„ this.request è¢«ä¼ å…¥äº† Request ç±»ï¼Œä¹Ÿå°±æ˜¯ StandardHostValve ç±»ä¸­çš„ requestã€‚ç„¶åå†™å…¥æˆ‘ä»¬çš„ Listener å°±å¯ä»¥äº†ã€‚

**æ€è·¯æ€»ç»“**

Listener æ˜¯ä¼šæ£€æµ‹ä»»ä½•æ•°æ®çš„å˜åŒ–çš„ï¼Œå¯¹äº ServletRequestListener å¯¹è±¡ï¼Œå¯¹äºæ¯ä¸€ä¸ªä¼šè¯è¿æ¥éƒ½è¦è¿›è¡Œä¸€ä¸ªæ£€æµ‹ã€‚é‚£ä¹ˆå°±ä¸€å®šå­˜åœ¨ä¸€ä¸ªå…¨å±€çš„å­˜å‚¨ä½ç½®ã€‚ç„¶åé€šè¿‡åå°„å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œæ›´æ”¹å³å¯å®ç° Listener çš„å»ºç«‹ã€‚è¿™é‡Œå³ä¸º StandardContext.applicationEventListenersListã€‚

**POC**

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKm9qFiawHsQdZibsLR2q7IIyWjovLWmDytcuQxUEhibVPbepChayrlehcg/640?wx_fmt=png)

**Filter ç±»å‹çš„åˆ›å»º**

**è°ƒç”¨é“¾**

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKIgYNgZG1uvjfM5vtBAia0GalqwEQcE9kP7HGnnKsEuwLack0wc5ef0A/640?wx_fmt=png)

internalDoFilter:189.ApplicationFilterChain:

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKaTBQubW7pO3SIHeBmpxAibbscUBx7WMovFiaaZB0feBjOzKv0R7MQh6A/640?wx_fmt=png)

è¿™é‡Œå¯ä»¥çœ‹å‡ºæˆ‘ä»¬çš„ Filter æ˜¯ç”± filters å±æ€§æ¥è¿›è¡Œå­˜å‚¨çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯»æ‰¾ä¸€ä¸‹æ˜¯å¦‚ä½•è¿›è¡Œåˆå§‹åŒ–çš„ã€‚

invoke:197.StandardWrapperValve ä¸­ä½¿ç”¨äº† ApplicationFilterFactory.createFilterChain æ¥æ–°å»ºä¸€ä¸ª ApplicationFilterChain ç±»ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKt7la5LicWZjRBygkDMQm3p3zTt2m0fbib0tjRsmoziaNtIrRv5dn7flOw/640?wx_fmt=png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶ä¸­æ˜¯é€šè¿‡è¯»å– StandardContext çš„å±æ€§æ¥è¿›è¡Œæ„å»º ApplicationFilterChain ç±»çš„ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKwTw7ibVe7zickia4WpoIzRlMOoaHE6Q76S1zxC9vmgzrAUXD3z8IldRMw/640?wx_fmt=png)

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKAicUISibhJzuPMNKsIKPwIeWJseIA6DmTtntZX2mXGz8mjhxaZJtDm2A/640?wx_fmt=png)

æ‰€ä»¥æˆ‘ä»¬å³å¯¹ StandardContext çš„å±æ€§ filterConfigs å’Œ filterMap è¿›è¡Œè®¾ç½®å³å¯ã€‚æˆ‘ä»¬æ¥æŸ¥çœ‹æ˜¯å¦æœ‰å¯¹åº”çš„å±æ€§è®¾ç½®çš„æ–¹æ³•ã€‚

åˆ›å»º filterMapï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKHPBSJ1cH58WJjLlibaM1O4ySiaZ5Ve1ZuMk3uB4kcyU7LDoE6VjMcIHg/640?wx_fmt=png)

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKuTVbW8OEXrWuKt6gTltASRGsleN1zEHBMXTUzrE48cmhwCsYvCalicg/640?wx_fmt=png)

åˆ›å»º filterConfigsï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgK1pMlKNYOXFcib3Laoc0Xm1eUMMPKhn7SPFciaHrtj0pHFsHY632OxichA/640?wx_fmt=png)

filterConfigs æœ¬è´¨æ˜¯ä¸ª Mapï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•è¢«èµ‹å€¼ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgK1ibbNWKRWsWvajCn1LJ9WKdVf1Wz7pJTPibBQEicibSHMO2sdtXtsEryog/640?wx_fmt=png)

é‚£ä¹ˆæˆ‘ä»¬å°±è¦å¯¹ filterDefs è¿›è¡Œä¸€ä¸ªèµ‹å€¼:

filterDefã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKXnibWdZeHLZRoUDGD8h80pMkumGNWlKjicNV1hT7jKdaWX6bjaIve89Q/640?wx_fmt=png)

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgK3icia6yUC1yNF3cpJ1XSAJ0Sg48sOAxlKy5sDWr8J7BuarL8CyJOgkibw/640?wx_fmt=png)

ç„¶åå†å¯¹ filterConfigs è¿›è¡Œä¸€ä¸ªèµ‹å€¼ï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKprUI5yE2iaslP1MUSlX6aicfhnB3ZXlbfib8qcfUkqteYribbVcQaZDKrA/640?wx_fmt=png)

**æ€è·¯æ€»ç»“**

*   è·å– StandardContext å¯¹è±¡;  
    
*   è®¾ç½® StandardContext ä¸­çš„ FilterMaps å¯¹è±¡;  
    
*   è®¾ç½® filterDefs å¯¹è±¡ï¼Œç„¶åç»„è£…è¿› filterConfigï¼Œç„¶åå°† filterConfig å†™å…¥ filterConfigs ä¸­ã€‚
    

**POC**

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgK8EZRh4jdxJ60CbkkEqgBzHJ7KJMGVWjwibxzpWDcaznvnkCWaib9DDibA/640?wx_fmt=png)

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKqzDIWJDjkFwDNKx77FAkhibSp0Yhqb53st73cBib29497JuHDziagqtdw/640?wx_fmt=png)

**Servlet å‹**

**è°ƒç”¨é“¾**

è¿™ä¸ªæ˜¯è¾ƒä¸ºç®€å•çš„ï¼Œåº”ç”¨ä¸€ä¸‹å¤§ä½¬çš„è°ƒè¯•é“¾å­ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKWGNSakwkb31TPBjA0ecUET9XnqlhmAiaibDE3AqTYWMJCztMODl1ibzSQ/640?wx_fmt=png)

é€šè¿‡ configureContext(webXml) æ–¹æ³•åˆ›å»º StandWrapper å¯¹è±¡ï¼Œå¹¶æ ¹æ®è§£æå‚æ•°åˆå§‹åŒ– StandWrapper å¯¹è±¡ã€‚

Servlet çš„æ‰€æœ‰ä¿¡æ¯æ˜¯å­˜å‚¨åœ¨ wrapper ä¸­çš„ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKfTPkSep4Ea2ic4rPC8zic2Tj3H2cfGTmj4roaTyWHSgkOXnbj0Ttj4Cw/640?wx_fmt=png)

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKGFJUqMoZibvbYQ011dLTD0g4J2Jy8bNIwdJk8OqlgDItlQQRibFicrbBg/640?wx_fmt=png)

**æ€è·¯æ€»ç»“**

æ‰€ä»¥ç»¼ä¸Šæˆ‘ä»¬çš„æ€è·¯å°±æ˜¯ï¼š

*   è€å¥—è·¯è·å– StandardContext å¯¹è±¡;
    
*   ç„¶åé€šè¿‡ StandardContext.createWrapper() åˆ›å»º StandardWrapper å¯¹è±¡;
    
*   è®¾ç½® StandardWrapper å¯¹åº”çš„å±æ€§ï¼Œå¹¶å°† StandardWrapper å¯¹è±¡æ·»åŠ è¿› StandardContext å¯¹è±¡;
    
*   é€šè¿‡ StandardContext.addServletMappingDecoded() æ·»åŠ å¯¹åº”çš„è·¯å¾„æ˜ å°„ã€‚
    

**POC**

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKZtbIpxic10J0Vjks4moIGfibDln3XnRdfdccYzuoTWK2EOCsqgwr6xmg/640?wx_fmt=png)

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKiaDLum7b5Apy4pvXPBLz9BiauYRQl4VWSbc4yxg8Eic7JNXLvQDEeMNeA/640?wx_fmt=png)

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKFo5LmbvRaVeWOpUk4JcRib9ArfnXlfR5ibAAU4Nqm5VXjWUW7Y9EFX7g/640?wx_fmt=png)

**Valve**

(ä¸ªäººæ„Ÿè§‰è¿™ä¸ªæ˜¯åˆ†æèµ·æ¥æœ€ç®€å•çš„ã€‚)

ç®¡é“æœºåˆ¶ä¸»è¦æ¶‰åŠåˆ°ä¸¤ä¸ªåè¯ï¼ŒPipeline(ç®¡é“)å’Œ Valve(é˜€é—¨)ã€‚å¦‚æœæˆ‘ä»¬æŠŠè¯·æ±‚æ¯”ä½œç®¡é“ (Pipeline) ä¸­æµåŠ¨çš„æ°´ï¼Œé‚£ä¹ˆé˜€é—¨ (Valve) å°±å¯ä»¥ç”¨æ¥åœ¨ç®¡é“ä¸­å®ç°å„ç§åŠŸèƒ½ï¼Œå¦‚æ§åˆ¶æµé€Ÿç­‰ã€‚å› æ­¤é€šè¿‡ç®¡é“æœºåˆ¶ï¼Œæˆ‘ä»¬èƒ½æŒ‰ç…§éœ€æ±‚ï¼Œç»™åœ¨ä¸åŒå­å®¹å™¨ä¸­æµé€šçš„è¯·æ±‚æ·»åŠ å„ç§ä¸åŒçš„ä¸šåŠ¡é€»è¾‘(å³å…¶ä¸­çš„ invoke æ–¹æ³•)ã€‚

å³é€šè¿‡ä¸€ä¸ª Pipeline ç±»æ¥ç»´æŠ¤ä¸€ä¸ªé€šé“ï¼Œå…·ä½“çš„é€»è¾‘æ˜¯ç”± Valve ç±»æ¥è¿›è¡Œç»´æŠ¤çš„ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgK1tll9kXshAJPfqeHEww1b9iaxvP8MPiaeLseOU2lbO85NdJsUibFsalMA/640?wx_fmt=png)

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKDsQo7hG6L1vqiaoVs7atW2e9hKyBryrzEyrQ28TiahGT6icQB52MN8Xmw/640?wx_fmt=png)

å…¶ä¸­çš„ invoke æ–¹æ³•å³ä¸ºæˆ‘ä»¬çš„é€»è¾‘ä¹¦å†™ç‚¹ã€‚

**è°ƒç”¨é“¾**

ç›´æ¥ä½¿ç”¨ Filter çš„è°ƒè¯•ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKtgaoicPfgNutQUKoFm34oOP6b1y8Dh0PM3qRlficrWS80PbRO8lxO9yg/640?wx_fmt=png)

åœ¨ invoke:97.StandardContextValve(org.apache.catalina.core) ä¸­è°ƒç”¨äº†ç®¡é“ä¸­çš„ Valve çš„ invoke æ–¹æ³•ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKmByNxK0ZicKr6TH3aCMrutCRJicsuZiaRUmqt9FCgmskuPYDALEo0FIOA/640?wx_fmt=png)

**æ€è·¯æ€»ç»“**

æˆ‘ä»¬çš„æ€è·¯å³åˆ›å»ºä¸€ä¸ª Value åŠ å…¥åˆ°ç®¡é“ StandardPipeline ç±»ä¸­å³å¯ã€‚

1.  è·å– StandardContext å¯¹è±¡ï¼›  
    
2.  é€šè¿‡ StandardContext å¯¹è±¡è·å– StandardPipelineï¼›  
    
3.  ç¼–å†™æ¶æ„ Valveï¼›  
    
4.  é€šè¿‡ StandardPipeline.addValve() åŠ¨æ€æ·»åŠ  Valveã€‚
    

**POC**

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKS1KM3M9Cf4swtMzkBia5F1iaKIkZ0ofcGrbICXJU4798yByBrIMDyibhw/640?wx_fmt=png)

**0****3Â å†…å­˜é©¬çš„æ£€æµ‹**

æœ‰æ”»å‡»å°±æœ‰é˜²ï¼Œæ ¹æ®ä¸Šæ–‡å†…å­˜é©¬çš„æ„é€ æˆ‘ä»¬å°±å¯ä»¥å†™å‡ºç›¸åº”çš„æ£€æµ‹è½¯ä»¶ã€‚

**Listener å†…å­˜é©¬**

æˆ‘ä»¬çŸ¥é“æˆ‘ä»¬æ˜¯å¯¹ StandardContext.applicationEventListenersList å±æ€§è¿›è¡Œæ›´æ”¹æ¥æ³¨å†Œ Listener å†…å­˜é©¬ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥å¯¹ applicationEventListenersList å±æ€§è¿›è¡Œä¸€ä¸ªè¯»å–å³å¯ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKOLyBZibAXT8hmgFDFtP519YA4Aok6a6icgWBJPMQAxkyKFKBH2CwgJeg/640?wx_fmt=png)

é‚£ä¹ˆå¦‚ä½•ä»è¿™äº›ç±»ä¸­å»è¯»å–é‚£äº›æ˜¯å†…å­˜é©¬å‹’ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å»è¯»å–å®ƒçš„ä¸€ä¸ª class æ–‡ä»¶ã€‚æŸ¥è¯¢æ˜¯å¦å­˜åœ¨å¯¹äºæ–‡ä»¶ï¼Œå¦‚æœä¸å­˜åœ¨å°±å¯ä»¥åˆæ­¥åˆ¤æ–­ä»–æ˜¯ä¸€ä¸ªå†…å­˜é©¬äº†ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKrw3nfKjquNTJKf75roM6SaAO3GibM2WKBSwPUta5hPqlZlCTkyDOrVA/640?wx_fmt=png)

ä»£ç ï¼š

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKkMiaovoj73uAKzKzSNSnH6aN4hYswvhopgBcwPsrsMyPW6msavNaLaQ/640?wx_fmt=png)

**Filter å†…å­˜é©¬**

å‰æ–‡æˆ‘ä»¬æ˜¯è‡ªå·±å¯¹ filterConfigs çš„ä¸€ä¸ªæ³¨å†Œï¼Œæˆ‘ä»¬å¯¹äºä»–çš„ä¸€ä¸ªæ£€æµ‹å°±ç®€å•å¤šäº†ï¼Œåªç”¨è€ƒè™‘è¯»å–å°±æ˜¯äº†ã€‚ä¸€æ ·çš„å¥—è·¯ä½¿ç”¨åå°„å¯¹ StandardContext ç±»çš„å±æ€§è¿›è¡Œä¸€ä¸ªè¯»å–ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKaBvxLic5Bk05MsFRQIJLDkGicySiawuxpNYpEv752siaJfJZ9o3cQez48A/640?wx_fmt=png)

ç„¶åæ ¸å®è¿™äº›ç±»æ˜¯å¦å­˜åœ¨å¯¹äºçš„ class æ–‡ä»¶ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKEibxwRibBicH13YbvFjrEaeVPJCEM1e5wljRx7nUgm2upXadmE9M15XibA/640?wx_fmt=png)

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKUMHw32yNwicFs8iaiauZZicrShoeENWy7YpoScYic0vwYia7Eib2JqiaUxPCdQ/640?wx_fmt=png)

**Servlet å†…å­˜é©¬**

Servlet æ˜¯é€šè¿‡ standardContext.addChild æ¥å¯¹ä¸€ä¸ª Wrapper è¿›è¡Œæ·»åŠ çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬ç›´æ¥å»çœ‹çœ‹æ˜¯å¦æœ‰å…¶ä»–çš„æ–¹æ³•å¯ä»¥è¿›è¡Œè·å–ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKsJQib8Tk7aJShs2syDD5d25seFA9VEpiaAQj19DRfjJtokeiaYXWTdryw/640?wx_fmt=png)

åŒæ—¶æŸ¥æ‰¾ä¸€ä¸‹ Wrapper å¯¹ servlet çš„è·å–æ–¹å¼ã€‚é€šè¿‡ getServletClass() å¯¹ servlet çš„ç±»åè¿›è¡Œä¸€ä¸ªè·å–ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKdtAppNXblJ2aprzVJ7oVV1kLUxVHticWjHH1doW7e9xGsJV2lINHstQ/640?wx_fmt=png)

åé¢å°±æ˜¯ä¸€ä¸ªç›¸åŒçš„æ€è·¯äº†ã€‚æŸ¥æ‰¾å¯¹åº”çš„ç±»åæ˜¯å¦å­˜åœ¨å¯¹åº”çš„ç±»æ–‡ä»¶ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKN8v7MdEibD2WmEG9AM3JRrIHK3BXA9HMYpZdKOLgM0P9FQgpA3RAlzw/640?wx_fmt=png)

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKicNMmROd1OhefiaEQL3ibibtQ6oQbD96KrW6PPzStHDqaBIlHmaibGGthPg/640?wx_fmt=png)

**Value å†…å­˜é©¬**

StandardPipeline ç±»ç›´æ¥æä¾›äº†å¯¹åº”çš„ getValves æ–¹æ³•ï¼Œé‚£ä¹ˆå°±å¾ˆç®€å•äº†ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKGCChLZhAhGEASQ0U0gdCbgD5nDPtNibRia9Xiaf4hsF3icRMgv6XpArxIQ/640?wx_fmt=png)

ä¸€æ ·çš„æ€è·¯å»è·å–ç±»åæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ class æ–‡ä»¶å³å¯ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_png/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKHLPQ8pZPULFsib7sMxHZLZYpHITr7LiaK5ib5Gtoibb4PsMEXXODhmJoQA/640?wx_fmt=png)

**04** **åŸåˆ›æ£€æµ‹å·¥å…·**

åŸºæœ¬åŸç†ä¸Šæ–‡å·²ç»æåˆ°äº†ï¼Œå°±æ˜¯è¿›è¡Œä¸€äº›æ•´åˆå’Œè¿›è¡Œä¸€äº›é¡µé¢çš„ç¾åŒ–ã€‚

æºç åœ°å€ https://github.com/TvT-dog/Tomcat-memshell-findã€‚å¸Œæœ›å¤§å®¶ç‚¹ç‚¹ starã€‚ğŸ˜Š

**05 å‚è€ƒæ–‡ç« **

https://goodapple.top/archives/1355

https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Servlet%E5%9E%8B/

![å›¾ç‰‡](https://mmbiz.qpic.cn/sz_mmbiz_jpg/ZqQxQaaSFRPeYUHUlBcZazph7U2xMHgKM2ibbvfcctTqYtGTmVEkcrNoUaGmQqLVdLuuvjmFos3tUHEGc5iaMVuw/640?wx_fmt=jpeg)

**é•¿æŒ‰äºŒç»´ç å…³æ³¨**

**D0g3**

é“æ ¼å®‰å…¨