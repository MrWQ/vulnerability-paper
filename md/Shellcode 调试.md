> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/GdSTT-8iR_8XatKYYoHEsQ)

        Shellcode 是一段 PIC（与位置无关的代码），这意味着它不对代码或数据使用硬编码地址。它通常用于漏洞利用开发，也可以用于恶意软件。  

        无法在调试器中运行 shellcode，因为它不是普通的可执行文件，而是一段数据。但使用 IDA 对其进行静态逆向却非常简单。

        让我们看看如何快速分析和调试 Shellcode。

Shellcode Hello World
=====================

        就本例而言，我们将使用一个简单的 shellcode，它将使用 MessageBox 显示字符串 “Hello World”。

   "\x33\xc9\x64\x8b\x49\x30\x8b\x49\x0c\x8b"  
   "\x49\x1c\x8b\x59\x08\x8b\x41\x20\x8b\x09"  
   "\x80\x78\x0c\x33\x75\xf2\x8b\xeb\x03\x6d"  
   "\x3c\x8b\x6d\x78\x03\xeb\x8b\x45\x20\x03"  
   "\xc3\x33\xd2\x8b\x34\x90\x03\xf3\x42\x81"  
   "\x3e\x47\x65\x74\x50\x75\xf2\x81\x7e\x04"  
   "\x72\x6f\x63\x41\x75\xe9\x8b\x75\x24\x03"  
   "\xf3\x66\x8b\x14\x56\x8b\x75\x1c\x03\xf3"  
   "\x8b\x74\x96\xfc\x03\xf3\x33\xff\x57\x68"  
   "\x61\x72\x79\x41\x68\x4c\x69\x62\x72\x68"  
   "\x4c\x6f\x61\x64\x54\x53\xff\xd6\x33\xc9"  
   "\x57\x66\xb9\x33\x32\x51\x68\x75\x73\x65"  
   "\x72\x54\xff\xd0\x57\x68\x6f\x78\x41\x01"  
   "\xfe\x4c\x24\x03\x68\x61\x67\x65\x42\x68"  
   "\x4d\x65\x73\x73\x54\x50\xff\xd6\x57\x68"  
   "\x72\x6c\x64\x21\x68\x6f\x20\x57\x6f\x68"  
   "\x48\x65\x6c\x6c\x8b\xcc\x57\x57\x51\x57"  
   "\xff\xd0\x57\x68\x65\x73\x73\x01\xfe\x4c"  
   "\x24\x03\x68\x50\x72\x6f\x63\x68\x45\x78"  
   "\x69\x74\x54\x53\xff\xd6\x57\xff\xd0"

        第一步是将该 shellcode 转换为十六进制格式。

![](https://mmbiz.qpic.cn/mmbiz_png/DPkernzS451NBDWDFmfuhvxh34gUeTKRVrNRtwNZibd6Ew5TLWrPlFicgIdd6ud3zMVzoQz2QGFqibro5LeQPib4Wg/640?wx_fmt=png)

IDA 逆向
======

        现在，我们可以像使用普通可执行文件一样将十六进制文件加载到 IDA 中。此处的区别在于，我们将其分解为二进制文件。

![](https://mmbiz.qpic.cn/mmbiz_png/DPkernzS451NBDWDFmfuhvxh34gUeTKRveeIKdavibAX72DzltibCnc1rc1ibjsiaHziaiaxq2nsXgGNCibOuW1bLWZbA/640?wx_fmt=png)

        IDA 不会正确地反汇编它，但我们可以按 “c” 键将其转换为代码。

![](https://mmbiz.qpic.cn/mmbiz_gif/DPkernzS451NBDWDFmfuhvxh34gUeTKRxzibhrI3LuZTmn5gLgmS6Tq4W4C19P4N3evT5yhHKzLUXyxDcHlPtgw/640?wx_fmt=gif)

Shellcode 调试
============

        由于 PIC 无法直接调试 Shellcode，因此我们需要将其转换为可执行文件才能将其加载到调试器中。

        为此，我们可以使用 shellcode2exe 工具。（这里有一个 Windows 的版本：https://github.com/fr0gger/shellcode2exe_package）

        要将我们的 shellcode 转换为可执行文件，我们必须以文件作为参数运行该工具。

```
C:\Users\shell\Desktop>shellcode2exe.exe hello_shell.hex hello.exe
Shellcode to executable converter
by Mario Vilas (mvilas at gmail dot com)
Reading raw shellcode from file hello_shell.hex
Generating executable file
Writing file hello.exe
Done.

```

        现在，我们可以将文件作为普通可执行文件运行，然后使用你喜欢的调试器对其进行调试。

![](https://mmbiz.qpic.cn/mmbiz_png/DPkernzS451NBDWDFmfuhvxh34gUeTKRW9YTeMWoG9e04JbZ4r26JEaWZHwsEiaHsD0mpF0j3bFYhvoJVcQJS7A/640?wx_fmt=png)

        该文件最终可以在调试器中作为普通可执行文件进行调试。

![](https://mmbiz.qpic.cn/mmbiz_png/DPkernzS451NBDWDFmfuhvxh34gUeTKRhtnh1jIcicTpJXlzEyeR4qR2rgbt0kkPMic5gX9l6NKnMWjBQDFibkVLg/640?wx_fmt=png)