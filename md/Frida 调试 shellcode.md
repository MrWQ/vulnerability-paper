> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/nLKXzgPlrwMJlPFeQCEybw)

    我在以前讲过几篇 shellcode 调试的文章，有《[汇编：定位 EIP/RIP](http://mp.weixin.qq.com/s?__biz=MjM5NDcxMDQzNA==&mid=2247486339&idx=1&sn=0b457a789eda17deb070ed21f08972fc&chksm=a682dd4e91f554581063623d3ec4f544e699578facb9130f500dec6f9d3be742b5ee89e436e6&scene=21#wechat_redirect)》《[如何调试 shellcode](http://mp.weixin.qq.com/s?__biz=MjM5NDcxMDQzNA==&mid=2247486610&idx=1&sn=ce3dccdf2427584ba6c47fb5ed3e844e&chksm=a682da5f91f553494a9eb515f83e74e03aaa8939e06188b474ebdc71b70b44352f5e347dda46&scene=21#wechat_redirect)》《[识别和分析 shellcode 的一些方法](http://mp.weixin.qq.com/s?__biz=MjM5NDcxMDQzNA==&mid=2247487129&idx=1&sn=68c429018d45382e14a7980935786ebb&chksm=a682d85491f551421eaa44081d8b19379efc4164bd5b7f4452c3308624c1e144caad43d2d0aa&scene=21#wechat_redirect)》等。这篇文章也是和 shellcode 有关，这次我们结合 Frida 来看看效果。

**一、思路**

. 用工具 RunShell 加载起来 shellcode，但不执行；  

. 将 Frida 附加到工具进程中，Frida 将允许我们在不修改代码的情况下拦截 Win32 API。

工具及 shellcode 放在文后的网盘中供下载。

**二、安装 Frida**

安装 12.8.0 版本，虽然不是最新的，但稳定。

python3 -m pip install frida==12.8.0

python3 -m pip install frida-tools==5.3.0

**三、过程**  

打开 RunShell64 加载 “x64-ret.bin”Shellcode 文件，点击 “Run” 命令并不要确认运行 Shellcode。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpL5Bia6w7DeqPCtVKMKx8CwDV4LXibgNEs3512nPsQJLwYhemZicQMicaCFOLehCHP6ysicQUX64TGV1RQ/640?wx_fmt=png)

然后打开命令提示符并将 Frida 附加到 RunShell64 进程 ID (-p)，指示该工具包含 MessageBoxA 和 LoadLibrary API 函数 (-i)：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpL5Bia6w7DeqPCtVKMKx8CwD7QicERmMHgn6DG3qEcCDjRkBXUYdSvEPQMzyH5dYOAMcoVv4m1MPiagg/640?wx_fmt=png)

frida-trace -p 129532 -i MessageBoxA -i LoadLibraryA

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpL5Bia6w7DeqPCtVKMKx8CwDwyOFAw3yGysXKibnOKksA8AFZYWdic9OFYjBxSnP2S6WutPNcVUf36hA/640?wx_fmt=png)

Frida 将在当前目录中生成带有 JS 文件的 handlers 文件夹（在映射到 modules/dlls 的子目录中）来处理与我们在命令中指定的函数的函数调用 / 离开（onEnter/onLeave）相关的事件

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpL5Bia6w7DeqPCtVKMKx8CwDKrLHUIvslqksOgqB2MbakpVXaxibn09IZYQr30XlCS0Ue74GxVTIPxQ/640?wx_fmt=png)

让我们跳回 RunShell64 并点击 Ok 运行 Shellcode，同时监控 frida-trace 的输出

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpL5Bia6w7DeqPCtVKMKx8CwDBSP7Sy8Vax8ibmdeU93wkrRaIdFCbkibGEtHKYlbF4WDh0D4XZb0icJ7w/640?wx_fmt=png)

发现在这个 shellcode 中输出了三个 API。

**四、修改 JS**

我们先来看看 Frida 生成的 js 文件，

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpL5Bia6w7DeqPCtVKMKx8CwDCG3LUucicqKvnXN1KVxDb1e2YDMuia4iaOTH75pYAPDSIbRJGvo4pF9tA/640?wx_fmt=png)

我们将调整 LoadLibraryA.JS 中的代码，以了解 Shellcode 请求的是哪个 DLL，以下是更新后：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpL5Bia6w7DeqPCtVKMKx8CwDibX3fnW2su9ktj9yXWvFjeeSNoGjzVLhD8uvAep2MlibibXYMln5hWBLg/640?wx_fmt=png)

再次运行 Shellcode，让我们检查输出：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpL5Bia6w7DeqPCtVKMKx8CwDpOVqgn22gTiaQMpiad2zZ3nrSengKpHycyV0YM3TkMvw3rhLIXmrjS4A/640?wx_fmt=png)

再修改 JS 代码需要修改为使用第一个参数（LPCSTR lpLibFilname）作为 ANSI 字符串（MessageBoxA 使用 ANSI 字符串）使用 Memory.readAnsiString(args[0])：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpL5Bia6w7DeqPCtVKMKx8CwDqAwQug9lSjanJJIo3RQsv8NtcCYqArGpulvtgkA5pajJyWGVm55GFg/640?wx_fmt=png)

再次运行 Shellcode，

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpL5Bia6w7DeqPCtVKMKx8CwDctuytzibaV8MpAtjoT33m7L4wEwcibSEOFkWRvwgJLH4dKQaUhLXoVTg/640?wx_fmt=png)

以上无需修改任何代码或使用任何挂钩库来拦截 Win32 API。

例子二：拦截更改 API 的参数  

    在上面的函数中有个 MessageBoxA 函数 (以这个为例)，我们想修改它的参数。这个功能很实用，在实际场景中分析很有用。

让我们通过更改消息框文本来调整在 MessageBoxA.JS 文件中传递给 onEnter 函数的参数:

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpL5Bia6w7DeqPCtVKMKx8CwD2UZMSd3bwt8RMO19vfeWiasiaVvQRaD9qBWFJ1aOYwfbdnhRSZ7IutIw/640?wx_fmt=png)

再次运行 Shellcode，

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpL5Bia6w7DeqPCtVKMKx8CwDEsx2Rqmpa8qP8y3GvvOO0mY5HOLkaYNicN7YyjMamgWJictETKJ11W6w/640?wx_fmt=png)

Frida 功能强大！！！

下载：  

链接：https://pan.baidu.com/s/1rCzwtityhe_phy7hsoBimA

提取码：gapm