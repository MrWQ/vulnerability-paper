<meta name="referrer" content="no-referrer"/>
> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/-P_Ybo0vT1dVqngxXBNZhA)

![](https://mmbiz.qpic.cn/mmbiz_jpg/djiam4RadAPZjEla9dGzYZabQjFvvqeibPXHoSzqSPJyBQutMnHiaSUMMeDLhPTiaTnOXS50Ck2EKLY9CHk5EgzYmQ/640?wx_fmt=jpeg)

最近学习 pwn，看到一个 switch 的逆向题目，于是乎在浩然表哥和 the one 表哥的帮助下研究了一波，学到了很多不可描述的知识。题目的下载地址：

```
https://www.icloud.com/iclouddrive/0ZkKpgouFpOW-DbEHvDSL2taQ#switch
```

下载题目附件后，根据扩展名使用 Wireshark 分析

![](https://mmbiz.qpic.cn/mmbiz_png/djiam4RadAPZjEla9dGzYZabQjFvvqeibP4CvnqhNpRqwzZTaopASem2fMzO2cmXwoiauFyO4qFE75bzftbNpZ4nw/640?wx_fmt=png)

不难发现，流量包中均为 USB 流量，猜测可能是通过 USB 传输了该 APP，使用如下命令提取出传输的文件：

```
tshark -r switch.pcapng -Y 'usb.capdata and usb.device_address==4' -T fields -e usb.pcapng > raw
```

将文本 16 进制转换为二进制格式

```
xxd -r -p raw raw.out
```

![](https://mmbiz.qpic.cn/mmbiz_png/djiam4RadAPZjEla9dGzYZabQjFvvqeibPYyv4vSym9q9BgxbUr97FoZqB1U2kheHojSMXBgY5etjT4iakT8sF3EA/640?wx_fmt=png)

我们将 nop 指令之前的内容全部删除掉，将文件另存为新的 bin 文件即可

![](https://mmbiz.qpic.cn/mmbiz_png/djiam4RadAPZjEla9dGzYZabQjFvvqeibPt0S1x20SrcKw0iaSgxFMNGsLLpEm9ibg3uDW2Sszayh9UIvDia58q0eUQ/640?wx_fmt=png)

我们大致了解了其架构，使用 ida 打开目标文件，Load file 时按照如下选项配置

![](https://mmbiz.qpic.cn/mmbiz_png/djiam4RadAPZjEla9dGzYZabQjFvvqeibP4yqqa2mEMZCYjJFzb2nC2vSLDDjhLRUxq5ofibsPceV68vk88PykDBg/640?wx_fmt=png)

Rebase the whole program

![](https://mmbiz.qpic.cn/mmbiz_png/djiam4RadAPZjEla9dGzYZabQjFvvqeibPlVp41yRaBfz7UTKxJDXm0XtXqicJ6L5AdfwJjEgTP66ib2HXgz7VOFag/640?wx_fmt=png)

通过查找交叉引用以及上下文分析，可以查找到该函数像是解密函数

![](https://mmbiz.qpic.cn/mmbiz_png/djiam4RadAPZjEla9dGzYZabQjFvvqeibPPS52sLjFKKmfCbEfdp3zPgljiasyCdDt6t45ia6O78kMX2jFl2LiakF9g/640?wx_fmt=png)

主要逻辑为对每个字节 AND 上一个 0x7F  

![](https://mmbiz.qpic.cn/mmbiz_png/djiam4RadAPZjEla9dGzYZabQjFvvqeibPdYJPQmxJZj4yuRNnC3x3o0w5iczvEXpKKz0v6695ADPh0Rryqcs0KTg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/djiam4RadAPZjEla9dGzYZabQjFvvqeibPI0iaccLich2zdVIVqeXNFhxiaWgUOUICJKmPiaKkBoCXMA3EiaOhaIq2cSA/640?wx_fmt=png)

将 0x4001CCAD 处的数据导出

![](https://mmbiz.qpic.cn/mmbiz_png/djiam4RadAPZjEla9dGzYZabQjFvvqeibPRHeFNGpicV5FGiccYaHjib8Q05ZV2SvJU7TcjAlSic0JwCArrticEnjaUNA/640?wx_fmt=png)

编写脚本进行解密：

```
ciphertext = [  0xE5, 0xF2, 0xE5, 0xA7, 0xF3, 0xA0, 0xE9, 0xEE, 0xE6, 0xEF, 
  0xA0, 0xE6, 0xF2, 0xEF, 0xED, 0xA0, 0xE6, 0xF5, 0xF3, 0xE5, 
  0xA0, 0xA8, 0xC8, 0xD7, 0xC9, 0xA9, 0xBA, 0xA0, 0xA5, 0xF3, 
  0x8A, 0x80, 0x00, 0xD9, 0xEF, 0xF5, 0xF2, 0xA0, 0xF0, 0xF2, 
  0xE5, 0xE3, 0xE9, 0xEF, 0xF5, 0xF3, 0xA0, 0xF0, 0xF2, 0xE9, 
  0xF6, 0xE1, 0xF4, 0xE5, 0xA0, 0xEB, 0xE5, 0xF9, 0xA8, 0xD3, 
  0xC2, 0xCB, 0xA9, 0xBA, 0xA0, 0xA5, 0xF3, 0x8A, 0x80, 0x00, 
  0xD3, 0xC2, 0xCB, 0xA0, 0xC1, 0xC5, 0xD3, 0xC5, 0xA0, 0xB0, 
  0xA0, 0xA8, 0xF3, 0xEF, 0xED, 0xE5, 0xA0, 0xF2, 0xE1, 0xEE, 
  0xE4, 0xEF, 0xED, 0xA0, 0xF4, 0xE8, 0xE9, 0xEE, 0xE7, 0xF3, 
  0xA0, 0xE5, 0xEE, 0xE3, 0xF2, 0xF9, 0xF0, 0xF4, 0xE5, 0xE4, 
  0xA0, 0xE2, 0xF9, 0xA0, 0xF9, 0xEF, 0xF5, 0xF2, 0xA0, 0xEB, 
  0xE5, 0xF9, 0xA9, 0xBA, 0xA0, 0xA5, 0xF3, 0x8A, 0x80, 0x00, 
  0x8A, 0xD4, 0xE8, 0xE9, 0xF3, 0xA0, 0xE3, 0xF2, 0xE1, 0xE3, 
  0xEB, 0xED, 0xE5, 0xA0, 0xF2, 0xE5, 0xAD, 0xF5, 0xF3, 0xE5, 
  0xA0, 0xED, 0xEF, 0xF3, 0xF4, 0xEC, 0xF9, 0xA0, 0xF4, 0xE8, 
  0xE5, 0xA0, 0xE3, 0xEF, 0xE4, 0xE5, 0xF3, 0xA0, 0xE6, 0xF2, 
  0xEF, 0xED, 0xA0, 0xF2, 0xE1, 0xEA, 0xEB, 0xEF, 0xF3, 0xF4, 
  0xEF, 0xAE, 0xA0, 0xE8, 0xF5, 0xE7, 0xE5, 0xA0, 0xF4, 0xE8, 
  0xE1, 0xEE, 0xEB, 0xF3, 0xFE, 0x8A, 0x80, 0x00, 0xC8, 0xE5, 
  0xF2, 0xE5, 0xA7, 0xF3, 0xA0, 0xF9, 0xEF, 0xF5, 0xF2, 0xA0, 
  0xF0, 0xF2, 0xE5, 0xE3, 0xE9, 0xEF, 0xF5, 0xF3, 0xA0, 0xE6, 
  0xEC, 0xE1, 0xE7, 0xA1, 0xA1, 0x8A, 0xE6, 0xEC, 0xE1, 0xE7, 
  0xFB, 0xE3, 0xF6, 0xF6, 0xE4, 0xDF, 0xF3, 0xF7, 0xB1, 0xF4, 
  0xE3, 0xE8, 0xAD, 0xE8, 0xB0, 0xED, 0xE5, 0xE2, 0xF2, 0xB3, 
  0xF7, 0xAD, 0xE9, 0xF3, 0xAD, 0xE2, 0xF2, 0xB8, 0xEC, 0xE9, 
  0xE1, 0xEE, 0xF4, 0xFD, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00]

flag = ""

for i in ciphertext:
  flag+= chr(i & 0x7f)

print(flag)
```

![](https://mmbiz.qpic.cn/mmbiz_png/djiam4RadAPZjEla9dGzYZabQjFvvqeibPhL7QAm8NibeWpLovv08Y3H10sqwCNfiam6gvV3AcV69TydIXosIRhYGA/640?wx_fmt=png)

还是太菜，很多东西没有分析明白，而且买来的 switch 好像还没用上，**不过分手厨房很好玩**....

![](https://mmbiz.qpic.cn/mmbiz_png/djiam4RadAPZjEla9dGzYZabQjFvvqeibPkYjEu8pjTDzibjOJjcCLEmetJGiaRB4motj4SomXbgVU8GXMYOX4nydQ/640?wx_fmt=png)