> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzI5MDE0MjQ1NQ==&mid=2247525257&idx=1&sn=1b5c2f2da5b11a3c8f1f645817f80462&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_gif/vnT4hbaLoX5J1VZCVndQceEd50LP5ZcZfHY0maZdjCibzYW3P3hSEGxmwQVhYonEJBGxHeGmyLnibCXFtTcYkQVg/640?wx_fmt=gif)

{

**点击蓝色**

 

**关注我们**

}

![](https://mmbiz.qpic.cn/mmbiz_jpg/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnOUGzQLuzP37icFJaVvBWBTu4JgiceNbTshL9gias9aCqkW9voORu4bTug/640?wx_fmt=jpeg)
-------------------------------------------------------------------------------------------------------------------------------------------------

**前言**
======

所谓壳，就是保护果实的俗称，加壳技术其意义在保护，就是让分析着或者工具看不到程序或者代码段的真实内容，将内容保护起来的一种手段，常见的壳基本分为三种：压缩壳，加密壳，虚拟壳，还有不常见的捆绑壳。

**正文**
======

  

**查壳**

想脱壳首先要知道对方采用了什么样的壳，最常见的方法利用节查看器，正常的程序应当如下所示。

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ0ibkuibbdacDPxhLfdFlaBLNXRNo4T1j89gzKhlibm4HcrsiaCOC7efKh329je2BGrdsRXGhvC4FjUJPQ/640?wx_fmt=png)

如果出现了其他区段，那么程序或者代码就有可能被加了壳，

这里推荐两款工具，一款是 PEID 和 DIE，我个人更喜欢 DIE，新版的 DIE 记录了更多壳的信息，信息也更加准确，PEID 相对的插件更多，也是大家耳熟能详的工具。

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ0ibkuibbdacDPxhLfdFlaBLNXaujs7DGJyQiaDvnO26mwvTfxNOlcD546U0ic2rMy2lKK4oNlgaoiaRic8w/640?wx_fmt=png) 

  

**压缩壳脱壳** 

压缩壳以 UPX 为代表，此类壳的功能已压缩为主，对文件的加密效果几乎没有，侦壳工具可以轻而易举地发现这些壳，也有较成熟的脱壳机来实现。所以当文件有较高的存储性能要求，且代码保密程度是可以开源时，才比较适合使用此类壳处理。

https://github.com/upx/upx/releases

使用方法也很简单：upx -d 即可一键脱壳

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ0ibkuibbdacDPxhLfdFlaBLNXXcJohVQzkhlEtMVKQZHlQhv99Pjq89Ik1bmf8jnAvuY5TYgntowtwQ/640?wx_fmt=png) 

  

**加密壳脱壳** 

常见的加密壳有 ASProtect 和 Armadillo 穿山甲, 加密效果较强，但就像密码一样，没有破解不了的密码也没有脱不掉的壳，目前针对 ASProtect 好像已经有了可用的脱壳机，但一般通用的脱壳方法如下:

1. 用 OD 打开程序, 点击选项——调试选项——异常，把里面的√全部去掉！CTRL+F2 重载下程序.

2. 按 SHIFT+F9, 直到程序运行, 记下从开始按 SHIFT+F9 到程序运行的次数 n.

3. 重载程序, 再按 SHIFT+F9, 这次按的次数为上次让程序运行时的次数的 n-1 次.

4. 此时观察 OD 的右下角有一个 "SE 句柄", 这时我们按 CTRL+G，输入 SE 句柄前的地址！来到这个地址.

5. 在这里, 按 F2 下断点！然后按 SHIFT+F9 来到断点处！

6. 这时候我们已经跳过了所有异常, 然后去掉断点，按 F8 慢慢向下跟踪很快就到达 OEP 了.

  

**虚拟壳脱壳** 

虚拟技术应用到壳的领域，设计了一套虚拟机引擎，将原始的汇编代码转译成虚拟机指令，要理解原始的汇编代码，就必须对其虚拟机引擎进行研究，此壳可以说是现在市面上最难脱的壳，因为不容易拖干净，很少有完美脱壳的办法，但是壳总有能脱的方法，这里用简单 1.6x 来举例：

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ0ibkuibbdacDPxhLfdFlaBLNXaC0vpjh5R0PU1WNmfCEibjOz5uGYoIBicjOEYT0PbCGSqRsO6gdwl5gA/640?wx_fmt=png)

可以看到虚拟壳最基本的特征就是增加 vmp 的区段

打开 od 对 od 调试选项进行设设置:

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ0ibkuibbdacDPxhLfdFlaBLNXGQCmZm6J8cfr9ylPbibEcLkOQaM9bkESMTkrZiby8XUtqCKK9Es5IiaLg/640?wx_fmt=png) ![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ0ibkuibbdacDPxhLfdFlaBLNXT7DzpxsYiaAGTEpePplrteo1bO5Ne529avLTibmAEnT9xTRXNEU9AUuQ/640?wx_fmt=png)

然后运行程序 ctrl+G 用到一个断点：virtualProtectEx 下断点，然后查看区段，text 到 vmp1 以后有 6 个区段所有下完断点后运行 6 次

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ0ibkuibbdacDPxhLfdFlaBLNXsy7L0FnCllj6Vhfc7NmCUvWYPvF32MFUKSLKyGEK4CC2WFdolTGh3g/640?wx_fmt=png)

运行到第六次后查看 Address 返回地址，然后在 text 设置内存访问断点，运行后我们就跑出了虚拟机，如果出现乱码 ctrl+a 分析下代码，ctrl+D FF 25 然后删除分析代码 到 OEP

通过 ctrl+d 寻找相应编程的 push 例如 VB 就 push vb5 或者 vb6

**总结**
======

总的来说脱壳都是遵循一定的定律

最常用的就是堆栈平衡 (esp)：

用压缩壳举例，在运行程序以前，先运行了压缩壳，而压缩壳也可以看作是一个段子程序，调用这个子程序就需要入栈操作，汇编语言中称作 PUSH，调用栈在程序结束后，为了清空栈内数据，和返回调用程序所压入的地址，所以要出栈，简称 POP

具体操作如下：

1 开始就点 F8, 注意观察 OD 右上角的寄存器中 ESP 有没有变成红色 (这只是一般情况下, 更确切的说我们选择的 ESP 值是关键句之后的第一个 ESP 值)

2. 在命令行下: dd XXXXXXXX(指在当前代码中的 ESP 地址, 或者是 hr XXXXXXXX), 按回车

3. 选中下断的地址, 断点 > 硬件访问 > WORD 断点.

4. 按一下 F9 运行程序, 直接来到了跳转处, 按下 F8, 到达程序 OEP.

当然这只是其中的一种：

单步跟踪法，内存镜像法，命令查找法，末次异常法，通常在实战中这些方法都是综合起来使用。

逆向的学问太多了，能讲的很多，更多其实就是慢慢尝试，总结逆向的需要学习的就是，语言，调试，还有一定的分析。

点击进入同系列文章：

  

脱壳学习（一）- 计算机底层基础

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ0ibkuibbdacDPxhLfdFlaBLNXLR29Qm1FITicrRp64Fv6LFzNiasQiaytLpCEiaJibLWiaXk9m8FnAGdcyR0w/640?wx_fmt=png)

[脱壳学习（二）- 反 “反调试” 篇](https://mp.weixin.qq.com/s?__biz=MzI5MDE0MjQ1NQ==&mid=2247520155&idx=1&sn=ec86938d0d0a5d02ea00b12eb5a97722&chksm=ec26ae03db512715d86112e5919ba38f30f97a1efb37126c3866c0f0456c325339379928c1b5&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ0ibkuibbdacDPxhLfdFlaBLNXLR29Qm1FITicrRp64Fv6LFzNiasQiaytLpCEiaJibLWiaXk9m8FnAGdcyR0w/640?wx_fmt=png)

### **往期回顾**

01

  

[后渗透之 windows 中无文件落地执行方法](https://mp.weixin.qq.com/s?__biz=MzI5MDE0MjQ1NQ==&mid=2247525191&idx=1&sn=c2d1b7cb8270858c0ddbc11bb60026d5&chksm=ec2642dfdb51cbc921467e421662bc6f70f595d93e5bcf61276cbffb33ab82d3fa3502ea17cd&scene=21#wechat_redirect)  

02

  

  
[网络空间搜索引擎使用技巧](https://mp.weixin.qq.com/s?__biz=MzI5MDE0MjQ1NQ==&mid=2247524697&idx=1&sn=852dfdb59b30beb93d3b7aa8cb03a930&chksm=ec2640c1db51c9d752256fa2fbb0a3e32c476ea510d7a1cd242438d477aece3c31a3e1cb7ce6&scene=21#wechat_redirect)  

03

  

[  
](http://mp.weixin.qq.com/s?__biz=MzI5MDE0MjQ1NQ==&mid=2247516613&idx=1&sn=be28c29022335c68d6048dc45da4bdd7&chksm=ec26a05ddb51294bfd8ab5c9199d64eae120b895782a5eb52b4d9bdf42d2455662858126051b&scene=21#wechat_redirect)[两个账户劫持案例](https://mp.weixin.qq.com/s?__biz=MzI5MDE0MjQ1NQ==&mid=2247521375&idx=1&sn=761542f38880711581c79a3bb7001709&chksm=ec26b5c7db513cd1bd7b90764370343fa0338e0c1dd04438f382e79a79eda27981bb7bf9a65b&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08P2lHs2gMuphdmUxyKIQR1YoniczDqibgwjKkLqegFsBvq5bdUibgAhzoJnJuaHEYGZ7icTO3MNaIWjg/640?wx_fmt=png)

**雷石安全实验室**

商务咨询：

0571-87031601

商务邮箱：

mtn@motanni.com

![](https://mmbiz.qpic.cn/mmbiz_gif/RXib24CCXQ09P8KpHiakzNxaeiaNpy9QJOicjS63gTVQ57eX4n7jnfk65micFGf1RP4kWh87kuM8w5dO5s6vsSx49yw/640?wx_fmt=gif)

觉得文章不错，记得【点赞、在看、转发】！！！