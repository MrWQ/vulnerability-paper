> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/fM4eJEvHH8GhvJZQwzxpfA)

**01、概述**

很多开源组件封装成容器镜像进行容器化部署在提高应用部署效率和管理便捷性的同时，也带来了一些安全挑战。一旦开源系统出现安全漏洞，基于资产测绘就很容易关联到开源组件，可能导致被批量利用。

在本文中，**我们将分享一个真实的 Docker 容器应急实例，涉及到基于开源组件漏洞披露的前后时间段内，容器遭遇挖矿程序植入的情况**。我们将深入分析排查过程，还原入侵的步骤和手段，帮助读者了解应对挖矿程序入侵的实际应急操作。

**02、分析排查**

（1）使用 top 命令查看，发现 kdevtmpfsi 进程异常，CPU 占用率 199%。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ia0LvkyJzB4kYd0DHwNhmicKMd3FPEBqe5mhfKibmZUGssFqiaQt6cc6Vpic0hSm8lwUDicgancSvZHia7GO8lbSbJPFw/640?wx_fmt=png)

（2）通过进程 PID 和 USER 查看进程信息，通过进程链定位到进程所在容器的进程 PID。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ia0LvkyJzB4kYd0DHwNhmicKMd3FPEBqe5zGKJvXicUI4Ah41KPVdb3zLa3NeVNSBAONsGqGl4beQ0NJt5iaaBQldA/640?wx_fmt=png)

（3）通过进程 PID 查找对应容器名称，容器名：metabase。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ia0LvkyJzB4kYd0DHwNhmicKMd3FPEBqe5c21c8FoTuWI8LNCeiaESvL8ias6PxZl2Wx0Fjha6gEuHZg5KUezAzZUg/640?wx_fmt=png)

（4）使用 docker top 查看容器中的进程信息，找到到容器内异常进程。如下图：异常进程 kdevtmpfsi（PID:5613）对应的父进程为 JAVA 进程 (PID:2301)。**据此，可初步判断，java 应用被入侵，导致容器被植入挖矿木马。**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ia0LvkyJzB4kYd0DHwNhmicKMd3FPEBqe5daUHHkWHoPuDBhbdiaajdF6ibAKGcrwZKaWR9mtnia1lNyjV39PuL4hww/640?wx_fmt=png)

**03、溯源分析**

（1）使用 docker logs 查看容器日志，并通过异常信息定义到漏洞触发的位置。如下图：通过 POST 提交请求，使用 wget 和 curl 命令下载挖矿脚本并执行。

```
docker logs metabase

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ia0LvkyJzB4kYd0DHwNhmicKMd3FPEBqe5Ar7kpABOqdB8pzib3TibcHqACAweBeKqQicibHPaicrfF8zxmcDIKfFxn2A/640?wx_fmt=png)

（2）查看运行的容器对应的镜像版本，对应的镜像为：metabase:v0.46.4

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ia0LvkyJzB4kYd0DHwNhmicKMd3FPEBqe5AExTAEBichJ218wrlceIPLHMRSzbdgWblDVKC5LMibW4ZxKeaA0PRLug/640?wx_fmt=png)

（3）通过日志信息和镜像版本，可进一步关联近段时间的威胁情报：开源 BI 分析工具 Metabase 中存在远程代码执行漏洞。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ia0LvkyJzB4kYd0DHwNhmicKMd3FPEBqe5DWdOpUENwodthq3KibT2mXANiaptOo8bwSGUfZ25lwHPYmA057OpkoJA/640?wx_fmt=png)

（4）漏洞复现，通过 exp 成功执行命令，确认当前使用镜像存在远程命令执行漏洞。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ia0LvkyJzB4kYd0DHwNhmicKMd3FPEBqe5cCU0xuTq0CRVJO6yzc82jhsv6DSuciaZgIgibgzJrurSIVQXSMOEzR8Q/640?wx_fmt=png)

**综上，攻击者通过利用 metabase 远程命令执行漏洞对暴露在外网上的服务进行攻击并下载并执行挖矿程序。**

**04、解决问题**

（1）保留入侵痕迹，使用 docker commit 保存为镜像，可作为 demo，用于检测容器安全产品的能力或其他用途。

```
docker commit -m "CoinMiner"  -a "bypass"  b4536a12a341  bypass007/miner:1.0

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ia0LvkyJzB4kYd0DHwNhmicKMd3FPEBqe5EsM7jFgQxNic7Md60EnicHeaJKnOQKqEfl0wPjZLPpoNWSq4N2w5SB2w/640?wx_fmt=png)

（2）使用 docker diff 命令查看容器内文件状态变化，通过容器内文件的变化，可以简单地窥探攻击者入侵容器的蛛丝马迹，做了什么操作，改了哪些系统文件。

```
docker diff metabase

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ia0LvkyJzB4kYd0DHwNhmicKMd3FPEBqe5nREBhLiaKia06egN52enGmLHwd0rN5s0AlmHKfGmVYk8D5qpibIicNrSIg/640?wx_fmt=png)

（3）通过对 shell 脚本文件和挖矿样本进行分析，可以了解到更详细的行为。部分截图如下：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/ia0LvkyJzB4kYd0DHwNhmicKMd3FPEBqe5X4dItlZTllvQJxrd7qlUOwjbmx3kpUkOAtx6kmUtAlHUtG5KiayiaeIw/640?wx_fmt=png)

（4）在容器环境里，容器被入侵的清理比较简单，不用着急去清理容器内的挖矿或是后门，直接删除容器即可。**比较重要的是，根据定位的漏洞问题进行修复，重构容器镜像。**在这里，我们可以将 metabase 镜像升级到官方提供的最新修复版本，就可以完成本次容器应用漏洞应急的处置。  

**原创稿件征集**

征集原创技术文章中，欢迎投递

投稿邮箱：edu@antvsion.com

文章类型：黑客极客技术、信息安全热点安全研究分析等安全相关

通过审核并发布能收获 200-800 元不等的稿酬。

[更多详情，点我查看！](http://mp.weixin.qq.com/s?__biz=MjM5MTYxNjQxOA==&mid=2652885477&idx=1&sn=39e97a60d7b68d19569284654e74ffa1&chksm=bd59ad288a2e243e4d89b7c456fbd44a93d241c881075b342af22431d93dca56e52076ed75ce&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_gif/7QRTvkK2qC6iavic0tIJIoZCwKvUYnFFiaibgSm6mrFp1ZjAg4ITRicicuLN88YodIuqtF4DcUs9sruBa0bFLtX59lQQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

靶场实操，戳 “阅读原文”