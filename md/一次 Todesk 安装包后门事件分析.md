> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/uqu_sRQmztAjAM2chXcIOA)

**0x01** **事件发现**
-----------------

在日常搬砖的过程中，发现一位员工的终端由于 mmc.exe 启动了 cmd.exe 执行了一段混淆的指令，从而触发了告警。命令行使用了字符串替换来混淆指令，很像灰黑产常用的手段。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxzyyLnFjEmCDLFrPLZCXzyotRUybOQGa4oTvC7QavianFn5iciaZ8uQZfw/640?wx_fmt=png)

根据终端日志定位到了行为来源是非官方的 todesk 安装包。

**0x02 日志分析**
-------------

运行这个 todesk 安装包，通过抓取样本运行时的日志，发现 todesk 安装包执行后，会在临时目录下释放并启动 irsetup.exe

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxte2m4jWCK10MjbjNiaNsmpwbpWgzXbK14RyFm54riaJf8QWxHqXReEnA/640?wx_fmt=png)

irsetup.exe 创建 Your Product 安装目录，在里面释放并启动 IEManager 相关的文件；之后 irsetup.exe 还释放并启动了一个官方的 todesk 安装包（经 MD5 和签名校验，为官方安装包），来进行正常的 todesk 安装。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxPqria9ZNWXm5ia5rGv8FoujS4l1fCOQ4oBULrfsMDX7R6FCdHJtIiaw4g/640?wx_fmt=png)

IEManager.exe 执行起来之后，从 118.107.14.42:4388 拉取了一个 NumenLibrary.dll 放到 C:\Users\Public\Documents\NumenLibrary.dll：

![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAx1pnxgMU05TSQHrIgyXialtibtgxEhcRzzROuAHTFd8ueXm9EJ80h0Wuw/640?wx_fmt=jpeg)

IEManager.exe 还释放了 NumenClean 主程序 Powermonster.exe 和一些后续持久化所需的文件。随后原始安装包和 irsetup.exe 退出。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxo3R8wZtBKZfWkm9ushI17InYYblGGjbE6YESCvWGvLZgrdYibB5fdqQ/640?wx_fmt=png)

从终端安全设备的日志中还可以看到，后面 IEManager.exe 会启动 wscript.exe 来执行 Server.vbe，虽然 vbe 文件被混淆了，但通过终端日志 + 后续对其他文件的分析来看，是为了通过 DCOM 的方式让 mmc.exe 调用 cmd 执行 unzip.exe，来解压出一个指向 Powermonster.exe 的快捷方式文件释放到自启动目录实现持久化。这样做应该是为了 BypassUAC。

由于企业终端安全设备日志涉及敏感信息，懂得都懂，这里就不放图了

在后续的日志中也可以看到被执行的、部分解混淆的告警中的命令，如下，其实就是实现了解压 unzip.dat：

cmd/c C:\Users\Public\Documents\unzip.exe -o -P Startup8888 C:\Users\Public\Documents\unzip.dat -d "C:\Users\ 不能透露 \AppData\Roaming"

随后就看到 unzip.exe 释放了一个快捷方式在自启动目录，还有一个 server.dll。可以推断 lnk 文件就是上一步被解压出的文件。

然后 Powermonster.exe 被 IEManager.exe 启动，过了一会也退出了。未出现其他的可疑行为。

至此，根据日志分析情况，我们需要知道被写入自启动目录下的 lnk 文件的指向，以及释放的这些文件是否恶意。

**0x03 样本分析**
-------------

在之前的日志分析中，我们已经清楚后门安装包运行后，会先释放启动 irsetup.exe 来释放启动 IEManager.exe 和启动它所需的其他文件，然后由 IEManager.exe 在 C:\Users\Public\Documents 目录释放启动 Powermonster.exe 及相关的其他文件。

前两个程序运行完毕之后都会退出，所以只需要分析 C:\Users\Public\Documents 下的文件以及释放在自启动目录中的文件即可。如下是在虚拟机执行样本后，获取到的 C:\Users\Public\Documents 文件目录。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxP7AJRoxh3j6CB6cutuF1icyicwPWZJk3kjl8vRFnbXmnLicHEa70c8iarQ/640?wx_fmt=png)

首先查看 unzip.lnk 的指向，发现其中的内容与在告警中看到的一致，说明告警的命令行就是因为执行了该 lnk 触发的。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxEAtymbCKvTias9zyjxMT0bWKQCLZBeMrMozqyxsr061IIRWcFcwn71A/640?wx_fmt=png)

对快捷方式的命令进行替换字符串解混淆，发现 server.dll 无实际意义，该指令主要是为了调用 unzip.exe 解压 unzip.dat，实际关键的命令为 cmd /c C:\Users\Public\Documents\unzip.exe -o -P Startup8888 C:\Users\Public\Documents\unzip.dat -d "C:\Users\50443\AppData\Roaming"，与在日志中看到的一致。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxdDeAWQo8LxUIKl2knbpTwjcnGrJqfK4oaAYTlubP1hz0REh3p1KUgQ/640?wx_fmt=png)

手动执行下该指令，发现效果是在自启动目录下释放一个 lnk 文件，该文件指向 C:\Users\Public\Documents\ 下的 Powermonster.exe，与日志分析的结果一致。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxIGXick1WXDX6Y0qILOzpJBHPKGEHKZLkrqRZdkgbHGnwsPDeJEiarR6w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxkwEBfVREOdFezOGBL6pgtC9XB8vuH8JiaxC8jU5KFSdtAtN9iaMUUSBA/640?wx_fmt=png)

server.vbe 虽然被混淆，但根据上面的日志分析，结合 unzip.lnk 的内容，能推断出 vbe 的能力是通过 DCOM 的方式来调用 mmc.exe 执行 lnk 文件，为了提权或规避检测。由于 lnk 中启动了 cmd，所以在终端安全设备日志中看到的是 mmc.exe 启动了 cmd.exe。 ![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxYpib7BIRr8l2m3tWuscf70djuZI0dFQibF3HKzNaE4ibkK3fjvB3BeX3A/640?wx_fmt=png)

综合上面的分析，样本所有的操作都是为了启动 Powermonster.exe 并实现自启动持久化，相关目录下面的所有文件功能分析总结如下：

Powermonster.exe 是执行和持久化的最终目标；

NumenLibrary.dll 是整个流程正常执行需要加载的 dll；

unzip.exe 是用来解压 dat 文件的；

Server.dat 可被解压为下面这些文件（实际上已经被 IEManager 直接释放了）；

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxM8ibfiadYicM1YK2pL1bhiaMaQvSlaFkQ3Pzc5Y2GLUsNjUgraWmCWNobA/640?wx_fmt=png)

unzip.dat 可被解压为指向 C:\Users\Public\Documents\Powermonster.exe 的快捷方式；

Server.vbe 被 wscript 调用，用于通过 DCOM 的方式启动 unzip.lnk；

unzip.lnk 指向一段被混淆的指令，指令内容为 cmd 启动 unzip.exe 解压 unzip.dat，将解压出的文件放到自启动目录下；

还有图中没有的 Server.dl，根据解混淆的指令可知没有实际意义，里面只写入了一串 Server 字符串。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxP7AJRoxh3j6CB6cutuF1icyicwPWZJk3kjl8vRFnbXmnLicHEa70c8iarQ/640?wx_fmt=png)

Powermonster.exe 经过沙箱和云查鉴定，是安全的。看它的以及属性信息，确认为是 NumenClean 垃圾清理工具的主程序。

 ![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxMDNBCB3VB2wJTLcibdlYSOqAv5EjX0Brau9dYA1rRRawGr4M11w9Mhw/640?wx_fmt=png)

于是当天我就把该事件定性为了高级的流氓软件捆绑推广事件，但是晚上睡觉的时候越想越觉得不对劲，如果只是一个流氓推广，为何要弄得如此复杂，事情肯定不会这么简单。由于该样本使用的捆绑传播、提权、持久化手法与灰黑产攻击极为相似，不像普通流氓软件的作风。

在前面的日志分析中，我们发现 IEManager.exe 执行起来之后，从 118.107.14.42:4388 拉取了一个 NumenLibrary.dll 放到 C:\Users\Public\Documents\NumenLibrary.dll，如果只是为了捆绑安装一个正常的软件，为何还需要远程拉取一个要加载的 dll，而不是直接释放（之前以为 NumenLibrary.dll 是软件运行起来所需的一个正常 dll，就没有深入分析）。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxUjqbBTwbeLTD5MaW7DEhDOzKoYlXqVqawkQLzH6xtsjBQIp3ibCQ6jA/640?wx_fmt=png)

第二天，我将 NumenLibrary.dll 放入沙箱中分析，发现有远程请求 150.242.98.207 拉取 PE 文件执行的行为，以及通过后续的威胁情报关联分析，也确认了是 Farfli 家族木马。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAx91XEoM1lu5iarwyPNmV5s2zLwLvhDoZniceEOrkE8ib6StIZkiczkrg2Ow/640?wx_fmt=png)

Powermonster.exe 确实会加载 NumenLibrary.dll：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxYpRUHUd2gN0UvUZnALEgAkctxUt21dXnmuOOiccFhdiboYcasicZIP7icg/640?wx_fmt=png)

随后外联了 150.242.98.207：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxaicDBpruHFSAYnjT20BYWib9PhN6176y1ly6L6zNcEvTgzCrnUIwzCicg/640?wx_fmt=png)

查看外联动作的堆栈调用，发现确实是在 NumenLibrary.dll 中调用了外联函数。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxiaxouZ0utHMpu9uI3icbiazwSeScE14wGmLTVicylmbG8DmoaYicQ9FfPJg/640?wx_fmt=png)

由此确认这一阶段是通过白进程加载黑 DLL 的方式来执行。

如果将 NumenLibrary.dll 删掉，启动主程序，会报错缺少 dll，随后正常启动软件：

 ![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxtHY9Ucib47anOVt6WeJ4My92xNYdic69R1g6lxcqyt1P1ftUF5Knb11w/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxCDqKXticicNcSCOTPmhvzPQg7TtD2toCCJ1C0jw07FOuw1Jz4wLoBMEw/640?wx_fmt=png)

由于目前远程拉取 PE 的连接已经无法访问，http://150.242.98.207/pserver.exe 已经获取不到，无法进一步分析。

**0x04 威胁情报分析**
---------------

150.242.98.207 查询威胁情报，发现虽然情报是未知，但是有许多关联的样本：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAx739IMpLdRu203oUWJ7ibMe8VKWJb8iaLLbuvqWQTGIU3NyAWsklb4Thg/640?wx_fmt=png)

点进去其中几个样本，发现这些木马具有相同与本次事件样本的行为，远程下载 http://150.242.98.207/pserver.exe 并执行，与本次事件关联密切，是同一组织所为：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxJDdzbJRiaTj0mib85wZ4wjKZ4rRccwc3vucAR9q7cn2GwLle0Xzr04Qw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAx0LInCwGoyuKk1Z4d3ONhmoXiaY2FmwicSOSdZ6lDDUQ6Ietb6Ljd8z5g/640?wx_fmt=png)

至此可以得知，本次事件是一次 Todesk 安装包捆绑 Farfli 木马后门的软件投毒事件，由于最后阶段的木马远程链接失效，所以才没有在日志中看到 Powermonster.exe 的可疑行为。

根据威胁情报的时间来看，样本的出现时间集中在 4 月，应该是一种比较新的 Farfli 变种。

**0x05 攻击流程**

根据上面的分析，后门安装包在第一阶段释放启动的 irsetup.exe 是为了释放启动正常的 todesk 安装包和 IEManager.exe。

IEManager.exe 用于安装启动 Powermonster.exe，并远程拉取 NumenLibrary.dll 放在安装目录下供 Powermonster.exe 加载，并实现 Powermonster.exe 的持久化。

Powermonster.exe 启动，加载 NumenLibrary.dll 后，执行 NumenLibrary.dll 中的恶意代码，远程下载执行木马程序。

整体攻击流程如下（真的好复杂 T _ T）：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxxlA9CicBF0GtsRib5k8OJdGVzaZFEIf1MmQc4voibWia2qkKNRRaWqicPxg/640?wx_fmt=png)

**0x06 溯源分析**
-------------

通过员工终端的 DNS 解析日志，找到终端运行 todesk 安装包之前的 DNS 解析记录，发现了一个 todesk 相关的域名：todesk.sdfblk.cn。

进入网站之后，发现并不是官网，是伪造的，点击下载，会跳转到一个下载界面，下载之后校验一下 MD5，发现确实是中招员工下载的。但是目前该下载链接已经是 404 了

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxpR0icPP1dwnrAgswTJBBzaOIG71B2g6gsMlEG81b8ezmX8Zo49nHBicA/640?wx_fmt=png)

目前威胁情报对仿冒 todesk 官网的域名仍是未知状态，这个域名也是最近注册的:

![](https://mmbiz.qpic.cn/sz_mmbiz_png/975QoDl7XibTrO3YvqtJtksq4Qf2iabPAxp6NibI4ePNmdpO5z6kkp8Q0YRdUXuefcd2LHabdLWEB48uOHWe24fXQ/640?wx_fmt=png)

**0x07 IOCs**
-------------

Todesk_setup.exe

4bfb4f472472d92f8ac458bef01e9d6c

numenlibrary.dll

1faada15997e3ed3de052b1d81064298

Powermonster.exe

72c495e9ee7b5bbae6230eae7592f246

todesk.sdfblk.cn

http://222.186.174.76:4561/1/Todesk_setup.exe

http://118.107.14.42:4388/NumenLibrary.dll

http://150.242.98.207/pserver.exe

**PS：大家从网上下载软件工具的时候，一定要去官网，并仔细核对域名哦~**