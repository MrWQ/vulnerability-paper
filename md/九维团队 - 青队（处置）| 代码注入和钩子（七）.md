> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247503136&idx=1&sn=74d0fe73843239bfce2037ad488d3f62&chksm=9ae18c18ad96050eecbd3ec3c596feb0d626b9ffcb4856814f80f6a46d9c03187dc4ae0d57ed&scene=178&cur_album_id=2617884898938290179#rd)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOQ4y3CslMX5EINOxRsoicGxHxJnwtXjIau4usI94yHUKXTqh4LyuVL4A/640?wx_fmt=gif)

**写在前边**

  

1. 本文原文为 K A, Monnappa. 2018 年发表的《Learning Malware Analysis》，本文的相关内容均为笔者对相关内容的翻译及实践记录，仅供各位学术交流使用。另出于易读性考虑，对部分字句有所删改。 

2. 如各位需要引用，请做原文引用，格式如下所示： 

[序号]K A, Monnappa. LearningMalware Analysis[M]. 2018.06. Published by Packt Publishing Ltd. Livery Place 35 Livery Street Birmingham B3 2PB, UK. 

3. 因文章整体内容较长，完整内容将会在本公众号拆分为多篇内容分别发出。本文为该系列的第七篇。

[往期内容请参见合集《Learning Malware Analysis》](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAwMDgyNTQzMQ==&action=getalbum&album_id=2617884898938290179&scene=173&from_msgid=2247502411&from_itemidx=1&count=3&nolastread=1#wechat_redirect)

  

  

**四**

**钩子技术**

  

  

到目前为止，我们已经看了不同的代码注入技术来执行恶意代码。攻击者将代码（主要是 DLL，但也可以是可执行文件或 shellcode）注入合法（目标）进程的另一个原因是为了勾住目标进程的 API 调用。一旦代码被注入到目标进程中，它就可以完全访问进程内存，并可以修改其组件。改变进程内存组件的能力允许攻击者替换 IAT 中的条目或修改 API 函数本身，这种技术被称为钩子。通过钩子 API（hook api），攻击者可以控制程序的执行路径，并将其重新引导到他选择的恶意代码中。然后，该恶意函数可以：

* 阻止合法应用程序（如安全产品）对 API 的调用。

* 监控和拦截传递给 API 的输入参数。

* 过滤从 API 返回的输出参数。

在本节中，我们将研究不同类型的挂钩技术。

**4.1**

**IAT 钩子**

####   

如前所述，IAT 包含一个应用程序从 DLLs 导入的函数地址。在这种技术中，当一个 DLL 被注入到目标（合法）进程中后，被注入的 DLL 中的代码（Dllmain() 函数）会钩住 IAT 中目标进程的入口。下面给出了用于执行这种钩子步骤的高级概述：

* 通过解析内存中的可执行镜像，找到 IAT 的位置。

* 确定要钩住的函数的入口。 

* 用恶意函数的地址替换该函数的地址。  

 为了帮助各位读者理解，下面让我们看一个合法程序通过调用 DeleteFileA()API 来删除一个文件的例子。

DeleteFileA() 对象接受一个参数，即要删除的文件的名称。下面的截图显示了合法程序（在上钩之前）正常通过 IAT 确定 DeleteFileA() 的地址，然后在 kernel32.dll 中调用 DeleteFileA()。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKvZianUGm4mNfvfPj5e4NwTf8J9tKXGjRyMJXU7vBzibqk0fQfNOHWeTH1sntmzCwnoyNh7fLvrlnQ/640?wx_fmt=png)

当程序的 IAT 被钩住时，IAT 中 DeleteFileA() 的地址被替换为恶意函数的地址，如下所示。

现在，当合法程序调用 DeleteFileA() 时，该调用被重定向到恶意软件模块中的恶意函数。恶意函数随后调用原来的 DeleteFileA() 函数，以使它看起来一切正常。在中间的恶意函数可以阻止合法程序删除文件，或者监视参数（正在被删除的文件），然后采取一些其他动作。  

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKvZianUGm4mNfvfPj5e4NwTfXLGZVLhyZPXxrLUteEmU9Vy60IPtKbWh5lGwAVbibrpXibOPRmHGib4g/640?wx_fmt=png)

除了通常在调用原始函数之前发生的阻断和监控之外，恶意函数还可以过滤输出参数，这发生在重新调用之后。这样，恶意软件可以钩住显示进程、文件、驱动、网络端口等列表的 API，并过滤输出以躲避使用这些 API 函数的工具。

对于使用这种技术的攻击者来说，其缺点是如果程序使用运行时链接（动态链接），或攻击者希望钩子的功能已作为表的内容导入，此时它就不起作用。另一个缺点则是 IAT 钩子很容易被发现。在正常情况下，IAT 中的条目应该位于其相应模块的地址范围内。例如，DeleteFile() 的地址应该在 kernel32.dll 的地址范围内。

为了检测这种挂钩技术，安全产品可以识别 IAT 中不在其模块地址范围内的条目。在 64 位 Windows 上，一项名为 PatchGuard 的技术可以阻止对包括 IAT 在内的调用表进行修补。由于这些问题，恶意软件作者使用了一种略微不同的钩子技术，接下来将讨论这个问题。

**4.2  
**

**内联钩子 inline hooking**

**(内联修补)**

####   

IAT 钩子依赖于交换函数指针，而在内联钩子中，API 函数本身被修改（打补丁）以将 API 重定向到恶意代码。与 IAT 钩子技术一样，这种技术允许攻击者拦截、监测和阻止特定应用程序的调用，并过滤输出参数。

在内联钩子中，目标 API 函数的前几个字节（指令）通常被一个跳转语句所覆盖，该语句将程序控制重新引导到恶意代码。然后恶意代码可以拦截输入参数，过滤输出，并将控制权重定向到原始函数。

为了帮助大家理解，让我们假设一个攻击者想钩住一个合法应用程序所做的 DeleteFileA() 函数调用。通常情况下，当合法应用程序的线程遇到对 DeleteFileA() 的调用时，该线程会从 DeleteFileA() 函数的起点开始执行，如下所示。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKvZianUGm4mNfvfPj5e4NwTiahhrpk4MoKOyfO842ld6ZTh6JElWhwURufnMBPwgn76FtorhrUYnOQ/640?wx_fmt=png)

为了用跳转取代函数的前几条指令，恶意软件需要选择一些指令来取代。jmp 指令至少需要 5 个字节，所以恶意软件需要选择占用 5 个字节以上的指令。

在上图中，替换前三条指令（使用不同颜色突出显示）是安全的，因为它们正好占用 5 个字节，而且这些指令除了设置堆栈框架外，没有什么作用。在 DeleteFileA() 中要替换的三条指令被复制，然后用某种跳转语句替换，将控制权转移到恶意函数中。

恶意函数做它想做的事，随后执行 DeleteFileA() 的原始三条指令，并跳回位于补丁下面的地址（在跳转指令下面），如下图所示。被替换的指令，连同返回目标函数的跳转语句，被称为蹦床。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKvZianUGm4mNfvfPj5e4NwTVshdKHklZuemUoHE7158m5jR1HG9k9mLNLroTbbosHDWZFQRicib151g/640?wx_fmt=png)

这种技术可以通过寻找 API 函数开始时的意外跳转指令来检测，但要注意的是恶意软件可以通过在 API 函数中插入更深的跳转，而不是在函数开始时插入，从而使检测变得困难；或是使用恶意软件可能会使用 call 指令，或 push 和 ret 指令的组合来重定向控制。这种技术可以绕过安全工具，因为安全工具只寻找 jmp 指令。

有了对内联钩子的了解，让我们来看看恶意软件（Zeus Bot）使用这种技术的例子。

宙斯机器人钩住了各种 API 函数；其中之一是 Internet Explorer（iexplore.exe）的 HttpSendRequestA()。通过钩住这个函数，恶意软件可以从 POST 有效载荷中提取凭证。在挂钩之前，恶意可执行文件（包含各种功能）被注入到 Internet Explorer 的地址空间。下面的截图显示了地址 0x33D0000，可执行文件被注入其中。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKvZianUGm4mNfvfPj5e4NwTDYlIe4ytnuFN6jBBbWf5rFLLUN76OnbRkyb94VEuMicq6NwK2Erl8Qg/640?wx_fmt=png)

在注入可执行文件后，HttpSendRequestA() 被钩住，将程序控制重定向到注入的可执行文件中的一个恶意函数。在我们看这个被钩住的函数之前，让我们看一下合法的 HttpSendRequestA() 函数的前几个字节（如图所示）。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKvZianUGm4mNfvfPj5e4NwTnq5A5gDhj7fCgcF62BbthLsN0MrbjYia3WER2usouXp0MkiaQJ6jJA4Q/640?wx_fmt=png)

前三个指令（占用 5 个字节，在前面的截图中突出显示）被替换为重定向控制。下面的截图显示了挂钩后的 HttpSendRequestA()。前三条指令被替换为 jmp 指令（占用 5 个字节）；注意跳转指令是如何将控制权重定向到地址为 0x33DEC48 的恶意代码上的，这属于注入的可执行程序的地址范围。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKvZianUGm4mNfvfPj5e4NwTPbqks1LVA9KRg4ntFeXiabf9bhOsU01COa12g6tXGhnZSRQeb7OXtQQ/640?wx_fmt=png)

（未完待续）

* * *

**—  往期回顾  —**

[**![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL227ibOmpOzGD7zr7zB8uG0FSsoSmrNybqajdOARxTKWzckYaEGEhQl0jLb31nIGLSHdgnfly5sqw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)**](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502438&idx=2&sn=b71fbe730dc1b64749725f06178077b4&chksm=9ae18b5ead960248f0ebce96cd96f4259a4ade57c8e47b3d542e33fc428e10b4608f7e53bbd1&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLdOqKzEvNTbt0UNQ9AZAskCduhbzdLPnO948jTEiccyuzWp4FkahcNwMDRlKpOXrG44dw1FFI8SpQ/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247503125&idx=1&sn=04ae48783eeff01f680205c836d8d87a&chksm=9ae18c2dad96053b4886a0c2a7c0790d5347f80551c4b2c66acdd47c55d7ea603ebc05aa585f&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKgESot71qPsaibQVndxZunibJyyxWT3jzjHHFHY0bbHKibSWQQD74kic1A1GWeEXHR6CIdRma7swau5g/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247503112&idx=1&sn=1f749451cd29f37cf4ab219182636725&chksm=9ae18c30ad9605264bf3f1d4ce17af1cea8594c6f33c835664e536b68edcb20ae75fdf9b394f&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zJMic1ygGSRUYacHY51PKr2frWlCt5vozMkXlysB1r3ibWsYpbP3KCUwgxqzWbUROxGRxovkgtQx9aQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502979&idx=1&sn=022ff3660eec28222f4e7b3604811523&chksm=9ae18dbbad9604ad0835205233aa337ef2368147462f71c68fdd3ac7aca8d99160ee281afb25&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKfkZV2bdiaOZt293ial0ibfapCeOggic8wb9B9KiaqztDaaczam3R4MJrX0bC25nYJrMicE1ib9ddYUhyUA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502937&idx=1&sn=68012b0b90bac5fc405e4f71b7446726&chksm=9ae18d61ad96047786bd37af5814be76c660707b0f704d722fdde8c033b35e6253d3eaf40f84&scene=21#wechat_redirect)

  

**关于安恒信息安全服务团队**

**安恒信息安全服务团队由九维安全能力专家构成，其职责分别为：红队持续突破、橙队擅于赋能、黄队致力建设、绿队跟踪改进、青队快速处置、蓝队实时防御，紫队不断优化、暗队专注情报和研究、白队运营管理，以体系化的安全人才及技术为客户赋能。**

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIFIDZlXFuQeZrcKrV7Zd8Aeg98Fw5jzbGBgUW1hVQXIV3YpLZncEYibgw7MFwWtDU5vwnE2QFVP7A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLzGUib2ia6F1ribVUnfRj2ibJY20XR9ug0dL1k1V6bOtbUgBw1diarLHgZPuz6dny9G7o2hmwRdgT1RJA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOCUgD3ep5Jp4DE8e2S2Y3WnxsKjicicOg3OsGGRc9NPibQ61aRAqNXZQDA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)