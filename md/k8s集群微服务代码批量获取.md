> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/HXlnmmDOP_Ha7hyKxMw2FA)

背景
==

最近测试k8s微服务，大概有几十个微服务，需要下载这些微服务的代码，单行命令去cp效率太低。![图片](https://mmbiz.qpic.cn/mmbiz_png/V0QaUkGPBe8iaoA5Fqt7ib94UrkjZevuQA5popSUok3HUzwddc38W7uA1GWWl9tvFuianrc8HK8dicFtC6Qb3rpXcQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

知识
==

第一步：获得k8s所有的命令空间

```
# 列出所有 namespace 中的所有 pod  
$ kubectl get pods --all-namespaces  
# 列出所有 pod 并显示详细信息  
$ kubectl get pods -o wide  

```

第二步：与运行中的 Pod 交互

```
#进入pod  
# 在已存在的容器中执行命令（只有一个容器的情况下）  
$ kubectl exec my-pod -- ls /  
# 在已存在的容器中执行命令（pod 中有多个容器的情况下）  
$ kubectl exec my-pod -c my-container -- ls /  
#交互式进入pod  
$ kubectl exec -ti storage -- bash  
root@storage:/data#  

```

第三步：复制VM文件到Pod,或者从Pod拉取文件到VM

```
#复制文件到pod  
$ kubectl cp file pod:/path   
#复制pod文件到vm  
$ kubectl cp example-pod:/tmp/example-dir ./example-dir  

```

这里可能存在多个命令空间namespaces,可以使用`--namespace example-namespace` 也可以直接添加namespace:

```
kubectl cp example-namespace/example-pod:/tmp/example-dir ./example-dir  

```

工程化
---

方案一：需要提前预置namespace

```
echo "start list all pods!"  
array=(mbc mbi mmc mms usg wss)  
for namespace in ${array[@]}  
do  
      pods=` kubectl get pods -n $namespace -o wide|awk 'NR>4{print p}{p=$1}'|sort|uniq|grep -v "NAME"|grep -v "icagent"|grep -v "everest"|grep -v "otel"|grep -v "istio" |grep -v "coredns"|grep -v "logging-aggregator"`  
      for pod in $pods  
      do  
         tarPod=`kubectl exec -it $pod -n $namespace -- /bin/bash -c "find / -name '*.jar' -o -name '*.class' 2>/dev/null|grep -v '/tmp'|grep -v '3rdComponent'|xargs tar -zcvf /tmp/$pod.tar.gz"`          podCpLocal=`kubectl cp $pod:/tmp/$pod.tar.gz $pod.tar.gz -n $namespace`  
      done  
done  
echo "end list  all pods!"  

```

方案二：

```
echo "start list all pods!"  
  
IFS_old=$IFS  
pods=`kubectl get pods --field-selector=status.phase=Running --all-namespaces|grep -v "monitoring"|grep -v "kube-system"|grep -v "istio-system"|grep -v "common"|awk 'NR == 1 {next} {print $1,$2}'|sed -n p`  
IFS=$'\n'  
for pod in ${pods}  
do  
      namespace=`echo $pod|awk -F" " '{print $1}'`  
      podid=`echo $pod|awk -F" " '{print $2}'`  
      #echo "${namespace} ${podid}"  
      tarPod=`kubectl exec -it $podid -n $namespace -- /bin/bash -c "find / -name '*.jar' -o -name '*.class' 2>/dev/null|grep -v '/tmp'|grep -v '3rdComponent'|xargs tar -zcvf /tmp/$podid.tar.gz"`  
      podCpLocal=`kubectl cp $podid:/tmp/$podid.tar.gz $podid.tar.gz -n $namespace`  
done  
IFS=$IFS_old  
echo "end list  all pods!"  
  

```

完美搞定，使用方便。

附录
==

1 https://jimmysong.io/kubernetes-handbook/guide/kubectl-cheatsheet.html

2 https://linuxhint.com/execute-bash-pod-kubectl/ 

3 https://www.rancher.cn/learning-paths/how-to-manage-kubernetes-with-kubectl/ 

4 https://www.cloudsavvyit.com/14811/how-to-copy-files-between-kubernetes-pods-and-your-machine/ 

5 https://learn2torials.com/a/kubernetes-cheat-sheet