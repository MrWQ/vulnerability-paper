> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/6VxLQr0UY_Eoz2f1p1VyQA) ![](https://mmbiz.qpic.cn/sz_mmbiz_gif/Tp9VOk1IaycpsK4AXvozeaMLYk7OBLQau8mDrsWslNiajkybyodE8HbkJ9ibPO7IofWw3S4sE38LyCWYSxSZMjkQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)

**免责声明**

由于传播、利用本公众号听风安全所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，公众号听风安全及作者不为**此**承担任何责任，一旦造成后果请自行承担！如有侵权烦请告知，我们会立即删除并致歉。谢谢！

公众号现在只对常读和星标的公众号才展示大图推送，

建议大家把听风安全设为**星标**，否则可能就看不到啦！

----------------------------------------------------------------------

**前言**

前几天看到很多关于某个输入法爆出 “漏洞” 的文章，其实早在七月份就有师傅在其他平台发出过相关视频，正好也有一段时间没写文章了就抽个时间来简单谈谈可以延伸的利用点，本篇文章重点不在输入法的利用，主要介绍如何使用 RDP 协议结合输入法进行利用。

**正文**
------

由于我个人就比较喜欢用 ** 输入法所以在看到相关详情的第一时间就进行了复现，确实可以成功复现。第一时间想到可以通过此方法来进行近源攻击可以快速的拿下要近源的目标机器。但是近源在实战里面用到的相对还是比较少的，然后就把目光转移到了远程连接这里。

正常远程连接一台机器是这样的 需要先输入账号密码才能进入界面

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IaydyZNKeTicz8HhA864NqZ0Q5Db8lzibCEpZssoo3s2vcrv0P2zfI5Brl9ibro7EdgbibbwwTWlS9eXSjw/640?wx_fmt=png&from=appmsg)

如果这种情况就不能通过漏洞来进行利用  

然后看到一篇文章[技术分享｜死磕 RDP 协议，从截图和爆破说起](http://mp.weixin.qq.com/s?__biz=MzI4MzcwNTAzOQ==&mid=2247528393&idx=1&sn=74961047a04f95115cb9eab084b1baef&chksm=eb848469dcf30d7fc97318feb7a4c1584dd9ed447d50e679a1a233914f245db1f943c2aa72c5&scene=21#wechat_redirect)这篇文章介绍了 RDP 协议相关的内容有兴趣的师傅可以看看，文中说 goby 可以在不输入账号密码情况下来进行截图，截图并不是我们的关注点，但是要截图不就已经进入了界面吗，用 goby 来试试

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IaydyZNKeTicz8HhA864NqZ0Q56xia86V25bk9hdMKGHcTIGzpkiamueiaI5HqrwLs62t7eibM46ib2oFSyoA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IaydyZNKeTicz8HhA864NqZ0Q5XSwBetkgDClfBIOPfu9opU0JHicqxO1pHBoGTrTyUGxYTnjbWPjB0fg/640?wx_fmt=png&from=appmsg)

发现 goby 确实可以成功截图

RDP 到目前为止已经迭代了好几个版本，本来是顺着上面文章中的思路，猜测可能使用低版本的协议可以直接进入到界面。不过这个时候正好看到一个师傅的项目（项目地址会在参考文章中给出），秉承着简单高效能用的原则放弃了上面的研究。其实跟低版本的思路差不多，因为高版本的协议都需要先进行认证再进入到界面比如 PROTOCL_HYBRID 和 PROTOCOL_HYBRID_EX  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IaydyZNKeTicz8HhA864NqZ0Q5Q0YN2PcHwuygiby0QvPsWAJTjGR7IkI47BCtRYwtjkP4MEREia0dyibRg/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IaydyZNKeTicz8HhA864NqZ0Q5ETJCNnRkSAaehP5XXRekZAlibsmnL5cvWxXolzuupJAuKoEMHb8Xc9g/640?wx_fmt=png&from=appmsg)

我们可以通过设置 要求连接时不使用 NLA 直接进行连接

使用以下配置文件即可

```
full address:s:127.0.0.1:3389
screen mode id:i:2
use multimon:i:0
desktopwidth:i:2560
desktopheight:i:1440
session bpp:i:32
winposstr:s:0,1,775,240,2025,1343
compression:i:1
keyboardhook:i:2
audiocapturemode:i:0
videoplaybackmode:i:1
connection type:i:7
networkautodetect:i:1
bandwidthautodetect:i:1
displayconnectionbar:i:1
enableworkspacereconnect:i:0
disable wallpaper:i:0
allow font smoothing:i:0
allow desktop composition:i:0
disable full window drag:i:1
disable menu anims:i:1
disable themes:i:0
disable cursor setting:i:0
bitmapcachepersistenable:i:1
audiomode:i:0
enablecredsspsupport:i:0
redirectprinters:i:1
redirectlocation:i:0
redirectcomports:i:0
redirectsmartcards:i:1
redirectwebauthn:i:1
redirectclipboard:i:1
redirectposdevices:i:0
autoreconnection enabled:i:1
authentication level:i:2
prompt for credentials:i:0
negotiate security layer:i:1
remoteapplicationmode:i:0
alternate shell:s:
shell working directory:s:
gatewayhostname:s:
gatewayusagemethod:i:4
gatewaycredentialssource:i:4
gatewayprofileusagemethod:i:0
promptcredentialonce:i:0
gatewaybrokeringtype:i:0
use redirection server name:i:0
rdgiskdcproxy:i:0
kdcproxyname:s:
enablerdsaadauth:i:0

```

保存为 RDP 文件就能使用  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IaydyZNKeTicz8HhA864NqZ0Q5GVE1Al4os7iayIiagDDHQtvl1ibc1Vj09vicpDHUewSxhZia8XrbFygVOnQ/640?wx_fmt=png&from=appmsg)

其中 enablecredsspsupport:i:0：代表是否启用 CredSSP（凭据安全服务提供程序）支持，这是一种用于 NLA（网络级别身份验证）的安全提供程序。0 表示禁用，1 表示启用。

然后使用此文件来连接刚才的目标机器

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IaydyZNKeTicz8HhA864NqZ0Q5KEx1qogOz5x8sZpXsRicIxUP8ia2vbVtfFGggicGpOUMvBq7Bk6lf0xGA/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IaydyZNKeTicz8HhA864NqZ0Q5zKLibm3KwAL0TKPiaTalKSQEA8nf6HGF0eNjqOa0N7M7HXuLB04ibibD6Q/640?wx_fmt=png&from=appmsg)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IaydyZNKeTicz8HhA864NqZ0Q5N0Imy7kGk3HpYBGSZmqVV3XyWA2YyI4xyZicXVCrop3iaOkibk4XRHYLw/640?wx_fmt=png&from=appmsg)

已经成功进入到了锁屏界面 接下来就可以通过相关漏洞来进行利用。  

不过要注意的是这个方式只能算是对先认证再进入界面的一个 “绕过”，并不是 NLA 绕过。  

能进入到界面是因为机器并没有开启 NLA

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IaydyZNKeTicz8HhA864NqZ0Q5RM5zuY7vfnlJvPz8xlbTzNSeiaxOGqIv0KlFKfxYNt2JVLeqPWE74ZA/640?wx_fmt=png&from=appmsg)

如果开启了 NLA 再去连接就会像下面这样

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IaydyZNKeTicz8HhA864NqZ0Q5lU6FlP5mLr97bwQ7ZH2v2N1WUJQEW3UFeNxbLfkzAZbkpWu87LEFJg/640?wx_fmt=png&from=appmsg)

这里附上开启、关闭 NLA 的命令

开启

```
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v "UserAuthentication" /t REG_DWORD /d 1 /f

```

关闭

```
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v "UserAuthentication" /t REG_DWORD /d 0 /f

```

不过实际上这两条命令没什么用 因为使用这两条命令需要管理员权限

![](https://mmbiz.qpic.cn/sz_mmbiz_png/Tp9VOk1IaydyZNKeTicz8HhA864NqZ0Q5XxmnIByj3fA3DyYg4YJb4yRXBdbyPtT7ia4yD8Oq9BmOK8tfa16xcyg/640?wx_fmt=png&from=appmsg)

也算是比较鸡肋的一个利用点，不过还是有部分机器关闭 NLA 的，遇到关闭的就可以使用以上方法进行利用。  

**结尾**
------

匆忙的水下一篇文章，文章内容可能不完全正确，如有大佬发现文中内容有错误的地方恳请斧正！也欢迎各位师傅共同交流学习技术！欢迎留言区交流讨论~

**参考文章**

https://mp.weixin.qq.com/s/Iv87dwn_VTruYExet8AnlA

https://github.com/0xCaner/RDP-NLA-Closing-Scanner

不可错过的往期推荐哦  

```
流量对抗-域前置基础设施搭建


成熟后门身披商业外衣，对抗杀软实现远控


一次有趣的RCEbypass


国H零失分防守经验：蜜罐环绕靶标的围点打援策略


几次护网小结之红队打点及小技巧


某裸聊诈骗站点渗透实战


你存在，在我们的攻击画像里

```

点击下方名片，关注我们

  

觉得内容不错，就点下 “**赞**” 和 “**在看**”

  

如果不想错过新的内容推送可以设为**星标**![](https://mmbiz.qpic.cn/mmbiz_png/Yv6ic9zgr5hTYyCkc91euAiaGULJSbiaHricFHs2dd2sib20WTJKwHYD90Jia9HCKxnmJUwnkicGU7rVP3EYCVh3dMnng/640?wx_fmt=other&wxfrom=5&wx_lazy=1&wx_co=1&tp=webp)