> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/x6VavWfK_fEungV2pDZ1Iw)

    “数字签名” 是个老话题，相关文章多如牛毛。那年写的那个《[Windows 安全检测工具](http://mp.weixin.qq.com/s?__biz=MjM5NDcxMDQzNA==&mid=2247483658&idx=1&sn=babc98f6ef610c313af239186ebc70a4&chksm=a682d7c791f55ed1e59b2315b3b1dcf9ab4c63ba87e9c95a984af32df3fe907459d654e64601&scene=21#wechat_redirect)》里面有个 “对进程或驱动文件的签名验证” 的功能，好像用到了 Windows 的 api，曾是个特色。

    为什么写这个？一是好久没来怪想念的；二是源于看到一段代码，顺便学习下这个知识点。事后，自感学习能力下降得厉害；花了不少的时间才理出个头绪，确实烧脑，各位可能会头晕。

    言归正传，那段 py 代码的功能是将一个 PE 的官方签名的移植到另一个无签名的 PE 程序，以作... 之用。看了下，挺有意思的，如下：  

    flItms = {}

    binary = open(binary, 'rb')

    binary.seek(int('3C', 16))

    flItms['buffer'] = 0

    flItms['JMPtoCodeAddress'] = 0

    flItms['dis_frm_pehdrs_sectble'] = 248

    ......

    flItms['Characteristics'] = struct.unpack('<H', binary.read(2))[0]

    flItms['OptionalHeader_start'] = flItms['COFF_Start'] + 20

......  

    binary.seek(flItms['OptionalHeader_start'])

    flItms['Magic'] = struct.unpack('<H', binary.read(2))[0]

    ......

    flItms['ImportTableRVA'] = struct.unpack('<I', binary.read(4))[0]

    flItms['ImportTableSize'] = struct.unpack('<I', binary.read(4))[0]

    flItms['ResourceTable'] = struct.unpack('<Q', binary.read(8))[0]

    flItms['ExceptionTable'] = struct.unpack('<Q', binary.read(8))[0]

    flItms['CertTableLOC'] = binary.tell()

    flItms['CertLOC'] = struct.unpack("<I", binary.read(4))[0]

    flItms['CertSize'] = struct.unpack("<I", binary.read(4))[0]

    binary.close()

    return flItms

    顺着好奇一路走来，感觉实现难度不大，但现实是我花了不少时间且在若干资料的帮助下才完成了这篇习作，感觉当年大伽们设计数字签名的公私钥验证真非常有智慧，环环相扣，缜密绵绵。现按照我的理解整理出来，方便大家学习......

工具准备：  

A、工具：makecert、signtool、asn1dump、010editor、dd、openssl 等；

B、原始（x86） exe 一个 (x64 的 exe 等也行)，名为 test.exe; 

**一、自制数字签名**

**1、makecert --help**  

-r: 自签名 

-n: 证书名称，格式为 - n “CN = 名称, E=Email,O = 组织名称, C = 国家, S = 省份 (州), P = 县城” 

-a: 指定散列算法，其值必须是 md5（默认值）或 SHA1 ; 

-$: 指定证书的签名权限，其值必须是 commercial（商业软件）或 individual（个人软件） ;

-b: 证书有效期的开始时间，格式为 mm/dd/yyyy 

-e: 证书有效期的结束时间，格式为 mm/dd/yyyy

命令：makecert -r -$ "individual" /sv "test.PVK" -n "CN=YXZ,O=WHU,C=China,S=AnHui" -a md5 -b 03/16/2020 -e 01/01/2030 test.cer

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZzIAzibQwxkj3lR705PLiaLkpaDm5rDM2Q7yVLLnOcQwaqabpMLZHM42w/640?wx_fmt=png)

生成了 “test.cer(数字证书文件)、test.PVK(数字签名的私钥文件)”；

**2、安装证书：**

双击 test.cer，输入密码，下一步...，成功安装；（略）

**3、signtool 进行签名**

复制一个 test.exe 为 test02.exe，对 test02.exe 进行数字签名；test.exe 方便和 test02.exe 进行比对；

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZP3jXN9zpdROlpwFwH8gnh3upMjmYK6HTA2HvaIIsgK6zPFOYYjCrdA/640?wx_fmt=png)

这里为 test03.exe，因为 02 已经签名成功了，以 03 为例吧。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZsGrDCQYzF0fibGia2zFbPXDXqoZLia8k6dwMLvwziaSdblZn6u41J1YAGA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZEdUlTr06zHYhW0iayzXo3YhOI3u9yhDEjQKibjr3HFpvXTSc7hsWyCvg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZEdUlTr06zHYhW0iayzXo3YhOI3u9yhDEjQKibjr3HFpvXTSc7hsWyCvg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZYZ1uyw5dkLMictAuREpKK9FzEGdeKoap4dUvy96JDFq7GMoiacLydFicQ/640?wx_fmt=png)

**注意，这里的散列算法选择 “****SHA1****”。这里的散列算法是 PE 文件的签名信息， 而之前** **makecert.exe** **设置的** **md5** **是证书的散列算法。**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZW1OD7bEUvIH7kCYO0Kc5uUEHiaxH1RbnGmF827M6pIYCsjlaYdj9WDQ/640?wx_fmt=png)

打开 test02.exe 文件属性，可以看到它增加了一个 “数字签名” 的区域，并且能够看到此数字签名是正常的及详细信息。

**二、PE 数字签名的头格式**

**1、签名在 PE 头的位置，位于：**

PE 头的 struct IMAGE_NT_HEADERS NtHeader-->struct IMAGE_OPTIONAL_HEADER32 OptionalHeader-->struct IMAGE_DATA_DIRECTORY_ARRAY DataDirArray-->struct IMAGE_DATA_DIRECTORY Security 这里，两项内容 “偏移 VirtualAddress 和大小 Size”，

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZA8KKHJrFTOqL0F5dY8ibSIJ17cvH1eovs8RB0T59g4OVQpK05x8c8Cw/640?wx_fmt=png)

从而得知，在文件偏移 “BD8000h” 处，大小为 1176(498h)；  

我们比较下 无签名 的此处位置值：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZrNmbbK7LbI16fr5MeCrYJdic0NvE8phKTZG4yvGe3TsficWarCEvYo8Q/640?wx_fmt=png)

都为 0；

**2、偏移处 BD8000h 的 Certificate Table：**  

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZbVib0eMsOcjnuIXEWicBiaeW59P7ibHnOjiahk9UZsoQWHd8e0KlHKVY5Lw/640?wx_fmt=png)

可以看到 Certificate Table 存储相关签名信息： 

文件开始位置：BD8000h

表项长度：4 字节，头部和签名数据的总长度 498h; 

证书版本：2 字节，常见 0x0200 表示 WIN_CERT_REVISION_2; 

证书类型：2 字节，常见 0x0002 表示包含 PKCS#7 的 SignData 结构 

SignedData：包含 PE 文件 Hash 值的签名数据、软件发布者公钥，选用的签名及散列算法等。（在文件中为 ASN.1 编码）

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZMbXCZFawDWFpaphWANFzuSRVnLjFBpLdL58bt6NhM4LhIrcXt2pLZA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZDbStvwEjXeTfsEt2B7glVic31t7lgCGiaCLficSyFr0E3PRib5YYY1vd5g/640?wx_fmt=png)

**3、提取签名数据**  

可以用 010editor 来提取，也可以用 dd 工具来提取；  

Certificate Table 从第 9 个字节开始后为签名信息，存为文件 “test02Pkcs7Data.bin”；

这里我们用 dd 工具：

dd if=./test02.exe of=./test02Pkcs7Data.bin skip=12419080 bs=1 count=1168

BD8000h 转换为十进制为 12419072+8，498h 为 1176-8，（减去 8 个字节的版本号和证书类型）；

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZEugoqeMciawHxrfDhtDRk9PdXF7qLqoVnbPvcB1hrCGLFbvuRYib6V0w/640?wx_fmt=png)

如果导出正确了，可以用 asn1dump 正常打开，

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZ4uibpvgyia6Bn7BzicKsAibicib1iaavJUVdOZYF6ZRWpvVbNT2PTtgXiblhAw/640?wx_fmt=png)

**三、PE 签名数据分析**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZaxb2KlYyLFwRD6TNgfwcHd9lY0G34udnFgd7IJib4W4lCbWgEiaiciaf9w/640?wx_fmt=png)

上图中左半部分为 PE 结构。右半部分，微软对 PKCS#7 格式的数字签名数据部分做了一个大概的结构介绍，实际的结构对应 SignedData。

**1、****PKCS#7 微软官方文档** 

一个 PKCS#7 SignedData 结构包括 PE 文件的哈希值，一个被软件出版厂商的私钥创建的签名、将软件出版厂商的签名密钥和法人代表进行绑定的（系列）X.509 v3 证书。PKCS#7 1.5 版本规范定义了如下关于 SignedData 的 ASN.1（抽象语法符号）结构：

#### SignedData 的定义：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZY9VGV0KysvXOz910ZUwSuz9K6kYVf8skIOg8c3qoM3nzMPwxEhdaTA/640?wx_fmt=png)

**注意，导出的 “test02Pkcs7Data.bin” 签名数据为 ASN.1 抽象结构，需要用 ASN1View 或 ASN1Dump 进行解析，**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZj4PGLicDyHoru93VceicpSq8xuoVSXS0NqwQ41GvV2H4TZrH4sDnUQ5w/640?wx_fmt=png)

如果不方便，可以将 hex 导出，放入这个网站 https://holtstrom.com/michael/tools/asn1decoder.php 将 hex 转换成 asn1:

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZQZxd56vgz1hTiaUB7L4uI7P088y2yXHGJM6jyqStMibTJPsllygL0paw/640?wx_fmt=png)

在这里对应的 flag, 如: 指定 SignedData 结构值为 “1.2.840.113549.1.7.2”，表示采用 PKCS#7 结构; 生成签名的哈希算法 MD5\SHA1\SHA256\ 签名属性 SPC\ 证书颁发者信息 (包括 md5withRSA 签名、证书颁发者 YXZ、组织 WHU、国家及省份) 等。核心数据包括：散列算法 \ 摘要数据 \ 公钥数据 \ 签名后数据; 

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZ1arUNgE2VJ1cJ5X9BFneibcpph5QUAakruPCzw4AvVPu0kiaW9EAHZLA/640?wx_fmt=png)

所有的对应最后显示成这张图；

**2、分析 Contentinfo 部分数据。**

该部分主要存储 PE 文件的 hash 值、以及标记变量、散列算法等。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZOJRl1swQWKktn2W1iaJeGTppjnNib5En60FmSLPdhYibB8W6aTpCcFpgQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZbiaLUlrCyLV1nY2o8JMsTuw2GInkDcebrOicqFkuEjJdKZlcJuAPekTA/640?wx_fmt=png)

比如上面的 sha1 算法。

**3、分析 Certificates 部分数据。**

该部分主要存储证书相关信息，包括证书发布者、证书时间戳等信息。注意，该部分内容可以直接导出，再和 “test02.exe” 的数字证书 进行对比。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZic4Vn1sUSgZPXQnHqVj0UYGqWV3d4ibVo5ibW8G6qIpleX2ga4HAyonbw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZSQpb1VORN7qdh0KUuYHC5l0P9rFeUQ5sYsPGtrOITJRvd81lEaZOkw/640?wx_fmt=png)

比如省份 “AnHui”。

**4、采用 010Editor 导出证书部分数据，并进行对比实验。**

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZRLMmxeZ3W73RkdpONXfJiaaG0iaU5A8tFnicaXF7eqgoYFAJQoN8xNPQQ/640?wx_fmt=png)

我们从 “30 82” 开始复制。这里采用 010Editor 工具复制。

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZkZI6VAbftJfsDnGB9CzYUm0wFQia6ILhhB9yrvWs87ojA8qdUVdcMKQ/640?wx_fmt=png)

保存为 h.cer，和 test02.exe 中的证书对比下，

![](https://mmbiz.qpic.cn/sz_mmbiz_png/2hnvgPYNzpLLmPvz7NLpH3bdjzQhYTfZrhQgibBHeiaNGQYVcibKhPAoDvzoWbX4sSvfDQGSEYUjDQyJZbSDEO7gQ/640?wx_fmt=png)

对比从 010Editor 导出的 “h.cer” 证书和 “test02.exe” 数字签名信息，发现是一致的（包括公钥），该实验也证明了签名数据的 第二部分为证书信息。

**四、数字签名的移植**  

将数字签名移植到无数字签名的程序上，移花接木。

步骤如下：

1、有签名程序开展，找到 PE 头的 struct IMAGE_DATA_DIRECTORY Security，取出其签名的偏移和大小长度，移到偏移处，取大小长度的内容；

2、将以上长度的内容复制到无签名程序的尾部，修改 struct IMAGE_DATA_DIRECTORY Security 处的偏移和长度值，指向 Certificates；

3、完工。  

要不要写个程序呢？其实很简单了，有时间再写吧！