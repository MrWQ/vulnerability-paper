> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/0aflg9MSsLf1-J9_dhSuEA)

本篇文章为国光师傅原创技术文章，文章来源**「国光 Web 安全交流圈」**

原文链接: https://web.sqlsec.com/thread/173

国光师傅 yyds

前言
--

好朋友的服务器疑似被挖矿了：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/05AlicrBviacVsDn7NpSVZ46Y39SYu66xb0AiaMhIfWEvPTWo7pMmjatty8qxnCyLbGBC6XWxbVaSRBy1wF5ZAsiag/640?wx_fmt=png)

服务器安装了 BT 面板，登录进去果然 CPU 占用很高：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/05AlicrBviacVsDn7NpSVZ46Y39SYu66xbZxB65KvpbgJIHVBBPDyNELrMXREZibxJChks92ASAVmL5xm4Qia6YiaVw/640?wx_fmt=png)

现象
--

**「可疑进程」**

首先使用 top 命令定位关键可以进程：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/05AlicrBviacVsDn7NpSVZ46Y39SYu66xbicPVqZGVVc7bEaJoNC3yhzsRJaSvJZiaZW5rEcpIMeuXFlCskvWDO5Cg/640?wx_fmt=png)

**「域名解析异常」**

服务器可出网，但是解析域名失败，导致 apt 无法安装软件包：

分析
--

**「配置 DNS Server」**

```
mkdir -p /etc/systemd/resolved.conf.d/

cat >/etc/systemd/resolved.conf.d/99-dns.conf << EOF
[Resolve]
DNS=114.114.114.114 8.8.8.8
EOF

ln -s -f /run/systemd/resolve/resolv.conf /etc/resolv.conf

systemctl daemon-reload && systemctl restart systemd-resolved.service && systemctl status -l systemd-resolved.service --no-pager

cat /etc/resolv.conf


```

然后就可以正常连接外网了：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/05AlicrBviacVsDn7NpSVZ46Y39SYu66xbl2HuiaEV721IdLHqwriadk6HMojmhchda9AMQZc6nrNpnHt4BEWxQanA/640?wx_fmt=png)

**「htop 辅助查看进程」**

可以使用 apt 安装 htop 来更直观的查看当前系统的进程：

```
apt install htop


```

查看一下可疑进程：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/05AlicrBviacVsDn7NpSVZ46Y39SYu66xbw5U2SYCwjwmhsBfHDtnYNjr4SKRHYSORTI3pmAMwc6aGYKDZwdkrNw/640?wx_fmt=png)

**「定位进程文件」**

查看 PID 为 3198834 的进程相关文件：

```
lsof -p 3198834


```

这里也可以使用下面命令查找进程相关的文件：

```
ls -l /proc/{进程PID号}/exe


```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/05AlicrBviacVsDn7NpSVZ46Y39SYu66xbI9aPwF0cOrZLaMqPSvP3PDYuvM2DKHW2zHDAbBA5I3HMJhhHYia53wQ/640?wx_fmt=png)

同时 3198352 的进程也很可疑

```
lsof -p 3198352


```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/05AlicrBviacVsDn7NpSVZ46Y39SYu66xb1xricnNLarqQlOomugkG50B2pmY4SHuOCsjDfKN8grrHUicuGpmx4oTw/640?wx_fmt=png)

根据分析大概是 6 月 6 日左右被入侵挖矿的：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/05AlicrBviacVsDn7NpSVZ46Y39SYu66xb46091nZicy8biavMI42SmXux3vicTPWPIIqibvfmDTlz0VibQLo7mc0zSrA/640?wx_fmt=png)

**「外连信息整理」**

*   111.90.138.173：马来西亚 吉隆坡
    
*   111.90.138.173 ：保加利亚 索非亚州 索非亚
    

**「分析恶意文件」**

*   sshd 文件
    

微步在线确定为 挖矿木马：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/05AlicrBviacVsDn7NpSVZ46Y39SYu66xbvcXVvAE6MXvZQZ05oSKaP4ib3sLhUZLX29JVIoUjbUqtrDrssDyCccQ/640?wx_fmt=png)

详细的原始检测报告可以参考：

https://s.threatbook.com/report/file/436b9e7ad9bfdae8e47c0a812b26a2cd3ac6d65b3c7807ee9c8d12bb40e0b8b5

*   PS 文件
    

微步在线检测 PS 文件大概率为端口扫描工具：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/05AlicrBviacVsDn7NpSVZ46Y39SYu66xbryDnGGU5kllyicm5oKuJkKYCriceKFibmHSpglIkaOaKzc5pPQ2kricqWg/640?wx_fmt=png)

此文件会将端口扫描的结果写入到 bios.txt 文件中：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/05AlicrBviacVsDn7NpSVZ46Y39SYu66xbsGabic8DJUibBeQqJMe5aAc7u11GwE1jynDiaNJS9FFph20Ett2Mt2XnQ/640?wx_fmt=png)

###### 隐藏的 cache 文件夹

根目录下的 .cache 文件夹也比较可疑，里面放着很多文件：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/05AlicrBviacVsDn7NpSVZ46Y39SYu66xbVJzFRu6C63CUibOTIH5Mhqfc7byCaCf3cLiac26SYTTlnecwUTXicsveA/640?wx_fmt=png)

**「定时任务分析」**

定时任务通过 cache 文件下的 a 脚本创建：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/05AlicrBviacVsDn7NpSVZ46Y39SYu66xbXXI7SKqzpl42ucDiaCqvZkvpiaE6VNWgzNIDcPD69PtGicDNwkF6JSKzg/640?wx_fmt=png)

清除
--

**「干掉可疑进程」**

既然定位到上面那些恶意进程的话，那么就直接干掉这些进程和删除这些恶意文件吧。

```
kill -9 3198352
kill -9 3198834


```

但是 CPU 负载还是很高，怀疑是挖矿病毒自己重新自启了进程了：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/05AlicrBviacVsDn7NpSVZ46Y39SYu66xbRiaXpoahAEhZZNjXmTB9SfXSUDocdxMWibzUxOOgX2lDJpJvAORUpLVQ/640?wx_fmt=png)

**「删除恶意文件」**

```
# 删除病毒文件和产物
rm -rf /root/sshd
rm -rf /root/ps
rm -rf /root/bios.txt


```

**「清空定时任务」**

```
echo "" > /var/spool/cron/crontabs/root


```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/05AlicrBviacVsDn7NpSVZ46Y39SYu66xbntMuWsHRkoHCh0YBOcfHZU4ygWfKibsyxRjR061iad12jl5qDEP8ZiaUA/640?wx_fmt=png)

**「继续分析进程」**

```
ls -l /proc/{进程PID号}/exe


```

原来是忘记删除 .cache 隐藏文件夹了 尴尬了 :qiudale:：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/05AlicrBviacVsDn7NpSVZ46Y39SYu66xbVaJNPLxqfwBL4KuzSHPddicOMVSONZIYKvgJdr2gIdnf6RebiaR77xWQ/640?wx_fmt=png)

**「删隐藏文件夹」**

我们来手动删除看看：

```
# 删除 .cache 缓存文件夹
rm -rf /.cache


```

###### 重启下服务器

最好我们也重启服务器开机观察一下是否还有可以进程来占用我们的 CPU 了：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/05AlicrBviacVsDn7NpSVZ46Y39SYu66xbWvAM0ibstibCJEqic1cnjQzTpB4CicEF9icmCbSGW333xFByiaNowANdiculQ/640?wx_fmt=png)

加固
--

通过上述分析，基本上确定了攻击者留下的痕迹了，下面得重点分析研究下服务器最初是如何失陷的。

**「SSH 安全加固」**

时间定位到 6 月 6 日左右，可以在 SSH 的登录日志里面查看到大量的爆破记录，不仅尝试了各种用户名还对 root 用户进行了大量的爆破：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/05AlicrBviacVsDn7NpSVZ46Y39SYu66xbwKC8lELlO2ltDT5hOl7eseZic6huhMOy82ZohDpJVnkQm90JQZVU3Pw/640?wx_fmt=png)

所以需要 root 用户开启公私钥登录或者设置 1 个强口令才可以。

**「开启防火墙」**

考虑到还有其他一些乱七八糟的服务，所以我们开启一下防火墙，设置只允许白名单端口可以被外部访问，其他一律拦截：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/05AlicrBviacVsDn7NpSVZ46Y39SYu66xb6WEaVHHAibVLibicXKPcYOm5mU9yYb4tBsNMgJQtaicaicy2nX2ynSJPCRQ/640?wx_fmt=png)

好啦，先这样吧，反正目前没有被挖矿了，等下次再被挖矿的话那就来继续加固其他服务。

对了，文章附上一下本次的挖矿样本，感兴趣的师傅们可以自行下载去玩玩~

后台回复 “0711” 即可获取啦

关注公众号
-----

下面就是团队的公众号啦，更新的文章都会在第一时间推送在公众号

74 篇原创内容

另：于传播、利用本公众号 CKCsec 安全研究院所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，CKCsec 安全研究院及作者不为此承担任何责任，一旦造成后果请自行承担！如有侵权烦请告知，我们会立即删除并致歉。谢谢！