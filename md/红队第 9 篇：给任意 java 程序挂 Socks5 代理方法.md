> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/pVAZvKADFVwPOC4CwrCooQ)

 **Part1 前言** 

在内网横向过程中，经常会用 frp、狗洞、nps 等工具，在内网环境中搭建一个反向 socks5 代理，方便红队人员开展内网渗透工作。于是，红对人员需要对各种渗透工具挂上 Socks5 代理，使用 proxifier 这个工具挂全局 s5 代理是非常方便的，但是有的渗透工具是使用 java 写的，而且作者并没有编写 Socks5 代理功能，用 proxifier 挂 java.exe 进程的时候总会出现各种各样的问题，这种情况下可以用 java 自带的命令行功能解决。

**本文章的各种命令都经过 ABC_123 的严格测试，同时仔细阅读了官方的 Oracle 的手册，也纠正一下网上各种文章的错误。**

 **技术研究过程** 

*   **命令行挂 Socks5 代理**
    

启动 Socks5 代理命令如下：

java -DsocksProxyHost=127.0.0.1 -DsocksProxyPort=1080 -jar webscan.jar

其中 socksProxyHost 是 Socks5 代理的 IP 地址，socksProxyPort 是 Socks5 代理的端口号。socksProxyVersion 版本号是 5 或者是 4，默认是 5 版本，也就是 Socks5 代理，这里也可以指定。

如果 socks5 代理需要用户名及密码时，网上的文章介绍的方法是：

java -DsocksProxyHost=10.1.1.2 -DsocksProxyPort=8877 -Djava.net.socks.username=alibaba -Djava.net.socks.password=secret**（此方法亲测无效，目前我也没找到命令行下设置 S5 代理用户名及密码的方法）**

其中，java.net.socks.username 是 Socks5 代理认证的用户名，java.net.socks.password 是 Socks5 代理认证的密码。但是我 java 命令行接上述两个参数，怎么都弄不成功，总是提示 Socks 认证失败，如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4SFttBA4x31VZdTHa145ZNI93mjmPgsKjwKtRPiaPaRJPQ5wJmE4WlbCl03ia04WP6HG3WVf96TqA/640?wx_fmt=png)

*   **命令行挂 HTTP 代理**
    

如果想对一个 Java 程序设置 HTTP 代理，或者想用 burpsuite 对一个 java 程序进行抓包，那就按如下所示设置：

Java -Dhttp.proxyHost=127.0.0.1 -Dhttp.proxyPort=8080 -Dhttps.proxyHost=127.0.0.1 -Dhttps.proxyPort=8080 -Dhttp.nonProxyHosts="*.example.com|localhost" -jar webscan.jar

**这里重点纠正一下网上各种文章的错误：**

如果想使用代理访问 HTTP 的 URL，则必须使用 http.proxyHost，http.proxyPort。如果想用代理访问 HTTPS 的 URL，则必须使用 https.proxyHost，https.proxyPort。如果想同时抓 HTTP、HTTPS 的 url 访问的话，**以上 4 项是必须设置的，缺一不可！**

具体命令解释如下：

http.proxyHost 是 HTTP 代理的 IP 地址，http.proxyPort 是 HTTP 代理的端口，https.proxyHost 是 HTTPS 代理的 IP 地址，https.proxyPort 是 HTTPS 代理的端口

http.nonProxyHosts（**经过我测试，此选项对于 http/https 型 URL 均适用**），用于指定哪些 IP 地址可以直连网络，不走 HTTP/HTTPS 代理，* 是 IP 地址的通配符，按照 | 分割每个 IP 段，前后加上双引号包裹起来。

如果 HTTP 代理需要用户名密码的话，则按照如下设置（以下命令摘抄自网络，本地没有带用户名密码的 http 代理环境，所以没测试）：

Java -Dhttp.proxyHost=127.0.0.1 -Dhttp.proxyPort=8080 -Dhttp.proxyUser=username -Dhttp.proxyPassword=password -Dhttp.nonProxyHosts="*.example.com|localhost|10.*.*.*" -jar webscan.jar

http.proxyUser 是 HTTP 代理的用户名，http.proxyPassword 是 HTTP 代理的密码，如果没有设置用户名密码认证，就不用设置这两项。

HTTPS 代理设置如下：

java -Dhttps.proxyHost=host -Dhttps.proxyPort=port -Dhttps.proxyUser=user -Dhttps.proxyPassword="password" -Djavax.net.ssl.trustStore=c:/cacerts -Djavax.net.ssl.trustStorePassword=changeit -jar webscan.jar

*   **如果使用系统代理的话**
    

java -Djava.net.useSystemProxies=true -jar webscan.jar

那么 webscan.jar 程序将会走 IE 浏览器设置的代理，也就是系统代理。然后打开 IE 浏览器，在 “代理服务器” 选项卡下设置一个代理 IP 即可：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4SFttBA4x31VZdTHa145ZQJqia4JDWgxA6PbFwZS8VFs5Z1BX4NYtk9xLTFicD4wTWIUSiblbwFN2g/640?wx_fmt=png)

*   **Java 代码编写中设置代理**
    

我在编写各种 Java 工具时，一开始总是为写 HTTP 代理、Socks5 代理头疼，因为太麻烦了。后续发现了一个简单有效的方法，可以在代码中直接添加 System.setProperty 设置，非常好用。

设置 HTTP/HTTPS 代理如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4SFttBA4x31VZdTHa145ZxzTOmASUbnibLAbanZq8xTnMK0OeIZvnaPT9QBGCnqkwqxR1UTWD9Rg/640?wx_fmt=png)

设置 Socks5 代理代码如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4SFttBA4x31VZdTHa145ZcIUzqu60U0Y4epaQibTnTtib0SwersIdGlMLHPYxCl8B5Z5iaebVsqWicA/640?wx_fmt=png)

ProxyAuth 类编写如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450D4SFttBA4x31VZdTHa145ZsfKPcc3YN9CDJtfKoILKPuRP5N1aZyibpGWOQBXQeX7zfzEylwkKfCQ/640?wx_fmt=png)

 **总结** 

**1.** 看官网手册挺重要的，更多的 java 命令行的网络设置方法，可以看 Oracle 官方的手册

https://docs.oracle.com/javase/8/docs/technotes/guides/net/properties.html

https://docs.oracle.com/javase/10/docs/api/java/net/doc-files/net-properties.html

**2.** 这种方法对于一些特殊框架编写的 Java 应用无效，这只是极少数的情况，我在具体渗透过程中，还没有遇到。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

专注于红队、蓝队技术分享

每周一篇，敬请关注

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rhn137KeqqlDkuRyY4G61jATRzyOrCBts8ucxkLpMNsYutSOY7BkPziaw/640?wx_fmt=jpeg)