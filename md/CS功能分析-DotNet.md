> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/vN6MhA7yAO-lkZ30FbsLwA)

这是[**信安成长计划**]的第 14 篇文章

  

0x00 目录

0x01 DotNet功能分析

0x02 DotNet功能执行

0x03 写在最后

  

在上两篇文章中，讲述了 CS 中的一种功能执行方式 RDI，这一次来分析一下另外一个非常重要的功能执行方式——DotNet

  

  

0x01 DotNet功能分析

CobaltStrike 提供了一种可以执行任意 DotNet 程序的方案，使用了名叫 invokeassembly 的 DLL，来加载和执行所传递的 DotNet 功能，提供这个方法的 Job 是 ExecuteAssemblyJob，它跟 RDI 不一样，它继承自 JobSimple 类

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerkG0B5oRL4v46f5rx6ibkp6WVicMxib4CsqXumDlOGYbn8m3d6ZYPjdJ49gMYg3en7PG0kZR4tmibcfQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

与 RDI 一样，它也有一些必须要处理的方法

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerkG0B5oRL4v46f5rx6ibkp6yfwCgAicn92YibmA0QWCzxv7oHw2KHiaqwrl9YVFUA72icPy089IPic7vMQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

在实际执行的时候，它会直接来运行 ExecuteAssemblyJob 的 spawn 方法

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerkG0B5oRL4v46f5rx6ibkp6Pic0xGJCu1XMNCdDI85WuiafJF8WhAznCmdHKJXDEO8oyyEyhow0MloQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

首先它会获取到 invokeassembly.dll，然后获取到它的 ReflectiveLoader 函数，接着就开始了任务的构建

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerkG0B5oRL4v46f5rx6ibkp6urtCxibeL04ttC82TFwhB2LafPUFEusfFpm7icPqKOLRdwaCibCYD0wmw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

随后会对其再进行一些设置的操作

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerkG0B5oRL4v46f5rx6ibkp6jsSgbTicwqGvGXjUVgXY7UkINswcg6164q4uiazWB0TJ95EiaybyjymEg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

在 fix 中，会有对 amsi 的一些处理

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerkG0B5oRL4v46f5rx6ibkp6JJPWueJ95SMc7wia5bRiannNxkyOnKCKehWlsIw3Wc4oxmbE5OGLOTFg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

接下来有一个比较重要的操作，获取参数

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerkG0B5oRL4v46f5rx6ibkp61QEpcuj5reKia8BPb0deIj0zmfBDLiaZ7Xk2iapCNrD1O92DFf6L2ibFaQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

在这里会将 this.file 和 this.args 都组合到一起

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerkG0B5oRL4v46f5rx6ibkp6PYDW2su1MoBz3gPicROtIcdGZtoW0LzRnHVOKYQL7xKoCYTgHelXVeQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

而这两个东西，正是我们要执行的 DotNet 和参数，所以说 CS 实际上是把我们要执行的内容当作参数来进行传输了，最后再交给 invokeassembly 来执行

  

![图片](https://mmbiz.qpic.cn/mmbiz_png/QLrPurKePerkG0B5oRL4v46f5rx6ibkp6hK2wcamJvhZYdjIoC6Go4ib6BIEbeCtIwESFFUT5df0iaQ6q0zkxhGQg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

  

而后就是任务的构建和发送了

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

  

0x02 DotNet功能执行

在执行到 DotNet 功能的时候，前面的处理操作先不管了，只看执行这里的

  

根据之前 RDI 的分析，也很容易能够区分出进程创建的位置，其中的操作基本都是一致的

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

直接就跳进函数的执行，这里面就包含了各种执行方式以及加载运行

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

之后执行权限就交给了 invokeassembly

  

![图片](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

  

这里再追下去的意义就不是很大了，主要就是调用接口来加载 DotNet 程序集，其中所用到的技术也是已经开源了的 Hosting CLR，可以参考下面的这篇文章来阅读

  

https://b4rtik.github.io/posts/execute-assembly-via-meterpreter-session/

  

https://github.com/b4rtik/metasploit-execute-assembly

  

  

0x03 写在最后

与 RDI 不同的是，我们并不需要在 DotNet 当中处理管道相关的内容，这些东西都由 beacon 和 invokeassembly 处理了，因为 DotNet 是由我们来传进去的，而 RDI 的功能它是不支持像 DotNet 这样直接调用的，而我们通过二开的方式来进行了使用，就需要直接按照所规定好的方式来进行处理才可以。

  

  

**往 期 文 章**

  

__1.__ [RDI 任务执行流程分析](http://mp.weixin.qq.com/s?__biz=MzkxMTMxMjI2OQ==&mid=2247484054&idx=1&sn=36fbb4c206a5dd6bcf0420a41227c77a&chksm=c11f5674f668df6242535515dcc7c0515ae70557c4764135d5f027185560bedb9de67a869ebf&scene=21#wechat_redirect)

__2.__ [RDI 任务发布流程分析](http://mp.weixin.qq.com/s?__biz=MzkxMTMxMjI2OQ==&mid=2247484052&idx=1&sn=9599bf0822b5ece0051bb3075bc64c90&chksm=c11f5676f668df608a25e149e4d8cd7102c449eda02ae4e38799364cdbcabf02381b822cf541&scene=21#wechat_redirect)  

__________3.__________ [自实现 Beacon 检测工具](http://mp.weixin.qq.com/s?__biz=MzkxMTMxMjI2OQ==&mid=2247484049&idx=1&sn=3bf61249578b55a3ae5c3828db7ff4eb&chksm=c11f5673f668df654c5632c2da681ad62567e06e338137c4c3a772ef2b7771ca555d37607df5&scene=21#wechat_redirect)

[更多文章 戳此查看](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzkxMTMxMjI2OQ==&action=getalbum&album_id=2174670809724747778#wechat_redirect)

  

 ![](http://mmbiz.qpic.cn/mmbiz_png/QLrPurKePeo0XtOibCh4mscJ6qedLKEvAXiasGrOylp2v8fMVpeKAbxA0zHBN40EvgZAqbcLytic5ibNREV9R6Hb7g/0?wx_fmt=png) ** 信安成长计划 ** 让我们一起探索 信息安全技术的原理 15篇原创内容   公众号