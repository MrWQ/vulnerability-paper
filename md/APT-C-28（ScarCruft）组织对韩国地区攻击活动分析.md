> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/iKHiPaRKnSd5m7xpP3cRDA)

![](https://mmbiz.qpic.cn/sz_mmbiz_gif/pLEuriaaPnU362NhLdPIDibrhibC5gfZR980tl5kIv8p6m64VHJU1n0pa7WajQ3lticuSKic1icw7xGRNGibTiaibdI7g7Q/640?wx_fmt=gif)

**APT-C-28**

  **ScarCruft**

APT-C-28（ScarCruft），又称 Konni，是一个活跃于朝鲜半岛的 APT 组织，其主要针对周边国家地区的政府机构进行网络攻击活动，以窃取敏感信息为主。该组织的攻击活动最早可追溯到 2014 年，近年来该组织活动频繁，不断被数个国内外安全团队持续追踪和披露。

近期 360 高级威胁研究院多次发现该组织针对韩国的定向攻击行动。在本轮攻击中，该组织前后使用 “奖励清单”、“支付” 等具有诱导性的文件名，同时使用 “加密货币”、“通讯录” 等诱饵内容诱导用户执行恶意宏文档。宏文档被允许执行后，会从自身下载或者释放 CAB 载荷并解压执行其中的脚本文件，进行一系列恶意样本的加载，从而对受害者发动网络攻击，达到窃密目的。

 **一、攻击活动分析**    

**1. 攻击流程分析** 
--------------

Konni 组织本次攻击流程大致如下图所示：         

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNfuxVGYKFvuYMABbPkfCrmQl4iaeDHpezZr16xv99iaXH7fn53bicpxl5Q/640?wx_fmt=png)

Konni 组织利用诱饵文件诱导用户点击打开，一旦执行便从远端服务器下载恶意宏模板文件，宏代码主要功能是继续下载 CAB 文件并解压执行其中 check.bat 文件，该 BAT 会判断系统版本及 CPU 架构，以便在安装服务时根据对应版本选择不同的 UAC 绕过方式，从而顺利伪装系统服务启动后门模块，达到驻留目的并开启窃密活动。

**2. 恶意文档分析** 
--------------

Konni 组织在近期针对韩国的定向攻击中，主要使用的样本为恶意文档，其伪装内容都为韩文，结合该组织经常使用鱼叉式网络钓鱼攻击手法，推断本次攻击应该也是使用鱼叉钓鱼投递方式。

以下是一个最近针对韩国地区的攻击样本，其信息如下：

<table cellspacing="0" cellpadding="0"><tbody><tr><td width="99" valign="top"><section><strong>文件名称<o:p></o:p></strong></section></td><td width="315" valign="top"><section>paypal.docx<o:p></o:p></section></td></tr><tr><td width="99" valign="top"><section><strong>文件大小<o:p></o:p></strong></section></td><td width="315" valign="top"><section>14.91 &nbsp;KB (15271 字节)<o:p></o:p></section></td></tr><tr><td width="99" valign="top"><section><strong>MD5<o:p></o:p></strong></section></td><td width="315" valign="top"><section>7b27586c4b332c5e87784c8d3e45a523<o:p></o:p></section></td></tr></tbody></table>

该样本执行时会从地址 http://k22012.c1.biz/paypal.dotm 下载恶意宏模板文档（MD5: a6736c776d6d44cec7ec07b9fb628ec3），并且宏代码被加密无法正常调试, 还原后其恶意代码如下所示：

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNQvgibC0elIo4GqRSmlchUYbWZFpMDRFWAc0a1OwzQgd5yY87sqafEnA/640?wx_fmt=png)

其功能首先将不易阅读的灰色文字设置为黑色，宏执行前后文档内容如下所示：

<table cellspacing="0" cellpadding="0" width="578"><tbody><tr><td width="207" valign="top"><section><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhN2ywwAUtTkKBGl50gAic4ksQgo6ZUl6psl7psY0okySPFg5AFJjvoribw/640?wx_fmt=png"></section></td><td width="207" valign="top"><section><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNWg9jF4adOdW2pHnFmciaTLGDib8Dlgf6SW31bqU0xSfXUxJgKf1KgUFQ/640?wx_fmt=png"></section></td></tr></tbody></table>

接着从地址 http://5645780.c1.biz//index.php?user_id=trap&auth=trap&pw=trap 下载文件，并保存到 %TEMP%\FXSAAENPILogFile.txt（MD5:1ae5b24456d9751dbd15c5c4fccef261）, 最后利用 expand 对下载文件进行解压并执行其中的 check.bat。

**3. 攻击组件分析** 
--------------

**1）FXSAAENPILogFile.txt 文件**
-----------------------------

宏代码中下载的 FXSAAENPILogFile.txt 文件信息如下：

<table cellspacing="0" cellpadding="0"><tbody><tr><td width="99" valign="top"><section><strong>文件名称<o:p></o:p></strong></section></td><td width="260.3333333333333" valign="top"><section>paypal.docx<o:p></o:p></section></td></tr><tr><td width="99" valign="top"><section><strong>文件大小<o:p></o:p></strong></section></td><td width="260.3333333333333" valign="top"><section>14.91 &nbsp;KB (15271 字节)<o:p></o:p></section></td></tr><tr><td width="99" valign="top"><section><strong>MD5<o:p></o:p></strong></section></td><td width="260.3333333333333" valign="top"><section>7b27586c4b332c5e87784c8d3e45a523<o:p></o:p></section></td></tr></tbody></table>

该文件实际上是个 CAB 文件，解压后如下图所示：

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNhfuVqPvuQ4F0BXvPPibRxObQdj8QQibib8HFcxZvS0UDtscugG40xLUQA/640?wx_fmt=png)

**2）check.bat 文件**

压缩包中的 check.bat 文件被宏代码运行，作为其他组件加载的入口，文件信息如下：

<table cellspacing="0" cellpadding="0"><tbody><tr><td width="99" valign="top"><section><strong>文件名称<o:p></o:p></strong></section></td><td width="315" valign="top"><section>FXSAAENPILogFile.txt<o:p></o:p></section></td></tr><tr><td width="99" valign="top"><section><strong>文件大小<o:p></o:p></strong></section></td><td width="315" valign="top"><section>127.29KB &nbsp;(130346 字节)<o:p></o:p></section></td></tr><tr><td width="99" valign="top"><section><strong>MD5<o:p></o:p></strong></section></td><td width="315" valign="top"><section>1ae5b24456d9751dbd15c5c4fccef261<o:p></o:p></section></td></tr></tbody></table>

check.bat 具体内容如下图所示，执行时首先判断是否存在 session，若存在直接执行 trap.bat 并退出，否则先判断是否是 Windows 10 系统，若是，设置 Num 等于 4，否则等于 1，这两个参数代表了不同的 UAC 绕过方式，接着判断是否在 64 位系统下，若是则执行 wpnprv64.dll，否则执行 wpnprv32.dll。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNjFK0zRbNibK1HXglCA4FZJT9Yhibq5yj0E03mTpBiaRtSosgmcc5r8j9w/640?wx_fmt=png)

**3）wpnprv32.dll 文件**

以 32 位系统为例，check.bat 文件调用 wpnprv32.dll，并传入参数 Num 和 trap.bat。该 DLL 提供了两种不同的方式进行 Byass UAC。

<table cellspacing="0" cellpadding="0"><tbody><tr><td width="99" valign="top"><section><strong>文件名称<o:p></o:p></strong></section></td><td width="315" valign="top"><section>check.bat<o:p></o:p></section></td></tr><tr><td width="99" valign="top"><section><strong>文件大小<o:p></o:p></strong></section></td><td width="315" valign="top"><section>491B &nbsp;(491 字节)<o:p></o:p></section></td></tr><tr><td width="99" valign="top"><section><strong>MD5<o:p></o:p></strong></section></td><td width="315" valign="top"><section>079be709ce7e57f4015b0ca8347e8a29<o:p></o:p></section></td></tr></tbody></table>

当传入的参数 Num 为 1 时，借助 wusa.exe 白名单文件，并结合令牌模拟登录方式从而进行 Bypass UAC。具体过程如下，首先通过 ShellExecuteExw 拉起 wusa.exe 进程，由于 wusa.exe 位于 UAC 白名单中，并不进行 UAC 验证，通过 NtOpenProcessToken 和 NtDuplicatetoken API 函数获取复制 wusa.exe 的 Token，然后将得到的 Token 传入 ImpersonateLoggedOnUser 模拟用户登录，接着使用 CreateProcessWithLogomW 执行传入的 trap.bat，最后将复制的令牌分配给新创建进程的线程。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNYa13UvQ28jJpNgloZQTqfYnDXPQjgLibDHTxajdHF1Lvf89kuYB3MRQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNQAmAl0ic4cS3pAldLicWpT8v8I3xMbyCHhGUkpXRicInPvZJbXKYvAVZg/640?wx_fmt=png)

当传入的 Num 为 4 时，则使用最早由 Project Zero 披露出来的 AppInfo RPC 以及 PPID 欺骗技术进行 Bypass UAC。

Appinfo 是一个 Windows RPC 服务，该 RPC 服务中的 RAiLaunchAdminProcess 函数主要用于 UAC 验证。具体过程如下，首先将 startFlags 设置为 0，创建一个普通权限的 winver.exe 进程，然后通过调用 NtQueryInformationProcess 函数获取该进程调试对象句柄，然后分离调试器，以便能够将现有的调试对象分配给下一步创建的新进程。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNb9eT3ibywLyc1EMFCpEMibdacXr7dicuwOKicVldTAEe0EYiaKXnQRz71tQ/640?wx_fmt=png)

接着重新创建一个具有高完整性级别的 taskmgr.exe 进程，获取初始进程调试事件，通过 NtDuplicateObject 获取完全访问进程句柄。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhN3L6Gj9y8GEo3y1FwlDMwYENbUc6DP6hGLGQRSvojUicPTssbNMM7WoA/640?wx_fmt=png)

最后使用父进程欺骗技术，创建一个新的高完整性级别进程，用于执行传入的 trap.bat。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNk58PZbRWXY7xZGbseVLNndZ2bpu0mlHIrXcTpN4toqibjmiakUemKfGg/640?wx_fmt=png)

**4）trap.bat 文件**

通过 wpnprv32.dll 执行的 trap.bat 基本信息如下表所示：

<table cellspacing="0" cellpadding="0"><tbody><tr><td width="99" valign="top"><section><strong>文件名称<o:p></o:p></strong></section></td><td width="315" valign="top"><section>trap.bat<o:p></o:p></section></td></tr><tr><td width="99" valign="top"><section><strong>文件大小<o:p></o:p></strong></section></td><td width="315" valign="top"><section>1.67KB (1705 字节)<o:p></o:p></section></td></tr><tr><td width="99" valign="top"><section><strong>MD5<o:p></o:p></strong></section></td><td width="315" valign="top"><section>8a37c1614aed81a2b9d1f44cf84e2515<o:p></o:p></section></td></tr></tbody></table>

其具体内容为：

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNKaLtibP0lAO0VKSWpxkibdISoX9PdWJqSeJvJEJiaFNye9RRDTLM4sMwg/640?wx_fmt=png)

执行时首先判断是否运行在 64 位系统下，若是则将 64 位的 DLL 文件和其相应 DAT 文件复制到 system32 目录下并改名为 rdssvc.dll 及 rdssvc.dat，否则将 32 位的 DLL 文件和其相应 DAT 文件复制到 system32 目录下并改名。接着执行安装步骤，创建 rdssvc 服务，其服务显示名为 “Remote Database Service Update”，执行路径 “svchost.exe -k rdssvc”，并在注册表 HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SvcHost 下创建 rdssvc 项，其参数指向 rdssvc.dll, 以此实现永久驻留。最后删除本目录下所有文件，成功创建服务如下所示，该服务加载的 DLL 程序为最终的远控木马。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNpgR5DjOyicyCrCQEKqoTGL6y7J4G1zNUETOA5T8iaErwUaichz1sREEYQ/640?wx_fmt=png)

**4. 最终载荷分析** 
--------------

以 32 位系统下加载的 rdssvc32.dll 为例，rdssvc32.dll 是一个伪装成服务的远控程序，相关信息如下。

<table cellspacing="0" cellpadding="0"><tbody><tr><td width="99" valign="top"><section><strong>文件名称<o:p></o:p></strong></section></td><td width="315" valign="top"><section>rdssvc32.dll<o:p></o:p></section></td></tr><tr><td width="99" valign="top"><section><strong>文件大小<o:p></o:p></strong></section></td><td width="315" valign="top"><section>80.0KB (81920 字节)<o:p></o:p></section></td></tr><tr><td width="99" valign="top"><section><strong>MD5<o:p></o:p></strong></section></td><td width="315" valign="top"><section>8e50622992a4b4b33127c34ff3fdbd30<o:p></o:p></section></td></tr></tbody></table>

解密函数名，并获取相关函数地址。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNoA9D8RHYJ3EcVe8AMoeyvnHez3uQt88yMiaBcWrPz3ZFAcW12OSRicOQ/640?wx_fmt=png)

读取注册表 HKEY_CURRENT_USER\Console 下的键值，其中 MinElapsed 表示再次联网测试的等待时间，时间范围为 1 分钟到 1 小时中间的随机整数分钟。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNVSH6ZStWXBr1HpHA1o1gmoxJS7AE4Fibrib5qHDaOynpdO7M9AosJ0sg/640?wx_fmt=png)

通过读取解密 rdssvc.dat 数据，其中 rdssvc.dat 的前 16 个字节为 IV(“d3dbd7bb1299096441c5ebba6ce2675e”)，剩下的内容是加密之后的 C2 服务器地址，Key 为服务名的 Hash256 值 (“3f96cd95327a8c801972620c7906dcfa9e6b76d3c1935b8648c5c24bfb2c21b8”)。使用 AES-CTR 解密得到 C2 服务器地址 “4895750.c1.biz”。 

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNWgaJiboiapSh80Nr7iaDsicicgRFoP9YSiaRL3U6jSekZ9RQj5rq5dGHHKag/640?wx_fmt=png)

如果 rdssvc.dat 不存在，则会读取 rdssvc.ini 文件解密出 URL 地址，从该 URL 中下载解密 C2 服务器地址。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNqWXmr39ZBtFYIJ5NWbpiawHdH46PRtS2tSibhicic9N1KYviclt0GPDBiaBg/640?wx_fmt=png)

然后分别通过执行 “cmd /c systeminfo” 和“cmd /c tasklist”获取系统信息和进程信息，并将数据保存到 C:\Windows\Temp \ 目录下。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhN7MJC1WHjBA3nqbDV26vvh7OGDSIzgGzHcAP3x0Rgibw5tnwTIObCcAw/640?wx_fmt=png)

此外，需要注意的在攻击者在上传信息时，如果文件格式不是 “.cab”、“.zip”、“.rar”，则会使用 makecab 进行打包加密上传，如果已经是这三种格式则直接加密上传。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNFEk81APwH9ichJKmSq513zWyubes7rZILzsvQia0pUmag2RYnsgib880A/640?wx_fmt=png)

最后使用 POST 方式将加密数据上传到 “http://4895750.c1.biz/up.php?name={HostName}”

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNo1xZqMUjJiaEMZwyVY7Z2hU21vZVX9X67QZH6BibvX1UKDEKuGiaD4b0g/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNz5yxtqJdwxqodQo8OmtVlMmdU4UHsJHMZq07OLtvgBvNicN1la6ibI5Q/640?wx_fmt=png)

并且通过 InternetReadFile 函数读取返回结果，如果结果为 “success!” 则表示成功。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNTYqA5eXGr2tBsaxS57Tb8hVPC4RcTTSKGibAnWMCUlLLhRRtFtmSx9w/640?wx_fmt=png)

另外，远控指令主要是向服务端 “4895750.c1.biz/dn.php?name={HostName}&prefix=cc(count)” 发送 Get 请求获取，其中 count 表示连接次数。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNXBB1LrKwnib6Yiaoh6ibO6JBh9uTqNY4elXDypPfLic4jdeliaJn1ppT5ibw/640?wx_fmt=png)

执行的部分命令如下：  

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNxRbPmhL5vCI6iaLYp31YcVKbF3TovTNDJNkXVAGrTl0e3j9LU14ibqTA/640?wx_fmt=png)

远控样本所支持的命令完整格式如下：

<table cellspacing="0" cellpadding="0"><tbody><tr><td width="75.33333333333333" valign="top"><section><strong>一级命令<o:p></o:p></strong></section></td><td width="55.33333333333333" valign="top"><section><strong>参数 1</strong><strong><o:p></o:p></strong></section></td><td width="60.33333333333333" valign="top"><section><strong>参数 2</strong><strong><o:p></o:p></strong></section></td><td width="261.3333333333333" valign="top"><section><strong>操作<o:p></o:p></strong></section></td></tr><tr><td width="80" valign="top"><section>/stext<o:p></o:p></section></td><td width="55.33333333333333" valign="top"><br></td><td width="65.33333333333333" valign="top"><br></td><td width="261.3333333333333" valign="top"><section>以 SYSTEM 权限执行下载的文件，并保存结果<o:p></o:p></section></td></tr><tr><td width="80" valign="top"><section>/user<o:p></o:p></section></td><td width="55.33333333333333" valign="top"><br></td><td width="65.33333333333333" valign="top"><br></td><td width="261.3333333333333" valign="top"><section>以用户权限执行文件<o:p></o:p></section></td></tr><tr><td width="80" valign="top"><section>/user<o:p></o:p></section></td><td width="55.33333333333333" valign="top"><section>/stext 或 &gt;<o:p></o:p></section></td><td width="65.33333333333333" valign="top"><br></td><td width="261.3333333333333" valign="top"><section>以用户权限执行, 并保存结果<o:p></o:p></section></td></tr><tr><td width="80" valign="top"><section>cmd<o:p></o:p></section></td><td width="55.33333333333333" valign="top"><section>pull<o:p></o:p></section></td><td width="65.33333333333333" valign="top"><section>/f<o:p></o:p></section></td><td width="261.3333333333333" valign="top"><section>将文件复制到临时目录，然后再上传<o:p></o:p></section></td></tr><tr><td width="80" valign="top"><section>cmd<o:p></o:p></section></td><td width="55.33333333333333" valign="top"><section>pull<o:p></o:p></section></td><td width="65.33333333333333" valign="top"><br></td><td width="261.3333333333333" valign="top"><section>上传指定文件<o:p></o:p></section></td></tr><tr><td width="80" valign="top"><section>cmd<o:p></o:p></section></td><td width="55.33333333333333" valign="top"><section>&gt;<o:p>&nbsp;</o:p></section></td><td width="65.33333333333333" valign="top"><br></td><td width="261.3333333333333" valign="top"><section>远程 shell 并将结果保存到临时目录<o:p></o:p></section></td></tr><tr><td width="80" valign="top"><section>cmd<o:p></o:p></section></td><td width="55.33333333333333" valign="top"><br></td><td width="65.33333333333333" valign="top"><br></td><td width="261.3333333333333" valign="top"><section>远程 shell<o:p></o:p></section></td></tr><tr><td width="80" valign="top"><section>cmd<o:p></o:p></section></td><td width="55.33333333333333" valign="top"><section>chmod<o:p></o:p></section></td><td width="65.33333333333333" valign="top"><br></td><td width="261.3333333333333" valign="top"><section>保存指定文件<o:p></o:p></section></td></tr><tr><td width="80" valign="top"><section>cmd<o:p></o:p></section></td><td width="55.33333333333333" valign="top"><section>put<o:p></o:p></section></td><td width="65.33333333333333" valign="top"><br></td><td width="261.3333333333333" valign="top"><section>移动文件到指定目录<o:p></o:p></section></td></tr></tbody></table>

除上述提到以外的命令，主要是以 SYSTEM 权限执行下载的文件。

 **二、关联分析** 
============

在今年早些时候，我们也发现了 Konni 组织针对韩国地区的多个攻击样本，关联样本 1 信息如下表所示：

<table cellspacing="0" cellpadding="0"><tbody><tr><td width="99" valign="top"><section><strong>文件名称<o:p></o:p></strong></section></td><td width="315" valign="top"><section>카뱅과&nbsp;&nbsp;손잡은코인원_비트독주&nbsp;&nbsp;체제무너뜨릴까.docx<o:p></o:p></section></td></tr><tr><td width="99" valign="top"><section><strong>文件大小<o:p></o:p></strong></section></td><td width="315" valign="top"><section>1.50 MB (1568752 字节)<o:p></o:p></section></td></tr><tr><td width="99" valign="top"><section><strong>MD5<o:p></o:p></strong></section></td><td width="315" valign="top"><section>00e6e9ed4666623860686c123ed334f0<o:p></o:p></section></td></tr></tbody></table>

Konni 组织使用加密货币相关文件名和内容诱导用户点击运行，其执行流程与上述分析类似，首先从远端地址 http://word2022.c1.biz/template.dotm 下载恶意宏模板，宏代码设置字体为黑色，执行前后伪装内容如下所示。

<table cellspacing="0" cellpadding="0" width="578"><tbody><tr><td width="207" valign="top"><section><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhN2YXgNunzsYcSXoUAq36dJnmcjiaW61X0wKxIVz3sJZeicialyHD0llbPA/640?wx_fmt=png"></section></td><td width="207" valign="top"><section><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNFwTNBnPJCEIspPO3dF7F9aLpFyXqTzE5xBDGQWiaayxQRu0kD6LqIiag/640?wx_fmt=png"></section></td></tr></tbody></table>

接着收集主机的操作系统版本信息、主机名、IP 地址信息并发送给服务器，收集此类信息可用于后续更加精准的攻击行动中。需要特别注意的是，该样本宏代码中没有后续下载 CAB 文件并解压执行的过程，因此判断该样本主要是前期侦察模块。

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4Ppiapr9weKDysvZCQ3TErZr1ERRoicF9ylTfCt1GFMY8K64kiaWvictRK9Cxrp1cS54cHWwRHXMCogtQA/640?wx_fmt=png)

此外，通过分析之前捕获的 Konni 组织样本，发现该组织前期使用的恶意文档是从自身释放 CAB 并解压执行其中脚本文件，这种方式没有远端加载 CAB 灵活，并且也容易暴露使用的恶意载荷。

关联样本 2 信息如下表所示：

<table cellspacing="0" cellpadding="0"><tbody><tr><td width="99" valign="top"><section><strong>文件名称<o:p></o:p></strong></section></td><td width="315" valign="top"><section>보상명부.xlam<o:p></o:p></section></td></tr><tr><td width="99" valign="top"><section><strong>文件大小<o:p></o:p></strong></section></td><td width="315" valign="top"><section>145.43 KB (148924 字节)<o:p></o:p></section></td></tr><tr><td width="99" valign="top"><section><strong>MD5<o:p></o:p></strong></section></td><td width="315" valign="top"><section>cf5f18032667bfb4c7373191e7fb1fbf<o:p></o:p></section></td></tr></tbody></table>

其利用宏从自身解压出 rels.xml 文件（实为 CBA 载荷），再利用 expand 解压 rels.xml 并执行其中的 check.bat 文件，后续流程和本次攻击基本一致，不再详细描述。       

![](https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4Ppiapr9weKDysvZCQ3TErZr1pdUkmFavfY0AnQFZYCTNwXfzpWX2WewZ3zex9Dq7ibmqM7rCvCSVV2Q/640?wx_fmt=png)

 **三、归属研判** 
============

Konni 组织本次针对韩国地区的攻击，跟之前针对俄罗斯地区使用的载荷相似度很高，主要集中体现在如下方面：

1. 在诱饵文档显示上依然保持着该组织的一贯风格，即成功执行后才将不易阅读的文字置黑显示出来，这个是该组织的一个显著特点；

2. 和以前样本一样都采用 CAB 格式文件层层加载载荷，只是 CAB 文件获取方式不完全相同，此外批处理脚本也十分类似;

<table cellspacing="0" cellpadding="0"><tbody><tr><td width="414" valign="top"><section><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4PpMNTic5Hartbkib8R7HmEyhNgQyoficGjZllXbZWQciagg9uRg6pKBGUpWAWgU5c1rJbWzW4I9dmqTZQ/640?wx_fmt=png"></section></td></tr><tr><td width="414" valign="top"><section><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/6CNEHNicic4Ppiapr9weKDysvZCQ3TErZr1y3icf350geVsRCNWMic6skFwEqrzDbKyMUWbibb8ZyLNRrNCc6bib6KciaA/640?wx_fmt=png"></section></td></tr></tbody></table>

3. 最终的远控模块功能相似，并且通信流量上也类似，如 4895750.c1.biz/dn.php?name={HostName}&prefix=cc(count)，其中 count 表示连接次数，从零开始。之前该组织使用过 / dn.php?client_id={主机 ID}&prefix=cc(count) 类似的 URL 格式。

最后结合到该样本是针对韩国地区的攻击，符合该组织一直以来的攻击目标，综上，本次攻击归于 Konni 组织。

  

**总结**

  

Konni 组织自被披露以来长期针对周边国家及地区的网络攻击行动，并且有愈演愈烈的趋势。在本轮攻击中，该组织一如既往的使用恶意文档作为攻击载体，将多个恶意模块打包成 CAB 格式进行攻击, 并且在 CAB 文件的下发方式上呈现出多样化的特点。这都表明该组织在持续地进行更新恶意代码的功能和形态，呈现出功能化模块化的特点，并开发适配不同的系统环境攻击组件。

此外，本文披露的相关恶意代码、C2 只是 Konni 组织针对韩国地区攻击过程中使用的部分武器，该组织不会因为一次攻击行动的暴露而停止活动，反而会持续更新其载荷，后期我们也将持续关注该组织的针对韩国及其他地区的攻击武器。       

**附录 IOC**

cf5f18032667bfb4c7373191e7fb1fbf

7b27586c4b332c5e87784c8d3e45a523

00e6e9ed4666623860686c123ed334f0

2c0db5d995d997a7687f527c493b4c89

7c77fbf78a0e15be66f9edee7ab21084

0567c9fa7c535e8d09fc5d1c712c66bf

ad868a784cb0303aeb02666fe70495f6

f2ffb3cb75535e4ef70b195de68fd330

020e326d4db035b61f66407acb74521d

f0105f3127de410360a2ed80d697b059

a7da2aaaa7efdd9ee74fc5e517be30b2

50551b96e321fe1b478b7bba77c573e6

a6736c776d6d44cec7ec07b9fb628ec3

1ae5b24456d9751dbd15c5c4fccef261

8e50622992a4b4b33127c34ff3fdbd30

1536e9bf086982c072c2cba7d42b0a62

8ef69701c52dc78df0df1dd0bb4c9f36

2211d9356dd7aeced0ee7b2a05077c75

079be709ce7e57f4015b0ca8347e8a29

371d4255ffe03274f016395fe3a4e380

8a37c1614aed81a2b9d1f44cf84e2515

           

rq7592.c1[.]biz

4895750.c1[.]biz

word2022.c1[.]biz

5645780.c1[.]biz

k22012.c1[.]biz

           

http://k22012.c1[.]biz/paypal.dotm

http://5645780.c1[.]biz/index.php?user_id=trap&auth=trap&pw=trap

http://word2022.c1[.]biz/template.dotm

http://word2022.c1[.]biz/index.php?os={OSVersion}&name={HostName}&ip={IP}

http://4895750.c1[.]biz/dn.php?name={HostName}&prefix=cc(count)

http://4895750.c1[.]biz/up.php?name={HostName}

http://rq7592.c1[.]biz/up.php?name={HostName}

http://rq7592.c1[.]biz/dn.php?name={HostName}&prefix=cc(count)

往期推荐

<table width="100%"><tbody><tr opera-tn-ra-comp="_$.pages:0.layers:0.comps:3.classicTable1:0" powered-by="xiumi.us"><td colspan="1" rowspan="1" opera-tn-ra-cell="_$.pages:0.layers:0.comps:3.classicTable1:0.td@@0" width="100.0000%"><section powered-by="xiumi.us"><section><table width="100%"><tbody><tr opera-tn-ra-comp="_$.pages:0.layers:0.comps:3.classicTable1:0.td@@0:0.classicTable1:0" powered-by="xiumi.us"><td colspan="1" opera-tn-ra-cell="_$.pages:0.layers:0.comps:3.classicTable1:0.td@@0:0.classicTable1:0.td@@0" rowspan="2" style="border-color: rgb(62, 62, 62);border-style: none;background-position: 13.4798% 0%;background-repeat: no-repeat;background-size: 145.021%;background-attachment: scroll;vertical-align: bottom;background-image: url(&quot;https://mmbiz.qpic.cn/sz_mmbiz_jpg/pLEuriaaPnU0R7Sgszppt1hGwn9OdEenwSJxdz5dJxef9FCzB4AxEIpOARnia5REfFoHO7nc33rYYXCr652AochQ/640?wx_fmt=jpeg&quot;);box-sizing: border-box;padding: 0px;" width="30.0000%"><section powered-by="xiumi.us"><section><p><strong>01</strong></p></section></section></td><td colspan="1" rowspan="1" opera-tn-ra-cell="_$.pages:0.layers:0.comps:3.classicTable1:0.td@@0:0.classicTable1:0.td@@1" width="70.0000%"><section powered-by="xiumi.us"><section><p>● 数字安全写入顶层规划，360 数字安全中国方案成果初现</p></section></section></td></tr><tr opera-tn-ra-comp="_$.pages:0.layers:0.comps:3.classicTable1:0.td@@0:0.classicTable1:1" powered-by="xiumi.us"><td colspan="1" rowspan="1" opera-tn-ra-cell="_$.pages:0.layers:0.comps:3.classicTable1:0.td@@0:0.classicTable1:1.td@@0" width="70.0000%"><section powered-by="xiumi.us"><section><p>► <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzA4MTg0MDQ4Nw==&amp;mid=2247558374&amp;idx=1&amp;sn=4951992c3482c0e6b5a20684f396279d&amp;chksm=9f8d74eea8fafdf809272cc0779bad53bb6c196073932d13b61a8eca5389f46a9350ad694dd2&amp;scene=21#wechat_redirect" textvalue="点击阅读" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">点击阅读</a></p></section></section></td></tr></tbody></table></section></section></td></tr><tr opera-tn-ra-comp="_$.pages:0.layers:0.comps:3.classicTable1:1" powered-by="xiumi.us"><td colspan="1" rowspan="1" opera-tn-ra-cell="_$.pages:0.layers:0.comps:3.classicTable1:1.td@@0" width="100.0000%"><section powered-by="xiumi.us"><section><table width="100%"><tbody><tr opera-tn-ra-comp="_$.pages:0.layers:0.comps:3.classicTable1:1.td@@0:0.classicTable1:0" powered-by="xiumi.us"><td colspan="1" opera-tn-ra-cell="_$.pages:0.layers:0.comps:3.classicTable1:1.td@@0:0.classicTable1:0.td@@0" rowspan="2" style="border-color: rgb(62, 62, 62);border-style: none;background-position: 46.8571% 3.99653%;background-repeat: no-repeat;background-size: 116.655%;background-attachment: scroll;vertical-align: bottom;background-image: url(&quot;https://mmbiz.qpic.cn/sz_mmbiz_jpg/pLEuriaaPnU0R7Sgszppt1hGwn9OdEenwp5YEm0EaZEI536Z00Noaxib3KaxUZ2gDN0zicO6Vq97ecCicibUD9NcKYw/640?wx_fmt=jpeg&quot;);box-sizing: border-box;padding: 0px;" width="30.0000%"><section powered-by="xiumi.us"><section><p><strong>02</strong></p></section></section></td><td colspan="1" rowspan="1" opera-tn-ra-cell="_$.pages:0.layers:0.comps:3.classicTable1:1.td@@0:0.classicTable1:0.td@@1" width="70.0000%"><section powered-by="xiumi.us"><section><p>● 《2022 年度反诈报告》重磅发布！</p></section></section></td></tr><tr opera-tn-ra-comp="_$.pages:0.layers:0.comps:3.classicTable1:1.td@@0:0.classicTable1:1" powered-by="xiumi.us"><td colspan="1" rowspan="1" opera-tn-ra-cell="_$.pages:0.layers:0.comps:3.classicTable1:1.td@@0:0.classicTable1:1.td@@0" width="70.0000%"><section powered-by="xiumi.us"><section><p>► <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzA4MTg0MDQ4Nw==&amp;mid=2247558006&amp;idx=1&amp;sn=0d7f5b1be1a15204e862955f3aa20448&amp;chksm=9f8d737ea8fafa6827ec8b8c84b957eaeb8ed3e5b1ce79e94c22a302217fa675904f1953eae4&amp;scene=21#wechat_redirect" textvalue="点击阅读" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">点击阅读</a></p></section></section></td></tr></tbody></table></section></section></td></tr><tr opera-tn-ra-comp="_$.pages:0.layers:0.comps:3.classicTable1:2" powered-by="xiumi.us"><td colspan="1" rowspan="1" opera-tn-ra-cell="_$.pages:0.layers:0.comps:3.classicTable1:2.td@@0" width="100.0000%"><section powered-by="xiumi.us"><section><table width="100%"><tbody><tr opera-tn-ra-comp="_$.pages:0.layers:0.comps:3.classicTable1:2.td@@0:0.classicTable1:0" powered-by="xiumi.us"><td colspan="1" opera-tn-ra-cell="_$.pages:0.layers:0.comps:3.classicTable1:2.td@@0:0.classicTable1:0.td@@0" rowspan="2" style="border-color: rgb(62, 62, 62);border-style: none;background-position: 5.47849% 0%;background-repeat: no-repeat;background-size: 223.994%;background-attachment: scroll;vertical-align: bottom;background-image: url(&quot;https://mmbiz.qpic.cn/sz_mmbiz_png/pLEuriaaPnU0R7Sgszppt1hGwn9OdEenwXXrDszdd5VaCmHmGdScc3xv8avPB3PRLibphzjqPc37mRlfUKz7OEVQ/640?wx_fmt=png&quot;);box-sizing: border-box;padding: 0px;" width="30.0000%"><section powered-by="xiumi.us"><section><p><strong>03</strong></p></section></section></td><td colspan="1" rowspan="1" opera-tn-ra-cell="_$.pages:0.layers:0.comps:3.classicTable1:2.td@@0:0.classicTable1:0.td@@1" width="70.0000%"><section powered-by="xiumi.us"><section><p>● 对症下药！360 开出以浏览器为核心的业务与数据安全解决方案</p></section></section></td></tr><tr opera-tn-ra-comp="_$.pages:0.layers:0.comps:3.classicTable1:2.td@@0:0.classicTable1:1" powered-by="xiumi.us"><td colspan="1" rowspan="1" opera-tn-ra-cell="_$.pages:0.layers:0.comps:3.classicTable1:2.td@@0:0.classicTable1:1.td@@0" width="70.0000%"><section powered-by="xiumi.us"><section><p>► <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzA4MTg0MDQ4Nw==&amp;mid=2247559565&amp;idx=1&amp;sn=a30fbc680b0dc191dc9d6acd215a47ff&amp;chksm=9f8d7985a8faf093e593d914fa5c7cbfc6487e703915a91fc472c2da8f863a5e4d4ab6d094ad&amp;scene=21#wechat_redirect" textvalue="点击阅读" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">点击阅读</a></p></section></section></td></tr></tbody></table></section></section></td></tr><tr opera-tn-ra-comp="_$.pages:0.layers:0.comps:3.classicTable1:3" powered-by="xiumi.us"><td colspan="1" rowspan="1" opera-tn-ra-cell="_$.pages:0.layers:0.comps:3.classicTable1:3.td@@0" width="100.0000%"><section powered-by="xiumi.us"><section><table width="100%"><tbody><tr opera-tn-ra-comp="_$.pages:0.layers:0.comps:3.classicTable1:3.td@@0:0.classicTable1:0" powered-by="xiumi.us"><td colspan="1" opera-tn-ra-cell="_$.pages:0.layers:0.comps:3.classicTable1:3.td@@0:0.classicTable1:0.td@@0" rowspan="2" style="border-color: rgb(62, 62, 62);border-style: none;background-position: 44.898% 0%;background-repeat: no-repeat;background-size: 121.304%;background-attachment: scroll;vertical-align: bottom;background-image: url(&quot;https://mmbiz.qpic.cn/sz_mmbiz_jpg/pLEuriaaPnU0R7Sgszppt1hGwn9OdEenwY9QnJhJnwicxYIXIIuia3NXHjAvZWOUBuM4NGzIEPS4VH25yiaVbBqibPw/640?wx_fmt=jpeg&quot;);box-sizing: border-box;padding: 0px;" width="30.0000%"><section powered-by="xiumi.us"><section><p><strong>04</strong></p></section></section></td><td colspan="1" rowspan="1" opera-tn-ra-cell="_$.pages:0.layers:0.comps:3.classicTable1:3.td@@0:0.classicTable1:0.td@@1" width="70.0000%"><section powered-by="xiumi.us"><section><p>● 事关企业财务安全！360 再次发布钓鱼攻击预警</p></section></section></td></tr><tr opera-tn-ra-comp="_$.pages:0.layers:0.comps:3.classicTable1:3.td@@0:0.classicTable1:1" powered-by="xiumi.us"><td colspan="1" rowspan="1" opera-tn-ra-cell="_$.pages:0.layers:0.comps:3.classicTable1:3.td@@0:0.classicTable1:1.td@@0" width="70.0000%"><section powered-by="xiumi.us"><section><p>► <a target="_blank" href="http://mp.weixin.qq.com/s?__biz=MzA4MTg0MDQ4Nw==&amp;mid=2247559280&amp;idx=1&amp;sn=fa18adffa2aa616059187d80ffd11a4b&amp;chksm=9f8d7878a8faf16ea560fe1b42dc6b5c3a8af0f5b88d2687a384dfa80f67b505e5cba2b49d47&amp;scene=21#wechat_redirect" textvalue="点击阅读" linktype="text" imgurl="" imgdata="null" data-itemshowtype="0" tab="innerlink" data-linktype="2">点击阅读</a></p></section></section></td></tr></tbody></table></section></section></td></tr></tbody></table>