> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/RmB0KuflveGhF0oY6LVktA) ![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESsicNPUpG79LDibBcMVSmrA1vq6ncaOiaAohRdFWRo2ap2E3hu84n356kQ/640?wx_fmt=png)

使用 openvpn docker 及 frp docker 工具构建虚拟专业网络 (V-P-N)
=================================================

借助 Docker 和 OpenVPN 技术，您可以在短时间内设置并运行 VPN 服务器，并保证您的服务器安全。

运行环境
----

Ubuntu 16.04 TLS Docker version 19.03.8, build afacb8b7f0 OpenVPN Android Client 0.7.43

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESKGnOEtGxk6dTk9HYdElIHIRehXkoqTRHY23eVIZk7nicusBACXjEIBw/640?wx_fmt=png)

创建 OpenVPN Docker 容器
--------------------

1.  1. 安装 Docker：如果您的系统上没有安装 Docker，请先按照适用于您的操作系统的指南安装 Docker。在 Ubuntu 上，可以使用以下命令安装 Docker：
    

```
sudo apt update
sudo apt install docker.io

```

1.  1. 获取 OpenVPN Docker 镜像：使用以下命令从 Docker Hub 上获取 OpenVPN 镜像：
    

```
sudo docker pull kylemanna/openvpn

```

1.  1. 创建 OpenVPN 配置目录：创建一个目录用于保存 OpenVPN 配置文件和证书：
    

```
OVPN_DATA="ovpn-data-test"
docker volume create --name $OVPN_DATA

```

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESyPicIhFrInMniajNwsMAZkfvJ83yvBGIezsickZIDOAnBg8mX21z0yG8g/640?wx_fmt=png)

执行上述命令后，会在 docker 默认数据及配置保存目录`/var/lib/docker/volumes`下创建 openvpn 的配置目录`ovpn-data-test`

1.  1. 初始化 OpenVPN 配置：使用以下命令初始化 OpenVPN 配置和证书。替换`YourPublicIP.com`为您希望访问 OpenVPN 服务器的公共 IP 地址或域名。
    

```
sudo docker run -v $OVPN_DATA:/etc/openvpn --log-driver=none --rm kylemanna/openvpn ovpn_genconfig -u udp://YourPublicIP.com

```

如果你是本地创建 VPN server，那么这里`YourPublicIP.com` 应该填写你本地 IP 地址。

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESk7ggicQ9E9ub4Pum3Nzib4yzbfJsiaJ1MUpxf0CMxlMlCkbvnPvzfk7jA/640?wx_fmt=png)

生成安全证书并运行 OpenVPN server
------------------------

1.  1. 生成 OpenVPN 服务器证书：使用以下命令生成 OpenVPN 服务器的证书和密钥。
    

```
sudo docker run -v $OVPN_DATA:/etc/openvpn --rm -it kylemanna/openvpn ovpn_initpki

```

输入 "yes"，然后按 Enter 键，如下所示，以启动 OpenVPN PKI 系统。

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESRdmXlgOrPc57rnAGDUy9ETrJxLgobap8yzeR5LNZmegicRr4gMp4vJA/640?wx_fmt=png)Initiating the OpenVPN PKI system

输入 CA 证书密码，或者输入 Enter

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESdQyccCk98ZpicLKW8zY2M1856gU6mKWKsdsJfot8wv6IcvWfXLKtUNA/640?wx_fmt=png)Setting a new CA certificate password

为 CA 证书输入一个名称，或者输入 Enter

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESTH135cHCuCDSQgP8L3ZPBlpJKxandjlDjUIoeo9mplqxmcu1ibDMDuw/640?wx_fmt=png)Naming the new CA certificate

输入在第 2 步设置的 CA 密码，以检查请求是否匹配签名。

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESUvxpxicJdSqLtdYd4LEAn9ibdsKIwNc5C4PNDbeHhvtS6znz2XiaszovQ/640?wx_fmt=png)Checking \the request matches the signature

再次输入密码生成 ca 私钥

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESQW2DggBr67GlVZiblibv9nxgecdAU1mCPykl56K804X2RZ2bbWC7oHcw/640?wx_fmt=png)Generate a private key by entering the CA passphrase

2. 使用以下命令启动 OpenVPN 服务器：

```
sudo docker run -v $OVPN_DATA:/etc/openvpn -d -p 1194:1194/udp --cap-add=NET_ADMIN kylemanna/openvpn

```

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESicWfoNic2uialicHXNcuqAOHiccianqQrFPx0fU5fAlHr8iciaAGXNrv9gmsPg/640?wx_fmt=png)

`--cap-add=NET_ADMIN`参数通过修改 Docker 默认不授予的网络接口来应用额外的 Linux 能力。

生成 OpenVPN client 证书
--------------------

1.  1. 生成客户端配置文件：使用以下命令生成 OpenVPN 客户端配置文件。将`CLIENTAPP`替换为您希望的客户端名称。
    

```
sudo docker run -v $OVPN_DATA:/etc/openvpn --rm -it kylemanna/openvpn easyrsa build-client-full CLIENTAPP nopass

```

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESzhrwZicWNT0yPC6sMddy02U3l4zoicZLRghmYvaR3jg9xDybAhR704Aw/640?wx_fmt=png)

```
sudo docker run -v $OVPN_DATA:/etc/openvpn --rm kylemanna/openvpn ovpn_getclient CLIENTAPP > CLIENTAPP.ovpn

```

将生成的`CLIENTAPP.ovpn`客户端证书拷贝到你的 Android Client。

现在，您已经成功安装了 OpenVPN 服务器，并生成了一个客户端配置文件。将`CLIENTAPP.ovpn`文件发送给您的客户端，并使用 OpenVPN 客户端连接到您的 OpenVPN 服务器即可。

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CES6zE1jRibdcC96cvia1ZdAXxhlHhE7KibItsnHwzlbBaYrmbFCEgXR4FWQ/640?wx_fmt=png)成功连接效果图

VPN server 内网穿透
---------------

如果 openvpn server 是在局域网内部署，则还需要使用 frp 工具进行穿透，关于 frp 内网穿透内容参考如下：

> https://blog.csdn.net/u011897062/article/details/131764782

具体到本文中的 openvpn frp 配置及命令如下： 服务端：frps `frps.init`文件不需要修改，需要在启动命令中增加`7002`端口的映射

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESIhvs79bicONicKWnCyLfzRmfVia96w17edMcYaNBw4GVHJq32AzNxvCcQ/640?wx_fmt=png)

客户端: frpc `/opt/frpc.init`增加 vpn 配置

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESu6ToibSO3iaPt3hvia5CFnFJbCfFCcNUkmicg0sVI8Fw3BzKxFqt4PrWpw/640?wx_fmt=png)

docker 运行命令增加 1194 映射

```
docker run --restart=always -d   --network host   -v /opt/frpc.ini:/etc/frp/frpc.ini   -p 80:80/tcp  -p 1194:1194/udp  --name frpc   snowdreamtech/frpc

```

`CLIENTAPP.ovpn`中`remote 0.0.0.0 7002 udp` 需要修改为`remote PublicIP.com 7002 udp`

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESGMZuqrwgW5aZTtWIr3lIqTD9B4YyY2Zp0F3356CUIQS81icicGrneoaA/640?wx_fmt=png)

OpenVPN 使用 Web UI 管理
--------------------

为了方便 OpenVPN server 的管理，官方提供了 Web UI 管理页面

*   • 下载`openvpn-as` docker 我们仍然使用 docker 来安装，命令如下：
    

```
docker pull linuxserver/openvpn-as

```

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CES8t3CSy3qI1XcxvUEicne4hB2lx2ELgbo9wDicGYic17Q2xqdiaFnmDIwbQ/640?wx_fmt=png)

*   • 创建 docker 容器
    

```
docker create --name=openvpn-as --restart=always -v /home/docker/openvpn-as/config:/config -e INTERFACE=eth0 -e PGID=1001 -e PUID=1001 -e TZ=Africa/Nairobi --net=host --privileged linuxserver/openvpn-as


```

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESvNAgVPt8XngFLCDNo9bf0Pl1Ib2I5cxj4w1eCibbMNK6KjsIN2NqNdA/640?wx_fmt=png)Creating a new Docker container (openvpn-as)

*   • 启动`openvpn-as`容器
    

```
docker start openvpn-as

```

*   • 登录 Web UI 使用`https://YourIP:943/admin`登录 admin 管理页面
    
    > 注意: 默认账号密码为`admin`和`password`![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESxRqBPtVUR14FKkhRDCneuc80QglABapXG1icr1AQSkfJYZFqq8LIdng/640?wx_fmt=png)openvpn web ui 登录 openvpn-as 后效果如下：![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESn3xdkbD75Os0yrhQllk3YE5T0xUQDIHYnoG6WIUV8fyQ5ggptwZniaA/640?wx_fmt=png)Accessing the OpenVPN Access Server dashboard
    

配置 DNS 以获得更快和更安全的连接
-------------------

目前，您的 OpenVPN Access Server 已经正确工作。但为了提高 VPN 服务器的性能，您需要配置 DNS。

要配置 DNS，您需要访问 OpenVPN 服务器的 Web 界面，并使用 Google 或您喜欢的 DNS 地址更新 DNS 设置。Google 提供了最快速的 DNS 服务器，您将在您的 OpenVPN Access Server 中使用它们。

1.  1. 在 OpenVPN Access Server 仪表板的 CONFIGURATION 选项卡下，点击左侧面板中的 VPN 设置。
    

滚动到 DNS 设置部分，启用 “Have clients use Specific DNS servers” 选项，如下所示。

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CES6ELIe0YureJ7IeVOIJGvnGR82XaxIDN70YtKKrccXdYBASgl5tq9oA/640?wx_fmt=png)Enabling custom OpenVPN DNS addresses

1.  1. 接下来，更新主 DNS 服务器（8.8.8.8）和次 DNS 服务器（8.8.8.4）为 Google DNS 地址，然后点击 “Save Settings” 保存更改。
    

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESsckicl3VKvYu3uVNZ4f9a2G14wgaibqpE5UV3HnaicjqiceuOIwu0sIGHw/640?wx_fmt=png)Setting custom OpenVPN DNS addresses

1.  1. 保存更改后，点击 “Update Running Server” 重新启动服务器，以使更改生效。
    

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CES9rB6gX41yb6qria2Ap47CNosDjq9C8PiaTBPBr3t125BA5eY3J8WkNiaA/640?wx_fmt=png)Updating the server settings

1.  1. 现在，在您的 Linux 机器上导航到 OpenVPN Access Server（例如 https://YourIP:943/admin）。将 YourIP 替换为您服务器的 IP 地址。如果配置正确，您将看到如下所示的相同页面。
    

使用默认凭据（用户名：admin，密码：password）登录。

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESKc8FfJlvibZbOynRKsHibb4ZexkywV8myB6Hh9UxCaic2c74zunS3l20w/640?wx_fmt=png)Logging in to OpenVPN Access Server

1.  1. 点击任何平台图标下载客户端应用程序，然后点击 “Yourself (user-locked profile)” 下载客户端. ovpn 文件。
    
    ![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESYUmwYia0alv9tszvEJUNticiaXPH8DIFQKCnhXfyjGKctHU4IHmLXTvMA/640?wx_fmt=png)Downloading the .ovpn config file and client app
2.  2. 最后，启动您下载的 OpenVPN 客户端，并像在 “使用证书保护 OpenVPN 客户端” 教程的最后一步中那样导入. ovpn 文件。
    

![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESIfmeN3ofRjicwFVsWBThwRIbWqyvmbKCJgTVcibwt3meyZ6XjoVHDIAA/640?wx_fmt=png)Connecting to the OpenVPN server

结论
--

托管您的 VPN 服务器绝不应该是一个复杂的任务，更不用说保护服务器连接了。幸运的是，OpenVPN Docker 就在眼前，拯救了一切。在本教程中，您已经学会了在 Ubuntu 上使用 Docker 安装、设置和配置 OpenVPN。您还了解了如何通过 OpenVPN CA 和客户端证书保护 Docker 容器中的 OpenVPN 访问。

除了通过命令行界面访问 OpenVPN 服务器外，您现在还可以通过 OpenVPN Access Server 的 Web 界面进行可视化操作。通过为 OpenVPN 客户端应用程序生成客户端配置文件，您已经实现了快速部署 VPN。

Github
------

> https://github.com/kylemanna/docker-openvpn![](https://mmbiz.qpic.cn/mmbiz_png/hfx5bHOBa3IStmGmsUTufIH9skrf0CESkdVW5GVpsbiaib9cR59yrqjVOia2BvbHt15X14NEhviarPs3Eibr3ibP1Iiaw/640?wx_fmt=png)

参考
--

> (Fundamentals of Running OpenVPN in Docker on Ubuntu) https://adamtheautomator.com/openvpn-in-docker/

> (frp+openvpn+docker 实现内网穿透) https://www.jianshu.com/p/8bffa1046008

> https://medium.com/@gurayy/set-up-a-vpn-server-with-docker-in-5-minutes-a66184882c45