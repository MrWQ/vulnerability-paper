> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/WUVGiU5K1YNTNX5B1w9hPg)

1. 需要环境
-------

> kali 环境 / 其他 Linux / windows / macOSpython3.8.0frida12.8.0     / Android 8 以下用这个版本 高版本直接最新 frida server 12.8.0frida-tools 5.3.0objection 1.8.4Redmi5A ROM:PixelExperience / 其他 root 的均可 x 音漫客 app 最新版

2.kali frida 环境搭建
-----------------

*   首先安装 python （python3.8.0)
    
*   安装 frida 12.8.0
    

*   pip install frida==12.8.0
    

*   frida-tools 5.3.0
    

*   pip install frida-tools==5.3.0
    

*   objection 1.8.4
    

*   pip install objection==1.8.4
    

3. 手机安装 kali frida server 12.8.0
--------------------------------

> 打开 frida12.8.0

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdYhR2KOKqrTwQfCWtmtrJwUkt8bia0eo7PxoTwbDTbZNeI3UfFVhCqOiag/640?wx_fmt=png)

> 这里我们要下载 Android 版本的, 当前下载为 Android-arm64 版本的根据自己的手机去选择下载好之后使用 adb 推送到手机上

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdYHiaUvRBiaZKFkvmngCaicLHKThgH5zqqnWxvncVcGlffJMhBjmQOUar0g/640?wx_fmt=png)

> 我们使用 adb 进入手机运行 frida server

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdYxUGLMOjiclbTfC7VwD3sghJcRNWDBC8XhwSYk1jRZKKGDh7EDd4r90w/640?wx_fmt=png)

> 解压之后改个名字然后需要赋予执行权限 **chmod 777 fr12.8.0**

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdYLJkmsnd95QaO33J0HgyUsXfX7DH8Bia4IjAxyfQMZTFYqq0O0TiatZHQ/640?wx_fmt=png)

> **./fr12.8.0 -D** 后台运行 frida server

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdYGv3bkTIcKG3uibIumRZwecapjaBeo0Ux0EiaAk3fvYFTpoTyOqY1iaBlg/640?wx_fmt=png)

> 继续安装 x 音漫客官网自行下载 **adb install *.apk**

4. 猜测逻辑
-------

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdYE6kKqG86tqO1cqpF6iaRAyhoXsAqJjvHa5cLHoB6iaFZeGQ8JGSAaibtw/640?wx_fmt=png)

> 可以看到有的是带这种有锁的, 也就是开 VIP 后可以看的, 上面的那些则可以免费观看, 可以猜测一下这里有个分支判断是否是 vip 然后走向不同的地方, 那么我们 hook 所有的 onClick 函数看看是什么逻辑

5. 验证逻辑
-------

```
var jclazz = null;
var jobj = null;

function getObjClassName(obj) {
   if (!jclazz) {
       var jclazz = Java.use("java.lang.Class");
  }
   if (!jobj) {
       var jobj = Java.use("java.lang.Object");
  }
   return jclazz.getName.call(jobj.getClass.call(obj));
}

function watch(obj, mtdName) {
   var listener_name = getObjClassName(obj);
   var target = Java.use(listener_name);
   if (!target || !mtdName in target) {
       return;
  }
   // send("[WatchEvent] hooking " + mtdName + ": " + listener_name);
   target[mtdName].overloads.forEach(function (overload) {
       overload.implementation = function () {
           //send("[WatchEvent] " + mtdName + ": " + getObjClassName(this));
           console.log("[WatchEvent] " + mtdName + ": " + getObjClassName(this))
           return this[mtdName].apply(this, arguments);
      };
  })
}

function OnClickListener() {
   Java.perform(function () {

       //以spawn启动进程的模式来attach的话
       Java.use("android.view.View").setOnClickListener.implementation = function (listener) {
           if (listener != null) {
               watch(listener, 'onClick');
          }
           return this.setOnClickListener(listener);
      };

       //如果frida以attach的模式进行attch的话
       Java.choose("android.view.View$ListenerInfo", {
           onMatch: function (instance) {
               instance = instance.mOnClickListener.value;
               if (instance) {
                   console.log("mOnClickListener name is :" + getObjClassName(instance));
                   watch(instance, 'onClick');
              }
          },
           onComplete: function () {
          }
      })
  })
}
setImmediate(OnClickListener);

```

```
使用frida来运行一下 如果错误请换frida版本

```

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdYO6oOsyrAaF8pFyU1uKdEFZkf7JYBuMTkfz6CjGgIWmogZicW0OxziaoQ/640?wx_fmt=png)

> 运行之后点击带锁的按钮会出现 cn.zymk.comic.ui.adapter.DirectoryPictureAdapter.1
> 
> 类名: cn.zymk.comic.ui.adapter.DirectoryPictureAdapter 匿名函数:$1 我们用 jadx 反编译来看下

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdYbLxBsT5YeadibtMVOMCT13JAAXpibQkO4AS4Hm8ibJG9Ks35o4utYBZjw/640?wx_fmt=png)

> 发现并没有搜到我们想要的匿名函数或者这个类

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdYEpW2nPsZvt7gPshKx243hgcOdmD87BTs5qDqCsZ133CktHd8cyXrKw/640?wx_fmt=png)

> 这里可以看出来是百度加固 (碰到的多了而已), 那么我们先去脱下壳了

6. 脱壳
-----

> 这里对于壳的概念就不多做解释了, 我们直接上 frida-dexdump 即可,frida-dexdump 链接 (https://github.com/hluwa/frida-dexdump)
> 
> pip install frida-dexdumpfrida-dexdump -FU 使用方式跟 frida 一样

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdYhL0HaMYAsEAPT0lEuQia9VyPfl0xWWb477PVC8a1yCdtCpic2So5nLYA/640?wx_fmt=png)

> 这里注意一点 -FU 是前置窗口也就是手机当前打开的窗口 如果不是当前窗口请用 frida-dexdump -u -f 包名

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdYredS0C04rj03nsFT8asOltxZCR98PM11ibrUULgCDJZuNNVNopnicqhQ/640?wx_fmt=png)

> 生成了很多的 dex 我们过滤下带有 MainActivity

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdY2eJmSvkicELEQWWiagscLEH3NXBz1kLP0ia8uWkicCqFQlpzvmuylZfic9A/640?wx_fmt=png)

> 可以看出来 08 带有 MainActivity 且是最大的我们直接 jadx classes08.dex 然后在在里面搜一下我们刚刚的那个类

7. 继续分析原理
---------

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdYqicHd7BpDJOXN7rsaxqJsqOba9UPKicy7UW0ia1eibuvVKd0NF7ib5ImGEA/640?wx_fmt=png)

> 这里我们就可以看到了, 双击过去看看他干了什么

```
public void onClick(final View view3) {
               Utils.noMultiClick(view3);
               if (chapterListItemBean.level > 0 && chapterListItemBean.is_release == 0) {
                   PriorityCouponUseDialog.Builder builder = new PriorityCouponUseDialog.Builder(DirectoryPictureAdapter.this.mContext, PriorityCouponUseDialog.DialogType.CLOSE);
                   int i2 = chapterListItemBean.level;
                   PriorityCouponUseDialog show = builder.setChapterData(i2, chapterListItemBean.chapter_name + " " + chapterListItemBean.chapter_title, chapterListItemBean.chapter_id, DirectoryPictureAdapter.this.comicBean.comic_id, DirectoryPictureAdapter.this.comicBean.comic_name, chapterListItemBean.create_time).setOnActionListener(new PriorityCouponUseDialog.OnActionListener() { // from class: cn.zymk.comic.ui.adapter.DirectoryPictureAdapter.1.1
                       @Override // cn.zymk.comic.view.dialog.PriorityCouponUseDialog.OnActionListener
                       public void onClickBack() {
                      }

                       @Override // cn.zymk.comic.view.dialog.PriorityCouponUseDialog.OnActionListener
                       public void onUseCouponFailed() {
                      }

                       @Override // cn.zymk.comic.view.dialog.PriorityCouponUseDialog.OnActionListener
                       public void onUseCouponSuccess() {
                           chapterListItemBean.is_release = 1;
                           DirectoryPictureAdapter.this.notifyDataSetChanged();
                      }
                  }).show();
                   if (DirectoryPictureAdapter.this.mContext instanceof BaseActivity) {
                       DirectoryPictureAdapter.this.mContext.setPriorityCouponUseDialog(show);
                       return;
                  }
                   return;
              }
               int netType = PhoneHelper.getInstance().getNetType();
               if (netType <= 1 || netType > 4) {
                   DirectoryPictureAdapter.this.jump2ReadPage(view3, chapterListItemBean);
              } else {
                   new CustomDialog.Builder(DirectoryPictureAdapter.this.mActivity).setMessage(R.string.no_wifi).setPositiveButton((CharSequence) DirectoryPictureAdapter.this.mActivity.getString(R.string.kown_no_wifi), true, new CanDialogInterface.OnClickListener() { // from class: cn.zymk.comic.ui.adapter.DirectoryPictureAdapter.1.2
                       public void onClick(CanBaseDialog canBaseDialog, int i3, CharSequence charSequence, boolean[] zArr) {
                           DirectoryPictureAdapter.this.jump2ReadPage(view3, chapterListItemBean);
                      }
                  }).setNegativeButton(R.string.cancel, true, (CanDialogInterface.OnClickListener) null).show();
              }
          }

```

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdYDvVYPUQsXGjGhbBWcf0hyL9zfxNkwxXfkbb52xjWkUl3lBQsgMxRXw/640?wx_fmt=png)

> 可以看到不管什么情况都会走到这个函数我们进去看看

```
public void jump2ReadPage(View view, ChapterListItemBean chapterListItemBean) {
       ComicBean comicBean;
       UserBean userBean = App.getInstance().getUserBean();
       if (this.comicBean != null && userBean != null && chapterListItemBean.is_vip == 1 && !Utils.isVip(userBean.isvip)) {
           PayChapterActivity.startActivity((Activity) this.mActivity, this.comicBean.comic_name, this.comicBean.comic_id, chapterListItemBean, Constants.ACTION_BOUGHT_SUCCESS_FROM_DETAIL_2_READ);
      } else if (chapterListItemBean.isRecharge || chapterListItemBean.price <= 0 || (comicBean = this.comicBean) == null) {
           gotoReadPage(view, chapterListItemBean);
      } else if (userBean != null) {
           a.e("userBean.isvip" + userBean.isvip);
           if (Utils.isVip(userBean.isvip) && Utils.chapterChargeVip(chapterListItemBean)) {
               gotoReadPage(view, chapterListItemBean);
          } else if (SetConfigBean.getAutoBuy(this.mActivity)) {
               this.mActivity.buyThisChapter(chapterListItemBean);
          } else {
               PayChapterActivity.startActivity((Activity) this.mActivity, this.comicBean.comic_name, this.comicBean.comic_id, chapterListItemBean, Constants.ACTION_BOUGHT_SUCCESS_FROM_DETAIL_2_READ);
          }
      } else {
           PayChapterActivity.startActivity((Activity) this.mActivity, comicBean.comic_name, this.comicBean.comic_id, chapterListItemBean, Constants.ACTION_BOUGHT_SUCCESS_FROM_DETAIL_2_READ);
      }
  }

```

> 这里的代码就比较清晰了, 可以看到很多的 PayChapterActivity.startActivity, 应该就是跳转到付款窗口那么我们就让 Utils.isVip(userBean.isvip) 这个函数返回 true 看看是否会走到 gotoReadPage, 这里我们需要写 js 的 frida 代码, 需要安装 nodenode 链接

8.frida hook 关键函数
-----------------

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdYxdpia13J8AicnyykBLxdFQELZov3g4cFmic3qh0vaxlCNFEX1VPibht4UQ/640?wx_fmt=png)

```
function HookVip() {
   Java.use("cn.zymk.comic.utils.Utils").isVip.implementation = function (number) {
       // 先看看他原始返回了什么
       var result = this.isVip(number);
       console.log("result = ", result);
       return result;
  }
}

function main() {
   // 主要hook和java相关的函数都需要包含在Java.perform中
   Java.perform(() => {
       HookVip();
  })
}

setImmediate(main)

```

> **frida -UF -l zymk.js** 运行看看

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdYMibgDJ0l9AHjDgQ1TnNdUp3ywgn3L5yjySHDoichHEzvwpUEe6IaJrGw/640?wx_fmt=png)

> 可以看到原始返回是 false 那么我们把他的返回值改了会怎么样呢

```
function HookVip() {
   Java.use("cn.zymk.comic.utils.Utils").isVip.implementation = function (number) {
       // 先看看他原始返回了什么
       // var result = this.isVip(number);
       // console.log("result = ", result);
       // return result;
       return true;
  }
}

function main() {
   Java.perform(() => {
       HookVip();
  })
}

setImmediate(main)

```

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdYzQ8vxHiaHvnmsSCe8OebB9ib6yxcde8RBwWCOlT8bTSCQiaPbct8NxwoQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdYibS0a04ib85rHWpmb6KJibX6IvatjFcnKuGl6c9wuh1pKwfPRyTwVDDCg/640?wx_fmt=png)

> 可以发现我们先跳到了内容界面然后里面, 过了几秒又跳到了充值界面, 那么这里试试直接把这个充值界面 ret 掉看看他能不能过去这个验证

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdYTNlnuBsHha3uKNBW3FzOWUtSXQWib68PDGQcMANCicMAOXn5ZnZ1osTw/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/WGegAIkTRic8p9p9Iv9OHRs0GNkkGVNdYSNzfTCpiaGYx0gkXCjnXhfzCqsEHmeCez5JQic1CEIWXjBqz7mXgdZgw/640?wx_fmt=png)

> 可以发现已经可以正常的观看了

```
function HookVip() {
   Java.use("cn.zymk.comic.utils.Utils").isVip.implementation = function (number) {
       // 先看看他原始返回了什么
       // var result = this.isVip(number);
       // console.log("result = ", result);
       // return result;
       return true;
  }
}

function HookPayChapterActivity(){
   Java.use("cn.zymk.comic.ui.mine.PayChapterActivity").startActivity.overload('android.app.Activity', 'java.lang.String', 'java.lang.String', 'cn.zymk.comic.model.ChapterListItemBean', 'java.lang.String').implementation =
   function(activity, str, str2, chapterListItemBean, str3, z){
       return;
       
  }
}

function main() {
   Java.perform(() => {
       HookVip();
       HookPayChapterActivity();
  })
}

setImmediate(main)

```

9. 总结
-----

> 逆向的过程中要找到自己需要的关键点, 然后跟着关键点去往下寻找找到突破口, 在遇到加固或者混淆的时候尝试去 dump 下 dex, 如果遇到了函数抽取就要去主动调用下让他走一个过程再去 dump,hook 所有的 onClick 可以让我们更快的去定位到关键位置, 如何去分辨 dump 的 dex 中哪个是我们想要的, 可以看相关的 Activity 去排除

![](https://mmbiz.qpic.cn/sz_mmbiz_png/lDgz7FfFgH8GspS8agzAK8LviakibJMSGsr7R6HR4N1ZBWSadPxHRE3FSc7BoQzwJN7JjQGZxKhFibibFv2Rqd8x9g/640?wx_fmt=png)

  

丈八网安蛇矛实验室成立于 2020 年，致力于安全研究、攻防解决方案以及靶场仿真复现等相关方向。团队核心成员均由从事安全行业 10 余年经验的安全专家组成，团队目前成员涉及红蓝对抗、渗透测试、逆向破解、病毒分析、工控安全以及免杀等相关领域。

  

![](https://mmbiz.qpic.cn/mmbiz_png/39G8cQmNrkNsUrJElEdmC2s8KdNTmlboVmySS9fB2xkvoKwJAdWcQffXqz3wOLof7DuGAhnD74UUFPiaS017sibg/640?wx_fmt=png)