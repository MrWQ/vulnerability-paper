> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/c5-wB-OOQyFT-0HBjPorIg)

 **Part1 前言** 

大家好，上期分享了一次 MS12-020 蓝屏漏洞的巧用。这篇文章源于之前做的一个银行红队项目，遇到到了一个 Oracle 数据库的 SQL 注入漏洞，但是网上能搜索到的各种 SQL 语句都没法出数据，所以客户不认可这个漏洞的危害性，于是就开始了对这个 Oracle 的 SQL 注入绕 WAF 的探索过程：

 **P****art2 研究过程** 

*   **SQL 注入判断过程**  
    

经过对 Web 应用一系列的手工漏洞测试，发现这个网站对 Web 漏洞的拦截**至少有两层防护**：

**1.** 外网部署了 WAF 设备拦截，对常规的 SQL 注入关键字有拦截；

**2.** 绕过外围的 Waf 设备后，发现应用程序本身也对 SQL 注入漏洞进行了严格的过滤；

这相当于两个 WAF 串联的情况，非常难解决。接下来看一下这个注入点情况：

使用 burpsuite 不断地抓包重放，当看到这个 POST 请求的时候，proCode=002&specIds=8866@871（防止泄露项目信息，原来的数据包就不贴图了），**发现参数的值中有一个 @符号，直觉和经验告诉我，就觉得这里面会存在安全问题****。**因为我猜想，参数值为了保留 @这个特殊字符，一定会对很多危险字符做出让步。所以重点对 specIds 参数进行了测试，还真发现了 SQL 注入漏洞。这个注入漏洞是这样判断出来的：

proCode=002&specIds=8866@871*(1-0)，返回正常

proCode=002&specIds=8866@871*(1-1)，返回错误

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ASbRYJ5vpZqH2kepmbWicTSvcxvib2GejKpBB7tWw9EdRq20pRXibicmYWiaiabkWJkqL6uFQ6qbic5PReQ/640?wx_fmt=png)

*   **SQL 注入拦截关键字判断**
    

这些都是 SQL 注入漏洞的基础，这里就不细讲了。接下来要做的是通过这个注入漏洞跑出数据，否则客户不认可这个漏洞。

首先看一下这个注入点过滤了哪些字符，specIds 参数经过大量的手工测试，发现至少有以下过滤：

**1.** and、or 、xor、like、true 等常见 SQL 语句的关键字通通不能用，大小写转换也不行。

**2.** substr、ascii、CHR、wm_concat、lower、upper 等 Oracle 常见 sql 语句出数据的关键函数不能用。

**3.** | 、<、>、! 等被干掉。（**对于 Oracle 注入来讲，| 竖杠被过滤掉，受限是非常大的**）

**4.** select、from 等 SQL 注入出数据的关键字被干掉。

看到这里感觉挺难的，但是比较幸运的是，这个 specIds 参数的单引号、（）左右括号、* 没有过滤。尤其是单引号没被过滤，这个非常关键，为这个注入漏洞能够跑出数据留下了一线生机！

*   **查看 Oracle 数据库手册**
    

select、from 这两个关键字被过滤了，想要出数据很难的。于是我从网上各种搜索，把 Oracle 数据库的关于数据查询的各种函数都找出来了，测试了一遍，几乎全被拦截掉了。但是幸运的是有一个 instr 函数成功绕过了所有防护，没被拦截。

接下来看看 Oracle 数据库手册上对 INSTR 函数的用法怎么描述的（这些翻译过来的中文使用说明看起来非常难以理解，我看了大半天才看明白）：

语法: INSTR（string1, string2[a,b]）

功能: 得到在 string1 中包含 string2 的位置。string1 是从左边开始检查的，开始的位置为 a，如果 a 是一个负数，那么 string1 是从右边开始进行扫描的。第 b 次出现的位置将被返回。a 和 b 都缺省设置为 1，这将会返回在 string1 中第一次出现 string2 的位置。如果 string2 在 a 和 b 的规定下没有找到，那么返回 0。位置的计算是相对于 string1 的开始位置的，不管 a 和 b 的取值是多少。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ASbRYJ5vpZqH2kepmbWicTSpq7Urvhpc4gZRic6L3JRiaGADrSicJX99mloMmgJicwuMNkibHVxnpfpMsw/640?wx_fmt=png)

根据手册构造出了以下 SQL 注入语句：**specIds=816Q@Q871*(instr(sql 插入点,'%s',%s)-(%s-1))**

“sql 插入点” 需要替换成我们想要查询的 sql 语句，这里需要找一个不包含 select、from 的语句写法，最终经过测试，发现以下语句可行：

utl_inaddr.get_host_address()，组合起来就是：

specIds=8866@871*(instr(utl_inaddr.get_host_address(),'%s',%s)-(%s-1)) &channelId=128

*   **python 脚本编写**
    

以下是我写的 python 脚本的一个片段，我把域名、url 地址都给打码了，大家可以照着改出一版自己的小脚本：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ASbRYJ5vpZqH2kepmbWicTS1EgUnwVCib2JYRkCCxNDgVmFqH5bDyqibtntLxF3xBcmsWweB35XVYpA/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ASbRYJ5vpZqH2kepmbWicTSpf1adOsOMUrCuCqrYtYxvxqD2mt6lQdgPNZ7psG2lKJkRsB8nBpCIQ/640?wx_fmt=png)  

 **Part3 总结** 

**1.** Oracle 注入、Mysql 注入等等遇到过不了的 WAF，多去查查相关数据库的各种特殊函数，非常有用。

**2.** SQL 注入漏洞的防护最好使用预编译，对于不能使用预编译的情况，记得过滤的关键字一定要全面。

**3.** SQL 注入漏洞深挖，总会有的。业务复杂度越来越高，各种研发人员更替，研发人员水平参差不齐，业务着急上线疏忽了安全问题整改等原因造成了这一现象。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

专注于红队、蓝队技术分享

每周一篇，敬请关注

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rhn137KeqqlDkuRyY4G61jATRzyOrCBts8ucxkLpMNsYutSOY7BkPziaw/640?wx_fmt=jpeg)