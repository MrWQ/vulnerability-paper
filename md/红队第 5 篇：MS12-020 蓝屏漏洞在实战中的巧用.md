> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/Zs1jErELad56HLpqm8HR5w)

 **Part1 前言** 

大家好，上期分享了一篇 Shiro Oracle Padding 反序列化漏洞无 key 的实战文章，这期讲一个 MS12-020 蓝屏漏洞的真实利用过程。这个案例源于 2013 年我在读研期间，印象是比较深的。在学校期间，我偶尔会帮网络部那边处理一些网站故障，还帮忙修补过安全漏洞。在那个年代，大学网站的漏洞是非常多的，基本上没有什么 WAF 设备防护。期间有一个大学网站大概是长时间没有人用，崩溃了，访问一直是卡死状态，服务器密码学校那边也不记得了。于是我就来了一顿操作，帮忙恢复了一下，中间也踩了不少坑。首先肯定是要想办法拿到服务器权限，然后帮学校把密码读出来，下面凭着记忆，把过程写出来。

 **Part2 研究过程** 

*   **Web 应用层面**
    

首先对这个特殊任务进行分析，首先是 Web 应用层面上，可以找各种 Web 漏洞拿权限，比如 SQL 注入漏洞、上传漏洞、列目录漏洞、XSS 盲打后台、找 CMS 公开或未公开的漏洞、框架漏洞等。但是本次案例中 Web 应用崩溃了，访问不了，所以这个思路不适用。

*   **中间件层面**
    

Web 应用没法搞，接下来重点看中间件上有没有可突破的点。从搜索引擎网页快照上看，大致判断中间件是 IIS6.0。对于 IIS 中间件，可利用的漏洞有 IIS PUT 文件上传、IIS5.0 远程代码执行、HTTP.sys 远程代码执行漏洞（MS15-034）、IIS6.0 远程溢出漏洞（CVE-2017-7269）等。在 2013 年，那时候 IIS6.0 中间件还没有爆出远程溢出漏洞（CVE-2017-7269），MS15-034 这个漏洞没有能拿权限的 exp，IIS 中间件也没有开启 PUT 上传功能，所以是没办法直接 PUT 上传写 shell。中间件这条路基本上也走不通。

（ 下面放一个老工具的图，怀旧一下，zwell 和桂林老兵写的，在 10 几年前检测 IIS 漏洞很好用，zwell 就是现在 goby 和 fafo 搜索引擎的作者）

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450B2wms7robnZGRUxBnrvnHI2nbuNRibdLj9wIsdM5pg9YxicNongKux7QllrBbHlhbazQsxtibd3H8Qg/640?wx_fmt=png)

*   **服务器 IP 层面**
    

中间件 IIS 也没有漏洞可利用，那么只能把精力放在服务器层面上了。接下来 nmap 全端口扫一下服务器 IP，看看开放了哪些端口。结果开放了 135、139、445、80、3389 端口（我处于学校内网中，所以 445 端口是开着的），操作系统识别为 Win2003。

接下来分析一下这几个端口的服务有哪些可利用的漏洞：

135 端口：可爆破 Administrator 的密码，135 端口早年爆出过远程代码执行漏洞，但是貌似是 02 年还是 03 年左右的漏洞了，太老了，没法利用。我记得那时候很多人流行用 135 漏洞批量扫 IP。

139 端口、445 端口：这两个端口都可爆破 Administrator 的密码，**这里有些读者可能会想到 MS08-067，但是没那么简单，因为当时的各种 exp 我都试过了，打不成功 Win2003 中文版系统。**

（ 放一个老工具的图，那个年代爆破密码这个工具特别好用，现在这个工具不行了）。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450B2wms7robnZGRUxBnrvnHIBHLezZx9mt2O2hyHbh5bz08ROtcrDw1X9Y3UFbmdEZlzPxEyYYLQ3A/640?wx_fmt=png)

我试了 BackTrack（BackTrack 是 Kali Linux 的前身，那时候名字是 BT4 还是 BT5 的，记不清了）里的 Metasploit 打 Win2003 的中文系统，根本打不成功。我用 Metasploit 打 Windows2003 中文系统就从来没成功过，打 Windows XP 系统可以打成功。后期看雪论坛有人放出了 MS08-067 的适用于中文系统 exp，还有很详细的分析文章，但那是好多年后的事情了，那个 exp 我后来也测试过，能打成功，但是也不太稳定。当时还没有 NSA 的方程式工具包泄露，否则很轻易就用 MS17-010 打下来了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450B2wms7robnZGRUxBnrvnHIcVaZMs4qMa18efpSUMVJjWdAPDJgOia2CcYI7nKIEIAc01c1MqZuyVQ/640?wx_fmt=png)

后来我又下载了国内大牛改的 MS08-067 的 exp，对于 Win2003 系统同样也打不成功。

（ 放个那时候工具的图，14 年前的老工具了，现在可以用方程式工具包替代 ）

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450B2wms7robnZGRUxBnrvnHITicxeoB5Nh1QsM5M6TdCzx8IBP3VMiaTNib1EehmgTJtS6BGM3N5Au4ibA/640?wx_fmt=png)

接下来对 445 端口爆破账号密码，445 端口爆破密码要比 135、139、3389 速度快很多，在内网环境中，有时候一秒就可以破几百次，挂了一个超大字典，结果没跑出密码。

组后只剩下 3389 端口了，3389 服务可以爆破密码，但是速度是比 445 要慢太多了。况且刚才 445 的 SMB 服务，也没爆出密码，所以 3389 爆破密码是多余的。

*    **MS12-020 蓝屏漏洞**
    

这样貌似就没办法了，等到晚上去食堂吃饭，在回来的路上灵光一闪，来思路了！3389 的 RDP 服务不是曾经爆出一个漏洞 MS12-020 吗？那么干脆用这个漏洞把服务器打蓝屏，重启一下服务器，网站不就恢复正常了吗？

但是为了谨慎起见，我想到了以下几个情况：

1、MS12-020 蓝屏后，Win2003 会不会重启？可别一直卡在那里就不动了。

2、重启后 IIS 服务器是不是能自启动，别重启后，IIS6.0 服务起不来了。

为了确保万无一失，还是搭建虚拟机环境测试一下吧，我本地搭建了一个虚拟机环境，使用 Metasploit 的 MS12-020 漏洞攻击后，蓝屏后几十秒，服务器就重启了，IIS6.0 默认是自启动的，也可以顺利起来。没有问题，蓝屏这个思路可以在实战中应用。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450B2wms7robnZGRUxBnrvnHIzLtbMZmDiakvBYprmfduNKZsmJDlo5fQfQozQ9rcdOXAouE0ibU2y14g/640?wx_fmt=png)

于是开始实战了，结果意外出现了，不知道为什么，Metasploit 的 MS12-020 的 exp 怎么打都不蓝屏，打了 7、8 遍没打蓝屏。

接下来怎么办，我在想，学校的这种系统很少有打补丁的情况，在当时，大学网站是不太关心网络安全问题的。想来想去换个 exp 再试试吧，于是我从网上下载了另一个利用程序，用 nc 发一个包过去（当时 nc 很流行，测试上传漏洞都是用 nc 来测试的），结果服务器立马就蓝屏了。蓝屏后，服务器自动重启，部署在 IIS 上的网站也恢复正常了。

（ 放一个其它工具的图吧，我清楚地记得当时是用 nc 载入一个 poc 文本文件发包利用成功的，但是工具找不到了，没法贴图了 ）

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450B2wms7robnZGRUxBnrvnHIvK2FxahfBANN30uMb5AoKB3oNJrb2icF5a49RTfF0FxibDg9q84aQhTw/640?wx_fmt=png)

蓝屏后是这个样子，过几十秒系统会自动重启，一切自启动的服务恢复正常。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450B2wms7robnZGRUxBnrvnHIYe7m49JnoJ8XjUUw0icyOQLUPkheqz35ibskeDO3FOcgx29xBd4hhibTw/640?wx_fmt=png)

网站恢复正常后，后续通过 Web 应用的后台上传漏洞打进去恢复密码的，都是常规思路，这里就不多讲了。

 **Part3 总结** 

**1.** 虚拟机环境与实战环境是不一样的，一个漏洞准备多个 EXP 看来很有必要。

**2.** 蓝屏漏洞有时候也可以派上用场，具体情况具体分析。**在日常红队项目中，大家尽量提前跟客户报备一下，因为现在一个服务器上放的业务很多，蓝屏重启可能造成不可挽回的损失，这里只是提供一个思路**。

**3.** Tomcat 等中间件在 Windows 下尽量别用这个方法了，因为很多都是批处理脚本启动的，重启后，就起不来了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

专注于红队、蓝队技术分享

每周一篇，敬请关注

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rhn137KeqqlDkuRyY4G61jATRzyOrCBts8ucxkLpMNsYutSOY7BkPziaw/640?wx_fmt=jpeg)