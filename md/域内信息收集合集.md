> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/rvw63W8FS0WX6czwnHL46Q)

    最近发现总是在学习，但是总是在需要它的时候时候想不来学过的东西。所以准备把学过的内容好好梳理一下，整合成一个系列的笔记。慢，才是快。

  **码字不易！****走过路过点个 "** _**在看**_ **"，不会错过**![](https://mmbiz.qpic.cn/mmbiz_png/m41BLSafyI6XITCu3uf91qb2YMMHV28IHkGmNiaicqtS9o8MicmFmRNgkbibqcQwXt9XtIKvibMlyj2egmbfia5o3Pzg/640?wx_fmt=png)

场景
--

    拿下一台跳板机后，需要对域内操作下一步操作。网上的文章大都是大而全的内容，没有针对性，看了没多久就忘记了，今天介绍实际在域内信息收集会使用的到方法。

定位当前用户角色
--------

    因为很多通过 cmd 命令查询域内信息的本质都是通过 LDAP 协议到域控上查询的，所以在查询时需要进行权限验证，**只有域用户和计算机自带的 system 用户，故需要知道当前的用户角色。（不是管理员用户，system 用户是机器上权限最高的用户，其用户名为机器名 +$, 对应在域内就是机器用户，所以 Systen 用户可运行查询域内信息的 cmd 命令）**  
这太简单了

```
whoami

```

如何发现域：
------

### 01 cmd 命令发现

  
1、cmd 发现域的方法有很多，比较易用且准确的是 net config workstation

```
net config workstation    //这条命令是查询本地计算机的配置，所以本地用户也可以查询

```

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf92NP1w7jibR9icpeG3jWnG32jdUf3oLIZSeyu4lMdB9GyficIAZJYSWKsA/640?wx_fmt=png)  

2、systeminfo

```
systeminfo | findstr /B /C  "域”   //中文
systeminfo | findstr /B /C "Domain”   //英文

```

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9gtLbvZYgVAplf7YnG9KEr83WlYv4CjBQXoSsCmiahnDf9ocpJtS9M3g/640?wx_fmt=png)

3、ipconfig

```
ipconfig   /all   //网卡信息

```

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9Apf5ibjX6O9RnNyym5dHNqKcIF1Nn0MnpJ7krAf5R6ncfjpR0FEuEpw/640?wx_fmt=png)

对域控的定位
------

### 01 cmd 命令定位  

我们定位域控的首要需求是知道域控的 IP，但是有时候可能不太容易得到域控 IP  
**直接获得域控 IP + 域控计算机名**

```
nltest /dsgetdc:域名        //查询域控相关信息，直接获取到IP+计算机名，无用户权限要求

```

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9laMO09bB7WLic3uSKvkHvfpRo4LMXR8WQYLYbbVVia2MeatU3YjOT5MQ/640?wx_fmt=png)

  
**以下只获得域控计算机名（再通过 ping 获得 IP）**

```
net group "Domain controllers" /Domain     //查看域控制器组，需要域内用户/机器用户

```

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9M0ymLJk5FqDBvibNlUgv3GmQjx7FIw9WYY6iaHB4mhk3R3Q0ftic5l8ew/640?wx_fmt=png)

```
net time /domain    //查询域内的当前时间,只有在域内用户/机器用户才可以查

```

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9nicqU2XJktDtQLQJX7tJzTzL140AQDeIN9J4wXQnuMahydicjLTUriauA/640?wx_fmt=png)

```
nltest /DCLIST:域名  //查看域内域控制器的计算机名，不是域内用户经测试也可查询到，只不过会报错

```

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9I24YPqTU0Zya39TVicgCOzZicFC9auOHpw2Vo6UrI6LBMHZEkOIibJM9Q/640?wx_fmt=png)

### 02 dns 解析记录查询定位域控

**原理**：域控服务器会向 DNS 服务器注册 DNS 记录，以便当客户端需要加入域或者和域有其他交互的时候，可以找到它。  
然而大多情况下，内部 DNS 服务器和 AD 域控服务器默认部署在同一台服务器。如果是这种情况，找到 DNS 服务器就能找到了域控服务器。  
若当前主机的 dns 为域内 dns，可通过查询 dns 解析记录定位域控。

```
nslookup -type=all  _ldap._tcp     //均可查

```

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9tRUcQN2mlomH2eGia8AN655MaqKgVbulEnPIuVTYTR78McHjK7EU44A/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9YFhHu5nqbBibTP3Kd4zic8Oc0y9aia0S7OQ7bTxdMXvyCZBon5NiaJemPQ/640?wx_fmt=png)

###   
03 通过端口探测方式定位域控

域控制器兼顾整个域的认证服务，所以会开启很多认证端口。  
如果你对一台机器进行了端口扫描，有一下端口开放情况的一定是个域控制器，这也是一种不在域内来定位域控的好方式。

```
nmap -sV -Pn 192.168.110.141 -p-

```

扫描出的 53 端口，为 DNS 服务端口，主要用于域名解析，通过 DNS 服务器可以实现域名与 ip 地址之间转换，一般在域控上，但也不一定，要看域控和 DNS 是不是在同服务器，不过一般都是。  
389 默认是 LDAP 协议端口  
636 端口与 88 端口他们都是域控机器开放的端口。  

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9U88Jut04nJLeDqibqiaC16WiaccFgpOAkhVDMgTO1yKRSbdmvbHHd3OicA/640?wx_fmt=png)

### ![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9agZBCJS4hdh55aaQJrpaMHKibiaro0dJhxRSDklCK8Kf2p0C7k9IhBmA/640?wx_fmt=png)  
  
04 SPN 扫描定位

由于 SPN 本身就是正常的 kerberos 请求，所以扫描隐蔽，它不同于 TCP 与 UDP 常规端口扫描。大部分 windows 已经自带 setspn.exe，且此操作无需管理权限。  
在域内机器执行：

```
setspn -T transfer.com -Q */*     //需要是域内用户或者机器用户

```

在扫描出的结果进行域控的定位。此时已经查询出域控机器。  

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9dd66UFlfNRibux0SauCmWCmaSicu8b7VgMKvgKMgsdiaZib6LIg6tT2uQw/640?wx_fmt=png)

### 05 nbtscan.exe

此外，还可以利用 nbtscan 来定位域控，他与端口探测都是机器不在域内定位的好方式, 它使用 netbios 协议扫描本地或远程 TCP/IP 网络上的开放 NetBIOS 名称服务器。

```
nbtscan 192.168.110.0/24    //windows下也有该工具

```

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9tL3s0icjE0CMHbuOUUoBwOR2lCMvUH7G7rhBQhNxC3JdNQ9R5XNNFKw/640?wx_fmt=png)S

  
这种方法在实际环境可能不太准确 (实际意义不太大)

对域管的定位
------

定位域管的常规方法可以归纳为是那种，第一种是 **cmd 直接查**、第二是**根据日志**，第三是**根据会话**。  
**日志**是指本地计算机的管理日志，可以使用脚本或 Wevtutil 工具导出并查看，**会话**是指域内每台机器的登录会话，可以使用 netsess.exe 或者 powerview 工具查询.(可以匿名查询，不需要权限)

### 01 cmd 命令定位

```
net group "Domain Admins" /domain       //查询域管理员，域内用户或机器用户才可查

```

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf95LZibygicIcSSXqpFkDst0a6qjKTZSb8BgtKkNtsBwQxHxT9TtYRohibA/640?wx_fmt=png)鱼贯. png

  
印证一下上面的的说法，本地用户 transfer 查询不到域控管理员列表，使用 psexec 返回 system 权限即可以查询到。  

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf90X8McQJc9SyyR4aewZtaswicdC8ksNtKdMHichpVDpKmw3UyrqXFgScA/640?wx_fmt=png)

### 02 利用 powerview 过滤出域管  

    powerview 集成在 powersploit 工具包中，是一个收集域信息很好用的脚本。但是这种相对 cmd 直接查较麻烦。没测试，没用过。

### （powersploit 会报毒，直接加载到内存应该可以过某 60 + 某绒，但是 df 不太好过，没什么 D 用）

```
注意：通常情况下需要过滤，因为真实的域环境中会有大量结果。
// 更多PowerView命令参数
Get-NetDomain: 获取当前用户所在域的名称
Get-NetUser: 获取所有用户的详细信息
Get-NetDomainController: 获取所有域控制器的信息
Get-NetComputer: 获取域内所有机器的详细信息
Get-NetOU: 获取域中的OU信息
Get-NetGroup: 获取所有域内组和组成员信息
Get-NetFileServer: 根据SPN获取当前域使用的文件服务器信息
Get-NetShare: 获取当前域内所有网络共享信息
Get-NetSession: 获取指定服务器的会话
Get-NetRDPSession: 获取指定服务器的远程连接
Get-NetProcess: 获取远程主机的进程
Get-UserEvent: 获取指定用户的日志
Get-ADObiect: 获取活动目录的对象
Get-NetGPO: 获取域内所有的组策略对象
Get-DomainPolicy: 获取域默认策略或域控制器策略
Invoke-UserHunter: 获取域用户登录的计算机信息及该用户是否有本地管理员权限
Invoke-ProcessHunter: 通过查询域内所有的机器进程找到特定用户
Invoke-UserEvenHunter: 根据用户日志查询某域用户登录过哪些域机器。

```

```
powershell.exe -exec bypass -Command "& {Import-Module C:\Users\win7\Desktop\tool\PowerView.ps1; Invoke-UserEvenHunter}"

```

还可以导入后过滤出域管:

```
Get-DomainUser|?{$_.memberof -like "*Domain Admins*"}

```

下面是几个古老的工具

### 03 PSloggedon.exe  

    在 Windows 上使用 net session 可以查看谁使用了本机资源，但不能查看谁在使用远程计算机资源、谁登录了本地或远程计算机，使用 psloggedon 可以查看本地登录的用户和通过本地计算机或远程计算机进行资源登录的用户。微软官方的东西，你懂的  
下载地址：

```
https://docs.microsoft.com/en-us/sysinternals/downloads/psloggedon

```

该工具通过检验注册表里 HKEY_USERS 的 key 值来查询谁登陆过机器，并且调用了 NetSessionEnum API。  

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf92RiafULLN37dOu3jw89PSJlnicoZQONia6hRqyRPIdaN0D25ypMAVsiarA/640?wx_fmt=png)Snipaste_2021-10-20_23-37-43.png

```
psloggedon.exe [-] [-l] [-x] [\\computername|username]
-                                显示支持的选项和用于输出值的单位。
-l                            仅显示本地登录，不显示本地和网络资源登录。
-x                            不显示登录时间。
\\computername    指定要列出登录信息的计算机的名称。
Username                指定用户名，在网络中搜索该用户登录的计算机。

```

PS：该工具有些功能需要管理员权限。  
PsLoggedon.exe Administrator  (指定用户)  

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9QjNUHN3ODXM9090a6TAtkVmf2ejZOO9mWJcUloicPIItDUej9OKhnNw/640?wx_fmt=png)

    如图，枚举出了 Administrator 用户在那些机器登陆过  
PsLoggedon.exe \dc (指定机器名)  

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9sGsPwRgugasZiaGwD0ibs1YGibUicFBBERSj14p1ia4gTSqDN8HXMZ7Nlew/640?wx_fmt=png)

如图，枚举出了正在 dc 这台机器上登录的用户。

### 04 PVefindaduser.exe

    它是用于查找 Active Directory 用户的登录位置、枚举域用户，以及查找在 特定计算机上登陆的用户，包括本地用户、通过 RDP 登陆的用户、用于运行服务和计划任务的用户。  
下载地址：

```
https://github.com/chrisdee/Tools/tree/master/AD/ADFindUsersLoggedOn

```

直接运行 pvefinaduser.exe -current 命令，即可显示域中所有计算机上当前登陆的所有用户

### 05 netview

    netview 是一个枚举工具，使用 WinAPI 枚举系统，利用 NetSessionEnum 寻找登录会话，利用 NetShareEnum 寻找共享，利用 NetWkstaUserEnum 枚举登录的用户，netview 可以查询共享入口和有价值的用户，其绝大部分功能无需管理员权限就可使用。**(360 报毒、火绒不报)**  
Netview 下载地址：

```
https://github.com/mubix/netview

```

```
-h               显示帮助信息
-f filename.txt  指定要提取主机列表的文件
-e filename.txt  指定要排除的主机名的文件
-o filename.txt  将所有输出重定向到指定的文件
-d domain        指定要提取主机列表的域。如果没有指定，则从当前域中提取主机列表
-g group         指定搜索的组名。如果没有指定，则在Domain Admins组中搜索
-c               对已找到的共享目录/文件的访问权限进行检查
-i interval      枚举主机之间等待的秒数
-j jitter        应用于间隔的抖动百分比（0.0-1.0）netview.exe -d

```

```
netview.exe -d

```

### 06 BloodHound  

    这个著名的域信息收集工具，不止用来查域管域控，主要面向复杂环境，他对整个域的拓扑都能以图形化的方式呈现。**(我比较低级，没用过，使用方式自行百度)**

### 07 Nmap 的 NSE 脚本

如果你有域账户或者本地账户，你可以使用 Nmap 的 smb-enum-sessions.nse 引擎来获取远程机器的登录 session，并且不需要管理员权限  
**smb-enum-domains.nse:** 对域控制器进行信息收集，可以获取主机信息、用户、可使用密码策略的用户等  
**smb-enum-users.nse:** 在进行域渗透时，如获取了域内某台主机权限，但权限有限，无法获取更多的域用户信息，可借助此脚本对域控制器进行扫描  
**smb-enum-shares.nse:** 遍历远程主机的共享目录  
**smb-enum-processes.nse:** 对主机的系统进程进行遍历，通过此信息，可知道目标主机运行着哪些软件  
**smb-enum-sessions.nse:** 获取域内主机的用户登陆会话，查看当前是否有用户登陆，且不需要管理员权限  
**smb-os-discovery.nse:** 收集目标主机的操作系统、计算机名、域名、域林名称、NetBIOS 机器名、NetBIOS 域名、工作组、系统时间等信息  

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9HrobfsNPRnpBncibAn5OjFfSvS2icavibv22zzcLARFLLkFtJ0U3732aw/640?wx_fmt=png)

域管进程的信息收集
---------

### 01 cmd 命令定位

先查域管用户组，再查当前主机以域管运行的进程即可

```
net group "Domain Admins" /domain

```

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9FwkcWPiaPHN9fYwIiaicfRlUguYUJ5dnAc7rPW76OMHLficZUf7GLBVWTw/640?wx_fmt=png)

```
tasklist  /v    //查看当前进程不限cmd   vmic 啥的有好多

```

域内其他信息收集
--------

### 01 查询域内所有计算机

```
net view /domain:域名

```

### 02 查询域内所有用户组列表

```
net group /domain    //同时也可以查到域控的计算机名

```

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9JZRib9uPKQFibW4x22OnHBes3LicTaxcfKfYdJpO9tQByMGRq8eAfQU0A/640?wx_fmt=png)  

### 03 查询所有域用户

```
net  user /domain   //查询域内所有域用户

```

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9yEqhkn8wyZt42N8e31slJHxbKjVQVTLYaRicWXQg8PFlh1Uvx6dkzEQ/640?wx_fmt=png)

### 04 获取域内所有用户的详细信息

以下命令从查询域内所有的域用户的详细信息，包含：用户名、描述信息、SID、域名、状态

```
wmic  useraccount get /all

```

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9cuuAgEG3Xg508ygO1Y5QCB6u00pibdlg0fcjQZicRTHwWES6kD6wRHlQ/640?wx_fmt=png)

### 05 查询所有域成员计算机列表

```
net group "domain computers"  /domain

```

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9xBlrev3Jb5vUISK808YLPu2Uo8e6Hdf1oWmSM5ia2dtGoFichcGTzjvg/640?wx_fmt=png)

### 06 获取域密码信息

执行以下命令获取域密码策略、密码长度、密码错误锁定等信息

```
net  accounts /domain

```

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf97TR2EJKp9lNIEyZR1czvSC0p9EulXjHcNx8To1ia0riaiau24FMaxofmA/640?wx_fmt=png)

### 07 获取域信任信息

```
nltest /domain_trusts

```

![](https://mmbiz.qpic.cn/mmbiz_png/FfykXWS1adUfJib2ROtYxicFaJIdoR5Xf9DLnOZzKGWG91pc4iaA6Ea8Z75l0b0IVvOAa4G1Q5cmjIE3XWCficRFeg/640?wx_fmt=png)  

### 08 一些只有域管权限能执行的命令

```
添加域内用户并加入管理员组：
net user 用户名 密码 /add /domain
net group "domain admins" 用户名 /add /domain
删除
net group "domain admins" 用户名 /del /domai
net view /domain:domain_name 查看某个域内主机
net time hostname 主机名
dsquery computer #查看域内主机列表
dsquery user     //域内用户









```