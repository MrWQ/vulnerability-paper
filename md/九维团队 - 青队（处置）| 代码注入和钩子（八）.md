> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247503290&idx=1&sn=4e33105f1d7118f950a90ab90e7597d0&chksm=9ae18c82ad960594c90cd0efa744ddb34f83329193ae9e7058a009989f89121d9d83438bb412&scene=178&cur_album_id=2617884898938290179#rd)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOQ4y3CslMX5EINOxRsoicGxHxJnwtXjIau4usI94yHUKXTqh4LyuVL4A/640?wx_fmt=gif)

**写在前边**

  

1. 本文原文为 K A, Monnappa. 2018 年发表的《Learning Malware Analysis》，本文的相关内容均为笔者对相关内容的翻译及实践记录，仅供各位学术交流使用。另出于易读性考虑，对部分字句有所删改。 

2. 如各位需要引用，请做原文引用，格式如下所示： 

[序号]K A, Monnappa. LearningMalware Analysis[M]. 2018.06. Published by Packt Publishing Ltd. Livery Place 35 Livery Street Birmingham B3 2PB, UK. 

3. 因文章整体内容较长，完整内容将会在本公众号拆分为多篇内容分别发出。本文为该系列的第八篇。

[往期内容请参见合集《Learning Malware Analysis》](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAwMDgyNTQzMQ==&action=getalbum&album_id=2617884898938290179&scene=173&from_msgid=2247502411&from_itemidx=1&count=3&nolastread=1#wechat_redirect)

**4.3**

**使用 Shim 进行内存修补**

在内联挂接中，我们看到了函数中的一系列字节是如何被修补以将控制权重定向到恶意代码的。使用应用程序兼容性垫片可以进行内存内修补（具体细节已在之前的推文中介绍过）。

微软使用内存打补丁的功能以应用补丁来修复其产品中的漏洞。内存打补丁是一个没有记录的功能，在兼容性管理员工具中也没有，但是安全研究人员通过逆向工程已经弄清楚了内存打补丁的功能，并且开发了分析它们的工具。

*Jon Erickson 的 sdb-explorer 和 William Ballenthin 的 python-sdb 允许你通过分析 shim 数据库（.sdb）文件。

```
项目网址：
sdb-explorer：
https://github.com/evil-e/sdb-explorer

python-sdb：
https://github.com/williballenthin/python-sdb
```

* 左右滑动查看更多

以下几位研究人员的演讲中包含了关于内存补丁的详细信息，以及分析这些补丁的工具。

```
持续使用和滥用微软的补丁: 
https://www.blackhat.com/docs/asia-14/materials/Erickson/WP-Asia-14-Erickson-Persist-It-Using-And-Abusing-Microsofts-Fix-It-Patches.pdf

真正的垫片黑幕: 
http://files.brucon.org/2015/Tomczak_and_Ballenthin_Shims_for_the_Win.pdf
```

* 左右滑动查看更多

恶意软件作者使用内存补丁来注入代码和钩住 API 功能。使用内存打补丁的恶意软件样本之一是 GootKit；这个恶意软件使用 sdbinst 工具安装各种垫片数据库（文件）。下面的截图显示了为多个应用程序安装的垫片，该截图显示了与 explorer.exe 相关的. sdb 文件。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLGN0fTvQnzzmCZQNIsMic6Veg5W49dY8WttQRo89IrxDoZH1n06YIvOJw7kYmByqm637oDD4Uqoog/640?wx_fmt=png)

安装的. sdb 文件包含将被直接修补到目标进程内存中的 shellcode。我们可以使用 sdb_dump_database.py 脚本（python-sdb 工具的一部分）来检查. sdb 文件，命令如下。

```
$ python sdb_dump_database.py {4c895e03-f7a5-4780-b65b-549b3fef0540}.sdb
```

* 左右滑动查看更多

前面命令的输出显示恶意软件以 explorer.exe 为目标，并应用名为 patchdata0 的垫片。垫片名称下面的 PATCH_BITS 是一个原始的二进制数据，包含将被打入 explorer.exe 内存的 shellcode。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLGN0fTvQnzzmCZQNIsMic6VckPZoPh6kCHvaFmib5rJ7iblj63ibYwZVOicXQLKNZE5T7gxClZZ533cgA/640?wx_fmt=png)

为了知道 shellcode 在做什么，我们需要能够解析 PATCH_BITS，它是一个无文档的结构。为了解析这个结构，我们可以使用 sdb_dump_patch.py 脚本（python-sdb 的一部分），给出补丁名称，patchdata0，如上图所示。

```
$ python sdb_dump_patch.py {4c895e03-f7a5-4780-b65b-549b3fef0540\}.sdb patchdata0
```

* 左右滑动查看更多

运行前面的命令显示在 explorer.exe 内的 kernel32.dll 中应用的各种补丁。下面的截图显示了第一个补丁，它在相对虚拟地址（RVA）0x0004f0f2 处匹配了两个字节，8B FF（mov edi,edi），并用 EB F9（jmp 0x0004f0ed）替换它们。换句话说，它将控制权重定向到 RVA 0x0004f0ed。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLGN0fTvQnzzmCZQNIsMic6V4k8K6tAsTwVLwHvVotGicHR0Dpjmib4xZDeONpex3nafF2VkHnUNlDrg/640?wx_fmt=png)

下面的输出显示了在 kernel32.dll 的 RVA 0x0004f0ed 处应用的另一个补丁，恶意软件用调用 0x000c61a4 替换了一系列 NOP 指令，从而将程序控制重定向到 RVA 0x000c61a4 处的功能。这样，恶意软件修补了 kernel32.dll 中的多个位置，并进行了各种重定向，最终将其引向实际的 shellcode。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLGN0fTvQnzzmCZQNIsMic6VkJqTqTAYab7ITADYm0M4aab2p6icqboCjBefr9qWzR2tkib8726QyKibA/640?wx_fmt=png)

为了了解恶意软件在 kernel32.dll 中打了什么补丁，我们可以将调试器连接到打了补丁的 explorer.exe 进程，并在 kernel32.dll 中找到这些补丁。例如为了检查 RVA 0x0004f0f2 的第一个补丁，我们需要确定 kernel32.dll 被加载的基址。

在文中这个例子中，它被加载在 0x76730000，然后加上 RVA 0x0004f0f2（换句话说，0x76730000 + 0x0004f0f2 = 0x7677f0f2）。下面的截图显示，这个地址 0x7677f0f2 与 API 函数 LoadLibraryW（）相关。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLGN0fTvQnzzmCZQNIsMic6VkwHmMIr3KAGib2Y7NuNLibDbm13EqnfN4uVU579a9BLwfdaic2bohBfJg/640?wx_fmt=png)

检查 LoadLibraryW() 函数可以看到该函数开始时的跳转指令，该指令最终将把程序控制权转给 shellcode。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zLGN0fTvQnzzmCZQNIsMic6Vs1xl6shPAbNwh0WjKPeDVMZC07cmv1j0K1JIT9LzkuJQyqR0NHucPA/640?wx_fmt=png)

这种技术很有趣，因为在这种情况下，恶意软件没有直接分配内存或注入代码，而是依靠微软的 shim 功能来注入 shellcode 和钩住 LoadLibraryW()API。它还通过跳转到 kernel32.dll 中的不同位置来使检测变得困难。

  

  

**五**

**其他资源**

  

  

除了本章介绍的代码注入技术外，安全研究人员还发现了其他各种注入代码的手段。以下是一些新的代码注入技术，以及拓展阅读的资源途径。

• ATOMBOMBING: BRAND NEW CODE INJECTION FOR WINDOWS: 

```
https:// blog.ensilo.com/atombombing-brand-new-code-injection-for-windows
```

* 左右滑动查看更多

•PROPagate: 

```
http://www.hexacorn.com/blog/2017/10/26/propagate-a-new- code-injection-trick/
```

* 左右滑动查看更多

•Process Doppelgänging, by Tal Liberman and Eugene Kogan:

```
https://www.blackhat.com/docs/eu-17/materials/eu-17-Liberman-Lost-In-Transaction-Process- Doppelganging.pdf
```

* 左右滑动查看更多

•Gargoyle:

```
https://jlospinoso.github.io/security/assembly/c/cpp/ developing/software/2017/03/04/gargoyle-memory-analysis-evasion.html
```

* 左右滑动查看更多

•GHOSTHOOK:

```
https://www.cyberark.com/threat-research-blog/ghosthook- bypassing-patchguard-processor-trace-based-hooking/
```

* 左右滑动查看更多

在本章中，我们主要关注的是用户空间的代码注入技术；在内核空间也可以实现类似的功能（我们将在后续的文章中向大家介绍内核空间的钩子技术）。以下书籍应该能帮助各位更深入地了解 rootkit 技术和 Windows 内部概念。

•The Rootkit Arsenal: Escape and Evasion in the Dark Corners of the System (2nd Edition), by Bill Blunden

•Practical Reverse Engineering: x86, x64, ARM, Windows Kernel, Reversing Tools, and Obfuscation, by Bruce Dang, Alexandre Gazet, and Elias Bachaalany

•Windows Internals (7th Edition), by Pavel Yosifovich, Alex Ionescu, Mark E. Russinovich, and David A. Solomon

  

  

**六**

**总结**

  

  

在本系列的文章中，我们研究了恶意程序用来在合法进程的上下文中注入和执行恶意代码的不同代码注入技术。这些技术允许攻击者执行恶意行为并绕过各种安全产品。除了执行恶意代码，攻击者还可以劫持合法进程调用的 API 函数（使用钩子），并将控制权重定向到恶意代码，以监视、阻止甚至过滤 API 的输出，从而改变程序的行为。

在后续的文章中，我们还将会更新更多内容中，例如将学习到攻击者为不被安全监控解决方案发现而使用的各种混淆技术，敬请期待。

（完）

* * *

**—  往期回顾  —**

[**![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL227ibOmpOzGD7zr7zB8uG0FSsoSmrNybqajdOARxTKWzckYaEGEhQl0jLb31nIGLSHdgnfly5sqw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)**](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502438&idx=2&sn=b71fbe730dc1b64749725f06178077b4&chksm=9ae18b5ead960248f0ebce96cd96f4259a4ade57c8e47b3d542e33fc428e10b4608f7e53bbd1&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zIic6aXxpvD4aibicNRyqUxBtY73nuOvte8CB9gM91licicYM8LP4wo54icOBa6xK1Tym1pKqqE2m1sibsicg/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247503272&idx=1&sn=f3cb0346e732dc10292f19b3f1af0e64&chksm=9ae18c90ad960586ba3603c847e8d449db5da34e3df21e33440656bf2de791057953d4465574&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zLGN0fTvQnzzmCZQNIsMic6V98mxlTffg4pdhaLria9tnHe2uHrvU2zcyOZjd7hb55ngM0xTV7xZOqA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247503186&idx=1&sn=457347b9d51d55025fb23cbc25aafcc5&chksm=9ae18c6aad96057c8fab77f60b5bb379dd5d0568779ad68fb2b84ebfa96298dfbba46ef18730&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zIdW56DaQCiaxWPiacSkHOB3bo49yKu47HAx3xZic4q47kBFj8L7Nkic8MFwhuWXnxnQzZxTxgVlfs6tA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247503136&idx=1&sn=74d0fe73843239bfce2037ad488d3f62&chksm=9ae18c18ad96050eecbd3ec3c596feb0d626b9ffcb4856814f80f6a46d9c03187dc4ae0d57ed&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKgESot71qPsaibQVndxZunibJyyxWT3jzjHHFHY0bbHKibSWQQD74kic1A1GWeEXHR6CIdRma7swau5g/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247503112&idx=1&sn=1f749451cd29f37cf4ab219182636725&chksm=9ae18c30ad9605264bf3f1d4ce17af1cea8594c6f33c835664e536b68edcb20ae75fdf9b394f&scene=21#wechat_redirect)

  

**关于安恒信息安全服务团队**

**安恒信息安全服务团队由九维安全能力专家构成，其职责分别为：红队持续突破、橙队擅于赋能、黄队致力建设、绿队跟踪改进、青队快速处置、蓝队实时防御，紫队不断优化、暗队专注情报和研究、白队运营管理，以体系化的安全人才及技术为客户赋能。**

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIFIDZlXFuQeZrcKrV7Zd8Aeg98Fw5jzbGBgUW1hVQXIV3YpLZncEYibgw7MFwWtDU5vwnE2QFVP7A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL31gt4m6YIRLh7wJeOSwYPOIblCvhN6OgHhV9NMJNH0TBianlpMmRbaKG1ia7iaPsWb4UX4ImgfEJ0A/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOCUgD3ep5Jp4DE8e2S2Y3WnxsKjicicOg3OsGGRc9NPibQ61aRAqNXZQDA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)