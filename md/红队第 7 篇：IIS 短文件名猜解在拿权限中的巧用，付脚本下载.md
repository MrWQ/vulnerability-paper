> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/N30pLGhwWJcNB90q9QOg1g)

 **Part1 前言** 

为了能在红队项目中发现更多的打点漏洞，我曾经花了不少精力，把那些大家觉得不重要的中低危漏洞拿来研究一下，发现有几个漏洞还是很有利用价值的，比如说，“IIS 短文件名猜解漏洞”。这个漏洞有以下这么几个特点：1、危害等级是中低风险。2、在当前网站应用中还广泛存在。3、微软官网不太认可这个漏洞，不出补丁。4、很多客户也选择不修复。5、漏洞利用起来极其困难，需要很大的耐心和毅力。但是我借助此漏洞间接拿权限成功了很多次，还是有很多技巧在里面的，下面分享一下详细过程。

 **Part2 研究过程** 

**IIS 短文件名猜解漏洞简介：**

首先简单介绍一下 IIS 短文件名猜解漏洞：Windows 系统为了兼容 16 位 MS-DOS 程序，为文件名较长的文件和文件夹生成了对应的 Windows 8.3 短文件名。比如文件名 direct~1.asp 中间有一个波浪号，这种就是短文件名了。

*   **查看短文件名的方法**
    

如下图所示，使用 windows 自带的命令即可。打开一个文件夹，使用 dir /x 命令，可以直接看到每个文件或者文件夹的短文件名，短文件名只保留前六位的文件名 + ~+ 1. 后缀名的前三位。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CKtdjfFibCZehNdLOpnsrVEj0FWlnQLbfNMYeLqnfPY47ERIRBI0wkWUqEbs8ucAKAA2fyhgShHsw/640?wx_fmt=png)

*   **短文件名命名规则**
    

Windows 短文件名的命名规则如下，实际上比以下描述要复杂一些，但是了解个大概即可，否则太费精力，不划算（**这段描述参考了 freebuf 的文章，文末附带了 freebuf 文章的原文链接地址**）：

**1.** 只有前六位字符直接显示，后续字符用~ 1 指代。其中数字 1 还可以递增，如果存在多个文件名类似的文件（名称前 6 位必须相同，且后缀名前 3 位必须相同）

**2.** 后缀名最长只有 3 位，多余的被截断，超过 3 位的长文件会生成短文件名

**3.** 所有小写字母都会转换成大写字母

**4.** 长文件名中含有多个.，以文件名最后一个. 作为短文件名后缀

**5.** 长文件名前缀 / 文件夹名字符长度符合 0-9 和 Aa-Zz 范围且需要大于等于 9 位才会生成短文件名，如果包含空格或者其他部分特殊字符，不论长度均会生成短文件。

*   **该漏洞的利用价值**  
    

此漏洞可以得到网站每个目录下文件的前 6 位字符，其利用价值体现在：

**1.** 猜解网站的后台地址。

**2.** 猜解敏感文件，例如网站备份的. rar、.zip、.bak、.sql 文件等。

**3.** 获取很多爬虫爬不到的未授权访问页面、获取 WebService 接口地址，从这些未授权访问页面中进而发现更多漏洞，如 SQL 注入漏洞、上传漏洞等。

**IIS 短文件名猜解的利用过程：**

假设 IIS 中间件网站目录下有 Databackup.zip 这样一个网站备份文件，使用 dir /x 查看，可以得到短文件名为 DATABA~1.zip。如果在红队项目过程中，得知网站下有一个 DATABA 为前缀的文件名，那么就可以很容易猜到完整的数据库文件名 database.zip 或者 databackup.zip，那么就可以直接下载数据库了，这对于红队项目是非常有帮助的。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CKtdjfFibCZehNdLOpnsrVEhQHgzcAPREEXgt4t54eTr8KzbQzSXVdNOGt0sPgZLTnFSVEQArHzxw/640?wx_fmt=png)

IIS 早期版本和较新版本对于 IIS 短文件名猜解的判断方法是不一样的，下面分情况搭建虚拟机环境测试一下：

*   **IIS6.0 下 GET 请求判断**
    

本地搭建一个 IIS6.0、Win2003 环境，看一下如何通过 IIS 短文件名猜解得到服务器文件或者文件夹地址。接下来构造如下两个 URL：

http://192.168.237.128:8888/shop/databa~1****/a.aspx

如下图所示，服务器如果存在 databa 开头的文件，则显示 404 响应码：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CKtdjfFibCZehNdLOpnsrVE0OhEf7F1TyywUV8vlrpoxCbcvXdajKY5NIKrticDiaXzyNM7CcQZuOjA/640?wx_fmt=png)

http://192.168.237.128:8888/shop/databc~1****/a.aspx

如下图所示：如果服务器不存在 databc 开头的文件，则显示 400 响应码提示：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CKtdjfFibCZehNdLOpnsrVEBwPGfxnnOSUD5XwClNrT1nwrJxzHYbAux3DwJK6cKsDD3qaHRB0bBQ/640?wx_fmt=png)

由此可知，通过以上判断方法，可以得到逐步猜解出低版本 IIS 网站目录下长文件名的前 6 位字符及后缀。但对于 IIS 较新版本，GET 请求是判断不出短文件名的，需要借助 OPTIONS 请求或者 TRACE 请求，HEAD 请求、GET 请求、POST 请求都不行。

*   **IIS 10.0 下 OPTIONS 请求判断**
    

接下来看一下 IIS 10.0 的情况下，同样在 wwwroot 目录下放一个 databackup.zip 文件：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CKtdjfFibCZehNdLOpnsrVEUhFWWcwqN3E6C7YENib3HxtE9kwmRVShVia5gVR4iclBDtsWeYz2yFibTQ/640?wx_fmt=png)

http://192.168.237.166/databa~1****/a.aspx  

如果服务器存在 databa 开头的文件，则提示 404 响应码。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CKtdjfFibCZehNdLOpnsrVE7E3S4CdcqZlNAwWdib8RpR7tXE5Uue3Qn7E0wDU0IERcA9kY103EknA/640?wx_fmt=png)

http://192.168.237.166/databc~1****/a.aspx

如果服务器不存在 databac 开头的文件名，则提示 200 响应码。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CKtdjfFibCZehNdLOpnsrVES8awSE6DWnPI14m0hiaVP3BZHtXNRKZiboDDNNIKteHiaMiaMpIrZtJBPw/640?wx_fmt=png)

*   **IIS 10.0 下 TRACE 请求判断**
    

接下来换成 TRACE 请求方法试一试：

http://192.168.237.166/databa~1****/a.aspx

如果服务器存在 databa 开头的文件，返回 404 响应码。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CKtdjfFibCZehNdLOpnsrVEdCHnCzVB5tItUDlE3Lb4potuRI2XOPGqfjWnXkJreaGzticCBianr2Gg/640?wx_fmt=png)

如果服务器不存在 databc 开头的文件，则返回 501 响应码。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CKtdjfFibCZehNdLOpnsrVExHHwgELnJpING0Hn7UEibN7fSVecOQNbrtEkeAOCfUQytcTPufVEvSA/640?wx_fmt=png)

*   **猜解方法总结如下（欢迎大家校勘）：**
    

**1.  对于 IIS6.0 左右的低版本：**

使用 HEAD、GET、POST 请求判断，返回响应码 404 则文件存在，返回响应码 400 则文件不存在。

**2.  对于 IIS10.0 左右的新版本：**

使用 OPTIONS、TRACE 请求方法判断，返回响应码 404 则文件存在，返回响应码 200 或者 501 则文件不存在。

**IIS 短文件名猜解实战案例分享：**

接下来分享一下我曾经做的 2 个实战案例。

*   **案例一：医疗行业案例**
    

这个案例来源于一次医疗行业的红队评估项目。如下图所示：通过 IIS 短文件名猜解，得到了如下两个短文件名（为了防止泄露项目信息，截图都来源于本地搭建的环境，原图就不贴出来了）

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CKtdjfFibCZehNdLOpnsrVED92SQTJTib3sgiczbHib50DZ7JEia3O3hoZVSyjfvj35VcfKZqvicmR97vw/640?wx_fmt=png)

**patien~1.asp 由于是医疗系统，所以很容易联想到单词 “病人”patient.asp**

**userad~1.asp 很容易联想到添加用户的功能页面：useradd.asp**

访问之后发现 patient.asp、useradd.asp 均不存在，因为 iis 短文件名猜解出来的后缀名只有前三位，于是将后缀. asp 换成. aspx 就显示文件存在了。

于是两个未授权访问页面就出现了，对这两个页面的漏洞进行深度挖掘，追踪页面中的 js 链接地址。patient.aspx 显示如下页面（图片是本地虚拟机环境），搜索框存在 SQLServer 注入漏洞，而且是 sa 权限，直接拿到了服务器权限。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CKtdjfFibCZehNdLOpnsrVETLIwsWrQT4e2ZHZRFv0XvIFenM8VXzC5R2eAFpXJH4XCQ6SyuibcOyQ/640?wx_fmt=png)

而 useradd.aspx 存在未授权添加用户漏洞。都是常规操，就不做过多介绍了。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CKtdjfFibCZehNdLOpnsrVECTqG5Nv29Uq1CeL6ib2TIBicahnN0RFTrMxKZkiaYN8LicOZErwTDHtQTA/640?wx_fmt=png)

*   **案例二：WebService 接口**
    

接下来看另一个稍微难一点的案例，扫描出一个真实文件名 / h/dmtkts~1.asm  

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CKtdjfFibCZehNdLOpnsrVEIc1n6wFzmWgBIyJoNntrKKRyic47QCNWfdF0oVHPA3zicVkWehRoCl1g/640?wx_fmt=png)

**dmtkts~1.asm 这个短文件名**耗费了我很长时间才给试出来：后来我在想，asm 后缀是什么后缀，开始以为是一个临时文件之类的后缀，后来我突然想到了：.asm 后缀就是. net 的 WebService 接口后缀. asmx。接下来 dmtkts 这个短文件名的完整名怎么猜，让我大伤脑筋，后来突然想到了，由于. asmx 是 WebService 的接口，后面这个 s 字母应该是 service 的首字母，**最终得到如下的完整文件名 dmtktservice.asmx**，最终拿到了一个 asmx 的任意接口调用。真是太难了。。

dmtktservice.asmx 类似于如下图片的功能（原图就不贴了），这接口里面有一处上传功能，后续利用上传漏洞拿到权限的。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CKtdjfFibCZehNdLOpnsrVEcwRM8VBNC7YYiaRoqYtJuYJcic7bKUiaVJvgvTypCHKcniazsC9zH2f5ew/640?wx_fmt=png)

对 IIS 短文件名猜解的利用案例就举这两个例子吧，都是实战案例。此外，还可以通过短文件名 + 字典的方式枚举，我曾经用过几百万行的目录字典、单词字典去跑 IIS 中间件，但最常用的还是自己按照研发人员的命名习惯去手工尝试。大家也可以发散思维，找到更多更好用的思路。

**iis 短文件名猜解脚本改造**

对于 iis 短文件名猜解，我下载了好几个脚本，各有优缺点吧，有的脚本不支持 iis10，有的脚本算法大概是有问题，跑出的 iis 短文件名不全。最终我把 lijiejie 的脚本改造了一下，使它支持 iis 10.0 的猜解，脚本主要改动内容如下：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CKtdjfFibCZehNdLOpnsrVEYvoVrJGTgjjzjWibXgR0PVAc2YrLxbSMPplAE8zrOKiaRS47fMfiaPBIg/640?wx_fmt=png)  

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450CKtdjfFibCZehNdLOpnsrVExeSF9G6icGP7vTy7A3r2qvMVPbY6eZ2k2ykQCUW8ULRy1uFGkqZKMbQ/640?wx_fmt=png)

**关注公众号，回复数字 “0518”，即可得到由 ABC_123 修改的，适用于 IIS 10.0 版本，的漏洞扫描脚本的下载地址。**

 **Part3 总结** 

**1.** 没有 0day 的时候，就把 Nday 用到极致。

**2.** 对于 IIS 短文件名猜解的利用，一定要按照研发人员的思维去猜测完整文件名。

参考链接：

https://www.freebuf.com/articles/web/172561.html

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png)

专注于红队、蓝队技术分享

每周一篇，敬请关注

![](https://mmbiz.qpic.cn/mmbiz_jpg/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rhn137KeqqlDkuRyY4G61jATRzyOrCBts8ucxkLpMNsYutSOY7BkPziaw/640?wx_fmt=jpeg)