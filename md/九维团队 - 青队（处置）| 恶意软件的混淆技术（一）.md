> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247503427&idx=1&sn=fa17158ff3c802bf946d22d1891c38a4&chksm=9ae18f7bad96066d9969c599e4faa88421f87403870d92387119ded3dad05f10d9865a52524c&scene=178&cur_album_id=2617884898938290179#rd)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOQ4y3CslMX5EINOxRsoicGxHxJnwtXjIau4usI94yHUKXTqh4LyuVL4A/640?wx_fmt=gif)

**写在前边**  

1. 本文原文为 K A, Monnappa. 2018 年发表的《Learning Malware Analysis》，本文的相关内容均为笔者对相关内容的翻译及实践记录，仅供各位学术交流使用。另出于易读性考虑，对部分字句有所删改。 

2. 如各位需要引用，请做原文引用，格式如下所示： 

[序号]K A, Monnappa. LearningMalware Analysis[M]. 2018.06. Published by Packt Publishing Ltd. Livery Place 35 Livery Street Birmingham B3 2PB, UK. 

3. 因文章整体内容较长，完整内容将会在本公众号拆分为多篇内容分别发出。本文为该系列的第一篇。

[往期内容请参见合集《Learning Malware Analysis》](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAwMDgyNTQzMQ==&action=getalbum&album_id=2617884898938290179&scene=173&from_msgid=2247502411&from_itemidx=1&count=3&nolastread=1#wechat_redirect)

  

  

混淆一词是指掩盖有意义信息的过程。恶意软件作者经常使用各种混淆技术来隐藏信息，并修改恶意内容，使安全分析人员难以发现和分析。他们通常会使用编码 / 加密技术来掩盖安全产品的信息，除此之外，攻击者还会使用打包器等程序来混淆恶意二进制内容，这使得分析和逆向工程更加困难。

在本系列文章中，我们将研究如何识别这些混淆技术，以及如何解码 / 解密和解压恶意二进制文件。我们将首先简单了解一下编码 / 加密技术，再了解一下解包技术。

攻击者通常会出于以下原因使用编码和加密：

1. 掩盖命令和控制通信。  

2. 隐藏基于签名的解决方案，如入侵防御系统、隐藏恶意软件所使用的配置文件的内容。

3. 加密从受害者系统中传出的信息。

4. 混淆恶意二进制文件中的字符串，以躲避静态分析。

在我们深入研究恶意软件如何使用加密算法之前，让我们简单了解一些即将会常使用的基本知识和一些术语。

**明文：**

指未加密的信息；这可能是命令和控制（C2）流量或恶意软件想要加密的文件内容。

**加密文本：**

指加密信息；这可能是恶意软件从 C2 服务器收到的加密的可执行文件或加密命令。

恶意软件对明文进行加密，将明文与密钥一起作为输入传递给加密函数，从而产生一个密码文本。由此产生的密码文本通常被恶意软件用来写入文件或通过网络发送。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKcDLOPsPUbXfvnUSdsiccnQP55nXq1vt5AV5jyC2TJ3ibawWXRR8CbJaib196lwYJ4HISrbKdh4CMibQ/640?wx_fmt=png)

以同样的方式，恶意软件可以从 C2 服务器或文件中接收加密的内容，然后通过将加密的内容和密钥传递给解密功能来解密，如下图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKcDLOPsPUbXfvnUSdsiccnQk9iarXYNYN61fNzIMqs5icexfWxQibibmAPOrLibm3sGKFs5y7JzIkSHBgg/640?wx_fmt=png)

在分析恶意软件时，我们可能想了解某个特定内容是如何被加密或解密的。要做到这一点，我们将主要关注识别加密或解密功能以及用于加密或解密内容的密钥。

例如，如果你想确定网络内容是如何被加密的，那么你可能会在网络输出操作（如 HttpSendRequest()）之前找到加密函数。同样地，如果你想知道 C2 的加密内容是如何被解密的，那么你很可能在使用诸如 InternetReadFile() 这样的 API 从 C2 检索到内容后找到解密函数。

一旦确定了加密 / 解密功能，检查这些功能将会使你了解到内容是如何加密 / 解密的、使用的密钥，以及用于混淆数据的算法。

**一**

简单编码

###   

大多数时候，攻击者会使用非常简单的编码算法，如 Base64 编码或 xor 加密来掩盖数据。攻击者之所以使用简单的算法，是因为它们容易实现，占用较少的系统资源，而且刚好可以掩盖安全产品及安全分析人员分析的内容。

  

**01**

凯撒密码

####   

凯撒密码，也被称为移位密码，是一种传统的密码，是最简单的编码技术之一。它通过将明文中的每个字母在字母表中下移一些固定的位置来对信息进行编码。例如，如果你将字符 "A" 向下移动 3 个位置，那么你将得到 "D"，而 "B" 将是 "E"，以此类推，当移动到 "X" 时，将包裹回 "A"。

**1.1 凯撒密码的工作原理**

#####   

理解凯撒密码的最好方法是写下从 A 到 Z 的字母，并给这些字母分配一个索引，从 0 到 25，如下图所示。换句话说，'A'对应于索引 0，'B'对应于索引 1，以此类推。一组从 A 到 Z 的所有字母被称为字符集。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKcDLOPsPUbXfvnUSdsiccnQUvxgBDuphkic8Q7VGJTPcOXLSy9e9icSGuDHl9EdkibXjJZFGpqNrSAug/640?wx_fmt=png)

现在，让我们假设你想把字母转移三个位置，那么 3 就成了你的密钥。为了加密字母'A'，将字母 A 的索引（即 0）加到钥匙 3 上；这样的结果是 0+3=3。现在用结果 3 作为索引，找到相应的字母，也就是'D'，这样'A'就被加密成'D'了。同理，为了加密'B'，我们将把'B'的索引（1）加到钥匙 3 上，结果是 4，索引 4 与'E'有关，所以'B'加密为'E'，以此类推。

这种技术的问题出现在我们到达'X'的时候，它的索引是 23。当我们将 23+3 相加时，我们得到 26，但我们知道没有与索引 26 相关的字符，因为最大索引值是 25。我们还知道，索引 26 应该绕回索引 0（与'A'相关）。

为了解决这个问题，我们用字符集的长度进行模数运算。在这种情况下，字符集 ABCDEFGHIJKLMNOPQRSTUVWXYZ 的长度是 26。现在，为了加密'X'，我们使用'X'的索引（23）并将其添加到密钥（3）中，然后对字符集的长度（26）进行模数运算（也就是 26=0(mod26)），如下所示。

```
(23+3)%26 = 0
```

这个操作的结果是 0，它被用作索引来寻找相应的字符，也就是'A'。

模数操作允许你循环回到开头。你可以用同样的逻辑来加密字符集中的所有字符（从 A 到 Z），并绕回起点。在凯撒密码中，你可以用以下方法获得被加密（密文）字符的索引。

```
(i + key) % (length of the character set 字符串长度)
where i = index of plaintext character 明文字符串索引
```

* 左右滑动查看更多  

以同样的方式，我们可以用以下方式获得明文（解密）字符的索引。

```
(j - key) % (length of the character set)
where j = index of ciphertext character
```

* 左右滑动查看更多

下图显示了字符集、加密和以 3 为密钥的文本 "ZEUS" 的解密（移动三个位置）。加密后，文本 "ZEUS" 被翻译成 "CHXV"，然后解密又将其翻译成 "ZEUS"。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zKcDLOPsPUbXfvnUSdsiccnQcC8dmD9uXegDADCaZ6fo9PqH6d7YVKSwea046KcKicJVvKUaibKffekg/640?wx_fmt=png)

**1.2 用 Python 解密凯撒密码**

#####   

下面是一个简单的 Python 脚本的例子，它将字符串 "CHXV" 解密为 "ZEUS"。

```
>>> chr_set = "ABCDEFGHIJKLMNOPQRSTUVWXYZ" >>> key = 3
>>> cipher_text = "CHXV"
>>> plain_text = ""
>>> for ch in cipher_text:
j = chr_set.find(ch.upper())
                    plain_index = (j-key) % len(chr_set)
plain_text += chr_set[plain_index] >>> print plain_text
ZEUS
```

* 左右滑动查看更多

一些恶意软件样本可能使用凯撒（shift）密码的修改版本，在这种情况下，你可以修改前面提到的脚本以满足你的需求。

APT1 集团使用的恶意软件 WEBC2-GREENCAT 从 C2 服务器获取内容，并使用修改版的凯撒密码对内容进行解密。它使用了一个 66 个字符的字符集 "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01 23456789._/-"，和一个 56 的密钥。  

（未完待续）

* * *

**—  往期回顾  —**

[**![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL227ibOmpOzGD7zr7zB8uG0FSsoSmrNybqajdOARxTKWzckYaEGEhQl0jLb31nIGLSHdgnfly5sqw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)**](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502438&idx=2&sn=b71fbe730dc1b64749725f06178077b4&chksm=9ae18b5ead960248f0ebce96cd96f4259a4ade57c8e47b3d542e33fc428e10b4608f7e53bbd1&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zK5c8cZKuNR5G61cH3JQJgJnBaHpyicaiapk8Wa3y5F1orC3l1YiapsSWHFJQ8DFVY17v3Kh5ibuOFrRg/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247503354&idx=1&sn=ea031f8247ccac1d31260dde0f288628&chksm=9ae18cc2ad9605d4d91500046f48ef5c82e86d8e3d82196fdd2d14f60c94a82b9225cec9dac7&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zK5c8cZKuNR5G61cH3JQJgJjUeUjia0hMko4UicRAtpDzhfQYlrVmxTibIyfNXH2kNKYjWd9iaCRqN7qw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247503300&idx=1&sn=30a09ab8570b450b8363789b00f4e126&chksm=9ae18cfcad9605eaef9de9c964cb1bebecfcea53fe315226965706d5a8dc064de7457266210f&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zILvgzP1Jqcv1H8kHxAZUSgcUEpzHamMgT2dWzCDpUCA65Ca14UWEF4rIlnD4FdicFjFQqoQkZLrrw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247503290&idx=1&sn=4e33105f1d7118f950a90ab90e7597d0&chksm=9ae18c82ad960594c90cd0efa744ddb34f83329193ae9e7058a009989f89121d9d83438bb412&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zIic6aXxpvD4aibicNRyqUxBtY73nuOvte8CB9gM91licicYM8LP4wo54icOBa6xK1Tym1pKqqE2m1sibsicg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247503272&idx=1&sn=f3cb0346e732dc10292f19b3f1af0e64&chksm=9ae18c90ad960586ba3603c847e8d449db5da34e3df21e33440656bf2de791057953d4465574&scene=21#wechat_redirect)

  

**关于安恒信息安全服务团队**

**安恒信息安全服务团队由九维安全能力专家构成，其职责分别为：红队持续突破、橙队擅于赋能、黄队致力建设、绿队跟踪改进、青队快速处置、蓝队实时防御，紫队不断优化、暗队专注情报和研究、白队运营管理，以体系化的安全人才及技术为客户赋能。**

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIFIDZlXFuQeZrcKrV7Zd8Aeg98Fw5jzbGBgUW1hVQXIV3YpLZncEYibgw7MFwWtDU5vwnE2QFVP7A/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL31gt4m6YIRLh7wJeOSwYPOIblCvhN6OgHhV9NMJNH0TBianlpMmRbaKG1ia7iaPsWb4UX4ImgfEJ0A/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOCUgD3ep5Jp4DE8e2S2Y3WnxsKjicicOg3OsGGRc9NPibQ61aRAqNXZQDA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)