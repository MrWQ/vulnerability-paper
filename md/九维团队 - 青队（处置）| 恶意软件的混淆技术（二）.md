> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247503627&idx=1&sn=df280588c2f7707e4edb6485aa43bcca&chksm=9ae18e33ad960725d6ada1632220f979afab8ddfdd881699cad2962cf8a9787859d9ec1601e1&scene=178&cur_album_id=2617884898938290179#rd)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOQ4y3CslMX5EINOxRsoicGxHxJnwtXjIau4usI94yHUKXTqh4LyuVL4A/640?wx_fmt=gif)

**写在前边**  

1. 本文原文为 K A, Monnappa. 2018 年发表的《Learning Malware Analysis》，本文的相关内容均为笔者对相关内容的翻译及实践记录，仅供各位学术交流使用。另出于易读性考虑，对部分字句有所删改。 

2. 如各位需要引用，请做原文引用，格式如下所示： 

[序号]K A, Monnappa. LearningMalware Analysis[M]. 2018.06. Published by Packt Publishing Ltd. Livery Place 35 Livery Street Birmingham B3 2PB, UK. 

3. 因文章整体内容较长，完整内容将会在本公众号拆分为多篇内容分别发出。本文为该系列的第二篇。

[往期内容请参见合集《Learning Malware Analysis》](https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzAwMDgyNTQzMQ==&action=getalbum&album_id=2617884898938290179&scene=173&from_msgid=2247502411&from_itemidx=1&count=3&nolastread=1#wechat_redirect)

  

  

**02**

Base64 编码

使用凯撒密码，攻击者可以对字母进行加密，但对二进制数据的加密还不够好，因此攻击者通常会使用其他各种编码 / 加密算法来加密二进制数据。Base64 编码允许攻击者将二进制数据编码为 ASCII 字符串格式。由于这个原因，你会经常看到攻击者在 HTTP 等纯文本协议中使用 Base64 编码的数据。

**2.1 将数据转换为 Base64**

标准的 Base64 编码通常由以下 64 个字符集组成。要编码的二进制数据的每 3 个字节（24 位）被翻译成该字符集的四个字符。每个翻译的字符大小为 6 比特。除了以下字符外，= 字符用于填充。

```
ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/
```

* 左右滑动查看更多

为了了解数据如何被翻译成 Base64 编码，首先需要建立 Base64 索引表，将索引 0 到 63 分配给字符集中的字母，如下图所示。按照下表，索引 0 对应于字母 A，索引 62 对应于 +，以此类推。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIwFLicWdu0N9vyIliaXOR7A2Qgib28lY4VvySUj5mAbvwibSob81viciaB05d626OoCDb120sOrOCtfXfA/640?wx_fmt=png)

现在，假设我们想对文本 "One" 进行 Base64 编码。要做到这一点，我们需要将字母转换为其相应的比特值，如下所示。

```
o -> 0x4f -> 01001111
n -> 0x6e -> 01101110
e -> 0x65 -> 01100101
```

Base64 算法一次处理 3 个字节（6 比特）（24 位）；在这种情况下，我们正好有 24 个比特，它们彼此相邻放置，如下所示。

随后，这 24 位被分成四部分，每部分由 6 位组成，并转换为其等效的十进制值。然后十进制值被用作索引，以便在 Base64 索引表中找到相应的值，因此该文本最终被编码为 T25l。

```
010011 -> 19 -> base64 table lookup -> T
110110 -> 54 -> base64 table lookup -> 2
111001 -> 57 -> base64 table lookup -> 5
100101 -> 37 -> base64 table lookup -> l
```

* 左右滑动查看更多

解码 Base64 是一个反向的过程，但理解 Base64 编码或解码的工作原理并不是必须的，因为有一些 python 模块和工具可以让你在不了解算法的情况下解码 Base64 编码的数据。在攻击者使用自定义版本的 Base64 编码的情况下，了解它将有所帮助。

**2.2 编码和解码 Base64**

要在 Python(2.x) 中使用 Base64 对数据进行编码，请使用以下代码：

```
>>> import base64
>>> plain_text = "One"
>>> encoded = base64.b64encode(plain_text)
>>> print encoded
T25l
```

* 左右滑动查看更多

要在 python 中解码 base64 数据，请使用以下代码：

```
>>> import base64
>>> encoded = "T25l"
>>> decoded = base64.b64decode(encoded) >>> print decoded
One
```

* 左右滑动查看更多

GCHQ 的 CyberChef 是一个伟大的 web 应用程序，它允许你在浏览器中进行各种编码 / 解码、加密 / 解密、压缩 / 解压和数据分析操作。

```
CyberChef访问网址：
https://gchq.github.io/CyberChef/
更多细节请参阅：
https://github.com/gchq/CyberChef
```

你也可以使用诸如 ConverterNET 这样的工具对 base64 数据进行编码 / 解码。ConvertNET 提供各种功能，允许你将数据转换为 / 从许多不同的格式。

```
ConverterNET访问网址：
http://www.kahusecurity.com/tools/
```

要进行编码，只需在输入栏中输入要编码的文本，然后点击 Text to Base64 按钮。要解码，在输入栏中输入要编码的数据，然后点击 Base64 到文本按钮即可。下面的截图显示了使用 ConverterNET 对字符串 Hi 进行的 Base64 编码。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIwFLicWdu0N9vyIliaXOR7A2cCE7fuqHGl9BPcOOyuEdjH75d44MaFHmCGb9icEvOj5MLgkPOQ7ljVQ/640?wx_fmt=png)

编码后的字符串末尾的 = 字符是填充字符。如果你还记得，该算法将三个字节的输入转换为四个字符，由于 Hi 只有两个字符，它被填充成三个字符；只要使用了填充，你就会在 Base64 编码的字符串的末尾看到 = 字符。这意味着一个有效的 Base64 编码的字符串的长度总是 4 的倍数。

**2.3 解码自定义的 Base64**

攻击者使用不同的 Base64 编码变化，其目的是阻止 Base64 解码工具成功解码数据。在本节中，你将了解到部分相关技术。

一些恶意软件样本将填充字符（=）从末端移除。这里显示了一个恶意软件样本（Trojan Qidmorks）进行的 C2 通信。下图中有效载荷看起来是用 base64 编码的。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIwFLicWdu0N9vyIliaXOR7A2bkNxI2sjBXIbmrEbFiaSPEvuFEu9HTtXuUGoywegvD6C1wCS2L9JKgQ/640?wx_fmt=png)

当我们试图解码 POST 有效载荷时，将会得到不正确的填充错误，如下所示。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIwFLicWdu0N9vyIliaXOR7A2WicpKkxbV3Juvianicsg1zk7TiawnxERQJMOeZMmCN2uZPahzNSmwxFdPQ/640?wx_fmt=png)

这个错误的原因是，编码字符串的长度（150）不是 4 的倍数。换句话说，Base64 编码的数据中缺少两个字符，这很可能是填充字符（==）。

```
>>> encoded = "Q3VycmVudFZlcnNpb246IDYuMQ0KVXNlciBwcml2aWxlZ2llcyBsZXZlbDogMg0KUGFyZW50IH Byb2Nlc3M6IFxEZXZpY2VcSGFyZGRpc2tWb2x1bWUxXFdpbmRvd3NcZXhwbG9yZXIuZXhlDQoNC g"
>>> len(encoded)
```

* 左右滑动查看更多

将两个填充字符（==）附加到编码的字符串中，成功地解码了数据，如下图所示。从解码后的数据可以看出，恶意软件向 C2 服务器发送了操作系统版本（6.1 代表 Windows 7）、用户的权限级别和父进程。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIwFLicWdu0N9vyIliaXOR7A2gec4HQ6HM3b0tfmDljrpjiaRLkqkOFqQrwStTleaNVeV6icLXksE1Gsw/640?wx_fmt=png)

有时，恶意软件作者使用 base64 编码的轻微变化。例如，攻击者可以使用一个字符集，其中字符 - 和_被用来代替 + 和 /（第 63 和 64 个字符），如下所示。

```
ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_
```

* 左右滑动查看更多

一旦确定了在原始字符集中被替换的字符来对数据进行编码，那么我们就可以使用如下所示的代码。此处的意思是将修改后的字符替换回标准字符集中的原始字符，然后再进行解码。

```
>>> import base64
>>> encoded = "cGFzc3dvcmQxMjM0IUA_PUB-"
>>> encoded = encoded.replace("-","+").replace("_","/") >>> decoded = base64.b64decode(encoded)
>>> print decoded
password1234!@?=@~
```

* 左右滑动查看更多

有时，恶意软件作者会改变字符集中的字符顺序。例如，他们可能使用以下字符集而不是标准字符集。

```
0123456789+/ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz
```

* 左右滑动查看更多

当攻击者使用非标准的 Base64 字符集时，我们可以用以下代码对数据进行解码。注意，在下面的代码中，除了 64 个字符外，变量 chr_set 和 non_chr_set 还包括填充字符 =（第 65 个字符），这是正确解码所需要的。

```
>>> import base64
>>> chr_set = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=" >>> non_chr_set = "0123456789+/ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz="
>>> encoded = "G6JgP6w=" >>> re_encoded = ""
>>> for en_ch in encoded:
            re_encoded += en_ch.replace(en_ch,
   chr_set[non_chr_set.find(en_ch)])
>>> decoded = base64.b64decode(re_encoded) >>> print decoded
Hello
```

* 左右滑动查看更多

你也可以使用 ConverterNET 工具，通过选择转换自定义 Base64 来执行自定义 Base64 解码。只要在 Alphabet 字段中输入自定义的 Base64 字符集，然后在 Input 字段中输入要解码的数据，并按下 Decode 按钮，如下图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIwFLicWdu0N9vyIliaXOR7A2y0iciaic56MDUDV5lVoC272g8ayKIuicFLCMibUOyNpd1DbtA1ZUyicuWOeQ/640?wx_fmt=png)

**2.4 识别 Base64**

我们可以通过寻找一个由 Base64 字符集（字母数字字符、+ 和 /）组成的长字符串来识别一个使用 Base64 编码的二进制文件。下面的截图显示了恶意二进制文件中的 Base64 字符集，表明恶意软件可能使用了 Base64 编码。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIwFLicWdu0N9vyIliaXOR7A2The5GJVBZHcATkwibEh2GLym1X0y1xVcKe29wCfibm3PuwEcxWO8K2RA/640?wx_fmt=png)

你可以使用字符串交叉引用功能来定位使用 Base64 字符集的代码，如以下截图所示。即使没有必要知道代码中哪里使用了 Base64 字符集来解码 Base64 数据，但有时，定位它是有用的。

例如在恶意软件作者使用 Base64 编码和其他加密算法的情况下。又或者如果恶意软件用某种加密算法对 C2 网络流量进行加密，然后使用 Base64 编码；在这种情况下，定位 Base64 字符集可能会使你进入 Base64 函数。然后就可以分析 Base64 函数或确定调用 Base64 函数的函数（使用 Xrefs 功能），这可能会令你找到加密函数。

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIwFLicWdu0N9vyIliaXOR7A2HhVewpwTuReeauibgegvvmwKG1ib99I0uGrvZjrdvUnkmyWjYHKGXubQ/640?wx_fmt=png)

我们可以在 x64dbg 中使用字符串交叉引用；要做到这一点，需要确保调试器在模块内任何地方暂停，然后在反汇编窗口（CPU 窗口）上点击右键，选择搜索 | 当前模块 | 字符串引用。

另一种检测二进制文件中是否存在 Base64 字符集的方法是使用 YARA 规则，如下所示。

```
rule base64
   {
   strings:
       $a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"
       $b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"
   condition:
$a or $b }
```

* 左右滑动查看更多

* * *

**—  往期回顾  —**

[**![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL227ibOmpOzGD7zr7zB8uG0FSsoSmrNybqajdOARxTKWzckYaEGEhQl0jLb31nIGLSHdgnfly5sqw/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)**](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247502438&idx=2&sn=b71fbe730dc1b64749725f06178077b4&chksm=9ae18b5ead960248f0ebce96cd96f4259a4ade57c8e47b3d542e33fc428e10b4608f7e53bbd1&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zK8iaQnNt5c6mVOpFsTibQ4k4hnrTYcRf4xttBMhSDiaBL8viar5gm1EpkDqzoSo9m7yc6OoiavDlHKYlg/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247503616&idx=1&sn=2d5472e002c928d603eb66d879038b35&chksm=9ae18e38ad96072ec81d739892ad58e859b60c602c55f367ab94547bb53f88325ed3a28f92dd&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zIwFLicWdu0N9vyIliaXOR7A2YluY8ib8n7V9yyymyuDWKUWo3JCttdHLsDegQW3aPDn7J1hDOnMhpqA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247503463&idx=1&sn=bcf6ed2066755691ea27018827f46954&chksm=9ae18f5fad9606496a6899f02eeea756e3cf1b11d6ed3b1e04bc2f47453c2f9cfc8759d0c815&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zKGW2PQGbMJOCZVKXJOGC84BhN1pWGiaferibEDjGSuicxLiaTANoR2rJWlFoiaAx9I4avydgxzMbYBiaUg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247503427&idx=1&sn=fa17158ff3c802bf946d22d1891c38a4&chksm=9ae18f7bad96066d9969c599e4faa88421f87403870d92387119ded3dad05f10d9865a52524c&scene=21#wechat_redirect)

[![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zK5c8cZKuNR5G61cH3JQJgJnBaHpyicaiapk8Wa3y5F1orC3l1YiapsSWHFJQ8DFVY17v3Kh5ibuOFrRg/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)](http://mp.weixin.qq.com/s?__biz=MzAwMDgyNTQzMQ==&mid=2247503354&idx=1&sn=ea031f8247ccac1d31260dde0f288628&chksm=9ae18cc2ad9605d4d91500046f48ef5c82e86d8e3d82196fdd2d14f60c94a82b9225cec9dac7&scene=21#wechat_redirect)

  

**关于安恒信息安全服务团队**

**安恒信息安全服务团队由九维安全能力专家构成，其职责分别为：红队持续突破、橙队擅于赋能、黄队致力建设、绿队跟踪改进、青队快速处置、蓝队实时防御，紫队不断优化、暗队专注情报和研究、白队运营管理，以体系化的安全人才及技术为客户赋能。**

![](https://mmbiz.qpic.cn/mmbiz_png/hiaiaLeG6N1zIFIDZlXFuQeZrcKrV7Zd8Aeg98Fw5jzbGBgUW1hVQXIV3YpLZncEYibgw7MFwWtDU5vwnE2QFVP7A/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_jpg/hiaiaLeG6N1zL31gt4m6YIRLh7wJeOSwYPOIblCvhN6OgHhV9NMJNH0TBianlpMmRbaKG1ia7iaPsWb4UX4ImgfEJ0A/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_gif/hiaiaLeG6N1zItD3hicyicTUxCsdYyvSZWKOCUgD3ep5Jp4DE8e2S2Y3WnxsKjicicOg3OsGGRc9NPibQ61aRAqNXZQDA/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)