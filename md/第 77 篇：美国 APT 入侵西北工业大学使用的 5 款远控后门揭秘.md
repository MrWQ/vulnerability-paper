> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/N_jJzk5ZqJEyU8COqBzzxQ)

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ATcz6jUJnFNeOxRzVZ9LbcCCMJ6Af2WYicgMPA32IwibF8mI2ibC9h8jaHkhxnZzZuqctMLRTxDudicA/640?wx_fmt=png)

 **Part1 前言** 
--------------

**大家好，我是 ABC_123**。在几个月前，我反复研读国家计算机病毒应急处理中心的多篇报告及 360 安全公司发布的各种关于该事件的报道，再结合国外对于美国 APT 研究报告，花了半个多月的时间复盘了美国 APT 入侵中国西北工业大学的整个流程，详见《[第 58 篇：美国安全局 NSA 入侵西北工业大学流程图梳理和分析 (正式篇)](http://mp.weixin.qq.com/s?__biz=MzkzMjI1NjI3Ng==&mid=2247485672&idx=1&sn=88c320d451ed4b1b23538cc3b888a33d&chksm=c25fc793f5284e852ffd7ebd1827f23ae4b358e00a95c7936439b00ef64b51e6e1c9a46c31a7&scene=21#wechat_redirect)》。随着对美国 APT 组织和武器库的进一步了解，**ABC_123 最近又有新的领悟和研究成果**，本着 “未知攻、焉知防” 的道理，今天给大家讲一讲美国 APT 在入侵西工大过程中，所用到的 5 款远控后门。

**建议大家把公众号 “希潭实验室” 设为星标，否则可能就看不到啦！**因为公众号现在只对常读和星标的公众号才能展示大图推送。操作方法：点击右上角的【...】，然后点击【设为星标】即可。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450DbhnGmO67ewLDJqstfHZSHdFeDURNa0QpfjclGrvg0lfANPtuLbf5Ddur3HZmdfAydibIf9zazCKQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

 **Part2 技术研究过程** 
------------------

根据官方发布的多篇报告，美国 APT 在入侵西工大过程中，一共使用了以下 5 款远控：

 **1** 针对边界设备及 linux 系统的 "**NOPEN**" 远控木马。

 **2** 针对 Windows 主机的 “**怒火喷射**” 图形界面远控。

 **3** 针对边界设备的 “**二次约会**” 中间人劫持远控。

 **4** 用于持久化控制的长期潜伏的 “**狡诈异端犯**” 后门。

 **5** 与 "NOPEN" 后门配合使用的实现各种隐藏功能的 “**坚忍外科医生**”rootkit 后门。

*   **NOPEN 远控木马**
    --------------
    

在之前的文章中介绍过，美国 NSA 通过 SunOS 系统远程溢出漏洞或者其它网络设备漏洞向边界设备植入后门，这种后门通常就是 NOPEN 木马。它由美国国家安全局 NSA 研发，主要用于控制受害单位的网络设备节点，主要针对 unix/linux 系统，包括 FreeBSD、SunOS、HP-UX、Solaris、Linux 等。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ALCL8wq1CSmicgCkj2ZkpQahWLblLsUhjDXIodPiaEgMqeLhZOEZIEprYFnOcHPDHicicVfy84lbH3XQ/640?wx_fmt=png)

ABC_123 对以往美国 APT 的报告解读来看，美国 NSA 曾利用防火墙等边界设备的多个远程权限获取漏洞，对很多公司的边界设备植入了大量的 NOPEN 后门。NOPEN 后门的植入方式主要有以下几种：

 **1**  攻击者手工植入。

 **2**   通过 "酸狐狸" 浏览器 0day 攻击平台配套的 "验证器" 后门加载植入。

 **3**  通过 "狡诈异端犯" 持久型潜伏后门植入。

 **4**  防火墙等边界网络设备 0day 漏洞利用工具自动化植入等。

 **5**  Linux 系统远程溢出漏洞植入。

NOPEN 木马包括服务端 noserver 和客户端 noclient 两部分，客户端会采取发送激活包的方式与服务端建立连接，使用 RSA 算法进行密钥协商，使用 RC6 算法加密通信流量。**NOPEN 后门的默认监听端口是 32754**，如果 32754 端口被占用，那么会递增一个端口号，监听在 32755 上，以此类推。

如下图所示，这是 NOPEN 木马的客户端的使用过程：

noclient [参数 1：目标主机 IP 地址]:[端口号（默认为 32754）]

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ALCL8wq1CSmicgCkj2ZkpQa8GRQ2hsvfY26jWwUGXAZHTTDE62uTkOIjRKKXlblpzIgLdLbMfqSWw/640?wx_fmt=png)

如下图所示，它连接服务端会有一个密钥协商过程，之后返回一个命令行格式的控制台。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ALCL8wq1CSmicgCkj2ZkpQajfxPibhWlGLCwoMicInmIRdpSmI2AZSiadjKLJYx3lxmiaTcpj4jlFQyLg/640?wx_fmt=png)

输入 help 命令会显示当前 NOPEN 可以进行的操作，而且提供了使用帮助。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ALCL8wq1CSmicgCkj2ZkpQaaaZfzFMUqXicRzHamag7172EeMZMibibKz8DEBK3eVJzmgEPhUE2bedXQ/640?wx_fmt=png)

输入 shell 命令，会返回一个交互型的 shell，可以执行任意 Linux 操作系统命令。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ALCL8wq1CSmicgCkj2ZkpQa4xI0W6eUQmX5zFibp5JgnWrcX2teuAFO6KkaiawJ6whBvCbkdj6gNksw/640?wx_fmt=png)

使用 wireshark 进行抓包，发现通信过程中流量是完全加密的。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ALCL8wq1CSmicgCkj2ZkpQa9BWqNGtDEPOHItcQKL4JKNRLfZpIgTYHOBs0XVkNQIIQZ7hNzYLD1Q/640?wx_fmt=png)

*   **二次约会中间人劫持后门**
    ---------------
    

“二次约会” 中间人劫持后门是美国 NSA 的最重要的网络攻击武器之一，一般与 "酸狐狸" 浏览器 0day 打击平台 Foxacid 配合使用。**这款攻击武器一般会长期驻留在网关服务器、边界路由器、防火墙设备中**，针对海量数据流量进行精准过滤与自动化劫持，可以用于网络流量监听、中间人劫持攻击、在流量包中插入恶意链接或者恶意代码，同时它还可以结合 **BADDECISION** 无线攻击武器对无线网络上的用户发起 “中间人” 攻击，在用户不知情的情况下访问 NSA 服务器的恶意载荷，导致个人电脑被控。

在美国入侵西工大案例中，美国 NSA 的 TAO（特定入侵行动办公室）在西北工业大学边界设备上安置该武器，劫持流经该设备的流量引导至 “酸狐狸” 平台实施浏览器溢出漏洞攻击。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ALCL8wq1CSmicgCkj2ZkpQahWLblLsUhjDXIodPiaEgMqeLhZOEZIEprYFnOcHPDHicicVfy84lbH3XQ/640?wx_fmt=png)

这款后门支持分布式部署，由服务端和客户端构成。攻击者可指定源 IP 地址、源端口、目的 IP 地址、目的端口、协议类型、TCP 标志等对网络流量进行过滤，并且**可以指定匹配正则表达式文件以获取特定内容的流量，并且能够在流量中插入包含特定内容的返回包**。接下来看这款工具的部分功能，以下是客户端程序：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ALCL8wq1CSmicgCkj2ZkpQaKGLulhTEnwj4I1lpRDvjU1HXIuo23jxtr8GC0vKiasm6bJdiaMWicFfibQ/640?wx_fmt=png)

以下是 "二次约会" 工具的 server 端程序：

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ALCL8wq1CSmicgCkj2ZkpQaTRWZaWhM4lF8OEG3DSicXNr4R7CcibnS0eqmMYlBHCOc3ibMWxcibiaIviaA/640?wx_fmt=png)

*   **怒火喷射图形界面远控**
    --------------
    

"怒火喷射" 远控是一款基于各种版本 Windows 系统的远控木马，并且带有图形界面，它可以生成 20 多种 payload，本身具备极强的抗分析、反调试功能。**在内网横向过程中，"怒火喷射" 远控可以结合方程式工具包的 "永恒之蓝"、"永恒浪漫"、"双脉冲星" 等 Windows 远程溢出漏洞实施攻击**。在美国 APT 对西工大攻击的案例中，TAO 机构主要使用该武器配合 “酸狐狸” 平台对西北工业大学办公网内网的个人电脑实施持久化控制。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ALCL8wq1CSmicgCkj2ZkpQaUDjbHOMEDkEpkXoEfm4I7bECqcTrhHODsfAj2icrPC5bqKDqlGu3AQg/640?wx_fmt=png)

如下图所示一旦木马上线，它会自动化进行一系列的信息收集。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ALCL8wq1CSmicgCkj2ZkpQaDVPj44KQXfZNqnYRFnib6Z40xcADrH0kpNkQnlScN5f9tck4ibzE0cnw/640?wx_fmt=png)

这款远控提供了很多后渗透功能，提供了各种插件，包括执行命令、文件浏览、日志查看、脚本定制、提升权限、网络查看、进程查看等。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ALCL8wq1CSmicgCkj2ZkpQaw0FwBGcmDxesh1QQrZZoeocnPFEjBj7ar3QX5zQFUia8WO2xoz2mC4g/640?wx_fmt=png)

为了适应各种网络环境，它支持正向连接、反向连接，支持 TCP 协议、HTTP 协议及 ICMP 协议。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ALCL8wq1CSmicgCkj2ZkpQaK6R9PfoeibpdJUDU2EbN1ROf2D908OG0qmglBdDpUM2NUciakIj5wcdw/640?wx_fmt=png)

同样带有对 windows 系统的截屏功能。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ALCL8wq1CSmicgCkj2ZkpQa8D4qd7bHdWrx45eoYkzlwjMq4YibwNGyjjRibicZooBViaR1NT02DfiacQA/640?wx_fmt=png)

*   **狡诈异端犯**
    ---------
    

"狡诈异端犯" 是一款轻量级的后门植入工具，运行后即删除自身，具备权限提升能力，**可长久潜伏于目标设备并可随系统自启动**。TAO 主要使用该武器实现持久化，以便在合适时机建立加密管道上传 NOPEN 木马，保障对西北工业大学信息网络的长期控制。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450ALCL8wq1CSmicgCkj2ZkpQatfV3WiaLwE0icjyQ3c82LZr2QHiccoEdFuCaanibDwHjpIxj2Zfc6iaFdQg/640?wx_fmt=png)

根据美国 NSA 的公开资料显示，"狡诈异端犯" 分为持久化版本和一次性版本，持久化版本在 Linux 系统重启后仍能存活。这款后门在进程注入之前会检查系统的进程，检查是否有适合注入的进程，如果返回 00，则代表后门安装成功，如果返回 09 错误，代表没有找到合适的能注入的进程，后门安装失败。"狡诈异端犯" 可以通过触发（Trigger）来激活，**并上传前面我们介绍的 "NOPEN" 后门**。

此外，这款后门美国 NSA 提供了专门的卸载工具，运行后卸载工具会删除自身，木马随之被清空，不留痕迹。**美国 NSA 的官方文档指出该工具不能与 TripWire**（文件系统完整性检查）同时使用，说明该类安全防护软件还是有一定效果的。

*   **坚忍外科医生 rootkit 后门**
    ---------------------
    

"坚忍外科医生" 是一款高级 rootkit 后门，在对西北工业大学的网络攻击中，美国 NSA 使用了多个版本。它可以和 Dewdrop 模块搭配使用，此武器是一款针对 Linux、Solaris、JunOS、FreeBSD 等 4 种类型操作系统的后门，该武器可持久化运行于目标设备上，**根据指令对目标设备上的指定文件、目录、进程等进行隐藏**。TAO 主要使用该武器隐藏 NOPEN 木马的文件和进程，避免其被监控发现。

**美国 NSA 的 TAO 机构将 “精准外科医生” 后门与远程控制木马 NOPEN 配合使用**，实现进程、文件和操作行为的全面 “隐身”，长期隐蔽控制西北工业大学的运维管理服务器，同时采取替换 3 个原系统文件和 3 类系统日志的方式，清楚痕迹，隐藏自身。官方报告指出，先前的美国 NSA 的 "Incision"后门可以直接升级到" 坚忍外科医生 " 后门。

 **Part3 总结** 
--------------

**1.**  美国 NSA 针对不同的操作系统、在不同的 APT 攻击阶段，会定制和使用不同的远控后门，这点与其它 APT 组织不同，其它 APT 组织更习惯把各种功能都集中到一两款远控上。

2.  对于 "二次约会" 中间人劫持工具、狡诈异端犯后门、坚忍外科医生后门，我目前还没弄明白怎么使用。**公开的资料太少了，有的可能需要多个组件配合使用，如果有读者了解使用方法，烦请指点一下，在此谢过**。

**3.**  后续 ABC_123 会对美国 NSA 的后门做进一步分析，需要借助 IDA Pro 等反编译工具，我已经好多年没搞过这一块了。**只能感叹，对于网络安全的各个技术方向，研究到最后都离不开系统底层**。

![](https://mmbiz.qpic.cn/mmbiz_png/OAz0RNU450A5qqg2iaK6KIYYR8y6pF5Rh3JHDibOKOop204nXz618iawdRb8dABicMPtHb2PkJE8x6koJO5HyuwZJQ/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**公众号专注于网络安全技术分享，包括 APT 事件分析、红队攻防、蓝队分析、渗透测试、代码审计等，每周一篇，99% 原创，敬请关注。**

**Contact me: 0day123abc#gmail.com(replace # with @)**