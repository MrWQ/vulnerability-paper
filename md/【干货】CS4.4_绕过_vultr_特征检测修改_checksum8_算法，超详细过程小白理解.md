> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/dtG6RD4QWmBr4zDyB4zS3g)<table width="676"><tbody><tr><td valign="top" width="557" height="62"><section><strong>声明：</strong>该公众号大部分文章来自作者日常学习笔记，也有少部分文章是经过原作者授权和其他公众号白名单转载，未经授权，严禁转载，如需转载，联系开白。</section><section>请勿利用文章内的相关技术从事非法测试，如因此产生的一切不良后果与文章作者和本公众号无关。</section></td></tr></tbody></table>

文章来源：学习笔记

前言
--

**「众所周知，关于 cs 相关的资料都非常的少，并且是打得特别紧，特别是这两年各个安全厂商对 cs 相关的内容都给予了特征识别等严重的打击，例如 vultr 网站会检测特征并关停服务器，我们可以同个多种方式更改特征绕过，接下来我们来讲更改 cs 的算法进行绕过。例如下面这样」**

我弄的环境，就因为开了 cs 结果就被强制破坏 o(╥﹏╥)o

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQogqrgAoPhAzt9b78tvwMzGYMOFT87vdgjXy1jGemcdyuSQsy5Qrk9MA/640?wx_fmt=png)❞

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQocoTCML8oLmjQtxdoKNnEe0TNRTqicpXlJJSE8uXibXulpnC3Af3Mlg9A/640?wx_fmt=png)❞

### 特征检测

**「关于被检测的特征详细来概述」**

首先我们新建监听器

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQo30PmBCxP5r067vw7MuMr4sNeicchhbtvVbSUGchFLr895NicZBqW7SOQ/640?wx_fmt=png)❞

这里我们一般用 80 和 443 来监听，因为其他端口的容易被封，这俩端口基本没人去管

接下来我们打开特征的的一些链接看下

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQoEkxX0gGGkGDwtxv5hGnVMSXNFthicgDszZ3Z4VJ4EfRianCwPdJGLnDA/640?wx_fmt=png)❞

可直接下载对应的文件，网上有一大堆检测脚本，我就不列举了

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQoxvmx4v84bZJfuNmdNEwBRDS0LmIYIgc25ctwLFGP09ia9XhXGLZHyuQ/640?wx_fmt=png)❞

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQo9NGJz1Pia8OQytvDdJyA4Yy69PLMjUt92NfVdu6TnH1zhRZS63MQM3Q/640?wx_fmt=png)❞

### 链接特征

```
80：http://IP/aaa9

443：https://ip:443/aaa9
```

当然特征不止这一个**「aaa9」**例如**「http://IP/HjIa」** 这个也会出现这种状态 并不是 404 （部分浏览器假的 404 需要多打开几遍才会请求下载未知文件）只要是符合**「checksum8」**算法技术出来的文件都可以请求到 **「不是唯一值」**

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQojEjw55ZV6mg9ricibZ3zx5BicDG1pKHKT7zVvaic954B94KZKuQspiaPia0g/640?wx_fmt=png)❞

我们可以看到这里面的请求的一些状态链接都是很短的，只有在发命令通过抓包才是那种长链接

下面就直接反编译，或者你找源码 都是有的

反编译
===

我们更改特征首先要反编译压缩包里面所有的. class 文件，把他变成. java 格式的我们才能编译

反编译这里推荐有一个工具比较方便，当然还有其他工具 但是讲的话文章会很长 我尽量很详细，我学习的时候搜索的资料大部分都有坑或者关键部分就直接跳过了这就很烦结合了多个文章内容我直达精髓。

JD-GUI：https://jd-gui.apponic.com/download/

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQo2F3kzO8c8eWfQDVCAzUSp05C2hicuCDthRb3xHHVIkFwZv6Kvo9wQDw/640?wx_fmt=png)❞

我们可以看到很直观的就可以看到里面的内容

> ❝
> 
> 我们通过左上角**「File→Save All Sourcel」**来保存全部反编译的文件（也可以下载别人的源代码或者别的工具反编译），会让你选择路径以及各式，保存好，我们这里反编译好了出现了个**「cobaltstrike.jar.src.zip」**文件
> 
> ❞

然后我们安装**「JAVAIDE」**(这个工具里面也有反编译的包具体方法可以网上搜索)

```
Java ide：https://www.jetbrains.com/zh-cn/idea/.
```

下载安装 里面有两个版本 不用纠结 第一个收费 第二个社区的免费 正好也能满足我们的需求

安装完成后我们打开安装中文包插件（英文的我看不懂）在**「PLugins」**里面搜索**「chinese」**第二个就是

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQo9ZMG7SUtXzcXTWapt9re5BJVwe1qM5RRiaOVlFwpl61lqRlDC9QTfSQ/640?wx_fmt=png)❞

我们来安装他 点击安装后会重新启动软件就变成中文的了

### 项目和环境配置

> ❝
> 
> 这里我首先提醒大家最好用老版本的 Java, 原因是新版本的编译的老版本的 java 不能运行，而老版本的却向上兼容，这就很蛇皮了，太老的版本可能少程序 推荐 java1.8    java1.8=java8 是一样的。（这个里面可以直接下载 Java1.8.0，目前是可以的以后就不知道了）
> 
> ❞

1、我们新建项目就默认第一个 java 模块然后不停的下一步选择路径打开，看图

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQoPfJdC4B2r7NSFgN0OfM6vbWGnZStkRwUDjfTy03D15M04ywgSXr6jA/640?wx_fmt=png)❞

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQoNia08iaEVk0FibuyZesM9RpNdQzWX3suB7D8K4efQ8BiaGhzwcPOuaCUbw/640?wx_fmt=png)❞

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQo4QAB5dXTnxwKBsfVchCHpa1t0kbrEc7WufaX8l8kibWXM4icLPuEFtRA/640?wx_fmt=png)❞

2、创建好之后我们新建俩文件夹，在软件里面和在外面创建都行都是同步刷新的，修改也是。这里我们新建**「decompiled_src」**和 l**「lib」**文件夹这里我就列举一个图减少占用

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQogsXwicy7VqTuT69hFBh81eOn0me8FevFOibcrQnsT8IibTe5b2BhOrpeg/640?wx_fmt=png)❞

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQoqjmtt4Q9m3roOZRJ8lsNsGiaj7E0n5X4jRJkfWDteX3JCkCaAjAaC8w/640?wx_fmt=png)❞

3、建立完成就是这个样子的，现在我们需要两个文件一个是反编译后**「cobaltstrike」**文件，一个是未反编译的**「cobaltstrike.jar」**原始文件，原因是编译需要依赖的文件环境和包，不然各种报错，非常的恼火，把原始文件**「cobaltstrike.jar」**放到**「lib」**文件夹，反编译后的解压到**「decompiled_src」**文件夹

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQob9X1eSWLpEt9bu94sf6Vwn4HGU0VBfRABZbmJy1JHT7zwyXztf1RMA/640?wx_fmt=png)❞

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQo7jwGiaQwNLUjNeO8sbEwb85GmWEImNTty5zcric8ibA20UibDvgR2ucRmQ/640?wx_fmt=png)❞

4、弄好之后就是这个样子的，然后咱们来设置环境，左上角 文件→项目结构，看一下**「sdk」**是否正确，然后点击模块，然后看图

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQotAlTTR0CLc8W7AHdWMgkwMe65OrheY2RwiaoJqjiaaLib0ryNDFekCBHQ/640?wx_fmt=png)❞

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQo4DpM9HP5qvvIPJHzicgnN1TkgkTrfUdicmvMxpb5SvuwnV0IicgqWe35w/640?wx_fmt=png)❞

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQoUT4wCPWxQO9RNZALl5zloFAlKw8bxvxbADpIjl5U5VgIP93VUib6yCg/640?wx_fmt=png)❞

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQow78EkI7cRYcVMrSAhtKwA0ic7JdbUicpQLhcg9lLiajN5njJP8bzvNnbA/640?wx_fmt=png)❞

5、**「选择 lib 里面 cs 原始 jar 包点击确定，确定完成之后打勾然后应用」**

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQoJWhfk6ic1C1yMQ8SNMc2TJn9HncAuHzK0L7xckR6Mia64LfhrzXlbC7g/640?wx_fmt=png)❞

6、然后点击**「工件→JAR→来自有依赖项的模块→然后选择 Aggressor」** 出现**「aggressor.Aggressor」**就说明正确了，然后确定，工件就设置完成了

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQoQOld7hiaLw5o6sCkJS3bYqQdu0Ua2jXzg5lJohay2tsC7KaibWEUMyzg/640?wx_fmt=png)❞

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQolhWlxKTUMUsoicdUtIhSjxutu9K93MSElFXVMyZDCpdr9badfO4UT7g/640?wx_fmt=png)❞

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQo23uia9ibx2lv1uCLOTtV1tMdDgibfpWhOkuv54BGsDQYfZxMlNogMF0vg/640?wx_fmt=png)❞

**「7、接下来看一下 sdk 有没有设置正确，正确直接应用然后确定」**

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQobT8HCliamnL2nkE8ZlI7EeibCeCLHTe6BB8qh6iaXZY6a9T64vEobab6A/640?wx_fmt=png)❞

### 修改 checksum8 算法

在**「D:\cs\decompiled_src\cloudstrike」**里面有个**「WebServer.java」**文件包含算法，这个好像是监听器里面的，有这个算法的还有另一个**「D:\cs\decompiled_src\common\CommonUtils.java」**也包含 checksum8

我们吧要修改的文件放到**「D:\cs\src」** 里面，这个文件代表着我们要编译的文件整合到 jar 文件里（就是实际只是编译的这两个文件）复制的之后要注意吧文件夹也复制过去 它会自动整合到路径

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQo54jlfebDsk0vapLtLuIjSicAM60SvILicx4l6BeW82ibiac1JAOBZfpHJQ/640?wx_fmt=png)❞

我们双击打开**「WebServer.java」** 然后**「ctrl+f」**搜索**「checksum8」**，这里我们很直观的就可以看到各种结果

![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQoOS4kOQ9I5z0tjLxUWbFUTABygVcUTiciacrUNvLzicaLrsX3fKPXRsM6g/640?wx_fmt=png)

**「checksum8，辅助算法计算脚本」**

```
public class EchoTest {    public static long checksum8(String text) {        if (text.length() < 4) {            return 0L;        }        text = text.replace("/", "");        long sum = 0L;        for (int x = 0; x < text.length(); x++) {            sum += text.charAt(x);        }        return sum;    }    public static void main(String[] args) throws Exception {        System.out.println(checksum8("ds6f565sdf44s65d4f21dsf1.jpg"));    \}\}
```

首先，我们想一个自己想要生成的 stage 访问下载地址 “**「ds6f565sdf44s65d4f21dsf1.jpg」**” 可以随意更换的

我们对于**「ds6f565sdf44s65d4f21dsf1.jpg」**这个可以随意换字符，这个是我乱打的到时候请求这个会请求到我们的文件，这个文件用于生成的那种 20kb 的他是后续会自动下载这个载入进去 你不想要这个可以直接 web 里边杀掉这俩 stager 站点，为了我的内容能少点我就不讲其他的了，可以从别的文章了解。

我们通过这个技术按脚本可以把他复制到在线 java 运行的网站查询结果，我这边呢就列举一个

在线运行 java：https://c.runoob.com/compile/10/

进去之后把技术按脚本复制粘贴到里面然后自己把这个字符串随意编辑一下点击运行，这里这个运行结果就是我们要更改的值，这里我们需要技术两个不一样的值，一样的话只能生效一个，x64 和 x86 随意分配计算

> ❝
> 
> 注意：x64 和 x86 是分别弄两个固定的下载 stage 的文件
> 
> ❞

**「首先，我们第一个 x86 就如图所示，checksum8 计算之后值等于 2260 就可以上线」**

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQo4ulEU8zUqFQwibFl6Eib0Dqic4XcIK36XgRYnGeTAdlUU5Xz07ibibW3yZQ/640?wx_fmt=png)❞

**「第二步，此处同理，我们得出第二个想要的值 2665，对应的就是传入的固定 jpg 路径」**

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQosF8USfAgG0ET83S08kcBzo1pE5Obict1FTLFicYePj0yb5ljeEkHtxXw/640?wx_fmt=png)❞

**「第三步，修改对应位置的我们刚刚生成的值和字符串」**

删完之后是这个结果如下图，可别把人家的括号和符号给人家干没了，不然要报错，**「如图所示」**

**「注意：同是小白提醒下，请勿删多删少，报错会让你知道」**

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQo7R2HwQjRKtDUBHJKsuU20alxZ1TzSEf4pd35K4QVjgpSII8Gt7ebVw/640?wx_fmt=png)❞

**「第四步、**「然后我们先编译测试下 因为反编译的肯定有错误的地方会报错，有时候不报错运气好，我们点击」**构建→构建工件」**，然后点击**「构建」**

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQopiax6agLnUVS3OhTkxu9EKr8P6Fnt39ib9Jia7J0zy11H5iaibuvMQZx2zA/640?wx_fmt=png)❞

接下来我们会看到 3 个错误，这个错误就是表示重复引用了某个字符，解决也简单 直接**「删除」**，如图

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQolic2cdGrgaGSRORKw8HMbymTahsZNmdiazKRjnUSjD71GjLOLSe9fGxw/640?wx_fmt=png)❞

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQomtuZY5xfMtKZvzqFHYCMsQIFFtHW5NKKwRvsicwPT0Ec70ZyITqE8Ww/640?wx_fmt=png)❞

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQomGRcxfic0pZQDLMLvofyLBGawgvevRu3ZjuOiaUIvyR6fqnHkLAticUsA/640?wx_fmt=png)❞

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQoygxVoSibNMp9EGsezKVUqzE3FscOCWoILz7I0W6uUR8ST9EXDsZ8XIA/640?wx_fmt=png)❞

编译不出错的不用管这个，这 3 错误搞完就可以编译了，输出目录在**「D:\cs\out\artifacts\cs_jar」**

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQoVfPMewZM5a2n7HdhjsWlLKNMfTGCJvSqNXFRl60wceJKmsYel6dicUg/640?wx_fmt=png)❞

改完这一个他们通过原本的特征无法检测到你了，但是你只改这一个的话是无法上线的，你可以在 c2 文件中吧请求的 url 改成**「ds6f565sdf44s65d4f21dsf1.jpg」**或者跟我进行下一步

> ❝
> 
> 解释一下：CommonUtils 对应的就是你小马 20kb 会主动访问服务器下载 stage 的，你得改对访问路径，相应是我们上面生成的
> 
> ❞

接下来改上线，没错就是这个 **「CommonUtils.java」**文件 但是注意别改错文件了 改**「src」**文件夹里面的 **「CommonUtils.java」**文件，我们打开他，还是老样子，搜索**「checksum8」**字符定位到相关代码附近

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQo1uWpeKia07MoS0fZqv7U8aDyudgUdHs6TJEmHSjala7e8U451BRq3uA/640?wx_fmt=png)❞

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQoxB6XxOMgkia8KsSy9xXE2icEYRjrUTXdR4377rkM7Q3anNWmcpVFUeIQ/640?wx_fmt=png)❞

把这俩结果更改为你的随机字符串 我这里是 **return "ds6f565sdf44s65d4f21dsf1.jpg"; 和 return "ds78d4fg4er784gdfg4df9g4d8g4.jpg";** 到时候的成品我也会有打包，不会的可以替换过渡一下

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQoZYHr8icgibV9zY48dErfdAKCtkvT81ZH4e3rLzW7ee3M1qiaKKD3kkCzw/640?wx_fmt=png)❞

接着构建工件，构建完成了， 接下来开始测试

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQoOojUQfUjmA6kMianDSygVzGpzLsqc1HrXWn0hibyxSFho7yeqS7jUNRw/640?wx_fmt=png)❞

收尾
==

**「在 D:\cs\out\artifacts\cs_jar 找打了咱们编译好的文件 ，打开压缩包把 cs.jar\cs\WebServer.class 和 WebServer 还有和 1.class 文件移动到到你原本的 cobaltstrike.jar 文件里对应目录」**

> ❝
> 
> 问： 为什莫么不直接用生成的 cs.jar 文件
> 
> 答： 可以直接用 但是需要修改 teamserver 所有相关 cobaltstrike.jar 的名称并且有一些启动的汉化包什么的也需要改，不能直接重命名，直接重命名是无法打开的，可能是包的名字写到了 java 文件里，我也不是很清楚，我这里直接重命名失败了，并且很容易出错。
> 
> ❞

**「过程很顺利， 没有丝毫错误，然后启动咱们的 cs 团队服务器，在启动客户端测试之前测试的链接」**

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQoXUEg9G5y1bibEeDMZEOib6f94XlEiapAABtCxI8zrU1XicmSdWpW4pvMzg/640?wx_fmt=png)❞

再次访问特征处是无法下载的，如图看流程

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQo1sE3Hyg0sOSeiclwXLvaIHWL1wob4CZzQKsgjY1S7dCjKGY1iaUIodyg/640?wx_fmt=png)❞

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQoB5xlA8lQxc3OUOphexmRic87jU9mImjD6wolSwPS9PuJD7Z1cknRwaA/640?wx_fmt=png)❞

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQoTCHSKoDqEVKicHT07S67C5cf2icib8U05vOXNeYibPMSD9ZApcdwsIqQJQ/640?wx_fmt=png)❞

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQoMD5yQhzwGY71vNjlKibvu9IiaPzdfvh2eIouoqGvcBucRlSo4PLJmLIw/640?wx_fmt=png)❞

结果就是可以直接通过我们设置对应的路径进行上线了

> ❝![](https://mmbiz.qpic.cn/mmbiz_png/pPVXCo8Wd8DwVA8YCJoJxoPr2WvMCGQoCshAXYSfDCibfxfdUmngVhUciccPKwNzicL2icibatlX917gZRgByDia9LeQ/640?wx_fmt=png)❞

注意一点：我中途是遇到过坑的，所以可能有些数值对不上，望请谅解

**「可以看到是原来默认的是完全访问不了了的直接就是 404 状态，并且 cs 也是可以上线的，到这里就结束了，希望我的教程可以帮助到您，谢谢您的观看！！！」**

> ❝
> 
> **「超详细过程改 checksum8 武装 cs 完成，下篇讲如何防溯源以及流量加密相关，经过测试 vultr 并没有再检测出我的 teamserver 的监听特征」**
> 
> ❞

### 获取我文中部分素材请公众号回复”2021-12-03“获取

公众号