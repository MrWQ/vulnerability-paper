> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/OvVkgFMBOYye6HBe9D00eQ)

前言
--

最近大家都开始 hw 了，各种 0day/1day 也是层出不穷，作为一个脚本小子，挖不出洞，但是也想看看 0day 是什么样子的，因此尝试搭建了蜜罐。官方的蜜罐不够用，所以需要学会自定义 web 蜜罐才行。

最近出了用友的洞，所以想通过自定义蜜罐的网页来捕捉 poc，效果也超出了我的意料拿到了很多的 poc，有些确实是没见过的，有空分析分析。在搭建蜜罐的时候，遇到了很多问题，因此写下本文方便各位师傅在遇到问题时能够有个参考方案。![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaGR0jE70GcGJjDwdxbuU5pH4Mbicren1Rst0Zh1vh3Pcmk6EicibbCIjHQ/640?wx_fmt=png&from=appmsg)

HFish 环境搭建
----------

网上的蜜罐有很多，但是我感觉比较实用的就是火线的 HFish（因为可以一键搭建），并且能免费用。![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iarENCcuxx85cZkkNdWkYkBZUUbXeicibB9BYVjFDXu9SN9YWAQDeuoQww/640?wx_fmt=png&from=appmsg)

服务器选购
-----

我之前经常用的是野草云服务器，但是搭建蜜罐的话最好还是使用国内的服务器这样才有伪装效果，对比了多家服务器后，我发现阿里云服务器目前是最有性价比的。今年阿里云还出了一个阿里云 99 计划，2 核 2G 的服务器才 99 块，并且续费还是 99。![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaOBK1nTFwT6DkhAQBqAiblktWicNv6esiaSG65px2oNjNMctA8YFhtRNpg/640?wx_fmt=png&from=appmsg)之前买的服务器，到期了就涨价，导致服务还得重新换一台服务器。像是火山云服务器的话，相同配置的情况下价格没有 99 元优惠，并且没有后续的续费优惠，续费价格会在 1030 元左右。其他很多平台的这个价位也大多是轻量型服务器，流量还有限制。

阿里云 99 的服务器我是在这里购买的：

https://www.aliyun.com/daily-act/ecs/activity_selection?userCode=ko4bxhro![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iamkkAbXyqPFPqz8eWcGbKYM39ue8PfQXZtcvpmnn0Q9FrdlGmIzf9Ow/640?wx_fmt=png&from=appmsg) 对比了一下，像是同价位的京东云、腾讯云、华为云服务器，则是轻量级服务器，并且还有流量限制。阿里云这个服务器是经济型服务器，性能更高更稳定，使用过程中不会有带宽用量相关的费用，我们搭建蜜罐流量还是走得很快的。轻量型服务器买了之后搭建蜜罐就会有坑点，如超出流量包后会额外收费，有几率被刷爆账单。

除此之外，轻量级服务器只够一个人用的，如果多人协作的话，就容易崩溃。相比而言阿里云的经济型服务器能进行多人共享，如果后续搭建其他的服务，类似 confluence 的话，最好还是使用经济型服务器。现在阿里云还有分享计划，推荐给朋友买能领取奖励金，既让朋友买个好用的服务器，俩人还能进一步领到优惠。![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53ia2wiaEdLgQiaxZJg5ElQfUpAz5x00udeLoIPTK2Y8nKrlND8aiaS2ibB90A/640?wx_fmt=png&from=appmsg)买了服务器后，后续还可以用来自己搭建指纹扫描系统之类的，相比于使用国外的服务器，能更大程度上获取到国内资产的相关指纹，因为现在很多资产都 ban 掉了国外的 IP，所以准备一台国内的服务器还是很有必要的。

手动下载安装
------

阿里云服务器系统我选择的是 ubuntu2024，我们来搭建 HFish。

安装包下载地址：https://hfish.cn-bj.ufileos.com/hfish-3.3.5-linux-amd64.tgz[2]

在云服务器上创建一个文件夹，将下载后的文件放入该文件夹中并进行解压

```
mkdir /tool/HFish
tar zxvf hfish-3.3.5-linux-amd64.tgz -C /tool/HFish

```

![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaPictakG6gdtbqC3nRmNDWlgVolOlZicZGgyEiaK2OMRdGaXr1xzLibUMTg/640?wx_fmt=png&from=appmsg)确保配置防火墙开启 TCP/4433、TCP/4434  

```
//CentOS
sudo firewall-cmd --add-port=4433/tcp --permanent   （用于web界面启动）
sudo firewall-cmd --add-port=4434/tcp --permanent   （用于节点与管理端通信）
sudo firewall-cmd --reload
//Ubuntu
sudo ufw allow 4433/tcp
sudo ufw allow 4434/tcp

```

运行 install.sh 文件

```
sudo ./install.sh

```

![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaQTzSY3vaP7IqE8T9TZGzhmCyxvZfgVW5Fx3eafEalIphl6DNBpwu6g/640?wx_fmt=png&from=appmsg)登录 web 页面，这里是默认的账号密码

```
登陆链接：https://[ip]:4433/web/
账号：admin
密码：HFish2021

```

![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iacibhhsyhCtDWcBZS5VEp3TTZibvPsP0XeViaxZwg2SkksKOkFMy2kUTdg/640?wx_fmt=png&from=appmsg)登录后的第一件事就是修改默认密码，防止被其他黑客拿弱口令扫进蜜罐后台：![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iawu8mLe1tcyiapklDmicxqMfQID9skF75kIX4jtOFLmloVkgWH3yZSybw/640?wx_fmt=png&from=appmsg)

快速入门 HFish
----------

### 节点配置

安装 HFish 管理端后，我们首先要做的是建立节点，节点就等同于一台独立的主机：![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iahXcfj1nloqOcJaynwYBnYggzb7nRWFrhMKlYoWbhXGm2RZP096xRrA/640?wx_fmt=png&from=appmsg)可以看到右侧就是用来添加蜜罐服务的，我们等下自定义的蜜罐就是通过这里进行添加的。

### 查看攻击详情

![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iafgAf3fSxQB9ic0TibUaZGXAhCqt2hzeJWOmgj3hzhv1ENujv3yScVn9w/640?wx_fmt=png&from=appmsg)如果蜜罐被打了，我们就可以在这里看到打过来的 poc，和对应的请求包。当然，请求包是很多的，因为资产放在公网上一直都在被扫，我们要做的就是过滤出可能存在攻击行为的请求包。

### 请求包过滤检测

HFish 的过滤检测是使用 YARA 语言，对所有蜜罐收集到的攻击原始信息进行关键词检测，支持自定义规则。![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iagYfVzkSCRRQEr4hmTyOfVYxtRB0CNxWOCdH1QRgDbggNmqJUvn8A6Q/640?wx_fmt=png&from=appmsg)HFish 使用的 yara 监测语法分为三部分，rule，string 和 condition。

rule 部分：检测规则命名。

strings 部分：定义了规则中使用的字符串或字节模式。这些模式是 YARA 用来检测恶意软件的核心。

condition 部分：指定了规则匹配的条件。条件可以是简单的逻辑表达式，检查字符串是否存在，或更复杂的条件，结合多个模式和文件属性。![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iabAgZ9jND3eEEd50eeNiaOCPicsHqPIWS7psPVuIGfjq7c7bUwBjhMgLA/640?wx_fmt=png&from=appmsg)例如：

```
rule name1
{
strings:
$str1 = "1"
$str12 = "2"
condition:
any of them
}

```

以 Log4j 远程命令执行 3（CVE-2021-44228）漏洞为例，string 中定义了常见的拦截规则![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaBvjToGP32sLprtt9IVc9krpNreBLlqBoM3jXDPyuUWOQA4ZKTEKS6A/640?wx_fmt=png&from=appmsg)如果部署的蜜罐中，就会被标记拦截![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaATNTnXWe7pia3JRYGykh01mfFxamVqrG6b3wXuaSKM2pgpBXBDIbdyg/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53ia5wnvrUtPOa0bgZ736e6ibiaothj1yV8CJicVAobkOUScBgdwFWPkgdQOg/640?wx_fmt=png&from=appmsg)可以点击命中目标发现对方的 ip，和请求接口![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaY255X7sc51dIFsQ58fbxLbOPn1Abfk89XMFPmDcw3aJpoTPBD4NORA/640?wx_fmt=png&from=appmsg)点击攻击详情可发现详细的请求包：![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaY6aGVpb0pM2eiamIm14l9D6UjYXVhnFiaVqWShOicfHI9QABqT57JEvLQ/640?wx_fmt=png&from=appmsg)所以根据这一应用我们可以自定义大量检测规则以及新增新服务蜜罐来获取攻击者的 poc。

### 新增检测规则

这里我们测试新增一个对 sql 注入进行检测的规则![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iay2PhgVk66LsoLswQvcb362qJoMqeymJpJNgGgKbvHlN32UGgcse6Cw/640?wx_fmt=png&from=appmsg) YARA 规则输入区 :

```
rule SQL_Injection_Detection
{
    strings:
        $a = "SELECT" nocase
        $b = "DROP TABLE" nocase
        $c = "OR " nocase
        $d = "INTO OUTFILE" nocase
        $e = "LOAD_FILE" nocase
        $f = "'" nocase
        $g = /UPDATE [^\s]+ SET [^\s]+ WHERE 1=1/ nocase
        $h = /admin' OR '1'='1/ nocase
        $i = /BENCHMARK\((\d+),\s*(\d+)\)/i    nocase
        $j = /sleep\((\d+)\)/    nocase
        $k = /DBMS_PIPE.RECEIVE_MESSAGE\('(\d+)',\s*(\d+)\)/i
        $l = /WAITFOR DELAY '0:0:(\d+)'/i
        $m = "and" nocase
    condition:
        any of them
}

```

可在 YARA 规则测试工具进行测试![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaO3EtcUyibccYZ0jy1z8MwmScnibxV5ibgjPiczickhQKX5Tm2jrnibhpQWwQ/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaKblb2rEbCAhVQNpUXIjTOIShOHQOAlxkSYiavG5DrJhmN8VaGnN2bibQ/640?wx_fmt=png&from=appmsg)新增后的规则，可进行操作修改，状态栏勾选表示已启动![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaicvlf4RVLvL2EhIlaJ5x7Ul60lNh1v2mjc1SkvHkQAGziayTWhXkKuHg/640?wx_fmt=png&from=appmsg)如果搭建的蜜罐受到该配置规则下的 sql 注入攻击，该规则就会被命中标记，可点击命中记录对请求包进行漏洞验证。![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iahB2zHe6ppmF39XAkgCsD1icTAwW6XgFn7LiaAt6xSdgLckuB6wECIn0Q/640?wx_fmt=png&from=appmsg)

### 自定义 web 蜜罐

### 伪装用友

自定义 web 蜜罐在环境管理 - 服务管理 - 新增服务中![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iamRKibqZaQUrmcicJkaEoibRmUNxc6rlbwVticjvicPdfhW8jjBviblNianZ4g/640?wx_fmt=png&from=appmsg)可点击自定义 Web 蜜罐制作查看官方文档制作![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iauSUWMKibkibvF7vN8MoLmIXVgXwDZpia5kgxogBjrMc6jyx6Ho4MPLMTQ/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iafiatYiaIuCEwOpxtua6sO2dOTdMroSP3PSoF3n8wCRjhibahj10hu4YzA/640?wx_fmt=png&from=appmsg)将制作好的 web 蜜罐文件进行打包处理，注意：(html 文件的命名必须是 index.html，zip 的文件名最好是 service-xxx.zip）![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaSYnghicPZmJmqsfmRDcWPaDOibQnPiaheO9gnSskeiaQjhcGHCE5fWUrYA/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaQsPuvYgBXI01oWKmfJq2nabiaFKSoXdADkNx6U3EuRAIWbbBgKEnFqA/640?wx_fmt=png&from=appmsg)在服务管理 - 新增服务模块中上传 web 服务包![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaib23ZMKrZTClMvS83CEicl6zBXic8xgXtXb038TSwkb8hIpOBkrGrglYw/640?wx_fmt=png&from=appmsg)在节点管理 - 内置节点下添加蜜罐服务![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53ia9JLVB557RB0spNpXfLj7nnn3u1OAEBQNc6FicVrkOashoD38fZbQw0g/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaemV8h9bzOfncWYXhf0Wp9R1Sy4G4iagvic4sKzicYgsUwXDXUoGscHuyA/640?wx_fmt=png&from=appmsg)添加成功后，如果蜜罐显示在线，说明已成功部署。![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53ia6mAW805j2GZUdP1Q66Wq8VZ7v8xJrlOhdVLsoMNH4DWgbuFiacEGStg/640?wx_fmt=png&from=appmsg)访问搭蜜罐的 ip + 端口，如果 web 页面正常回显，且功能点正常，说明 web 蜜罐搭建成功。![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaib8wNnecicxHz7QnWmduQ0M5vICF6icLgaELd2pqgCaZgBAiadVY1ibxO7Q/640?wx_fmt=png&from=appmsg)拿内置漏洞 - Log4j 远程命令执行 3（CVE-2021-44228）漏洞进行测试，输入 payload 进行，点击登录进行验证。![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53ia4ib5fBtj1uKXfpSTkBmp254G66a5op3BkaNHtb9ESUe9YTwYViabyC0g/640?wx_fmt=png&from=appmsg)管理平台这边可以看到攻击列表成功已经成功捕获到了攻击行为：![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaobiaLNjibvJ4YV789f3AASc0OPnfWBKZf4QkF62B1sn6R362nbnV9pcg/640?wx_fmt=png&from=appmsg)后面可在漏洞模拟模块下选中命中记录查看完整的攻击请求包，![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaic5AASxlhSzlFJ0s6fteRbDspOeLWGEmib133ian7FZuRSPwk6VveTVTg/640?wx_fmt=png&from=appmsg)![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaxInRKvPnB8CJpQEJvPFta4dJcg1DtiaANOnY0zuGFYAC5BB09okBzYA/640?wx_fmt=png&from=appmsg)可以看到我们拿到了 get 的包，如果有 day 我们就可以进行下一步验证：![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iagGw9yH5BOp6QaWeu8JywMyBjeiba6DqBjwU6iaAx9KYRWOrva88S5Weg/640?wx_fmt=png&from=appmsg)

### 伪装 WVP 视频平台

除了用友之外，我这边再举一个例子，相关的蜜罐压缩包放在后台，感兴趣的师傅可以去下载下来看看源码是怎么写的。![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaPOyATTFBdR8ku1HwtvicmCtfrO6skFkIBSNxGlgicrbwRbdQPOcHCTOA/640?wx_fmt=png&from=appmsg)捕获攻击报文信息：![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iaibRh9s0eFWSn61HVlWe9deunuKAm3iacd9nK4czPzMEbgk79kjvv4EQg/640?wx_fmt=png&from=appmsg)

总结
--

差不多就是这样了，师傅们可以买一个 99ECS 玩玩，搭建完蜜罐还可以玩其他项目。嫌麻烦的可以直接用阿里云蜜罐服务，方便搭建。

祝愿各位师傅在 hw 期间能够多多捕获 0day！

> 关注公众号后台回复 0729，可获取 WVP 视频平台蜜罐包进行学习。

> 加入我们学习群一起学习交流，获取最新安全资讯，一群已超过 400 人，可扫码添加左侧运营微信发送验证 "云鸦" 进入，也可以扫码直接二群，欢迎师傅们一起学习交流，每天学习安全新知识~

![](https://mmbiz.qpic.cn/mmbiz_png/AbAaoHnsh8JWXeibqHbxkkneAoImEM53iakFYulp6HopITeRnl32qwqcQUJ6iawOjnFaL8DzibDgVzZaqCicQsnCialg/640?wx_fmt=png&from=appmsg)

### References

`[1]`: _https://www.aliyun.com/daily-act/ecs/activity_selection?userCode=ko4bxhro_  
`[2]`: _https://hfish.cn-bj.ufileos.com/hfish-3.3.5-linux-amd64.tgz_