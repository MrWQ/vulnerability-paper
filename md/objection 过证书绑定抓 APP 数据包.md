> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s?__biz=MzI5MDE0MjQ1NQ==&mid=2247516310&idx=1&sn=5ede8361f167e0da04c7b8707d3f2671&chksm=ec26a10edb5128183f4e285d04a1879e5dd375dbada07ccfdccbc7d6fbffd918ee714b8b8297&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_jpg/RXib24CCXQ08ia4MhA05iaKSwJdaHp8U6mnOUGzQLuzP37icFJaVvBWBTu4JgiceNbTshL9gias9aCqkW9voORu4bTug/640?wx_fmt=jpeg)
-------------------------------------------------------------------------------------------------------------------------------------------------

**前言**
======

在做 APP 安全测试时，往往会遇到抓不到数据包的情况，导致这种情况的原因有很多种，其中证书绑定是经常遇到的问题之一。如果我们在抓包时，使用了流量转发 + 透明代理还无法获取 APP 的数据包，那么大概率他就使用了证书绑定，除了使用插件和 frida 脚本 hook 外，这里还有一种更为简单的办法，使用 objection 一个命令搞定证书绑定。

当然，由于证书绑定的功能是由开发者自定义的，因此并不存在一个通用的解决方案，Objection 也只是对常见的 App 所使用的网络框架中对证书进行校验的代码逻辑进行了 Hook 修改。一旦 App 中的代码被混淆或者使用了未知的框架，这些 App 的客户端校验服务器的逻辑就需要自行分析了。

**前置知识**
========

### **证书绑定**

ssl Pinning 这种方式不仅校验服务器证书是否是系统中的可信凭证，在通信过程中甚至连系统内置的证书都不信任，而只信任 App 指定的证书。一旦发现服务器证书为非指定证书即停止通信，最终导致即使将抓包工具的证书安装到系统信任凭据中也无法生效。

### **frida**

frida 是一款轻量级的 hook 框架，专业点的说法就是动态插桩工具，可以插入一些代码到原生 App 的内存空间去动态地监视和修改其行为。通俗点讲通过该框架可以对 android、ios、windows、linux 等平台应用进行进程注入，从而达到劫持应用的目的，通过劫持我们可以实现各种功能。

该框架从 Java 层 Hook 到 Native 层 Hook 无所不能，但是持久化还是要依靠 Xposed 框架，另外由于其过于火爆，一些厂商也研究了反调试的方法。

### **Objection**

Objection 是基于 frida 的集成工具，其主要功能支持 Android 和 iOS 两大移动平台。在对 Android 的支持中，Objection 可以快速完成诸如内存搜索、类和模块搜索、方法 Hook 以及打印参数、返回值、调用栈等常用功能，是一个非常方便的逆向必备工具和内存漫游神器。

**流程**
======

这里相关环境安装不在赘述，直接手机下载代理软件

一般来讲代理软件分两种，一种通过走 VPN 隧道的方式进行代理，有些 APP 会直接检测 VPN 代理，然后不加载。另外一种通过修改手机底层的 iptables 进行流量转发，从而绕过部分 APP 的检测，其区别在于一个软件开启后，手机上方会有一个 VPN 图标的提示，另一个没有。

这里我使用的是 postern 进行代理配置

添加代理服务器

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ0icbDFvKiaVYllD5nVmUjLPhaxmg7qokUIxy3l1zzbgnobuKocq1NpByib3SEnbqicnAO2aWNFJ3HBEMw/640?wx_fmt=png)

添加规则

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ0icbDFvKiaVYllD5nVmUjLPhaicuJpsr7gIibJfFrrmmRLAzVrzcsoNGlXBLkXHWiaEhATKNkrXLCDLVFg/640?wx_fmt=png)

这时候可以测试一下浏览器，抓取一下百度的流量。是可以正常抓取的，但是打开 app 会发现，没有任何数据包发出。

手机使用数据线连接到电脑，开启 USB 调试功能，电脑端使用 adb 工具连接手机

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ0icbDFvKiaVYllD5nVmUjLPha0q52HQrp7BUc7QhMicOGPh7pKiadEmOtSOSbN34KH5YBHy9pCeu4IPJg/640?wx_fmt=png)

使用 adb shell 进入 root 模式，启动 frida

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ0icbDFvKiaVYllD5nVmUjLPhamNpLJesecPM0V8oBv6ag3pd3W6ZIbxhzBPzUqk8Hia7VLktKVp41ucA/640?wx_fmt=png)

电脑端使用命令获取 APP 的包名

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ0icbDFvKiaVYllD5nVmUjLPhaSktdWOQEYibX3icKkaVm0oRC2hq1LhFpYk4Ef8icicBdToOlCCxMFBb0ug/640?wx_fmt=png)

使用 objection 工具直接对 app 进行绕过，因为有些 APP 的证书检测是从启动时就开了，所以这里我们使用启动时附加命令

objection -g 包名 explore -s "android sslpinning disable"

可以看到其会自动对相关函数进行 hook

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ0icbDFvKiaVYllD5nVmUjLPhaHFNhk68e3ZdRj8b9zWJic69tgLG1Xwuiaqd3vRqpCPYCVUde9VApN3Bg/640?wx_fmt=png)

最后就能成功抓到数据包

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ0icbDFvKiaVYllD5nVmUjLPhaYcyqcyu3Hr5icnZPoMxicDSiaYLRia3NGooS9xndXrIp8BY5ibWHfVkNVIg/640?wx_fmt=png)

**总结**
======

无论使用哪种方法，能获取数据包进行测试才是最终目的，不论是 Xposed 框架的 JustTrustMe 插件、frida 的 hook 脚本还是 objection 的内置命令，其核心都是去查找 app 所调用的类，并对相关函数进行 hook，最终解除证书绑定。如果上述相关办法都不管用，那么说明 APP 可能混淆了，需要我们自己手动查找相关函数进行 hook，所以掌握其相关的基本知识对我们安全测试人员还是很有必要的。

### **往期回顾**

01

  

  
[一例 APP 绕过 root 检测解密](http://mp.weixin.qq.com/s?__biz=MzI5MDE0MjQ1NQ==&mid=2247516249&idx=1&sn=9960c67513d78c7012f7c4feda3839b9&chksm=ec26a1c1db5128d7daceaab4dd17ffa3f19e800389b3104e423b1004fe08f280c075068bcf43&scene=21#wechat_redirect)

02

  

  
[Log4j2 漏洞复现 & 原理 & 补丁绕过](http://mp.weixin.qq.com/s?__biz=MzI5MDE0MjQ1NQ==&mid=2247516183&idx=1&sn=a447caa8ace6dfc2432c1c418914bcfe&chksm=ec26a18fdb512899e486cce0a93d6e1cf51fad4519d376ac3f7584118b0ec15feae88bbaab3b&scene=21#wechat_redirect)  

03

  

[](http://mp.weixin.qq.com/s?__biz=MzI5MDE0MjQ1NQ==&mid=2247515959&idx=1&sn=34e6afbaeffba8a91b095f7fdb9fd5f6&chksm=ec269eafdb5117b90420f4ac45431a2b81af13908f0f2f8dc3cca89bd6f078d90d9e4382f1c0&scene=21#wechat_redirect)[一个文件上传漏洞靶场](http://mp.weixin.qq.com/s?__biz=MzI5MDE0MjQ1NQ==&mid=2247516060&idx=1&sn=72a0b808ed086906f7428f901e3cc3f8&chksm=ec269e04db5117120c16a28893fd691ded0a3afcc5cd6fa22e69d6a6f6c6b00743a9a5ad1f58&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/RXib24CCXQ08P2lHs2gMuphdmUxyKIQR1YoniczDqibgwjKkLqegFsBvq5bdUibgAhzoJnJuaHEYGZ7icTO3MNaIWjg/640?wx_fmt=png)

**雷石安全实验室**

商务咨询：

0571-87031601

商务邮箱：

mtn@motanni.com

联系地址：

浙江省杭州市市民街 98 号尊宝大厦金尊 3301