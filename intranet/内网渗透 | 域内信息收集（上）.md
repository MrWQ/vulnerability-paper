> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/FBwmtlATVa8YDimn3DF7JA)

渗透的本质是信息搜集，而信息搜集整理为后续的情报跟进提供了强大的保证。

一、内网信息收集概述
==========

进入内网后，首先需要对当前网络环境进行判断：  
• 我是谁：当前机器的角色  
• 这是哪：当前机器所处网络环境的拓扑结构

主要信息：
=====

本机信息收集  
基础信息：  
内网网段信息，查看网卡信息收集内部地址段的信息  
内网大小  
核心业务信息：  
内网 OA 办公系统、邮件服务器、网络监控系统、财务应用系统、核心产品源码（SVN 服务器、git 服务器等）  
其他信息：  
管理员密码、浏览器密码、cookie、无线密码、数据库密码、VPN 历史密码、Teamview 历史密码等  
其他用户 session、3389 和 IPC$ 连接记录，各用户回收站信息、用户列表  
host 文件和 DNS 缓存信息  
AV、补丁、进程、服务、端口、网络代理信息、软件列表  
计划任务、账号密码策略和锁定策略、共享文件、web 服务器配置文件  
启动项、系统日志、Web 服务器日志、防火墙规则

1. 收集本机信息
---------

### 手动收集信息

本机信息包括操作系统、权限、内网 IP 地址段、杀毒软件、端口、服务、补丁更新频率、网络连接、共享、会话等。  
如果是域内主机，操作系统，应用软件，补丁、服务、杀毒软件一般都是批量安装的。  
1. 查询网络配置信息  
ipconfig/all

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OpNxA95v7hRcn3JZgxjECc91vQTVFwhmXKNU2Ty9wT25RFPuNHPVyOw/640?wx_fmt=png)

  
2. 查询操作系统及软件的信息  
systeminfo | findstr /B /C"OS 名称" OS 版本”  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OKicnDKxzvic65pzbqS8MlpBSuD3JvJpEOMpc7ezTknBatAnx6GGW2R2Q/640?wx_fmt=png)

假如是英文版本就改为 Name 和 · 版本就行  
2. 查看系统体系结构  
echo %PROCESSOR_ARCHITECTURE%

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0ORO79MACJCAsQHSmiab65Z27v1v0bbpR8iad7dZGLKPviabZlGXGB0GQIQ/640?wx_fmt=png)

3. 查看安装的路径及版本、路径  
利用 wmic 命令，将结果输出到文本文件  
wmic product get name,version  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OmVVcXKlQvY8b8TZ5UoSyBl7o7iawxHmicNt3icYA3H4pQLcrxiaib0XGBug/640?wx_fmt=png)

利用 powersHELL 命令，收集软件的版本信息  
powershell "Get-WmiObject -class Win32_Product | Select-Object -Property name,version"

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OFJTuKlZIS6z05v8BhS56TfMhnbsCX9nCDibOh4ibHp0DiatwaU6NffwDA/640?wx_fmt=png)

  
3. 查询本机服务信息  
wmic service list brief  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OhqmuJUR2m9NNicfrJAmh4eSibr0HvM0oDdBGZJFSmahfZzXuQdTF3B8Q/640?wx_fmt=png)

  
4. 查询进程列表  
tasklsit  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OQicfz0pvtwDjL6n1tnOCOWG90NrvtT81lflp0abQBvnby98PNZTiaJSA/640?wx_fmt=png)

wmic process brief

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OQRbvdSWZicictc2WcTzCf1f6f8EYmH9wibaQ3BZElkXfEB3wLNQG2kIAA/640?wx_fmt=png)

  
5. 查看启动程序信息  
wmic startup get command ,caption

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0ORB2iaI2u1Xn2V4L1ibQ4n0vEvpmL8HakR9ibK6q4fQiaAV1cjBoL689XDw/640?wx_fmt=png)

6. 查看计划任务  
schtasks /query /fo LIST /v

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0O9lpyOUBibAJLXADjg83wMWcQ55ZSHribfkXmABQa3auewEcUbT1buTaA/640?wx_fmt=png)

7. 查看主机开机时间  
net statistics workstation  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0O2wib4nx7QCEb5AQo1koPlrxTEy0zQ7MlrjxK3SOaTGlVxx7s24APCGA/640?wx_fmt=png)  

8. 查询用户列表  
执行如下命令，查看本机用户列表  
net user

net localgroup administrator

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OYFfyibhZDGiab5Ig936VZYBvbE2pexsoZd3NP3I9W3FM0z5icAYWOv8gA/640?wx_fmt=png)

  
查看当前在线用户

query user || qwinsta

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OIeu7I5QsgFOGvA3eXGYnxJhEHkWCb86JRgb3zXG8YzQzzWQC1G7s2A/640?wx_fmt=png)

  
9. 列出或断开本地计算机与所连接的客户端之间的会话（需要管理员权限）  
net sesssion

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OC6ECiajdkF9hLvmpKvIk2ibN0jyl2ECJ4nwHdIQSC6uLvCyGiacSTxEKw/640?wx_fmt=png)

10.  查询端口列表（常用命令）  
    netstat -ano
    
    ![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0Oufs8sYQmuoJrRvyG5OGwrC7FaibhE7r4QoTQ3VnGBwNY4Nr4KvomsOQ/640?wx_fmt=png)
    

  
11. 查看补丁列表  
systeminfo

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OJPOf6RPXh6EhEm0UO3Z6zzAFHXRtlvbnkWaD9PqJnXQpcERsNksicow/640?wx_fmt=png)

  
使用 wmic 命令查看安装在系统的补丁  
wmic qfe get Caption ,Description ,HotFixID,InstalledOn

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OSFLLdnXAicBuspgH9TQYKqKfCseIUH8lCboCzAicBIs3xtuaGCFVa7rg/640?wx_fmt=png)

12. 查询本机共享列表

net share

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OvHQibI29th1plp0SN0ASjap0GTBQRrowdaZicicSmWbEO9ib4MtV2VDAoA/640?wx_fmt=png)

  
wmic share get name,path,status  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OnPlXzn5OTEZtHI4POia2St25ribgTB2ajAtMKwpkbACORic31vIDlIaNg/640?wx_fmt=png)

13. 查询路由表及所有可用接口的 Arp 缓存表  
route print  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0Oq7UmIsSJ2IYMHkQibBEEBXkWTXkLagibEibtlwhY77O0mTopCeNGKgpww/640?wx_fmt=png)

  
    arp -a

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OOeNicx4DFzto9gAia1P38jwlwPyRjaAVh6sWpe6RyhO8AEdiaT8SDLxoQ/640?wx_fmt=png)

  
14. 查询防火墙相关配置  
1. 关闭防火墙  
windows server 2003 及之前的版本：  
netsh firewall set opmode disable  
windows server 2003 及之后的版本：  
netsh advfirewall set allprofiles state off  
2. 查看防火墙配置  
netsh firewall show config  
3. 修改防火墙配置  
windwos server 2003 及之前的版本，允许指定程序全部连接  
netsh firewall add allowedprogram c:\nc.exe "allow nc" enable  
windows server 2003 之后的版本：  
允许指定程序进入, 命令如下：  
netsh advfirewall firewall add rule C:\nc.exe"  
允许指定程序退出, 命令如下：  
netsh advfirewall firewall add rule C:\nc.exe"  
允许 3389 端口放行：  
netsh advfirewall firewall add rule protocol=TCP dir=in localport=3389 action=allow  
Copy  
4. 自定义防火墙日志的存储位置  
netsh advfirewall set currentprofile logging filename "C:\windows\temp\fw.log"  
2. 查看防火墙及配置  
netsh firewall show config

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OOBvRqVfYR7RBDQXMnnHFuEVv8bLBjsm1yBtjRyhaUBq3FFIPJkZs5w/640?wx_fmt=png)

  
15. 查看代理配置情况  
reg query "HKEY_CURRENT_USER\Software\Microsoft\windows\CurrentVersion\INternet settings"

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OBApZQ0nsssr3BbnwrM9YnZqGThompRc5IfX0DIvx9OvpVeQSs1hVibg/640?wx_fmt=png)

16. 查询并开启远程连接端口
---------------

REG QUERY “HKEY_LOcal_MACHINE\SYSTEM\CurrentControLset\Control\Terminal Server \WinStations\RDP-TCP" /v PortNUmber  

---------------------------------------------------------------------------------------------------------------------

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OFZH5w6ibLIrTfvztr2Y9mGK2qS0EHMBL0rdXor7LEcGTNIxyqiaRq6pA/640?wx_fmt=png)

  
wmic /namespace:\root\CIMV2\TerminalServices PATH Win32_TerminalServiceSetting WHERE (__CLASS !="") CALL SetAllowTSConnections 1
-----------------------------------------------------------------------------------------------------------------------------------

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OXbcmibTHvyHHpQiawpBm3tQVhQ2Amic9f5iaqM6xvGmSZ3nV9auAyU4zyQ/640?wx_fmt=png)

2 自动收集信息
--------

为了简化操作，可以创建一个脚本，在目标机器上完成流程、服务、用户账户、用户组、网络接口、硬盘信息、网络共享信息、操作系统、安装的补丁、安装的软件、启动时运行的程序、时区等信息的查询工作。  
1. 下载地址：http://www.fuzzysecurity.com/scripts/files/wmic_info.rar  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0O8UWD9cwq6upAqNU5MsP4o8DwMSiboJD4Q2KCveTRLDUKUITicENcT5Zg/640?wx_fmt=png)

2. 点击下载文件，然后生成了 out.html

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OjvXicUItvmrQ1CPYicqD4PZaymSJRHR3E8P0HxDxicHWcNgpEJibibRpvzg/640?wx_fmt=png)

2.Empire 下的主机信息收集
-----------------

Empire 提供了用于收集主机信息的模块。输入命令”usemodule situational_awareness/host/winenum “  

查询当前权限
------

1. 查看当前权限 ·  
whoami  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OCApiaKicic2AGm6Koiara11zxvroApu77GgF4Ipx0l0IHftd0bias2OsPrg/640?wx_fmt=png)

2. 获取域 SID  
whoami/all  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0O7FYbz5lCPEKlXEMiclib2hNldeU02sbQOUmBWCJMfibkdCzzYNCpIAxHg/640?wx_fmt=png)

  
3. 查询指定用户的详细信息  
执行以下命令，查询当前用户的详细信息  
net user xxx /domain

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OdzbMSzNScIXgZ0t44DHctpODuhbYjjL5ayAJlb2GmnwIPhygrU6Ksg/640?wx_fmt=png)

4、判断是否存在域  

1. 使用 ipconfig 命令  
ipconfig/all  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OhibFKXydq4t6ibwvIVpDFuCXvPoibibRlKlYxH778ntjIwI1hUyjS2aM5A/640?wx_fmt=png)

nslookup hacke.testlab  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OCvX22yZicLRtGU3RkwCuxZHgEiaia3dDmDN5DTovxe4micLL18eT7GbPQQ/640?wx_fmt=png)

2. 查看系统详细信息  
systeminfo

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0O0JK6AiaTWDKMnM5DuHfO1mFsnlfzXsARXUq84ZR458H8cThoQ5BGNQg/640?wx_fmt=png)

  
3. 查询当前登录域及登录用户信息  
net config workstation  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OjAhhXqaUKicDbBLElCvtG0D4KSjNibVgbGcqBK0NBpnto9wbiaQKjpjMQ/640?wx_fmt=png)

4. 判断主域  
net time /domain  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0ObQM7kaIP5mDofHNyMqjE7151j0Ck986ia7WGoP6I6dLZbzjMTfCiaOuQ/640?wx_fmt=png)

二、 探测域内存活主机
===========

内网存活主机探测是内网渗透测试中不可缺少的一个环节。可在白天和晚上分别 · 进行探测。

1 利用 NetBIOS 快速探测内网
-------------------

NetBIOS 是局域网程序使用的一种程序编辑接口（API），为程序提供了请求级别服务的统一的命令集，为局域网提供了网络及其他特殊功能。  
nbtscan 是一个命令行工具，用于扫描本地或远程 tcp/ip 网络上的开放 NEtBIos 名称服务器。  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OfiaKqoyiabWqLfld4gb0PutwRUSzUs98Ja5A12mPtuaj1CibMP8klQffw/640?wx_fmt=png)

2 利用 ICMP 协议快速探测内网
------------------

除了利用 NEtBIos 探测内网，还可以利用 icmp 协议探测内网。  
for /L %I in (1,1,254) Do @ping -w l -n 1 192.168.1.%I findstr "TTL="  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OX5MRSQk0BDm8JdBqxibmPHa2bMT8QOvAmAA1CIUxvuY561zEzV8cAQg/640?wx_fmt=png)

3 通过 arp 扫描探测内网
---------------

1.arp-scan 工具  
arp -a  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OfL3GL7ib3xCNGYbLVEOmu2ricggaYAx5iaCZUl2RxicEfcIvIetibKGfuNg/640?wx_fmt=png)

2.Empire 中的 arpscan 模块  
3.NIshang 中的 invoke-Arpscan.ps1 脚本

4 通过常规 TCP/UDp 端口扫描内网
---------------------

ScanLine 是一款经典的端口扫描工具，可以在所有版本的 windoWS 操作系统中使单个文件，用，体积小，仅使用单个文件，同时支持 TCp/udp 扫描

5 扫描域内端口
--------

端口的 banner 信息 ，端口上运行的服务，常见应用的默认端口  
利用 telnet 命令进行扫描  
Telnet 协议是 tcp/ip 协议族的一员，是 Internet 远程登陆服务的标准协议和主要形式。  
1. 首先得开启服务  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OEtAlxiabHZ1F6sx25WjNaGrxCdyXTmRERsjy42gFqGRpJSiaGQOficxTw/640?wx_fmt=png)

telnet 192.168.1.1 22  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OB1VeFC53Nm1eJIlHib3BoFNsCmBiaaDHOP41Ltwc8Wdt0yehMxicolpNA/640?wx_fmt=png)

S 扫描器  
S 扫描是 2007 年古老的扫描器，不建议使用了。  
Metasploit 端口扫描

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OuqXAUC751S7NbicpDubAfRW5Zju65eDoVL0ZJMZI5dm3ibAFhL4gc4yg/640?wx_fmt=png)

6、端口 banner 信息
--------------

如果通过扫描发现了端口，可以使用客户端连接工具或者 nc，获取服务端的 Banner 信息。获取 Banner 信息后，可以在漏洞库中查找对应 cve 编号的 POc、exp、在 exploitDB、seebug 等平台上查看相关的漏洞利用工具，然后到目标系统中验证漏洞是否存在，从而有针对性地进行安全加固。  
nc -nv 127.0.0.1 22  

![](https://mmbiz.qpic.cn/mmbiz_png/iar31WKQlTTpNjEIvOKj0DjqvXxEXUz0OOp4NtibTNjmR73WAZXHX9kHf4jdicPXBmnxtRGVIHmbbIy7dr9SkgwUg/640?wx_fmt=png)

  
• 文件共享服务端口（21、22、69、2049、139、389）  
• 远程连接服务端口（22、23、3389、5900、5632）  
• Web 应用服务端口（80、443、8080、7001、7002、8089、9090、4848、1352）  
• 数据库服务端口（3306、1433、1521、5432、6379、5000、9200）  
• 邮件服务端口（25、110、143）  
• 网络常见协议端口（53、67、68、161）域内基础信息收集

7、常见命令
------

```
ipconfig /all    查询本机IP段、所在域nbtstat –A ip             netbios 查询netstat –an/ano/anb     网络连接查询route print            路由表cmdkey /l             是否保存了登录凭证net session           查看是否有远程连接的session
```

net 类

```
net user        本机用户
net user /domain    查询域用户
net user domain-admin /domain 查看管理员登陆时间，密码过期时间，是否有登陆脚本
net localgroup administrators     本机管理员（通常含有域用户）
net localgroup administrators /domain   登录本机的域管理员
net localgroup administrators workgroup\user001 /add    域用户添加到本机
```

```
net group /domain   查询域工作组net group "domain admins" /domain       查询域管理员用户组net group "Domain controllers" /domain  查询域控列表net group "domain computers" /domain   获得所有域成员计算机列表net view    查询同一域内机器net view /domain    查询域列表net view /domain:domainnamenet accounts                               查看本地密码策略net accounts /domain                      查看域密码策略net time /domain                         查看域时间nltest /domain_trusts                    获取域信任信息dsquery
```

dsquery computer domainroot -limit 65535 && net group "domain  
computers" /domain ------> 列出该域内所有机器名  
dsquery user domainroot -limit 65535 && net user /domain------> 列出该域内所有用户名  
dsquery subnet ------> 列出该域内网段划分  
dsquery group && net group /domain ------> 列出该域内分组  
dsquery ou ------> 列出该域内组织单位  
dsquery server && net time /domain------> 列出该域内域控制器

```
总结：域内信息收集的方法是进行域内渗透最重要的一步，在域内进行快速收集有用信息是内网渗透的关键。

```