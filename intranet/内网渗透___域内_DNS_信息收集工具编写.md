> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/vF7g3BjNiuDV0h4sMON57g)

域内 DNS 信息收集
===========

在一个大型的内网环境当中，如果我们在不确定目标资产定位在哪里我们就可以通过 dns 去定位，当然也可以通过活动目录集成的 dns 服务。

这里举例 DC Locator Process

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou9wlBYACDlgUIzLkMguomVU8tF4EhOmN6mGfufxlia5FwEiaePT5bfRxicdxBnmsdXpJa2ElfxofMYXQ/640?wx_fmt=png)

ffDAQa.png

第一步它会询问_ldap._tcp.dc._msdcs.contoso.com 注册记录是什么，dns 就会返回所有的域控。

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou9wlBYACDlgUIzLkMguomVU6TOrqp77ADjky6ya1I8TEsydsMgTicOXzHUxhTMJS2EzxvUTcCeJ4iaQ/640?wx_fmt=png)

ffDMDu.png

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou9wlBYACDlgUIzLkMguomVUicaEjorJl3SCzVyAaoX40TIGLhvmA6H6tMpDu4pHicyB1UxicNjRT2XeA/640?wx_fmt=png)

ffDWiD.png

**dnscmd**

```
dnscmd.exe . /EnumRecords redteam.local .
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou9wlBYACDlgUIzLkMguomVUjic3pb6oNhhqia6Pbl7KIuXMccKEGcB9NwM47NqP7wKZw0ArxkTXM8cA/640?wx_fmt=png)

ffD7Ti.png

```
dnscmd /zoneexport redteam.local redteam.local.dns.txt 
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou9wlBYACDlgUIzLkMguomVUQcvia5WUtKLKCMP2uaseof3lapAJOqNAibw009AwMbiaxdYTZEoa0z86w/640?wx_fmt=png)

ffDvtL.png

**SharpAdidnsdump**

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou9wlBYACDlgUIzLkMguomVUoQgcUvmBca43rF68bUb07micVQ2fftBqcmsic5gyjlwayjLWje7Ms8VQ/640?wx_fmt=png)

ffD35W.png

这里我们也可以通过获取域内机器然后通过`Dns.GetHostEntry`解析 ip。

```
using System;using System.Collections.Generic;using System.Linq;using System.Text;using System.Threading.Tasks;using System.DirectoryServices;using System.Net;namespace QueryDomainIp{    class Program    {        static void Main(string[] args)        {            DirectoryEntry coon = new DirectoryEntry();            DirectorySearcher search = new DirectorySearcher(coon);            search.Filter = "(&(objectclass=computer))";            try            {                foreach (SearchResult r in search.FindAll())                {                    string computername = "";                    computername = r.Properties["cn"][0].ToString();                    IPHostEntry hostInfo = Dns.GetHostEntry(computername);                    foreach (IPAddress result_ip in hostInfo.AddressList)                    {                        Console.WriteLine("HostName:{0} IP:{1}", computername, result_ip);                    }                }            }            catch (System.Exception ex)            {                Console.WriteLine("[-] error");                Console.WriteLine("[-] Exception: " + ex.Message);            }        }    \}\}
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou9wlBYACDlgUIzLkMguomVUQPQSQazZhT587eDPSY2dsXr2mdrkHA594nqZlc8cEIDibRLickg8GiaRw/640?wx_fmt=png)

ffDNXw.png

**PowerView.ps1**

```
import-module PowerView.ps1Get-DNSRecord -ZoneName redteam.local
```

![](https://mmbiz.qpic.cn/mmbiz_png/Uq8Qfeuvou9wlBYACDlgUIzLkMguomVUovibzILgZRIVQ2CLiajicQQdT2jjjXvBUkiaTflfm36TVboJO28YZ8cxEw/640?wx_fmt=png)

ffDayR.png

![](https://mmbiz.qpic.cn/mmbiz_png/ndicuTO22p6ibN1yF91ZicoggaJJZX3vQ77Vhx81O5GRyfuQoBRjpaUyLOErsSo8PwNYlT1XzZ6fbwQuXBRKf4j3Q/640?wx_fmt=png)

**推荐阅读：**

[**内网渗透 | 域渗透之 Dcsync 的利用实战**](http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&mid=2247502081&idx=1&sn=993c644c97408fb2a25cd2ea18c9f40d&chksm=ec1c9c3edb6b15289ea7d74a993e9f77f0b6b4f108f4b13c639a34cf956cdfcdadc7bc53dc6b&scene=21#wechat_redirect)  

[**实战｜内网渗透 hash 窃取技巧**](http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&mid=2247501586&idx=1&sn=6880bcc4910c9f8c44b3ae9072ae47bc&chksm=ec1c922ddb6b1b3baea698fcfe6ffa6e60ad496a336862174f6febcac9210964fd4ef1b464ce&scene=21#wechat_redirect)  

[**内网渗透｜LAPS 的使用小技巧**](http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&mid=2247501302&idx=1&sn=8845cca96059bc2f346a9a4701b933df&chksm=ec1c90c9db6b19df9fae2fc24ec86923dc21c6376cbb65fd6e602aa8f75e91c5e7002ebc6fb7&scene=21#wechat_redirect)  

[**内网渗透 | 横向移动中 MSTSC 的密码获取**](http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&mid=2247500601&idx=1&sn=00cc8c4a13b170711b3dbe7f94fbf566&chksm=ec1c9606db6b1f108f34dbddbfc7874b25ed8dbcfdb5f0df95b0441488151583d451382659fd&scene=21#wechat_redirect)  

[**内网渗透 | 内网穿透之多层代理**](http://mp.weixin.qq.com/s?__biz=MzI5MDU1NDk2MA==&mid=2247500597&idx=1&sn=19fc81b36da44ac13ae3a37aac6bb12d&chksm=ec1c960adb6b1f1cc23e7fc404c5f5fbd77d68bc3a8c1476b525e365a2a5a184a3016a7b8a65&scene=21#wechat_redirect)  

**点赞，转发，在看**

![](https://mmbiz.qpic.cn/mmbiz_gif/Uq8QfeuvouibQiaEkicNSzLStibHWxDSDpKeBqxDe6QMdr7M5ld84NFX0Q5HoNEedaMZeibI6cKE55jiaLMf9APuY0pA/640?wx_fmt=gif)