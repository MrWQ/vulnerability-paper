> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [mp.weixin.qq.com](https://mp.weixin.qq.com/s/y7cytNY6-HuT4PxKwPtOow)

****0x01 前言****

[如何搭建属于自己内网全流量的 IDS/IPS](http://mp.weixin.qq.com/s?__biz=Mzg2MzYzNjEyMg==&mid=2247486487&idx=1&sn=9eddfdcbbc6c15b990e7220b49b44c30&chksm=ce74d3e2f9035af4569adaa4f6df663d18448ee51902187395bed84854abec6c51faaca42032&scene=21#wechat_redirect)
===============================================================================================================================================================================================================================================

接上片文 “如何搭建属于自己内网全流量的 IDS/IPS” 上一篇文章介绍了如何利用 suricata+arkime 做内网全流量系统，目前只做到了记录 suricata 告警日志和 arkime 流量分析，只实现了 ids 入侵检测系统的功能，但是要作为 IPS 入侵防御系统来用的话暂时还不能实现拦截的功能，这章介绍怎么作为 IPS 来使用实现阻断拦截的功能

****0x02 部署位置****

      家庭网络中，一般只有一个路由器，剩下的就是电脑等设备，使用网线连接路由器和主机终端，IPS 部署位置一般选择串联，这样不用改变原来的网络结构，如下图

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8Ke1zdv64t1ibEpldEwavRBp9Sr5wAa30XK8icnFO6XV7AecDyrEGhUPlS0Aa4f1d5GIkxcAmiaECPFg/640?wx_fmt=png)

    大概就是这样串进去就行了，注：这里是选择的 IPS 模式，所以需要两个网卡，一进一出，Suricata 将负责将数据包从一个接口复制到另一个接口。复制过程中过一遍内置规则集，发现命中则拦截阻断此流量

********0x03 实验环境********

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8Ke1zdv64t1ibEpldEwavRBptFZNibicaRRxchk5iaOCaMvREtuN3icdPzvMD0JH0g8ZOyhkKl5kPMqNuQ/640?wx_fmt=png)

注：surucata 必须要有两网卡，一进一出，生产环境根据自己网络配置好，串进去就行，不然很容易网络风暴。。。。  

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8Ke1zdv64t1ibEpldEwavRBp77rcN0WcILL4Y4J6JABZGn0zRtzEP23JuUd7e9ft7s037wTsdhAJEg/640?wx_fmt=png)

     先将 vmnet4 的 dhcp 服务禁用，

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8Ke1zdv64t1ibEpldEwavRBpDdRUMwl7Po9e1GHPYBA7PayNV2GX8pocHbEQziauB486mrmIHqDQBTA/640?wx_fmt=png)

攻击机和靶机的 ip，可以看到攻击者和靶机并不是一个网段，但是当 suricata 启动之后，自身所带的两个网卡就会相互复制流量，这时候 suricata 的作用就会相当于一根网线，将靶机攻击机和靶机连接起来，攻击者就可以访问靶机了

     关于 suricataips 的配置可参考官网

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8Ke1zdv64t1ibEpldEwavRBpiahvR3fNLzpgEha6GD53yzrDmfr4YtYEk40cjVhFMwtHZbTMLYc95jQ/640?wx_fmt=png)

    随便写条测试规则。因为现在是 ips，所以动作要换成 drop； alert 记录所有匹配的规则并记录与匹配规则相关的数据包；  drop ips 模式使用，如果匹配到之后则立即阻断数据包不会发送任何信息

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8Ke1zdv64t1ibEpldEwavRBpLHtOQh0gtn8BZs5uZsHq8sO27UbxnjG8GLuhA1ACMxMeWcyPZ6txuA/640?wx_fmt=png)

未启动 suricata 之前，攻击机不能访问靶机

启动 suricata 之后，靶机 ip 会发生变化，变成 和攻击者同网段的，随后攻击者可以访问靶机

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8Ke1zdv64t1ibEpldEwavRBpaBVSuFZYyJ7OBb4F08n3E8NA6Ruvhx1f4ULEBjvOeV4PPH4jyJxD7Q/640?wx_fmt=png)

根目录放置两个文件  

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8Ke1zdv64t1ibEpldEwavRBpnhd0cP0PfLWrN0UlCkvWK32XTndAfQC0T3kjbSicfk63PpERvs9B2oA/640?wx_fmt=png)

攻击者访问 baidu.php 文件被拦截，ips 规则生效  

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8Ke1zdv64t1ibEpldEwavRBpBgEkR0Wia3xiax6jlyzfz0ljOW2JGROrMOadPJ3AYkB8CCbz3vRRETgA/640?wx_fmt=png)

本文最终解释权归本文作者所有！！！
=================

    本公众号发布的**靶场、文章项目中涉及的任何脚本工具**，仅用于**测试和学习研究，禁止用于商业用途****，**不能保证其合法性，准确性，完整性和有效性，请根据情况自行判断；

     本文章、项目内场所有资源文件，杜绝任何靶本公众号、自媒体进行形式的擅自转载、发布

    本公众号对任何脚本及工具问题概不负责，包括不限于由任何脚本错误导致的任何损失或损害及任何法律责任；

    直接使用本或公众发布的技术、靶场、文章项目中涉及的脚本工具，但在某些行为不符合任何国家 / 地区或相关地区的情况下进行传播时，引发的隐私或其他任何法律问题的后果概不负责；

    如果任何单位或个人认为项目或文章的内容可能侵犯其权利，则应及时通知并证明其身份，证明我们将在收到证明文件后删除相关内容；

    以任何方式查看或使用此项目的人或直接或间接使用项目的任何脚本的使用者都应仔细阅读此声明；

     本公众号保留更改或补充，免责随时声明的权利；

    **一旦您访问或使用访问本公众号任何项目，则视为您已接受此免责声明。**

 **您在本声明未发出之时，使用或者访问了本公众号任何项目 ，则视为已接受此声明，请仔细阅读。**

                                                                                        ** 此致**

 **由于、利用的信息而造成的任何或直接的此文传播后果，均由用户本人负责，作者不承担任何直接责任。**

**一切法律后果均由攻击者承担！！！**

**日站不规范，亲人两行泪！！！**

日站不规范，亲人两行泪！！！

日站不规范，亲人两行泪！！！

专注于信息安全方面分享，非营利性组织，不接任何商业广告

关注不迷，点赞！关注！转向！评论！！  

要投稿的请留言或者加微信，会第一时间回复，谢谢

![](https://mmbiz.qpic.cn/mmbiz_png/VXs6byTkU8LXzGow9VibbNMVo6HZcv2tXyEVHp3WgicIC7LMomYkvcRP4JcjK69MibibkGZlZfN3IAs8KqRiapekqqA/640?wx_fmt=png)